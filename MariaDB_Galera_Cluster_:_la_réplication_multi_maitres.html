<!DOCTYPE html>
<html lang="en" dir="ltr" class="client-nojs">
<head>
<meta charset="UTF-8" />
<title>MariaDB Galera Cluster : la réplication multi maitres - Deimos.fr / Bloc Notes Informatique</title>
<meta name="generator" content="MediaWiki 1.25.5" />
<link rel="shortcut icon" href="https://wiki.deimos.fr/favicon.ico" />
<link rel="search" type="application/opensearchdescription+xml" href="opensearch_desc.php" title="Deimos.fr / Bloc Notes Informatique (en)" />
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.deimos.fr/api.php?action=rsd" />
<link rel="alternate" hreflang="x-default" href="./MariaDB_Galera_Cluster_:_la_réplication_multi_maitres.html" />
<link rel="copyright" href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.fr" />
<link rel="alternate" type="application/atom+xml" title="Deimos.fr / Bloc Notes Informatique Atom feed" href="https://wiki.deimos.fr/index.php?title=Special:RecentChanges&amp;feed=atom" />
<link rel="stylesheet" href="load.php%3Fdebug=false&amp;lang=en&amp;modules=ext.cite.styles|mediawiki.legacy.commonPrint,shared|mediawiki.sectionAnchor|mediawiki.skinning.interface|mediawiki.ui.button|skins.vector.styles&amp;only=styles&amp;skin=vector&amp;*.css" />
<meta name="ResourceLoaderDynamicStyles" content="" />
<link rel="stylesheet" href="load.php%3Fdebug=false&amp;lang=en&amp;modules=site&amp;only=styles&amp;skin=vector&amp;*.css" />
<style>a:lang(ar),a:lang(kk-arab),a:lang(mzn),a:lang(ps),a:lang(ur){text-decoration:none}
/* cache key: blocnotesinfo-wiki_:resourceloader:filter:minify-css:7:6f8c0c45eefd74c7bbe9478b32df38c0 */</style>
<script src="load.php%3Fdebug=false&amp;lang=en&amp;modules=startup&amp;only=scripts&amp;skin=vector&amp;*"></script>
<script>if(window.mw){
mw.config.set({"wgCanonicalNamespace":"","wgCanonicalSpecialPageName":false,"wgNamespaceNumber":0,"wgPageName":"MariaDB_Galera_Cluster_:_la_réplication_multi_maitres","wgTitle":"MariaDB Galera Cluster : la réplication multi maitres","wgCurRevisionId":13275,"wgRevisionId":13275,"wgArticleId":3572,"wgIsArticle":true,"wgIsRedirect":false,"wgAction":"view","wgUserName":null,"wgUserGroups":["*"],"wgCategories":[],"wgBreakFrames":false,"wgPageContentLanguage":"en","wgPageContentModel":"wikitext","wgSeparatorTransformTable":["",""],"wgDigitTransformTable":["",""],"wgDefaultDateFormat":"dmy","wgMonthNames":["","January","February","March","April","May","June","July","August","September","October","November","December"],"wgMonthNamesShort":["","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"wgRelevantPageName":"MariaDB_Galera_Cluster_:_la_réplication_multi_maitres","wgRelevantArticleId":3572,"wgIsProbablyEditable":false,"wgRestrictionEdit":[],"wgRestrictionMove":[],"wgWikiEditorEnabledModules":{"toolbar":true,"dialogs":true,"hidesig":true,"preview":true,"publish":false}});
}</script><script>if(window.mw){
mw.loader.implement("user.options",function($,jQuery){mw.user.options.set({"variant":"en"});});mw.loader.implement("user.tokens",function($,jQuery){mw.user.tokens.set({"editToken":"+\\","patrolToken":"+\\","watchToken":"+\\"});});
/* cache key: blocnotesinfo-wiki_:resourceloader:filter:minify-js:7:a5c52c063dc436c1ca7c9f456936a5e9 */
}</script>
<script>if(window.mw){
mw.loader.load(["mediawiki.page.startup","mediawiki.legacy.wikibits","mediawiki.legacy.ajax","skins.vector.js"]);
}</script>
<style type="text/css">/*<![CDATA[*/
.source-text {line-height: normal;}
.source-text li, .source-text pre {
	line-height: normal; border: 0px none white;
}
/**
 * GeSHi Dynamically Generated Stylesheet
 * --------------------------------------
 * Dynamically generated stylesheet for text
 * CSS class: source-text, CSS id: 
 * GeSHi (C) 2004 - 2007 Nigel McNie, 2007 - 2008 Benny Baumann
 * (http://qbnz.com/highlighter/ and http://geshi.org/)
 * --------------------------------------
 */
.text.source-text .de1, .text.source-text .de2 {font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;font-family: monospace, monospace;}
.text.source-text  {font-family:monospace;}
.text.source-text .imp {font-weight: bold; color: red;}
.text.source-text li, .text.source-text .li1 {font-weight: normal; vertical-align:top;}
.text.source-text .ln {width:1px;text-align:right;margin:0;padding:0 2px;vertical-align:top;}
.text.source-text .li2 {font-weight: bold; vertical-align:top;}
.text.source-text .ln-xtra, .text.source-text li.ln-xtra, .text.source-text div.ln-xtra {background-color: #ffc;}
.text.source-text span.xtra { display:block; }

/*]]>*/
</style>
<style type="text/css">/*<![CDATA[*/
.source-sql {line-height: normal;}
.source-sql li, .source-sql pre {
	line-height: normal; border: 0px none white;
}
/**
 * GeSHi Dynamically Generated Stylesheet
 * --------------------------------------
 * Dynamically generated stylesheet for sql
 * CSS class: source-sql, CSS id: 
 * GeSHi (C) 2004 - 2007 Nigel McNie, 2007 - 2008 Benny Baumann
 * (http://qbnz.com/highlighter/ and http://geshi.org/)
 * --------------------------------------
 */
.sql.source-sql .de1, .sql.source-sql .de2 {font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;font-family: monospace, monospace;}
.sql.source-sql  {font-family:monospace;}
.sql.source-sql .imp {font-weight: bold; color: red;}
.sql.source-sql li, .sql.source-sql .li1 {font-weight: normal; vertical-align:top;}
.sql.source-sql .ln {width:1px;text-align:right;margin:0;padding:0 2px;vertical-align:top;}
.sql.source-sql .li2 {font-weight: bold; vertical-align:top;}
.sql.source-sql .kw1 {color: #993333; font-weight: bold;}
.sql.source-sql .co1 {color: #808080; font-style: italic;}
.sql.source-sql .coMULTI {color: #808080; font-style: italic;}
.sql.source-sql .es0 {color: #000099; font-weight: bold;}
.sql.source-sql .br0 {color: #66cc66;}
.sql.source-sql .sy0 {color: #66cc66;}
.sql.source-sql .st0 {color: #ff0000;}
.sql.source-sql .nu0 {color: #cc66cc;}
.sql.source-sql .ln-xtra, .sql.source-sql li.ln-xtra, .sql.source-sql div.ln-xtra {background-color: #ffc;}
.sql.source-sql span.xtra { display:block; }

/*]]>*/
</style>
<style type="text/css">/*<![CDATA[*/
.source-mysql {line-height: normal;}
.source-mysql li, .source-mysql pre {
	line-height: normal; border: 0px none white;
}
/**
 * GeSHi Dynamically Generated Stylesheet
 * --------------------------------------
 * Dynamically generated stylesheet for mysql
 * CSS class: source-mysql, CSS id: 
 * GeSHi (C) 2004 - 2007 Nigel McNie, 2007 - 2008 Benny Baumann
 * (http://qbnz.com/highlighter/ and http://geshi.org/)
 * --------------------------------------
 */
.mysql.source-mysql .de1, .mysql.source-mysql .de2 {font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;font-family: monospace, monospace;}
.mysql.source-mysql  {font-family:monospace;}
.mysql.source-mysql .imp {font-weight: bold; color: red;}
.mysql.source-mysql li, .mysql.source-mysql .li1 {font-weight: normal; vertical-align:top;}
.mysql.source-mysql .ln {width:1px;text-align:right;margin:0;padding:0 2px;vertical-align:top;}
.mysql.source-mysql .li2 {font-weight: bold; vertical-align:top;}
.mysql.source-mysql .kw1 {color: #990099; font-weight: bold;}
.mysql.source-mysql .kw2 {color: #990099; font-weight: bold;}
.mysql.source-mysql .kw3 {color: #9900FF; font-weight: bold;}
.mysql.source-mysql .kw4 {color: #999900; font-weight: bold;}
.mysql.source-mysql .kw5 {color: #999900; font-weight: bold;}
.mysql.source-mysql .kw6 {color: #FF9900; font-weight: bold;}
.mysql.source-mysql .kw7 {color: #FF9900; font-weight: bold;}
.mysql.source-mysql .kw8 {color: #9900FF; font-weight: bold;}
.mysql.source-mysql .kw9 {color: #9900FF; font-weight: bold;}
.mysql.source-mysql .kw10 {color: #CC0099; font-weight: bold;}
.mysql.source-mysql .kw11 {color: #CC0099; font-weight: bold;}
.mysql.source-mysql .kw12 {color: #009900;}
.mysql.source-mysql .kw13 {color: #000099;}
.mysql.source-mysql .kw14 {color: #000099;}
.mysql.source-mysql .kw15 {color: #000099;}
.mysql.source-mysql .kw16 {color: #000099;}
.mysql.source-mysql .kw17 {color: #000099;}
.mysql.source-mysql .kw18 {color: #000099;}
.mysql.source-mysql .kw19 {color: #000099;}
.mysql.source-mysql .kw20 {color: #000099;}
.mysql.source-mysql .kw21 {color: #000099;}
.mysql.source-mysql .kw22 {color: #000099;}
.mysql.source-mysql .kw23 {color: #000099;}
.mysql.source-mysql .kw24 {color: #000099;}
.mysql.source-mysql .kw25 {color: #000099;}
.mysql.source-mysql .kw26 {color: #000099;}
.mysql.source-mysql .kw27 {color: #00CC00;}
.mysql.source-mysql .coMULTI {color: #808000; font-style: italic;}
.mysql.source-mysql .co1 {color: #808080; font-style: italic;}
.mysql.source-mysql .co2 {color: #808080; font-style: italic;}
.mysql.source-mysql .es0 {color: #004000; font-weight: bold;}
.mysql.source-mysql .es1 {color: #008080; font-weight: bold;}
.mysql.source-mysql .br0 {color: #FF00FF;}
.mysql.source-mysql .sy1 {color: #CC0099;}
.mysql.source-mysql .sy2 {color: #000033;}
.mysql.source-mysql .st0 {color: #008000;}
.mysql.source-mysql .nu0 {color: #008080;}
.mysql.source-mysql .ln-xtra, .mysql.source-mysql li.ln-xtra, .mysql.source-mysql div.ln-xtra {background-color: #ffc;}
.mysql.source-mysql span.xtra { display:block; }

/*]]>*/
</style>
<style type="text/css">/*<![CDATA[*/
.source-bash {line-height: normal;}
.source-bash li, .source-bash pre {
	line-height: normal; border: 0px none white;
}
/**
 * GeSHi Dynamically Generated Stylesheet
 * --------------------------------------
 * Dynamically generated stylesheet for bash
 * CSS class: source-bash, CSS id: 
 * GeSHi (C) 2004 - 2007 Nigel McNie, 2007 - 2008 Benny Baumann
 * (http://qbnz.com/highlighter/ and http://geshi.org/)
 * --------------------------------------
 */
.bash.source-bash .de1, .bash.source-bash .de2 {font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;font-family: monospace, monospace;}
.bash.source-bash  {font-family:monospace;}
.bash.source-bash .imp {font-weight: bold; color: red;}
.bash.source-bash li, .bash.source-bash .li1 {font-weight: normal; vertical-align:top;}
.bash.source-bash .ln {width:1px;text-align:right;margin:0;padding:0 2px;vertical-align:top;}
.bash.source-bash .li2 {font-weight: bold; vertical-align:top;}
.bash.source-bash .kw1 {color: #000000; font-weight: bold;}
.bash.source-bash .kw2 {color: #c20cb9; font-weight: bold;}
.bash.source-bash .kw3 {color: #7a0874; font-weight: bold;}
.bash.source-bash .co0 {color: #666666; font-style: italic;}
.bash.source-bash .co1 {color: #800000;}
.bash.source-bash .co2 {color: #cc0000; font-style: italic;}
.bash.source-bash .co3 {color: #000000; font-weight: bold;}
.bash.source-bash .co4 {color: #666666;}
.bash.source-bash .es1 {color: #000099; font-weight: bold;}
.bash.source-bash .es2 {color: #007800;}
.bash.source-bash .es3 {color: #007800;}
.bash.source-bash .es4 {color: #007800;}
.bash.source-bash .es5 {color: #780078;}
.bash.source-bash .es_h {color: #000099; font-weight: bold;}
.bash.source-bash .br0 {color: #7a0874; font-weight: bold;}
.bash.source-bash .sy0 {color: #000000; font-weight: bold;}
.bash.source-bash .st0 {color: #ff0000;}
.bash.source-bash .st_h {color: #ff0000;}
.bash.source-bash .nu0 {color: #000000;}
.bash.source-bash .re0 {color: #007800;}
.bash.source-bash .re1 {color: #007800;}
.bash.source-bash .re2 {color: #007800;}
.bash.source-bash .re4 {color: #007800;}
.bash.source-bash .re5 {color: #660033;}
.bash.source-bash .ln-xtra, .bash.source-bash li.ln-xtra, .bash.source-bash div.ln-xtra {background-color: #ffc;}
.bash.source-bash span.xtra { display:block; }

/*]]>*/
</style>
<!--[if lt IE 7]><style type="text/css">body{behavior:url("/skins/Vector/csshover.min.htc")}</style><![endif]-->
</head>
<body class="mediawiki ltr sitedir-ltr ns-0 ns-subject page-MariaDB_Galera_Cluster_la_réplication_multi_maitres skin-vector action-view vector-animateLayout">
		<div id="mw-page-base" class="noprint"></div>
		<div id="mw-head-base" class="noprint"></div>
		<div id="content" class="mw-body" role="main">
			<a id="top"></a>

						<h1 id="firstHeading" class="firstHeading" lang="en"><span dir="auto">MariaDB Galera Cluster : la réplication multi maitres</span></h1>
						<div id="bodyContent" class="mw-body-content">
									<div id="siteSub">From Deimos.fr / Bloc Notes Informatique</div>
								<div id="contentSub"></div>
												<div id="jump-to-nav" class="mw-jump">
					Jump to:					<a href="./MariaDB_Galera_Cluster_:_la_réplication_multi_maitres.html#mw-navigation">navigation</a>, 					<a href="./MariaDB_Galera_Cluster_:_la_réplication_multi_maitres.html#p-search">search</a>
				</div>
				<div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr"><div id="toc" class="toc"><div id="toctitle"><h2>Contents</h2></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="./MariaDB_Galera_Cluster_:_la_réplication_multi_maitres.html#Introduction"><span class="tocnumber">1</span> <span class="toctext">Introduction</span></a></li>
<li class="toclevel-1 tocsection-2"><a href="./MariaDB_Galera_Cluster_:_la_réplication_multi_maitres.html#Installation"><span class="tocnumber">2</span> <span class="toctext">Installation</span></a></li>
<li class="toclevel-1 tocsection-3"><a href="./MariaDB_Galera_Cluster_:_la_réplication_multi_maitres.html#Configuration"><span class="tocnumber">3</span> <span class="toctext">Configuration</span></a>
<ul>
<li class="toclevel-2 tocsection-4"><a href="./MariaDB_Galera_Cluster_:_la_réplication_multi_maitres.html#MariaDB"><span class="tocnumber">3.1</span> <span class="toctext">MariaDB</span></a></li>
<li class="toclevel-2 tocsection-5"><a href="./MariaDB_Galera_Cluster_:_la_réplication_multi_maitres.html#Galera"><span class="tocnumber">3.2</span> <span class="toctext">Galera</span></a></li>
<li class="toclevel-2 tocsection-6"><a href="./MariaDB_Galera_Cluster_:_la_réplication_multi_maitres.html#G.C3.A9o_cluster"><span class="tocnumber">3.3</span> <span class="toctext">Géo cluster</span></a></li>
<li class="toclevel-2 tocsection-7"><a href="./MariaDB_Galera_Cluster_:_la_réplication_multi_maitres.html#M.C3.A9thodes_de_r.C3.A9plications"><span class="tocnumber">3.4</span> <span class="toctext">Méthodes de réplications</span></a>
<ul>
<li class="toclevel-3 tocsection-8"><a href="./MariaDB_Galera_Cluster_:_la_réplication_multi_maitres.html#mysqldump"><span class="tocnumber">3.4.1</span> <span class="toctext">mysqldump</span></a></li>
<li class="toclevel-3 tocsection-9"><a href="./MariaDB_Galera_Cluster_:_la_réplication_multi_maitres.html#Rsync"><span class="tocnumber">3.4.2</span> <span class="toctext">Rsync</span></a></li>
<li class="toclevel-3 tocsection-10"><a href="./MariaDB_Galera_Cluster_:_la_réplication_multi_maitres.html#XtraBackup"><span class="tocnumber">3.4.3</span> <span class="toctext">XtraBackup</span></a></li>
<li class="toclevel-3 tocsection-11"><a href="./MariaDB_Galera_Cluster_:_la_réplication_multi_maitres.html#Sp.C3.A9cifier_un_donor"><span class="tocnumber">3.4.4</span> <span class="toctext">Spécifier un donor</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-12"><a href="./MariaDB_Galera_Cluster_:_la_réplication_multi_maitres.html#Utilisation"><span class="tocnumber">4</span> <span class="toctext">Utilisation</span></a>
<ul>
<li class="toclevel-2 tocsection-13"><a href="./MariaDB_Galera_Cluster_:_la_réplication_multi_maitres.html#Cr.C3.A9ation_du_cluster"><span class="tocnumber">4.1</span> <span class="toctext">Création du cluster</span></a></li>
<li class="toclevel-2 tocsection-14"><a href="./MariaDB_Galera_Cluster_:_la_réplication_multi_maitres.html#Ajouter_des_noeuds_dans_le_cluster"><span class="tocnumber">4.2</span> <span class="toctext">Ajouter des noeuds dans le cluster</span></a></li>
<li class="toclevel-2 tocsection-15"><a href="./MariaDB_Galera_Cluster_:_la_réplication_multi_maitres.html#V.C3.A9rifier_l.27.C3.A9tat_du_cluster"><span class="tocnumber">4.3</span> <span class="toctext">Vérifier l'état du cluster</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-16"><a href="./MariaDB_Galera_Cluster_:_la_réplication_multi_maitres.html#Garbd_.28quorum.29"><span class="tocnumber">5</span> <span class="toctext">Garbd (quorum)</span></a></li>
<li class="toclevel-1 tocsection-17"><a href="./MariaDB_Galera_Cluster_:_la_réplication_multi_maitres.html#Sauvegardes_et_restaurations"><span class="tocnumber">6</span> <span class="toctext">Sauvegardes et restaurations</span></a>
<ul>
<li class="toclevel-2 tocsection-18"><a href="./MariaDB_Galera_Cluster_:_la_réplication_multi_maitres.html#Installation_2"><span class="tocnumber">6.1</span> <span class="toctext">Installation</span></a></li>
<li class="toclevel-2 tocsection-19"><a href="./MariaDB_Galera_Cluster_:_la_réplication_multi_maitres.html#Utilisation_2"><span class="tocnumber">6.2</span> <span class="toctext">Utilisation</span></a>
<ul>
<li class="toclevel-3 tocsection-20"><a href="./MariaDB_Galera_Cluster_:_la_réplication_multi_maitres.html#Sauvegarde"><span class="tocnumber">6.2.1</span> <span class="toctext">Sauvegarde</span></a></li>
<li class="toclevel-3 tocsection-21"><a href="./MariaDB_Galera_Cluster_:_la_réplication_multi_maitres.html#Restauration"><span class="tocnumber">6.2.2</span> <span class="toctext">Restauration</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-22"><a href="./MariaDB_Galera_Cluster_:_la_réplication_multi_maitres.html#R.C3.A9cup.C3.A9ration_et_maintenance"><span class="tocnumber">7</span> <span class="toctext">Récupération et maintenance</span></a>
<ul>
<li class="toclevel-2 tocsection-23"><a href="./MariaDB_Galera_Cluster_:_la_réplication_multi_maitres.html#M.C3.A9thode_automatique"><span class="tocnumber">7.1</span> <span class="toctext">Méthode automatique</span></a></li>
<li class="toclevel-2 tocsection-24"><a href="./MariaDB_Galera_Cluster_:_la_réplication_multi_maitres.html#M.C3.A9thode_manuelle"><span class="tocnumber">7.2</span> <span class="toctext">Méthode manuelle</span></a></li>
<li class="toclevel-2 tocsection-25"><a href="./MariaDB_Galera_Cluster_:_la_réplication_multi_maitres.html#Forcer_un_noeud_.C3.A0_se_resynchroniser"><span class="tocnumber">7.3</span> <span class="toctext">Forcer un noeud à se resynchroniser</span></a></li>
<li class="toclevel-2 tocsection-26"><a href="./MariaDB_Galera_Cluster_:_la_réplication_multi_maitres.html#Split_brain"><span class="tocnumber">7.4</span> <span class="toctext">Split brain</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-27"><a href="./MariaDB_Galera_Cluster_:_la_réplication_multi_maitres.html#FAQ"><span class="tocnumber">8</span> <span class="toctext">FAQ</span></a>
<ul>
<li class="toclevel-2 tocsection-28"><a href="./MariaDB_Galera_Cluster_:_la_réplication_multi_maitres.html#Un_de_mes_services_MariaDB_refuse_de_d.C3.A9marrer_apr.C3.A8s_arr.C3.AAt_de_celui_ci"><span class="tocnumber">8.1</span> <span class="toctext">Un de mes services MariaDB refuse de démarrer après arrêt de celui ci</span></a></li>
<li class="toclevel-2 tocsection-29"><a href="./MariaDB_Galera_Cluster_:_la_réplication_multi_maitres.html#.2Fdev.2Fstderr:_Permission_denied"><span class="tocnumber">8.2</span> <span class="toctext">/dev/stderr: Permission denied</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-30"><a href="./MariaDB_Galera_Cluster_:_la_réplication_multi_maitres.html#References"><span class="tocnumber">9</span> <span class="toctext">References</span></a></li>
</ul>
</div>

<table class="config_array" align="right" style="width:20em; font-size:90%; text-align:left; border: 1px #d0e7ff solid; margin-left:10px;">
   <tr>
      <td class="config_subarray" colspan="2" style="text-align:center;"><a href="./File:GaleraCluster_logo.png.html" class="image" title="MariaDB"><img alt="MariaDB" src="images/9/97/GaleraCluster_logo.png" width="220" height="83" /></a></td>
   </tr><tr><td colspan="2" style="text-align:center;"><hr class="gradient" /></td></tr><tr>
      <th>Software version</th>
      <td>5.5</td>
   </tr><tr>
      <th>Operating System</th>
      <td>Debian 7</td>
   </tr><tr>
      <th>Website</th>
      <td><a rel="nofollow" class="external text" href="http://mariadb.org/">MariaDB Website</a></td>
   </tr><tr>
      <th>Last Update</th>
      <td>19/04/2014</td>
   </tr><tr>
      <th>Others</th>
      <td>Galera 23.2.4(r147)</td>
   </tr>
</table>
<h1><span class="mw-headline" id="Introduction"><span class="mw-headline-number">1</span> Introduction</span></h1>
<p>Si vous avez déjà fait de la réplication MySQL, vous avez que vous êtes limités à 2 nœuds maitre maximum. Que beaucoup d'actions se font à la main et qu'il est donc difficile d'avoir quelque chose de scalable et surtout accessible en écriture en simultané, du fait que par défaut les écritures soient synchrones.
<p>Note: Si vous avez besoin de conseil ou de support sur MySQL/MariaDB/Galera, je vous recommande la société <a href="https://www.oceandba.fr/">OceanDBA</a></p>
</p><p>Il existe donc un outil appelé <a rel="nofollow" class="external text" href="http://www.codership.com">Galera</a> qui s'intègre à MariaDB ou MySQL (via recompilation dans les 2 cas) et qui permet de faire du multi maitres (3 nœuds minimum). Il existe plusieurs produits qui utilisent Galera&#160;:
</p>
<ul><li> MariaDB Galera Cluster</li>
<li> Percona Cluster</li>
<li> MySQL Galera Cluster</li></ul>
<p>Pour ceux qui se posent la question, c'est vraiment différent de MySQL Cluster qui sait scaler les écritures. Ici c'est multi threadé uniquement. Et contrairement à MHA qui est une solution asynchrone, Galera est synchrone.<br />
Galera ne fonctionne <b>que pour le moteur InnoDB</b> et permet&#160;:
</p>
<ul><li> Les réplications synchrones</li>
<li> Des réplications multi maitres actifs</li>
<li> Lecture/Écriture sur plusieurs nœuds simultané</li>
<li> Détection automatique lorsqu'un nœud tombe</li>
<li> Réintégration d'un nœud automatiquement</li>
<li> Pas de lag au niveau des slaves</li>
<li> Aucunes transactions perdues</li>
<li> Latences clientes plus faible</li></ul>
<p>Bien que cela semble parfait sur le papier, il y a <a rel="nofollow" class="external text" href="http://www.codership.com/wiki/doku.php?id=limitations">quelques limitations</a>&#160;:
</p>
<ul><li> Supporte uniquement InnoDB</li>
<li> Il faut qu'il y est des clés primaires sur toutes les tables</li>
<li> DELETE ne fonctionne que sur les tables munies de clefs primaires</li>
<li> LOCK/UNLOCK/GET_LOCK/RELEASE_LOCK ne fonctionne pas en multi maitre</li>
<li> Les query logs ne peuvent être envoyés sur des tables, mais uniquement sur des fichiers</li>
<li> Les transactions XA ne sont pas supportées</li></ul>
<p>Pour vous aider à comprendre une architecture type&#160;:
</p><p><a href="./File:Galera.png.html" class="image"><img alt="Galera.png" src="images/a/a9/Galera.png" width="462" height="363" /></a><sup id="cite_ref-1" class="reference"><a href="./MariaDB_Galera_Cluster_:_la_réplication_multi_maitres.html#cite_note-1">[1]</a></sup>
</p><p>Sachez également qu'un outil en ligne aide à la construction de ce genre d'infrastructures&#160;: <a rel="nofollow" class="external text" href="http://www.severalnines.com/galera-configurator/">Galera Configurator</a><sup id="cite_ref-2" class="reference"><a href="./MariaDB_Galera_Cluster_:_la_réplication_multi_maitres.html#cite_note-2">[2]</a></sup>
</p>
<h1><span class="mw-headline" id="Installation"><span class="mw-headline-number">2</span> Installation</span></h1>
<p>To install MariaDB, it's unfortunately not embedded in Debian, so we'll add a repository. First of all, install a python tool to get aptkey&#160;: 
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> aptitude</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">aptitude install python-software-properties</pre></div></div>
</td></tr></table><br />
<p>Then let's add this repository (<a rel="nofollow" class="external free" href="https://downloads.mariadb.org/mariadb/repositories/">https://downloads.mariadb.org/mariadb/repositories/</a>)&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> </font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">apt-key adv --recv-keys --keyserver keyserver.ubuntu.com 0xcbcb082a1bb943db
add-apt-repository 'deb http://mirrors.linsrv.net/mariadb/repo/10.0/debian wheezy main'</pre></div></div>
</td></tr></table><br />
<p>We're now going to change apt pinning to prioritize MariaDB's repository&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/apt/preferences.d/mariadb</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">Package: *
Pin: release o=MariaDB
Pin-Priority: 1000</pre></div></div>
</td></tr></table><br />
<table width="100%" class="notes_array">
<tr>
<td class="notes_subarray"> <font size="-1"><a href="./File:Notes_file.png.html" class="image" title="Notes"><img alt="Notes" src="images/2/20/Notes_file.png" width="31" height="32" /></a> Notes</font>
</td></tr>
<tr>
<td>A l'heure ou j'écris ces lignes, il y a un petit problème de dépendances avec certains packages. Il faudra donc les télécharger au préalable et les installer. Vous n'avez pas besoin de suivre la fin de cette installation si vous n'avez pas rencontré d'erreurs avec les étapes précédentes
</td></tr></table><br />
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> </font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">wget http://ftp.fr.debian.org/debian/pool/main/o/openssl/libssl0.9.8_0.9.8o-4squeeze14_amd64.deb
dpkg -i libssl0.9.8_0.9.8o-4squeeze14_amd64.deb</pre></div></div>
</td></tr></table><br />
<p>Maintenant, nous allons installer MariaDB et Galera&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> aptitude</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">aptitude update
aptitude install mariadb-galera-server galera rsync openntpd</pre></div></div>
</td></tr></table><br />
<table width="100%" class="notes_array">
<tr>
<td class="notes_subarray"> <font size="-1"><a href="./File:Notes_file.png.html" class="image" title="Notes"><img alt="Notes" src="images/2/20/Notes_file.png" width="31" height="32" /></a> Notes</font>
</td></tr>
<tr>
<td>Le package rsync n'est pas obligatoire, mais nécessaire si vous allez utiliser cette méthode de transfert par la suite
</td></tr></table><br />
<h1><span class="mw-headline" id="Configuration"><span class="mw-headline-number">3</span> Configuration</span></h1>
<h2><span class="mw-headline" id="MariaDB"><span class="mw-headline-number">3.1</span> MariaDB</span></h2>
<p>Avant de commencer à toucher à la configuration, nous allons devoir supprimer des fichiers de logs sous peine que MariaDB ne démarre plus. Il va donc falloir couper le service mariadb&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> service</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">service mysql stop</pre></div></div>
</td></tr></table><br />
<p>Puis nous mettons cette configuration MariaDB&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/mysql/my.cnf</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1"># MariaDB database server configuration file.
# Pierre Mavro / Deimosfr
#
# You can copy this file to one of:
# - &quot;/etc/mysql/my.cnf&quot; to set global options,
# - &quot;~/.my.cnf&quot; to set user-specific options.
# 
# One can use all long options that the program supports.
# Run program with --help to get a list of available options and with
# --print-defaults to see which it would actually understand and use.
#
# For explanations see
# http://dev.mysql.com/doc/mysql/en/server-system-variables.html
&#160;
# This will be passed to all mysql clients
# It has been reported that passwords should be enclosed with ticks/quotes
# escpecially if they contain &quot;#&quot; chars...
# Remember to edit /etc/mysql/debian.cnf when changing the socket location.
[client]
port		= 3306
socket		= /var/run/mysqld/mysqld.sock
&#160;
# Here is entries for some specific programs
# The following values assume you have at least 32M ram
&#160;
# This was formally known as [safe_mysqld]. Both versions are currently parsed.
[mysqld_safe]
socket		= /var/run/mysqld/mysqld.sock
nice		= 0
&#160;
[mysqld]
#
# * Basic Settings
#
user		= mysql
pid-file	= /var/run/mysqld/mysqld.pid
socket		= /var/run/mysqld/mysqld.sock
port		= 3306
basedir		= /usr
datadir		= /var/lib/mysql
innodb_log_group_home_dir = /var/lib/mysql
tmpdir		= /tmp
lc_messages_dir	= /usr/share/mysql
lc_messages	= en_US
skip-external-locking
&#160;
character_set_server = utf8
collation_server = utf8_general_ci
&#160;
#
# Instead of skip-networking the default is now to listen only on
# localhost which is more compatible and is not less secure.
bind-address		= 0.0.0.0
#
# * Fine Tuning
#
max_connections		= 500
connect_timeout		= 5
wait_timeout		= 600
max_allowed_packet	= 16M
thread_cache_size       = 128
sort_buffer_size	= 16M
bulk_insert_buffer_size	= 16M
tmp_table_size		= 32M
max_heap_table_size	= 64M
net_buffer_length	= 4k
&#160;
#
# * MyISAM
#
# This replaces the startup script and checks MyISAM tables if needed
# the first time they are touched. On error, make copy and try a repair.
myisam_recover          = BACKUP
key_buffer_size		= 128M
#open-files-limit	= 2000
table_open_cache	= 400
myisam_sort_buffer_size	= 512M
concurrent_insert	= 2
read_buffer_size	= 2M
read_rnd_buffer_size	= 1M
#
# * Query Cache Configuration
#
# Cache only tiny result sets, so we can fit more in the query cache.
query_cache_limit		= 128K
query_cache_size		= 64M
# for more write intensive setups, set to DEMAND or OFF
#query_cache_type		= DEMAND
#
# * Logging and Replication
#
# Both location gets rotated by the cronjob.
# Be aware that this log type is a performance killer.
# As of 5.1 you can enable the log at runtime!
#general_log_file        = /var/log/mysql/mysql.log
#general_log             = 1
#
# Error logging goes to syslog due to /etc/mysql/conf.d/mysqld_safe_syslog.cnf.
#
# we do want to know about network errors and such
log_warnings		= 2
#
# Enable the slow query log to see queries with especially long duration
#slow_query_log[={0|1}]
slow_query_log_file	= /var/log/mysql/mariadb-slow.log
long_query_time = 10
#log_slow_rate_limit	= 1000
log_slow_verbosity	= query_plan
&#160;
#log-queries-not-using-indexes
#log_slow_admin_statements
#
# The following can be used as easy to replay backup logs or for replication.
# note: if you are setting up a replication slave, see README.Debian about
#       other settings you may need to change.
#server-id		= 1
#report_host		= master1
#auto_increment_increment = 2
#auto_increment_offset	= 1
log_bin			= /var/log/mysql/mariadb-bin
log_bin_index		= /var/log/mysql/mariadb-bin.index
# not fab for performance, but safer
#sync_binlog		= 1
expire_logs_days	= 10
max_binlog_size         = 100M
# slaves
#relay_log		= /var/log/mysql/relay-bin
#relay_log_index	= /var/log/mysql/relay-bin.index
#relay_log_info_file	= /var/log/mysql/relay-bin.info
#log_slave_updates
#read_only
#
# If applications support it, this stricter sql_mode prevents some
# mistakes like inserting invalid dates etc.
#sql_mode		= NO_ENGINE_SUBSTITUTION,TRADITIONAL
#
# * InnoDB
#
# InnoDB is enabled by default with a 10MB datafile in /var/lib/mysql/.
# Read the manual for more InnoDB related options. There are many!
default_storage_engine	= InnoDB
# you can't just change log file size, requires special procedure
#innodb_log_file_size			= 50M
innodb_buffer_pool_size			= 256M
innodb_log_buffer_size			= 8M
innodb_log_file_size			= 256M
thread_concurrency			= 64
innodb_thread_concurrency		= 64
innodb_read_io_threads			= 16
innodb_write_io_threads			= 16
innodb_flush_log_at_trx_commit 		= 2
innodb_file_per_table			= 1
innodb_open_files			= 400
innodb_io_capacity			= 600
innodb_lock_wait_timeout 		= 60
innodb_flush_method			= O_DIRECT
innodb_doublewrite 			= 0
innodb_additional_mem_pool_size		= 20M
innodb_buffer_pool_restore_at_startup	= 500
innodb_file_per_table
#
# * Security Features
#
# Read the manual, too, if you want chroot!
# chroot = /var/lib/mysql/
#
# For generating SSL certificates I recommend the OpenSSL GUI &quot;tinyca&quot;.
#
# ssl-ca=/etc/mysql/cacert.pem
# ssl-cert=/etc/mysql/server-cert.pem
# ssl-key=/etc/mysql/server-key.pem
&#160;
[mysqldump]
quick
quote-names
max_allowed_packet	= 16M
&#160;
[mysql]
#no-auto-rehash	# faster start of mysql but no tab completition
&#160;
[isamchk]
key_buffer		= 16M
&#160;
[mysqlhotcopy]
interactive-timeout
&#160;
#
# * IMPORTANT: Additional settings that can override those from this file!
#   The files must end with '.cnf', otherwise they'll be ignored.
#
!includedir /etc/mysql/conf.d/</pre></div></div>
</td></tr></table><br />
<p>Nous allons maintenant supprimer les fichiers de logs car nous venons de toucher à leurs confs (sous peine de ne pas pouvoir démarrer d'instances) et pouvoir démarrer notre service MariaDB&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> </font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">rm /var/lib/mysql/ib_logfile*
service mysql start</pre></div></div>
</td></tr></table><br />
<h2><span class="mw-headline" id="Galera"><span class="mw-headline-number">3.2</span> Galera</span></h2>
<p>Voici la configuration à appliquer pour un cluster sur le même site&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/mysql/conf.d/mariadb.cnf</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1"># MariaDB-specific config file.
# Read by /etc/mysql/my.cnf
&#160;
[client]
# Default is Latin1, if you need UTF-8 set this (also in server section)
#default-character-set = utf8
&#160;
[mysqld]
#
# * Character sets
#
# Default is Latin1, if you need UTF-8 set all this (also in client section)
#
#character-set-server  = utf8
#collation-server      = utf8_general_ci
#character_set_server   = utf8
#collation_server       = utf8_general_ci
&#160;
<span class="xtra ln-xtra"># Load Galera Cluster</span><span class="xtra ln-xtra">wsrep_provider = /usr/lib/galera/libgalera_smm.so</span><span class="xtra ln-xtra">wsrep_cluster_name='mariadb_cluster'</span><span class="xtra ln-xtra">wsrep_node_name=node2</span><span class="xtra ln-xtra">wsrep_node_address=&quot;10.0.0.2&quot;</span><span class="xtra ln-xtra">wsrep_cluster_address = 'gcomm://10.0.0.1,10.0.0.2,10.0.0.3,10.0.0.4'</span><span class="xtra ln-xtra">wsrep_retry_autocommit = 0</span><span class="xtra ln-xtra">wsrep_sst_method = rsync</span><span class="xtra ln-xtra">wsrep_provider_options=&quot;gcache.size = 1G; gcache.name = /tmp/galera.cache&quot;</span>#wsrep_replication_myisam = 1
#wsrep_sst_receive_address = &lt;x.x.x.x&gt;
#wsrep_notify_cmd=&quot;script.sh&quot;
&#160;
# Other mysqld options
binlog_format = ROW
innodb_autoinc_lock_mode = 2
innodb_flush_log_at_trx_commit = 2
innodb_locks_unsafe_for_binlog = 1</pre></div></div>
</td></tr></table><br />
<ul><li> wsrep_cluster_name&#160;: le nom du cluster Galera. A utiliser, surtout si vous disposez de plusieurs cluster Galera dans le même subnet, afin d'éviter que certains noeuds entrent dans le mauvais cluster.</li>
<li> wsrep_node_name&#160;: le nom de la machine sur laquelle se trouve ce fichier de configuration. Vous l'aurez compris, <b>il faut a tout prix éviter les doublons</b> (surtout pour le debug&#160;;-))</li>
<li> wsrep_node_address&#160;: adresse ip du noeud actuel (même avertissement que la ligne précédente)</li>
<li> wsrep_cluster_address&#160;: liste des membres du cluster pouvant être maitre (séparé par des virgules).</li>
<li> wsrep_provider_options&#160;: permet d'activer des <a rel="nofollow" class="external text" href="http://www.codership.com/wiki/doku.php?id=galera_parameters_0.8">options supplémentaires</a>.
<ul><li> gcache permet de stocker les données à transférer aux autres noeuds. Par défaut à 128M, il est conseillé d'augmenter cette valeur.<sup id="cite_ref-3" class="reference"><a href="./MariaDB_Galera_Cluster_:_la_réplication_multi_maitres.html#cite_note-3">[3]</a></sup></li></ul></li>
<li> wsrep_retry_autocommit&#160;: permet de définir le nombre de tentatives une requête doit être réexécutée en cas de conflit.</li>
<li> wsrep_sst_method&#160;: la méthode d'échange des données. Rsync est la plus rapide à l'heure actuelle.<sup id="cite_ref-4" class="reference"><a href="./MariaDB_Galera_Cluster_:_la_réplication_multi_maitres.html#cite_note-4">[4]</a></sup></li>
<li> wsrep_replication_myisam&#160;: permet d'activer la réplication des données MyISAM (<b>pas de gestion des transactions...a éviter donc&#160;!</b>)</li>
<li> wsrep_sst_receive_address&#160;: permet de forcer l'utilisation d'une certaine adresse pour que les hôtes distants puissent se connecter (résous les problèmes de VIP)</li>
<li> wsrep_notify_cmd&#160;: permet d’exécuter un script à chaque évènement de Galera (changement d'état d'un nœud)</li>
<li> binlog_format&#160;: permet de définir le format des logs en mode ROW</li>
<li> innodb_autoinc_lock_mode&#160;: modifie le comportement des verrous</li>
<li> innodb_flush_log_at_trx_commit&#160;: optimisation des performances</li></ul>
<table width="100%" class="notes_array">
<tr>
<td class="notes_subarray"> <font size="-1"><a href="./File:Notes_file.png.html" class="image" title="Notes"><img alt="Notes" src="images/2/20/Notes_file.png" width="31" height="32" /></a> Notes</font>
</td></tr>
<tr>
<td>Adaptez les lignes <i>wsrep_node_name</i> et <i>wsrep_cluster_address</i> à vos machines respectives.
</td></tr></table><br />
<p>La configuration ci dessus est applicable pour tous les nœuds, sauf pour le maitre (celui qui doit démarrer le premier). Celui ci doit avoir la configuration identique, à la seule différence de cette ligne&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/mysql/conf.d/mariadb.cnf</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">wsrep_cluster_address = 'gcomm://'</pre></div></div>
</td></tr></table><br />
<table width="100%" class="warning_array">
<tr>
<td class="warning_subarray"> <font size="-1"><a href="./File:Warning_file.png.html" class="image" title="Warning"><img alt="Warning" src="images/0/09/Warning_file.png" width="39" height="32" /></a> <b>WARNING</b></font>
</td></tr>
<tr>
<td>Il est important <b>qu'une seule machine</b> ai la configuration 'gcomm://', car c'est l'initialisation du cluster
</td></tr></table><br />
<h2><span class="mw-headline" id="G.C3.A9o_cluster"><span class="mw-headline-number">3.3</span> Géo cluster</span></h2>
<p>Il est possible de faire du Géo cluster, l'inconvénient c'est que lorsqu'il y a une coupure suppérieure aux timeouts indiqués, un des clusters va devoir se resynchroniser entièrement. Voici la ligne à configurer pour modifier ces timeouts&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/mysql/conf.d/mariadb.cnf</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">[...]
wsrep_provider_options = &quot;evs.keepalive_period = PT3S; evs.inactive_check_period = PT10S; evs.suspect_timeout = PT30S; evs.inactive_timeout = PT1M; evs.install_timeout = PT1M&quot;
[...]</pre></div></div>
</td></tr></table><br />
<p>Si vous utilisez l'option 'wsrep_sst_receive_address', il faudra rajouter un paramètre sur cette ligne (ist.recv_addr) et mettre la même ip que l'option 'wsrep_sst_receive_address'&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/mysql/conf.d/mariadb.cnf</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">[...]
wsrep_provider_options = &quot;evs.keepalive_period = PT3S; evs.inactive_check_period = PT10S; evs.suspect_timeout = PT30S; evs.inactive_timeout = PT1M; evs.install_timeout = PT1M; ist.recv_addr = &lt;x.x.x.x&gt;&quot;
[...]</pre></div></div>
</td></tr></table><br />
<h2><span class="mw-headline" id="M.C3.A9thodes_de_r.C3.A9plications"><span class="mw-headline-number">3.4</span> Méthodes de réplications</span></h2>
<p>Il existe plusieurs solutions pour les transferts de données entre noeuds. Dans l'exemple plus haut, nous avons utilisé rsync. Lorsqu'une machine demande à un donor (une autre machine) de recevoir les données, <b>les transactions sont bloqués pour le donneur durant la période d'échange de données avec le receveur&#160;!!!</b>
</p>
<table width="100%" class="warning_array">
<tr>
<td class="warning_subarray"> <font size="-1"><a href="./File:Warning_file.png.html" class="image" title="Warning"><img alt="Warning" src="images/0/09/Warning_file.png" width="39" height="32" /></a> <b>WARNING</b></font>
</td></tr>
<tr>
<td>Si vous utilisez un load balancer, il faudra sortir le noeud donneur pendant cette période là
</td></tr></table><br />
<p>Ce blocage peut être toutefois limité en utilisant <a href="./MariaDB_Galera_Cluster_:_la_réplication_multi_maitres.html#XtraBackup">la méthode xtrabackup</a>.
</p>
<h3><span class="mw-headline" id="mysqldump"><span class="mw-headline-number">3.4.1</span> mysqldump</span></h3>
<p>SST (State Snapshot Transfert) va permettre de faire des échanges complets (uniquement, pas d'incrémentale). Il faut donc créer un utilisateur sur toutes les machines&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> mysql</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">grant all on *.* to 'sst_user'@'%' identified by 'sst_password';</pre></div></div>
</td></tr></table><br />
<p>Puis modifier la configuration pour que le user et le password concordent&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/mysql/conf.d/mariadb.cnf</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">[...]
wsrep_sst_auth = 'sst_user:sst_password'
[...]</pre></div></div>
</td></tr></table><br />
<p>Du coup, lorsque l'on intègre un nouveau noeud, on peut constater qu'un nœud est passé en donneur&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> mysql</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="sql source-sql"><pre class="de1">MariaDB <span class="br0">&#91;</span><span class="br0">&#40;</span><span class="kw1">NONE</span><span class="br0">&#41;</span><span class="br0">&#93;</span><span class="sy0">&gt;</span> <span class="kw1">SHOW</span> global <span class="kw1">STATUS</span> <span class="kw1">LIKE</span> <span class="st0">'wsrep%stat%'</span>;
<span class="sy0">+</span><span class="co1">---------------------------+--------------------------------------+</span>
<span class="sy0">|</span> Variable_name             <span class="sy0">|</span> <span class="kw1">VALUE</span>                                <span class="sy0">|</span>
<span class="sy0">+</span><span class="co1">---------------------------+--------------------------------------+</span>
<span class="sy0">|</span> wsrep_local_state_uuid    <span class="sy0">|</span> 3e10ea72<span class="sy0">-</span>f2b9<span class="sy0">-</span>11e2<span class="sy0">-</span>0800<span class="sy0">-</span>4b821a7d26d5 <span class="sy0">|</span>
<span class="sy0">|</span> wsrep_local_state         <span class="sy0">|</span> <span class="nu0">2</span>                                    <span class="sy0">|</span>
<span class="xtra ln-xtra"><span class="sy0">|</span> wsrep_local_state_comment <span class="sy0">|</span> Donor<span class="sy0">/</span>Desynced                       <span class="sy0">|</span></span><span class="sy0">|</span> wsrep_cluster_state_uuid  <span class="sy0">|</span> 3e10ea72<span class="sy0">-</span>f2b9<span class="sy0">-</span>11e2<span class="sy0">-</span>0800<span class="sy0">-</span>4b821a7d26d5 <span class="sy0">|</span>
<span class="sy0">|</span> wsrep_cluster_status      <span class="sy0">|</span> <span class="kw1">PRIMARY</span>                              <span class="sy0">|</span>
<span class="sy0">+</span><span class="co1">---------------------------+--------------------------------------+</span>
<span class="nu0">5</span> <span class="kw1">ROWS</span> <span class="kw1">IN</span> <span class="kw1">SET</span> <span class="br0">&#40;</span><span class="nu0">0.00</span> sec<span class="br0">&#41;</span></pre></div></div>
</td></tr></table><br />
<p>On voit également que la valeur du wsrep_local_state change à 4 pour que le process soit terminé.<sup id="cite_ref-5" class="reference"><a href="./MariaDB_Galera_Cluster_:_la_réplication_multi_maitres.html#cite_note-5">[5]</a></sup>
</p>
<table width="100%" class="notes_array">
<tr>
<td class="notes_subarray"> <font size="-1"><a href="./File:Notes_file.png.html" class="image" title="Notes"><img alt="Notes" src="images/2/20/Notes_file.png" width="31" height="32" /></a> Notes</font>
</td></tr>
<tr>
<td>Le problème de cette méthode est qu'elle ne gère pas les IST (Incremental State Transfert). Tout doit être transféré en cas de problème et pas seulement l'incrémentale. Il faut regarder les méthodes rsync ou xtrabackup pour pouvoir faire de l'IST
</td></tr></table><br />
<h3><span class="mw-headline" id="Rsync"><span class="mw-headline-number">3.4.2</span> Rsync</span></h3>
<p>C'est une méthode très efficace&#160;! L'inconvénient majeur est qu'elle ne permet pas de faire des transferts à chaud. Voici comment configurer le SST&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/mysql/conf.d/mariadb.cnf</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">[...]
wsrep_sst_method = rsync
[...]</pre></div></div>
</td></tr></table><br />
<p>Il faut que les données ne soient plus accédées par MariaDB pour que cela fonctionne correctement. Un autre prérequis est la présence d'rsync sur les serveurs.
</p>
<h3><span class="mw-headline" id="XtraBackup"><span class="mw-headline-number">3.4.3</span> XtraBackup</span></h3>
<p><b>XtraBackup est la meilleure méthode aujourd'hui</b>. Elle permet de faire des transferts en minimisant le temps de lock qui n'est que de quelques secondes. Pour que l'on puisse utiliser cette méthode, il faut installer XtraBackup.
</p><p>Pour l'installer sur une Debian, c'est très simple, nous allons rajouter son repository&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> gpg</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">apt-key adv --keyserver keys.gnupg.net --recv-keys 1C4CBDCDCD2EFD2A</pre></div></div>
</td></tr></table><br />
<p>Créez ce fichier pour ajouter le repository&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/apt/sources.list.d/percona.list</font>
</td></tr>
<tr>
<td>
<pre>deb <a rel="nofollow" class="external free" href="http://repo.percona.com/apt">http://repo.percona.com/apt</a> VERSION main
deb-src <a rel="nofollow" class="external free" href="http://repo.percona.com/apt">http://repo.percona.com/apt</a> VERSION main
</pre>
</td></tr></table><br />
<p>On update et on installe&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> aptitude</font>
</td></tr>
<tr>
<td>
<pre>aptitude update
aptitude install xtrabackup
</pre>
</td></tr></table><br />
<p>Puis on peut configurer nos noeuds pour qu'ils utilisent cette méthode&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/mysql/conf.d/mariadb.cnf</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">[...]
wsrep_sst_method = xtrabackup
[...]</pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="Sp.C3.A9cifier_un_donor"><span class="mw-headline-number">3.4.4</span> Spécifier un donor</span></h3>
<p>Pour ce qui est de la réplication, si vous souhaitez à tout moment dédier une machine en donor (et éventuellement pour les backups) depuis un serveur&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> mysql</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="sql source-sql"><pre class="de1"><span class="kw1">SET</span> global wsrep_sst_donor<span class="sy0">=&lt;</span>node3<span class="sy0">&gt;</span></pre></div></div>
</td></tr></table><br />
<p>Ceci résous la problématique du load balancer cité plus haut et évite les blocages durant un backup.
</p><p>Sinon vous pouvez le spécifier directement pour l'intégration d'un noeud&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> mysqld</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">mysqld --wsrep_cluster_address='gcomm://&lt;node1&gt;' --wsrep_sst_donor='&lt;node1&gt;'</pre></div></div>
</td></tr></table><br />
<table width="100%" class="notes_array">
<tr>
<td class="notes_subarray"> <font size="-1"><a href="./File:Notes_file.png.html" class="image" title="Notes"><img alt="Notes" src="images/2/20/Notes_file.png" width="31" height="32" /></a> Notes</font>
</td></tr>
<tr>
<td>Si vous démarrez 2 fois de suite MariaDB sans lancer au moins une fois une synchro Galera, la 2ème fois, il fera une synchro complète
</td></tr></table><br />
<h1><span class="mw-headline" id="Utilisation"><span class="mw-headline-number">4</span> Utilisation</span></h1>
<p>Avant de passer à l'utilisation, il faut comprendre le principe. Lorsque nous allons démarrer nos instances MariaDB, nous allons nous retrouver dans ce cas de configuration (je n'ai volontairement pas fait toutes les flèches de communication pour éviter que ça devienne trop fouillis, mais tous les nodes discutent entre eux)&#160;:
</p><p><a href="./File:Galera1.png.html" class="image"><img alt="Galera1.png" src="images/9/9b/Galera1.png" width="400" height="400" /></a>
</p>
<ul><li> Le node 1 initialise le cluster avec la valeur du gcomm vide.</li>
<li> Les autres nodes se connectent sur le node 1 et échangent leurs données pour avoir le même niveau de données partout</li></ul>
<h2><span class="mw-headline" id="Cr.C3.A9ation_du_cluster"><span class="mw-headline-number">4.1</span> Création du cluster</span></h2>
<p>Mettez vous sur le <b>node 1</b> afin de créer le cluster. Nous allons l'allumer avec une adresse de cluster vide, qui va indiquer sa création&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> mysqld</font>
</td></tr>
<tr>
<td>
<pre>service mysql start --wsrep_cluster_address='gcomm://'
</pre>
<p>ou
</p>
<pre>mysqld --wsrep_cluster_address='gcomm://'
</pre>
</td></tr></table><br />
<h2><span class="mw-headline" id="Ajouter_des_noeuds_dans_le_cluster"><span class="mw-headline-number">4.2</span> Ajouter des noeuds dans le cluster</span></h2>
<p>Pour joindre des nodes au cluster qui vient d'être créer, c'est simple&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> mysqld</font>
</td></tr>
<tr>
<td>
<pre>service mysql start --wsrep_cluster_address='gcomm://&lt;ip_du_node_1&gt;'
</pre>
<p>ou
</p>
<pre>mysqld --wsrep_cluster_address='gcomm://&lt;ip_du_node_1&gt;'
</pre>
</td></tr></table><br />
<p>Mettez donc l'IP du node 1 pour se connecter à lui. Vous pouvez également simplement démarrer le service MariaDB, car nous avons une configuration qui est fonctionnelle&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> </font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">service mysql start</pre></div></div>
</td></tr></table><br />
<p>Si vous n'arrivez pas à joindre le master, lancez cette commande sur dans mysql sur le master pour être sur qu'il est bien démarré&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> mysql</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="sql source-sql"><pre class="de1"><span class="kw1">SET</span> global wsrep_cluster_address<span class="sy0">=</span><span class="st0">'gcomm://'</span></pre></div></div>
</td></tr></table><br />
<table width="100%" class="notes_array">
<tr>
<td class="notes_subarray"> <font size="-1"><a href="./File:Notes_file.png.html" class="image" title="Notes"><img alt="Notes" src="images/2/20/Notes_file.png" width="31" height="32" /></a> Notes</font>
</td></tr>
<tr>
<td>Vous pouvez utilisez les IP ou des noms DNS
</td></tr></table><br />
<h2><span class="mw-headline" id="V.C3.A9rifier_l.27.C3.A9tat_du_cluster"><span class="mw-headline-number">4.3</span> Vérifier l'état du cluster</span></h2>
<p>Pour vérifier l'état du cluster, voici la commande à exécuter dans MariaDB&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> mysql -uroot -p</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">MariaDB [(none)]&gt; SHOW STATUS LIKE 'wsrep_%';
+--------------------------+----------------------+
| Variable_name            | Value                |
+--------------------------+----------------------+
| wsrep_cluster_conf_id    | 18446744073709551615 |
<span class="xtra ln-xtra">| wsrep_cluster_size       | 0                    |</span>| wsrep_cluster_state_uuid |                      |
| wsrep_cluster_status     | Disconnected         |
| wsrep_connected          | OFF                  |
| wsrep_local_index        | 18446744073709551615 |
| wsrep_provider_name      |                      |
| wsrep_provider_vendor    |                      |
| wsrep_provider_version   |                      |
<span class="xtra ln-xtra">| wsrep_ready              | ON                   |</span>+--------------------------+----------------------+
10 rows in set (0.01 sec)</pre></div></div>
</td></tr></table><br />
<p>Ici je n'ai que mon serveur principale qui tourne. Aucun autre node n'a encore joint le cluster. Mais lorsque j'en ajoute&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> mysql</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">&gt; mysql -uroot -p -e &quot;SHOW STATUS LIKE 'wsrep_%';&quot;
+----------------------------+----------------------------------------------------------------------------+
| Variable_name              | Value                                                                      |
+----------------------------+----------------------------------------------------------------------------+
| wsrep_local_state_uuid     | 9e9f8568-a025-11e2-0800-be0dc874ac98                                       |
| wsrep_protocol_version     | 4                                                                          |
| wsrep_last_committed       | 0                                                                          |
| wsrep_replicated           | 0                                                                          |
| wsrep_replicated_bytes     | 0                                                                          |
| wsrep_received             | 12                                                                         |
| wsrep_received_bytes       | 639                                                                        |
| wsrep_local_commits        | 0                                                                          |
| wsrep_local_cert_failures  | 0                                                                          |
| wsrep_local_bf_aborts      | 0                                                                          |
| wsrep_local_replays        | 0                                                                          |
| wsrep_local_send_queue     | 0                                                                          |
| wsrep_local_send_queue_avg | 0.000000                                                                   |
| wsrep_local_recv_queue     | 0                                                                          |
| wsrep_local_recv_queue_avg | 0.000000                                                                   |
| wsrep_flow_control_paused  | 0.000000                                                                   |
| wsrep_flow_control_sent    | 0                                                                          |
| wsrep_flow_control_recv    | 0                                                                          |
| wsrep_cert_deps_distance   | 0.000000                                                                   |
| wsrep_apply_oooe           | 0.000000                                                                   |
| wsrep_apply_oool           | 0.000000                                                                   |
| wsrep_apply_window         | 0.000000                                                                   |
| wsrep_commit_oooe          | 0.000000                                                                   |
| wsrep_commit_oool          | 0.000000                                                                   |
| wsrep_commit_window        | 0.000000                                                                   |
| wsrep_local_state          | 4                                                                          |
| wsrep_local_state_comment  | Synced                                                                     |
| wsrep_cert_index_size      | 0                                                                          |
| wsrep_causal_reads         | 0                                                                          |
| wsrep_incoming_addresses   | 10.0.0.1:3306,10.0.0.2:3306,10.0.0.3:3306,10.0.0.4:3306                    |
| wsrep_cluster_conf_id      | 2                                                                          |
<span class="xtra ln-xtra">| wsrep_cluster_size         | 4                                                                          |</span>| wsrep_cluster_state_uuid   | 9e9f8568-a025-11e2-0800-be0dc874ac98                                       |
| wsrep_cluster_status       | Primary                                                                    |
| wsrep_connected            | ON                                                                         |
| wsrep_local_index          | 0                                                                          |
| wsrep_provider_name        | Galera                                                                     |
| wsrep_provider_vendor      | Codership Oy &lt;info@codership.com&gt;                                          |
| wsrep_provider_version     | 23.2.4(r147)                                                               |
<span class="xtra ln-xtra">| wsrep_ready                | ON                                                                         |</span>+----------------------------+----------------------------------------------------------------------------+</pre></div></div>
</td></tr></table><br />
<p>Je vois bien ici mes 4 noeuds master&#160;:-)
</p>
<h1><span class="mw-headline" id="Garbd_.28quorum.29"><span class="mw-headline-number">5</span> Garbd (quorum)</span></h1>
<p>Afin d'éviter les split brains (inconsistances cluster), il est conseillé d'utiliser un outil fournit avec le cluster Galera qui agira comme un quorum cluster, <b>surtout si vous êtes en mode 2 noeuds</b> (et c'est généralement là le principale avantage). Voici un cas d'utilisation<sup id="cite_ref-6" class="reference"><a href="./MariaDB_Galera_Cluster_:_la_réplication_multi_maitres.html#cite_note-6">[6]</a></sup>&#160;:
</p>
<pre>
                    ,---------.
                    |  garbd  |
                    `---------'
         ,---------.     |     ,---------.
         | clients |     |     | clients |
         `---------'     |     `---------'
                    \    |    /
                     \ ,---. /
                     ('     `)
                    (   WAN   )
                     (.     ,)
                     / `---' \
                    /         \
         ,---------.           ,---------.
         |  node1  |           |  node2  |
         |  node3  |           |  node4  |
         `---------'           `---------'
        Data Center 1         Data Center 2
</pre>
<p>Il faudra alors utiliser le service garbd. Il est installé de base, mais n'est tout simplement pas activé. Pour le configurer, nous allons éditer sa configuration&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/default/garb</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1"># Copyright (C) 2012 Coedership Oy
# This config file is to be sourced by garb service script.
&#160;
# A space-separated list of node addresses (address[:port]) in the cluster
<span class="xtra ln-xtra">GALERA_NODES=&quot;10.0.0.1:4567 10.0.0.2:4567 10.0.0.3:4567 10.0.0.4:4567&quot;</span>&#160;
# Galera cluster name, should be the same as on the rest of the nodes.
<span class="xtra ln-xtra">GALERA_GROUP=&quot;mariadb_cluster&quot;</span>&#160;
# Optional Galera internal options string (e.g. SSL settings)
# see http://www.codership.com/wiki/doku.php?id=galera_parameters
# GALERA_OPTIONS=&quot;&quot;
&#160;
# Log file for garbd. Optional, by default logs to syslog
# LOG_FILE=&quot;&quot;</pre></div></div>
</td></tr></table><br />
<p>Adaptez le GALERA_NODES avec la liste de tous vos nodes et le GALERA_GROUP avec le nom du cluster Galera. Il ne reste plus qu'à l'activer au démarrage de la machine et démarrer le service&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> </font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">update-rc.d -f garb defaults
service garb start</pre></div></div>
</td></tr></table><br />
<p>Maintenant, sur un de vos noeuds, vous pourrez voir qu'il y a un nouveau node, qui n'est en fait que le quorum&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> mysql</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="mysql source-mysql"><pre class="de1">MariaDB <span class="br0">&#91;</span><span class="br0">&#40;</span>none<span class="br0">&#41;</span><span class="br0">&#93;</span><span class="sy1">&gt;</span> <span class="kw1">SHOW</span> <span class="kw1">STATUS</span> <span class="kw10">LIKE</span> <span class="st0">'wsrep<span class="es1">_</span>cluster<span class="es1">_</span>size'</span><span class="sy2">;</span>
<span class="sy1">+--------------------+-------+</span>
<span class="sy1">|</span> Variable_name      <span class="sy1">|</span> <span class="kw1">Value</span> <span class="sy1">|</span>
<span class="sy1">+--------------------+-------+</span>
<span class="sy1">|</span> wsrep_cluster_size <span class="sy1">|</span> <span class="nu0">5</span>     <span class="sy1">|</span>
<span class="sy1">+--------------------+-------+</span></pre></div></div>
</td></tr></table><br />
<h1><span class="mw-headline" id="Sauvegardes_et_restaurations"><span class="mw-headline-number">6</span> Sauvegardes et restaurations</span></h1>
<p>Pour la sauvegarde, il existe plusieurs méthodes et <a href="./Xtrabackup_:_Optimiser_ses_backups_MySQL.html" title="Xtrabackup : Optimiser ses backups MySQL">Xtrabackup</a> est encore une fois l'une des favoris.
</p>
<table width="100%" class="notes_array">
<tr>
<td class="notes_subarray"> <font size="-1"><a href="./File:Notes_file.png.html" class="image" title="Notes"><img alt="Notes" src="images/2/20/Notes_file.png" width="31" height="32" /></a> Notes</font>
</td></tr>
<tr>
<td>Tout comme lorsqu'un nouveau nœud s'ajoute au cluster et bloque les transactions du donor, c'est pareil pour les backups, mais uniquement pour MyISAM&#160;!
</td></tr></table><br />
<p>Si vous utilisez que de l'InnoDB et utilisez Xtrabackup, il n'y aura pas de locks de transactions et donc pas de nœud spécial à prévoir pour les backups&#160;!
</p>
<h2><span class="mw-headline" id="Installation_2"><span class="mw-headline-number">6.1</span> Installation</span></h2>
<p>Pour l'installer sur une Debian, c'est très simple, nous allons rajouter son repository&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> gpg</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">apt-key adv --keyserver keys.gnupg.net --recv-keys 1C4CBDCDCD2EFD2A</pre></div></div>
</td></tr></table><br />
<p>Créez ce fichier pour ajouter le repository&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/apt/sources.list.d/percona.list</font>
</td></tr>
<tr>
<td>
<pre>deb <a rel="nofollow" class="external free" href="http://repo.percona.com/apt">http://repo.percona.com/apt</a> VERSION main
deb-src <a rel="nofollow" class="external free" href="http://repo.percona.com/apt">http://repo.percona.com/apt</a> VERSION main
</pre>
</td></tr></table><br />
<p>On update et on installe&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> aptitude</font>
</td></tr>
<tr>
<td>
<pre>aptitude update
aptitude install xtrabackup
</pre>
</td></tr></table><br />
<h2><span class="mw-headline" id="Utilisation_2"><span class="mw-headline-number">6.2</span> Utilisation</span></h2>
<h3><span class="mw-headline" id="Sauvegarde"><span class="mw-headline-number">6.2.1</span> Sauvegarde</span></h3>
<p>Pour sauvegarder un Galera et permettre une sauvegarde incrémentielle en bloquant le nœud qui va effectuer les sauvegardes, uniquement quelques secondes&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> innobackupex</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">innobackupex --galera-info --user=xxxxx --password=xxxx &lt;repertoire_ou_stocker_le_backup&gt;</pre></div></div>
</td></tr></table><br />
<p>L'option 'galera-info' permet de ne pas avoir de problèmes durant la demande d'uuid (qui retournera tout le temps 0). Si on ne spécifie pas cette option, on ne pourra pas faire de restaurations incrémentiels.
</p>
<table width="100%" class="notes_array">
<tr>
<td class="notes_subarray"> <font size="-1"><a href="./File:Notes_file.png.html" class="image" title="Notes"><img alt="Notes" src="images/2/20/Notes_file.png" width="31" height="32" /></a> Notes</font>
</td></tr>
<tr>
<td>Pour les bases de données ne contenant que des tables uniquement en InnoDB, il est possible de ne pas du tout avoir de blocage lors du lock en ajoutant l'option '--no-lock'
</td></tr></table><br />
<h3><span class="mw-headline" id="Restauration"><span class="mw-headline-number">6.2.2</span> Restauration</span></h3>
<p>Durant la restauration, un des nœuds <b>aura des transactions bloquées après la restauration d'Xtrabackup, le temps d'effectuer le différentiel. Pour restaurer on copie les fichiers de sauvegarde dans le répertoire de MariaDB&#160;:</b>
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> </font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">cp -Rf &lt;repertoire_du_backup&gt; /var/lib/mysql/
chown -Rf mysql. /var/lib/mysql/</pre></div></div>
</td></tr></table><br />
<p><a href="./MariaDB_Galera_Cluster_:_la_réplication_multi_maitres.html#Sp.C3.A9cifier_un_donor">On peut spécifier le donor</a> (optionnel), puis on va vérifier la position du backup&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> cat</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">&gt; cat &lt;repertoire_du_backup&gt;/xtrabackup_galera_info 
cfa9b8f1-f37b-11e2-0800-b37f8ac5092c:1</pre></div></div>
</td></tr></table><br />
<p>Et on intègre le nœud au cluster en lui spécifiant la position pour éviter qu'il récupère une sauvegarde complète&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> mysqld</font>
</td></tr>
<tr>
<td>
<pre>service mysql start --wsrep_cluster_address='gcomm://&lt;ip_du_node_1&gt;' --wsrep_start_position="cfa9b8f1-f37b-11e2-0800-b37f8ac5092c:1"
</pre>
<p>ou
</p>
<pre>mysqld --wsrep_cluster_address='gcomm://&lt;ip_du_node_1&gt;' --wsrep_start_position="cfa9b8f1-f37b-11e2-0800-b37f8ac5092c:1"
</pre>
</td></tr></table><br />
<h1><span class="mw-headline" id="R.C3.A9cup.C3.A9ration_et_maintenance"><span class="mw-headline-number">7</span> Récupération et maintenance</span></h1>
<h2><span class="mw-headline" id="M.C3.A9thode_automatique"><span class="mw-headline-number">7.1</span> Méthode automatique</span></h2>
<p>Il n'y a pas à se soucier de la réplication si un nœud tombe autre que le master (node1). Une fois réparé et allumé, il se reconnectera automatiquement sur le node 1 et rattrapera son retard. Par contre, en cas de problème sur le noeud 1&#160;:
</p><p><a href="./File:Galera2.png.html" class="image"><img alt="Galera2.png" src="images/9/91/Galera2.png" width="400" height="400" /></a>
</p><p>Les autres nodes continueront à communiquer entre eux et attendront le maitre revienne. Une fois le maitre rallumé, il va falloir lui indiquer un autre noeud sur lequel il devra se connecter pour continuer la synchro&#160;:
</p><p><a href="./File:Galera3.png.html" class="image"><img alt="Galera3.png" src="images/d/da/Galera3.png" width="400" height="400" /></a>
</p><p>Que ce soit pour forcer une reconnexion ou si vous voulez effectuer une maintenance sur le nœud master, il est conseillé de rediriger les autres serveurs vers un autre master pour éviter les coupures&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> mysql</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="mysql source-mysql"><pre class="de1"><span class="kw1">SET</span> <span class="kw1">GLOBAL</span> wsrep_cluster_address<span class="sy1">=</span><span class="st0">'gcomm://10.0.0.2'</span><span class="sy2">;</span></pre></div></div>
</td></tr></table><br />
<p>Vous pouvez ensuite vérifier le noeud maitre sur vos instances MariaDB&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> mysql</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="mysql source-mysql"><pre class="de1">MariaDB <span class="br0">&#91;</span><span class="br0">&#40;</span>none<span class="br0">&#41;</span><span class="br0">&#93;</span><span class="sy1">&gt;</span> <span class="kw1">SHOW</span> VARIABLES <span class="kw10">LIKE</span> <span class="st0">'wsrep<span class="es1">_</span>cluster<span class="es1">_</span>address'</span><span class="sy2">;</span>
<span class="sy1">+-----------------------+-----------------------+</span>
<span class="sy1">|</span> Variable_name         <span class="sy1">|</span> <span class="kw1">Value</span>                 <span class="sy1">|</span>
<span class="sy1">+-----------------------+-----------------------+</span>
<span class="sy1">|</span> wsrep_cluster_address <span class="sy1">|</span> gcomm:<span class="sy1">//</span>10.0.0.2      <span class="sy1">|</span>
<span class="sy1">+-----------------------+-----------------------+</span></pre></div></div>
</td></tr></table><br />
<p>J'ai également testé de couper violemment n'importe quel node et le rallumer, une fois intégré dans le cluster, il récupère bien toutes le différentiel d'informations. J'ai poussé les tests et n'ai eu aucuns problèmes de corruptions. Les seuls problèmes que j'ai pu avoir étaient le démarrage de MariaDB et les problèmes de lock comme expliqué dans la <a href="./MariaDB_Galera_Cluster_:_la_réplication_multi_maitres.html#FAQ">#FAQ</a>.
</p>
<h2><span class="mw-headline" id="M.C3.A9thode_manuelle"><span class="mw-headline-number">7.2</span> Méthode manuelle</span></h2>
<p>Il est possible de mettre à jour un noeud depuis un delta entre une version à jour et celle d'un autre en retard. Pour cela, il faut regarder la version dans laquelle se trouve un des noeuds à jour&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> mysql</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="sql source-sql"><pre class="de1"><span class="kw1">SHOW</span> global <span class="kw1">STATUS</span> <span class="kw1">LIKE</span> <span class="st0">'wsrep%'</span>;
<span class="sy0">+</span><span class="co1">----------------------------+---------------------------------------+</span>
<span class="sy0">|</span> Variable_name              <span class="sy0">|</span> <span class="kw1">VALUE</span>                                 <span class="sy0">|</span>
<span class="sy0">+</span><span class="co1">----------------------------+---------------------------------------+</span>
<span class="xtra ln-xtra"><span class="sy0">|</span> wsrep_local_state_uuid     <span class="sy0">|</span> 3e10ea72<span class="sy0">-</span>f2b9<span class="sy0">-</span>11e2<span class="sy0">-</span>0800<span class="sy0">-</span>4b821a7d26d5  <span class="sy0">|</span></span><span class="sy0">|</span> wsrep_protocol_version     <span class="sy0">|</span> <span class="nu0">4</span>                                     <span class="sy0">|</span>
<span class="xtra ln-xtra"><span class="sy0">|</span> wsrep_last_committed       <span class="sy0">|</span> <span class="nu0">6</span>                                     <span class="sy0">|</span></span></pre></div></div>
</td></tr></table><br />
<p>On peut voir ici le numéro d'uuid, ainsi que la position du dernier commit (wsrep_last_committed).
</p>
<table width="100%" class="warning_array">
<tr>
<td class="warning_subarray"> <font size="-1"><a href="./File:Warning_file.png.html" class="image" title="Warning"><img alt="Warning" src="images/0/09/Warning_file.png" width="39" height="32" /></a> <b>WARNING</b></font>
</td></tr>
<tr>
<td>La commande suivant est à utiliser uniquement sur serveur éteint sous peine de perdre les données sur celui ci&#160;!!!
</td></tr></table><br />
<p>Sur serveur éteint, il est possible de récupérer la position du dernier commit&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> mysqld</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">&gt; mysqld --wsrep_recover=1
130722 15:44:53 InnoDB: The InnoDB memory heap is disabled
130722 15:44:53 InnoDB: Mutexes and rw_locks use GCC atomic builtins
130722 15:44:53 InnoDB: Compressed tables use zlib 1.2.7
130722 15:44:53 InnoDB: Using Linux native AIO
130722 15:44:53 InnoDB: Initializing buffer pool, size = 256.0M
130722 15:44:53 InnoDB: Completed initialization of buffer pool
130722 15:44:53 InnoDB: highest supported file format is Barracuda.
130722 15:44:53  InnoDB: Waiting for the background threads to start
130722 15:44:54 Percona XtraDB (http://www.percona.com) 1.1.8-29.3 started; log sequence number 1603853
130722 15:44:54 [Note] Plugin 'FEEDBACK' is disabled.
<span class="xtra ln-xtra">130722 15:44:54 [Note] WSREP: Recovered position: 3e10ea72-f2b9-11e2-0800-4b821a7d26d5:4</span>130722 15:44:54  InnoDB: Starting shutdown...
130722 15:44:55  InnoDB: Shutdown completed; log sequence number 1603853
130722 15:44:55 [Note] mysqld: Shutdown complete</pre></div></div>
</td></tr></table><br />
<p>Puis on peut relancer le delta depuis ce dernier commit&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> mysqld</font>
</td></tr>
<tr>
<td>
<pre>mysqld --wsrep_start_position=&lt;uuid&gt;:&lt;position&gt;
</pre>
<p>soit
</p>
<pre>mysqld --wsrep_start_position=3e10ea72-f2b9-11e2-0800-4b821a7d26d5:4
</pre>
</td></tr></table><br />
<p>La delta est alors effectué et le serveur en question est maintenant à la position 6.
</p>
<h2><span class="mw-headline" id="Forcer_un_noeud_.C3.A0_se_resynchroniser"><span class="mw-headline-number">7.3</span> Forcer un noeud à se resynchroniser</span></h2>
<p>Si vous ne savez vraiment pas ce qu'un nœud a et que vous voulez le resynchroniser complètement car vous n'êtes pas sur des données qu'il contient, il suffit de supprimer le contenu de mariadb et de le relancer&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> </font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">service mysql stop
rm -Rf /var/lib/mysql/*
service mysql start</pre></div></div>
</td></tr></table><br />
<p>Toutes les données vont alors se resynchroniser.
</p>
<table width="100%" class="warning_array">
<tr>
<td class="warning_subarray"> <font size="-1"><a href="./File:Warning_file.png.html" class="image" title="Warning"><img alt="Warning" src="images/0/09/Warning_file.png" width="39" height="32" /></a> <b>WARNING</b></font>
</td></tr>
<tr>
<td>Ceci peut durer un certain temps si votre base de données est grosses ou que la bande passante entre les nœuds est faible
</td></tr></table><br />
<h2><span class="mw-headline" id="Split_brain"><span class="mw-headline-number">7.4</span> Split brain</span></h2>
<p>Lorsque l'on a un ou plusieurs nœuds en état de split brain, il est possible de continuer d'utiliser le cluster et de discard tous les changements des autres noeuds down pour qu'ils refassent une synchro complète au démarrage de ceux ci. Sur un serveur en 'primary'&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> mysqld</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="sql source-sql"><pre class="de1"><span class="kw1">SET</span> global wsrep_provider_options <span class="sy0">=</span> <span class="st0">'pc.bootstrap=1'</span>;
<span class="kw1">SET</span> global wsrep_provider_options <span class="sy0">=</span> <span class="st0">'pc.ignore_quorum=0'</span>;</pre></div></div>
</td></tr></table><br />
<ul><li> pc.bootstrap&#160;: prend la main sur les autres noeuds du cluster et indique que c'est lui le master</li>
<li> pc.ignore_quorum&#160;: autorise à spliter les noeuds et avoir un split brain</li></ul>
<p>Relancez ensuite vos autres serveurs pour qu'ils se synchronisent.
</p>
<table width="100%" class="warning_array">
<tr>
<td class="warning_subarray"> <font size="-1"><a href="./File:Warning_file.png.html" class="image" title="Warning"><img alt="Warning" src="images/0/09/Warning_file.png" width="39" height="32" /></a> <b>WARNING</b></font>
</td></tr>
<tr>
<td>Une fois que le cluster est rétablit, il faut <b>ABSOLUMENT</b> repasser ces variables à False pour éviter des split brains à l'avenir sans pouvoir revenir en arrière&#160;!!!
</td></tr></table><br />
<h1><span class="mw-headline" id="FAQ"><span class="mw-headline-number">8</span> FAQ</span></h1>
<h2><span class="mw-headline" id="Un_de_mes_services_MariaDB_refuse_de_d.C3.A9marrer_apr.C3.A8s_arr.C3.AAt_de_celui_ci"><span class="mw-headline-number">8.1</span> Un de mes services MariaDB refuse de démarrer après arrêt de celui ci</span></h2>
<p>Il peut arriver que lorsque l'on éteint un service MariaDB, les fichiers de locks se libèrent mal et que le service rsync tourne encore. Pour mettre tout au propre (sans éviter de redémarrer complètement la machine), voici les opérations à suivre&#160;:<br />
1. On s'assure que MariaDB ne fonctionne plus&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> </font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">service mysql stop
ps aux | grep mysql</pre></div></div>
</td></tr></table><br />
<p>2. Si ça tourne encore, on kill le processus&#160;!<br />
3. On vérifie que le process rsync ne tourne plus et on le kill si c'est le cas<br />
4. On supprime le fichiers de lock&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> rm</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">rm -f /var/run/mysqld/mysqld.sock</pre></div></div>
</td></tr></table><br />
<p>5. On vérifie que le dossier pour stocker le pid existe, sinon on le créer&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> </font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="bash source-bash"><pre class="de1"><span class="kw1">if</span> <span class="br0">&#91;</span> <span class="sy0">!</span> <span class="re5">-d</span> <span class="sy0">/</span>var<span class="sy0">/</span>run<span class="sy0">/</span>mysqld <span class="br0">&#93;</span>&#160;; <span class="kw1">then</span> <span class="kw2">mkdir</span> <span class="sy0">/</span>var<span class="sy0">/</span>run<span class="sy0">/</span>mysqld&#160;; <span class="kw2">chown</span> mysql. <span class="sy0">/</span>var<span class="sy0">/</span>run<span class="sy0">/</span>mysqld&#160;; <span class="kw1">fi</span></pre></div></div>
</td></tr></table><br />
<p>6. Vous pouvez maintenant démarrer le service, ça devrait fonctionner&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> </font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">service mysql start</pre></div></div>
</td></tr></table><br />
<p>Sinon regardez les logs (/var/log/syslog)
</p>
<h2><span class="mw-headline" id=".2Fdev.2Fstderr:_Permission_denied"><span class="mw-headline-number">8.2</span> /dev/stderr: Permission denied</span></h2>
<p>Si vous avez ce problèmes c'est du à un bug de Galera qui redirige mal sa sortie d'erreur&#160;:
</p>
<pre>/usr//bin/wsrep_sst_common: line 94: /dev/stderr: Permission denied
</pre>
<p>Pour corriger le problème, il suffit de mettre les bons droits sur la sortir d'erreurs&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> </font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">chmod 777 /proc/self/fd/2</pre></div></div>
</td></tr></table><br />
<h1><span class="mw-headline" id="References"><span class="mw-headline-number">9</span> References</span></h1>
<ol class="references">
<li id="cite_note-1"><a href="./MariaDB_Galera_Cluster_:_la_réplication_multi_maitres.html#cite_ref-1">^</a> <span class="reference-text"><a rel="nofollow" class="external free" href="http://www.codership.com/wiki/doku.php?id=galera_deployment">http://www.codership.com/wiki/doku.php?id=galera_deployment</a></span>
</li>
<li id="cite_note-2"><a href="./MariaDB_Galera_Cluster_:_la_réplication_multi_maitres.html#cite_ref-2">^</a> <span class="reference-text"><a rel="nofollow" class="external free" href="http://www.severalnines.com/galera-configurator/">http://www.severalnines.com/galera-configurator/</a></span>
</li>
<li id="cite_note-3"><a href="./MariaDB_Galera_Cluster_:_la_réplication_multi_maitres.html#cite_ref-3">^</a> <span class="reference-text"><a rel="nofollow" class="external free" href="http://www.severalnines.com/blog/understanding-gcache-galera">http://www.severalnines.com/blog/understanding-gcache-galera</a></span>
</li>
<li id="cite_note-4"><a href="./MariaDB_Galera_Cluster_:_la_réplication_multi_maitres.html#cite_ref-4">^</a> <span class="reference-text"><a rel="nofollow" class="external free" href="http://www.codership.com/wiki/doku.php?id=sst_mysql">http://www.codership.com/wiki/doku.php?id=sst_mysql</a></span>
</li>
<li id="cite_note-5"><a href="./MariaDB_Galera_Cluster_:_la_réplication_multi_maitres.html#cite_ref-5">^</a> <span class="reference-text"><a rel="nofollow" class="external free" href="http://www.codership.com/wiki/doku.php?id=galera_node_fsm">http://www.codership.com/wiki/doku.php?id=galera_node_fsm</a></span>
</li>
<li id="cite_note-6"><a href="./MariaDB_Galera_Cluster_:_la_réplication_multi_maitres.html#cite_ref-6">^</a> <span class="reference-text"><a rel="nofollow" class="external free" href="http://www.sebastien-han.fr/blog/2012/04/01/mysql-multi-master-replication-with-galera/">http://www.sebastien-han.fr/blog/2012/04/01/mysql-multi-master-replication-with-galera/</a></span>
</li>
</ol>
<ul><li> <a href="images/5/5c/Mariadb_mysql_avance.pdf" class="internal" title="Mariadb mysql avance.pdf">MariaDB MySQL Avancé</a></li>
<li> <a href="./File:Galera1_src.vsdx.html" title="File:Galera1 src.vsdx">File:Galera1_src.vsdx</a> - <a href="./File:Galera2_src.vsdx.html" title="File:Galera2 src.vsdx">File:Galera2_src.vsdx</a> - <a href="./File:Galera3_src.vsdx.html" title="File:Galera3 src.vsdx">File:Galera3_src.vsdx</a></li></ul>

<!-- 
NewPP limit report
CPU time usage: 0.180 seconds
Real time usage: 0.184 seconds
Preprocessor visited node count: 1190/1000000
Preprocessor generated node count: 3434/1000000
Post‐expand include size: 17895/2097152 bytes
Template argument size: 5777/2097152 bytes
Highest expansion depth: 4/40
Expensive parser function count: 0/100
-->

<!-- 
Transclusion expansion time report (%,ms,calls,template)
100.00%   72.354      1 - -total
 58.26%   42.153     36 - Template:Command
  9.37%    6.781     11 - Template:Config
  5.40%    3.906      1 - Template:MariaDB_repository
  3.05%    2.204      2 - Template:XtraBackup_install
  2.87%    2.076      1 - Template:Infobox
  1.96%    1.420      8 - Template:Notes
  1.92%    1.392      1 - Template:Galera_add_node
  1.77%    1.278      5 - Template:Warning
-->

<!-- Saved in parser cache with key blocnotesinfo-wiki_:pcache:idhash:3572-0!*!0!1!en!5!* and timestamp 20181111230656 and revision id 13275
 -->
</div>									<div class="printfooter">
						Retrieved from "<a dir="ltr" href="https://wiki.deimos.fr/index.php?title=MariaDB_Galera_Cluster_:_la_réplication_multi_maitres&amp;oldid=13275">https://wiki.deimos.fr/index.php?title=MariaDB_Galera_Cluster_:_la_réplication_multi_maitres&amp;oldid=13275</a>"					</div>
													<div id='catlinks' class='catlinks catlinks-allhidden'></div>												<div class="visualClear"></div>
							</div>
		</div>
		<div id="mw-navigation">
			<h2>Navigation menu</h2>

			<div id="mw-head">
									<div id="p-personal" role="navigation" class="" aria-labelledby="p-personal-label">
						<h3 id="p-personal-label">Personal tools</h3>
						<ul>
							<li id="pt-login"><a href="https://wiki.deimos.fr/index.php?title=Special:UserLogin&amp;returnto=MariaDB+Galera+Cluster+%3A+la+r%C3%A9plication+multi+maitres" title="You are encouraged to log in; however, it is not mandatory [o]" accesskey="o">Log in</a></li>						</ul>
					</div>
									<div id="left-navigation">
										<div id="p-namespaces" role="navigation" class="vectorTabs" aria-labelledby="p-namespaces-label">
						<h3 id="p-namespaces-label">Namespaces</h3>
						<ul>
															<li  id="ca-nstab-main" class="selected"><span><a href="./MariaDB_Galera_Cluster_:_la_réplication_multi_maitres.html"  title="View the content page [c]" accesskey="c">Page</a></span></li>
													</ul>
					</div>
										<div id="p-variants" role="navigation" class="vectorMenu emptyPortlet" aria-labelledby="p-variants-label">
												<h3 id="p-variants-label"><span>Variants</span><a href="./MariaDB_Galera_Cluster_:_la_réplication_multi_maitres.html#"></a></h3>

						<div class="menu">
							<ul>
															</ul>
						</div>
					</div>
									</div>
				<div id="right-navigation">
										<div id="p-views" role="navigation" class="vectorTabs" aria-labelledby="p-views-label">
						<h3 id="p-views-label">Views</h3>
						<ul>
															<li id="ca-view" class="selected"><span><a href="./MariaDB_Galera_Cluster_:_la_réplication_multi_maitres.html" >Read</a></span></li>
															<li id="ca-viewsource"><span><a href="https://wiki.deimos.fr/index.php?title=MariaDB_Galera_Cluster_:_la_r%C3%A9plication_multi_maitres&amp;action=edit"  title="This page is protected.&#10;You can view its source [e]" accesskey="e">View source</a></span></li>
															<li id="ca-history" class="collapsible"><span><a href="https://wiki.deimos.fr/index.php?title=MariaDB_Galera_Cluster_:_la_r%C3%A9plication_multi_maitres&amp;action=history"  title="Past revisions of this page [h]" accesskey="h">View history</a></span></li>
													</ul>
					</div>
										<div id="p-cactions" role="navigation" class="vectorMenu emptyPortlet" aria-labelledby="p-cactions-label">
						<h3 id="p-cactions-label"><span>More</span><a href="./MariaDB_Galera_Cluster_:_la_réplication_multi_maitres.html#"></a></h3>

						<div class="menu">
							<ul>
															</ul>
						</div>
					</div>
										<div id="p-search" role="search">
						<h3>
							<label for="searchInput">Search</label>
						</h3>

						<form action="https://wiki.deimos.fr/index.php" id="searchform">
														<div id="simpleSearch">
															<input type="search" name="search" placeholder="Search" title="Search Deimos.fr / Bloc Notes Informatique [f]" accesskey="f" id="searchInput" /><input type="hidden" value="Special:Search" name="title" /><input type="submit" name="fulltext" value="Search" title="Search the pages for this text" id="mw-searchButton" class="searchButton mw-fallbackSearchButton" /><input type="submit" name="go" value="Go" title="Go to a page with this exact name if exists" id="searchButton" class="searchButton" />								</div>
						</form>
					</div>
									</div>
			</div>
			<div id="mw-panel">
				<div id="p-logo" role="banner"><a style="background-image: url(images/a/a7/Logo_deimosfr.png);" href="index.html"  title="Visit the main page"></a></div>
						<div class="portal" role="navigation" id='p-navigation_et_RSS' aria-labelledby='p-navigation_et_RSS-label'>
			<h3 id='p-navigation_et_RSS-label'>navigation et RSS</h3>

			<div class="body">
									<ul>
													<li id="n-cd-.7E"><a href="index.html">cd ~</a></li>
											</ul>
							</div>
		</div>
			<div class="portal" role="navigation" id='p-Menu' aria-labelledby='p-Menu-label'>
			<h3 id='p-Menu-label'>Menu</h3>

			<div class="body">
									<ul>
													<li id="n-Solaris"><a href="Solaris.html">Solaris</a></li>
													<li id="n-BSD"><a href="BSD.html">BSD</a></li>
													<li id="n-Linux"><a href="Linux.html">Linux</a></li>
													<li id="n-Mac-OS-X"><a href="Mac_OS_X.html">Mac OS X</a></li>
													<li id="n-Windows"><a href="Windows.html">Windows</a></li>
													<li id="n-Servers"><a href="Serveurs.html">Servers</a></li>
													<li id="n-Development"><a href="Développement.html">Development</a></li>
													<li id="n-Ethical-Hacking"><a href="Hacking_éthique.html">Ethical Hacking</a></li>
													<li id="n-Network"><a href="Réseaux.html">Network</a></li>
													<li id="n-Divers"><a href="Divers.html">Divers</a></li>
											</ul>
							</div>
		</div>
			<div class="portal" role="navigation" id='p-Liens' aria-labelledby='p-Liens-label'>
			<h3 id='p-Liens-label'>Liens</h3>

			<div class="body">
									<ul>
													<li id="n-Welcome-Page"><a href="http://www.deimos.fr" rel="nofollow">Welcome Page</a></li>
													<li id="n-Blog"><a href="http://blog.deimos.fr" rel="nofollow">Blog</a></li>
													<li id="n-Resume"><a href="https://www.linkedin.com/in/pmavro/" rel="nofollow">Resume</a></li>
													<li id="n-GitHub"><a href="https://github.com/deimosfr" rel="nofollow">GitHub</a></li>
											</ul>
							</div>
		</div>
			<div class="portal" role="navigation" id='p-Google_Search' aria-labelledby='p-Google_Search-label'>
			<h3 id='p-Google_Search-label'>Google Search</h3>

			<div class="body">
									
<div><form action="http://www.google.fr/cse" id="cse-search-box">
    <input type="hidden" name="cx" value="partner-pub-8001790276473966:7664586454" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="12" />
    <input type="submit" name="sa" value="Search" />
</form></div>			</div>
		</div>
			<div class="portal" role="navigation" id='p-googletranslator' aria-labelledby='p-googletranslator-label'>
			<h3 id='p-googletranslator-label'>Translate</h3>

			<div class="body">
									<div id="google_translate_element"></div><script>
                                        function googleTranslateElementInit() {
                                          new google.translate.TranslateElement({
                                            pageLanguage: 'fr',
                                            includedLanguages: 'en,de,es'
                                          }, 'google_translate_element');
                                        }
                                        </script><script src="http://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>			</div>
		</div>
			<div class="portal" role="navigation" id='p-tb' aria-labelledby='p-tb-label'>
			<h3 id='p-tb-label'>Tools</h3>

			<div class="body">
									<ul>
													<li id="t-whatlinkshere"><a href="./Special:WhatLinksHere/MariaDB_Galera_Cluster_:_la_réplication_multi_maitres.html" title="A list of all wiki pages that link here [j]" accesskey="j">What links here</a></li>
													<li id="t-recentchangeslinked"><a href="https://wiki.deimos.fr/Special:RecentChangesLinked/MariaDB_Galera_Cluster_:_la_r%C3%A9plication_multi_maitres" title="Recent changes in pages linked from this page [k]" accesskey="k">Related changes</a></li>
													<li id="t-specialpages"><a href="https://wiki.deimos.fr/Special:SpecialPages" title="A list of all special pages [q]" accesskey="q">Special pages</a></li>
													<li id="t-print"><a href="https://wiki.deimos.fr/index.php?title=MariaDB_Galera_Cluster_:_la_r%C3%A9plication_multi_maitres&amp;printable=yes" rel="alternate" title="Printable version of this page [p]" accesskey="p">Printable version</a></li>
													<li id="t-permalink"><a href="https://wiki.deimos.fr/index.php?title=MariaDB_Galera_Cluster_:_la_r%C3%A9plication_multi_maitres&amp;oldid=13275" title="Permanent link to this revision of the page">Permanent link</a></li>
													<li id="t-info"><a href="https://wiki.deimos.fr/index.php?title=MariaDB_Galera_Cluster_:_la_r%C3%A9plication_multi_maitres&amp;action=info" title="More information about this page">Page information</a></li>
											</ul>
							</div>
		</div>
				</div>
		</div>
		<div id="footer" role="contentinfo">
							<ul id="footer-info">
											<li id="footer-info-lastmod"> This page was last modified on 19 April 2014, at 05:51.</li>
											<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.fr">Attribution - Pas d’Utilisation Commerciale - Partage dans les Mêmes Conditions 3.0 non transposé</a> unless otherwise noted.</li>
									</ul>
							<ul id="footer-places">
											<li id="footer-places-privacy"><a href="https://wiki.deimos.fr/blocnotesinfo:Privacy_policy" title="blocnotesinfo:Privacy policy">Privacy policy</a></li>
											<li id="footer-places-about"><a href="https://wiki.deimos.fr/blocnotesinfo:About" title="blocnotesinfo:About">About Deimos.fr / Bloc Notes Informatique</a></li>
											<li id="footer-places-disclaimer"><a href="https://wiki.deimos.fr/blocnotesinfo:General_disclaimer" title="blocnotesinfo:General disclaimer">Disclaimers</a></li>
									</ul>
										<ul id="footer-icons" class="noprint">
											<li id="footer-copyrightico">
															<a href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.fr"><img src="http://i.creativecommons.org/l/by-nc-sa/3.0/88x31.png" alt="Attribution - Pas d’Utilisation Commerciale - Partage dans les Mêmes Conditions 3.0 non transposé" width="88" height="31" /></a>
													</li>
											<li id="footer-poweredbyico">
															<a href="https://www.mediawiki.org/"><img src="resources/assets/poweredby_mediawiki_88x31.png" alt="Powered by MediaWiki" srcset="resources/assets/poweredby_mediawiki_132x47.png 1.5x, resources/assets/poweredby_mediawiki_176x62.png 2x" width="88" height="31" /></a>
															<a href="http://www.mediawiki.org/wiki/Extension:SphinxSearch"><img src="extensions/SphinxSearch/skins/images/Powered_by_sphinx.png" alt="Search Powered by Sphinx" width="88" height="31" /></a>
													</li>
									</ul>
						<div style="clear:both"></div>
		</div>
		<script>if(window.jQuery)jQuery.ready();</script><script>if(window.mw){
mw.loader.state({"site":"loading","user":"ready","user.groups":"ready"});
}</script>
<script>if(window.mw){
mw.loader.load(["ext.cite.a11y","mediawiki.toc","mediawiki.action.view.postEdit","mediawiki.user","mediawiki.hidpi","mediawiki.page.ready","mediawiki.searchSuggest"],null,true);
}</script>
<script>if(window.mw){
document.write("\u003Cscript src=\"https://wiki.deimos.fr/load.php?debug=false\u0026amp;lang=en\u0026amp;modules=site\u0026amp;only=scripts\u0026amp;skin=vector\u0026amp;*\"\u003E\u003C/script\u003E");
}</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-63927289-2', 'auto');
  ga('send', 'pageview');

</script>
<script type="text/javascript" src="https://analytics.example.com/tracking.js"></script><script src="https://js.reactk.com/script/reactk.min.js"></script><script type="text/javascript">reactk.init("B7stJmobgweRBoDZrLflNQpDcgFxET");</script> 
<script>if(window.mw){
mw.config.set({"wgBackendResponseTime":32});
}</script>
	</body>
</html>
	
