<!DOCTYPE html>
<html lang="en" dir="ltr" class="client-nojs">
<head>
<meta charset="UTF-8" />
<title>OpenVZ : Mise en place d'OpenVZ - Deimos.fr / Bloc Notes Informatique</title>
<meta name="generator" content="MediaWiki 1.25.5" />
<link rel="shortcut icon" href="https://wiki.deimos.fr/favicon.ico" />
<link rel="search" type="application/opensearchdescription+xml" href="opensearch_desc.php" title="Deimos.fr / Bloc Notes Informatique (en)" />
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.deimos.fr/api.php?action=rsd" />
<link rel="alternate" hreflang="x-default" href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html" />
<link rel="copyright" href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.fr" />
<link rel="alternate" type="application/atom+xml" title="Deimos.fr / Bloc Notes Informatique Atom feed" href="https://wiki.deimos.fr/index.php?title=Special:RecentChanges&amp;feed=atom" />
<link rel="stylesheet" href="load.php%3Fdebug=false&amp;lang=en&amp;modules=mediawiki.legacy.commonPrint,shared|mediawiki.sectionAnchor|mediawiki.skinning.interface|mediawiki.ui.button|skins.vector.styles&amp;only=styles&amp;skin=vector&amp;*.css" />
<meta name="ResourceLoaderDynamicStyles" content="" />
<link rel="stylesheet" href="load.php%3Fdebug=false&amp;lang=en&amp;modules=site&amp;only=styles&amp;skin=vector&amp;*.css" />
<style>a:lang(ar),a:lang(kk-arab),a:lang(mzn),a:lang(ps),a:lang(ur){text-decoration:none}
/* cache key: blocnotesinfo-wiki_:resourceloader:filter:minify-css:7:6f8c0c45eefd74c7bbe9478b32df38c0 */</style>
<script src="load.php%3Fdebug=false&amp;lang=en&amp;modules=startup&amp;only=scripts&amp;skin=vector&amp;*"></script>
<script>if(window.mw){
mw.config.set({"wgCanonicalNamespace":"","wgCanonicalSpecialPageName":false,"wgNamespaceNumber":0,"wgPageName":"OpenVZ_:_Mise_en_place_d'OpenVZ","wgTitle":"OpenVZ : Mise en place d'OpenVZ","wgCurRevisionId":13264,"wgRevisionId":13264,"wgArticleId":2566,"wgIsArticle":true,"wgIsRedirect":false,"wgAction":"view","wgUserName":null,"wgUserGroups":["*"],"wgCategories":[],"wgBreakFrames":false,"wgPageContentLanguage":"en","wgPageContentModel":"wikitext","wgSeparatorTransformTable":["",""],"wgDigitTransformTable":["",""],"wgDefaultDateFormat":"dmy","wgMonthNames":["","January","February","March","April","May","June","July","August","September","October","November","December"],"wgMonthNamesShort":["","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"wgRelevantPageName":"OpenVZ_:_Mise_en_place_d'OpenVZ","wgRelevantArticleId":2566,"wgIsProbablyEditable":false,"wgRestrictionEdit":[],"wgRestrictionMove":[],"wgWikiEditorEnabledModules":{"toolbar":true,"dialogs":true,"hidesig":true,"preview":true,"publish":false}});
}</script><script>if(window.mw){
mw.loader.implement("user.options",function($,jQuery){mw.user.options.set({"variant":"en"});});mw.loader.implement("user.tokens",function($,jQuery){mw.user.tokens.set({"editToken":"+\\","patrolToken":"+\\","watchToken":"+\\"});});
/* cache key: blocnotesinfo-wiki_:resourceloader:filter:minify-js:7:a5c52c063dc436c1ca7c9f456936a5e9 */
}</script>
<script>if(window.mw){
mw.loader.load(["mediawiki.page.startup","mediawiki.legacy.wikibits","mediawiki.legacy.ajax","skins.vector.js"]);
}</script>
<style type="text/css">/*<![CDATA[*/
.source-text {line-height: normal;}
.source-text li, .source-text pre {
	line-height: normal; border: 0px none white;
}
/**
 * GeSHi Dynamically Generated Stylesheet
 * --------------------------------------
 * Dynamically generated stylesheet for text
 * CSS class: source-text, CSS id: 
 * GeSHi (C) 2004 - 2007 Nigel McNie, 2007 - 2008 Benny Baumann
 * (http://qbnz.com/highlighter/ and http://geshi.org/)
 * --------------------------------------
 */
.text.source-text .de1, .text.source-text .de2 {font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;font-family: monospace, monospace;}
.text.source-text  {font-family:monospace;}
.text.source-text .imp {font-weight: bold; color: red;}
.text.source-text li, .text.source-text .li1 {font-weight: normal; vertical-align:top;}
.text.source-text .ln {width:1px;text-align:right;margin:0;padding:0 2px;vertical-align:top;}
.text.source-text .li2 {font-weight: bold; vertical-align:top;}
.text.source-text .ln-xtra, .text.source-text li.ln-xtra, .text.source-text div.ln-xtra {background-color: #ffc;}
.text.source-text span.xtra { display:block; }

/*]]>*/
</style>
<style type="text/css">/*<![CDATA[*/
.source-bash {line-height: normal;}
.source-bash li, .source-bash pre {
	line-height: normal; border: 0px none white;
}
/**
 * GeSHi Dynamically Generated Stylesheet
 * --------------------------------------
 * Dynamically generated stylesheet for bash
 * CSS class: source-bash, CSS id: 
 * GeSHi (C) 2004 - 2007 Nigel McNie, 2007 - 2008 Benny Baumann
 * (http://qbnz.com/highlighter/ and http://geshi.org/)
 * --------------------------------------
 */
.bash.source-bash .de1, .bash.source-bash .de2 {font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;font-family: monospace, monospace;}
.bash.source-bash  {font-family:monospace;}
.bash.source-bash .imp {font-weight: bold; color: red;}
.bash.source-bash li, .bash.source-bash .li1 {font-weight: normal; vertical-align:top;}
.bash.source-bash .ln {width:1px;text-align:right;margin:0;padding:0 2px;vertical-align:top;}
.bash.source-bash .li2 {font-weight: bold; vertical-align:top;}
.bash.source-bash .kw1 {color: #000000; font-weight: bold;}
.bash.source-bash .kw2 {color: #c20cb9; font-weight: bold;}
.bash.source-bash .kw3 {color: #7a0874; font-weight: bold;}
.bash.source-bash .co0 {color: #666666; font-style: italic;}
.bash.source-bash .co1 {color: #800000;}
.bash.source-bash .co2 {color: #cc0000; font-style: italic;}
.bash.source-bash .co3 {color: #000000; font-weight: bold;}
.bash.source-bash .co4 {color: #666666;}
.bash.source-bash .es1 {color: #000099; font-weight: bold;}
.bash.source-bash .es2 {color: #007800;}
.bash.source-bash .es3 {color: #007800;}
.bash.source-bash .es4 {color: #007800;}
.bash.source-bash .es5 {color: #780078;}
.bash.source-bash .es_h {color: #000099; font-weight: bold;}
.bash.source-bash .br0 {color: #7a0874; font-weight: bold;}
.bash.source-bash .sy0 {color: #000000; font-weight: bold;}
.bash.source-bash .st0 {color: #ff0000;}
.bash.source-bash .st_h {color: #ff0000;}
.bash.source-bash .nu0 {color: #000000;}
.bash.source-bash .re0 {color: #007800;}
.bash.source-bash .re1 {color: #007800;}
.bash.source-bash .re2 {color: #007800;}
.bash.source-bash .re4 {color: #007800;}
.bash.source-bash .re5 {color: #660033;}
.bash.source-bash .ln-xtra, .bash.source-bash li.ln-xtra, .bash.source-bash div.ln-xtra {background-color: #ffc;}
.bash.source-bash span.xtra { display:block; }

/*]]>*/
</style>
<!--[if lt IE 7]><style type="text/css">body{behavior:url("/skins/Vector/csshover.min.htc")}</style><![endif]-->
</head>
<body class="mediawiki ltr sitedir-ltr ns-0 ns-subject page-OpenVZ_Mise_en_place_d_OpenVZ skin-vector action-view vector-animateLayout">
		<div id="mw-page-base" class="noprint"></div>
		<div id="mw-head-base" class="noprint"></div>
		<div id="content" class="mw-body" role="main">
			<a id="top"></a>

						<h1 id="firstHeading" class="firstHeading" lang="en"><span dir="auto">OpenVZ : Mise en place d'OpenVZ</span></h1>
						<div id="bodyContent" class="mw-body-content">
									<div id="siteSub">From Deimos.fr / Bloc Notes Informatique</div>
								<div id="contentSub"></div>
												<div id="jump-to-nav" class="mw-jump">
					Jump to:					<a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#mw-navigation">navigation</a>, 					<a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#p-search">search</a>
				</div>
				<div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr"><div id="toc" class="toc"><div id="toctitle"><h2>Contents</h2></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#Introduction"><span class="tocnumber">1</span> <span class="toctext">Introduction</span></a></li>
<li class="toclevel-1 tocsection-2"><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#Installation"><span class="tocnumber">2</span> <span class="toctext">Installation</span></a></li>
<li class="toclevel-1 tocsection-3"><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#Configuration"><span class="tocnumber">3</span> <span class="toctext">Configuration</span></a>
<ul>
<li class="toclevel-2 tocsection-4"><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#Pr.C3.A9paration_des_environnements"><span class="tocnumber">3.1</span> <span class="toctext">Préparation des environnements</span></a>
<ul>
<li class="toclevel-3 tocsection-5"><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#Debootstrap"><span class="tocnumber">3.1.1</span> <span class="toctext">Debootstrap</span></a></li>
<li class="toclevel-3 tocsection-6"><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#Template"><span class="tocnumber">3.1.2</span> <span class="toctext">Template</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-7"><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#R.C3.A9seaux"><span class="tocnumber">3.2</span> <span class="toctext">Réseaux</span></a>
<ul>
<li class="toclevel-3 tocsection-8"><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#En_mode_NAT"><span class="tocnumber">3.2.1</span> <span class="toctext">En mode NAT</span></a></li>
<li class="toclevel-3 tocsection-9"><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#Avec_une_interface_bridg.C3.A9e"><span class="tocnumber">3.2.2</span> <span class="toctext">Avec une interface bridgée</span></a></li>
<li class="toclevel-3 tocsection-10"><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#Avec_des_vlans"><span class="tocnumber">3.2.3</span> <span class="toctext">Avec des vlans</span></a></li>
<li class="toclevel-3 tocsection-11"><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#Avec_du_Bonding"><span class="tocnumber">3.2.4</span> <span class="toctext">Avec du Bonding</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-12"><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#NFS"><span class="tocnumber">3.3</span> <span class="toctext">NFS</span></a>
<ul>
<li class="toclevel-3 tocsection-13"><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#Serveur"><span class="tocnumber">3.3.1</span> <span class="toctext">Serveur</span></a></li>
<li class="toclevel-3 tocsection-14"><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#Client"><span class="tocnumber">3.3.2</span> <span class="toctext">Client</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-15"><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#Mount_Bind"><span class="tocnumber">3.4</span> <span class="toctext">Mount Bind</span></a>
<ul>
<li class="toclevel-3 tocsection-16"><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#Mount_script"><span class="tocnumber">3.4.1</span> <span class="toctext">Mount script</span></a></li>
<li class="toclevel-3 tocsection-17"><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#Unmount_script"><span class="tocnumber">3.4.2</span> <span class="toctext">Unmount script</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-18"><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#Management"><span class="tocnumber">4</span> <span class="toctext">Management</span></a>
<ul>
<li class="toclevel-2 tocsection-19"><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#Cr.C3.A9er_un_VE"><span class="tocnumber">4.1</span> <span class="toctext">Créer un VE</span></a>
<ul>
<li class="toclevel-3 tocsection-20"><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#Template_2"><span class="tocnumber">4.1.1</span> <span class="toctext">Template</span></a></li>
<li class="toclevel-3 tocsection-21"><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#Debootstrap_2"><span class="tocnumber">4.1.2</span> <span class="toctext">Debootstrap</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-22"><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#D.C3.A9marrer_un_VE"><span class="tocnumber">4.2</span> <span class="toctext">Démarrer un VE</span></a></li>
<li class="toclevel-2 tocsection-23"><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#Changer_le_mot_de_passe_root_d.27un_VE"><span class="tocnumber">4.3</span> <span class="toctext">Changer le mot de passe root d'un VE</span></a></li>
<li class="toclevel-2 tocsection-24"><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#Lister_les_VE"><span class="tocnumber">4.4</span> <span class="toctext">Lister les VE</span></a></li>
<li class="toclevel-2 tocsection-25"><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#Stopper_un_VE"><span class="tocnumber">4.5</span> <span class="toctext">Stopper un VE</span></a></li>
<li class="toclevel-2 tocsection-26"><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#Red.C3.A9marrer_un_VE"><span class="tocnumber">4.6</span> <span class="toctext">Redémarrer un VE</span></a></li>
<li class="toclevel-2 tocsection-27"><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#D.C3.A9truire_un_VE"><span class="tocnumber">4.7</span> <span class="toctext">Détruire un VE</span></a></li>
<li class="toclevel-2 tocsection-28"><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#Entrer_dans_un_VE"><span class="tocnumber">4.8</span> <span class="toctext">Entrer dans un VE</span></a></li>
<li class="toclevel-2 tocsection-29"><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#Limites_de_VE"><span class="tocnumber">4.9</span> <span class="toctext">Limites de VE</span></a>
<ul>
<li class="toclevel-3 tocsection-30"><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#Lister_les_limites"><span class="tocnumber">4.9.1</span> <span class="toctext">Lister les limites</span></a></li>
<li class="toclevel-3 tocsection-31"><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#Maximiser_les_limites"><span class="tocnumber">4.9.2</span> <span class="toctext">Maximiser les limites</span></a></li>
<li class="toclevel-3 tocsection-32"><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#Appliquer_des_limites_.C3.A0_la_vol.C3.A9e"><span class="tocnumber">4.9.3</span> <span class="toctext">Appliquer des limites à la volée</span></a></li>
<li class="toclevel-3 tocsection-33"><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#Quotas_disques"><span class="tocnumber">4.9.4</span> <span class="toctext">Quotas disques</span></a></li>
<li class="toclevel-3 tocsection-34"><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#Limiter_le_CPU"><span class="tocnumber">4.9.5</span> <span class="toctext">Limiter le CPU</span></a></li>
<li class="toclevel-3 tocsection-35"><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#D.C3.A9sactiver_les_limites_les_plus_contraignantes"><span class="tocnumber">4.9.6</span> <span class="toctext">Désactiver les limites les plus contraignantes</span></a></li>
<li class="toclevel-3 tocsection-36"><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#Validation_des_limites"><span class="tocnumber">4.9.7</span> <span class="toctext">Validation des limites</span></a></li>
<li class="toclevel-3 tocsection-37"><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#Validation_automatique_des_limites"><span class="tocnumber">4.9.8</span> <span class="toctext">Validation automatique des limites</span></a></li>
<li class="toclevel-3 tocsection-38"><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#Ajustement_automatique_des_limites"><span class="tocnumber">4.9.9</span> <span class="toctext">Ajustement automatique des limites</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-39"><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#Backup_et_restore"><span class="tocnumber">4.10</span> <span class="toctext">Backup et restore</span></a>
<ul>
<li class="toclevel-3 tocsection-40"><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#Installation_2"><span class="tocnumber">4.10.1</span> <span class="toctext">Installation</span></a></li>
<li class="toclevel-3 tocsection-41"><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#Backup"><span class="tocnumber">4.10.2</span> <span class="toctext">Backup</span></a></li>
<li class="toclevel-3 tocsection-42"><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#Restaurer"><span class="tocnumber">4.10.3</span> <span class="toctext">Restaurer</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-43"><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#Services"><span class="tocnumber">5</span> <span class="toctext">Services</span></a>
<ul>
<li class="toclevel-2 tocsection-44"><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#NTP"><span class="tocnumber">5.1</span> <span class="toctext">NTP</span></a></li>
<li class="toclevel-2 tocsection-45"><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#GlusterFS"><span class="tocnumber">5.2</span> <span class="toctext">GlusterFS</span></a></li>
<li class="toclevel-2 tocsection-46"><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#Encfs"><span class="tocnumber">5.3</span> <span class="toctext">Encfs</span></a></li>
<li class="toclevel-2 tocsection-47"><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#OpenVPN"><span class="tocnumber">5.4</span> <span class="toctext">OpenVPN</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-48"><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#FAQ"><span class="tocnumber">6</span> <span class="toctext">FAQ</span></a>
<ul>
<li class="toclevel-2 tocsection-49"><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#bridge_vmbr0_does_not_exist.21"><span class="tocnumber">6.1</span> <span class="toctext">bridge vmbr0 does not exist!</span></a></li>
<li class="toclevel-2 tocsection-50"><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#J.27ai_des_freeze_au_boot.2Farr.C3.AAt_de_mes_VZ"><span class="tocnumber">6.2</span> <span class="toctext">J'ai des freeze au boot/arrêt de mes VZ</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-51"><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#Ressources"><span class="tocnumber">7</span> <span class="toctext">Ressources</span></a></li>
</ul>
</div>

<h1><span class="mw-headline" id="Introduction"><span class="mw-headline-number">1</span> Introduction</span></h1>
<p><a rel="nofollow" class="external text" href="http://fr.wikipedia.org/wiki/Openvz">OpenVZ</a> est une technologie de virtualisation de niveau système d'exploitation basée sur le noyau Linux. OpenVZ permet à un serveur physique d'exécuter de multiples instances de systèmes d'exploitation isolés, connus sous le nom de serveurs privés virtuels (VPS) ou environnements virtuels (VE).
</p><p>En comparaison aux machines virtuelles telles que VMware et aux technologies de paravirtualisation telles que Xen, OpenVZ offre moins de flexibilité dans le choix du système d'exploitation&#160;: le système d'exploitation invité et hôte doivent être de type Linux (bien que les distributions de Linux peuvent être différentes dans des VEs différents). Cependant, la virtualisation au niveau OS d'OpenVZ offre une meilleure performance, une meilleure scalabilité (i.e. évolution), une meilleure densité, une meilleure gestion de ressource dynamique, et une meilleure facilité d'administration que ses alternatives. Selon le site Web d'OpenVZ, cette méthode de virtualisation introduirait une très faible pénalité sur les performances&#160;: 1 à 3% de pertes seulement par rapport à un ordinateur physique.
</p><p>OpenVZ est la base de Virtuozzo, un produit propriétaire fourni par SWsoft, Inc. OpenVZ est distribué sous la Licence publique générale GNU version 2.
</p><p>OpenVZ comprend le noyau Linux et un jeu de commandes utilisateurs.
</p>
<h1><span class="mw-headline" id="Installation"><span class="mw-headline-number">2</span> Installation</span></h1>
<p>Pour installer OpenVZ, c'est toujours aussi simple sur debian&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> aptitude</font>
</td></tr>
<tr>
<td>
<pre>aptitude install vzquota vzctl linux-image-2.6-openvz-amd64 linux-image-openvz-amd64 linux-headers-2.6-openvz-amd64 debootstrap
</pre>
</td></tr></table><br />
<p>Nous allons également éditer les sysctl pour ajouter ceci&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/sysctl.conf</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1"># On Hardware Node we generally need
# packet forwarding enabled and proxy arp disabled
&#160;
net.ipv4.conf.default.forwarding=1
net.ipv4.conf.default.proxy_arp = 0
net.ipv4.ip_forward=1
&#160;
# Enables source route verification
net.ipv4.conf.all.rp_filter = 1
&#160;
# Enables the magic-sysrq key
kernel.sysrq = 1
&#160;
# TCP Explict Congestion Notification
#net.ipv4.tcp_ecn = 0
&#160;
# we do not want all our interfaces to send redirects
net.ipv4.conf.default.send_redirects = 1
net.ipv4.conf.all.send_redirects = 0</pre></div></div>
</td></tr></table><br />
<p>Et on va activer ce dont nous avons besoin&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> </font>
</td></tr>
<tr>
<td>
<pre>sysctl -p
</pre>
</td></tr></table><br />
<h1><span class="mw-headline" id="Configuration"><span class="mw-headline-number">3</span> Configuration</span></h1>
<h2><span class="mw-headline" id="Pr.C3.A9paration_des_environnements"><span class="mw-headline-number">3.1</span> Préparation des environnements</span></h2>
<p>Vous avez la possibilité de créer vos environnements de 2 manières&#160;:
</p>
<ul><li> Par debootstrap</li>
<li> Par template</li></ul>
<p>Les 2 solutions se valent. La plus rapide étant le template car elle doit se trouver sur votre machine.
</p><p>Personnellement, j'ai utilisé longtemps la template. Puis récemment, j'ai du passer mon serveur en Squeeze (actuellement en testing) et aucunes templates n'existaient. J'ai donc opté pour la version debootstrap.
</p>
<h3><span class="mw-headline" id="Debootstrap"><span class="mw-headline-number">3.1.1</span> Debootstrap</span></h3>
<p>Vous allez voir que c'est très simple. Pour créer un VE, nous allons donc utiliser la méthode debootstrap. Voici la liste des distributions disponibles&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> ls</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">&gt; ls /usr/share/debootstrap/scripts/
breezy	edgy  etch-m68k  gutsy	hoary	      intrepid	karmic	lucid	  potato  sarge.buildd	    sid      stable   unstable	warty.buildd  woody.buildd
dapper	etch  feisty	 hardy	hoary.buildd  jaunty	lenny	maverick  sarge   sarge.fakechroot  squeeze  testing  warty	woody</pre></div></div>
</td></tr></table><br />
<p>Pour ma part, j'ai choisis Squeeze, donc&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> debootstrap</font>
</td></tr>
<tr>
<td>
<pre>debootstrap --arch amd64 squeeze /mnt/containers/private/101
</pre>
</td></tr></table><br />
<ul><li> --arch&#160;: On choisis l'architecture voulue, ici amd64.</li>
<li> squeeze&#160;: le nom de la distrib souhaité</li>
<li> /mnt/containers/private/101&#160;: l'endroit ou doit être placé mon VE (j'utilise ici l'ID du VE)</li></ul>
<h3><span class="mw-headline" id="Template"><span class="mw-headline-number">3.1.2</span> Template</span></h3>
<p>Nous n'allons pas créer notre template, mais plutôt en télécharger des déjà existantes à l'adresse suivante&#160;: <a rel="nofollow" class="external free" href="http://wiki.openvz.org/Download/template/precreated">http://wiki.openvz.org/Download/template/precreated</a> et le placer au bon endroit. Pour ma part j'ai modifier le fichier /etc/vz/vz.conf pour modifier les chemins par défaut. Ca pointe donc vers /mnt/containers.
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> </font>
</td></tr>
<tr>
<td>
<pre>cd /mnt/containers/template/cache
wget <a rel="nofollow" class="external free" href="http://download.openvz.org/template/precreated/contrib/debian-5.0-amd64-minimal.tar.gz">http://download.openvz.org/template/precreated/contrib/debian-5.0-amd64-minimal.tar.gz</a>
</pre>
</td></tr></table><br />
<h2><span class="mw-headline" id="R.C3.A9seaux"><span class="mw-headline-number">3.2</span> Réseaux</span></h2>
<h3><span class="mw-headline" id="En_mode_NAT"><span class="mw-headline-number">3.2.1</span> En mode NAT</span></h3>
<p>Si vous avez besoin d'avoir plusieurs VE disponible depuis 1 seule IP et que vous ne pouvez pas avoir d'autres IP directement accessibles, il faudra alors passer en mode naté. C'est notamment le cas si vous possédez une Dedibox (Illiad) ou un serveur Kimsufi (OVH) dont une seule IP WAN est disponible (en standard) pour un serveur donné et qu'il vous est impossible de faire <a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#Avec_une_interface_bridg.C3.A9e">du mode bridgé</a>.
</p><p>Nous allons donc configurer simplement la partie carte réseaux&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/network/interfaces</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1"># This file describes the network interfaces available on your system
# and how to activate them. For more information, see interfaces(5).
&#160;
# The loopback network interface
auto lo
iface lo inet loopback
&#160;
# The primary network interface
auto eth0
iface eth0 inet static
        address 88.xx.xx.xx
        netmask 255.255.255.0
        network 88.xx.xx.0
        broadcast 88.xx.xx.255
        gateway 88.xx.xx.xx</pre></div></div>
</td></tr></table><br />
<p>Jusque là, tout est classique. Seulement nous allons avoir besoin suite à la création d'un VE de faire du masquerading pour la possibilité d'avoir Internet depuis les VE et du PREROUTING pour tout ce qui est redirection. Nous utiliserons donc ici IPtables qui nous donnera accès à l'extérieur depuis les VE et dont les redirections de ports seront possible depuis l'extérieur vers les VE&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/init.d/iptables</font>
</td></tr>
<tr>
<td>
<div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="bash source-bash"><pre class="de1"><span class="co0">#!/bin/bash</span>
&#160;
<span class="co0">#-------------------------------------------------------------------------</span>
<span class="co0"># Essentials</span>
<span class="co0">#-------------------------------------------------------------------------</span>
&#160;
<span class="re2">IPTABLES</span>=<span class="st_h">'/sbin/iptables'</span>;
modprobe nf_conntrack_ftp
&#160;
<span class="co0">#-------------------------------------------------------------------------</span>
<span class="co0"># Physical and virtual interfaces definitions</span>
<span class="co0">#-------------------------------------------------------------------------</span>
&#160;
<span class="co0"># Interfaces</span>
<span class="re2">wan_if</span>=<span class="st0">&quot;eth0&quot;</span>;
<span class="re2">vpn_if</span>=<span class="st0">&quot;tap0&quot;</span>;
&#160;
<span class="co0">#-------------------------------------------------------------------------</span>
<span class="co0"># Networks definitions</span>
<span class="co0">#-------------------------------------------------------------------------</span>
&#160;
<span class="co0"># Networks</span>
<span class="re2">wan_ip</span>=<span class="st0">&quot;x.x.x.x&quot;</span>;
<span class="re2">lan_net</span>=<span class="st0">&quot;192.168.90.0/24&quot;</span>;
<span class="re2">vpn_net</span>=<span class="st0">&quot;192.168.20.0/24&quot;</span>;
&#160;
<span class="co0"># IPs</span>
<span class="re2">ed_ip</span>=<span class="st0">&quot;192.168.90.1&quot;</span>;
<span class="re2">banzai_ip</span>=<span class="st0">&quot;192.168.90.2&quot;</span>;
&#160;
<span class="co0">#-------------------------------------------------------------------------</span>
<span class="co0"># Global Rules input / output / forward</span>
<span class="co0">#-------------------------------------------------------------------------</span>
&#160;
<span class="co0"># Flushing tables</span>
<span class="re1">$IPTABLES</span> <span class="re5">-F</span>
<span class="re1">$IPTABLES</span> <span class="re5">-X</span>
<span class="re1">$IPTABLES</span> <span class="re5">-t</span> nat <span class="re5">-F</span>
&#160;
<span class="co0"># Define default policy</span>
<span class="re1">$IPTABLES</span> <span class="re5">-P</span> INPUT DROP
<span class="re1">$IPTABLES</span> <span class="re5">-P</span> OUTPUT ACCEPT
<span class="re1">$IPTABLES</span> <span class="re5">-P</span> FORWARD ACCEPT
&#160;
<span class="re1">$IPTABLES</span> <span class="re5">-A</span> INPUT <span class="re5">-j</span> ACCEPT <span class="re5">-d</span> <span class="re1">$lan_net</span>;
<span class="re1">$IPTABLES</span> <span class="re5">-A</span> INPUT <span class="re5">-j</span> ACCEPT <span class="re5">-m</span> state <span class="re5">--state</span> ESTABLISHED,RELATED
&#160;
<span class="co0">#-------------------------------------------------------------------------</span>
<span class="co0"># Allow masquerading for VE</span>
<span class="co0">#-------------------------------------------------------------------------</span>
&#160;
<span class="co0"># Activating masquerade to get Internet from VE</span>
<span class="re1">$IPTABLES</span> <span class="re5">-t</span> nat <span class="re5">-A</span> POSTROUTING <span class="re5">-o</span> <span class="re1">$wan_if</span> <span class="re5">-s</span> <span class="re1">$lan_net</span> <span class="re5">-j</span> MASQUERADE
&#160;
<span class="co0"># Activating masquerade to get VPN access from VE</span>
<span class="re1">$IPTABLES</span> <span class="re5">-t</span> nat <span class="re5">-A</span> POSTROUTING <span class="re5">-o</span> tap0 <span class="re5">-j</span> MASQUERADE
&#160;
<span class="co0">#-------------------------------------------------------------------------</span>
<span class="co0"># Allow ports on CT</span>
<span class="co0">#-------------------------------------------------------------------------</span>
&#160;
<span class="co0"># Allow ICMP</span>
<span class="re1">$IPTABLES</span> <span class="re5">-A</span> INPUT <span class="re5">-j</span> ACCEPT <span class="re5">-p</span> icmp
&#160;
<span class="co0"># SSH access</span>
<span class="re1">$IPTABLES</span> <span class="re5">-A</span> INPUT <span class="re5">-j</span> ACCEPT <span class="re5">-p</span> tcp <span class="re5">--dport</span> <span class="nu0">22</span>
&#160;
<span class="co0">#-------------------------------------------------------------------------</span>
<span class="co0"># Redirections for incoming connections (wan)</span>
<span class="co0">#-------------------------------------------------------------------------</span>
&#160;
<span class="co0"># HTTP access</span>
<span class="re1">$IPTABLES</span> <span class="re5">-t</span> nat <span class="re5">-A</span> PREROUTING <span class="re5">-p</span> tcp <span class="re5">--dport</span> <span class="nu0">80</span> <span class="re5">-d</span> <span class="re1">$wan_ip</span> <span class="re5">-j</span> DNAT <span class="re5">--to-destination</span> <span class="re1">$ed_ip</span>:<span class="nu0">80</span>
&#160;
<span class="co0"># HTTPS access</span>
<span class="re1">$IPTABLES</span> <span class="re5">-t</span> nat <span class="re5">-A</span> PREROUTING <span class="re5">-p</span> tcp <span class="re5">--dport</span> <span class="nu0">443</span> <span class="re5">-d</span> <span class="re1">$wan_ip</span> <span class="re5">-j</span> DNAT <span class="re5">--to-destination</span> <span class="re1">$ed_ip</span>:<span class="nu0">443</span></pre></div></div>
</td></tr></table><br />
<p>Ici j'ai le port 80 et 443 qui sont redirigés vers une machine (Ed).
</p>
<h3><span class="mw-headline" id="Avec_une_interface_bridg.C3.A9e"><span class="mw-headline-number">3.2.2</span> Avec une interface bridgée</span></h3>
<p>Le gros intérêt de l’interface venet, c’est que ça permet à l’administrateur du serveur physique de décider de la configuration réseau de la machine virtuelle. C’est particulièrement appréciable pour un hébergeur qui souhaite vendre un service d’hébergement de machines virtuelles, car il peut librement laisser ses clients administrer leur serveur virtuel OpenVZ tout en étant certain qu’ils ne pourront pas perturber le réseau, s’attribuer davantage d’adresses IP que prévu, bidouiller les tables de routage, etc. Si vous utilisez OpenVZ pour fournir des services d’hébergement à vos clients, l’interface veth n’est pas faite pour vous. Je ne suis pas dans ce cas de figure, donc les potentiels problèmes de sécurité que peuvent poser l’interface veth pour un hébergeur ne me concernent pas.
</p><p>J’utilise à la fois venet et veth sur les serveurs que j’administre&#160;: veth lorsque j’ai besoin d’avoir un accès aux couches ethernet depuis les serveurs virtuels, et venet dans tous les autres cas. Mais, contrairement à la simplicité offerte par les interfaces venet, pour pouvoir utiliser une interface veth dans un serveur virtuel, il faut faire quelques opérations de configuration complémentaires pour préparer le serveur physique à recevoir des serveurs virtuels utilisant veth. C’est ce que je vais décrire dans les sections suivantes.
</p><p>Nous allons donc installer le nécessaire&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> apt-get</font>
</td></tr>
<tr>
<td>
<pre>apt-get install bridge-utils
</pre>
</td></tr></table><br />
<p>Puis créer une configuration type&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/network/interfaces</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">auto lo
iface lo inet loopback
&#160;
auto eth0
iface eth0 inet manual
&#160;
auto vmbr0
iface vmbr0 inet static
    bridge_ports eth0
    address 192.168.1.216
    netmask 255.255.255.0
    network 192.168.1.0
    broadcast 192.168.1.255
    gateway 192.168.1.254</pre></div></div>
</td></tr></table><br />
<p>Rebootez ensuite le serveur.
</p><p>Afin qu’au lancement d’un serveur virtuel OpenVZ ajoute ou retire dynamiquement une interface veth au bridge, il faut créer quelques fichiers sur le serveur physique. Cette opération est à faire une bonne fois pour toutes sur le serveur physique, indépendamment du nombre de serveurs virtuels qui seront créés par la suite. Il est également possible de la faire sur un serveur qui, au final, n’héberge que des serveurs virtuels utilisant des interfaces venet, cela ne perturbe en rien ces derniers.
</p><p>D’abord, il faut créer le fichier /etc/vz/vznet.conf, avec le contenu suivant&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/vz/vznet.conf</font>
</td></tr>
<tr>
<td>
<pre>#!/bin/bash
EXTERNAL_SCRIPT="/usr/sbin/vznetaddbr"
</pre>
</td></tr></table><br />
<p>puis le fichier /usr/sbin/vznetaddbr, avec le contenu suivant&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /usr/sbin/vznetaddbr</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">#!/bin/sh
#
# Add virtual network interfaces (veth's) in a container to a bridge on CT0
&#160;
CONFIGFILE=/etc/vz/conf/$VEID.conf
. $CONFIGFILE
&#160;
NETIFLIST=$(printf&#160;%s &quot;$NETIF&quot; |tr ';' '\n')
&#160;
if [ -z &quot;$NETIFLIST&quot; ]; then
   echo &gt;&amp;2 &quot;According to $CONFIGFILE, CT$VEID has no veth interface configured.&quot;
   exit 1
fi
&#160;
for iface in $NETIFLIST; do
    bridge=
    host_ifname=
&#160;
    for str in $(printf&#160;%s &quot;$iface&quot; |tr ',' '\n'); do
	case &quot;$str&quot; in
	    bridge=*|host_ifname=*)
		eval &quot;${str%%=*}=\${str#*=}&quot;&#160;;;
	esac
    done
&#160;
    [ &quot;$host_ifname&quot; = &quot;$3&quot; ] ||
	continue
&#160;
    [ -n &quot;$bridge&quot; ] ||
	bridge=vmbr0
&#160;
    echo &quot;Adding interface $host_ifname to bridge $bridge on CT0 for CT$VEID&quot;
    ip link set dev &quot;$host_ifname&quot; up
    echo 1 &gt;&quot;/proc/sys/net/ipv4/conf/$host_ifname/proxy_arp&quot;
    echo 1 &gt;&quot;/proc/sys/net/ipv4/conf/$host_ifname/forwarding&quot;
    brctl addif &quot;$bridge&quot; &quot;$host_ifname&quot;
&#160;
    break
done
&#160;
exit 0</pre></div></div>
</td></tr></table><br />
<p>Pour info, j'ai modifier la ligne contenant "bridge=" avec mon interface vmbr0.
</p><p>Il faut également associer le droit d’exécution à ce fichier en tapant la commande&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> chmod</font>
</td></tr>
<tr>
<td>
<pre>chmod 0500 /usr/sbin/vznetaddbr
</pre>
</td></tr></table><br />
<p>On va maintenant configurer la VE (voir également plus bas comment manager une VE)&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> vzctl</font>
</td></tr>
<tr>
<td>
<pre>vzctl set $my_veid --netif_add eth0 --save
</pre>
</td></tr></table><br />
<p>Et enfin éditez votre configuration de machine et ajoutez l'interface bridge pour celui ci&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/vz/conf/$VEID.conf</font>
</td></tr>
<tr>
<td>
<pre>CONFIG_CUSTOMIZED="yes"
VZHOSTBR="vmbr0"
</pre>
</td></tr></table><br />
<p>La fin de config du fichier de conf doit au final ressembler à ceci&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/vz/conf/$VEID.conf</font>
</td></tr>
<tr>
<td>
<pre>...
OSTEMPLATE="debian-5.0-amd64-minimal"
ORIGIN_SAMPLE="vps.basic"
HOSTNAME="vz.deimos.fr"
CONFIG_CUSTOMIZED="yes"
VZHOSTBR="vmbr0"
IP_ADDRESS=""
NAMESERVER="192.168.100.3"
CAPABILITY="SYS_TIME:on "
NETIF="ifname=eth0,mac=00:18:51:96:D4:8D,host_ifname=veth101.0,host_mac=00:18:51:B8:B8:CF"
</pre>
</td></tr></table><br />
<p>Maintenant, il suffit de configurer l'interface eth0 comme vous avez l'habitude de faire sur votre VE.
</p>
<h3><span class="mw-headline" id="Avec_des_vlans"><span class="mw-headline-number">3.2.3</span> Avec des vlans</span></h3>
<p>Vous pouvez avoir besoin de créer des vlan dans vos VE. Ca fonctionne même très bien avec une interface bridgée. Pour se faire, sur la machine host, vous devez avoir un vlan de configuré (<a href="Mise_en_place_de_VLAN.html" title="Mise en place de VLAN">pour la mise en place, utilisez cette documentation</a>). Pour ceux qui souhaitent quand même un exemple&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/network/interfaces</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1"># This file describes the network interfaces available on your system
# and how to activate them. For more information, see interfaces(5).
&#160;
# The loopback network interface
auto lo
iface lo inet loopback
&#160;
# The primary network interface
allow-hotplug eth0
auto eth0
iface eth0 inet manual
&#160;
# The bridged interface
auto vmbr0
iface vmbr0 inet static
        address 192.168.100.1
        netmask 255.255.255.0
        gateway 192.168.100.254
        broadcast 192.168.100.255
        network 192.168.100.0
        bridge_ports eth0
        bridge_fd 9
        bridge_hello 2
        bridge_maxage 12
        bridge_stp off
&#160;
# The DMZ Vlan 110
auto vmbr0.110
iface vmbr0.110 inet static
	address 192.168.110.1
	netmask 255.255.255.0
	broadcast 192.168.110.255
	vlan_raw_device vmbr0</pre></div></div>
</td></tr></table><br />
<p>Cet exemple est fait avec une interface bridgée car j'ai du <a href="./KVM_:_Mise_en_place_de_KVM.html" title="KVM : Mise en place de KVM">KVM</a> qui tourne dessus, mais rien ne vous oblige à ce qu'elle le soit.
</p><p>Ensuite, lorsque vous créez votre VE, vous n'avez rien de plus à faire lors de la création de votre interface réseau pour votre VE. Lancez ensuite la création de votre VE et n'oubliez pas d'installer le package "vlan" pour pouvoir créer un accès vlan au sein même de votre VE. Voici encore une fois de quoi vous donner une idée de la conf réseau du VE&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/vz/conf/VEID.conf</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">...
CONFIG_CUSTOMIZED=&quot;yes&quot;
VZHOSTBR=&quot;vmbr0&quot;
IP_ADDRESS=&quot;&quot;
NETIF=&quot;ifname=eth0,mac=00:18:50:FE:EF:0B,host_ifname=veth101.0,host_mac=00:18:50:07:B8:F4&quot;</pre></div></div>
</td></tr></table><br />
<p>Pour la conf du VE, c'est preque identique que pour la machine host, il va falloir créer une interface vlan sur l'interface principale (pas besoin encore une fois d'avoir l'interface principale de configurée, seulement la vlan suffit). Pour les plus perplexes, voici un exemple de configuration dans un VE&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/network/interfaces</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1"># This configuration file is auto-generated.
# WARNING: Do not edit this file, your changes will be lost.
# Please create/edit /etc/network/interfaces.head and /etc/network/interfaces.tail instead,
# their contents will be inserted at the beginning and at the end
# of this file, respectively.
#
# NOTE: it is NOT guaranteed that the contents of /etc/network/interfaces.tail
# will be at the very end of this file.
&#160;
# Auto generated lo interface
auto lo
iface lo inet loopback
&#160;
# VE interface
auto eth0
iface eth0 inet manual
&#160;
# VLAN 110 interface
auto eth0.110
iface eth0.110 inet static
	address 192.168.110.2
	netmask 255.255.255.0
	gateway 192.168.110.254
	broadcast 192.168.110.255
	vlan_raw_device eth0</pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="Avec_du_Bonding"><span class="mw-headline-number">3.2.4</span> Avec du Bonding</span></h3>
<p>Vous pouvez avoir besoin de créer du bonding bridgé dans vos VE. Pour se faire, sur la machine host, vous devez avoir un bonding de configuré (<a href="./Réseau_:_créer_un_bonding.html" title="Réseau : créer un bonding">pour la mise en place, utilisez cette documentation</a>). Pour ceux qui souhaitent quand même un exemple&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/network/interfaces</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1"># This file describes the network interfaces available on your system
# and how to activate them. For more information, see interfaces(5).
&#160;
# The loopback network interface
auto lo eth0 eth1
iface lo inet loopback
&#160;
iface eth0 inet manual
iface eth1 inet manual
&#160;
auto bond0
iface bond0 inet manual
    slaves eth0 eth1
    bond_mode active-backup
    bond_miimon 100
    bond_downdelay 200
    bond_updelay 200
&#160;
auto vmbr0
iface vmbr0 inet static
    address 192.168.0.227
    netmask 255.255.255.0
    network 192.168.0.0
    gateway 192.168.0.245
    bridge_ports bond0</pre></div></div>
</td></tr></table><br />
<h2><span class="mw-headline" id="NFS"><span class="mw-headline-number">3.3</span> NFS</span></h2>
<p>Je n'aborderais ici que le côté client dans un VE, pas d'un serveur dans un VE.
</p>
<h3><span class="mw-headline" id="Serveur"><span class="mw-headline-number">3.3.1</span> Serveur</span></h3>
<p>Tout d'abord côté serveur, <a href="./NFS_:_Mise_en_place_d'un_serveur_NFS.html" title="NFS : Mise en place d'un serveur NFS">montez votre serveur NFS en suivant cette documentation</a>.
</p><p>Puis nous allons installer ceci qui va nous permettre d'utiliser non seulement le protocole v3 d'NFS, mais en plus de pouvoir faire abstraction de la couche kernel (pratique en cas de crash)&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> aptitude</font>
</td></tr>
<tr>
<td>
<pre>aptitude install nfs-user-server
</pre>
</td></tr></table><br />
<h3><span class="mw-headline" id="Client"><span class="mw-headline-number">3.3.2</span> Client</span></h3>
<ul><li> Sur la machine hôte (HN), ajoutez ces lignes dans sysctl.conf&#160;:</li></ul>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/sysctl.conf</font>
</td></tr>
<tr>
<td>
<pre>...
# OpenVZ NFS Client
sunrpc.ve_allow_rpc = 1
fs.nfs.ve_allow_nfs = 1
kernel.ve_allow_kthreads = 1
</pre>
</td></tr></table><br />
<p>Puis on applique tout ça à chaud&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> sysctl</font>
</td></tr>
<tr>
<td>
<pre>sysctl -p
</pre>
</td></tr></table><br />
<p>Activons maintenant le NFS sur les VE qui nous intéressent&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> vzctl</font>
</td></tr>
<tr>
<td>
<pre>vzctl set $my_veid --features "nfs:on" --save
</pre>
</td></tr></table><br />
<p>Je ne sais pas si cette étape est indispensable, mais dans le doute, je l'ajoute quand même&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> aptitude</font>
</td></tr>
<tr>
<td>
<pre>aptitude install nfs-user-server
</pre>
</td></tr></table><br />
<p>Ensuite, vous pouvez monter normalement vos points de montage NFS. Il est cependant possible que vous rencontriez quelques soucis. C'est pour quoi sur le serveur, je vous conseil de rajouter l'option 'no_root_squash' dans le fichier export&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/export</font>
</td></tr>
<tr>
<td>
<pre>/mnt/backups/backups 192.168.0.127(rw,no_root_squash)
</pre>
</td></tr></table><br />
<p>Et sur le client, ajoutez l'option nolock pour monter le NFS&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> mount</font>
</td></tr>
<tr>
<td>
<pre>mount -t nfs -o nolock @IP:/mon/partage mon_point_de_montage
</pre>
</td></tr></table><br />
<h2><span class="mw-headline" id="Mount_Bind"><span class="mw-headline-number">3.4</span> Mount Bind</span></h2>
<p>Les mount bind peuvent être parfois très pratiques. Voilà comment faire&#160;:
</p>
<h3><span class="mw-headline" id="Mount_script"><span class="mw-headline-number">3.4.1</span> Mount script</span></h3>
<p>Créez un script dans /etc/vz/conf/vps.mount pour tous les VE ou /etc/vz/conf/CTID.mount pour un VE en particulier (remplacer CITD par le numéro du VE)&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/vz/conf/101.mount</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">#!/bin/bash
source /etc/vz/vz.conf
source ${VE_CONFFILE}
mount --bind /mnt/disk ${VE_ROOT}/mnt/disk</pre></div></div>
</td></tr></table><br />
<p>Et adaptez la dernière ligne avec vos besoins.
</p>
<h3><span class="mw-headline" id="Unmount_script"><span class="mw-headline-number">3.4.2</span> Unmount script</span></h3>
<p>Et enfin la même chose pour le script du démontage, donc /etc/vz/conf/vps.umount ou /etc/vz/conf/CTID.umount&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/vz/conf/101.umount</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">#!/bin/bash
source /etc/vz/vz.conf
source ${VE_CONFFILE}
umount ${VE_ROOT}/mnt/disk
exit 0</pre></div></div>
</td></tr></table><br />
<p>Et enfin on applique les droits qu'il faut pour que ce soit exécutable&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> chmod</font>
</td></tr>
<tr>
<td>
<pre>chmod u+x /etc/vz/conf/CTID.mount /etc/vz/conf/CTID.umount
</pre>
</td></tr></table><br />
<h1><span class="mw-headline" id="Management"><span class="mw-headline-number">4</span> Management</span></h1>
<h2><span class="mw-headline" id="Cr.C3.A9er_un_VE"><span class="mw-headline-number">4.1</span> Créer un VE</span></h2>
<p>Choisissez la méthode voulu en fonction de la méthode de création de la VM que vous souhaitez (template ou debootstrap).
</p>
<h3><span class="mw-headline" id="Template_2"><span class="mw-headline-number">4.1.1</span> Template</span></h3>
<p>Pour créer un container, utilisez cette commande&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> vzctl</font>
</td></tr>
<tr>
<td>
<pre>my_veid=101
vzctl create $my_veid --ostemplate debian-5.0-amd64-minimal --config vps.basic
vzctl set $my_veid --onboot yes --save
vzctl set $my_veid --hostname nagios.mycompany.com --save
vzctl set $my_veid --ipadd 192.168.0.130 --save
vzctl set $my_veid --nameserver 192.168.0.27 --save
</pre>
</td></tr></table><br />
<p>Si vous voulez configurer vos interfaces en mode bridgé, n'oubliez pas <a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#Avec_une_interface_bridg.C3.A9e" title="OpenVZ : Mise en place d'OpenVZ">cette partie</a>.
</p>
<h3><span class="mw-headline" id="Debootstrap_2"><span class="mw-headline-number">4.1.2</span> Debootstrap</span></h3>
<p>A l'époque ou j'écris ces lignes, Squeeze n'est pas encore la version stable, mais vient (aujourd'hui même de freezer pour être stable). Il y a donc quelques petits trucs qui peuvent varier comme ceci qu'il va falloir créer&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> cp</font>
</td></tr>
<tr>
<td>
<pre>cp /etc/vz/conf/ve-basic.conf-sample /etc/vz/conf/ve-vps.basic.conf-sample
</pre>
</td></tr></table><br />
<p>Nous copions donc ici les paramètres par défaut d'un VE vers un nouveau nom qu'il sera capable de prendre par défaut. Lançons donc sa configuration&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> vzctl</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">&gt; my_veid=101
&gt; vzctl set $my_veid --applyconfig vps.basic --save
WARNING: /etc/vz/conf/101.conf not found: No such file or directory
Saved parameters for CT 101</pre></div></div>
</td></tr></table><br />
<p>Ensuite nous rajoutons quelques lignes supplémentaires nécessaire dans notre fichier de configuration&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> </font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1"> echo &quot;OSTEMPLATE=debian&quot; &gt;&gt; /etc/vz/conf/$my_veid.conf</pre></div></div>
</td></tr></table><br />
<p>Puis on configure les paramètres réseaux&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> vzctl</font>
</td></tr>
<tr>
<td>
<pre>vzctl set $my_veid --ipadd 192.168.0.130 --save
vzctl set $my_veid --nameserver 192.168.0.27 --save
</pre>
</td></tr></table><br />
<p>Ensuite nous allons supprimer udev qui peut empêcher la VM de booter&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> rm</font>
</td></tr>
<tr>
<td>
<pre>rm /mnt/containers/private/101/etc/rcS.d/S02udev
</pre>
</td></tr></table><br />
<p>Puis nous allons démarrer le VE et entrer dedans&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> vzctl</font>
</td></tr>
<tr>
<td>
<pre>vzctl start $my_veid
vzctl enter $my_veid
</pre>
</td></tr></table><br />
<p>Renseignez votre fichier source.list&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/apt/source.list</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">deb http://ftp.fr.debian.org/debian/ squeeze main non-free contrib
deb-src http://ftp.fr.debian.org/debian/ squeeze main non-free contrib
&#160;
deb http://security.debian.org/ squeeze/updates main contrib non-free
deb-src http://security.debian.org/ squeeze/updates main contrib non-free</pre></div></div>
</td></tr></table><br />
<p>Puis, lancez ces commandes pour supprimer le superflu et supprimer les gettys (les VEs n'en n'utilisent pas)&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> </font>
</td></tr>
<tr>
<td>
<pre>sed -i -e '/getty/d' /etc/inittab
rm -Rf /lib/udev/
</pre>
</td></tr></table><br />
<p>Nous résolvons le problème de mtab&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> </font>
</td></tr>
<tr>
<td>
<pre>rm -f /etc/mtab
ln -s /proc/mounts /etc/mtab
</pre>
</td></tr></table><br />
<h2><span class="mw-headline" id="D.C3.A9marrer_un_VE"><span class="mw-headline-number">4.2</span> Démarrer un VE</span></h2>
<p>Maintenant vous pouvez démarrer votre VE&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> vzctl</font>
</td></tr>
<tr>
<td>
<pre>vzctl start 101
</pre>
</td></tr></table><br />
<h2><span class="mw-headline" id="Changer_le_mot_de_passe_root_d.27un_VE"><span class="mw-headline-number">4.3</span> Changer le mot de passe root d'un VE</span></h2>
<p>Si vous souhaitez changer le mot de passe root&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> vzctl</font>
</td></tr>
<tr>
<td>
<pre>vzctl exec 101 passwd
</pre>
</td></tr></table><br />
<h2><span class="mw-headline" id="Lister_les_VE"><span class="mw-headline-number">4.4</span> Lister les VE</span></h2>
<p>Pour lister vos VE, utilisez la commande vzlist&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> vzlist</font>
</td></tr>
<tr>
<td>
<pre>$ vzlist 
     VEID      NPROC STATUS  IP_ADDR         HOSTNAME                        
      101          8 running 192.168.0.130   nagios.mycompany.com
</pre>
</td></tr></table><br />
<h2><span class="mw-headline" id="Stopper_un_VE"><span class="mw-headline-number">4.5</span> Stopper un VE</span></h2>
<p>Pour arrêter noter VE&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> vzctl</font>
</td></tr>
<tr>
<td>
<pre>vzctl stop 101
Stopping container ...
Container was stopped
Container is unmounted
</pre>
</td></tr></table><br />
<h2><span class="mw-headline" id="Red.C3.A9marrer_un_VE"><span class="mw-headline-number">4.6</span> Redémarrer un VE</span></h2>
<p>Pour redémarrer un VE&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> vzctl</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">$ vzctl restart 101
Restarting VE
Stopping VE ...
VE was stopped
VE is unmounted
Starting VE ...
VE is mounted
Adding IP address(es): 192.168.0.130
Setting CPU units: 1000
Configure meminfo: 500000
Set hostname: nagios.mycompany.com
File resolv.conf was modified
VE start in progress...</pre></div></div>
</td></tr></table><br />
<h2><span class="mw-headline" id="D.C3.A9truire_un_VE"><span class="mw-headline-number">4.7</span> Détruire un VE</span></h2>
<p>Pour supprimer définitivement un VE&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> vzctl</font>
</td></tr>
<tr>
<td>
<pre>$ vzctl destroy 101
Destroying container private area: /vz/private/101
Container private area was destroyed
</pre>
</td></tr></table><br />
<h2><span class="mw-headline" id="Entrer_dans_un_VE"><span class="mw-headline-number">4.8</span> Entrer dans un VE</span></h2>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> vzctl</font>
</td></tr>
<tr>
<td>
<pre>$ vzctl enter 101
entered into VE 101
</pre>
</td></tr></table><br />
<h2><span class="mw-headline" id="Limites_de_VE"><span class="mw-headline-number">4.9</span> Limites de VE</span></h2>
<p>Par défaut il y a des limites que les VE ne peuvent passer. Nous allons voir comment les gérer ici. Si vous souhaitez tout de même aller encore plus loin, sachez qu'il y a tout d'expliquer sur le site officiel <a rel="nofollow" class="external free" href="http://wiki.openvz.org/User_beancounters">http://wiki.openvz.org/User_beancounters</a>.
</p>
<h3><span class="mw-headline" id="Lister_les_limites"><span class="mw-headline-number">4.9.1</span> Lister les limites</span></h3>
<p>Pour lister les limites, nous allons exécuter cette commande&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> vctl</font>
</td></tr>
<tr>
<td>
<pre>$ vzctl exec 101 cat /proc/user_beancounters
Version: 2.5
      uid  resource                     held              maxheld              barrier                limit              failcnt
     101:  kmemsize                  1301153              3963508             14372700             14790164                    0
           lockedpages                     0                    8                  256                  256                    0
           privvmpages                  8987                49706                65536                69632                    0
           shmpages                      640                  656                21504                21504                    0
           dummy                           0                    0                    0                    0                    0
           numproc                         9                   21                  240                  240                    0
           physpages                    1786                27164                    0  9223372036854775807                    0
           vmguarpages                     0                    0                33792  9223372036854775807                    0
           oomguarpages                 1786                27164                26112  9223372036854775807                    0
           numtcpsock                      3                    6                  360                  360                    0
           numflock                        1                    7                  188                  206                    0
           numpty                          1                    2                   16                   16                    0
           numsiginfo                      0                    2                  256                  256                    0
           tcpsndbuf                  106952               106952              1720320              2703360                    0
           tcprcvbuf                   49152              1512000              1720320              2703360                    0
           othersockbuf                    0                21008              1126080              2097152                    0
           dgramrcvbuf                     0                 5648               262144               262144                    0
           numothersock                   25                   29                  360                  360                    0
           dcachesize                 115497               191165              3409920              3624960                    0
           numfile                       234                  500                 9312                 9312                    0
           dummy                           0                    0                    0                    0                    0
           dummy                           0                    0                    0                    0                    0
           dummy                           0                    0                    0                    0                    0
           numiptent                      10                   10                  128                  128                    0
</pre>
</td></tr></table><br />
<p>Il faut que la dernière ligne soit toujours à 0, sinon c'est que clairement vous avez atteint les limites.
</p><p>Voici quelques informations importantes&#160;:
</p>
<ul><li> held&#160;: Actuellement la valeur de la ressource</li>
<li> maxheld&#160;: la valeur maximum que la ressource a atteind</li>
<li> barrier&#160;: la limite soft (avertissement). Ca signifie que la valeur held a déjà été jusqu'à cette valeur</li>
<li> limit&#160;: la milite hard. La valeur held ne pourra jamais dépasser cette valeur.</li></ul>
<p>Pour les augmenter, limites vous avez 2 solutions&#160;:
</p>
<ul><li> Vous pouvez le faire <a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#Appliquer_des_limites_.C3.A0_la_vol.C3.A9e" title="OpenVZ : Mise en place d'OpenVZ">à la volée</a>.</li>
<li> Allez dans /etc/vz/conf/101.conf et augmentez les valeurs qui posent problème. Malheureusement, cela nécessite un redémarrage du VE pour que ces paramètres soient prit en compte.</li></ul>
<p>Il est possible que le failcnt ne soit pas réinitialiser à 0...pas d'inquiétude, il se fera plus tard.
</p>
<h3><span class="mw-headline" id="Maximiser_les_limites"><span class="mw-headline-number">4.9.2</span> Maximiser les limites</span></h3>
<p>Si vous avez trop de restrictions par rapport à vos besoins ou que vous sentez que le VE que vous allez créer va être lourde, maximisez dès le départ ceci&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> vzsplit</font>
</td></tr>
<tr>
<td>
<pre>vzsplit -n <b>2</b> -f max-limits
</pre>
</td></tr></table><br />
<ul><li> 2&#160;: changez ce numéro par le nombre de VM que vous voulez faire tourner sur votre machine et il se chargera de calculer au mieux les limites pour votre VE</li></ul>
<p>Un fichier <b>/etc/vz/conf/ve-max-limits.conf-sample</b>. Vous pouvez l'éditer à tout moment et faire les modifications que vous souhaitez. Si vous voulez l'appliquer à un VE&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> vzctl</font>
</td></tr>
<tr>
<td>
<pre>vzctl set <b>101</b> --applyconfig <b>max-limits</b> --save
</pre>
</td></tr></table><br />
<p>Le VE 101 a maintenant une nouvelle configuration via la config 'max-limits'.
</p>
<h3><span class="mw-headline" id="Appliquer_des_limites_.C3.A0_la_vol.C3.A9e"><span class="mw-headline-number">4.9.3</span> Appliquer des limites à la volée</span></h3>
<p>Par exemple, vous souhaitez changer la taille de la RAM à la volée&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> vzctl</font>
</td></tr>
<tr>
<td>
<pre>vzctl set 101 --privvmpages <b>786432:1048576</b> --save <b>--setmod restart</b>
</pre>
</td></tr></table><br />
<ul><li> 786432&#160;: correspondant à la limite soft (barrier)</li>
<li> 1048576&#160;: correspondant à la limite hard (limit)</li></ul>
<p>Grâce au 'setmod restart', je peux maintenant appliquer des limites à la volée.
</p>
<h3><span class="mw-headline" id="Quotas_disques"><span class="mw-headline-number">4.9.4</span> Quotas disques</span></h3>
<p>Vous avez peut être mis des quotas disque et vous arrivez à 100% de votre disque VE. Pas de soucis, on augmente le quota à chaud&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> vzctl</font>
</td></tr>
<tr>
<td>
<pre>vzctl set 101 --diskspace 14G:15G --save
</pre>
</td></tr></table><br />
<p>Si vous ne voulez pas de quota, ajoutez cette ligne dans la configuration du VE&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/vz/conf/VEID.conf</font>
</td></tr>
<tr>
<td>
<pre>DISK_QUOTA=no
</pre>
</td></tr></table><br />
<h3><span class="mw-headline" id="Limiter_le_CPU"><span class="mw-headline-number">4.9.5</span> Limiter le CPU</span></h3>
<p>Si vous souhaitez limiter le CPU, il y a plusieurs façons d'y arriver. Soit vous jouez avec le scheduler, sois vous appliquez un pourcentage. Pour des usages basique la deuxième solution vous conviendra&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> vzctl</font>
</td></tr>
<tr>
<td>
<pre>&gt; vzctl set $my_veid --cpulimit 80 --save --setmod restart
Setting CPU limit: 80
Saved parameters for CT 102
</pre>
</td></tr></table><br />
<p>Par exemple ici j'ai limiter mon VE 102 à 80% de CPU. Pour plus d'infos&#160;: <a rel="nofollow" class="external free" href="http://wiki.openvz.org/Resource_shortage">http://wiki.openvz.org/Resource_shortage</a>
</p>
<h3><span class="mw-headline" id="D.C3.A9sactiver_les_limites_les_plus_contraignantes"><span class="mw-headline-number">4.9.6</span> Désactiver les limites les plus contraignantes</span></h3>
<p>Si vous avez beaucoup de charge sur un VE, vous allez régulièrement devoir augmenter certains paramètres assez régulièrement, ce qui peut vite devenir fatiguant. Pour être tranquile avec certains d'entre eux, on peut tout simplement désactiver les limites en entrant la valeur maximale&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> vzctl</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">vzctl set $my_veid --kmemsize unlimited --save --setmod restart
vzctl set $my_veid --lockedpages unlimited --save --setmod restart
vzctl set $my_veid --privvmpages unlimited --save --setmod restart
vzctl set $my_veid --shmpages unlimited --save --setmod restart
vzctl set $my_veid --numproc unlimited --save --setmod restart
vzctl set $my_veid --numtcpsock unlimited --save --setmod restart
vzctl set $my_veid --numflock unlimited --save --setmod restart
vzctl set $my_veid --numpty unlimited --save --setmod restart
vzctl set $my_veid --numsiginfo unlimited --save --setmod restart
vzctl set $my_veid --tcpsndbuf unlimited --save --setmod restart
vzctl set $my_veid --tcprcvbuf unlimited --save --setmod restart
vzctl set $my_veid --othersockbuf unlimited --save --setmod restart
vzctl set $my_veid --dgramrcvbuf unlimited --save --setmod restart
vzctl set $my_veid --numothersock unlimited --save --setmod restart
vzctl set $my_veid --dcachesize unlimited --save --setmod restart
vzctl set $my_veid --numfile unlimited --save --setmod restart
vzctl set $my_veid --numiptent unlimited --save --setmod restart</pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="Validation_des_limites"><span class="mw-headline-number">4.9.7</span> Validation des limites</span></h3>
<p>Si vous souhaitez faire valider vos limites pour être sur que tout est ok&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> vzcfgvalidate</font>
</td></tr>
<tr>
<td>
<pre>&gt; vzcfgvalidate /etc/vz/conf/101.conf 
Validation completed: success
</pre>
</td></tr></table><br />
<h3><span class="mw-headline" id="Validation_automatique_des_limites"><span class="mw-headline-number">4.9.8</span> Validation automatique des limites</span></h3>
<p>Si par exemple, vous voulez valider au mieux l'utilisation des ressources de votre machine et également suivre les best practices d'OpenVZ, vous pouvez utiliser l'outil vzcfgvalidate&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> vzcfgvalidate</font>
</td></tr>
<tr>
<td>
<pre>vzcfgvalidate -i /etc/vz/conf/101.conf
</pre>
</td></tr></table><br />
<p>Ceci va lancer un mode interactif en informant de ce qui ne va pas. A vous de valider si oui ou non vous souhaitez faire les modifications. Si vous n'avez pas les capacité d'analyze nécessaire aux problèmes ou tout simplement que vous n'avez pas envie de vous prendre la tête avec ceci, remplacez l'option '-i' par '-r' qui ajustera automatiquement aux bonne valeurs.
</p><p>Pour ceux qui ne veulent pas se prendre du tout la tête avec les limites, voici un petit script qui ajustera toutes les limites de tous vos VE automatiquement. Il ne reste plus qu'a le coller en crontab&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> auto_ajust_ve.sh</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="bash source-bash"><pre class="de1"><span class="co0">#!/bin/sh</span>
<span class="co0"># Auto Ajust VE</span>
<span class="co0"># Made by Pierre Mavro / Deimos</span>
<span class="co0"># Contact&#160;: deimos at deimos dot fr</span>
&#160;
<span class="co0"># Configure VE directory config path</span>
<span class="re2">VE_CONF</span>=<span class="st0">&quot;/etc/vz/conf&quot;</span>
&#160;
<span class="kw3">echo</span> <span class="st0">&quot;Auto ajustment start&#160;:&quot;</span>
<span class="kw1">for</span> i <span class="kw1">in</span> <span class="sy0">`</span><span class="kw2">ls</span> <span class="re1">$VE_CONF</span><span class="sy0">/*</span>.conf<span class="sy0">`</span>&#160;; <span class="kw1">do</span>
	<span class="kw1">if</span> <span class="br0">&#91;</span> <span class="re1">$i</span> <span class="sy0">!</span>= <span class="st0">&quot;<span class="es2">$VE_CONF</span>/0.conf&quot;</span> <span class="br0">&#93;</span>&#160;; <span class="kw1">then</span>
                <span class="kw3">echo</span> <span class="st0">&quot;Ajusting <span class="es2">$i</span>...&quot;</span>
		vzcfgvalidate <span class="re5">-r</span> <span class="re1">$i</span>
	<span class="kw1">fi</span>
<span class="kw1">done</span>
<span class="kw3">echo</span> <span class="st0">&quot;Auto ajustment done&quot;</span></pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="Ajustement_automatique_des_limites"><span class="mw-headline-number">4.9.9</span> Ajustement automatique des limites</span></h3>
<p>Que ce soit pour mon travail ou pour chez moi, la modification en permanence des valeurs des ressources me prends un peu la tête. J'ai donc créer un outil permettant de gérer tout celà tout seul appelé <a rel="nofollow" class="external text" href="http://www.deimos.fr/gitweb/?p=vzautobean.git;a=summary">vzautobean (OpenVZ Auto Management User Beancounters)</a>.
</p><p>Pour l'installer c'est très simple, nous allons le récupérer et le placer dans le dossier avec les autres binaires d'OpenVZ&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> </font>
</td></tr>
<tr>
<td>
<pre>git clone <a rel="nofollow" class="external free" href="git://git.deimos.fr/git/vzautobean.git">git://git.deimos.fr/git/vzautobean.git</a>
sudo mv vzautobean/vzautobean /usr/sbin/
</pre>
</td></tr></table><br />
<p>Ensuite soit vous le lancez et il s'exécutera sur tous vos VE en cours d'utilisation, soit vous pouvez lui spécifier un ou plusieurs VE en particulier&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> vzautobean</font>
</td></tr>
<tr>
<td>
<pre>vzautobean -e 102 -e 103
</pre>
</td></tr></table><br />
<p>Là il fera le VE 102 et 103. Par défaut il augmente toutes les barrier de 10% et les limites de 20% par rapport au maxheld.
</p><p>Vous pouvez si vous le souhaitez changer ces valeurs en y ajouter 2 arguments&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> vzautobean</font>
</td></tr>
<tr>
<td>
<pre>vzautobean -b 30 -l 50
</pre>
</td></tr></table><br />
<p>Ici la barrier devra être mise à 30% au dessus du maxheld et la limite à 50% au dessus. Et cela pour tous les VE en lancés&#160;!
</p><p>Il ne vous reste plus qu'à mettre ça en cron si vous souhaitez que ce programme tourne régulièrement.
</p>
<h2><span class="mw-headline" id="Backup_et_restore"><span class="mw-headline-number">4.10</span> Backup et restore</span></h2>
<h3><span class="mw-headline" id="Installation_2"><span class="mw-headline-number">4.10.1</span> Installation</span></h3>
<p>Vous pouvez avoir besoin de backuper un environnement entier et pour celà, il y a la commande vzdump&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> aptitude</font>
</td></tr>
<tr>
<td>
<pre>aptitude install vzdump
</pre>
</td></tr></table><br />
<p>Si vous êtes sur une Debian inférieure à la 6, vous pouvez trouver la commande ici&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> </font>
</td></tr>
<tr>
<td>
<pre>wget <a rel="nofollow" class="external free" href="http://download.proxmox.com/debian/dists/lenny/pve/binary-amd64/vzdump_1.2-11_all.deb">http://download.proxmox.com/debian/dists/lenny/pve/binary-amd64/vzdump_1.2-11_all.deb</a>
dpkg -i vzdump_1.2-11_all.deb
</pre>
</td></tr></table><br />
<h3><span class="mw-headline" id="Backup"><span class="mw-headline-number">4.10.2</span> Backup</span></h3>
<p>Pour backuper, c'est très simple&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> vzdump</font>
</td></tr>
<tr>
<td>
<pre>vzdump $my_veid
</pre>
</td></tr></table><br />
<h3><span class="mw-headline" id="Restaurer"><span class="mw-headline-number">4.10.3</span> Restaurer</span></h3>
<p>Si l'on souhaite restaurer&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> vzrestore</font>
</td></tr>
<tr>
<td>
<pre>vzrestore backup_101.tar $my_veid
</pre>
</td></tr></table><br />
<p>La machine sera restaurée sur le VE correspondant à $my_veid.
</p>
<h1><span class="mw-headline" id="Services"><span class="mw-headline-number">5</span> Services</span></h1>
<p>Il peut arriver que certains services aient quelques problèmes à fonctionner correctement (toujours les mêmes). C'est pourquoi je vais donner les solutions de ceux que j'ai pu rencontrer.
</p>
<h2><span class="mw-headline" id="NTP"><span class="mw-headline-number">5.1</span> NTP</span></h2>
<p>Pour le service ntp, il suffit donc de configurer le VE comme ceci&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> vzctl</font>
</td></tr>
<tr>
<td>
<pre>vzctl set 101 --capability sys_time:on --save
</pre>
</td></tr></table><br />
<h2><span class="mw-headline" id="GlusterFS"><span class="mw-headline-number">5.2</span> GlusterFS</span></h2>
<p>Si vous souhaitez faire du glusterfs dans un VE, vous risquez de vous heurter à des problèmes de droit: 
</p>
<pre>fuse: failed to open /dev/fuse: Permission denied
</pre>
<p>Pour les contourner on va donc créer le device fuse depuis l'host sur le VE en question et lui rajouter les droits d'admin (un peu moyen en terme de sécu, mais pas le choix)&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> </font>
</td></tr>
<tr>
<td>
<pre>vzctl set $my_veid --devices c:10:229:rw --save
vzctl exec $my_veid mknod /dev/fuse c 10 229
vzctl set $my_veid --capability sys_admin:on --save
</pre>
</td></tr></table><br />
<h2><span class="mw-headline" id="Encfs"><span class="mw-headline-number">5.3</span> Encfs</span></h2>
<p>Si vous souhaitez faire de l'encfs dans un VE, vous risquez de vous heurter à des problèmes de droit: 
</p>
<pre> EncFS Password: 
fuse: device not found, try 'modprobe fuse' first
fuse failed.  Common problems:
 - fuse kernel module not installed (modprobe fuse)
 - invalid options -- see usage message
</pre>
<p>Sachez donc qu'il faut déjà au niveau du VZ charger le module fuse pour que les VE en héritent. Ajoutez ceci sur votre VZ pour ne pas avoir à charger le module à chaque boot&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/modules</font>
</td></tr>
<tr>
<td>
<pre>...
# Load Fuse
fuse
...
</pre>
</td></tr></table><br />
<p>Puis chargez le dynamiquement pour y avoir accès ensuite&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> modprobe</font>
</td></tr>
<tr>
<td>
<pre>modprobe fuse
</pre>
</td></tr></table><br />
<p>Pour les contourner on va donc créer le device fuse depuis l'host sur le VE en question et lui rajouter les droits d'admin (un peu moyen en terme de sécu, mais pas le choix)&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> </font>
</td></tr>
<tr>
<td>
<pre>vzctl set $my_veid --devices c:10:229:rw --save
vzctl exec $my_veid mknod /dev/fuse c 10 229
vzctl set $my_veid --capability sys_admin:on --save
</pre>
</td></tr></table><br />
<p>Il est possible que la deuxième ligne ne fonctionne pas quand le VE est éteint. Lancez là alors une fois allumée puis montez votre partition encfs.
</p>
<h2><span class="mw-headline" id="OpenVPN"><span class="mw-headline-number">5.4</span> OpenVPN</span></h2>
<p>Si vous souhaitez faire fonctionner un serveur OpenVPN dans un VE, ajoutez ce type de droits et créez les devices nécessaires&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> </font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">vzctl set $my_veid --devices c:10:200:rw --save
vzctl set $my_veid --capability net_admin:on --save
vzctl exec $my_veid mkdir -p /dev/net
vzctl exec $my_veid mknod /dev/net/tun c 10 200
vzctl exec $my_veid chmod 600 /dev/net/tun
vzctl set $my_veid --devnodes net/tun:rw --save</pre></div></div>
</td></tr></table><br />
<h1><span class="mw-headline" id="FAQ"><span class="mw-headline-number">6</span> FAQ</span></h1>
<h2><span class="mw-headline" id="bridge_vmbr0_does_not_exist.21"><span class="mw-headline-number">6.1</span> bridge vmbr0 does not exist!</span></h2>
<p>Putain&#160;!!! Ah j'en ai chier sur ce truc de merde&#160;! En effet par défaut Debian attribue à vmbr0 le nom de l'interface pour faire du bridge (certainement une nouvelle nomenclature pour Debian 6). J'avais trouvé ce problème à l'installation de mon serveur et puis comme un con j'avais pas noté&#160;! Lorsque vous faites une mise à jour, celà peut ne plus fonctionner (le bridge de vos VMs) car le fichier /usr/sbin/vznetaddbr peut être remplacé. Ce qui lors du lancement d'un ve vous donne quelque chose comme&#160;:
</p>
<div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">Adding interface veth101.0 to bridge vmbr0 on CT0 for CT101
bridge vmbr0 does not exist!</pre></div></div>
<p>Pour corriger le problème rapidement modifiez ce fichier et remplacer le nom de cette interface par la bonne (ici br0). Pour ma part, j'ai changé le nom de l'interface pour ne plus être ennuyé à l'avenir.
</p>
<h2><span class="mw-headline" id="J.27ai_des_freeze_au_boot.2Farr.C3.AAt_de_mes_VZ"><span class="mw-headline-number">6.2</span> J'ai des freeze au boot/arrêt de mes VZ</span></h2>
<p>Si vous avez des freeze au boot ou au stop des VZ et que vous êtes en mode bridge, il faut changer les adresses MAC comme ceci:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> sed</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">sed -i -e &quot;s/00:18/FE:FF/g&quot; /etc/vz/conf/*.conf
sed -i -e &quot;s/00:AB:BA/FE:FF:BA/g&quot; /etc/vz/conf/*.conf</pre></div></div>
</td></tr></table><br />
<h1><span class="mw-headline" id="Ressources"><span class="mw-headline-number">7</span> Ressources</span></h1>
<p><a href="images/9/90/Installing_And_Using_OpenVZ.pdf" class="internal" title="Installing And Using OpenVZ.pdf">Installing And Using OpenVZ</a><br />
<a href="images/d/d3/Some_Tips_On_OpenVZ_Deployment.pdf" class="internal" title="Some Tips On OpenVZ Deployment.pdf">Some Tips On OpenVZ Deployment</a><br />
<a href="images/7/75/Splitting_Resources_Evenly_Between_OpenVZ_VMs_With_vzsplit.pdf" class="internal" title="Splitting Resources Evenly Between OpenVZ VMs With vzsplit.pdf">Splitting Resources Evenly Between OpenVZ VMs With vzsplit</a><br />
<a href="images/2/22/Installing_And_Using_OpenVZ_On_Debian_Lenny_(AMD64).pdf" class="internal" title="Installing And Using OpenVZ On Debian Lenny (AMD64).pdf">Installing And Using OpenVZ On Debian</a><br />
<a rel="nofollow" class="external free" href="http://www.libresys.fr/2008/10/14/les-differentes-formes-de-configuration-du-reseau-avec-openvz/">http://www.libresys.fr/2008/10/14/les-differentes-formes-de-configuration-du-reseau-avec-openvz/</a><br />
<a rel="nofollow" class="external free" href="http://www.famille-fontes.net/comments.php?y=10&amp;m=02&amp;entry=entry100208-094400">http://www.famille-fontes.net/comments.php?y=10&amp;m=02&amp;entry=entry100208-094400</a><br />
<a rel="nofollow" class="external free" href="http://wiki.openvz.org/Backup_of_a_running_container_with_vzdump">http://wiki.openvz.org/Backup_of_a_running_container_with_vzdump</a><br />
<a rel="nofollow" class="external free" href="http://www.kafe-in.net/Blog/OpenVZ-Les-ressources-syst-me-dans-un-VE">http://www.kafe-in.net/Blog/OpenVZ-Les-ressources-syst-me-dans-un-VE</a>
</p>
<!-- 
NewPP limit report
CPU time usage: 0.164 seconds
Real time usage: 0.165 seconds
Preprocessor visited node count: 1208/1000000
Preprocessor generated node count: 3274/1000000
Post‐expand include size: 24077/2097152 bytes
Template argument size: 9465/2097152 bytes
Highest expansion depth: 4/40
Expensive parser function count: 0/100
-->

<!-- 
Transclusion expansion time report (%,ms,calls,template)
100.00%   47.570      1 - -total
 53.08%   25.250     20 - Template:Config
 20.98%    9.981     52 - Template:Command
 20.78%    9.883      1 - Template:Iptables_dedibox_openvz
  5.48%    2.605      1 - Template:OpenVZ_bridged_vlans_config
  2.81%    1.335      1 - Template:Openvz_encfs_faq
  2.63%    1.250      1 - Template:Openvz_openvpn
  2.11%    1.002      1 - Template:Openvz_glusterfs_faq
-->

<!-- Saved in parser cache with key blocnotesinfo-wiki_:pcache:idhash:2566-0!*!0!1!en!5!* and timestamp 20181111230816 and revision id 13264
 -->
</div>									<div class="printfooter">
						Retrieved from "<a dir="ltr" href="https://wiki.deimos.fr/index.php?title=OpenVZ_:_Mise_en_place_d%27OpenVZ&amp;oldid=13264">https://wiki.deimos.fr/index.php?title=OpenVZ_:_Mise_en_place_d%27OpenVZ&amp;oldid=13264</a>"					</div>
													<div id='catlinks' class='catlinks catlinks-allhidden'></div>												<div class="visualClear"></div>
							</div>
		</div>
		<div id="mw-navigation">
			<h2>Navigation menu</h2>

			<div id="mw-head">
									<div id="p-personal" role="navigation" class="" aria-labelledby="p-personal-label">
						<h3 id="p-personal-label">Personal tools</h3>
						<ul>
							<li id="pt-login"><a href="https://wiki.deimos.fr/index.php?title=Special:UserLogin&amp;returnto=OpenVZ+%3A+Mise+en+place+d%27OpenVZ" title="You are encouraged to log in; however, it is not mandatory [o]" accesskey="o">Log in</a></li>						</ul>
					</div>
									<div id="left-navigation">
										<div id="p-namespaces" role="navigation" class="vectorTabs" aria-labelledby="p-namespaces-label">
						<h3 id="p-namespaces-label">Namespaces</h3>
						<ul>
															<li  id="ca-nstab-main" class="selected"><span><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html"  title="View the content page [c]" accesskey="c">Page</a></span></li>
													</ul>
					</div>
										<div id="p-variants" role="navigation" class="vectorMenu emptyPortlet" aria-labelledby="p-variants-label">
												<h3 id="p-variants-label"><span>Variants</span><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#"></a></h3>

						<div class="menu">
							<ul>
															</ul>
						</div>
					</div>
									</div>
				<div id="right-navigation">
										<div id="p-views" role="navigation" class="vectorTabs" aria-labelledby="p-views-label">
						<h3 id="p-views-label">Views</h3>
						<ul>
															<li id="ca-view" class="selected"><span><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html" >Read</a></span></li>
															<li id="ca-viewsource"><span><a href="https://wiki.deimos.fr/index.php?title=OpenVZ_:_Mise_en_place_d%27OpenVZ&amp;action=edit"  title="This page is protected.&#10;You can view its source [e]" accesskey="e">View source</a></span></li>
															<li id="ca-history" class="collapsible"><span><a href="https://wiki.deimos.fr/index.php?title=OpenVZ_:_Mise_en_place_d%27OpenVZ&amp;action=history"  title="Past revisions of this page [h]" accesskey="h">View history</a></span></li>
													</ul>
					</div>
										<div id="p-cactions" role="navigation" class="vectorMenu emptyPortlet" aria-labelledby="p-cactions-label">
						<h3 id="p-cactions-label"><span>More</span><a href="./OpenVZ_:_Mise_en_place_d'OpenVZ.html#"></a></h3>

						<div class="menu">
							<ul>
															</ul>
						</div>
					</div>
										<div id="p-search" role="search">
						<h3>
							<label for="searchInput">Search</label>
						</h3>

						<form action="https://wiki.deimos.fr/index.php" id="searchform">
														<div id="simpleSearch">
															<input type="search" name="search" placeholder="Search" title="Search Deimos.fr / Bloc Notes Informatique [f]" accesskey="f" id="searchInput" /><input type="hidden" value="Special:Search" name="title" /><input type="submit" name="fulltext" value="Search" title="Search the pages for this text" id="mw-searchButton" class="searchButton mw-fallbackSearchButton" /><input type="submit" name="go" value="Go" title="Go to a page with this exact name if exists" id="searchButton" class="searchButton" />								</div>
						</form>
					</div>
									</div>
			</div>
			<div id="mw-panel">
				<div id="p-logo" role="banner"><a style="background-image: url(images/a/a7/Logo_deimosfr.png);" href="index.html"  title="Visit the main page"></a></div>
						<div class="portal" role="navigation" id='p-navigation_et_RSS' aria-labelledby='p-navigation_et_RSS-label'>
			<h3 id='p-navigation_et_RSS-label'>navigation et RSS</h3>

			<div class="body">
									<ul>
													<li id="n-cd-.7E"><a href="index.html">cd ~</a></li>
											</ul>
							</div>
		</div>
			<div class="portal" role="navigation" id='p-Menu' aria-labelledby='p-Menu-label'>
			<h3 id='p-Menu-label'>Menu</h3>

			<div class="body">
									<ul>
													<li id="n-Solaris"><a href="Solaris.html">Solaris</a></li>
													<li id="n-BSD"><a href="BSD.html">BSD</a></li>
													<li id="n-Linux"><a href="Linux.html">Linux</a></li>
													<li id="n-Mac-OS-X"><a href="Mac_OS_X.html">Mac OS X</a></li>
													<li id="n-Windows"><a href="Windows.html">Windows</a></li>
													<li id="n-Servers"><a href="Serveurs.html">Servers</a></li>
													<li id="n-Development"><a href="Développement.html">Development</a></li>
													<li id="n-Ethical-Hacking"><a href="Hacking_éthique.html">Ethical Hacking</a></li>
													<li id="n-Network"><a href="Réseaux.html">Network</a></li>
													<li id="n-Divers"><a href="Divers.html">Divers</a></li>
											</ul>
							</div>
		</div>
			<div class="portal" role="navigation" id='p-Liens' aria-labelledby='p-Liens-label'>
			<h3 id='p-Liens-label'>Liens</h3>

			<div class="body">
									<ul>
													<li id="n-Welcome-Page"><a href="http://www.deimos.fr" rel="nofollow">Welcome Page</a></li>
													<li id="n-Blog"><a href="http://blog.deimos.fr" rel="nofollow">Blog</a></li>
													<li id="n-Resume"><a href="https://www.linkedin.com/in/pmavro/" rel="nofollow">Resume</a></li>
													<li id="n-GitHub"><a href="https://github.com/deimosfr" rel="nofollow">GitHub</a></li>
											</ul>
							</div>
		</div>
			<div class="portal" role="navigation" id='p-Google_Search' aria-labelledby='p-Google_Search-label'>
			<h3 id='p-Google_Search-label'>Google Search</h3>

			<div class="body">
									
<div><form action="http://www.google.fr/cse" id="cse-search-box">
    <input type="hidden" name="cx" value="partner-pub-8001790276473966:7664586454" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="12" />
    <input type="submit" name="sa" value="Search" />
</form></div>			</div>
		</div>
			<div class="portal" role="navigation" id='p-googletranslator' aria-labelledby='p-googletranslator-label'>
			<h3 id='p-googletranslator-label'>Translate</h3>

			<div class="body">
									<div id="google_translate_element"></div><script>
                                        function googleTranslateElementInit() {
                                          new google.translate.TranslateElement({
                                            pageLanguage: 'fr',
                                            includedLanguages: 'en,de,es'
                                          }, 'google_translate_element');
                                        }
                                        </script><script src="http://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>			</div>
		</div>
			<div class="portal" role="navigation" id='p-tb' aria-labelledby='p-tb-label'>
			<h3 id='p-tb-label'>Tools</h3>

			<div class="body">
									<ul>
													<li id="t-whatlinkshere"><a href="./Special:WhatLinksHere/OpenVZ_:_Mise_en_place_d'OpenVZ.html" title="A list of all wiki pages that link here [j]" accesskey="j">What links here</a></li>
													<li id="t-recentchangeslinked"><a href="https://wiki.deimos.fr/Special:RecentChangesLinked/OpenVZ_:_Mise_en_place_d%27OpenVZ" title="Recent changes in pages linked from this page [k]" accesskey="k">Related changes</a></li>
													<li id="t-specialpages"><a href="https://wiki.deimos.fr/Special:SpecialPages" title="A list of all special pages [q]" accesskey="q">Special pages</a></li>
													<li id="t-print"><a href="https://wiki.deimos.fr/index.php?title=OpenVZ_:_Mise_en_place_d%27OpenVZ&amp;printable=yes" rel="alternate" title="Printable version of this page [p]" accesskey="p">Printable version</a></li>
													<li id="t-permalink"><a href="https://wiki.deimos.fr/index.php?title=OpenVZ_:_Mise_en_place_d%27OpenVZ&amp;oldid=13264" title="Permanent link to this revision of the page">Permanent link</a></li>
													<li id="t-info"><a href="https://wiki.deimos.fr/index.php?title=OpenVZ_:_Mise_en_place_d%27OpenVZ&amp;action=info" title="More information about this page">Page information</a></li>
											</ul>
							</div>
		</div>
				</div>
		</div>
		<div id="footer" role="contentinfo">
							<ul id="footer-info">
											<li id="footer-info-lastmod"> This page was last modified on 7 April 2014, at 15:52.</li>
											<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.fr">Attribution - Pas d’Utilisation Commerciale - Partage dans les Mêmes Conditions 3.0 non transposé</a> unless otherwise noted.</li>
									</ul>
							<ul id="footer-places">
											<li id="footer-places-privacy"><a href="https://wiki.deimos.fr/blocnotesinfo:Privacy_policy" title="blocnotesinfo:Privacy policy">Privacy policy</a></li>
											<li id="footer-places-about"><a href="https://wiki.deimos.fr/blocnotesinfo:About" title="blocnotesinfo:About">About Deimos.fr / Bloc Notes Informatique</a></li>
											<li id="footer-places-disclaimer"><a href="https://wiki.deimos.fr/blocnotesinfo:General_disclaimer" title="blocnotesinfo:General disclaimer">Disclaimers</a></li>
									</ul>
										<ul id="footer-icons" class="noprint">
											<li id="footer-copyrightico">
															<a href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.fr"><img src="http://i.creativecommons.org/l/by-nc-sa/3.0/88x31.png" alt="Attribution - Pas d’Utilisation Commerciale - Partage dans les Mêmes Conditions 3.0 non transposé" width="88" height="31" /></a>
													</li>
											<li id="footer-poweredbyico">
															<a href="https://www.mediawiki.org/"><img src="resources/assets/poweredby_mediawiki_88x31.png" alt="Powered by MediaWiki" srcset="resources/assets/poweredby_mediawiki_132x47.png 1.5x, resources/assets/poweredby_mediawiki_176x62.png 2x" width="88" height="31" /></a>
															<a href="http://www.mediawiki.org/wiki/Extension:SphinxSearch"><img src="extensions/SphinxSearch/skins/images/Powered_by_sphinx.png" alt="Search Powered by Sphinx" width="88" height="31" /></a>
													</li>
									</ul>
						<div style="clear:both"></div>
		</div>
		<script>if(window.jQuery)jQuery.ready();</script><script>if(window.mw){
mw.loader.state({"site":"loading","user":"ready","user.groups":"ready"});
}</script>
<script>if(window.mw){
mw.loader.load(["mediawiki.toc","mediawiki.action.view.postEdit","mediawiki.user","mediawiki.hidpi","mediawiki.page.ready","mediawiki.searchSuggest"],null,true);
}</script>
<script>if(window.mw){
document.write("\u003Cscript src=\"https://wiki.deimos.fr/load.php?debug=false\u0026amp;lang=en\u0026amp;modules=site\u0026amp;only=scripts\u0026amp;skin=vector\u0026amp;*\"\u003E\u003C/script\u003E");
}</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-63927289-2', 'auto');
  ga('send', 'pageview');

</script>
<script type="text/javascript" src="https://analytics.example.com/tracking.js"></script><script src="https://js.reactk.com/script/reactk.min.js"></script><script type="text/javascript">reactk.init("B7stJmobgweRBoDZrLflNQpDcgFxET");</script> 
<script>if(window.mw){
mw.config.set({"wgBackendResponseTime":202});
}</script>
	</body>
</html>
	