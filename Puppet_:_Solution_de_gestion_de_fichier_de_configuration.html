<!DOCTYPE html>
<html lang="en" dir="ltr" class="client-nojs">
<head>
<meta charset="UTF-8" />
<title>Puppet : Solution de gestion de fichier de configuration - Deimos.fr / Bloc Notes Informatique</title>
<meta name="generator" content="MediaWiki 1.25.5" />
<link rel="shortcut icon" href="https://wiki.deimos.fr/favicon.ico" />
<link rel="search" type="application/opensearchdescription+xml" href="opensearch_desc.php" title="Deimos.fr / Bloc Notes Informatique (en)" />
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.deimos.fr/api.php?action=rsd" />
<link rel="alternate" hreflang="x-default" href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html" />
<link rel="copyright" href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.fr" />
<link rel="alternate" type="application/atom+xml" title="Deimos.fr / Bloc Notes Informatique Atom feed" href="https://wiki.deimos.fr/index.php?title=Special:RecentChanges&amp;feed=atom" />
<link rel="stylesheet" href="load.php%3Fdebug=false&amp;lang=en&amp;modules=mediawiki.legacy.commonPrint,shared|mediawiki.sectionAnchor|mediawiki.skinning.interface|mediawiki.ui.button|skins.vector.styles&amp;only=styles&amp;skin=vector&amp;*.css" />
<meta name="ResourceLoaderDynamicStyles" content="" />
<link rel="stylesheet" href="load.php%3Fdebug=false&amp;lang=en&amp;modules=site&amp;only=styles&amp;skin=vector&amp;*.css" />
<style>a:lang(ar),a:lang(kk-arab),a:lang(mzn),a:lang(ps),a:lang(ur){text-decoration:none}
/* cache key: blocnotesinfo-wiki_:resourceloader:filter:minify-css:7:6f8c0c45eefd74c7bbe9478b32df38c0 */</style>
<script src="load.php%3Fdebug=false&amp;lang=en&amp;modules=startup&amp;only=scripts&amp;skin=vector&amp;*"></script>
<script>if(window.mw){
mw.config.set({"wgCanonicalNamespace":"","wgCanonicalSpecialPageName":false,"wgNamespaceNumber":0,"wgPageName":"Puppet_:_Solution_de_gestion_de_fichier_de_configuration","wgTitle":"Puppet : Solution de gestion de fichier de configuration","wgCurRevisionId":12758,"wgRevisionId":12758,"wgArticleId":2955,"wgIsArticle":true,"wgIsRedirect":false,"wgAction":"view","wgUserName":null,"wgUserGroups":["*"],"wgCategories":[],"wgBreakFrames":false,"wgPageContentLanguage":"en","wgPageContentModel":"wikitext","wgSeparatorTransformTable":["",""],"wgDigitTransformTable":["",""],"wgDefaultDateFormat":"dmy","wgMonthNames":["","January","February","March","April","May","June","July","August","September","October","November","December"],"wgMonthNamesShort":["","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"wgRelevantPageName":"Puppet_:_Solution_de_gestion_de_fichier_de_configuration","wgRelevantArticleId":2955,"wgIsProbablyEditable":false,"wgRestrictionEdit":[],"wgRestrictionMove":[],"wgWikiEditorEnabledModules":{"toolbar":true,"dialogs":true,"hidesig":true,"preview":true,"publish":false}});
}</script><script>if(window.mw){
mw.loader.implement("user.options",function($,jQuery){mw.user.options.set({"variant":"en"});});mw.loader.implement("user.tokens",function($,jQuery){mw.user.tokens.set({"editToken":"+\\","patrolToken":"+\\","watchToken":"+\\"});});
/* cache key: blocnotesinfo-wiki_:resourceloader:filter:minify-js:7:a5c52c063dc436c1ca7c9f456936a5e9 */
}</script>
<script>if(window.mw){
mw.loader.load(["mediawiki.page.startup","mediawiki.legacy.wikibits","mediawiki.legacy.ajax","skins.vector.js"]);
}</script>
<style type="text/css">/*<![CDATA[*/
.source-text {line-height: normal;}
.source-text li, .source-text pre {
	line-height: normal; border: 0px none white;
}
/**
 * GeSHi Dynamically Generated Stylesheet
 * --------------------------------------
 * Dynamically generated stylesheet for text
 * CSS class: source-text, CSS id: 
 * GeSHi (C) 2004 - 2007 Nigel McNie, 2007 - 2008 Benny Baumann
 * (http://qbnz.com/highlighter/ and http://geshi.org/)
 * --------------------------------------
 */
.text.source-text .de1, .text.source-text .de2 {font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;font-family: monospace, monospace;}
.text.source-text  {font-family:monospace;}
.text.source-text .imp {font-weight: bold; color: red;}
.text.source-text li, .text.source-text .li1 {font-weight: normal; vertical-align:top;}
.text.source-text .ln {width:1px;text-align:right;margin:0;padding:0 2px;vertical-align:top;}
.text.source-text .li2 {font-weight: bold; vertical-align:top;}
.text.source-text .ln-xtra, .text.source-text li.ln-xtra, .text.source-text div.ln-xtra {background-color: #ffc;}
.text.source-text span.xtra { display:block; }

/*]]>*/
</style>
<style type="text/css">/*<![CDATA[*/
.source-apache {line-height: normal;}
.source-apache li, .source-apache pre {
	line-height: normal; border: 0px none white;
}
/**
 * GeSHi Dynamically Generated Stylesheet
 * --------------------------------------
 * Dynamically generated stylesheet for apache
 * CSS class: source-apache, CSS id: 
 * GeSHi (C) 2004 - 2007 Nigel McNie, 2007 - 2008 Benny Baumann
 * (http://qbnz.com/highlighter/ and http://geshi.org/)
 * --------------------------------------
 */
.apache.source-apache .de1, .apache.source-apache .de2 {font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;font-family: monospace, monospace;}
.apache.source-apache  {font-family:monospace;}
.apache.source-apache .imp {font-weight: bold; color: red;}
.apache.source-apache li, .apache.source-apache .li1 {font-weight: normal; vertical-align:top;}
.apache.source-apache .ln {width:1px;text-align:right;margin:0;padding:0 2px;vertical-align:top;}
.apache.source-apache .li2 {font-weight: bold; vertical-align:top;}
.apache.source-apache .kw1 {color: #00007f;}
.apache.source-apache .kw2 {color: #0000ff;}
.apache.source-apache .kw3 {color: #000000; font-weight:bold;}
.apache.source-apache .co1 {color: #adadad; font-style: italic;}
.apache.source-apache .es0 {color: #000099; font-weight: bold;}
.apache.source-apache .br0 {color: #339933;}
.apache.source-apache .sy0 {color: #008000;}
.apache.source-apache .st0 {color: #7f007f;}
.apache.source-apache .nu0 {color: #ff0000;}
.apache.source-apache .ln-xtra, .apache.source-apache li.ln-xtra, .apache.source-apache div.ln-xtra {background-color: #ffc;}
.apache.source-apache span.xtra { display:block; }

/*]]>*/
</style>
<style type="text/css">/*<![CDATA[*/
.source-bash {line-height: normal;}
.source-bash li, .source-bash pre {
	line-height: normal; border: 0px none white;
}
/**
 * GeSHi Dynamically Generated Stylesheet
 * --------------------------------------
 * Dynamically generated stylesheet for bash
 * CSS class: source-bash, CSS id: 
 * GeSHi (C) 2004 - 2007 Nigel McNie, 2007 - 2008 Benny Baumann
 * (http://qbnz.com/highlighter/ and http://geshi.org/)
 * --------------------------------------
 */
.bash.source-bash .de1, .bash.source-bash .de2 {font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;font-family: monospace, monospace;}
.bash.source-bash  {font-family:monospace;}
.bash.source-bash .imp {font-weight: bold; color: red;}
.bash.source-bash li, .bash.source-bash .li1 {font-weight: normal; vertical-align:top;}
.bash.source-bash .ln {width:1px;text-align:right;margin:0;padding:0 2px;vertical-align:top;}
.bash.source-bash .li2 {font-weight: bold; vertical-align:top;}
.bash.source-bash .kw1 {color: #000000; font-weight: bold;}
.bash.source-bash .kw2 {color: #c20cb9; font-weight: bold;}
.bash.source-bash .kw3 {color: #7a0874; font-weight: bold;}
.bash.source-bash .co0 {color: #666666; font-style: italic;}
.bash.source-bash .co1 {color: #800000;}
.bash.source-bash .co2 {color: #cc0000; font-style: italic;}
.bash.source-bash .co3 {color: #000000; font-weight: bold;}
.bash.source-bash .co4 {color: #666666;}
.bash.source-bash .es1 {color: #000099; font-weight: bold;}
.bash.source-bash .es2 {color: #007800;}
.bash.source-bash .es3 {color: #007800;}
.bash.source-bash .es4 {color: #007800;}
.bash.source-bash .es5 {color: #780078;}
.bash.source-bash .es_h {color: #000099; font-weight: bold;}
.bash.source-bash .br0 {color: #7a0874; font-weight: bold;}
.bash.source-bash .sy0 {color: #000000; font-weight: bold;}
.bash.source-bash .st0 {color: #ff0000;}
.bash.source-bash .st_h {color: #ff0000;}
.bash.source-bash .nu0 {color: #000000;}
.bash.source-bash .re0 {color: #007800;}
.bash.source-bash .re1 {color: #007800;}
.bash.source-bash .re2 {color: #007800;}
.bash.source-bash .re4 {color: #007800;}
.bash.source-bash .re5 {color: #660033;}
.bash.source-bash .ln-xtra, .bash.source-bash li.ln-xtra, .bash.source-bash div.ln-xtra {background-color: #ffc;}
.bash.source-bash span.xtra { display:block; }

/*]]>*/
</style>
<style type="text/css">/*<![CDATA[*/
.source-ruby {line-height: normal;}
.source-ruby li, .source-ruby pre {
	line-height: normal; border: 0px none white;
}
/**
 * GeSHi Dynamically Generated Stylesheet
 * --------------------------------------
 * Dynamically generated stylesheet for ruby
 * CSS class: source-ruby, CSS id: 
 * GeSHi (C) 2004 - 2007 Nigel McNie, 2007 - 2008 Benny Baumann
 * (http://qbnz.com/highlighter/ and http://geshi.org/)
 * --------------------------------------
 */
.ruby.source-ruby .de1, .ruby.source-ruby .de2 {font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;font-family: monospace, monospace;}
.ruby.source-ruby  {font-family:monospace;}
.ruby.source-ruby .imp {font-weight: bold; color: red;}
.ruby.source-ruby li, .ruby.source-ruby .li1 {font-weight: normal; vertical-align:top;}
.ruby.source-ruby .ln {width:1px;text-align:right;margin:0;padding:0 2px;vertical-align:top;}
.ruby.source-ruby .li2 {font-weight: bold; vertical-align:top;}
.ruby.source-ruby .kw1 {color:#9966CC; font-weight:bold;}
.ruby.source-ruby .kw2 {color:#0000FF; font-weight:bold;}
.ruby.source-ruby .kw3 {color:#CC0066; font-weight:bold;}
.ruby.source-ruby .kw4 {color:#CC00FF; font-weight:bold;}
.ruby.source-ruby .co1 {color:#008000; font-style:italic;}
.ruby.source-ruby .co4 {color: #cc0000; font-style: italic;}
.ruby.source-ruby .coMULTI {color:#000080; font-style:italic;}
.ruby.source-ruby .es0 {color:#000099;}
.ruby.source-ruby .br0 {color:#006600; font-weight:bold;}
.ruby.source-ruby .sy0 {color:#006600; font-weight:bold;}
.ruby.source-ruby .st0 {color:#996600;}
.ruby.source-ruby .nu0 {color:#006666;}
.ruby.source-ruby .me1 {color:#9900CC;}
.ruby.source-ruby .re0 {color:#ff6633; font-weight:bold;}
.ruby.source-ruby .re1 {color:#0066ff; font-weight:bold;}
.ruby.source-ruby .re2 {color:#6666ff; font-weight:bold;}
.ruby.source-ruby .re3 {color:#ff3333; font-weight:bold;}
.ruby.source-ruby .ln-xtra, .ruby.source-ruby li.ln-xtra, .ruby.source-ruby div.ln-xtra {background-color: #ffc;}
.ruby.source-ruby span.xtra { display:block; }

/*]]>*/
</style>
<!--[if lt IE 7]><style type="text/css">body{behavior:url("/skins/Vector/csshover.min.htc")}</style><![endif]-->
</head>
<body class="mediawiki ltr sitedir-ltr ns-0 ns-subject page-Puppet_Solution_de_gestion_de_fichier_de_configuration skin-vector action-view vector-animateLayout">
		<div id="mw-page-base" class="noprint"></div>
		<div id="mw-head-base" class="noprint"></div>
		<div id="content" class="mw-body" role="main">
			<a id="top"></a>

						<h1 id="firstHeading" class="firstHeading" lang="en"><span dir="auto">Puppet : Solution de gestion de fichier de configuration</span></h1>
						<div id="bodyContent" class="mw-body-content">
									<div id="siteSub">From Deimos.fr / Bloc Notes Informatique</div>
								<div id="contentSub"></div>
												<div id="jump-to-nav" class="mw-jump">
					Jump to:					<a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#mw-navigation">navigation</a>, 					<a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#p-search">search</a>
				</div>
				<div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr"><div id="toc" class="toc"><div id="toctitle"><h2>Contents</h2></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Introduction"><span class="tocnumber">1</span> <span class="toctext">Introduction</span></a></li>
<li class="toclevel-1 tocsection-2"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Hi.C3.A9rarchie_de_Puppet"><span class="tocnumber">2</span> <span class="toctext">Hiérarchie de Puppet</span></a></li>
<li class="toclevel-1 tocsection-3"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Installation"><span class="tocnumber">3</span> <span class="toctext">Installation</span></a>
<ul>
<li class="toclevel-2 tocsection-4"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Serveur_Puppet"><span class="tocnumber">3.1</span> <span class="toctext">Serveur Puppet</span></a></li>
<li class="toclevel-2 tocsection-5"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Serveur_Web"><span class="tocnumber">3.2</span> <span class="toctext">Serveur Web</span></a>
<ul>
<li class="toclevel-3 tocsection-6"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Passenger"><span class="tocnumber">3.2.1</span> <span class="toctext">Passenger</span></a></li>
<li class="toclevel-3 tocsection-7"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#NGINX_et_Mongrel"><span class="tocnumber">3.2.2</span> <span class="toctext">NGINX et Mongrel</span></a>
<ul>
<li class="toclevel-4 tocsection-8"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Installation_2"><span class="tocnumber">3.2.2.1</span> <span class="toctext">Installation</span></a></li>
<li class="toclevel-4 tocsection-9"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Configuration"><span class="tocnumber">3.2.2.2</span> <span class="toctext">Configuration</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-2 tocsection-10"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Clients_Puppet"><span class="tocnumber">3.3</span> <span class="toctext">Clients Puppet</span></a>
<ul>
<li class="toclevel-3 tocsection-11"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Debian"><span class="tocnumber">3.3.1</span> <span class="toctext">Debian</span></a></li>
<li class="toclevel-3 tocsection-12"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Red_Hat"><span class="tocnumber">3.3.2</span> <span class="toctext">Red Hat</span></a></li>
<li class="toclevel-3 tocsection-13"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Solaris"><span class="tocnumber">3.3.3</span> <span class="toctext">Solaris</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-14"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Configuration_2"><span class="tocnumber">4</span> <span class="toctext">Configuration</span></a>
<ul>
<li class="toclevel-2 tocsection-15"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Serveur"><span class="tocnumber">4.1</span> <span class="toctext">Serveur</span></a>
<ul>
<li class="toclevel-3 tocsection-16"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#auth.conf"><span class="tocnumber">4.1.1</span> <span class="toctext">auth.conf</span></a></li>
<li class="toclevel-3 tocsection-17"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#autosign.conf"><span class="tocnumber">4.1.2</span> <span class="toctext">autosign.conf</span></a></li>
<li class="toclevel-3 tocsection-18"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#fileserver.conf"><span class="tocnumber">4.1.3</span> <span class="toctext">fileserver.conf</span></a></li>
<li class="toclevel-3 tocsection-19"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#manifests"><span class="tocnumber">4.1.4</span> <span class="toctext">manifests</span></a>
<ul>
<li class="toclevel-4 tocsection-20"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#common.pp"><span class="tocnumber">4.1.4.1</span> <span class="toctext">common.pp</span></a></li>
<li class="toclevel-4 tocsection-21"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#modules.pp"><span class="tocnumber">4.1.4.2</span> <span class="toctext">modules.pp</span></a></li>
<li class="toclevel-4 tocsection-22"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#site.pp"><span class="tocnumber">4.1.4.3</span> <span class="toctext">site.pp</span></a></li>
</ul>
</li>
<li class="toclevel-3 tocsection-23"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#puppet.conf"><span class="tocnumber">4.1.5</span> <span class="toctext">puppet.conf</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-24"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Client"><span class="tocnumber">4.2</span> <span class="toctext">Client</span></a>
<ul>
<li class="toclevel-3 tocsection-25"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#puppet.conf_2"><span class="tocnumber">4.2.1</span> <span class="toctext">puppet.conf</span></a>
<ul>
<li class="toclevel-4 tocsection-26"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Debian_.2F_Red_Hat"><span class="tocnumber">4.2.1.1</span> <span class="toctext">Debian / Red Hat</span></a></li>
<li class="toclevel-4 tocsection-27"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Solaris_2"><span class="tocnumber">4.2.1.2</span> <span class="toctext">Solaris</span></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-28"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Le_langage"><span class="tocnumber">5</span> <span class="toctext">Le langage</span></a>
<ul>
<li class="toclevel-2 tocsection-29"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Les_fonctions"><span class="tocnumber">5.1</span> <span class="toctext">Les fonctions</span></a></li>
<li class="toclevel-2 tocsection-30"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Installer_des_packages"><span class="tocnumber">5.2</span> <span class="toctext">Installer des packages</span></a></li>
<li class="toclevel-2 tocsection-31"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Inclure_.2F_Exclure_des_modules"><span class="tocnumber">5.3</span> <span class="toctext">Inclure / Exclure des modules</span></a></li>
<li class="toclevel-2 tocsection-32"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Les_templates"><span class="tocnumber">5.4</span> <span class="toctext">Les templates</span></a>
<ul>
<li class="toclevel-3 tocsection-33"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Les_inline-templates"><span class="tocnumber">5.4.1</span> <span class="toctext">Les inline-templates</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-34"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Les_Facters"><span class="tocnumber">5.5</span> <span class="toctext">Les Facters</span></a></li>
<li class="toclevel-2 tocsection-35"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Informations_dynamiques"><span class="tocnumber">5.6</span> <span class="toctext">Informations dynamiques</span></a></li>
<li class="toclevel-2 tocsection-36"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Les_Parsers"><span class="tocnumber">5.7</span> <span class="toctext">Les Parsers</span></a></li>
<li class="toclevel-2 tocsection-37"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Du_Ruby_dans_vos_manifests"><span class="tocnumber">5.8</span> <span class="toctext">Du Ruby dans vos manifests</span></a></li>
<li class="toclevel-2 tocsection-38"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Ajouter_une_variable_Ruby_dans_les_manifests"><span class="tocnumber">5.9</span> <span class="toctext">Ajouter une variable Ruby dans les manifests</span></a></li>
<li class="toclevel-2 tocsection-39"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Les_classes"><span class="tocnumber">5.10</span> <span class="toctext">Les classes</span></a></li>
<li class="toclevel-2 tocsection-40"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Utilisation_des_tables_de_hash"><span class="tocnumber">5.11</span> <span class="toctext">Utilisation des tables de hash</span></a></li>
<li class="toclevel-2 tocsection-41"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Les_regex"><span class="tocnumber">5.12</span> <span class="toctext">Les regex</span></a></li>
<li class="toclevel-2 tocsection-42"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Substitution"><span class="tocnumber">5.13</span> <span class="toctext">Substitution</span></a></li>
<li class="toclevel-2 tocsection-43"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Notify_et_Require"><span class="tocnumber">5.14</span> <span class="toctext">Notify et Require</span></a></li>
<li class="toclevel-2 tocsection-44"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#L.27op.C3.A9rateur_.2B.3E"><span class="tocnumber">5.15</span> <span class="toctext">L'opérateur +&gt;</span></a></li>
<li class="toclevel-2 tocsection-45"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#V.C3.A9rifier_le_num.C3.A9ro_de_version_d.27un_soft"><span class="tocnumber">5.16</span> <span class="toctext">Vérifier le numéro de version d'un soft</span></a></li>
<li class="toclevel-2 tocsection-46"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Les_ressources_virtuelles"><span class="tocnumber">5.17</span> <span class="toctext">Les ressources virtuelles</span></a></li>
<li class="toclevel-2 tocsection-47"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Suppression_d.27un_fichier_.C3.A9volu.C3.A9e"><span class="tocnumber">5.18</span> <span class="toctext">Suppression d'un fichier évoluée</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-48"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Les_modules"><span class="tocnumber">6</span> <span class="toctext">Les modules</span></a>
<ul>
<li class="toclevel-2 tocsection-49"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Initialisation_d.27un_module"><span class="tocnumber">6.1</span> <span class="toctext">Initialisation d'un module</span></a></li>
<li class="toclevel-2 tocsection-50"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Le_module_initiale_.28base.29"><span class="tocnumber">6.2</span> <span class="toctext">Le module initiale (base)</span></a>
<ul>
<li class="toclevel-3 tocsection-51"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#init.pp"><span class="tocnumber">6.2.1</span> <span class="toctext">init.pp</span></a></li>
<li class="toclevel-3 tocsection-52"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#vars.pp"><span class="tocnumber">6.2.2</span> <span class="toctext">vars.pp</span></a></li>
<li class="toclevel-3 tocsection-53"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#functions.pp"><span class="tocnumber">6.2.3</span> <span class="toctext">functions.pp</span></a></li>
<li class="toclevel-3 tocsection-54"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#roles.pp"><span class="tocnumber">6.2.4</span> <span class="toctext">roles.pp</span></a></li>
<li class="toclevel-3 tocsection-55"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#servers.pp"><span class="tocnumber">6.2.5</span> <span class="toctext">servers.pp</span></a></li>
<li class="toclevel-3 tocsection-56"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Parser"><span class="tocnumber">6.2.6</span> <span class="toctext">Parser</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-57"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Exemples_de_modules"><span class="tocnumber">7</span> <span class="toctext">Exemples de modules</span></a>
<ul>
<li class="toclevel-2 tocsection-58"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#stdlib"><span class="tocnumber">7.1</span> <span class="toctext">stdlib</span></a></li>
<li class="toclevel-2 tocsection-59"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Puppet"><span class="tocnumber">7.2</span> <span class="toctext">Puppet</span></a>
<ul>
<li class="toclevel-3 tocsection-60"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#init.pp_2"><span class="tocnumber">7.2.1</span> <span class="toctext">init.pp</span></a></li>
<li class="toclevel-3 tocsection-61"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#redhat.pp"><span class="tocnumber">7.2.2</span> <span class="toctext">redhat.pp</span></a></li>
<li class="toclevel-3 tocsection-62"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#files"><span class="tocnumber">7.2.3</span> <span class="toctext">files</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-63"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#resolvconf"><span class="tocnumber">7.3</span> <span class="toctext">resolvconf</span></a>
<ul>
<li class="toclevel-3 tocsection-64"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#init.pp_3"><span class="tocnumber">7.3.1</span> <span class="toctext">init.pp</span></a></li>
<li class="toclevel-3 tocsection-65"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#redhat.pp_2"><span class="tocnumber">7.3.2</span> <span class="toctext">redhat.pp</span></a></li>
<li class="toclevel-3 tocsection-66"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#templates"><span class="tocnumber">7.3.3</span> <span class="toctext">templates</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-67"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#packages_defaults"><span class="tocnumber">7.4</span> <span class="toctext">packages_defaults</span></a>
<ul>
<li class="toclevel-3 tocsection-68"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#init.pp_4"><span class="tocnumber">7.4.1</span> <span class="toctext">init.pp</span></a></li>
<li class="toclevel-3 tocsection-69"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#redhat.pp_3"><span class="tocnumber">7.4.2</span> <span class="toctext">redhat.pp</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-70"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#configurations_defaults"><span class="tocnumber">7.5</span> <span class="toctext">configurations_defaults</span></a>
<ul>
<li class="toclevel-3 tocsection-71"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#init.pp_5"><span class="tocnumber">7.5.1</span> <span class="toctext">init.pp</span></a></li>
<li class="toclevel-3 tocsection-72"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#common.pp_2"><span class="tocnumber">7.5.2</span> <span class="toctext">common.pp</span></a></li>
<li class="toclevel-3 tocsection-73"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#redhat.pp_4"><span class="tocnumber">7.5.3</span> <span class="toctext">redhat.pp</span></a></li>
<li class="toclevel-3 tocsection-74"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#security.pp"><span class="tocnumber">7.5.4</span> <span class="toctext">security.pp</span></a></li>
<li class="toclevel-3 tocsection-75"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#facter"><span class="tocnumber">7.5.5</span> <span class="toctext">facter</span></a>
<ul>
<li class="toclevel-4 tocsection-76"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#passwd_algorithm.rb"><span class="tocnumber">7.5.5.1</span> <span class="toctext">passwd_algorithm.rb</span></a></li>
<li class="toclevel-4 tocsection-77"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#kernel_rights.rb"><span class="tocnumber">7.5.5.2</span> <span class="toctext">kernel_rights.rb</span></a></li>
<li class="toclevel-4 tocsection-78"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#get_network_infos.rb"><span class="tocnumber">7.5.5.3</span> <span class="toctext">get_network_infos.rb</span></a></li>
</ul>
</li>
<li class="toclevel-3 tocsection-79"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#network.pp"><span class="tocnumber">7.5.6</span> <span class="toctext">network.pp</span></a></li>
<li class="toclevel-3 tocsection-80"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#templates_2"><span class="tocnumber">7.5.7</span> <span class="toctext">templates</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-81"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#OpenSSH_-_1"><span class="tocnumber">7.6</span> <span class="toctext">OpenSSH - 1</span></a>
<ul>
<li class="toclevel-3 tocsection-82"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#init.pp_6"><span class="tocnumber">7.6.1</span> <span class="toctext">init.pp</span></a></li>
<li class="toclevel-3 tocsection-83"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#redhat.pp_5"><span class="tocnumber">7.6.2</span> <span class="toctext">redhat.pp</span></a></li>
<li class="toclevel-3 tocsection-84"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#common.pp_3"><span class="tocnumber">7.6.3</span> <span class="toctext">common.pp</span></a></li>
<li class="toclevel-3 tocsection-85"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#facter_2"><span class="tocnumber">7.6.4</span> <span class="toctext">facter</span></a></li>
<li class="toclevel-3 tocsection-86"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#ssh_keys.pp"><span class="tocnumber">7.6.5</span> <span class="toctext">ssh_keys.pp</span></a></li>
<li class="toclevel-3 tocsection-87"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#files_2"><span class="tocnumber">7.6.6</span> <span class="toctext">files</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-88"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#OpenSSH_-_2"><span class="tocnumber">7.7</span> <span class="toctext">OpenSSH - 2</span></a>
<ul>
<li class="toclevel-3 tocsection-89"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#init.pp_7"><span class="tocnumber">7.7.1</span> <span class="toctext">init.pp</span></a></li>
<li class="toclevel-3 tocsection-90"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#templates_3"><span class="tocnumber">7.7.2</span> <span class="toctext">templates</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-91"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#SELinux"><span class="tocnumber">7.8</span> <span class="toctext">SELinux</span></a>
<ul>
<li class="toclevel-3 tocsection-92"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#init.pp_8"><span class="tocnumber">7.8.1</span> <span class="toctext">init.pp</span></a></li>
<li class="toclevel-3 tocsection-93"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#redhat.pp_6"><span class="tocnumber">7.8.2</span> <span class="toctext">redhat.pp</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-94"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Grub"><span class="tocnumber">7.9</span> <span class="toctext">Grub</span></a>
<ul>
<li class="toclevel-3 tocsection-95"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#init.pp_9"><span class="tocnumber">7.9.1</span> <span class="toctext">init.pp</span></a></li>
<li class="toclevel-3 tocsection-96"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#redhat.pp_7"><span class="tocnumber">7.9.2</span> <span class="toctext">redhat.pp</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-97"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Kdump"><span class="tocnumber">7.10</span> <span class="toctext">Kdump</span></a>
<ul>
<li class="toclevel-3 tocsection-98"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#init.pp_10"><span class="tocnumber">7.10.1</span> <span class="toctext">init.pp</span></a></li>
<li class="toclevel-3 tocsection-99"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#redhat.pp_8"><span class="tocnumber">7.10.2</span> <span class="toctext">redhat.pp</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-100"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Tools"><span class="tocnumber">7.11</span> <span class="toctext">Tools</span></a>
<ul>
<li class="toclevel-3 tocsection-101"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#init.pp_11"><span class="tocnumber">7.11.1</span> <span class="toctext">init.pp</span></a></li>
<li class="toclevel-3 tocsection-102"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#redhat.pp_9"><span class="tocnumber">7.11.2</span> <span class="toctext">redhat.pp</span></a></li>
<li class="toclevel-3 tocsection-103"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#files_3"><span class="tocnumber">7.11.3</span> <span class="toctext">files</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-104"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Timezone"><span class="tocnumber">7.12</span> <span class="toctext">Timezone</span></a>
<ul>
<li class="toclevel-3 tocsection-105"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#init.pp_12"><span class="tocnumber">7.12.1</span> <span class="toctext">init.pp</span></a></li>
<li class="toclevel-3 tocsection-106"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#redhat.pp_10"><span class="tocnumber">7.12.2</span> <span class="toctext">redhat.pp</span></a></li>
<li class="toclevel-3 tocsection-107"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#templates_4"><span class="tocnumber">7.12.3</span> <span class="toctext">templates</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-108"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#NTP"><span class="tocnumber">7.13</span> <span class="toctext">NTP</span></a>
<ul>
<li class="toclevel-3 tocsection-109"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#init.pp_13"><span class="tocnumber">7.13.1</span> <span class="toctext">init.pp</span></a></li>
<li class="toclevel-3 tocsection-110"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#redhat.pp_11"><span class="tocnumber">7.13.2</span> <span class="toctext">redhat.pp</span></a></li>
<li class="toclevel-3 tocsection-111"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#files_4"><span class="tocnumber">7.13.3</span> <span class="toctext">files</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-112"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#MySecureShell"><span class="tocnumber">7.14</span> <span class="toctext">MySecureShell</span></a>
<ul>
<li class="toclevel-3 tocsection-113"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#init.pp_14"><span class="tocnumber">7.14.1</span> <span class="toctext">init.pp</span></a></li>
<li class="toclevel-3 tocsection-114"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#redhat.pp_12"><span class="tocnumber">7.14.2</span> <span class="toctext">redhat.pp</span></a></li>
<li class="toclevel-3 tocsection-115"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#files_5"><span class="tocnumber">7.14.3</span> <span class="toctext">files</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-116"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#OpenLDAP_client_.26_Server"><span class="tocnumber">7.15</span> <span class="toctext">OpenLDAP client &amp; Server</span></a>
<ul>
<li class="toclevel-3 tocsection-117"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#init.pp_15"><span class="tocnumber">7.15.1</span> <span class="toctext">init.pp</span></a></li>
<li class="toclevel-3 tocsection-118"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#redhat.pp_13"><span class="tocnumber">7.15.2</span> <span class="toctext">redhat.pp</span></a></li>
<li class="toclevel-3 tocsection-119"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#facter_3"><span class="tocnumber">7.15.3</span> <span class="toctext">facter</span></a>
<ul>
<li class="toclevel-4 tocsection-120"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#generated_ldap_servers.rb"><span class="tocnumber">7.15.3.1</span> <span class="toctext">generated_ldap_servers.rb</span></a></li>
<li class="toclevel-4 tocsection-121"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#current_ldap_servers.rb"><span class="tocnumber">7.15.3.2</span> <span class="toctext">current_ldap_servers.rb</span></a></li>
</ul>
</li>
<li class="toclevel-3 tocsection-122"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Parser_2"><span class="tocnumber">7.15.4</span> <span class="toctext">Parser</span></a>
<ul>
<li class="toclevel-4 tocsection-123"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#dns2ip.rb"><span class="tocnumber">7.15.4.1</span> <span class="toctext">dns2ip.rb</span></a></li>
</ul>
</li>
<li class="toclevel-3 tocsection-124"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#redhat_ldapclient.pp"><span class="tocnumber">7.15.5</span> <span class="toctext">redhat_ldapclient.pp</span></a></li>
<li class="toclevel-3 tocsection-125"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#redhat_ldapserver.pp"><span class="tocnumber">7.15.6</span> <span class="toctext">redhat_ldapserver.pp</span></a></li>
<li class="toclevel-3 tocsection-126"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#files_6"><span class="tocnumber">7.15.7</span> <span class="toctext">files</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-127"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#sudo"><span class="tocnumber">7.16</span> <span class="toctext">sudo</span></a>
<ul>
<li class="toclevel-3 tocsection-128"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#init.pp_16"><span class="tocnumber">7.16.1</span> <span class="toctext">init.pp</span></a>
<ul>
<li class="toclevel-4 tocsection-129"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Am.C3.A9lioration_d.27un_module"><span class="tocnumber">7.16.1.1</span> <span class="toctext">Amélioration d'un module</span></a></li>
</ul>
</li>
<li class="toclevel-3 tocsection-130"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#files_7"><span class="tocnumber">7.16.2</span> <span class="toctext">files</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-131"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#snmpd"><span class="tocnumber">7.17</span> <span class="toctext">snmpd</span></a>
<ul>
<li class="toclevel-3 tocsection-132"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#init.pp_17"><span class="tocnumber">7.17.1</span> <span class="toctext">init.pp</span></a></li>
<li class="toclevel-3 tocsection-133"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#redhat.pp_14"><span class="tocnumber">7.17.2</span> <span class="toctext">redhat.pp</span></a></li>
<li class="toclevel-3 tocsection-134"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#files_8"><span class="tocnumber">7.17.3</span> <span class="toctext">files</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-135"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Postfix"><span class="tocnumber">7.18</span> <span class="toctext">Postfix</span></a>
<ul>
<li class="toclevel-3 tocsection-136"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#init.pp_18"><span class="tocnumber">7.18.1</span> <span class="toctext">init.pp</span></a></li>
<li class="toclevel-3 tocsection-137"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#redhat.pp_15"><span class="tocnumber">7.18.2</span> <span class="toctext">redhat.pp</span></a></li>
<li class="toclevel-3 tocsection-138"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#templates_5"><span class="tocnumber">7.18.3</span> <span class="toctext">templates</span></a></li>
<li class="toclevel-3 tocsection-139"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#files_9"><span class="tocnumber">7.18.4</span> <span class="toctext">files</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-140"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Nsswitch"><span class="tocnumber">7.19</span> <span class="toctext">Nsswitch</span></a>
<ul>
<li class="toclevel-3 tocsection-141"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#facter_4"><span class="tocnumber">7.19.1</span> <span class="toctext">facter</span></a></li>
<li class="toclevel-3 tocsection-142"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#init.pp_19"><span class="tocnumber">7.19.2</span> <span class="toctext">init.pp</span></a></li>
<li class="toclevel-3 tocsection-143"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#templates_6"><span class="tocnumber">7.19.3</span> <span class="toctext">templates</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-144"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Nagios_NRPE_.2B_plugins"><span class="tocnumber">7.20</span> <span class="toctext">Nagios NRPE + plugins</span></a>
<ul>
<li class="toclevel-3 tocsection-145"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#init.pp_20"><span class="tocnumber">7.20.1</span> <span class="toctext">init.pp</span></a></li>
<li class="toclevel-3 tocsection-146"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#files_10"><span class="tocnumber">7.20.2</span> <span class="toctext">files</span></a></li>
<li class="toclevel-3 tocsection-147"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#templates_7"><span class="tocnumber">7.20.3</span> <span class="toctext">templates</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-148"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Munin"><span class="tocnumber">7.21</span> <span class="toctext">Munin</span></a>
<ul>
<li class="toclevel-3 tocsection-149"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Munin_Interfaces"><span class="tocnumber">7.21.1</span> <span class="toctext">Munin Interfaces</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-150"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Mcollective"><span class="tocnumber">7.22</span> <span class="toctext">Mcollective</span></a>
<ul>
<li class="toclevel-3 tocsection-151"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#init.pp_21"><span class="tocnumber">7.22.1</span> <span class="toctext">init.pp</span></a></li>
<li class="toclevel-3 tocsection-152"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#common.pp_4"><span class="tocnumber">7.22.2</span> <span class="toctext">common.pp</span></a></li>
<li class="toclevel-3 tocsection-153"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#redhat.pp_16"><span class="tocnumber">7.22.3</span> <span class="toctext">redhat.pp</span></a></li>
<li class="toclevel-3 tocsection-154"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#files_11"><span class="tocnumber">7.22.4</span> <span class="toctext">files</span></a>
<ul>
<li class="toclevel-4 tocsection-155"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#RedHat.server.cfg"><span class="tocnumber">7.22.4.1</span> <span class="toctext">RedHat.server.cfg</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-2 tocsection-156"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Bind"><span class="tocnumber">7.23</span> <span class="toctext">Bind</span></a>
<ul>
<li class="toclevel-3 tocsection-157"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#init.pp_22"><span class="tocnumber">7.23.1</span> <span class="toctext">init.pp</span></a></li>
<li class="toclevel-3 tocsection-158"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#redhat.pp_17"><span class="tocnumber">7.23.2</span> <span class="toctext">redhat.pp</span></a></li>
<li class="toclevel-3 tocsection-159"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#files_12"><span class="tocnumber">7.23.3</span> <span class="toctext">files</span></a></li>
<li class="toclevel-3 tocsection-160"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#templates_8"><span class="tocnumber">7.23.4</span> <span class="toctext">templates</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-161"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Importation_d.27un_module"><span class="tocnumber">7.24</span> <span class="toctext">Importation d'un module</span></a>
<ul>
<li class="toclevel-3 tocsection-162"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Importer_tous_les_modules_d.27un_coup"><span class="tocnumber">7.24.1</span> <span class="toctext">Importer tous les modules d'un coup</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-163"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Utilisation"><span class="tocnumber">8</span> <span class="toctext">Utilisation</span></a>
<ul>
<li class="toclevel-2 tocsection-164"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Certificats"><span class="tocnumber">8.1</span> <span class="toctext">Certificats</span></a>
<ul>
<li class="toclevel-3 tocsection-165"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Cr.C3.A9ation_d.27un_certificat"><span class="tocnumber">8.1.1</span> <span class="toctext">Création d'un certificat</span></a></li>
<li class="toclevel-3 tocsection-166"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Ajout_d.27un_client_puppet_au_serveur"><span class="tocnumber">8.1.2</span> <span class="toctext">Ajout d'un client puppet au serveur</span></a></li>
<li class="toclevel-3 tocsection-167"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Synchroniser_un_client"><span class="tocnumber">8.1.3</span> <span class="toctext">Synchroniser un client</span></a>
<ul>
<li class="toclevel-4 tocsection-168"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Simuler"><span class="tocnumber">8.1.3.1</span> <span class="toctext">Simuler</span></a></li>
</ul>
</li>
<li class="toclevel-3 tocsection-169"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#R.C3.A9voquer_un_certificat"><span class="tocnumber">8.1.4</span> <span class="toctext">Révoquer un certificat</span></a></li>
<li class="toclevel-3 tocsection-170"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#R.C3.A9voquer_tous_les_certificats_du_serveur"><span class="tocnumber">8.1.5</span> <span class="toctext">Révoquer tous les certificats du serveur</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-171"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Surveillance_des_processus"><span class="tocnumber">8.2</span> <span class="toctext">Surveillance des processus</span></a>
<ul>
<li class="toclevel-3 tocsection-172"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#D.C3.A9termination_de_l.27.C3.A9tat_des_noeuds"><span class="tocnumber">8.2.1</span> <span class="toctext">Détermination de l'état des noeuds</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-173"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Utilisation_avanc.C3.A9e"><span class="tocnumber">9</span> <span class="toctext">Utilisation avancée</span></a>
<ul>
<li class="toclevel-2 tocsection-174"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Monitorer_Passenger"><span class="tocnumber">9.1</span> <span class="toctext">Monitorer Passenger</span></a></li>
<li class="toclevel-2 tocsection-175"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#V.C3.A9rifier_la_syntaxe_de_ses_.pp"><span class="tocnumber">9.2</span> <span class="toctext">Vérifier la syntaxe de ses .pp</span></a></li>
<li class="toclevel-2 tocsection-176"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Outrepasser_des_restrictions"><span class="tocnumber">9.3</span> <span class="toctext">Outrepasser des restrictions</span></a></li>
<li class="toclevel-2 tocsection-177"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#D.C3.A9sactiver_une_ressource"><span class="tocnumber">9.4</span> <span class="toctext">Désactiver une ressource</span></a></li>
<li class="toclevel-2 tocsection-178"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Pre_et_Post_puppet_run"><span class="tocnumber">9.5</span> <span class="toctext">Pre et Post puppet run</span></a></li>
<li class="toclevel-2 tocsection-179"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#CFT"><span class="tocnumber">9.6</span> <span class="toctext">CFT</span></a></li>
<li class="toclevel-2 tocsection-180"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#G.C3.A9n.C3.A9rer_un_manifest_depuis_un_syst.C3.A8me_existant"><span class="tocnumber">9.7</span> <span class="toctext">Générer un manifest depuis un système existant</span></a></li>
<li class="toclevel-2 tocsection-181"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Puppet_Push"><span class="tocnumber">9.8</span> <span class="toctext">Puppet Push</span></a></li>
<li class="toclevel-2 tocsection-182"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#MCollective_2"><span class="tocnumber">9.9</span> <span class="toctext">MCollective</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-183"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#FAQ"><span class="tocnumber">10</span> <span class="toctext">FAQ</span></a>
<ul>
<li class="toclevel-2 tocsection-184"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#err:_Could_not_retrieve_catalog_from_remote_server:_hostname_was_not_match_with_the_server_certificate"><span class="tocnumber">10.1</span> <span class="toctext">err: Could not retrieve catalog from remote server: hostname was not match with the server certificate</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-185"><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Ressources"><span class="tocnumber">11</span> <span class="toctext">Ressources</span></a></li>
</ul>
</div>

<table class="config_array" align="right" style="width:20em; font-size:90%; text-align:left; border: 1px #d0e7ff solid; margin-left:10px;">
   <tr>
      <td class="config_subarray" colspan="2" style="text-align:center;"><a href="./File:Puppet-short.png.html" class="image" title="Puppet"><img alt="Puppet" src="images/e/ef/Puppet-short.png" width="151" height="44" /></a></td>
   </tr><tr><td colspan="2" style="text-align:center;"><hr class="gradient" /></td></tr><tr>
      <th>Software version</th>
      <td>3.0+</td>
   </tr><tr>
      <th>Operating System</th>
      <td>Debian 7</td>
   </tr><tr>
      <th>Website</th>
      <td><a rel="nofollow" class="external text" href="http://puppetlabs.com/">Puppet Website</a></td>
   </tr><tr>
      <th>Last Update</th>
      <td>02/08/2013</td>
   </tr><tr>
      <th>Others</th>
      <td>Clients OS:<br />Debian 6/7<br />Solaris 10<br />RHEL 6</td>
   </tr>
</table>
<h1><span class="mw-headline" id="Introduction"><span class="mw-headline-number">1</span> Introduction</span></h1>
<p>Puppet est une application très pratique… C’est ce que l’on pourrait retrouver dans les entreprises avec de grands volumes de serveurs, où le système d’information est «&#160;industrialisé&#160;».<br />
Puppet permet d’automatiser un grand nombre de tache d’administration, comme l’installation de logiciels, de services ou encore de modifier des fichiers.<br />
Puppet permet de faire cela de manière centralisée ce qui permet d’administrer et de mieux contrôler un grand nombre de serveur hétérogènes ou homogènes.<br />
Puppet fonctionne en mode Client / Serveur.<br />
</p><p>Sur chaque machine un client va être installé et c’est lui qui va contacter le PuppetMaster, le serveur, par le biais de communication HTTPS, et donc SSL, un système pki est fourni.<br />
Puppet a été développé en Ruby le rendant multiplateforme&#160;: bsd (free, macos …) ,linux (redhat, debian, suse …), sun (opensolaris …)<br />
<a rel="nofollow" class="external text" href="http://reductivelabs.com/">Reductive Labs</a>, la société éditant Puppet, a développé un produit complémentaire, nommé Facter.<br />
Cette application permet de lister des éléments propres aux systèmes administrés, comme le nom de machine, l’adresse ip, la distribution, des variables d’environnement utilisables dans les templates de puppet.<br />
Puppet gérant des templates, on peut rapidement comprendre l’utilité de Facter, si par exemple on gère une ferme de serveurs de messagerie, qui nécessite un paramétrage contenant par exemple le nom de la machine. Là un template combiné avec des variables d’environnements s’avère tout à fait utile.<br />
Enfin bref Puppet combiné à Facter me semble une solution très intéressante pour simplifier l’administration de systèmes.
</p><p>Voici un schéma de fonctionnement de puppet&#160;:<br />
<a href="./File:Puppet_Star.png.html" class="image"><img alt="Puppet Star.png" src="images/9/92/Puppet_Star.png" width="348" height="174" /></a>
</p><p>Pour la configuration de Puppet, si vous souhaitez utiliser un IDE, il existe <a rel="nofollow" class="external text" href="http://www.puppetlabs.com/blog/geppetto-a-puppet-ide/">Geppetto</a>. Je vous le recommande d'ailleurs, ça vous évitera bien des soucis de syntaxe.
</p><p>Les documentations pour des version antérieurs à ce celle ci sont disponible ici&#160;:
</p>
<ul><li><a href="images/2/2b/Puppet_2.7.pdf" class="internal" title="Puppet 2.7.pdf">Puppet 2.7</a></li>
<li><a href="images/b/bc/Puppet_0.25.4.pdf" class="internal" title="Puppet 0.25.4.pdf">Puppet 0.25.4</a></li></ul>
<h1><span class="mw-headline" id="Hi.C3.A9rarchie_de_Puppet"><span class="mw-headline-number">2</span> Hiérarchie de Puppet</span></h1>
<p>Avant d'aller plus loin, j'ai pompé depuis le site officiel le fonctionnement de l'arborescence de puppet&#160;:
</p><p>All Puppet data files (modules, manifests, distributable files, etc) should be maintained in a Subversion or CVS repository (or your favorite Version Control System). The following hierarchy describes the layout one should use to arrange the files in a maintainable fashion:
</p>
<ul><li> /manifests/: this directory contains files and subdirectories that determine the manifest of individual systems but do not logically belong to any particular module. Generally, this directory is fairly thin and alternatives such as the use of LDAP or other external node tools can make the directory even thinner. This directory contains the following special files:
<ul><li> site.pp: first file that the Puppet Master parses when determining a server's catalog. It imports all the underlying subdirectories and the other special files in this directory. It also defines any global defaults, such as package managers. See sample site.pp.</li>
<li> templates.pp: defines all template classes. See also terminology:template classes. See sample templates.pp.</li>
<li> nodes.pp: defines all the nodes if not using an external node tool. See sample nodes.pp.</li></ul></li>
<li> /modules/{modulename}/: houses puppet modules in subdirectories with names matching that of the module name. This area defines the general building blocks of a server and contains modules such as for openssh, which will generally define classes openssh::client and openssh::server to setup the client and server respectively. The individual module directories contains subdirectories for manifests, distributable files, and templates. See `modules organization, terminology:module.</li>
<li> /modules/user/: A special module that contains manifests for users. This module contains a special subclass called user::virtual which declares all the users that might be on a given system in a virtual way. The other subclasses in the user module are classes for logical groupings, such as user::unixadmins, which will realize the individual users to be included in that group. See also naming conventions, terminology:realize.</li>
<li> /services/&#160;: this is an additional modules area that is specified in the module path for the puppetmaster. However, instead of generic modules for individual services and bits of a server, this module area is used to model servers specific to enterprise level infrastructure services (core infrastructure services that your IT department provides, such as www, enterprise directory, file server, etc). Generally, these classes will include the modules out of /modules/ needed as part of the catalog (such as openssh::server, postfix, user::unixadmins, etc). The files section for these modules is used to distribute configuration files specific to the enterprise infrastructure service such as openldap schema files if the module were for the enterprise directory. To avoid namespace collision with the general modules, it is recommended that these modules/classes are prefixed with s_ (e.g. s_ldap for the enterprise directory server module)</li>
<li> /clients/: similar to the /services/ module area, this area is used for modules related to modeling servers for external clients (departments outside your IT department). To avoid namespace collision, it is recommended that these modules/classes are prefixed with c_.</li>
<li> /notes/: this directory contains notes for reference by local administrators.</li>
<li> /plugins/: contains custom types programmed in Ruby. See also terminology:plugin-type.</li>
<li> /tools/: contains scripts useful to the maintenance of Puppet.</li></ul>
<h1><span class="mw-headline" id="Installation"><span class="mw-headline-number">3</span> Installation</span></h1>
<h2><span class="mw-headline" id="Serveur_Puppet"><span class="mw-headline-number">3.1</span> Serveur Puppet</span></h2>
<p>La version utilisée du master doit être la même que celle des postes clients. Il est très fortement recommandé d'utiliser une version supérieure ou égale à 0.25.4 (correctif de nombreux problèmes de performance).
Pour cela, sur Debian, il faudra installer la version disponible en squeeze/lenny-backport ou supérieur, et la bloquer pour éviter qu'une upgrade malencontreuse ne change sa version (utilisation des "pin locks"). Nous allons opter ici pour la version donnée sur le site officiel de Puppet.
</p><p>Pour le moment,il faut configurer le fichier /etc/hosts avec l'ip du serveur&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/hosts</font>
</td></tr>
<tr>
<td>
<pre>...
192.168.0.93    puppet-prd.deimos.fr puppet
...
</pre>
</td></tr></table><br />
<p><i>Note&#160;: Vérifiez que l'horloge du puppetmaster (et les client aussi bien sûr) est bien à jour/synchronisée. Il peut y avoir un problème avec les certificats qui seront non reconnus/acceptés si il y a un décalage (faire un `dpkg-reconfigure tz-data`).</i>
</p><p>Configurez le repository officiel de puppet si vous souhaitez la dernière version, sinon sautez cette étape pour installer la version qui est fournit par votre distribution&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> </font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">wget http://apt.puppetlabs.com/puppetlabs-release-stable.deb
dpkg -i puppetlabs-release-stable.deb</pre></div></div>
</td></tr></table><br />
<p>Et ensuite, nous mettez à jour&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> aptitude</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">aptitude update</pre></div></div>
</td></tr></table><br />
<p>Puis installer puppetmaster&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> aptitude</font>
</td></tr>
<tr>
<td>
<pre>aptitude install puppetmaster
</pre>
</td></tr></table><br />
<p>On peut vérifier que puppetmaster est bien installé en lançant 'facter' (voir si elle retourne bien quelque chose) ou la présence des fichiers SSL (dans /var/lib/puppet).
</p>
<h2><span class="mw-headline" id="Serveur_Web"><span class="mw-headline-number">3.2</span> Serveur Web</span></h2>
<p>Il va maintenant falloir configurer un serveur web sur la même machine que le serveur Puppet (Puppet Master). Pourquoi&#160;? Tout simplement par ce que le serveur par défaut est Webrick et que celui ci s'écroule si 10 noeuds en simultané y accèdent.
</p>
<table width="100%" class="warning_array">
<tr>
<td class="warning_subarray"> <font size="-1"><a href="./File:Warning_file.png.html" class="image" title="Warning"><img alt="Warning" src="images/0/09/Warning_file.png" width="39" height="32" /></a> <b>WARNING</b></font>
</td></tr>
<tr>
<td>Vous pouvez garder Webrick si vous souhaitez faire du test sur quelque noeuds, mais pas pour un passage en production&#160;!
</td></tr></table><br />
<p>Je vous laisse le choix ici entre Passenger et Nginx. Passenger est la solution recommandée depuis la version 3 de Puppet.
</p>
<h3><span class="mw-headline" id="Passenger"><span class="mw-headline-number">3.2.1</span> Passenger</span></h3>
<p>Si vous avez fait le choix d'utiliser Passenger comme il est recommandé par PuppetLab, il va falloir désactiver le démarrage automatique du démon, puisque celui ci démarrera un serveur web et entrera en conflit avec Passenger si on le laisse&#160;: 
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/default/puppetmaster</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1"># Defaults for puppetmaster - sourced by /etc/init.d/puppetmaster
&#160;
# Start puppetmaster on boot? If you are using passenger, you should
# have this set to &quot;no&quot;
<span class="xtra ln-xtra">START=no</span>&#160;
# Startup options
DAEMON_OPTS=&quot;&quot;
&#160;
# What port should the puppetmaster listen on (default: 8140).
PORT=8140</pre></div></div>
</td></tr></table><br />
<p>Désactivez maintenant le service&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> </font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">/etc/init.d/puppetmaster stop</pre></div></div>
</td></tr></table><br />
<p>Puis, installez Passenger&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> aptitude</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">aptitude install puppetmaster-passenger</pre></div></div>
</td></tr></table><br />
<p>Vous n'avez pas de configuration à faire. Tout est prévu par les packages officiels de Puppet. Dans le cas ou vous l'avez installé sans le repository officiel, voici la configuration générée&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/apache2/sites-enabled/puppetmaster</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="apache source-apache"><pre class="de1"><span class="co1"># you probably want to tune these settings</span>
PassengerHighPerformance <span class="kw2">on</span>
PassengerMaxPoolSize <span class="nu0">12</span>
PassengerPoolIdleTime <span class="nu0">1500</span>
<span class="co1"># PassengerMaxRequests 1000</span>
PassengerStatThrottleRate <span class="nu0">120</span>
RackAutoDetect <span class="kw2">Off</span>
RailsAutoDetect <span class="kw2">Off</span>
&#160;
<span class="kw1">Listen</span> <span class="nu0">8140</span>
&#160;
&lt;<span class="kw3">VirtualHost</span> *:<span class="nu0">8140</span>&gt;
        <span class="kw1">SSLEngine</span> <span class="kw2">on</span>
        <span class="kw1">SSLProtocol</span> -<span class="kw2">ALL</span> +SSLv3 +TLSv1
        <span class="kw1">SSLCipherSuite</span> <span class="kw2">ALL</span>:!ADH:RC4+RSA:+HIGH:+MEDIUM:-LOW:-SSLv2:-EXP
&#160;
        <span class="kw1">SSLCertificateFile</span>      /var/lib/puppet/ssl/certs/puppet.deimos.lan.pem
        <span class="kw1">SSLCertificateKeyFile</span>   /var/lib/puppet/ssl/private_keys/puppet.deimos.lan.pem
        <span class="kw1">SSLCertificateChainFile</span> /var/lib/puppet/ssl/certs/ca.pem
        <span class="kw1">SSLCACertificateFile</span>    /var/lib/puppet/ssl/certs/ca.pem
        <span class="co1"># If Apache complains about invalid signatures on the CRL, you can try disabling</span>
        <span class="co1"># CRL checking by commenting the next line, but this is not recommended.</span>
        <span class="kw1">SSLCARevocationFile</span>     /var/lib/puppet/ssl/ca/ca_crl.pem
        <span class="kw1">SSLVerifyClient</span> optional
        <span class="kw1">SSLVerifyDepth</span>  <span class="nu0">1</span>
        <span class="co1"># The `ExportCertData` option is needed for agent certificate expiration warnings</span>
        <span class="kw1">SSLOptions</span> +StdEnvVars +ExportCertData
&#160;
        <span class="co1"># This header needs to be set if using a loadbalancer or proxy</span>
        <span class="kw1">RequestHeader</span> unset X-Forwarded-For
&#160;
        <span class="kw1">RequestHeader</span> set X-SSL-Subject&#160;%{SSL_CLIENT_S_DN}e
        <span class="kw1">RequestHeader</span> set X-Client-DN&#160;%{SSL_CLIENT_S_DN}e
        <span class="kw1">RequestHeader</span> set X-Client-Verify&#160;%{SSL_CLIENT_VERIFY}e
&#160;
        <span class="kw1">DocumentRoot</span> /usr/share/puppet/rack/puppetmasterd/public/
        RackBaseURI /
        &lt;<span class="kw3">Directory</span> /usr/share/puppet/rack/puppetmasterd/&gt;
                <span class="kw1">Options</span> <span class="kw2">None</span>
                <span class="kw1">AllowOverride</span> <span class="kw2">None</span>
                <span class="kw1">Order</span> <span class="kw1">allow</span>,<span class="kw1">deny</span>
                <span class="kw1">allow</span> from <span class="kw2">all</span>
        &lt;/<span class="kw3">Directory</span>&gt;
&lt;/<span class="kw3">VirtualHost</span>&gt;</pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="NGINX_et_Mongrel"><span class="mw-headline-number">3.2.2</span> NGINX et Mongrel</span></h3>
<h4><span class="mw-headline" id="Installation_2"><span class="mw-headline-number">3.2.2.1</span> Installation</span></h4>
<p>Si vous avez fait le choix d'NGINX et Mongrel, il va falloir commencer par les installer&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> aptitude</font>
</td></tr>
<tr>
<td>
<pre>aptitude install nginx mongrel
</pre>
</td></tr></table><br />
<h4><span class="mw-headline" id="Configuration"><span class="mw-headline-number">3.2.2.2</span> Configuration</span></h4>
<p>Modification du fichier /etc/default/puppetmaster&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/default/puppetmaster</font>
</td></tr>
<tr>
<td>
<pre># Defaults for puppetmaster - sourced by /etc/init.d/puppet

# Start puppet on boot?
<b>START=yes</b>

# Startup options
DAEMON_OPTS=""

# What server type to run 
# Options: 
# 	   webrick (default, cannot handle more than ~30 nodes)
#	   mongrel (scales better than webrick because you can run
#	    	    multiple processes if you are getting
#	    	    connection-reset or End-of-file errors, switch to
#	    	    mongrel. Requires front-end web-proxy such as
#	    	    apache, nginx, or pound)
#	   See: <a rel="nofollow" class="external free" href="http://reductivelabs.com/trac/puppet/wiki/UsingMongrel">http://reductivelabs.com/trac/puppet/wiki/UsingMongrel</a>
<b>SERVERTYPE=mongrel</b>

# How many puppetmaster instances to start? Its pointless to set this
# higher than 1 if you are not using mongrel. 
<b>PUPPETMASTERS=4</b>

# What port should the puppetmaster listen on (default: 8140). If
# PUPPETMASTERS is set to a number greater than 1, then the port for
# the first puppetmaster will be set to the port listed below, and
# further instances will be incremented by one 
#
# NOTE: if you are using mongrel, then you will need to have a
# front-end web-proxy (such as apache, nginx, pound) that takes
# incoming requests on the port your clients are connecting to
# (default is: 8140), and then passes them off to the mongrel
# processes.  In this case it is recommended to run your web-proxy on
# port 8140 and change the below number to something else, such as
# 18140.
<b>PORT=18140</b>
</pre>
</td></tr></table><br />
<p>Après (re-)lancement du démon, on doit pouvoir voir les sockets attachées&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> netstat</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1"> &gt; netstat -pvltpn             
 Connexions Internet actives (seulement serveurs)
 Proto Recv-Q Send-Q Adresse locale          Adresse distante        Etat        PID/Program name
 tcp        0      0 0.0.0.0:41736           0.0.0.0:*               LISTEN      2029/rpc.statd  
 tcp        0      0 0.0.0.0:111             0.0.0.0:*               LISTEN      2018/portmap    
 tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      2333/sshd       
<span class="xtra ln-xtra"> tcp        0      0 127.0.0.1:18140         0.0.0.0:*               LISTEN      10059/ruby      </span><span class="xtra ln-xtra"> tcp        0      0 127.0.0.1:18141         0.0.0.0:*               LISTEN      10082/ruby      </span><span class="xtra ln-xtra"> tcp        0      0 127.0.0.1:18142         0.0.0.0:*               LISTEN      10104/ruby      </span><span class="xtra ln-xtra"> tcp        0      0 127.0.0.1:18143         0.0.0.0:*               LISTEN      10126/ruby      </span> tcp6       0      0&#160;:::22                  &#160;:::*                    LISTEN      2333/sshd</pre></div></div>
</td></tr></table><br />
<p>On ajoute les lignes suivante dans le fichier /etc/puppet/puppet.conf&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/puppet.conf</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">[main]
logdir=/var/log/puppet
vardir=/var/lib/puppet
ssldir=/var/lib/puppet/ssl
rundir=/var/run/puppet
factpath=$vardir/lib/facter
templatedir=$confdir/templates
<span class="xtra ln-xtra">pluginsync = true</span><span class="xtra ln-xtra">&#160;</span><span class="xtra ln-xtra">[master]</span><span class="xtra ln-xtra"># These are needed when the puppetmaster is run by passenger</span><span class="xtra ln-xtra"># and can safely be removed if webrick is used.</span><span class="xtra ln-xtra">ssl_client_header = HTTP_X_SSL_SUBJECT</span><span class="xtra ln-xtra">ssl_client_verify_header = SSL_CLIENT_VERIFY</span><span class="xtra ln-xtra">report = true</span><span class="xtra ln-xtra">&#160;</span><span class="xtra ln-xtra">[agent]</span><span class="xtra ln-xtra">server=puppet-srv.deimos.fr</span></pre></div></div>
</td></tr></table><br />
<p>On modifie la configuration suivante dans /etc/nginx.conf&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/nginx/nginx.conf</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">user www-data;
worker_processes  4;  
&#160;
error_log  /var/log/nginx/error.log;
pid        /var/run/nginx.pid;
&#160;
events {
    worker_connections  1024;
    # multi_accept on; 
}
&#160;
http {
<span class="xtra ln-xtra">    #include       /etc/nginx/mime.types;</span><span class="xtra ln-xtra">    default_type  application/octet-stream;</span>&#160;
<span class="xtra ln-xtra">    access_log /var/log/nginx/access.log;</span><span class="xtra ln-xtra">&#160;</span><span class="xtra ln-xtra">    sendfile        on; </span>    tcp_nopush     on; 
&#160;
<span class="xtra ln-xtra">    # Look at TLB size in /proc/cpuinfo (Linux) for the 4k pagesize</span><span class="xtra ln-xtra">    large_client_header_buffers     16      4k; </span><span class="xtra ln-xtra">    proxy_buffers                   128     4k; </span>&#160;
    #keepalive_timeout  0;  
    keepalive_timeout  65; 
    tcp_nodelay        on; 
&#160;
    gzip  on; 
    gzip_disable &quot;MSIE [1-6]\.(?!.*SV1)&quot;;
&#160;
    include /etc/nginx/conf.d/*.conf;
    include /etc/nginx/sites-enabled/*;
}</pre></div></div>
</td></tr></table><br />
<p>Et on ajoute cette configuration pour puppet&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/nginx/sites-available/puppetmaster.conf</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">upstream puppet-prd.deimos.fr {
   server 127.0.0.1:18140;
   server 127.0.0.1:18141;
   server 127.0.0.1:18142;
   server 127.0.0.1:18143;
}   
&#160;
server {
   listen                  8140;
&#160;
   ssl                     on; 
<span class="xtra ln-xtra">   ssl_certificate         /var/lib/puppet/ssl/certs/puppet-prd.pem;</span><span class="xtra ln-xtra">   ssl_certificate_key     /var/lib/puppet/ssl/private_keys/puppet-prd.pem;</span>   ssl_client_certificate  /var/lib/puppet/ssl/ca/ca_crt.pem;
   ssl_ciphers             SSLv2:-LOW:-EXPORT:RC4+RSA;
   ssl_session_cache       shared:SSL:8m;
   ssl_session_timeout     5m; 
&#160;
   ssl_verify_client       optional;
&#160;
   # obey to the Puppet CRL 
   ssl_crl                 /var/lib/puppet/ssl/ca/ca_crl.pem;
&#160;
   root                    /var/empty;
   access_log              /var/log/nginx/access-8140.log;
   #rewrite_log             /var/log/nginx/rewrite-8140.log;
&#160;
   # Variables
   # $ssl_cipher returns the line of those utilized it is cipher for established SSL-connection
   # $ssl_client_serial returns the series number of client certificate for established SSL-connection
   # $ssl_client_s_dn returns line subject DN of client certificate for established SSL-connection
   # $ssl_client_i_dn returns line issuer DN of client certificate for established SSL-connection
   # $ssl_protocol returns the protocol of established SSL-connection
&#160;
   location / {
<span class="xtra ln-xtra">       proxy_pass          http://puppet-prd.deimos.fr;</span>       proxy_redirect      off;
       proxy_set_header    Host             $host;
       proxy_set_header    X-Real-IP        $remote_addr;
       proxy_set_header    X-Forwarded-For  $proxy_add_x_forwarded_for;
       proxy_set_header    X-Client_DN      $ssl_client_s_dn;
       proxy_set_header    X-Client-Verify  $ssl_client_verify;
       proxy_set_header    X-SSL-Subject    $ssl_client_s_dn;
       proxy_set_header    X-SSL-Issuer     $ssl_client_i_dn;
       proxy_read_timeout  65; 
&#160;
   }
}</pre></div></div>
</td></tr></table><br />
<p>Ensuite on créer le lien symbolique pour appliquer la configuration&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> ln</font>
</td></tr>
<tr>
<td>
<pre>cd /etc/nginx/sites-available
ln -s /etc/nginx/sites-enabled/puppetmaster .
</pre>
</td></tr></table><br />
<p>Et ensuite on redémarre le serveur Nginx.
</p><p>Pour vérifier que les daemons tournent correctement, vous devez avoir les sockets suivantes ouvertes&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> netstat</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">&gt; netstat -vlptn             
Connexions Internet actives (seulement serveurs)
Proto Recv-Q Send-Q Adresse locale          Adresse distante        Etat        PID/Program name
tcp        0      0 0.0.0.0:41736           0.0.0.0:*               LISTEN      2029/rpc.statd  
<span class="xtra ln-xtra">tcp        0      0 0.0.0.0:8140            0.0.0.0:*               LISTEN      10293/nginx     </span>tcp        0      0 0.0.0.0:8141            0.0.0.0:*               LISTEN      10293/nginx     
tcp        0      0 0.0.0.0:111             0.0.0.0:*               LISTEN      2018/portmap    
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      2333/sshd       
tcp        0      0 127.0.0.1:18140         0.0.0.0:*               LISTEN      10059/ruby      
tcp        0      0 127.0.0.1:18141         0.0.0.0:*               LISTEN      10082/ruby      
tcp        0      0 127.0.0.1:18142         0.0.0.0:*               LISTEN      10104/ruby      
tcp        0      0 127.0.0.1:18143         0.0.0.0:*               LISTEN      10126/ruby      
tcp6       0      0&#160;:::22                  &#160;:::*                    LISTEN      2333/sshd</pre></div></div>
</td></tr></table><br />
<h2><span class="mw-headline" id="Clients_Puppet"><span class="mw-headline-number">3.3</span> Clients Puppet</span></h2>
<p>Pour les clients, c'est simple aussi. Mais avant ajoutez la ligne du serveur dans le fichier hosts&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/hosts</font>
</td></tr>
<tr>
<td>
<pre>...
192.168.0.93        puppet-prd.deimos.fr       puppet
</pre>
</td></tr></table><br />
<p>Ceci n'est pas obligatoire si vos noms DNS sont correctement configurés.
</p>
<h3><span class="mw-headline" id="Debian"><span class="mw-headline-number">3.3.1</span> Debian</span></h3>
<p>Si vous souhaitez utiliser la dernière version&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> </font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">wget http://apt.puppetlabs.com/puppetlabs-release-stable.deb
dpkg -i puppetlabs-release-stable.deb</pre></div></div>
</td></tr></table><br />
<p>Et ensuite, nous mettez à jour&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> aptitude</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">aptitude update</pre></div></div>
</td></tr></table><br />
<p>Vérifier que le fichier /etc/hosts contient bien le hostname de la machine cliente, puis installez puppet&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> apt-get</font>
</td></tr>
<tr>
<td>
<pre>aptitude install puppet
</pre>
</td></tr></table><br />
<h3><span class="mw-headline" id="Red_Hat"><span class="mw-headline-number">3.3.2</span> Red Hat</span></h3>
<p>Tout comme Debian, il existe un repo yum sur Red Hat et nous allons installer un package qui va le configurer pour nous&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> rpm</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">rpm -ivh http://yum.puppetlabs.com/el/6/products/x86_64/puppetlabs-release-6-6.noarch.rpm</pre></div></div>
</td></tr></table><br />
<p>Puis on installe&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> yum</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">yum install puppet</pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="Solaris"><span class="mw-headline-number">3.3.3</span> Solaris</span></h3>
<p>Le client Puppet dans la version stable de blastwave est trop ancien (0.23). Il faudra donc installer Puppet (et Facter) par l'intermédiaire du gestionnaire standard de Ruby: gem.<br />
Pour cela, il faudra au préalable installer ruby avec la commande suivante:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> pkg-get</font>
</td></tr>
<tr>
<td>
<pre>pkg-get -i ruby
</pre>
</td></tr></table><br />
<table width="100%" class="warning_array">
<tr>
<td class="warning_subarray"> <font size="-1"><a href="./File:Warning_file.png.html" class="image" title="Warning"><img alt="Warning" src="images/0/09/Warning_file.png" width="39" height="32" /></a> <b>WARNING</b></font>
</td></tr>
<tr>
<td>
<p>Vérifier que rubygems n'est pas déjà installé, sinon le supprimer&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> pkg-get</font>
</td></tr>
<tr>
<td>
<pre>pkg-get -r rubygems
</pre>
</td></tr></table><br />
</td></tr></table><br />
<p>puis installer une version plus à jour à partir des sources:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> </font>
</td></tr>
<tr>
<td>
<pre>wget <a rel="nofollow" class="external free" href="http://rubyforge.org/frs/download.php/45905/rubygems-1.3.1.tgz">http://rubyforge.org/frs/download.php/45905/rubygems-1.3.1.tgz</a>
gzcat rubygems-1.3.1.tgz | tar -xf -
cd rubygems-1.3.1
ruby setup.rb
gem --version
</pre>
</td></tr></table><br />
<p>Installer puppet avec la commande et l'argument -p si vous avez un proxy&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> gem</font>
</td></tr>
<tr>
<td>
<pre>gem install puppet --version '0.25.4' -p <a rel="nofollow" class="external free" href="http://proxy:3128/">http://proxy:3128/</a>
</pre>
</td></tr></table><br />
<p>Il faut modifier/ajouter quelques commandes qui ne sont pas par défaut sur Solaris, pour que Puppet fonctionne mieux:
</p>
<ul><li> Créer un lien pour uname et puppetd&#160;:</li></ul>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> ln</font>
</td></tr>
<tr>
<td>
<pre>ln -s /usr/bin/uname /usr/bin/
ln -s /opt/csw/bin/puppetd /usr/bin/
</pre>
</td></tr></table><br />
<ul><li> Créer un script appelé /usr/bin/dnsdomainname&#160;:</li></ul>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /usr/bin/dnsdomainname</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="bash source-bash"><pre class="de1"><span class="co0">#!/usr/bin/bash</span>
<span class="re2">DOMAIN</span>=<span class="st0">&quot;<span class="es5">`/usr/bin/domainname 2&gt; /dev/null`</span>&quot;</span>
<span class="kw1">if</span> <span class="br0">&#91;</span> <span class="sy0">!</span> <span class="re5">-z</span> <span class="st0">&quot;<span class="es2">$DOMAIN</span>&quot;</span> <span class="br0">&#93;</span>; <span class="kw1">then</span>
    <span class="kw3">echo</span> <span class="re1">$DOMAIN</span> <span class="sy0">|</span> <span class="kw2">sed</span> <span class="st_h">'s/^[^.]*.//'</span>
<span class="kw1">fi</span></pre></div></div>
</td></tr></table><br />
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> chmod</font>
</td></tr>
<tr>
<td>
<pre>chmod 755 /usr/bin/dnsdomainname
</pre>
</td></tr></table><br />
<p>Ensuite, la procédure est la même que pour les autres OS, c'est à dire, modifier /etc/hosts pour inclure puppet-prd.deimos.fr, et lancer: 
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> puppetd</font>
</td></tr>
<tr>
<td>
<pre>puppetd --verbose --no-daemon --test --server puppet-prd.deimos.fr
</pre>
</td></tr></table><br />
<p>A ce stade là, si ça ne fonctionne pas, c'est tout simplement qu'il faut modifier la configuration (puppet.conf) de votre client.
</p>
<h1><span class="mw-headline" id="Configuration_2"><span class="mw-headline-number">4</span> Configuration</span></h1>
<h2><span class="mw-headline" id="Serveur"><span class="mw-headline-number">4.1</span> Serveur</span></h2>
<p>Pour la partie serveur, voici comment est constitué l'arborescence de celui ci (dans /etc/puppet)&#160;:
</p>
<div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">.
|-- auth.conf
|-- autosign.conf
|-- fileserver.conf
|-- manifests
|   |-- common.pp
|   |-- modules.pp
|   `-- site.pp
|-- modules
|-- puppet.conf
`-- templates</pre></div></div>
<h3><span class="mw-headline" id="auth.conf"><span class="mw-headline-number">4.1.1</span> auth.conf</span></h3>
<p>C'est ici que nous allons régler toutes les autorisations&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/auth.conf</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1"># This is an example auth.conf file, it mimics the puppetmasterd defaults
#
# The ACL are checked in order of appearance in this file.
#
# Supported syntax:
# This file supports two different syntax depending on how
# you want to express the ACL.
#
# Path syntax (the one used below):
# ---------------------------------
# path /path/to/resource
# [environment envlist]
# [method methodlist]
# [auth[enthicated] {yes|no|on|off|any}]
# allow [host|ip|*]
# deny [host|ip]
#
# The path is matched as a prefix. That is /file match at
# the same time /file_metadat and /file_content.
#
# Regex syntax:
# -------------
# This one is differenciated from the path one by a '~'
#
# path ~ regex
# [environment envlist]
# [method methodlist]
# [auth[enthicated] {yes|no|on|off|any}]
# allow [host|ip|*]
# deny [host|ip]
#
# The regex syntax is the same as ruby ones.
#
# Ex:
# path ~ .pp$
# will match every resource ending in .pp (manifests files for instance)
#
# path ~ ^/path/to/resource
# is essentially equivalent to path /path/to/resource
#
# environment:: restrict an ACL to a specific set of environments
# method:: restrict an ACL to a specific set of methods
# auth:: restrict an ACL to an authenticated or unauthenticated request
# the default when unspecified is to restrict the ACL to authenticated requests
# (ie exactly as if auth yes was present).
#
&#160;
### Authenticated ACL - those applies only when the client
### has a valid certificate and is thus authenticated
&#160;
# allow nodes to retrieve their own catalog (ie their configuration)
path ~ ^/catalog/([^/]+)$
method find
allow $1
&#160;
# allow nodes to retrieve their own node definition
path ~ ^/node/([^/]+)$
method find
allow $1
&#160;
# allow all nodes to access the certificates services
path /certificate_revocation_list/ca
method find
allow *
&#160;
# allow all nodes to store their reports
path /report
method save
allow *
&#160;
# inconditionnally allow access to all files services
# which means in practice that fileserver.conf will
# still be used
path /file
allow *
&#160;
### Unauthenticated ACL, for clients for which the current master doesn't
### have a valid certificate; we allow authenticated users, too, because
### there isn't a great harm in letting that request through.
&#160;
# allow access to the master CA
path /certificate/ca
method find
allow *
&#160;
path /certificate/
method find
allow *
&#160;
path /certificate_request
method find, save
allow *
&#160;
# this one is not stricly necessary, but it has the merit
# to show the default policy which is deny everything else
path /
auth any
<span class="xtra ln-xtra">allow *.deimos.fr</span></pre></div></div>
</td></tr></table><br />
<p>Dans le cas ou vous rencontrez des problèmes d'accès, pour faire simple <b>mais non sécurisé</b>, ajoutez cette ligne à la fin de votre fichier de configuration le temps de vos tests&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/auth.conf</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">allow *</pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="autosign.conf"><span class="mw-headline-number">4.1.2</span> autosign.conf</span></h3>
<p>Vous pouvez autosigner certains certificats pour gagner du temps. Ceci peut être un peu dangereux, mais si votre filtrage des noeuds est correctement faite derrière, pas de soucis&#160;:-)
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> autosign.conf</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">*.deimos.fr</pre></div></div>
</td></tr></table><br />
<p>Ici je vais autosigner tous mes nodes ayant comme domaine deimos.fr
</p>
<h3><span class="mw-headline" id="fileserver.conf"><span class="mw-headline-number">4.1.3</span> fileserver.conf</span></h3>
<p>Donnez les autorisations des machines clientes dans le fichier /etc/puppet/fileserver.conf&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/fileserver.conf</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1"># This file consists of arbitrarily named sections/modules
# defining where files are served from and to whom
&#160;
# Define a section 'files'
# Adapt the allow/deny settings to your needs. Order
# for allow/deny does not matter, allow always takes precedence
# over deny
[files]
  path /etc/puppet/files
<span class="xtra ln-xtra">  allow *.deimos.fr</span>#  allow *.example.com
#  deny *.evil.example.com
#  allow 192.168.0.0/24
&#160;
[plugins]
<span class="xtra ln-xtra">  allow *.deimos.fr</span>#  allow *.example.com
#  deny *.evil.example.com
#  allow 192.168.0.0/24</pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="manifests"><span class="mw-headline-number">4.1.4</span> manifests</span></h3>
<p>Créons les fichiers manquants&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> touch</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="bash source-bash"><pre class="de1"><span class="kw2">touch</span> <span class="sy0">/</span>etc<span class="sy0">/</span>puppet<span class="sy0">/</span>manifests<span class="sy0">/</span><span class="br0">&#123;</span>common.pp,modules.pp,site.pp<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<h4><span class="mw-headline" id="common.pp"><span class="mw-headline-number">4.1.4.1</span> common.pp</span></h4>
<p>Puis on va les renseigner un par un. Le common.pp est vide, mais vous pouvez y insérer des choses qui permettrons d'être pris en tant que configuration globale.
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/manifests/common.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1">&#160;</pre></div></div>
</td></tr></table><br />
<h4><span class="mw-headline" id="modules.pp"><span class="mw-headline-number">4.1.4.2</span> modules.pp</span></h4>
<p>Ensuite je vais définir ici mon ou mes modules de base. Par exemple, dans ma future configuration je vais déclarer un module "base" qui contiendra tout ce que n'importe quelle machine faisant partie de puppet héritera&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/manifests/modules.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"> import <span class="st0">&quot;base&quot;</span></pre></div></div>
</td></tr></table><br />
<h4><span class="mw-headline" id="site.pp"><span class="mw-headline-number">4.1.4.3</span> site.pp</span></h4>
<p>On demande de charger tous les modules présents dans le dossier modules&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/manifests/site.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="co1"># /etc/puppet/manifests/site.pp</span>
import <span class="st0">&quot;common.pp&quot;</span>
&#160;
<span class="co1"># The filebucket option allows for file backups to the server</span>
filebucket <span class="br0">&#123;</span> main: server <span class="sy0">=&gt;</span> <span class="st0">'puppet-prod-nux.deimos.fr'</span> <span class="br0">&#125;</span>
&#160;
<span class="co1"># Backing up all files and ignore vcs files/folders</span>
<span class="kw4">File</span> <span class="br0">&#123;</span>
	backup <span class="sy0">=&gt;</span> <span class="st0">'.puppet-bak'</span>,
	ignore <span class="sy0">=&gt;</span> <span class="br0">&#91;</span><span class="st0">'.svn'</span>, <span class="st0">'.git'</span>, <span class="st0">'CVS'</span> <span class="br0">&#93;</span>
<span class="br0">&#125;</span>
&#160;
<span class="co1"># Default global path</span>
<span class="kw3">Exec</span> <span class="br0">&#123;</span> path <span class="sy0">=&gt;</span> <span class="st0">&quot;/usr/bin:/usr/sbin/:/bin:/sbin&quot;</span> <span class="br0">&#125;</span>
&#160;
<span class="co1"># Import base module</span>
import <span class="st0">&quot;modules.pp&quot;</span></pre></div></div>
</td></tr></table><br />
<p>Ici je lui dis d'utiliser le filebucket présent sur le serveur puppet et de renommer les fichiers qui vont être remplacés par puppet en &lt;fichier&gt;.puppet-bak.<br />
Je lui demande également d'ignorer tout dossiers ou fichiers créer par des VCS de type SVN, gut ou CVS.<br />
Et enfin, j'indique le path par défaut que puppet aura quant il s'exécutera sur les clients.
</p><p>Il faut savoir que toute cette configuration est propre au serveur puppet, donc global. Tous ce que nous mettrons dedans pourra être hérité.<br />
On relance le puppetmaster pour être sûr que les modifications côté serveur ont bien été prises en compte.
</p>
<h3><span class="mw-headline" id="puppet.conf"><span class="mw-headline-number">4.1.5</span> puppet.conf</span></h3>
<p>J'ai volontairement passé le dossier modules car c'est le gros morceau de puppet et fera l'objet d'une attention toute particulière plus tard dans cet article.
</p><p>Donc nous allons passer au fichier de configuration puppet.conf que vous avez normalement déjà configuré lors de l'installation mongrel/nginx...&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/puppet.conf</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">[main]
logdir=/var/log/puppet
vardir=/var/lib/puppet
ssldir=/var/lib/puppet/ssl
rundir=/var/run/puppet
factpath=$vardir/lib/facter
templatedir=$confdir/templates
<span class="xtra ln-xtra">pluginsync = true</span><span class="xtra ln-xtra">&#160;</span><span class="xtra ln-xtra">[master]</span><span class="xtra ln-xtra"># These are needed when the puppetmaster is run by passenger</span><span class="xtra ln-xtra"># and can safely be removed if webrick is used.</span><span class="xtra ln-xtra">ssl_client_header = HTTP_X_SSL_SUBJECT</span><span class="xtra ln-xtra">ssl_client_verify_header = SSL_CLIENT_VERIFY</span><span class="xtra ln-xtra">report = true</span><span class="xtra ln-xtra">&#160;</span><span class="xtra ln-xtra">[agent]</span><span class="xtra ln-xtra">server=puppet-srv.deimos.fr</span></pre></div></div>
</td></tr></table><br />
<p>Pour le dossier templates, je n'ai rien dedans.
</p>
<h2><span class="mw-headline" id="Client"><span class="mw-headline-number">4.2</span> Client</span></h2>
<p>Chaque client doit avoir son entrée dans le serveur DNS (tout comme le serveur)&#160;!
</p>
<h3><span class="mw-headline" id="puppet.conf_2"><span class="mw-headline-number">4.2.1</span> puppet.conf</span></h3>
<h4><span class="mw-headline" id="Debian_.2F_Red_Hat"><span class="mw-headline-number">4.2.1.1</span> Debian / Red Hat</span></h4>
<p>Le fichier de configuration doit contenir l'adresse du serveur&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/puppet.conf</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">[main]
    # The Puppet log directory.
    # The default value is '$vardir/log'.
    logdir = /var/log/puppet
&#160;
    # Where Puppet PID files are kept.
    # The default value is '$vardir/run'.
    rundir = /var/run/puppet
&#160;
    # Where SSL certificates are kept.
    # The default value is '$confdir/ssl'.
    ssldir = $vardir/ssl
&#160;
<span class="xtra ln-xtra">    # Puppet master server</span><span class="xtra ln-xtra">    server = puppet-prd.deimos.fr</span><span class="xtra ln-xtra">&#160;</span><span class="xtra ln-xtra">    # Add custom facts</span><span class="xtra ln-xtra">    pluginsync = true</span><span class="xtra ln-xtra">    pluginsource = puppet://$server/plugins</span><span class="xtra ln-xtra">    factpath = /var/lib/puppet/lib/facter</span>&#160;
[agent]
    # The file in which puppetd stores a list of the classes
    # associated with the retrieved configuratiion.  Can be loaded in
    # the separate ``puppet`` executable using the ``--loadclasses``
    # option.
    # The default value is '$confdir/classes.txt'.
    classfile = $vardir/classes.txt
&#160;
    # Where puppetd caches the local configuration.  An
    # extension indicating the cache format is added automatically.
    # The default value is '$confdir/localconfig'.
    localconfig = $vardir/localconfig
&#160;
    # Reporting
    report = true</pre></div></div>
</td></tr></table><br />
<h4><span class="mw-headline" id="Solaris_2"><span class="mw-headline-number">4.2.1.2</span> Solaris</span></h4>
<p>Pour la partie Solaris, il a fallu pas mal adapter la configuration&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/puppet.conf</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">[main]
    logdir=/var/log/puppet
    vardir=/var/opt/csw/puppet
    rundir=/var/run/puppet
    # ssldir=/var/lib/puppet/ssl
    ssldir=/etc/puppet/ssl
    # Where 3rd party plugins and modules are installed
    libdir = $vardir/lib
    templatedir=$vardir/templates
    # Turn plug-in synchronization on.
    pluginsync = true
    pluginsource = puppet://$server/plugins
    factpath = /var/puppet/lib/facter
&#160;
[puppetd]
    report=true
    server=puppet-prd.deimos.fr
    # certname=puppet-prd.deimos.fr
    # enable the marshal config format
    config_format=marshal
    # different run-interval, default= 30min
    # e.g. run puppetd every 4 hours = 14400
    runinterval = 14400
    logdest=/var/log/puppet/puppet.log</pre></div></div>
</td></tr></table><br />
<h1><span class="mw-headline" id="Le_langage"><span class="mw-headline-number">5</span> Le langage</span></h1>
<p>Avant de commencer la création de modules, il va falloir en connaitre un peu plus sur la syntaxe/le langage utilisé pour puppet. Il faut savoir que sa syntaxe est proche du ruby et qu'il est même possible d'écrire des modules complets en ruby. Je vais expliquer ici quelques techniques/possibilités pour vous permettre de créer des modules avancés par la suite.
</p><p>Nous allons utiliser des types également, je ne rentrerais pas en détail dessus, car la doc sur le site est suffisamment clair pour cela&#160;: <a rel="nofollow" class="external free" href="http://docs.puppetlabs.com/references/latest/type.html">http://docs.puppetlabs.com/references/latest/type.html</a>
</p>
<h2><span class="mw-headline" id="Les_fonctions"><span class="mw-headline-number">5.1</span> Les fonctions</span></h2>
<p>Voici comment définir une fonction avec plusieurs arguments&#160;:
</p>
<div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1">define network_config<span class="br0">&#40;</span> <span class="re0">$ip</span>, <span class="re0">$netmask</span>, <span class="re0">$gateway</span> <span class="br0">&#41;</span> <span class="br0">&#123;</span>
    notify <span class="br0">&#123;</span><span class="st0">&quot;$ip, $netmask, $gateway&quot;</span>:<span class="br0">&#125;</span>
<span class="br0">&#125;</span>
network_config <span class="br0">&#123;</span> <span class="st0">&quot;eth0&quot;</span>:
    ip      <span class="sy0">=&gt;</span> <span class="st0">'192.168.0.1'</span>,
    netmask <span class="sy0">=&gt;</span> <span class="st0">'255.255.255.0'</span>,
    gateway <span class="sy0">=&gt;</span> <span class="st0">'192.168.0.254,
}</span></pre></div></div>
<h2><span class="mw-headline" id="Installer_des_packages"><span class="mw-headline-number">5.2</span> Installer des packages</span></h2>
<p>Nous allons voir ici comment installer un package, puis utiliser une fonction pour facilement en installer bien plus. Pour un package, c'est simple&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> init.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="co1"># Install kexec-tools</span>
package <span class="br0">&#123;</span> <span class="st0">'kexec-tools'</span>:
    <span class="kw1">ensure</span> <span class="sy0">=&gt;</span> <span class="st0">'installed'</span>
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<p>Nous demandons ici qu'un package (kexec-tool) soit installé. Si nous souhaitons que plusieurs soient installés, il va falloir créer un tableau&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> init.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="co1"># Install kexec-tools</span>
package <span class="br0">&#123;</span> 
   <span class="br0">&#91;</span>
      <span class="st0">'kexec-tools'</span>,
      <span class="st0">'package2'</span>,
      <span class="st0">'pacakge3'</span>
   <span class="br0">&#93;</span>:
   <span class="kw1">ensure</span> <span class="sy0">=&gt;</span> <span class="st0">'installed'</span>
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<p>C'est plutôt pratique et les tableau fonctionnent très souvent de cette manière pour a peu prêt n'importe quel type utilisé. Nous pouvons aussi créer une fonction pour cela dans laquelle nous allons lui envoyer chaque élément du tableau&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> init.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="co1"># Validate that pacakges are installed</span>
define packages_install <span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
    notice<span class="br0">&#40;</span><span class="st0">&quot;Installation of ${name} package&quot;</span><span class="br0">&#41;</span>
    package <span class="br0">&#123;</span>
        <span class="st0">&quot;${name}&quot;</span>:
            <span class="kw1">ensure</span> <span class="sy0">=&gt;</span> <span class="st0">'installed'</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span>
<span class="co1"># Set all custom packages (not embended in distribution) that need to be installed</span>
packages_install
<span class="br0">&#123;</span> <span class="br0">&#91;</span>
   <span class="st0">'puppet'</span>,
   <span class="st0">'tmux'</span>
<span class="br0">&#93;</span>: <span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<p>Certains d'entre vous dirons que pour ce cas précis, ça ne sert à rien, puisque la méthode au dessus permet de le faire tandis que d'autres trouveront cette méthode plus élégante et facile à appréhender pour un novice qui arrive sur puppet. Le nom de la fonction utilisé est packages_install, la variable $name est toujours le premier élément envoyé à une fonction, qui correspond ici à chaque éléments de notre tableau.
</p>
<h2><span class="mw-headline" id="Inclure_.2F_Exclure_des_modules"><span class="mw-headline-number">5.3</span> Inclure / Exclure des modules</span></h2>
<p>Vous venez de voir les fonctions, nous allons les poussées un peu plus loin avec une solution pour inclure et exclure le chargement de certains modules. Ici, j'ai un fichier de fonctions&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> functions.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="co1"># Load or not modules (include/exclude)</span>
define include_modules <span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="kw1">if</span> <span class="br0">&#40;</span>$exclude_modules == <span class="kw1">undef</span><span class="br0">&#41;</span> <span class="kw1">or</span>&#160;!<span class="br0">&#40;</span>$name <span class="kw1">in</span> <span class="re0">$exclude_modules</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw1">include</span> <span class="re0">$name</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<p>Là j'ai un autre fichier représentant les rôles de mes serveurs (on y viendra plus tard)&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> </font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="co1"># Load modules</span>
<span class="re0">$minimal_modules</span> =
<span class="br0">&#91;</span>
    <span class="st0">'puppet'</span>,
    <span class="st0">'resolvconf'</span>,
    <span class="st0">'packages_defaults'</span>,
    <span class="st0">'configurations_defaults'</span>
<span class="br0">&#93;</span>
include_modules<span class="br0">&#123;</span> <span class="re0">$minimal_modules</span>: <span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<p>Et enfin un fichier contenant le nom d'un serveur dans lequel je vais lui demander de charger certains modules, mais d'en exclure également une partie&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> </font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1">node <span class="st0">'srv.deimos.fr'</span> <span class="br0">&#123;</span>
    <span class="re0">$exclude_modules</span> = <span class="br0">&#91;</span> <span class="st0">'resolvconf'</span> <span class="br0">&#93;</span>
    <span class="kw1">include</span> base::minimal
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<p>Ici j'utilise un tableau '$exclude_modules' (avec un seul élément, mais vous pouvez en mettre plusieurs séparés par des virgules), qui va me permettre de préciser les modules à exclude. Car par la ligne d'après il va charger tout ce dont il aura besoin grâce à la fonction include_modules.
</p>
<h2><span class="mw-headline" id="Les_templates"><span class="mw-headline-number">5.4</span> Les templates</span></h2>
<p>Lorsque vous écrivez des manifests, vous faites appelle à une directive nommée 'File' lorsque vous souhaitez envoyer un fichier sur un serveur. Mais si le contenu de ce fichier doit changer en fonction de certains paramètres (nom, ip, timezone, domaine...), alors il faut utiliser les templates&#160;! Et c'est là que ça devient intéressant puisqu'il est possible de scripter au sein même d'un template pour en générer le contenu. Les templates utilisent un langage très proche de celui du ruby.
</p><p>Dans un template, la syntaxe suivante est utilisée&#160;:
</p>
<ul><li> Pour les facts, c’est simple, il faut préfixer la variable par un “@”. Par exemple &lt;%= fqdn&#160;%&gt; devient &lt;%= @fqdn&#160;%&gt;.</li>
<li> Pour vos variables, si elle est déclarée dans le manifest qui appelle le template, utilisez également le “@”.</li>
<li> Ma variable myvar définie dans le manifeste qui appelle ce template a pour valeur &lt;%= myvar&#160;%&gt;.</li></ul>
<p>Dans le cas ou vous souhaitez accéder à une variable définie en dehors du manifest actuel, en dehors du scope local, utilisez la fonction scope.lookupvar&#160;:
</p>
<div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="sy0">&lt;%</span>= scope.<span class="me1">lookupvar</span><span class="br0">&#40;</span><span class="st0">'common::config::myvar'</span><span class="br0">&#41;</span> <span class="sy0">%&gt;</span></pre></div></div>
<p>Vous pouvez valider votre template via&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> erb</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">erb -P -x -T '-' mytemplate.erb | ruby -c</pre></div></div>
</td></tr></table><br />
<p>Voici un exemple avec OpenSSH pour que vous compreniez. J'ai donc pris la configuration qui va varier selon certains paramètres&#160;:
</p><p><br />
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/ssh/templates/sshd_config</font>
</td></tr>
<tr>
<td>
<pre># Package generated configuration file
# See the sshd(8) manpage for details

# What ports, IPs and protocols we listen for
<b>&lt;% ssh_default_port.each do |val| -%&gt; </b>
<b>Port &lt;%= val -%&gt; </b>
<b>&lt;% end -%&gt;</b>
# Use these options to restrict which interfaces/protocols sshd will bind to
#ListenAddress&#160;::
#ListenAddress 0.0.0.0
Protocol 2
# HostKeys for protocol version 2
HostKey /etc/ssh/ssh_host_rsa_key
HostKey /etc/ssh/ssh_host_dsa_key
#Privilege Separation is turned on for security
UsePrivilegeSeparation yes

# Lifetime and size of ephemeral version 1 server key
KeyRegenerationInterval 3600
ServerKeyBits 768

# Logging
SyslogFacility AUTH
LogLevel INFO

# Authentication:
LoginGraceTime 120
PermitRootLogin yes
StrictModes yes

RSAAuthentication yes
PubkeyAuthentication yes
#AuthorizedKeysFile	%h/.ssh/authorized_keys

# Don't read the user's ~/.rhosts and ~/.shosts files
IgnoreRhosts yes
# For this to work you will also need host keys in /etc/ssh_known_hosts
RhostsRSAAuthentication no
# similar for protocol version 2
HostbasedAuthentication no
# Uncomment if you don't trust ~/.ssh/known_hosts for RhostsRSAAuthentication
#IgnoreUserKnownHosts yes

# To enable empty passwords, change to yes (NOT RECOMMENDED)
PermitEmptyPasswords no

# Change to yes to enable challenge-response passwords (beware issues with
# some PAM modules and threads)
ChallengeResponseAuthentication no

# Change to no to disable tunnelled clear text passwords
#PasswordAuthentication yes

# Kerberos options
#KerberosAuthentication no
#KerberosGetAFSToken no
#KerberosOrLocalPasswd yes
#KerberosTicketCleanup yes

# GSSAPI options
#GSSAPIAuthentication no
#GSSAPICleanupCredentials yes

X11Forwarding yes
X11DisplayOffset 10
PrintMotd no
PrintLastLog yes
TCPKeepAlive yes
#UseLogin no

#MaxStartups 10:30:60
#Banner /etc/issue.net

# Allow client to pass locale environment variables
AcceptEnv LANG LC_*

Subsystem sftp /usr/lib/openssh/sftp-server

UsePAM yes
<b># AllowUsers &lt;%= ssh_allowed_users&#160;%&gt;</b>
</pre>
</td></tr></table><br />
<p>Ici nous utilisons donc 2 types d'utilisation de templates. Une multi lignes a répétition, et l'autre avec un simple remplacement de variables&#160;:
</p>
<ul><li> ssh_default_port.each do&#160;: permet de mettre une ligne de "Port num_port" a chaque port spécifié</li>
<li> ssh_allowed_users&#160;: permet de donner une liste d'utilisateur</li></ul>
<p>Ces variables sont généralement a déclarer soit dans <a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#servers.pp">la partie 'node'</a> ou bien dans la <a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#vars.pp">configuration globale</a>. Nous venons de voir comment mettre une variable ou une boucle dans un template, mais sachez qu'il est également possible de mettre des if&#160;! Bref, un langage complet existe et vous permet de moduler a souhait un fichier.
</p><p>Ces méthodes s'avèrent simple et très efficaces. Petite subtilité&#160;:
</p>
<ul><li> -%&gt;&#160;: Lorsqu'une ligne se termine comme ceci, c'est qu'il ne va pas y avoir de saut de ligne grâce au - situé à la fin.</li>
<li>&#160;%&gt; &#160;: Il y aura un saut de ligne ici.</li></ul>
<h3><span class="mw-headline" id="Les_inline-templates"><span class="mw-headline-number">5.4.1</span> Les inline-templates</span></h3>
<p>Ceci est une petite subtilité qui peut paraitre inutile, mais est en fait très utile pour exécuter de petites méthodes au sein d'un manifest&#160;! Prenez par exemple la fonction 'split' qui aujourd'hui existe dans puppet, il semblerait normal que la fonction 'join' existe non&#160;? Et bien non...enfin pas dans la version actuelle au moment ou j'écris ces lignes (la 2.7.18). Je peux donc utiliser de la même façons que les templates du code dans mes manifests, voyez plutôt&#160;:
</p>
<div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1">$ldap_servers = [ '192.168.0.1', '192.168.0.2', '127.0.0.1' ]
$comma_ldap_servers = inline_template(&quot;<span class="sy0">&lt;%</span>= <span class="br0">&#40;</span>ldap_servers<span class="br0">&#41;</span>.<span class="me1">join</span><span class="br0">&#40;</span><span class="st0">','</span><span class="br0">&#41;</span> <span class="sy0">%&gt;</span>&quot;)</pre></div></div>
<ul><li> $ldap_servers&#160;: ceci est un simple tableau avec ma liste de serveurs LDAP</li>
<li> $comma_ldap_servers&#160;: nous utilisons la fonction inline_template, qui va appeler la fonction join, lui passer le tableau ldap_servers et joindre le contenu avec des virgules.</li></ul>
<p>J'aurais au finale&#160;:
</p>
<div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="re0">$comma_ldap_servers</span> = <span class="st0">'192.168.0.1,192.168.0.2,127.0.0.1'</span></pre></div></div>
<h2><span class="mw-headline" id="Les_Facters"><span class="mw-headline-number">5.5</span> Les Facters</span></h2>
<p>Les "facts", sont des scripts (voir /usr/lib/ruby/1.8/facter pour les facts standards) permettant de construire des variables dynamiques, qui changent en fonction de l'environnement dans lequel ils sont exécutés.<br />
Par exemple, on pourra définir un "fact", qui détermine si l'on est sur une machine de type "cluster" en  fonction de la présence ou l'absence d'un fichier&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> is_cluster.rb</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"> <span class="co1"># is_cluster.rb</span>
&#160;
 Facter.<span class="me1">add</span><span class="br0">&#40;</span><span class="st0">&quot;is_cluster&quot;</span><span class="br0">&#41;</span> <span class="kw1">do</span>
   setcode <span class="kw1">do</span>
      <span class="kw4">FileTest</span>.<span class="me1">exists</span>?<span class="br0">&#40;</span><span class="st0">&quot;/etc/cluster/nodeid&quot;</span><span class="br0">&#41;</span>
   <span class="kw1">end</span>
 <span class="kw1">end</span></pre></div></div>
</td></tr></table><br />
<p>On peut aussi utiliser de fonctions qui permettent de mettre directement dans des templates, des fonctions de type facter (downcase ou upcase pour changer la casse)&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> modules/collectd/templates/collectd.conf</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1">#
# Config file for collectd(1).
# Please read collectd.conf(5) for a list of options.
# http://collectd.org/
#
&#160;
<span class="xtra ln-xtra">Hostname     <span class="sy0">&lt;%</span>= hostname.<span class="me1">downcase</span> <span class="sy0">%&gt;</span></span>FQDNLookup   true</pre></div></div>
</td></tr></table><br />
<p>Attention, si l'on veut tester le fact sur la machine destination, il ne faudra pas oublier de spécifier le chemin ou se trouvent les facts sur la machine&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> export</font>
</td></tr>
<tr>
<td>
<pre>export FACTERLIB=/var/lib/puppet/lib/facter
</pre>
</td></tr></table><br />
<p>ou pour Solaris&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> export</font>
</td></tr>
<tr>
<td>
<pre>export FACTERLIB=/var/opt/csw/puppet/lib/facter
</pre>
</td></tr></table><br />
<p>Pour voir la liste des facts ensuite présent sur le système, il faut simplement taper la commander facter&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> facter</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">&gt; facter
facterversion =&gt; 1.5.7
hardwareisa =&gt; i386
hardwaremodel =&gt; i86pc
hostname =&gt; PA-OFC-SRV-UAT-2
hostnameldap =&gt; PA-OFC-SRV-UAT
id =&gt; root
interfaces =&gt; lo0,e1000g0,e1000g0_1,e1000g0_2,e1000g1,e1000g2,e1000g3,clprivnet0
...</pre></div></div>
</td></tr></table><br />
<p>Voir <a rel="nofollow" class="external free" href="http://docs.puppetlabs.com/guides/custom_facts.html">http://docs.puppetlabs.com/guides/custom_facts.html</a> pour plus de détails.
</p>
<h2><span class="mw-headline" id="Informations_dynamiques"><span class="mw-headline-number">5.6</span> Informations dynamiques</span></h2>
<p>Il est possible d'utiliser des scripts côté serveur et d'en récupérer le contenu dans une variable. Voici un exemple&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /usr/bin/latest_puppet_version.rb</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="co1">#!/usr/bin/ruby</span>
<span class="kw3">require</span> <span class="st0">'open-uri'</span>
page = <span class="kw3">open</span><span class="br0">&#40;</span><span class="st0">&quot;http://www.puppetlabs.com/misc/download-options/&quot;</span><span class="br0">&#41;</span>.<span class="me1">read</span>
<span class="kw3">print</span> page.<span class="me1">match</span><span class="br0">&#40;</span><span class="sy0">/</span>stable version is <span class="br0">&#40;</span><span class="br0">&#91;</span>\d\.<span class="br0">&#93;</span><span class="sy0">*</span><span class="br0">&#41;</span><span class="sy0">/</span><span class="br0">&#41;</span><span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span></pre></div></div>
</td></tr></table><br />
<p>Et dans le manifest&#160;:
</p>
<div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="re0">$latestversion</span> = generate<span class="br0">&#40;</span><span class="st0">&quot;/usr/bin/latest_puppet_version.rb&quot;</span><span class="br0">&#41;</span>
notify <span class="br0">&#123;</span> <span class="st0">&quot;The latest stable Puppet version is ${latestversion}. You're using ${puppetversion}.&quot;</span>: <span class="br0">&#125;</span></pre></div></div>
<p>Magique non&#160;?&#160;:-). Sachez qu'il est même possible de passer des arguments avec une virgule entre chaque&#160;!!!
</p>
<h2><span class="mw-headline" id="Les_Parsers"><span class="mw-headline-number">5.7</span> Les Parsers</span></h2>
<p>Les parsers sont la création de fonctions particulières utilisables dans les manifests (côté serveur). Par exemple, j'ai créer un parser qui va me permettre de faire du reverse lookup dns&#160;:
</p><p><br />
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/openldap/lib/puppet/parser/functions/dns2ip.rb</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="co1"># Dns2IP for Puppet</span>
<span class="co1"># Made by Pierre Mavro</span>
<span class="co1"># Does a DNS lookup and returns an array of strings of the results</span>
<span class="co1"># Usage&#160;: need to send one string dns servers separated by comma. The return will be the same</span>
&#160;
<span class="kw3">require</span> <span class="st0">'resolv'</span>
&#160;
<span class="kw1">module</span> <span class="re2">Puppet::Parser::Functions</span>
  newfunction<span class="br0">&#40;</span><span class="re3">:dns2ip</span>, <span class="re3">:type</span> <span class="sy0">=&gt;</span> <span class="re3">:rvalue</span><span class="br0">&#41;</span> <span class="kw1">do</span> <span class="sy0">|</span>arguments<span class="sy0">|</span>
    result = <span class="br0">&#91;</span> <span class="br0">&#93;</span>
    <span class="co1"># Split comma sperated list in array</span>
    dns_array = arguments<span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span>.<span class="kw3">split</span><span class="br0">&#40;</span><span class="st0">','</span><span class="br0">&#41;</span>
    <span class="co1"># Push each DNS/IP address in result array</span>
    dns_array.<span class="me1">each</span> <span class="kw1">do</span> <span class="sy0">|</span>dns_name<span class="sy0">|</span>
      result.<span class="me1">push</span><span class="br0">&#40;</span>Resolv.<span class="me1">new</span>.<span class="me1">getaddresses</span><span class="br0">&#40;</span>dns_name<span class="br0">&#41;</span><span class="br0">&#41;</span>
    <span class="kw1">end</span>
    <span class="co1"># Join array with comma</span>
    dns_list = result.<span class="me1">join</span><span class="br0">&#40;</span><span class="st0">','</span><span class="br0">&#41;</span>
    <span class="co1"># Delete last comma if exist</span>
    good_dns_list = dns_list.<span class="kw3">gsub</span><span class="br0">&#40;</span><span class="sy0">/</span>,$<span class="sy0">/</span>, <span class="st0">''</span><span class="br0">&#41;</span>
    <span class="kw2">return</span> good_dns_list
  <span class="kw1">end</span>
<span class="kw1">end</span></pre></div></div>
</td></tr></table><br />
<p>Nous allons pouvoir créer cette variable puis l'insérer dans nos manifests&#160;:
</p>
<div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="re0">$comma_ldap_servers</span> = <span class="st0">'ldap1.deimos.fr,ldap2.deimos.fr,127.0.0.1'</span>
<span class="re0">$ip_ldap_servers</span> = dns2ip<span class="br0">&#40;</span><span class="st0">&quot;${comma_ldap_servers}&quot;</span><span class="br0">&#41;</span></pre></div></div>
<p>J'envoie ici une liste de serveur LDAP et il me sera retourné leurs adresses IP. Vous comprenez maintenant que c'est un appel, un peu comme les <a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Les_inline_templates">inline_templates</a>, mais qui est bien plus puissant.
</p>
<table width="100%" class="notes_array">
<tr>
<td class="notes_subarray"> <font size="-1"><a href="./File:Notes_file.png.html" class="image" title="Notes"><img alt="Notes" src="images/2/20/Notes_file.png" width="31" height="32" /></a> Notes</font>
</td></tr>
<tr>
<td>
<p>J'ai pu constater un comportement de cache assez désagréable avec ce type de fonctions&#160;! En effet, lorsque vous développez un parser et que vous le testez, il est fort probable que vous utilisiez des fonctions 'Notify' dans vos manifests pour debugger. Cependant les modifications que vous ferez sur votre parser ne s'appliqueront pas forcément tant que vous n'aurez pas vidé les caches. Après quelques recherches et demandes IRC, il s'avère que la seule méthode fonctionnelle soit de <b>redémarrer le Puppet Master et le serveur web (Nginx dans notre cas)</b>. Ca fonctionne très bien, mais c'est un peu pénible lors de la phase de debug.
</p>
</td></tr></table><br />
<h2><span class="mw-headline" id="Du_Ruby_dans_vos_manifests"><span class="mw-headline-number">5.8</span> Du Ruby dans vos manifests</span></h2>
<p>Il est tout à fait possible d'écrire du Ruby dans vos manifests. Voyez plutôt&#160;:
</p>
<div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1">notice<span class="br0">&#40;</span> <span class="st0">&quot;I am running on node&#160;%s&quot;</span> <span class="sy0">%</span> scope.<span class="me1">lookupvar</span><span class="br0">&#40;</span><span class="st0">&quot;fqdn&quot;</span><span class="br0">&#41;</span> <span class="br0">&#41;</span></pre></div></div>
<p>Ca ressemble fortement à un sprintf.
</p>
<h2><span class="mw-headline" id="Ajouter_une_variable_Ruby_dans_les_manifests"><span class="mw-headline-number">5.9</span> Ajouter une variable Ruby dans les manifests</span></h2>
<p>Si nous souhaitons par exemple récupérer l'heure actuelle dans un manifest&#160;:
</p>
<div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="kw3">require</span> <span class="st0">'time'</span>
scope.<span class="me1">setvar</span><span class="br0">&#40;</span><span class="st0">&quot;now&quot;</span>, <span class="kw4">Time</span>.<span class="me1">now</span><span class="br0">&#41;</span>
notice<span class="br0">&#40;</span> <span class="st0">&quot;Here is the current time&#160;:&#160;%s&quot;</span> <span class="sy0">%</span> scope.<span class="me1">lookupvar</span><span class="br0">&#40;</span><span class="st0">&quot;now&quot;</span><span class="br0">&#41;</span> <span class="br0">&#41;</span></pre></div></div>
<h2><span class="mw-headline" id="Les_classes"><span class="mw-headline-number">5.10</span> Les classes</span></h2>
<p>On peut utiliser des classes avec des arguments comme ceci&#160;:
</p>
<div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="kw1">class</span> mysql<span class="br0">&#40;</span> <span class="re0">$package</span>, <span class="re0">$socket</span>, <span class="re0">$port</span> = <span class="st0">&quot;3306&quot;</span> <span class="br0">&#41;</span> <span class="br0">&#123;</span>
    …
<span class="br0">&#125;</span>
<span class="kw1">class</span> <span class="br0">&#123;</span> <span class="st0">&quot;mysql&quot;</span>:
    package <span class="sy0">=&gt;</span> <span class="st0">&quot;percona-sql-server-5.0&quot;</span>,
    socket  <span class="sy0">=&gt;</span> <span class="st0">&quot;/var/run/mysqld/mysqld.sock&quot;</span>,
    port    <span class="sy0">=&gt;</span> <span class="st0">&quot;3306&quot;</span>,
<span class="br0">&#125;</span></pre></div></div>
<h2><span class="mw-headline" id="Utilisation_des_tables_de_hash"><span class="mw-headline-number">5.11</span> Utilisation des tables de hash</span></h2>
<p>Tout comme les tableaux, il est également possible d'utilise les tables de hasch, regardez cet exemple&#160;:
</p>
<div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="re0">$interface</span> = <span class="br0">&#123;</span>
    name <span class="sy0">=&gt;</span> <span class="st0">'eth0'</span>,
    address <span class="sy0">=&gt;</span> <span class="st0">'192.168.0.1'</span>
<span class="br0">&#125;</span>
notice<span class="br0">&#40;</span><span class="st0">&quot;Interface ${interface[name]} has address ${interface[address]}&quot;</span><span class="br0">&#41;</span></pre></div></div>
<h2><span class="mw-headline" id="Les_regex"><span class="mw-headline-number">5.12</span> Les regex</span></h2>
<p>Il est possible d'utiliser les regex et d'en récupérer les patterns&#160;:
</p>
<div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="re0">$input</span> = <span class="st0">&quot;What a great tool&quot;</span>
<span class="kw1">if</span> <span class="re0">$input</span> =~ <span class="sy0">/</span>What a <span class="br0">&#40;</span>\w<span class="sy0">+</span><span class="br0">&#41;</span> tool<span class="sy0">/</span> <span class="br0">&#123;</span>
   notice<span class="br0">&#40;</span><span class="st0">&quot;You said the tool is&#160;: '$1'. The complete line is&#160;: $0&quot;</span><span class="br0">&#41;</span>
<span class="br0">&#125;</span></pre></div></div>
<h2><span class="mw-headline" id="Substitution"><span class="mw-headline-number">5.13</span> Substitution</span></h2>
<p>Il est possible de substituer&#160;:
</p>
<div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="re0">$ipaddress</span> = <span class="st0">'192.168.0.15'</span>
<span class="re0">$class_c</span> = regsubst<span class="br0">&#40;</span>$ipaddress, <span class="st0">&quot;(.*)<span class="es0">\.</span>.*&quot;</span>, <span class="st0">&quot;<span class="es0">\1</span>.0&quot;</span><span class="br0">&#41;</span>
notify <span class="br0">&#123;</span> <span class="re0">$ipaddress</span>: <span class="br0">&#125;</span>
notify <span class="br0">&#123;</span> <span class="re0">$class_c</span>: <span class="br0">&#125;</span></pre></div></div>
<p>Ce qui me donnera 192.168.0.15 et 192.168.0.0.
</p>
<h2><span class="mw-headline" id="Notify_et_Require"><span class="mw-headline-number">5.14</span> Notify et Require</span></h2>
<p>Ces 2 fonctions sont fortes utiles une fois insérées dans un manifest. Cela permet par exemple à un service de dire qu'il require (require) un Package pour fonctionner et à un fichier de configuration de notifier (notify) un service s'il change pour que celui ci redémarre le démon. On peut également écrire quelque chose comme ceci&#160;:
</p>
<div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1">Package<span class="br0">&#91;</span><span class="st0">&quot;ntp&quot;</span><span class="br0">&#93;</span> <span class="sy0">-&gt;</span> <span class="kw4">File</span><span class="br0">&#91;</span><span class="st0">&quot;/etc/ntp.conf&quot;</span><span class="br0">&#93;</span> ~<span class="sy0">&gt;</span> Service<span class="br0">&#91;</span><span class="st0">&quot;ntp&quot;</span><span class="br0">&#93;</span></pre></div></div>
<ul><li> -&gt;&#160;: signifie 'require'</li>
<li> ~&gt;&#160;: signifie 'notify'</li></ul>
<p>Il est également possible de faire des require sur des classes&#160;:-)
</p>
<h2><span class="mw-headline" id="L.27op.C3.A9rateur_.2B.3E"><span class="mw-headline-number">5.15</span> L'opérateur +&gt;</span></h2>
<p>Voici un superbe opérateur qui va nous permettre de gagner un peu de temps. L'exemple ci dessous&#160;:
</p>
<div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1">file <span class="br0">&#123;</span> <span class="st0">&quot;/etc/ssl/certs/cookbook.pem&quot;</span>:
    source <span class="sy0">=&gt;</span> <span class="st0">&quot;puppet:///modules/apache/deimos.pem&quot;</span>,
<span class="br0">&#125;</span>
Service<span class="br0">&#91;</span><span class="st0">&quot;apache2&quot;</span><span class="br0">&#93;</span> <span class="br0">&#123;</span>
    <span class="kw3">require</span> <span class="sy0">+&gt;</span> <span class="kw4">File</span><span class="br0">&#91;</span><span class="st0">&quot;/etc/ssl/certs/deimos.pem&quot;</span><span class="br0">&#93;</span>,
<span class="br0">&#125;</span></pre></div></div>
<p>Correspond à&#160;:
</p>
<div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1">service <span class="br0">&#123;</span> <span class="st0">&quot;apache2&quot;</span>:
<span class="xtra ln-xtra">       enable  <span class="sy0">=&gt;</span> <span class="kw2">true</span>,</span><span class="xtra ln-xtra">       <span class="kw1">ensure</span>  <span class="sy0">=&gt;</span> running,</span>       <span class="kw3">require</span> <span class="sy0">=&gt;</span> <span class="kw4">File</span><span class="br0">&#91;</span><span class="st0">&quot;/etc/ssl/certs/deimos.pem&quot;</span><span class="br0">&#93;</span>,
<span class="br0">&#125;</span></pre></div></div>
<h2><span class="mw-headline" id="V.C3.A9rifier_le_num.C3.A9ro_de_version_d.27un_soft"><span class="mw-headline-number">5.16</span> Vérifier le numéro de version d'un soft</span></h2>
<p>Si vous avez besoin de vérifier le numéro e version d'un soft pour prendre ensuite une décision, voici un bon exemple&#160;:
</p>
<div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="re0">$app_version</span> = <span class="st0">&quot;2.7.16&quot;</span>
<span class="re0">$min_version</span> = <span class="st0">&quot;2.7.18&quot;</span>
<span class="kw1">if</span> versioncmp<span class="br0">&#40;</span> <span class="re0">$app_version</span>, <span class="re0">$min_version</span> <span class="br0">&#41;</span> <span class="sy0">&gt;</span>= <span class="nu0">0</span> <span class="br0">&#123;</span>
   notify <span class="br0">&#123;</span> <span class="st0">&quot;Puppet version OK&quot;</span>: <span class="br0">&#125;</span>
<span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
   notify <span class="br0">&#123;</span> <span class="st0">&quot;Puppet upgrade needed&quot;</span>: <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></div></div>
<h2><span class="mw-headline" id="Les_ressources_virtuelles"><span class="mw-headline-number">5.17</span> Les ressources virtuelles</span></h2>
<p>Utile pour les écritures de test, vous pouvez par exemple créer une ressource en la précédent d'un '@'. Elle sera lue mais non exécutée jusqu'à ce qu'implicitement vous lui indiquiez (realize). Exemple&#160;:
</p>
<div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="re1">@package</span> <span class="br0">&#123;</span>
    <span class="st0">'postfix'</span>:
        <span class="kw1">ensure</span> <span class="sy0">=&gt;</span> installed
<span class="br0">&#125;</span>
realize<span class="br0">&#40;</span> Package<span class="br0">&#91;</span><span class="st0">''</span>postfix<span class="br0">&#93;</span> <span class="br0">&#41;</span></pre></div></div>
<p>Un des gros avantages de cette méthode est de pouvoir déclarer à plusieurs endroits dans votre puppet master le realize sans pour autant que vous ayez de conflits&#160;!
</p>
<h2><span class="mw-headline" id="Suppression_d.27un_fichier_.C3.A9volu.C3.A9e"><span class="mw-headline-number">5.18</span> Suppression d'un fichier évoluée</span></h2>
<p>Vous pouvez demander la suppression d'un fichier au bout d'un temps donné ou bien à partir d'une certaine taille&#160;:
</p>
<div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1">tidy <span class="br0">&#123;</span> <span class="st0">&quot;/var/lib/puppet/reports&quot;</span>:
    age     <span class="sy0">=&gt;</span> <span class="st0">&quot;1w&quot;</span>,
    size    <span class="sy0">=&gt;</span> <span class="st0">&quot;512k&quot;</span>,
    recurse <span class="sy0">=&gt;</span> <span class="kw2">true</span>,
<span class="br0">&#125;</span></pre></div></div>
<p>Ceci entrainera la suppression d'un dossier au bout d'une semaine avec son contenu.
</p>
<h1><span class="mw-headline" id="Les_modules"><span class="mw-headline-number">6</span> Les modules</span></h1>
<p>Il est recommandé de créer des modules pour chaque service afin de rendre la configuration plus souple. Ca fait partie de certaines best practices.
</p><p>Je vais aborder ici différentes techniques en essayant de garder un ordre croissant de difficulté.
</p>
<h2><span class="mw-headline" id="Initialisation_d.27un_module"><span class="mw-headline-number">6.1</span> Initialisation d'un module</span></h2>
<p>Nous allons donc créer sur le serveur, l'arborescence adéquate. Pour cet exemple, nous allons partir avec "sudo", mais vous pouvez choisir autre chose si vous souhaitez&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> </font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="bash source-bash"><pre class="de1"><span class="kw2">mkdir</span> <span class="re5">-p</span> <span class="sy0">/</span>etc<span class="sy0">/</span>puppet<span class="sy0">/</span>modules<span class="sy0">/</span>sudo<span class="sy0">/</span>manifests
<span class="kw2">touch</span> <span class="sy0">/</span>etc<span class="sy0">/</span>puppet<span class="sy0">/</span>modules<span class="sy0">/</span>sudo<span class="sy0">/</span>manifests<span class="sy0">/</span>init.pp</pre></div></div>
</td></tr></table><br />
<p>N'oubliez pas que ceci est nécessaire pour chaque module. Le fichier init.pp est le premier fichier qui se chargera lors de l'appel au module.
</p>
<h2><span class="mw-headline" id="Le_module_initiale_.28base.29"><span class="mw-headline-number">6.2</span> Le module initiale (base)</span></h2>
<p>Il nous faut créer un module initiale qui va gérer la liste des serveurs, les fonctions dont nous allons avoir besoin, les roles, des variables globales... bref, ça peut paraitre un peu abstrait au premier abord mais sachez juste qu'il nous faut un module pour gérer ensuite tous les autres. Nous allons commencer par celui là qui est un des plus important pour la suite.
</p><p>Comme vous le savez maintenant, il nous faut un fichier init.pp pour que le premier module soit chargé. Nous allons donc créer notre arborescence que nous allons appeler "base"&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> mkdir</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="bash source-bash"><pre class="de1"><span class="kw2">mkdir</span> <span class="re5">-p</span> <span class="sy0">/</span>etc<span class="sy0">/</span>puppet<span class="sy0">/</span>modules<span class="sy0">/</span>base<span class="sy0">/</span><span class="br0">&#123;</span>manifests,puppet<span class="sy0">/</span>parser<span class="sy0">/</span>functions<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="init.pp"><span class="mw-headline-number">6.2.1</span> init.pp</span></h3>
<p>Puis nous allons créer et renseigner le fichier init.pp&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/base/manifests/init.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="co1">################################################################################</span>
<span class="co1">#                                BASE MODULES                                  #</span>
<span class="co1">################################################################################</span>
&#160;
<span class="co1"># Load defaults vars</span>
import <span class="st0">&quot;vars.pp&quot;</span>
<span class="co1"># Load functions</span>
import <span class="st0">&quot;functions.pp&quot;</span>
<span class="co1"># Load sysctl module</span>
<span class="kw1">include</span> <span class="st0">&quot;sysctl&quot;</span>
<span class="co1"># Load network module</span>
<span class="kw1">include</span> <span class="st0">&quot;network&quot;</span>
<span class="co1"># Load roles</span>
import <span class="st0">&quot;roles.pp&quot;</span>
<span class="co1"># Set servers properties</span>
import <span class="st0">&quot;servers.pp&quot;</span></pre></div></div>
</td></tr></table><br />
<p>Les lignes correspondantes à import sont équivalentes à un "include" (dans des services comme ssh ou nrpe) de mes autres fichier .pp que nous allons créer par la suite. Tandis que les include vont charger d'autres modules que je vais créer par la suite.
</p>
<h3><span class="mw-headline" id="vars.pp"><span class="mw-headline-number">6.2.2</span> vars.pp</span></h3>
<p>Nous allons ensuite créer le fichier vars.pp qui contiendra toutes mes variables globales pour mes futurs modules ou manifests (*.pp)&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/base/manifests/vars.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="co1">################################################################################</span>
<span class="co1">#                                    VARS                                      #</span>
<span class="co1">################################################################################</span>
&#160;
<span class="co1"># Default admins emails</span>
<span class="re0">$root_email</span> = <span class="st0">'deimos@deimos.fr'</span>
&#160;
<span class="co1"># NTP Timezone. Usage&#160;:</span>
<span class="co1"># Look at /usr/share/zoneinfo/ and add the continent folder followed by the town</span>
<span class="re0">$set_timezone</span> = <span class="st0">'Europe/Paris'</span>
&#160;
<span class="co1"># Define empty exclude modules</span>
<span class="re0">$exclude_modules</span> = <span class="br0">&#91;</span> <span class="br0">&#93;</span>
&#160;
<span class="co1"># Default LDAP servers</span>
<span class="re0">$ldap_servers</span> = <span class="br0">&#91;</span> <span class="br0">&#93;</span>
&#160;
<span class="co1"># Default DNS servers</span>
<span class="re0">$dns_servers</span> = <span class="br0">&#91;</span> <span class="st0">'192.168.0.69'</span>, <span class="st0">'192.168.0.27'</span> <span class="br0">&#93;</span></pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="functions.pp"><span class="mw-headline-number">6.2.3</span> functions.pp</span></h3>
<p>Maintenant, nous allons créer des fonctions qui vont nous permettre de rajouter quelques fonctionnalités aujourd'hui non présentes dans puppet ou en simplifier certaines&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/base/manifests/functions.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><ol><li class="li1"><pre class="de1"><span class="sy0">/*</span> </pre></li><li class="li1"><pre class="de1">Puppet Functions</pre></li><li class="li1"><pre class="de1">Made by Pierre Mavro</pre></li><li class="li1"><pre class="de1"><span class="sy0">*/</span></pre></li><li class="li2"><pre class="de2"><span class="co1">################################################################################</span></pre></li><li class="li1"><pre class="de1"><span class="co1">#                             GLOBAL FUNCTIONS                                 #</span></pre></li><li class="li1"><pre class="de1"><span class="co1">################################################################################</span></pre></li><li class="li1"><pre class="de1">&#160;</pre></li><li class="li1"><pre class="de1"><span class="co1"># Load or not modules (include/exclude)</span></pre></li><li class="li2 ln-xtra"><pre class="de2">define include_modules <span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></pre></li><li class="li1"><pre class="de1">    <span class="kw1">if</span> <span class="br0">&#40;</span>$exclude_modules == <span class="kw1">undef</span><span class="br0">&#41;</span> <span class="kw1">or</span>&#160;!<span class="br0">&#40;</span>$name <span class="kw1">in</span> <span class="re0">$exclude_modules</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></pre></li><li class="li1"><pre class="de1">        <span class="kw1">include</span> <span class="re0">$name</span></pre></li><li class="li1"><pre class="de1">    <span class="br0">&#125;</span></pre></li><li class="li1"><pre class="de1"><span class="br0">&#125;</span></pre></li><li class="li2"><pre class="de2">&#160;</pre></li><li class="li1"><pre class="de1"><span class="co1"># Validate that pacakges are installed</span></pre></li><li class="li1 ln-xtra"><pre class="de1">define packages_install <span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></pre></li><li class="li1"><pre class="de1">    notice<span class="br0">&#40;</span><span class="st0">&quot;Installation of ${name} package&quot;</span><span class="br0">&#41;</span></pre></li><li class="li1"><pre class="de1">    package <span class="br0">&#123;</span></pre></li><li class="li2"><pre class="de2">        <span class="st0">&quot;${name}&quot;</span>:</pre></li><li class="li1"><pre class="de1">            <span class="kw1">ensure</span> <span class="sy0">=&gt;</span> present</pre></li><li class="li1"><pre class="de1">    <span class="br0">&#125;</span></pre></li><li class="li1"><pre class="de1"><span class="br0">&#125;</span></pre></li><li class="li1"><pre class="de1">&#160;</pre></li><li class="li2"><pre class="de2"><span class="co1"># Check that those services are enabled on boot or not</span></pre></li><li class="li1 ln-xtra"><pre class="de1">define services_start_on_boot <span class="br0">&#40;</span>$enable_status<span class="br0">&#41;</span> <span class="br0">&#123;</span></pre></li><li class="li1"><pre class="de1">    service <span class="br0">&#123;</span></pre></li><li class="li1"><pre class="de1">        <span class="st0">&quot;${name}&quot;</span>:</pre></li><li class="li1"><pre class="de1">            enable <span class="sy0">=&gt;</span> <span class="st0">&quot;${enable_status}&quot;</span></pre></li><li class="li2"><pre class="de2">    <span class="br0">&#125;</span></pre></li><li class="li1"><pre class="de1"><span class="br0">&#125;</span></pre></li><li class="li1"><pre class="de1">&#160;</pre></li><li class="li1"><pre class="de1"><span class="co1"># Add, remove, comment or uncomment lines</span></pre></li><li class="li1 ln-xtra"><pre class="de1">define line <span class="br0">&#40;</span>$file, <span class="re0">$line</span>, <span class="re0">$ensure</span> = <span class="st0">'present'</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></pre></li><li class="li2"><pre class="de2">    <span class="kw1">case</span> <span class="re0">$ensure</span> <span class="br0">&#123;</span></pre></li><li class="li1"><pre class="de1">        default&#160;: <span class="br0">&#123;</span></pre></li><li class="li1"><pre class="de1">            err<span class="br0">&#40;</span><span class="st0">&quot;unknown ensure value ${ensure}&quot;</span><span class="br0">&#41;</span></pre></li><li class="li1"><pre class="de1">        <span class="br0">&#125;</span></pre></li><li class="li1"><pre class="de1">        present&#160;: <span class="br0">&#123;</span></pre></li><li class="li2"><pre class="de2">            <span class="kw3">exec</span> <span class="br0">&#123;</span></pre></li><li class="li1"><pre class="de1">                <span class="st0">&quot;echo '${line}' &gt;&gt; '${file}'&quot;</span>&#160;:</pre></li><li class="li1"><pre class="de1">                    <span class="kw1">unless</span> <span class="sy0">=&gt;</span> <span class="st0">&quot;grep -qFx '${line}' '${file}'&quot;</span>,</pre></li><li class="li1"><pre class="de1">                    logoutput <span class="sy0">=&gt;</span> <span class="kw2">true</span></pre></li><li class="li1"><pre class="de1">            <span class="br0">&#125;</span></pre></li><li class="li2"><pre class="de2">        <span class="br0">&#125;</span></pre></li><li class="li1"><pre class="de1">        absent&#160;: <span class="br0">&#123;</span></pre></li><li class="li1"><pre class="de1">            <span class="kw3">exec</span> <span class="br0">&#123;</span></pre></li><li class="li1"><pre class="de1">                <span class="st0">&quot;grep -vFx '${line}' '${file}' | tee '${file}' &gt; /dev/null 2&gt;&amp;1&quot;</span>&#160;:</pre></li><li class="li1"><pre class="de1">                    onlyif <span class="sy0">=&gt;</span> <span class="st0">&quot;grep -qFx '${line}' '${file}'&quot;</span>,</pre></li><li class="li2"><pre class="de2">                    logoutput <span class="sy0">=&gt;</span> <span class="kw2">true</span></pre></li><li class="li1"><pre class="de1">            <span class="br0">&#125;</span></pre></li><li class="li1"><pre class="de1">        <span class="br0">&#125;</span></pre></li><li class="li1"><pre class="de1">        uncomment&#160;: <span class="br0">&#123;</span></pre></li><li class="li1"><pre class="de1">            <span class="kw3">exec</span> <span class="br0">&#123;</span></pre></li><li class="li2"><pre class="de2">                <span class="st0">&quot;sed -i -e'/${line}/s/#<span class="es0">\+</span>//' '${file}'&quot;</span>&#160;:</pre></li><li class="li1"><pre class="de1">                    onlyif <span class="sy0">=&gt;</span> <span class="st0">&quot;test `grep '${line}' '${file}' | grep '^#' | wc -l` -ne 0&quot;</span>,</pre></li><li class="li1"><pre class="de1">                    logoutput <span class="sy0">=&gt;</span> <span class="kw2">true</span></pre></li><li class="li1"><pre class="de1">            <span class="br0">&#125;</span></pre></li><li class="li1"><pre class="de1">        <span class="br0">&#125;</span></pre></li><li class="li2"><pre class="de2">        comment&#160;: <span class="br0">&#123;</span></pre></li><li class="li1"><pre class="de1">            <span class="kw3">exec</span> <span class="br0">&#123;</span></pre></li><li class="li1"><pre class="de1">                <span class="st0">&quot;/bin/sed -i -e'/${line}/s/<span class="es0">\(</span>.<span class="es0">\+</span><span class="es0">\)</span>$/#<span class="es0">\1</span>/' '${file}'&quot;</span>&#160;:</pre></li><li class="li1"><pre class="de1">                    onlyif <span class="sy0">=&gt;</span> <span class="st0">&quot;test `grep '${line}' '${file}' | grep -v '^#' | wc -l` -ne 0&quot;</span>,</pre></li><li class="li1"><pre class="de1">                    logoutput <span class="sy0">=&gt;</span> <span class="kw2">true</span></pre></li><li class="li2"><pre class="de2">            <span class="br0">&#125;</span></pre></li><li class="li1"><pre class="de1">        <span class="br0">&#125;</span></pre></li><li class="li1"><pre class="de1">&#160;</pre></li><li class="li1"><pre class="de1">        <span class="co1"># Use this resource instead if your platform's grep doesn't support -vFx;</span></pre></li><li class="li1"><pre class="de1">        <span class="co1"># note that this command has been known to have problems with lines containing quotes.</span></pre></li><li class="li2"><pre class="de2">        <span class="co1"># exec { &quot;/usr/bin/perl -ni -e 'print unless /^\\Q${line}\\E\$/' '${file}'&quot;:</span></pre></li><li class="li1"><pre class="de1">        <span class="co1">#     onlyif =&gt; &quot;grep -qFx '${line}' '${file}'&quot;</span></pre></li><li class="li1"><pre class="de1">        <span class="co1"># }</span></pre></li><li class="li1"><pre class="de1">&#160;</pre></li><li class="li1"><pre class="de1">    <span class="br0">&#125;</span></pre></li><li class="li2"><pre class="de2"><span class="br0">&#125;</span></pre></li><li class="li1"><pre class="de1">&#160;</pre></li><li class="li1"><pre class="de1"><span class="co1"># Validate that softwares are installed</span></pre></li><li class="li1 ln-xtra"><pre class="de1">define comment_lines <span class="br0">&#40;</span>$filename<span class="br0">&#41;</span> <span class="br0">&#123;</span></pre></li><li class="li1"><pre class="de1">    line <span class="br0">&#123;</span></pre></li><li class="li2"><pre class="de2">        <span class="st0">&quot;${name}&quot;</span>&#160;:</pre></li><li class="li1"><pre class="de1">            file <span class="sy0">=&gt;</span> <span class="st0">&quot;${filename}&quot;</span>,</pre></li><li class="li1"><pre class="de1">            line <span class="sy0">=&gt;</span> <span class="st0">&quot;${name}&quot;</span>,</pre></li><li class="li1"><pre class="de1">            <span class="kw1">ensure</span> <span class="sy0">=&gt;</span> comment</pre></li><li class="li1"><pre class="de1">    <span class="br0">&#125;</span></pre></li><li class="li2"><pre class="de2"><span class="br0">&#125;</span></pre></li><li class="li1"><pre class="de1">&#160;</pre></li><li class="li1"><pre class="de1"><span class="co1"># Sysctl managment</span></pre></li><li class="li1 ln-xtra"><pre class="de1"><span class="kw1">class</span> sysctl <span class="br0">&#123;</span></pre></li><li class="li1"><pre class="de1">    define conf <span class="br0">&#40;</span>$value<span class="br0">&#41;</span> <span class="br0">&#123;</span></pre></li><li class="li2"><pre class="de2">    <span class="co1"># $name is provided by define invocation</span></pre></li><li class="li1"><pre class="de1">    <span class="co1"># guid of this entry</span></pre></li><li class="li1"><pre class="de1">        <span class="re0">$key</span> = <span class="re0">$name</span></pre></li><li class="li1"><pre class="de1">        <span class="re0">$context</span> = <span class="st0">&quot;/files/etc/sysctl.conf&quot;</span></pre></li><li class="li1"><pre class="de1">        augeas <span class="br0">&#123;</span></pre></li><li class="li2"><pre class="de2">            <span class="st0">&quot;sysctl_conf/$key&quot;</span>&#160;:</pre></li><li class="li1"><pre class="de1">                context <span class="sy0">=&gt;</span> <span class="st0">&quot;$context&quot;</span>,</pre></li><li class="li1"><pre class="de1">                onlyif <span class="sy0">=&gt;</span> <span class="st0">&quot;get $key&#160;!= '$value'&quot;</span>,</pre></li><li class="li1"><pre class="de1">                changes <span class="sy0">=&gt;</span> <span class="st0">&quot;set $key '$value'&quot;</span>,</pre></li><li class="li1"><pre class="de1">                notify <span class="sy0">=&gt;</span> <span class="kw3">Exec</span><span class="br0">&#91;</span><span class="st0">&quot;sysctl&quot;</span><span class="br0">&#93;</span>,</pre></li><li class="li2"><pre class="de2">        <span class="br0">&#125;</span></pre></li><li class="li1"><pre class="de1">    <span class="br0">&#125;</span></pre></li><li class="li1"><pre class="de1">    file <span class="br0">&#123;</span></pre></li><li class="li1"><pre class="de1">        <span class="st0">&quot;sysctl_conf&quot;</span>&#160;:</pre></li><li class="li1"><pre class="de1">            name <span class="sy0">=&gt;</span> $::operatingsystem&#160;? <span class="br0">&#123;</span></pre></li><li class="li2"><pre class="de2">                default <span class="sy0">=&gt;</span> <span class="st0">&quot;/etc/sysctl.conf&quot;</span>,</pre></li><li class="li1"><pre class="de1">            <span class="br0">&#125;</span>,</pre></li><li class="li1"><pre class="de1">    <span class="br0">&#125;</span></pre></li><li class="li1"><pre class="de1">    <span class="kw3">exec</span> <span class="br0">&#123;</span></pre></li><li class="li1"><pre class="de1">        <span class="st0">&quot;sysctl -p&quot;</span>&#160;:</pre></li><li class="li2"><pre class="de2">            <span class="kw1">alias</span> <span class="sy0">=&gt;</span> <span class="st0">&quot;sysctl&quot;</span>,</pre></li><li class="li1"><pre class="de1">            refreshonly <span class="sy0">=&gt;</span> <span class="kw2">true</span>,</pre></li><li class="li1"><pre class="de1">            subscribe <span class="sy0">=&gt;</span> <span class="kw4">File</span><span class="br0">&#91;</span><span class="st0">&quot;sysctl_conf&quot;</span><span class="br0">&#93;</span>,</pre></li><li class="li1"><pre class="de1">    <span class="br0">&#125;</span></pre></li><li class="li1"><pre class="de1"><span class="br0">&#125;</span></pre></li><li class="li2"><pre class="de2">&#160;</pre></li><li class="li1"><pre class="de1"><span class="co1"># Function to add ssh public keys</span></pre></li><li class="li1 ln-xtra"><pre class="de1">define ssh_add_key <span class="br0">&#40;</span>$user, <span class="re0">$key</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></pre></li><li class="li1"><pre class="de1">   <span class="co1"># Create users home directory if absent</span></pre></li><li class="li1"><pre class="de1">   <span class="kw3">exec</span> <span class="br0">&#123;</span></pre></li><li class="li2"><pre class="de2">      <span class="st0">&quot;mkhomedir_${name}&quot;</span>&#160;:</pre></li><li class="li1"><pre class="de1">         path <span class="sy0">=&gt;</span> <span class="st0">&quot;/bin:/usr/bin&quot;</span>,</pre></li><li class="li1"><pre class="de1">         command <span class="sy0">=&gt;</span> <span class="st0">&quot;cp -Rfp /etc/skel ~$user; chown -Rf $user:group ~$user&quot;</span>,</pre></li><li class="li1"><pre class="de1">         onlyif <span class="sy0">=&gt;</span> <span class="st0">&quot;test `ls ~$user 2&gt;&amp;1 &gt;/dev/null | wc -l` -ne 0&quot;</span></pre></li><li class="li1"><pre class="de1">   <span class="br0">&#125;</span>   </pre></li><li class="li2"><pre class="de2">&#160;</pre></li><li class="li1"><pre class="de1">   ssh_authorized_key <span class="br0">&#123;</span></pre></li><li class="li1"><pre class="de1">      <span class="st0">&quot;${name}&quot;</span>&#160;:</pre></li><li class="li1"><pre class="de1">         <span class="kw1">ensure</span> <span class="sy0">=&gt;</span> present,</pre></li><li class="li1"><pre class="de1">         key <span class="sy0">=&gt;</span> <span class="st0">&quot;$key&quot;</span>,</pre></li><li class="li2"><pre class="de2">         type <span class="sy0">=&gt;</span> <span class="st0">'ssh-rsa'</span>,</pre></li><li class="li1"><pre class="de1">         user <span class="sy0">=&gt;</span> <span class="st0">&quot;$user&quot;</span>,</pre></li><li class="li1"><pre class="de1">         <span class="kw3">require</span> <span class="sy0">=&gt;</span> <span class="kw3">Exec</span><span class="br0">&#91;</span><span class="st0">&quot;mkhomedir_${name}&quot;</span><span class="br0">&#93;</span></pre></li><li class="li1"><pre class="de1">   <span class="br0">&#125;</span>   </pre></li><li class="li1"><pre class="de1"><span class="br0">&#125;</span></pre></li><li class="li2"><pre class="de2">&#160;</pre></li><li class="li1"><pre class="de1"><span class="co1"># Limits.conf managment</span></pre></li><li class="li1 ln-xtra"><pre class="de1">define limits_conf <span class="br0">&#40;</span>$domain = <span class="st0">&quot;root&quot;</span>, <span class="re0">$type</span> = <span class="st0">&quot;soft&quot;</span>,$item = <span class="st0">&quot;nofile&quot;</span>,	<span class="re0">$value</span> = <span class="st0">&quot;10000&quot;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></pre></li><li class="li1"><pre class="de1">    <span class="co1"># guid of this entry</span></pre></li><li class="li1"><pre class="de1">    <span class="re0">$key</span> = <span class="st0">&quot;$domain/$type/$item&quot;</span></pre></li><li class="li2"><pre class="de2">&#160;</pre></li><li class="li1"><pre class="de1">    <span class="co1"># augtool&gt; match /files/etc/security/limits.conf/domain[.=&quot;root&quot;][./type=&quot;hard&quot; and ./item=&quot;nofile&quot; and ./value=&quot;10000&quot;]</span></pre></li><li class="li1"><pre class="de1">    <span class="re0">$context</span> = <span class="st0">&quot;/files/etc/security/limits.conf&quot;</span></pre></li><li class="li1"><pre class="de1">    <span class="re0">$path_list</span> = <span class="st0">&quot;domain[.=<span class="es0">\&quot;</span>$domain<span class="es0">\&quot;</span>][./type=<span class="es0">\&quot;</span>$type<span class="es0">\&quot;</span> and ./item=<span class="es0">\&quot;</span>$item<span class="es0">\&quot;</span>]&quot;</span></pre></li><li class="li1"><pre class="de1">    <span class="re0">$path_exact</span> = <span class="st0">&quot;domain[.=<span class="es0">\&quot;</span>$domain<span class="es0">\&quot;</span>][./type=<span class="es0">\&quot;</span>$type<span class="es0">\&quot;</span> and ./item=<span class="es0">\&quot;</span>$item<span class="es0">\&quot;</span> and ./value=<span class="es0">\&quot;</span>$value<span class="es0">\&quot;</span>]&quot;</span></pre></li><li class="li2"><pre class="de2">&#160;</pre></li><li class="li1"><pre class="de1">    augeas <span class="br0">&#123;</span></pre></li><li class="li1"><pre class="de1">        <span class="st0">&quot;limits_conf/$key&quot;</span>&#160;:</pre></li><li class="li1"><pre class="de1">            context <span class="sy0">=&gt;</span> <span class="st0">&quot;$context&quot;</span>,</pre></li><li class="li1"><pre class="de1">            onlyif <span class="sy0">=&gt;</span> <span class="st0">&quot;match $path_exact size==0&quot;</span>,</pre></li><li class="li2"><pre class="de2">            changes <span class="sy0">=&gt;</span> <span class="br0">&#91;</span></pre></li><li class="li1"><pre class="de1">                <span class="co1"># remove all matching to the $domain, $type, $item, for any $value</span></pre></li><li class="li1"><pre class="de1">                <span class="st0">&quot;rm $path_list&quot;</span>,</pre></li><li class="li1"><pre class="de1">                <span class="co1"># insert new node at the end of tree</span></pre></li><li class="li1"><pre class="de1">                <span class="st0">&quot;set domain[last()+1] $domain&quot;</span>,</pre></li><li class="li2"><pre class="de2">                <span class="co1"># assign values to the new node</span></pre></li><li class="li1"><pre class="de1">                <span class="st0">&quot;set domain[last()]/type $type&quot;</span>,</pre></li><li class="li1"><pre class="de1">                <span class="st0">&quot;set domain[last()]/item $item&quot;</span>,</pre></li><li class="li1"><pre class="de1">                <span class="st0">&quot;set domain[last()]/value $value&quot;</span>,<span class="br0">&#93;</span>,</pre></li><li class="li1"><pre class="de1">    <span class="br0">&#125;</span></pre></li><li class="li2"><pre class="de2"><span class="br0">&#125;</span></pre></li></ol></div></div>
</td></tr></table><br />
<p>Nous avons donc&#160;:
</p>
<ul><li> Ligne 10&#160;: La possibilité de charger ou non des modules via un tableau envoyé en argument de fonction (comme décrit plus haut dans cette documentation)</li>
<li> Ligne 17&#160;: La possibilité de vérifier que des packages sont installés sur la machine</li>
<li> Ligne 26&#160;: La possibilité de vérifier que des services sont correctement chargés au boot de la machine</li>
<li> Ligne 34&#160;: La possibilité de s'assurer qu'une ligne d'un fichier est présente, absente, commentée ou non non commentée</li>
<li> Ligne 78&#160;: La possibilité de commenter plusieurs lignes via un tableau envoyé en argument de fonction</li>
<li> Ligne 88&#160;: La possibilité de gérer le fichier sysctl.conf</li>
<li> Ligne 117&#160;: La possibilité de déployer facilement des clefs publiques SSH</li>
<li> Ligne 128&#160;: La possibilité de gérer simplement le fichier limits.conf</li></ul>
<p>Toutes ses fonctions ne sont bien entendues pas obligatoires mais aident grandement à l'utilisation de puppet.
</p>
<h3><span class="mw-headline" id="roles.pp"><span class="mw-headline-number">6.2.4</span> roles.pp</span></h3>
<p>Ensuite nous avons un fichier contenant le rôles des serveurs. Voyez ça plutôt comme des groupes auxquels nous allons faire souscrire les serveurs&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/base/manifests/roles.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="co1">################################################################################</span>
<span class="co1">#                                   ROLES                                      #</span>
<span class="co1">################################################################################</span>
&#160;
<span class="co1"># Level 1&#160;: Minimal</span>
<span class="kw1">class</span> base::minimal
<span class="br0">&#123;</span>
    <span class="co1"># Load modules</span>
    <span class="re0">$minimal_modules</span> =
    <span class="br0">&#91;</span>
        <span class="st0">'stdlib'</span>,
        <span class="st0">'puppet'</span>,
        <span class="st0">'resolvconf'</span>,
        <span class="st0">'packages_defaults'</span>,
        <span class="st0">'configurations_defaults'</span>,
        <span class="st0">'openssh'</span>,
        <span class="st0">'selinux'</span>,
        <span class="st0">'grub'</span>,
        <span class="st0">'kdump'</span>,
        <span class="st0">'tools'</span>,
        <span class="st0">'timezone'</span>,
        <span class="st0">'ntp'</span>,
        <span class="st0">'mysecureshell'</span>,
        <span class="st0">'openldap'</span>,
        <span class="st0">'acl'</span>,
        <span class="st0">'sudo'</span>,
        <span class="st0">'snmpd'</span>,
        <span class="st0">'postfix'</span>,
        <span class="st0">'nrpe'</span>
    <span class="br0">&#93;</span>
    include_modules<span class="br0">&#123;</span> <span class="re0">$minimal_modules</span>: <span class="br0">&#125;</span>
<span class="br0">&#125;</span>
&#160;
<span class="co1"># Level 2&#160;: Cluster</span>
<span class="kw1">class</span> base::cluster inherits minimal
<span class="br0">&#123;</span>
    <span class="co1"># Load modules</span>
    <span class="re0">$cluster_modules</span> =
    <span class="br0">&#91;</span>
        <span class="st0">'packages_cluster'</span>,
        <span class="st0">'configurations_cluster'</span>
    <span class="br0">&#93;</span>
    include_modules<span class="br0">&#123;</span> <span class="re0">$cluster_modules</span>: <span class="br0">&#125;</span>
<span class="br0">&#125;</span>
&#160;
<span class="co1"># Level 2&#160;: Low Latency</span>
<span class="kw1">class</span> base::low_latency inherits minimal
<span class="br0">&#123;</span>
    <span class="co1"># Load modules</span>
    <span class="re0">$lowlatency_modules</span> =
    <span class="br0">&#91;</span>
        <span class="st0">'low_latency'</span>
    <span class="br0">&#93;</span>
    include_modules<span class="br0">&#123;</span> <span class="re0">$lowlatency_modules</span>: <span class="br0">&#125;</span>
<span class="br0">&#125;</span>
&#160;
<span class="co1"># Level 3&#160;: Low Latency + Cluster</span>
<span class="kw1">class</span> base::low_latency_cluster inherits minimal
<span class="br0">&#123;</span>
    <span class="kw1">include</span> base::cluster
    <span class="kw1">include</span> base::low_latency
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<p>J'ai donc définit ici des classes qui héritent plus ou moins entre elles. C'est en fait définit par niveaux. Le niveau 3 dépends du 2 et 1, le 2 du 1 et le 1 n'a pas de dépendances. Cela me permet d'avoir une certaine souplesse. Je sais par exemple ici que si je charge ma classe cluster, ma classe minimal sera également chargée. Vous noterez l'annotation 'base::minimal'. Il est recommandé de charger ses classes en appelant le module, suivit de '::'. Cela facilite grandement la lecture des manifests.
</p>
<h3><span class="mw-headline" id="servers.pp"><span class="mw-headline-number">6.2.5</span> servers.pp</span></h3>
<p>Et pour finir, j'ai un fichier ou je fais ma déclaration de serveurs&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/base/manifests/servers.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="sy0">/*</span><span class="co1">##############################################################################</span>
<span class="co1">#                                     SERVERS                                  #</span>
<span class="co1">################################################################################</span>
&#160;
== Automated Dependancies Roles ==
<span class="sy0">*</span> cluster <span class="sy0">-&gt;</span> minimal
<span class="sy0">*</span> low_latency <span class="sy0">-&gt;</span> minimal
<span class="sy0">*</span> low_latency_cluster <span class="sy0">-&gt;</span> low_latency <span class="sy0">+</span> cluster <span class="sy0">+</span> minimal
&#160;
== Template <span class="kw1">for</span> servers ==
node <span class="sy0">/</span>regex<span class="sy0">/</span> 
<span class="br0">&#123;</span>
    <span class="co1">#$exclude_modules = [ ]</span>
    <span class="co1">#$ldap_servers = 'x.x.x.x'</span>
    <span class="co1">#$set_timezone = 'Europe/Paris'</span>
    <span class="co1">#$dns_servers = [ ]</span>
    <span class="co1">#include base::minimal</span>
    <span class="co1">#include base::cluster</span>
    <span class="co1">#include base::low_latency</span>
    <span class="co1">#include base::low_latency_cluster</span>
<span class="br0">&#125;</span>
&#160;
<span class="co1">##############################################################################*/</span>
&#160;
<span class="co1"># One server</span>
node <span class="st0">'srv1.deimos.fr'</span>  <span class="br0">&#123;</span>
    <span class="re0">$ldap_servers</span> = <span class="br0">&#91;</span> <span class="st0">'127.0.0.1'</span> <span class="br0">&#93;</span>
    <span class="kw1">include</span> base::minimal
<span class="br0">&#125;</span>
&#160;
<span class="co1"># Multiple servers</span>
node <span class="st0">'srv2.deimos.fr'</span> <span class="st0">'srv3.deimos.fr'</span>  <span class="br0">&#123;</span>
    <span class="re0">$ldap_servers</span> = <span class="br0">&#91;</span> <span class="st0">'127.0.0.1'</span> <span class="br0">&#93;</span>
    <span class="kw1">include</span> base::minimal
<span class="br0">&#125;</span>
&#160;
<span class="co1"># Multiple regex based servers</span>
node <span class="sy0">/</span>srv<span class="sy0">-</span>prd<span class="sy0">-</span>\d<span class="sy0">+/</span> <span class="br0">&#123;</span>
    <span class="kw1">include</span> base::minimal
    <span class="kw1">include</span> base::low_latency
    <span class="re0">$set_timezone</span> = <span class="st0">'Europe/London'</span>
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<p>Ici j'ai mis un serveur en exemple ou une regex pour plusieurs serveurs. Pour info, la configuration peut être intégrée dans <a rel="nofollow" class="external text" href="http://reductivelabs.com/trac/puppet/wiki/LDAPNodes">LDAP</a>.
</p>
<h3><span class="mw-headline" id="Parser"><span class="mw-headline-number">6.2.6</span> Parser</span></h3>
<p>Nous allons créer l'arborescence nécessaire&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> mkdir</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="bash source-bash"><pre class="de1"><span class="kw2">mkdir</span> <span class="re5">-p</span> <span class="sy0">/</span>etc<span class="sy0">/</span>puppet<span class="sy0">/</span>modules<span class="sy0">/</span>base<span class="sy0">/</span>puppet<span class="sy0">/</span>parser<span class="sy0">/</span>functions</pre></div></div>
</td></tr></table><br />
<p>Puis ajoutez un parser empty qui nous permettra de détecter si un tableau/une variable est vide ou non&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/base/puppet/parser/functions/empty.rb</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="co1">#</span>
<span class="co1"># empty.rb</span>
<span class="co1">#</span>
<span class="co1"># Copyright 2011 Puppet Labs Inc.</span>
<span class="co1"># Copyright 2011 Krzysztof Wilczynski</span>
<span class="co1">#</span>
<span class="co1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="co1"># you may not use this file except in compliance with the License.</span>
<span class="co1"># You may obtain a copy of the License at</span>
<span class="co1">#</span>
<span class="co1"># http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="co1">#</span>
<span class="co1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="co1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="co1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="co1"># See the License for the specific language governing permissions and</span>
<span class="co1"># limitations under the License.</span>
<span class="co1">#</span>
&#160;
<span class="kw1">module</span> <span class="re2">Puppet::Parser::Functions</span>
  newfunction<span class="br0">&#40;</span><span class="re3">:empty</span>, <span class="re3">:type</span> <span class="sy0">=&gt;</span> <span class="re3">:rvalue</span>, <span class="re3">:doc</span> <span class="sy0">=&gt;</span> <span class="sy0">&lt;&lt;-</span>EOS
Returns <span class="kw2">true</span> <span class="kw1">if</span> given <span class="kw3">array</span> type <span class="kw1">or</span> hash type has no elements <span class="kw1">or</span> <span class="kw1">when</span> a <span class="kw3">string</span>
value is empty <span class="kw1">and</span> <span class="kw2">false</span> otherwise.
&#160;
<span class="me1">Prototype</span>:
&#160;
empty<span class="br0">&#40;</span>x<span class="br0">&#41;</span>
&#160;
Where x is either an <span class="kw3">array</span>, a hash <span class="kw1">or</span> a <span class="kw3">string</span> value.
&#160;
<span class="kw1">For</span> example:
&#160;
Given the following statements:
&#160;
<span class="re0">$a</span> = <span class="st0">''</span>
<span class="re0">$b</span> = <span class="st0">'abc'</span>
<span class="re0">$c</span> = <span class="br0">&#91;</span><span class="br0">&#93;</span>
<span class="re0">$d</span> = <span class="br0">&#91;</span><span class="st0">'d'</span>, <span class="st0">'e'</span>, <span class="st0">'f'</span><span class="br0">&#93;</span>
<span class="re0">$e</span> = <span class="br0">&#123;</span><span class="br0">&#125;</span>
<span class="re0">$f</span> = <span class="br0">&#123;</span> <span class="st0">'x'</span> <span class="sy0">=&gt;</span> <span class="nu0">1</span>, <span class="st0">'y'</span> <span class="sy0">=&gt;</span> <span class="nu0">2</span>, <span class="st0">'z'</span> <span class="sy0">=&gt;</span> <span class="nu0">3</span> <span class="br0">&#125;</span>
&#160;
notice empty<span class="br0">&#40;</span>$a<span class="br0">&#41;</span>
notice empty<span class="br0">&#40;</span>$b<span class="br0">&#41;</span>
notice empty<span class="br0">&#40;</span>$c<span class="br0">&#41;</span>
notice empty<span class="br0">&#40;</span>$d<span class="br0">&#41;</span>
notice empty<span class="br0">&#40;</span>$e<span class="br0">&#41;</span>
notice empty<span class="br0">&#40;</span>$f<span class="br0">&#41;</span>
&#160;
The result will be as follows:
&#160;
notice: Scope<span class="br0">&#40;</span><span class="kw1">Class</span><span class="br0">&#91;</span>main<span class="br0">&#93;</span><span class="br0">&#41;</span>: <span class="kw2">true</span>
notice: Scope<span class="br0">&#40;</span><span class="kw1">Class</span><span class="br0">&#91;</span>main<span class="br0">&#93;</span><span class="br0">&#41;</span>: <span class="kw2">false</span>
notice: Scope<span class="br0">&#40;</span><span class="kw1">Class</span><span class="br0">&#91;</span>main<span class="br0">&#93;</span><span class="br0">&#41;</span>: <span class="kw2">true</span>
notice: Scope<span class="br0">&#40;</span><span class="kw1">Class</span><span class="br0">&#91;</span>main<span class="br0">&#93;</span><span class="br0">&#41;</span>: <span class="kw2">false</span>
notice: Scope<span class="br0">&#40;</span><span class="kw1">Class</span><span class="br0">&#91;</span>main<span class="br0">&#93;</span><span class="br0">&#41;</span>: <span class="kw2">true</span>
notice: Scope<span class="br0">&#40;</span><span class="kw1">Class</span><span class="br0">&#91;</span>main<span class="br0">&#93;</span><span class="br0">&#41;</span>: <span class="kw2">false</span>
EOS
  <span class="br0">&#41;</span> <span class="kw1">do</span> <span class="sy0">|*</span>arguments<span class="sy0">|</span>
    <span class="co1">#</span>
    <span class="co1"># This is to ensure that whenever we call this function from within</span>
    <span class="co1"># the Puppet manifest or alternatively form a template it will always</span>
    <span class="co1"># do the right thing ...</span>
    <span class="co1">#</span>
    arguments = arguments.<span class="me1">shift</span> <span class="kw1">if</span> arguments.<span class="me1">first</span>.<span class="me1">is_a</span>?<span class="br0">&#40;</span><span class="kw3">Array</span><span class="br0">&#41;</span>
&#160;
    <span class="kw3">raise</span> <span class="re2">Puppet::ParseError</span>, <span class="st0">&quot;empty(): Wrong number of arguments &quot;</span> <span class="sy0">+</span>
      <span class="st0">&quot;given (#{arguments.size} for 1)&quot;</span> <span class="kw1">if</span> arguments.<span class="me1">size</span> <span class="sy0">&lt;</span> <span class="nu0">1</span>
&#160;
    value = arguments.<span class="me1">shift</span>
&#160;
    <span class="kw1">unless</span> <span class="br0">&#91;</span><span class="kw3">Array</span>, <span class="kw4">Hash</span>, <span class="kw3">String</span><span class="br0">&#93;</span>.<span class="kw1">include</span>?<span class="br0">&#40;</span>value.<span class="kw1">class</span><span class="br0">&#41;</span>
      <span class="kw3">raise</span> <span class="re2">Puppet::ParseError</span>, <span class="st0">'empty(): Requires either array, hash '</span> <span class="sy0">+</span>
        <span class="st0">'or string type to work with'</span>
    <span class="kw1">end</span>
&#160;
    value.<span class="me1">empty</span>?
  <span class="kw1">end</span>
<span class="kw1">end</span>
&#160;
<span class="co1"># vim: set ts=2 sw=2 et&#160;:</span>
<span class="co1"># encoding: utf-8</span></pre></div></div>
</td></tr></table><br />
<h1><span class="mw-headline" id="Exemples_de_modules"><span class="mw-headline-number">7</span> Exemples de modules</span></h1>
<h2><span class="mw-headline" id="stdlib"><span class="mw-headline-number">7.1</span> stdlib</span></h2>
<p>Ce module <a rel="nofollow" class="external text" href="http://forge.puppetlabs.com/puppetlabs/stdlib">stdlib</a> n'est pas indispensable, mais il est utile si vous manquez de fonctionnalités dans Puppet. En effet, il apporte un lot assez important de fonctions&#160;:
</p>
<pre>
abs		     ensure_resource	  include	       loadyaml		    reverse		 to_bytes
bool2num	     err		  info		       lstrip		    rstrip		 type
capitalize	     extlookup		  inline_template      md5		    search		 unique
chomp		     fail		  is_array	       member		    sha1		 upcase
chop		     file		  is_domain_name       merge		    shellquote		 validate_absolute_pa
create_resources     flatten		  is_float	       notice		    size		 validate_array
crit		     fqdn_rand		  is_hash	       num2bool		    sort		 validate_bool
debug		     fqdn_rotate	  is_integer	       parsejson	    squeeze		 validate_hash
defined		     generate		  is_ip_address	       parseyaml	    str2bool		 validate_re
defined_with_params  get_module_path	  is_mac_address       prefix		    str2saltedsha512	 validate_slength
delete		     getvar		  is_numeric	       range		    strftime		 validate_string
delete_at	     grep		  is_string	       realize		    strip		 values
downcase	     has_key		  join		       regsubst		    swapcase		 values_at
emerg		     hash		  keys		       require		    time		 zip
empty
</pre>
<p>Créez d'abord l'arborescence&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> mkdir</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="bash source-bash"><pre class="de1"><span class="kw2">mkdir</span> <span class="re5">-p</span> <span class="sy0">/</span>etc<span class="sy0">/</span>puppet<span class="sy0">/</span>modules<span class="sy0">/</span>stdlib</pre></div></div>
</td></tr></table><br />
<p>Téléchargez la dernière version et décompressez là tout simplement&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> </font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">cd /etc/puppet/modules/stdlib
wget http://forge.puppetlabs.com/puppetlabs/stdlib/3.2.0.tar.gz
tar -xzf 3.2.0.tar.gz
mv puppetlabs-stdlib-3.2.0/stdlib stdlib
rm -f 3.2.0.tar.gz</pre></div></div>
</td></tr></table><br />
<h2><span class="mw-headline" id="Puppet"><span class="mw-headline-number">7.2</span> Puppet</span></h2>
<p>Celui ci est assez drôle car en fait il s'agit simplement de la configuration du client Puppet. Cependant, il peut s'avérer très utile pour sa gérer ses propres mises à jour. Nous allons donc créer les arborescences&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> mkdir</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="bash source-bash"><pre class="de1"><span class="kw2">mkdir</span> <span class="re5">-p</span> <span class="sy0">/</span>etc<span class="sy0">/</span>puppet<span class="sy0">/</span>modules<span class="sy0">/</span>puppet<span class="sy0">/</span><span class="br0">&#123;</span>manifests,files<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="init.pp_2"><span class="mw-headline-number">7.2.1</span> init.pp</span></h3>
<p>Nous créons ici le module init.pp qui va nous permettre selon l'OS de choisir le fichier à charger.
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/puppet/manifests/init.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="sy0">/*</span> 
Puppet <span class="kw1">Module</span> <span class="kw1">for</span> Puppet
Made by Pierre Mavro
<span class="sy0">*/</span>
<span class="kw1">class</span> puppet <span class="br0">&#123;</span>
<span class="co1"># Check OS and request the appropriate function</span>
    <span class="kw1">case</span> $::operatingsystem <span class="br0">&#123;</span>
        <span class="st0">'RedHat'</span>&#160;: <span class="br0">&#123;</span>
            <span class="kw1">include</span>&#160;::puppet::redhat
        <span class="br0">&#125;</span>
        <span class="co1">#'sunos':  { include packages_defaults::solaris }</span>
        default&#160;: <span class="br0">&#123;</span>
            notice<span class="br0">&#40;</span><span class="st0">&quot;Module ${module_name} is not supported on ${::operatingsystem}&quot;</span><span class="br0">&#41;</span>
        <span class="br0">&#125;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="redhat.pp"><span class="mw-headline-number">7.2.2</span> redhat.pp</span></h3>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/puppet/manifests/redhat.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="sy0">/*</span> 
Puppet <span class="kw1">Module</span> <span class="kw1">for</span> Puppet
Made by Pierre Mavro
<span class="sy0">*/</span>
<span class="kw1">class</span> puppet::redhat <span class="br0">&#123;</span>
    <span class="co1"># Change default configuration</span>
    file <span class="br0">&#123;</span>
        <span class="st0">'/etc/puppet/puppet.conf'</span>&#160;:
            <span class="kw1">ensure</span> <span class="sy0">=&gt;</span> present,
<span class="xtra ln-xtra">            source <span class="sy0">=&gt;</span> <span class="st0">&quot;puppet:///modules/puppet/${::osfamily}.puppet.conf&quot;</span>,</span>            mode <span class="sy0">=&gt;</span> <span class="nu0">644</span>,
            owner <span class="sy0">=&gt;</span> root,
            group <span class="sy0">=&gt;</span> root
    <span class="br0">&#125;</span>
&#160;
    <span class="co1"># Disable service on boot and be sure it is not started</span>
    service <span class="br0">&#123;</span>
        <span class="st0">'puppet-srv'</span>&#160;:
            name <span class="sy0">=&gt;</span> <span class="st0">'puppet'</span>,
            <span class="co1"># Let this line commented if you're using Puppet Dashboard</span>
            <span class="co1">#ensure =&gt; stopped,</span>
            enable <span class="sy0">=&gt;</span> <span class="kw2">false</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<p>A la ligne 9, nous utilisons une variable disponible dans les facts (côté client) pour qu'en fonction de la réponse, nous chargeons un fichier associé à à l'OS. Nous allons donc avoir un fichier de configuration accessible via Puppet sous la forme 'RedHat.puppet.conf'.<br />
Ensuite, le service, nous nous assurons qu'il soit bien stoppé au démarrage et qu'il est dans un état éteint pour le moment. En fait je ne souhaites pas que toutes les 30 minutes (valeur par défaut), il se déclenche et se synchronise, je trouve ça trop dangereux et préfère décider via d'autres mécanismes (SSH, Mcollective...) quant je souhaites qu'une synchronisation soit faite.
</p>
<h3><span class="mw-headline" id="files"><span class="mw-headline-number">7.2.3</span> files</span></h3>
<p>Dans files, nous allons avoir le fichier de configuration basique qui doit s'appliquer à toutes les machines de type RedHat&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/puppet/files/RedHat.puppet.conf</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">[main]
    # The Puppet log directory.
    # The default value is '$vardir/log'.
    logdir = /var/log/puppet
&#160;
    # Where Puppet PID files are kept.
    # The default value is '$vardir/run'.
    rundir = /var/run/puppet
&#160;
    # Where SSL certificates are kept.
    # The default value is '$confdir/ssl'.
    ssldir = $vardir/ssl
&#160;
    # Puppet master server
    server = puppet-prd.deimos.fr
&#160;
    # Add custom facts
    pluginsync = true
    pluginsource = puppet://$server/plugins
    factpath = /var/lib/puppet/lib/facter
&#160;
[agent]
    # The file in which puppetd stores a list of the classes
    # associated with the retrieved configuratiion.  Can be loaded in
    # the separate ``puppet`` executable using the ``--loadclasses``
    # option.
    # The default value is '$confdir/classes.txt'.
    classfile = $vardir/classes.txt
&#160;
    # Where puppetd caches the local configuration.  An
    # extension indicating the cache format is added automatically.
    # The default value is '$confdir/localconfig'.
    localconfig = $vardir/localconfig
&#160;
    # Reporting
    report = true
&#160;
    # Inspect reports for a compliance workflow
    archive_files = true</pre></div></div>
</td></tr></table><br />
<h2><span class="mw-headline" id="resolvconf"><span class="mw-headline-number">7.3</span> resolvconf</span></h2>
<p>J'ai fais ce module pour gérer le fichier de configuration resolv.conf. L'utilisation est assez simple, il va récupérer les informations des serveurs DNS resneigné dans le tableau disponible dans <a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#vars.pp">vars.pp du module base</a>. Renseignez donc les serveurs DNS par défaut&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/base/manifests/vars.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="co1"># Default DNS servers</span>
<span class="re0">$dns_servers</span> = <span class="br0">&#91;</span> <span class="st0">'192.168.0.69'</span>, <span class="st0">'192.168.0.27'</span> <span class="br0">&#93;</span></pre></div></div>
</td></tr></table><br />
<p>Vous pouvez surclasser ces valeurs directement au niveau d'un ou plusieurs noeuds si vous devez avoir des configuration spécifiques pour certains neouds (dans le fichier <a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#servers.pp">servers.pp du module base</a>)&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/base/manifests/servers.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="co1"># One server</span>
node <span class="st0">'srv.deimos.fr'</span> <span class="br0">&#123;</span>
    <span class="re0">$dns_servers</span> = <span class="br0">&#91;</span> <span class="st0">'127.0.0.1'</span> <span class="br0">&#93;</span>
    <span class="kw1">include</span> base::minimal
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<p>Créons l'arborescence&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> mkdir</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="bash source-bash"><pre class="de1"><span class="kw2">mkdir</span> <span class="re5">-p</span> <span class="sy0">/</span>etc<span class="sy0">/</span>puppet<span class="sy0">/</span>modules<span class="sy0">/</span>resolvconf<span class="sy0">/</span><span class="br0">&#123;</span>manifests,templates<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="init.pp_3"><span class="mw-headline-number">7.3.1</span> init.pp</span></h3>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/resolvconf/manifests/init.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="sy0">/*</span> 
Resolv.<span class="me1">conf</span> <span class="kw1">Module</span> <span class="kw1">for</span> Puppet
Made by Pierre Mavro
<span class="sy0">*/</span>
<span class="kw1">class</span> resolvconf <span class="br0">&#123;</span>
    <span class="co1"># Check OS and request the appropriate function</span>
    <span class="kw1">case</span> $::operatingsystem <span class="br0">&#123;</span>
        <span class="st0">'RedHat'</span>&#160;: <span class="br0">&#123;</span>
            <span class="kw1">include</span> resolvconf::redhat
        <span class="br0">&#125;</span>
        <span class="co1">#'sunos':  { include packages_defaults::solaris }</span>
        default&#160;: <span class="br0">&#123;</span>
            notice<span class="br0">&#40;</span><span class="st0">&quot;Module ${module_name} is not supported on ${::operatingsystem}&quot;</span><span class="br0">&#41;</span>
        <span class="br0">&#125;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="redhat.pp_2"><span class="mw-headline-number">7.3.2</span> redhat.pp</span></h3>
<p>Voici la configuration pour Red Hat, j'utilise ici un fichier template, qui se renseignera avec les informations présente dans le tableau $dns_servers&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/resolvconf/manifests/redhat.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="sy0">/*</span> 
Resolvconf <span class="kw1">Module</span> <span class="kw1">for</span> Puppet
Made by Pierre Mavro
<span class="sy0">*/</span>
<span class="kw1">class</span> resolvconf::redhat <span class="br0">&#123;</span>
    <span class="co1"># resolv.conf file</span>
    file <span class="br0">&#123;</span>
        <span class="st0">&quot;/etc/resolv.conf&quot;</span>&#160;:
            content <span class="sy0">=&gt;</span> template<span class="br0">&#40;</span><span class="st0">&quot;resolvconf/resolv.conf&quot;</span><span class="br0">&#41;</span>,
            mode <span class="sy0">=&gt;</span> <span class="nu0">744</span>,
            owner <span class="sy0">=&gt;</span> root,
            group <span class="sy0">=&gt;</span> root
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="templates"><span class="mw-headline-number">7.3.3</span> templates</span></h3>
<p>Et enfin mon fichier template resolv.conf&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/resolvconf/templates/resolv.conf</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"># Generated by Puppet
domain deimos.fr
search deimos.fr deimos.lan
<span class="sy0">&lt;%</span> dns_servers.<span class="me1">each</span> <span class="kw1">do</span> <span class="sy0">|</span>dnsval<span class="sy0">|</span> <span class="sy0">-%&gt;</span>
nameserver <span class="sy0">&lt;%</span>= dnsval <span class="sy0">%&gt;</span>
<span class="sy0">&lt;%</span> <span class="kw1">end</span> <span class="sy0">-%&gt;</span></pre></div></div>
</td></tr></table><br />
<p>Ici nous avons une boucle ruby qui va parcourir le tableau $dns_servers et qui va construire le fichier resolv.conf en insérant ligne par ligne 'nameserver' avec le serveur associé.
</p>
<h2><span class="mw-headline" id="packages_defaults"><span class="mw-headline-number">7.4</span> packages_defaults</span></h2>
<p>J'utilise se module pour qu'il installe ou désinstalle des packages dont j'ai absolument besoin sur toutes mes machines. Créons l’arborescence&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> mkdir</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="bash source-bash"><pre class="de1"><span class="kw2">mkdir</span> <span class="re5">-p</span> <span class="sy0">/</span>etc<span class="sy0">/</span>puppet<span class="sy0">/</span>modules<span class="sy0">/</span>packages_defaults<span class="sy0">/</span>manifests</pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="init.pp_4"><span class="mw-headline-number">7.4.1</span> init.pp</span></h3>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/packages_defaults/manifests/init.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="kw1">class</span> packages_defaults <span class="br0">&#123;</span>
<span class="co1"># Check OS and request the appropriate function</span>
    <span class="kw1">case</span> $::operatingsystem <span class="br0">&#123;</span>
        <span class="st0">'RedHat'</span>&#160;: <span class="br0">&#123;</span>
            <span class="kw1">include</span>&#160;::packages_defaults::redhat
        <span class="br0">&#125;</span>
        <span class="co1">#'sunos':  { include packages_defaults::solaris }</span>
        default&#160;: <span class="br0">&#123;</span>
            notice<span class="br0">&#40;</span><span class="st0">&quot;Module ${module_name} is not supported on ${::operatingsystem}&quot;</span><span class="br0">&#41;</span>
        <span class="br0">&#125;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="redhat.pp_3"><span class="mw-headline-number">7.4.2</span> redhat.pp</span></h3>
<p>J'aurais pu tout regroupé dans un seul bloc, mais par soucis de lisiblité sur les packages qui figurent dans la distribution et ceux que j'ai rajouté dans un repository custom, j'ai préféré faire une séparation&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/packages_defaults/manifests/redhat.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="co1"># Red Hat Defaults packages</span>
<span class="kw1">class</span> packages_defaults::redhat
<span class="br0">&#123;</span>
    <span class="co1"># Set all default packages (embended in distribution) that need to be installed</span>
    packages_install
    <span class="br0">&#123;</span> <span class="br0">&#91;</span>
        <span class="st0">'nc'</span>,
        <span class="st0">'tree'</span>,
        <span class="st0">'telnet'</span>,
        <span class="st0">'dialog'</span>,
        <span class="st0">'freeipmi'</span>,
        <span class="st0">'glibc-2.12-1.80.el6.i686'</span>
    <span class="br0">&#93;</span>: <span class="br0">&#125;</span>
&#160;
    <span class="co1"># Set all custom packages (not embended in distribution) that need to be installed</span>
    packages_install
    <span class="br0">&#123;</span> <span class="br0">&#91;</span>
        <span class="st0">'puppet'</span>,
        <span class="st0">'tmux'</span>
    <span class="br0">&#93;</span>: <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<h2><span class="mw-headline" id="configurations_defaults"><span class="mw-headline-number">7.5</span> configurations_defaults</span></h2>
<p>Ce module, tout comme le précédent est utilisé pour la configuration de l'OS livré en standard. Je souhaites en fait ici faire des ajustements sur des parties du système pure, sans vraiment rentrer sur un logiciel en particulier. Créons l'arborescence&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> mkdir</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="bash source-bash"><pre class="de1"><span class="kw2">mkdir</span> <span class="re5">-p</span> <span class="sy0">/</span>etc<span class="sy0">/</span>puppet<span class="sy0">/</span>modules<span class="sy0">/</span>configuration_defaults<span class="sy0">/</span><span class="br0">&#123;</span>manifests,templates,lib<span class="sy0">/</span>facter<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="init.pp_5"><span class="mw-headline-number">7.5.1</span> init.pp</span></h3>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/configuration_defaults/manifests/init.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="kw1">class</span> configurations_defaults <span class="br0">&#123;</span>
    import <span class="st0">'*.pp'</span>
&#160;
    <span class="co1"># Configure common security parameters</span>
    <span class="kw1">include</span> configurations_defaults::common
&#160;
    <span class="co1"># Check OS and request the appropriate function</span>
    <span class="kw1">case</span> $::operatingsystem <span class="br0">&#123;</span>
        <span class="st0">'RedHat'</span>&#160;: <span class="br0">&#123;</span>
            <span class="kw1">include</span> configurations_defaults::redhat
        <span class="br0">&#125;</span>
        default&#160;: <span class="br0">&#123;</span>
            notice<span class="br0">&#40;</span><span class="st0">&quot;Module ${module_name} is not supported on ${::operatingsystem}&quot;</span><span class="br0">&#41;</span>
        <span class="br0">&#125;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<p>Ici je viens charger tous les fichiers .pp au démarrage, puis appelle importe les configuration communes (common), ensuite j'applique les configurations spécifiques à chaque OS.
</p>
<h3><span class="mw-headline" id="common.pp_2"><span class="mw-headline-number">7.5.2</span> common.pp</span></h3>
<p>Ici je souhaites avoir la même base de fichier motd pour toutes mes machines. Vous verrez par la suite pourquoi il figure en tant que template&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/configuration_defaults/manifests/common.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="kw1">class</span> configurations_defaults::common
<span class="br0">&#123;</span>
    <span class="co1"># Motd banner for all servers</span>
    file <span class="br0">&#123;</span>
        <span class="st0">'/etc/motd'</span>:
            <span class="kw1">ensure</span> <span class="sy0">=&gt;</span> present,
            content <span class="sy0">=&gt;</span> template<span class="br0">&#40;</span><span class="st0">&quot;configurations_defaults/motd&quot;</span><span class="br0">&#41;</span>,
            mode <span class="sy0">=&gt;</span> <span class="nu0">644</span>,
            owner <span class="sy0">=&gt;</span> root,
            group <span class="sy0">=&gt;</span> root
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="redhat.pp_4"><span class="mw-headline-number">7.5.3</span> redhat.pp</span></h3>
<p>Je vais ici charger des options de sécurité, configurer automatiquement le bonding sur mes machines et une option de sysctl&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/configuration_defaults/manifests/redhat.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="kw1">class</span> configurations_defaults::redhat
<span class="br0">&#123;</span>
    <span class="co1"># Security configurations</span>
    <span class="kw1">include</span> <span class="st0">'configurations_defaults::redhat::security'</span>
&#160;
    <span class="co1"># Configure bonding</span>
    <span class="kw1">include</span> <span class="st0">'configurations_defaults::redhat::network'</span>
&#160;
    <span class="co1"># Set sysctl options</span>
    sysctl::conf
    <span class="br0">&#123;</span>   
        <span class="st0">'vm.swappiness'</span>: value <span class="sy0">=&gt;</span> <span class="st0">'0'</span>;
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="security.pp"><span class="mw-headline-number">7.5.4</span> security.pp</span></h3>
<p>Vous allez voir que ce fichier fait pas mal de choses&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/configuration_defaults/manifests/security.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="kw1">class</span> configurations_defaults::redhat::security inherits configurations_defaults::redhat
<span class="br0">&#123;</span>
<span class="xtra ln-xtra">    <span class="co1"># Manage Root passwords</span></span>    <span class="re0">$sha512_passwd</span>=<span class="st0">'$6$lhkAz...'</span>
    <span class="re0">$md5_passwd</span>=<span class="st0">'$1$Fcwy...'</span>
&#160;
    <span class="kw1">if</span> <span class="br0">&#40;</span>$::passwd_algorithm == sha512<span class="br0">&#41;</span>
    <span class="br0">&#123;</span>
        <span class="co1"># sha512 root password</span>
        <span class="re0">$root_password</span>=<span class="st0">&quot;$sha512_passwd&quot;</span>
    <span class="br0">&#125;</span>
    <span class="kw1">else</span>
    <span class="br0">&#123;</span>
        <span class="co1"># MD5 root password</span>
        <span class="re0">$root_password</span>=<span class="st0">&quot;$md5_passwd&quot;</span>
    <span class="br0">&#125;</span>
    user <span class="br0">&#123;</span>
        <span class="st0">'root'</span>:
            <span class="kw1">ensure</span>   <span class="sy0">=&gt;</span> present,
            password <span class="sy0">=&gt;</span> <span class="st0">&quot;$root_password&quot;</span>
    <span class="br0">&#125;</span>
&#160;
<span class="xtra ln-xtra">    <span class="co1"># Enable auditd service</span></span>    service <span class="br0">&#123;</span>
        <span class="st0">&quot;auditd&quot;</span>&#160;:
            enable <span class="sy0">=&gt;</span> <span class="kw2">true</span>,
            <span class="kw1">ensure</span> <span class="sy0">=&gt;</span> <span class="st0">'running'</span>,
    <span class="br0">&#125;</span>
&#160;
<span class="xtra ln-xtra">    <span class="co1"># Comment unwanted sysctl lines</span></span>    <span class="re0">$sysctl_file</span> = <span class="st0">'/etc/sysctl.conf'</span>
    <span class="re0">$sysctl_comment_lines</span> =
    <span class="br0">&#91;</span>
        <span class="st0">&quot;net.bridge.bridge-nf-call-ip6tables&quot;</span>,
        <span class="st0">&quot;net.bridge.bridge-nf-call-iptables&quot;</span>,
        <span class="st0">&quot;net.bridge.bridge-nf-call-arptables&quot;</span>
    <span class="br0">&#93;</span>
    comment_lines <span class="br0">&#123;</span>
        <span class="re0">$sysctl_comment_lines</span>&#160;:
            filename <span class="sy0">=&gt;</span> <span class="st0">&quot;$sysctl_file&quot;</span>
    <span class="br0">&#125;</span>
&#160;
<span class="xtra ln-xtra">    <span class="co1"># Add security sysctl values</span></span>    sysctl::conf
    <span class="br0">&#123;</span>
        <span class="st0">'vm.mmap_min_addr'</span>: value <span class="sy0">=&gt;</span> <span class="st0">'65536'</span>;
        <span class="st0">'kernel.modprobe'</span>: value <span class="sy0">=&gt;</span> <span class="st0">'/bin/false'</span>;
        <span class="st0">'kernel.kptr_restrict'</span>: value <span class="sy0">=&gt;</span> <span class="st0">'1'</span>;
        <span class="st0">'net.ipv6.conf.all.disable_ipv6'</span>: value <span class="sy0">=&gt;</span> <span class="st0">'1'</span>;
    <span class="br0">&#125;</span>
&#160;
<span class="xtra ln-xtra">    <span class="co1"># Deny kernel read to others users</span></span>    <span class="kw1">case</span> $::kernel_security_rights <span class="br0">&#123;</span>
        <span class="st0">'0'</span>: <span class="br0">&#123;</span>
            <span class="kw3">exec</span> <span class="br0">&#123;</span><span class="st0">'chmod_kernel'</span>:
                command <span class="sy0">=&gt;</span> <span class="st0">'chmod o-r /boot/{vmlinuz,System.map}-*'</span>
            <span class="br0">&#125;</span>
        <span class="br0">&#125;</span>
        <span class="st0">'1'</span>&#160;: <span class="br0">&#123;</span>
            notice<span class="br0">&#40;</span><span class="st0">&quot;Kernel files have security rights&quot;</span><span class="br0">&#41;</span>
        <span class="br0">&#125;</span>
    <span class="br0">&#125;</span>
&#160;
<span class="xtra ln-xtra">    <span class="co1"># Change opened file descriptor value and avoid fork bomb by limiting number of process</span></span>    limits_conf <span class="br0">&#123;</span>
        <span class="st0">&quot;open_fd&quot;</span>: domain <span class="sy0">=&gt;</span> <span class="st0">'*'</span>, type <span class="sy0">=&gt;</span> <span class="st0">'-'</span>, item <span class="sy0">=&gt;</span> nofile, value <span class="sy0">=&gt;</span> <span class="nu0">2048</span>;
        <span class="st0">&quot;fork_bomb_soft&quot;</span>: domain <span class="sy0">=&gt;</span> <span class="st0">'@users'</span>, type <span class="sy0">=&gt;</span> soft, item <span class="sy0">=&gt;</span> nproc, value <span class="sy0">=&gt;</span> <span class="nu0">200</span>;
        <span class="st0">&quot;fork_bomb_hard&quot;</span>: domain <span class="sy0">=&gt;</span> <span class="st0">'@users'</span>, type <span class="sy0">=&gt;</span> hard, item <span class="sy0">=&gt;</span> nproc, value <span class="sy0">=&gt;</span> <span class="nu0">300</span>; 
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<p>Quelques explications s'imposent&#160;:
</p>
<ul><li> Manage Root passwords&#160;: On définit le mot de passe root souhaité sous forme md5 et sha1. En fonction de ce qu'il y aura de configuré sur la machine, il configurera le mot de passe souhaité. Pour cette détection j'utilise un facter (<a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#passwd_algorithm.rb">passwd_algorithm.rb</a>)</li>
<li> Enable auditd service&#160;: on s'assure que le service auditd démarrera bien au boot et tourne actuellement</li>
<li> Comment unwanted sysctl lines&#160;: nous demandons que certaines lignes présentes dans sysctl soient commentées si elles existent</li>
<li> Add security sysctl values&#160;: nous ajoutons des règles sysctl, ainsi que leur assignons une valeur</li>
<li> Deny kernel read to others users&#160;: j'ai créer ici un facter, qui permet de vérifier les droits des fichiers kernel (<a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#kernel_rights.rb">kernel_rights.rb</a>)</li>
<li> Change opened file descriptor value&#160;: permet d'utiliser la fonction limits_conf pour gérer le fichier limits.conf. Ici j'ai changé la valeur par défaut des file descriptor et on rajoute une petite sécurité pour <a href="./Ulimit_:_Utiliser_les_limites_systèmes.html" title="Ulimit : Utiliser les limites systèmes">éviter les fork bomb</a>.</li></ul>
<h3><span class="mw-headline" id="facter"><span class="mw-headline-number">7.5.5</span> facter</span></h3>
<p>Nous allons insérer ici les facters qui vont nous servir pour certaines fonctions demandées ci dessus.
</p>
<h4><span class="mw-headline" id="passwd_algorithm.rb"><span class="mw-headline-number">7.5.5.1</span> passwd_algorithm.rb</span></h4>
<p>Ce facter va déterminer l'algorithme utilisé pour l'authentification&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/configuration_defaults/lib/facter/passwd_algorithm.rb</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="co1"># Get Passwd Algorithm</span>
Facter.<span class="me1">add</span><span class="br0">&#40;</span><span class="st0">&quot;passwd_algorithm&quot;</span><span class="br0">&#41;</span> <span class="kw1">do</span>
  setcode <span class="kw1">do</span>
    <span class="re2">Facter::Util::Resolution</span>.<span class="kw3">exec</span><span class="br0">&#40;</span><span class="st0">&quot;grep ^PASSWDALGORITHM /etc/sysconfig/authconfig | awk -F'=' '{ print $2 }'&quot;</span><span class="br0">&#41;</span>
  <span class="kw1">end</span>
<span class="kw1">end</span></pre></div></div>
</td></tr></table><br />
<h4><span class="mw-headline" id="kernel_rights.rb"><span class="mw-headline-number">7.5.5.2</span> kernel_rights.rb</span></h4>
<p>Ce facter va déterminer si n'importe quel utilisateur a le droit de lire les kernels installés sur la machine courante&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/configuration_defaults/lib/facter/kernel_rights.rb</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="co1"># Get security rights</span>
Facter.<span class="me1">add</span><span class="br0">&#40;</span><span class="re3">:kernel_security_rights</span><span class="br0">&#41;</span> <span class="kw1">do</span>
  <span class="co1"># Get kernel files where rights will be checked</span>
  kernel_files = <span class="kw4">Dir</span>.<span class="me1">glob</span><span class="br0">&#40;</span><span class="st0">&quot;/boot/{vmlinuz,System.map}-*&quot;</span><span class="br0">&#41;</span>
  current_rights=<span class="nu0">1</span>
&#160;
  <span class="co1"># Check each files</span>
  kernel_files.<span class="me1">each</span> <span class="kw1">do</span> <span class="sy0">|</span>file<span class="sy0">|</span>
    <span class="co1"># Get file mode</span>
    full_rights = <span class="kw3">sprintf</span><span class="br0">&#40;</span><span class="st0">&quot;%o&quot;</span>, <span class="kw4">File</span>.<span class="me1">stat</span><span class="br0">&#40;</span>file<span class="br0">&#41;</span>.<span class="me1">mode</span><span class="br0">&#41;</span>
    <span class="co1"># Get last number (correponding to other rights)</span>
    other_rights = <span class="kw3">Integer</span><span class="br0">&#40;</span>full_rights<span class="br0">&#41;</span> <span class="sy0">%</span> <span class="nu0">10</span>
    <span class="co1"># Check if other got read rights</span>
    <span class="kw1">if</span> other_rights <span class="sy0">&gt;</span>= <span class="nu0">4</span>
      current_rights=<span class="nu0">0</span>
    <span class="kw1">end</span>
  <span class="kw1">end</span>
  setcode <span class="kw1">do</span>
    <span class="co1"># Set kernel_security_rights to 1 if read value is detected</span>
    current_rights
  <span class="kw1">end</span>
<span class="kw1">end</span></pre></div></div>
</td></tr></table><br />
<h4><span class="mw-headline" id="get_network_infos.rb"><span class="mw-headline-number">7.5.5.3</span> get_network_infos.rb</span></h4>
<p>Ce facter permet de récupérer l'ip courante sur eth0, le netmask et la gateway&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/configuration_defaults/lib/facter/get_network_infos.rb</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="co1"># Get public IP address</span>
Facter.<span class="me1">add</span><span class="br0">&#40;</span><span class="re3">:public_ip</span><span class="br0">&#41;</span> <span class="kw1">do</span>
  setcode <span class="kw1">do</span>
    <span class="co1"># Get bond0 ip if exist</span>
    <span class="kw1">if</span> <span class="kw4">File</span>.<span class="me1">exist</span>? <span class="st0">&quot;/proc/sys/net/ipv4/conf/bond0&quot;</span>
      <span class="re2">Facter::Util::Resolution</span>.<span class="kw3">exec</span><span class="br0">&#40;</span><span class="st0">&quot;ip addr show dev bond0 | awk '/inet/{print $2}' | head -1 | sed 's/<span class="es0">\\</span>/.*//'&quot;</span><span class="br0">&#41;</span>
    <span class="kw1">else</span>
      <span class="co1"># Or eth0 ip if exist</span>
      <span class="kw1">if</span> <span class="kw4">File</span>.<span class="me1">exist</span>? <span class="st0">&quot;/proc/sys/net/ipv4/conf/eth0&quot;</span>
        <span class="re2">Facter::Util::Resolution</span>.<span class="kw3">exec</span><span class="br0">&#40;</span><span class="st0">&quot;ip addr show dev eth0 | awk '/inet/{print $2}' | head -1 | sed 's/<span class="es0">\\</span>/.*//'&quot;</span><span class="br0">&#41;</span>
      <span class="kw1">else</span>
        <span class="co1"># Else return error</span>
        <span class="st0">'unknow (puppet issue)'</span>
      <span class="kw1">end</span>
    <span class="kw1">end</span>
  <span class="kw1">end</span>
<span class="kw1">end</span>
&#160;
<span class="co1"># Get netmask on the fist interface</span>
Facter.<span class="me1">add</span><span class="br0">&#40;</span><span class="re3">:public_netmask</span><span class="br0">&#41;</span> <span class="kw1">do</span>
  setcode <span class="kw1">do</span>
    <span class="co1"># Get bond0 netmask if exist</span>
    <span class="kw1">if</span> <span class="kw4">File</span>.<span class="me1">exist</span>? <span class="st0">&quot;/proc/sys/net/ipv4/conf/bond0&quot;</span>
      <span class="re2">Facter::Util::Resolution</span>.<span class="kw3">exec</span><span class="br0">&#40;</span><span class="st0">&quot;ifconfig bond0 | awk '/inet/{print $4}' | sed 's/.*://'&quot;</span><span class="br0">&#41;</span>
    <span class="kw1">else</span>
      <span class="co1"># Or eth0 netmask if exist</span>
      <span class="kw1">if</span> <span class="kw4">File</span>.<span class="me1">exist</span>? <span class="st0">&quot;/proc/sys/net/ipv4/conf/eth0&quot;</span>
        <span class="re2">Facter::Util::Resolution</span>.<span class="kw3">exec</span><span class="br0">&#40;</span><span class="st0">&quot;ifconfig eth0 | awk '/inet/{print $4}' | sed 's/.*://'&quot;</span><span class="br0">&#41;</span>
      <span class="kw1">else</span>
        <span class="co1"># Else set a default netmask</span>
        <span class="st0">'255.255.255.0'</span>
      <span class="kw1">end</span>
    <span class="kw1">end</span>
  <span class="kw1">end</span>
<span class="kw1">end</span>
&#160;
<span class="co1"># Get default gateway</span>
Facter.<span class="me1">add</span><span class="br0">&#40;</span><span class="re3">:default_gateway</span><span class="br0">&#41;</span> <span class="kw1">do</span>
  setcode <span class="kw1">do</span>
    <span class="re2">Facter::Util::Resolution</span>.<span class="kw3">exec</span><span class="br0">&#40;</span><span class="st0">&quot;ip route | awk '/default/{print $3}'&quot;</span><span class="br0">&#41;</span>
  <span class="kw1">end</span>
<span class="kw1">end</span></pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="network.pp"><span class="mw-headline-number">7.5.6</span> network.pp</span></h3>
<p>Ici nous allons charger la configuration du bonding et d'autres choses liées au réseau&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/configuration_defaults/manifests/network.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="kw1">class</span> configurations_defaults::redhat::network inherits configurations_defaults::redhat
<span class="br0">&#123;</span>
<span class="xtra ln-xtra">    <span class="co1"># Disable network interface renaming</span></span>    augeas <span class="br0">&#123;</span>
        <span class="st0">&quot;grub_udev_net&quot;</span>&#160;:
            context <span class="sy0">=&gt;</span> <span class="st0">&quot;/files/etc/grub.conf&quot;</span>,
            changes <span class="sy0">=&gt;</span> <span class="st0">&quot;set title[1]/kernel/biosdevname 0&quot;</span>
    <span class="br0">&#125;</span>
&#160;
<span class="xtra ln-xtra">    <span class="co1"># Load bonding module at boot</span></span>    line <span class="br0">&#123;</span>
        <span class="st0">'load_bonding'</span>:
            file <span class="sy0">=&gt;</span> <span class="st0">'/etc/modprobe.d/bonding.conf'</span>,
            line <span class="sy0">=&gt;</span> <span class="st0">'alias bond0 bonding'</span>,
            <span class="kw1">ensure</span> <span class="sy0">=&gt;</span> present
    <span class="br0">&#125;</span>
&#160;
<span class="xtra ln-xtra">    <span class="co1"># Bonded master interface - static</span></span>    network::bond::static <span class="br0">&#123;</span>
        <span class="st0">&quot;bond0&quot;</span>&#160;:
            ipaddress <span class="sy0">=&gt;</span> <span class="st0">&quot;$::public_ip&quot;</span>,
            netmask <span class="sy0">=&gt;</span> <span class="st0">&quot;$::public_netmask&quot;</span>,
            gateway <span class="sy0">=&gt;</span> <span class="st0">&quot;$::default_gateway&quot;</span>,
            bonding_opts <span class="sy0">=&gt;</span> <span class="st0">&quot;mode=active-backup&quot;</span>,
            <span class="kw1">ensure</span> <span class="sy0">=&gt;</span> <span class="st0">&quot;up&quot;</span>
    <span class="br0">&#125;</span>
&#160;
    <span class="co1"># Bonded slave interface - static</span>
    network::bond::slave <span class="br0">&#123;</span>
        <span class="st0">&quot;eth0&quot;</span>&#160;:
            macaddress <span class="sy0">=&gt;</span> $::macaddress_eth0,
            master <span class="sy0">=&gt;</span> <span class="st0">&quot;bond0&quot;</span>,
    <span class="br0">&#125;</span>
&#160;
    <span class="co1"># Bonded slave interface - static</span>
    network::bond::slave <span class="br0">&#123;</span>
        <span class="st0">&quot;eth1&quot;</span>&#160;:
            macaddress <span class="sy0">=&gt;</span> $::macaddress_eth1,
            master <span class="sy0">=&gt;</span> <span class="st0">&quot;bond0&quot;</span>,
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<ul><li> Disable network interface renaming&#160;: nous ajoutons un argument et mettons sa valeur à 0 dans grub pour qu'il ne renomme pas les interfaces et les laissent en ethX. <a href="Renommer_les_interfaces_réseaux_en_ethX.html" title="Renommer les interfaces réseaux en ethX">J'ai fais un article qui parle de ça si ça vous intéresse</a>.</li>
<li> Load bonding module at boot&#160;: On s'assure que le module bonding sera bien chargé au boot de la machine et qu'un alias sur bond0 existe</li>
<li> Bonded interfaces&#160;: Je vous renvoie sur <a rel="nofollow" class="external text" href="http://forge.puppetlabs.com/razorsedge/network">le module bonding disponible sur Puppet Forge</a>, ainsi qu'à <a href="./Réseau_:_créer_un_bonding.html" title="Réseau : créer un bonding">la documentation sur le bonding si vous savez pas ce que c'est</a>. J'ai également créer un facter (<a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#get_network_infos.rb">get_network_infos.rb</a>) pour cela afin de récupérer l'interface publique (eth0, sur laquelle je me connecterais), le netmask et gateway déjà présent et configuré sur la machine</li></ul>
<h3><span class="mw-headline" id="templates_2"><span class="mw-headline-number">7.5.7</span> templates</span></h3>
<p>Nous en avions parlé plus haut, nous gérons une template pour motd afin d'afficher en plus d'un texte, le hostname de la machine sur laquelle vous vous connectez (ligne 16)&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/configuration_defaults/templates/motd</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">================================================================================
This is an official computer system and is the property of Deimos. It
is for authorized users only. Unauthorized users are prohibited. Users
(authorized or unauthorized) have no explicit or implicit expectation of
privacy. Any or all uses of this system may be subject to one or more of
the following actions: interception, monitoring, recording, auditing,
inspection and disclosing to security personnel and law enforcement
personnel, as well as authorized officials of other agencies, both domestic
and foreign. By using this system, the user consents to these actions.
Unauthorized or improper use of this system may result in administrative
disciplinary action and civil and criminal penalties. By accessing this
system you indicate your awareness of and consent to these terms and
conditions of use. Discontinue access immediately if you do not agree to
the conditions stated in this notice.
================================================================================
&#160;
                             &lt;%= hostname&#160;%&gt;</pre></div></div>
</td></tr></table><br />
<h2><span class="mw-headline" id="OpenSSH_-_1"><span class="mw-headline-number">7.6</span> OpenSSH - 1</span></h2>
<p>Voici un premier exemple pour OpenSSH. Créons l'arborescence&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> mkdir</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">mkdir -p /etc/puppet/modules/openssh/{manifests,templates,lib/facter}</pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="init.pp_6"><span class="mw-headline-number">7.6.1</span> init.pp</span></h3>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/openssh/manifests/init.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="sy0">/*</span> 
OpenSSH <span class="kw1">Module</span> <span class="kw1">for</span> Puppet
Made by Pierre Mavro
<span class="sy0">*/</span>
<span class="kw1">class</span> openssh <span class="br0">&#123;</span>
<span class="co1"># Check OS and request the appropriate function</span>
    <span class="kw1">case</span> $::operatingsystem <span class="br0">&#123;</span>
        <span class="st0">'RedHat'</span>&#160;: <span class="br0">&#123;</span>
            <span class="kw1">include</span> openssh::redhat
        <span class="br0">&#125;</span>
        <span class="co1">#'sunos':  { include packages_defaults::solaris }</span>
        default&#160;: <span class="br0">&#123;</span>
            notice<span class="br0">&#40;</span><span class="st0">&quot;Module ${module_name} is not supported on ${::operatingsystem}&quot;</span><span class="br0">&#41;</span>
        <span class="br0">&#125;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="redhat.pp_5"><span class="mw-headline-number">7.6.2</span> redhat.pp</span></h3>
<p>Nous chargeons ici tout ce dont nous avons besoin, puis chargeons le common car il faut qu'OpenSSH soit installé et configuré avant de passer à la partie commune&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/openssh/manifests/redhat.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="sy0">/*</span> 
OpenSSH <span class="kw1">Module</span> <span class="kw1">for</span> Puppet
Made by Pierre Mavro
<span class="sy0">*/</span>
<span class="kw1">class</span> openssh::redhat <span class="br0">&#123;</span>
    <span class="co1"># Install ssh package</span>
    package <span class="br0">&#123;</span>
        <span class="st0">'openssh-server'</span>&#160;:
            <span class="kw1">ensure</span> <span class="sy0">=&gt;</span> present
    <span class="br0">&#125;</span>
&#160;
    <span class="co1"># SSHd config file</span>
    file <span class="br0">&#123;</span>
        <span class="st0">&quot;/etc/ssh/sshd_config&quot;</span>&#160;:
            source <span class="sy0">=&gt;</span> <span class="st0">&quot;puppet:///modules/openssh/sshd_config.$::operatingsystem&quot;</span>,
            mode <span class="sy0">=&gt;</span> <span class="nu0">600</span>,
            owner <span class="sy0">=&gt;</span> root,
            group <span class="sy0">=&gt;</span> root,
            notify  <span class="sy0">=&gt;</span> Service<span class="br0">&#91;</span><span class="st0">&quot;sshd&quot;</span><span class="br0">&#93;</span>
    <span class="br0">&#125;</span>
&#160;
    service <span class="br0">&#123;</span>
        <span class="st0">'sshd'</span>&#160;:
            enable <span class="sy0">=&gt;</span> <span class="kw2">true</span>,
            <span class="kw1">ensure</span> <span class="sy0">=&gt;</span> running,
            <span class="kw3">require</span> <span class="sy0">=&gt;</span> <span class="kw4">File</span><span class="br0">&#91;</span><span class="st0">'/etc/ssh/sshd_config'</span><span class="br0">&#93;</span>
    <span class="br0">&#125;</span>
&#160;
    <span class="kw1">include</span> openssh::common
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<p>Dans la partie service, il y a une information importante (require), qui redémarrera le service si le fichier de configuration change.
</p>
<h3><span class="mw-headline" id="common.pp_3"><span class="mw-headline-number">7.6.3</span> common.pp</span></h3>
<p>Ici, nous nous assurons que le dossier ou stocker des clefs SSH est bien présent avec les bons droits, puis nous faisons appel à un autre fichier qui va contenir toutes les clefs que nous souhaitons exporter&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/openssh/manifests/common.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="sy0">/*</span> 
OpenSSH <span class="kw1">Module</span> <span class="kw1">for</span> Puppet
Made by Pierre Mavro
<span class="sy0">*/</span>
<span class="kw1">class</span> openssh::common <span class="br0">&#123;</span>
    <span class="co1"># Check that .ssh directory exist with correct rights    </span>
    file <span class="br0">&#123;</span>
        <span class="st0">&quot;$::home_root/.ssh&quot;</span>&#160;:
            <span class="kw1">ensure</span> <span class="sy0">=&gt;</span> directory,
            mode <span class="sy0">=&gt;</span> 0700,
            owner <span class="sy0">=&gt;</span> root,
            group <span class="sy0">=&gt;</span> root
    <span class="br0">&#125;</span>
&#160;
    <span class="co1"># Load all public keys</span>
    <span class="kw1">include</span> openssh::ssh_keys    
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<p>La directive 'home_root' est généré depuis un facter fournis ci dessous.
</p>
<h3><span class="mw-headline" id="facter_2"><span class="mw-headline-number">7.6.4</span> facter</span></h3>
<p>Voici le facter qui permet de récupérer le home du user root&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/openssh/lib/facter/home_root.rb</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="co1"># Get Home directory</span>
Facter.<span class="me1">add</span><span class="br0">&#40;</span><span class="st0">&quot;home_root&quot;</span><span class="br0">&#41;</span> <span class="kw1">do</span>
  setcode <span class="kw1">do</span>
    <span class="re2">Facter::Util::Resolution</span>.<span class="kw3">exec</span><span class="br0">&#40;</span><span class="st0">&quot;echo ~root&quot;</span><span class="br0">&#41;</span>
  <span class="kw1">end</span>
<span class="kw1">end</span></pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="ssh_keys.pp"><span class="mw-headline-number">7.6.5</span> ssh_keys.pp</span></h3>
<p>Ici je rajoute les clefs, que ce soit pour l'accès depuis d'autres serveurs ou bien des utilisateurs&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/openssh/manifests/ssh_keys.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="sy0">/*</span> 
OpenSSH <span class="kw1">Module</span> <span class="kw1">for</span> Puppet
Made by Pierre Mavro
<span class="sy0">*/</span>
<span class="kw1">class</span> openssh::ssh_keys inherits openssh::common <span class="br0">&#123;</span>
    <span class="co1">###################################</span>
    <span class="co1"># Servers</span>
    <span class="co1">###################################</span>
&#160;
    <span class="co1"># Puppet master    </span>
    ssh_add_key <span class="br0">&#123;</span>
        <span class="st0">'puppet_root'</span>&#160;:
            user <span class="sy0">=&gt;</span> <span class="st0">'root'</span>,
            key <span class="sy0">=&gt;</span> <span class="st0">'AAAA...'</span>
    <span class="br0">&#125;</span>
&#160;
    <span class="co1">###################################</span>
    <span class="co1"># Sys-Admins</span>
    <span class="co1">###################################</span>
&#160;
    <span class="co1"># Pierre Mavro</span>
    ssh_add_key <span class="br0">&#123;</span>
        <span class="st0">'pmavro_root'</span>&#160;:
            user <span class="sy0">=&gt;</span> <span class="st0">'root'</span>,
            key <span class="sy0">=&gt;</span> <span class="st0">'AAAA...'</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<p><br />
</p>
<h3><span class="mw-headline" id="files_2"><span class="mw-headline-number">7.6.6</span> files</span></h3>
<p>Le fichier de configuration OpenSSH pour Red Hat&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/openssh/files/sshd_config.RedHat</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1"># $OpenBSD: sshd_config,v 1.80 2008/07/02 02:24:18 djm Exp $
&#160;
# This is the sshd server system-wide configuration file.  See
# sshd_config(5) for more information.
&#160;
# This sshd was compiled with PATH=/usr/local/bin:/bin:/usr/bin
&#160;
# The strategy used for options in the default sshd_config shipped with
# OpenSSH is to specify options with their default value where
# possible, but leave them commented.  Uncommented options change a
# default value.
&#160;
Port 22
#AddressFamily any
#ListenAddress 0.0.0.0
#ListenAddress&#160;::
&#160;
# Disable legacy (protocol version 1) support in the server for new
# installations. In future the default will change to require explicit
# activation of protocol 1
Protocol 2
&#160;
# HostKey for protocol version 1
#HostKey /etc/ssh/ssh_host_key
# HostKeys for protocol version 2
#HostKey /etc/ssh/ssh_host_rsa_key
#HostKey /etc/ssh/ssh_host_dsa_key
&#160;
# Lifetime and size of ephemeral version 1 server key
#KeyRegenerationInterval 1h
#ServerKeyBits 1024
&#160;
# Logging
# obsoletes QuietMode and FascistLogging
#SyslogFacility AUTH
SyslogFacility AUTHPRIV
#LogLevel INFO
&#160;
# Authentication:
&#160;
LoginGraceTime 2m
PermitRootLogin without-password
#StrictModes yes
#MaxAuthTries 6
#MaxSessions 10
&#160;
#RSAAuthentication yes
#PubkeyAuthentication yes
#AuthorizedKeysFile	.ssh/authorized_keys
#AuthorizedKeysCommand none
#AuthorizedKeysCommandRunAs nobody
&#160;
# For this to work you will also need host keys in /etc/ssh/ssh_known_hosts
#RhostsRSAAuthentication no
# similar for protocol version 2
#HostbasedAuthentication no
# Change to yes if you don't trust ~/.ssh/known_hosts for
# RhostsRSAAuthentication and HostbasedAuthentication
#IgnoreUserKnownHosts no
# Don't read the user's ~/.rhosts and ~/.shosts files
#IgnoreRhosts yes
&#160;
# To disable tunneled clear text passwords, change to no here!
#PasswordAuthentication yes
#PermitEmptyPasswords no
PasswordAuthentication yes
&#160;
# Change to no to disable s/key passwords
#ChallengeResponseAuthentication yes
ChallengeResponseAuthentication no
&#160;
# Kerberos options
#KerberosAuthentication no
#KerberosOrLocalPasswd yes
#KerberosTicketCleanup yes
#KerberosGetAFSToken no
#KerberosUseKuserok yes
&#160;
# GSSAPI options
# Disable GSSAPI to avoid login slowdown
GSSAPIAuthentication no
#GSSAPIAuthentication yes
#GSSAPICleanupCredentials yes
#GSSAPICleanupCredentials no
#GSSAPIStrictAcceptorCheck yes
#GSSAPIKeyExchange no
&#160;
# Set this to 'yes' to enable PAM authentication, account processing, 
# and session processing. If this is enabled, PAM authentication will 
# be allowed through the ChallengeResponseAuthentication and
# PasswordAuthentication.  Depending on your PAM configuration,
# PAM authentication via ChallengeResponseAuthentication may bypass
# the setting of &quot;PermitRootLogin without-password&quot;.
# If you just want the PAM account and session checks to run without
# PAM authentication, then enable this but set PasswordAuthentication
# and ChallengeResponseAuthentication to 'no'.
#UsePAM no
UsePAM yes
&#160;
# Accept locale-related environment variables
AcceptEnv LANG LC_CTYPE LC_NUMERIC LC_TIME LC_COLLATE LC_MONETARY LC_MESSAGES
AcceptEnv LC_PAPER LC_NAME LC_ADDRESS LC_TELEPHONE LC_MEASUREMENT
AcceptEnv LC_IDENTIFICATION LC_ALL LANGUAGE
AcceptEnv XMODIFIERS
&#160;
# For security reasons, deny tcp forwarding
AllowTcpForwarding no
X11Forwarding no
# Disable DNS usage to avoid login slowdown
UseDNS no
# Disconnect client if they are idle
ClientAliveInterval 600
ClientAliveCountMax 0
&#160;
#AllowAgentForwarding yes
#GatewayPorts no
#X11Forwarding no
#X11DisplayOffset 10
#X11UseLocalhost yes
#PrintMotd yes
#PrintLastLog yes
#TCPKeepAlive yes
#UseLogin no
#UsePrivilegeSeparation yes
#PermitUserEnvironment no
#Compression delayed
#ShowPatchLevel no
#PidFile /var/run/sshd.pid
#MaxStartups 10
#PermitTunnel no
#ChrootDirectory none
&#160;
# no default banner path
#Banner none
&#160;
# override default of no subsystems
Subsystem	sftp	/usr/libexec/openssh/sftp-server
&#160;
# Example of overriding settings on a per-user basis
#Match User anoncvs
#	X11Forwarding no
#	AllowTcpForwarding no
#	ForceCommand cvs server</pre></div></div>
</td></tr></table><br />
<h2><span class="mw-headline" id="OpenSSH_-_2"><span class="mw-headline-number">7.7</span> OpenSSH - 2</span></h2>
<p>Voici un deuxième exemple pour OpenSSH, un peu différent. Vous devez <a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Initialisation_d.27un_module">initialiser le module</a> avant de continuer.
</p>
<h3><span class="mw-headline" id="init.pp_7"><span class="mw-headline-number">7.7.1</span> init.pp</span></h3>
<p>Ici je veux que ce soit mon fichier sshd_config qui m'intéresse&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/ssh/manifests/init.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="co1">#ssh.pp</span>
&#160;
<span class="co1"># SSH Class with all includes</span>
<span class="kw1">class</span> ssh <span class="br0">&#123;</span>
   <span class="re0">$ssh_default_port</span> = <span class="br0">&#91;</span><span class="st0">&quot;22&quot;</span><span class="br0">&#93;</span>
   <span class="re0">$ssh_allowed_users</span> = <span class="st0">&quot;root&quot;</span>
   <span class="kw1">include</span> ssh::config, ssh::key, ssh::service
<span class="br0">&#125;</span>
&#160;
<span class="co1"># SSHD Config file</span>
<span class="kw1">class</span> ssh::config <span class="br0">&#123;</span>
  <span class="kw4">File</span> <span class="br0">&#123;</span>
    name <span class="sy0">=&gt;</span> <span class="re0">$operatingsystem</span>&#160;? <span class="br0">&#123;</span>
      Solaris  <span class="sy0">=&gt;</span> <span class="st0">&quot;/etc/ssh/sshd_config&quot;</span>,
      default <span class="sy0">=&gt;</span> <span class="st0">&quot;/etc/ssh/sshd_config&quot;</span>
    <span class="br0">&#125;</span>,
  <span class="br0">&#125;</span>
&#160;
  <span class="co1"># Using templates for sshd_config</span>
  file <span class="br0">&#123;</span> sshd_config:
    content <span class="sy0">=&gt;</span> <span class="re0">$operatingsystem</span>&#160;? <span class="br0">&#123;</span>
       default <span class="sy0">=&gt;</span> template<span class="br0">&#40;</span><span class="st0">&quot;ssh/sshd_config&quot;</span><span class="br0">&#41;</span>,
       Solaris <span class="sy0">=&gt;</span> template<span class="br0">&#40;</span><span class="st0">&quot;ssh/sshd_config.solaris&quot;</span><span class="br0">&#41;</span>,
    <span class="br0">&#125;</span>
  <span class="br0">&#125;</span>
<span class="br0">&#125;</span>
&#160;
<span class="co1"># SSH Key exchange</span>
<span class="kw1">class</span> ssh::key <span class="br0">&#123;</span>
	<span class="re0">$basedir</span> = <span class="re0">$operatingsystem</span>&#160;? <span class="br0">&#123;</span>
        Solaris <span class="sy0">=&gt;</span> <span class="st0">&quot;/.ssh&quot;</span>,
        Debian <span class="sy0">=&gt;</span> <span class="st0">&quot;/root/.ssh&quot;</span>,
		Redhat <span class="sy0">=&gt;</span> <span class="st0">&quot;/root/.ssh&quot;</span>,
	<span class="br0">&#125;</span>
&#160;
        <span class="co1"># Make sur .ssh exist in root home dir</span>
	file <span class="br0">&#123;</span> <span class="st0">&quot;$basedir/&quot;</span>:
		<span class="kw1">ensure</span> <span class="sy0">=&gt;</span> directory,
		mode <span class="sy0">=&gt;</span> 0700,
		owner <span class="sy0">=&gt;</span> root,
		group <span class="sy0">=&gt;</span> root,
		ignore <span class="sy0">=&gt;</span> <span class="st0">'.svn'</span>
	<span class="br0">&#125;</span>
&#160;
    <span class="co1"># Check if authorized_keys key file exist or create empty one</span>
    file <span class="br0">&#123;</span> <span class="st0">&quot;$basedir/authorized_keys&quot;</span>:
        <span class="kw1">ensure</span> <span class="sy0">=&gt;</span> present,
    <span class="br0">&#125;</span>
&#160;
    <span class="co1"># Check this line exist</span>
    line <span class="br0">&#123;</span> ssh_key:
  	file <span class="sy0">=&gt;</span> <span class="st0">&quot;$basedir/authorized_keys&quot;</span>,
  	line <span class="sy0">=&gt;</span> <span class="st0">&quot;ssh-dss AAAAB3NzaC1....zG3ZA== root@puppet&quot;</span>,
  	    <span class="kw1">ensure</span> <span class="sy0">=&gt;</span> present;
	<span class="br0">&#125;</span>
<span class="br0">&#125;</span>
&#160;
<span class="co1"># Check servoce status</span>
<span class="kw1">class</span> ssh::service <span class="br0">&#123;</span>
  service <span class="br0">&#123;</span> ssh:
    name <span class="sy0">=&gt;</span> <span class="re0">$operatingsystem</span>&#160;? <span class="br0">&#123;</span>
      Solaris <span class="sy0">=&gt;</span> <span class="st0">&quot;svc:/network/ssh:default&quot;</span>,
      default <span class="sy0">=&gt;</span> ssh
    <span class="br0">&#125;</span>,
    <span class="kw1">ensure</span>    <span class="sy0">=&gt;</span> running,
    enable    <span class="sy0">=&gt;</span> <span class="kw2">true</span>
  <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<p>Ensuite, par rapport à sudo, j'ai un notify qui permet d'automatiquement redémarrer le service lorsque le fichier est remplacé par une nouvelle version. C'est le service ssh avec l'option "ensure =&gt; running", qui va permettre la détection du changement de version et redémarrage.
</p>
<h3><span class="mw-headline" id="templates_3"><span class="mw-headline-number">7.7.2</span> templates</span></h3>
<p>Du fait que nous utilisons des templates, nous allons avoir besoin de créer un dossier templates&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> mkdir</font>
</td></tr>
<tr>
<td>
<pre>mkdir -p /etc/puppet/modules/ssh/templates
</pre>
</td></tr></table><br />
<p>Ensuite nous allons créer 2 fichiers (sshd_config et sshd_config.solaris) car les configuration ne se comportent pas de la même manière (OpenSSH vs Sun SSH. Je n'aborderais cependant ici que la partie OpenSSH&#160;:
</p><p><br />
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/ssh/templates/sshd_config</font>
</td></tr>
<tr>
<td>
<pre># Package generated configuration file
# See the sshd(8) manpage for details

# What ports, IPs and protocols we listen for
<b>&lt;% ssh_default_port.each do |val| -%&gt; </b>
<b>Port &lt;%= val -%&gt; </b>
<b>&lt;% end -%&gt;</b>
# Use these options to restrict which interfaces/protocols sshd will bind to
#ListenAddress&#160;::
#ListenAddress 0.0.0.0
Protocol 2
# HostKeys for protocol version 2
HostKey /etc/ssh/ssh_host_rsa_key
HostKey /etc/ssh/ssh_host_dsa_key
#Privilege Separation is turned on for security
UsePrivilegeSeparation yes

# Lifetime and size of ephemeral version 1 server key
KeyRegenerationInterval 3600
ServerKeyBits 768

# Logging
SyslogFacility AUTH
LogLevel INFO

# Authentication:
LoginGraceTime 120
PermitRootLogin yes
StrictModes yes

RSAAuthentication yes
PubkeyAuthentication yes
#AuthorizedKeysFile	%h/.ssh/authorized_keys

# Don't read the user's ~/.rhosts and ~/.shosts files
IgnoreRhosts yes
# For this to work you will also need host keys in /etc/ssh_known_hosts
RhostsRSAAuthentication no
# similar for protocol version 2
HostbasedAuthentication no
# Uncomment if you don't trust ~/.ssh/known_hosts for RhostsRSAAuthentication
#IgnoreUserKnownHosts yes

# To enable empty passwords, change to yes (NOT RECOMMENDED)
PermitEmptyPasswords no

# Change to yes to enable challenge-response passwords (beware issues with
# some PAM modules and threads)
ChallengeResponseAuthentication no

# Change to no to disable tunnelled clear text passwords
#PasswordAuthentication yes

# Kerberos options
#KerberosAuthentication no
#KerberosGetAFSToken no
#KerberosOrLocalPasswd yes
#KerberosTicketCleanup yes

# GSSAPI options
#GSSAPIAuthentication no
#GSSAPICleanupCredentials yes

X11Forwarding yes
X11DisplayOffset 10
PrintMotd no
PrintLastLog yes
TCPKeepAlive yes
#UseLogin no

#MaxStartups 10:30:60
#Banner /etc/issue.net

# Allow client to pass locale environment variables
AcceptEnv LANG LC_*

Subsystem sftp /usr/lib/openssh/sftp-server

UsePAM yes
<b># AllowUsers &lt;%= ssh_allowed_users&#160;%&gt;</b>
</pre>
</td></tr></table><br />
<h2><span class="mw-headline" id="SELinux"><span class="mw-headline-number">7.8</span> SELinux</span></h2>
<p>Si vous souhaitez en connaitre plus sur SELinux, je vous invite à <a href="Sécuriser_son_architecture_avec_SELinux.html" title="Sécuriser son architecture avec SELinux">regarder cette documentation</a>.
Créons l'arborescence&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> mkdir</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">mkdir -p /etc/puppet/modules/selinux/manifests</pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="init.pp_8"><span class="mw-headline-number">7.8.1</span> init.pp</span></h3>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/selinux/manifests/init.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="kw1">class</span> selinux <span class="br0">&#123;</span>
    <span class="co1"># Check OS and request the appropriate function</span>
    <span class="kw1">case</span> $::operatingsystem <span class="br0">&#123;</span>
        <span class="st0">'RedHat'</span>&#160;: <span class="br0">&#123;</span>
            <span class="kw1">include</span> selinux::redhat
        <span class="br0">&#125;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="redhat.pp_6"><span class="mw-headline-number">7.8.2</span> redhat.pp</span></h3>
<p>Ici, je vais utiliser une fonction (augeas), qui va me permettre de passer la valeur de la variable 'SELINUX' à 'disabled', car je souhaites désactiver ce module&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/selinux/manifests/redhat.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="kw1">class</span> selinux::redhat
<span class="br0">&#123;</span>
    <span class="co1"># Disable SELinux</span>
    augeas <span class="br0">&#123;</span>
        <span class="st0">&quot;selinux&quot;</span>&#160;:
            context <span class="sy0">=&gt;</span> <span class="st0">&quot;/files/etc/sysconfig/selinux/&quot;</span>,
            changes <span class="sy0">=&gt;</span> <span class="st0">&quot;set SELINUX disabled&quot;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<h2><span class="mw-headline" id="Grub"><span class="mw-headline-number">7.9</span> Grub</span></h2>
<p>Il existe beaucoup d'options de Grub et son utilisation peut varier d'un système à l'autre. Je vous <a href="./Grub_:_Utilisation_d'un_bootloader.html" title="Grub : Utilisation d'un bootloader">recommande cette documentation</a> avant d'attaquer ceci.
Créons l'arborescence&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> mkdir</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">mkdir -p /etc/puppet/modules/grub/manifests</pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="init.pp_9"><span class="mw-headline-number">7.9.1</span> init.pp</span></h3>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/grub/manifests/init.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="sy0">/*</span> 
Grub <span class="kw1">Module</span> <span class="kw1">for</span> Puppet
Made by Pierre Mavro
<span class="sy0">*/</span>
<span class="kw1">class</span> grub <span class="br0">&#123;</span>
<span class="co1"># Check OS and request the appropriate function</span>
    <span class="kw1">case</span> $::operatingsystem <span class="br0">&#123;</span>
        <span class="st0">'RedHat'</span>&#160;: <span class="br0">&#123;</span>
            <span class="kw1">include</span>&#160;::grub::redhat
        <span class="br0">&#125;</span>
        <span class="co1">#'sunos':  { include packages_defaults::solaris }</span>
        default&#160;: <span class="br0">&#123;</span>
            notice<span class="br0">&#40;</span><span class="st0">&quot;Module ${module_name} is not supported on ${::operatingsystem}&quot;</span><span class="br0">&#41;</span>
        <span class="br0">&#125;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="redhat.pp_7"><span class="mw-headline-number">7.9.2</span> redhat.pp</span></h3>
<p>Les choses vont se compliquer un peu plus ici. J'utilise encore le module Augeas pour supprimer les arguments quiet et rhgb des kernels disponibles dans grub.conf&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/grub/manifests/redhat.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="sy0">/*</span> 
Grub <span class="kw1">Module</span> <span class="kw1">for</span> Puppet
Made by Pierre Mavro
<span class="sy0">*/</span>
<span class="kw1">class</span> grub::redhat
<span class="br0">&#123;</span>
    <span class="co1"># Remove unwanted parameters parameter</span>
    augeas <span class="br0">&#123;</span>
        <span class="st0">&quot;grub&quot;</span>&#160;:
            context <span class="sy0">=&gt;</span> <span class="st0">&quot;/files/etc/grub.conf&quot;</span>,
            changes <span class="sy0">=&gt;</span> <span class="br0">&#91;</span>
                <span class="st0">&quot;remove title[*]/kernel/quiet&quot;</span>,
                <span class="st0">&quot;remove title[*]/kernel/rhgb&quot;</span>
            <span class="br0">&#93;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<h2><span class="mw-headline" id="Kdump"><span class="mw-headline-number">7.10</span> Kdump</span></h2>
<p>Créons l'arborescence&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> mkdir</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">mkdir -p /etc/puppet/modules/kdump/manifests</pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="init.pp_10"><span class="mw-headline-number">7.10.1</span> init.pp</span></h3>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/kdump/manifests/init.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="sy0">/*</span> 
Kdump <span class="kw1">Module</span> <span class="kw1">for</span> Puppet
Made by Pierre Mavro
<span class="sy0">*/</span>
<span class="kw1">class</span> kdump <span class="br0">&#123;</span>
    <span class="co1"># Check OS and request the appropriate function</span>
    <span class="kw1">case</span> $::operatingsystem <span class="br0">&#123;</span>
        <span class="st0">'RedHat'</span>&#160;: <span class="br0">&#123;</span>
            <span class="kw1">include</span> kdump::redhat
        <span class="br0">&#125;</span>
        default&#160;: <span class="br0">&#123;</span>
            notice<span class="br0">&#40;</span><span class="st0">&quot;Module ${module_name} is not supported on ${::operatingsystem}&quot;</span><span class="br0">&#41;</span>
        <span class="br0">&#125;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="redhat.pp_8"><span class="mw-headline-number">7.10.2</span> redhat.pp</span></h3>
<p>Voici la configuration que je souhaites&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/kdump/manifests/redhat.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="sy0">/*</span> 
Kdump <span class="kw1">Module</span> <span class="kw1">for</span> Puppet
Made by Pierre Mavro
<span class="sy0">*/</span>
<span class="kw1">class</span> kdump::redhat
<span class="br0">&#123;</span>
<span class="xtra ln-xtra">    <span class="co1"># Install kexec-tools</span></span>    package <span class="br0">&#123;</span> <span class="st0">'kexec-tools'</span>:
        <span class="kw1">ensure</span> <span class="sy0">=&gt;</span> <span class="st0">'installed'</span>
    <span class="br0">&#125;</span>
&#160;
<span class="xtra ln-xtra">    <span class="co1"># Be sure that service is set to start at boot</span></span>    service <span class="br0">&#123;</span>
        <span class="st0">'kdump'</span>:
            enable <span class="sy0">=&gt;</span> <span class="kw2">true</span>
    <span class="br0">&#125;</span>
&#160;
<span class="xtra ln-xtra">    <span class="co1"># Set crashkernel in grub.conf to the good size (not auto)</span></span>    augeas <span class="br0">&#123;</span>
        <span class="st0">&quot;grub_kdump&quot;</span>&#160;:
            context <span class="sy0">=&gt;</span> <span class="st0">'/files/etc/grub.conf'</span>,
            changes <span class="sy0">=&gt;</span> <span class="br0">&#91;</span>
                <span class="st0">'set title[1]/kernel/crashkernel 128M'</span>
            <span class="br0">&#93;</span>
    <span class="br0">&#125;</span>
&#160;
<span class="xtra ln-xtra">    <span class="co1"># Set location of crash dumps</span></span>    line <span class="br0">&#123;</span>
        <span class="st0">'var_crash'</span>:
            file <span class="sy0">=&gt;</span> <span class="st0">'/etc/kdump.conf'</span>,
            line <span class="sy0">=&gt;</span> <span class="st0">'path <span class="es0">\/</span>var<span class="es0">\/</span>crash'</span>,
            <span class="kw1">ensure</span> <span class="sy0">=&gt;</span> uncomment
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<ul><li> Install kexec-tools&#160;: je m'assure que le package est bien installé</li>
<li> Be sure that service is set to start at boot&#160;: je m'assure qu'il est bien activé au boot. Pour information, je ne vérifie pas qu'il tourne puisque cela nécessite un redémarrage s'il n'était pas présent.</li>
<li> Set crashkernel in grub.conf to the good size (not auto)&#160;: Met la valeur 128M à l'argument crashkernel du premier kernel trouvé dans le fichier grub.conf. Il n'est pas possible de spécifier '*' comme pour un remove dans angeas. Cependant, vu qu'à chaque mise à jour du kernel, tous les autres en hériteront, ce n'est pas un soucis&#160;:-)</li>
<li> Set location of crash dumps&#160;: nous spécifions dans la configuration de kdump qu'une ligne est bien décommentée et qu'elle a le path souhaité pour les crash dump.</li></ul>
<h2><span class="mw-headline" id="Tools"><span class="mw-headline-number">7.11</span> Tools</span></h2>
<p>Ceci n'est pas un logiciel, mais plutôt un module qui me sert à envoyer tous mes scripts d'admin, mes outils etc... Créons l'arborescence&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> mkdir</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">mkdir -p /etc/puppet/modules/tools/{manifests,files}</pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="init.pp_11"><span class="mw-headline-number">7.11.1</span> init.pp</span></h3>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/tools/manifests/init.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="kw1">class</span> tools <span class="br0">&#123;</span>
<span class="co1"># Check OS and request the appropriate function</span>
    <span class="kw1">case</span> $::operatingsystem <span class="br0">&#123;</span>
        <span class="st0">'RedHat'</span>&#160;: <span class="br0">&#123;</span>
            <span class="kw1">include</span>&#160;::tools::redhat
        <span class="br0">&#125;</span>
        <span class="co1">#'sunos':  { include packages_defaults::solaris }</span>
        default&#160;: <span class="br0">&#123;</span>
            notice<span class="br0">&#40;</span><span class="st0">&quot;Module ${module_name} is not supported on ${::operatingsystem}&quot;</span><span class="br0">&#41;</span>
        <span class="br0">&#125;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="redhat.pp_9"><span class="mw-headline-number">7.11.2</span> redhat.pp</span></h3>
<p>Nous allons voir ici différentes manière d'ajouter des fichiers&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/tools/manifests/redhat.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="kw1">class</span> tools::redhat <span class="br0">&#123;</span>
<span class="xtra ln-xtra">    <span class="co1"># Check that scripts folder exist</span></span>    file <span class="br0">&#123;</span>
        <span class="st0">&quot;/etc/scripts&quot;</span>&#160;:
            <span class="kw1">ensure</span> <span class="sy0">=&gt;</span> directory,
            mode <span class="sy0">=&gt;</span> 0755,
            owner <span class="sy0">=&gt;</span> root,
            group <span class="sy0">=&gt;</span> root
    <span class="br0">&#125;</span>
&#160;
<span class="xtra ln-xtra">    <span class="co1"># Synchro admin-scripts</span></span>    file <span class="br0">&#123;</span>
        <span class="st0">&quot;/etc/scripts/admin-scripts&quot;</span>&#160;:
            <span class="kw1">ensure</span> <span class="sy0">=&gt;</span> directory,
            mode <span class="sy0">=&gt;</span> 0755,
            owner <span class="sy0">=&gt;</span> root,
            group <span class="sy0">=&gt;</span> root,
            source <span class="sy0">=&gt;</span> <span class="st0">&quot;puppet:///modules/tools/admin-scripts/&quot;</span>,
            purge <span class="sy0">=&gt;</span> <span class="kw2">true</span>,
            force <span class="sy0">=&gt;</span> <span class="kw2">true</span>,
            recurse <span class="sy0">=&gt;</span> <span class="kw2">true</span>,
            ignore <span class="sy0">=&gt;</span> <span class="st0">'.svn'</span>,
            backup <span class="sy0">=&gt;</span> <span class="kw2">false</span>
    <span class="br0">&#125;</span>
&#160;
<span class="xtra ln-xtra">    <span class="co1"># Fast reboot command</span></span>    file <span class="br0">&#123;</span>
        <span class="st0">&quot;/usr/bin/fastreboot&quot;</span>&#160;:
            source <span class="sy0">=&gt;</span> <span class="st0">&quot;puppet:///modules/tools/fastreboot&quot;</span>,
            mode <span class="sy0">=&gt;</span> <span class="nu0">744</span>,
            owner <span class="sy0">=&gt;</span> root,
            group <span class="sy0">=&gt;</span> root
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<ul><li> Check that scripts folder exist&#160;: Je m'assure que mon dossier existe avec les bons droits, avant d'y déposer des fichiers.</li>
<li> Synchro admin-scripts&#160;: Je viens copier un répertoire complet avec son contenu&#160;:
<ul><li> purge =&gt; true&#160;: Je m'assure que tout ce qui n'est pas dans mon puppet files, doit disparaitre côté serveur. Donc si vous avez manuellement ajouté un fichier dans le dossier /etc/scripts/admin-scripts, il disparaitra.</li>
<li> force =&gt; true&#160;: On force en cas de suppression ou remplacement.</li>
<li> recurse =&gt; true&#160;: C'est ce qui me permet de dire de copier tout le contenu</li>
<li> backup =&gt; false&#160;: On ne sauvegarde pas les fichiers avant de les remplacer</li></ul></li>
<li> Fast reboot command&#160;: Je rajoute un fichier exécutable</li></ul>
<h3><span class="mw-headline" id="files_3"><span class="mw-headline-number">7.11.3</span> files</span></h3>
<p>Voici dans files à quoi ressemble mon arborescence dans le dossier files&#160;:
</p>
<div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">.
|-- admin-scripts
|   |-- script1.pl
|   `-- script2.pl
`-- fastreboot</pre></div></div>
<p>Pour information, <a href="./Kexec_:_optimisez_vos_temps_de_boot.html" title="Kexec : optimisez vos temps de boot">la commande fastreboot est disponible ici</a>.
</p>
<h2><span class="mw-headline" id="Timezone"><span class="mw-headline-number">7.12</span> Timezone</span></h2>
<p>Gérer les timezone, c'est plus ou moins facile suivant les OS. Nous allons voir ici comment s'en sortir sur Red Hat. Créons l'arborescence&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> mkdir</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">mkdir -p /etc/puppet/modules/timezone/{manifests,templates}</pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="init.pp_12"><span class="mw-headline-number">7.12.1</span> init.pp</span></h3>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/timezone/manifests/init.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="sy0">/*</span> 
Timezone <span class="kw1">Module</span> <span class="kw1">for</span> Puppet
Made by Pierre Mavro
<span class="sy0">*/</span>
<span class="kw1">class</span> timezone <span class="br0">&#123;</span>
<span class="co1"># Check OS and request the appropriate function</span>
    <span class="kw1">case</span> $::operatingsystem <span class="br0">&#123;</span>
        <span class="st0">'RedHat'</span>&#160;: <span class="br0">&#123;</span>
            <span class="kw1">include</span> timezone::redhat
        <span class="br0">&#125;</span>
        <span class="co1">#'sunos':  { include packages_defaults::solaris }</span>
        default&#160;: <span class="br0">&#123;</span>
            notice<span class="br0">&#40;</span><span class="st0">&quot;Module ${module_name} is not supported on ${::operatingsystem}&quot;</span><span class="br0">&#41;</span>
        <span class="br0">&#125;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="redhat.pp_10"><span class="mw-headline-number">7.12.2</span> redhat.pp</span></h3>
<p>Nous utilisons une variable '$set_timezone' stockée <a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#vars.pp">dans les variables globales</a> ou <a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#servers.pp">dans la configuration d'un node</a> avec le continent et le pays. Voici un exemple&#160;:
</p>
<div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="co1"># NTP Timezone. Usage&#160;:</span>
<span class="co1"># Look at /usr/share/zoneinfo/ and add the continent folder followed by the town</span>
<span class="re0">$set_timezone</span> = <span class="st0">'Europe/Paris'</span></pre></div></div>
<p>Et le manifest&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/timezone/manifests/redhat.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="sy0">/*</span> 
Timezone <span class="kw1">Module</span> <span class="kw1">for</span> Puppet
Made by Pierre Mavro
<span class="sy0">*/</span>
<span class="kw1">class</span> timezone::redhat
<span class="br0">&#123;</span>
    <span class="co1"># Usage&#160;: set a var called set_timezone with required informations. Ex&#160;:</span>
    <span class="co1"># set_timezone = &quot;Europe/Paris&quot;</span>
&#160;
    <span class="co1"># Set timezone file</span>
    file <span class="br0">&#123;</span> <span class="st0">'/etc/sysconfig/clock'</span>:
        content <span class="sy0">=&gt;</span> template<span class="br0">&#40;</span><span class="st0">&quot;timezone/clock.$::operatingsystem&quot;</span><span class="br0">&#41;</span>,
        mode <span class="sy0">=&gt;</span> <span class="nu0">644</span>,
        owner <span class="sy0">=&gt;</span> root,
        group <span class="sy0">=&gt;</span> root
    <span class="br0">&#125;</span>
&#160;
    <span class="co1"># Create required Symlink</span>
    file <span class="br0">&#123;</span> <span class="st0">'/etc/localtime'</span>:
        <span class="kw1">ensure</span> <span class="sy0">=&gt;</span> link,
        target <span class="sy0">=&gt;</span> <span class="st0">&quot;/usr/share/zoneinfo/${set_timezone}&quot;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="templates_4"><span class="mw-headline-number">7.12.3</span> templates</span></h3>
<p>Et le fichier template nécessaire pour Red Hat&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/timezone/templates/clock.RedHat</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">ZONE=&quot;&lt;%= set_timezone&#160;%&gt;&quot;</pre></div></div>
</td></tr></table><br />
<h2><span class="mw-headline" id="NTP"><span class="mw-headline-number">7.13</span> NTP</span></h2>
<p>Si vous souhaitez comprendre comment configurer un serveur NTP, je vous invite à <a href="./NTP_:_Création_d'un_serveur_NTP.html" title="NTP : Création d'un serveur NTP">lire cette documentation</a>.
</p><p>Créons l'arborescence&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> mkdir</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">mkdir -p /etc/puppet/modules/ntp/{manifests,files}</pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="init.pp_13"><span class="mw-headline-number">7.13.1</span> init.pp</span></h3>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/ntp/manifests/init.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="sy0">/*</span> 
NTP <span class="kw1">Module</span> <span class="kw1">for</span> Puppet
Made by Pierre Mavro
<span class="sy0">*/</span>
<span class="kw1">class</span> ntp <span class="br0">&#123;</span>
<span class="co1"># Check OS and request the appropriate function</span>
    <span class="kw1">case</span> $::operatingsystem <span class="br0">&#123;</span>
        <span class="st0">'RedHat'</span>&#160;: <span class="br0">&#123;</span>
            <span class="kw1">include</span> ntp::redhat
        <span class="br0">&#125;</span>
        <span class="co1">#'sunos':  { include packages_defaults::solaris }</span>
        default&#160;: <span class="br0">&#123;</span>
            notice<span class="br0">&#40;</span><span class="st0">&quot;Module ${module_name} is not supported on ${::operatingsystem}&quot;</span><span class="br0">&#41;</span>
        <span class="br0">&#125;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="redhat.pp_11"><span class="mw-headline-number">7.13.2</span> redhat.pp</span></h3>
<p>Je souhaites ici que le package soit installé, configuré au boot, qu'il récupère un fichier de configuration classique et qu'il configure la crontab pour que le service ne se lance qu'en dehors des heures de production (pour que les logs de prod aient une cohérence)&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/ntp/manifests/redhat.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="sy0">/*</span> 
NTP <span class="kw1">Module</span> <span class="kw1">for</span> Puppet
Made by Pierre Mavro
<span class="sy0">*/</span>
<span class="kw1">class</span> ntp::redhat <span class="br0">&#123;</span>
    <span class="co1"># Install NTP service</span>
    package <span class="br0">&#123;</span>
        <span class="st0">'ntp'</span>&#160;:
            <span class="kw1">ensure</span> <span class="sy0">=&gt;</span> <span class="st0">'installed'</span>
    <span class="br0">&#125;</span>
&#160;
    <span class="co1"># Be sure that service is set to start at boot</span>
    service <span class="br0">&#123;</span>
        <span class="st0">'ntpd'</span>&#160;:
            enable <span class="sy0">=&gt;</span> <span class="kw2">false</span>
    <span class="br0">&#125;</span>
&#160;
    <span class="co1"># Set configuration file</span>
    file <span class="br0">&#123;</span>
        <span class="st0">'/etc/ntp.conf'</span>&#160;:
            <span class="kw1">ensure</span> <span class="sy0">=&gt;</span> present,
            source <span class="sy0">=&gt;</span> <span class="st0">&quot;puppet:///modules/ntp/${::osfamily}.ntp.conf&quot;</span>,
            mode <span class="sy0">=&gt;</span> <span class="nu0">644</span>,
            owner <span class="sy0">=&gt;</span> root,
            group <span class="sy0">=&gt;</span> root
    <span class="br0">&#125;</span>
&#160;
    <span class="co1"># Enable ntp service during off production hours</span>
    cron <span class="br0">&#123;</span>
        <span class="st0">'ntp_start'</span>&#160;:
            command <span class="sy0">=&gt;</span> <span class="st0">'/etc/init.d/ntpd start'</span>,
            user <span class="sy0">=&gt;</span> root,
            minute <span class="sy0">=&gt;</span> <span class="nu0">0</span>,
            hour <span class="sy0">=&gt;</span> <span class="nu0">0</span>
    <span class="br0">&#125;</span>
&#160;
    <span class="co1"># Disable ntp service during on production hours</span>
    cron <span class="br0">&#123;</span>
        <span class="st0">'ntp_stop'</span>&#160;:
            command <span class="sy0">=&gt;</span> <span class="st0">'/etc/init.d/ntpd stop'</span>,
            user <span class="sy0">=&gt;</span> root,
            minute <span class="sy0">=&gt;</span> <span class="nu0">3</span>,
            hour <span class="sy0">=&gt;</span> <span class="nu0">0</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<p>Vous remarquerez l'utilisation des directives 'cron' dans puppet qui permettent le management des lignes de crontab pour un utilisateur donné.
</p>
<h3><span class="mw-headline" id="files_4"><span class="mw-headline-number">7.13.3</span> files</span></h3>
<p>Voici le fichier de configuration pour Red Hat&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/ntp/files/RedHat.ntp.conf</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1"># For more information about this file, see the man pages
# ntp.conf(5), ntp_acc(5), ntp_auth(5), ntp_clock(5), ntp_misc(5), ntp_mon(5).
&#160;
driftfile /var/lib/ntp/drift
&#160;
# Permit time synchronization with our time source, but do not
# permit the source to query or modify the service on this system.
restrict default kod nomodify notrap nopeer noquery
restrict -6 default kod nomodify notrap nopeer noquery
&#160;
# Permit all access over the loopback interface.  This could
# be tightened as well, but to do so would effect some of
# the administrative functions.
restrict 127.0.0.1 
restrict -6&#160;::1
&#160;
# Hosts on local network are less restricted.
#restrict 192.168.1.0 mask 255.255.255.0 nomodify notrap
&#160;
# Use public servers from the pool.ntp.org project.
# Please consider joining the pool (http://www.pool.ntp.org/join.html).
server 0.rhel.pool.ntp.org
server 1.rhel.pool.ntp.org
server 2.rhel.pool.ntp.org
&#160;
#broadcast 192.168.1.255 autokey	# broadcast server
#broadcastclient			# broadcast client
#broadcast 224.0.1.1 autokey		# multicast server
#multicastclient 224.0.1.1		# multicast client
#manycastserver 239.255.254.254		# manycast server
#manycastclient 239.255.254.254 autokey # manycast client
&#160;
# Undisciplined Local Clock. This is a fake driver intended for backup
# and when no outside source of synchronized time is available. 
#server	127.127.1.0	# local clock
#fudge	127.127.1.0 stratum 10	
&#160;
# Enable public key cryptography.
#crypto
&#160;
includefile /etc/ntp/crypto/pw
&#160;
# Key file containing the keys and key identifiers used when operating
# with symmetric key cryptography. 
keys /etc/ntp/keys
&#160;
# Specify the key identifiers which are trusted.
#trustedkey 4 8 42
&#160;
# Specify the key identifier to use with the ntpdc utility.
#requestkey 8
&#160;
# Specify the key identifier to use with the ntpq utility.
#controlkey 8
&#160;
# Enable writing of statistics records.
#statistics clockstats cryptostats loopstats peerstats</pre></div></div>
</td></tr></table><br />
<h2><span class="mw-headline" id="MySecureShell"><span class="mw-headline-number">7.14</span> MySecureShell</span></h2>
<p>La configuration de MySecureShell n'est pas très complexe, seulement elle diffère généralement d'une machine à une autre, surtout si vous avez un gros parc. Vous souhaitez certainement avoir une gestion identique globale et pouvoir faire du custom sur certains utilisateurs, groupes, virtualhost, etc… C'est pourquoi nous allons gérer ceci de façon la plus simple possible, c'est à dire une configuration globale, puis des includes.
</p><p>Créons l'arborescence&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> mkdir</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">mkdir -p /etc/puppet/modules/mysecureshell/{manifests,files}</pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="init.pp_14"><span class="mw-headline-number">7.14.1</span> init.pp</span></h3>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/mysecureshell/manifests/init.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="sy0">/*</span> 
MySecureShell <span class="kw1">Module</span> <span class="kw1">for</span> Puppet
Made by Pierre Mavro
<span class="sy0">*/</span>
<span class="kw1">class</span> mysecureshell <span class="br0">&#123;</span>
    <span class="co1"># Check OS and request the appropriate function</span>
    <span class="kw1">case</span> $::operatingsystem <span class="br0">&#123;</span>
        <span class="st0">'RedHat'</span>&#160;: <span class="br0">&#123;</span>
            <span class="kw1">include</span> mysecureshell::redhat
        <span class="br0">&#125;</span>
        default&#160;: <span class="br0">&#123;</span>
            notice<span class="br0">&#40;</span><span class="st0">&quot;Module ${module_name} is not supported on ${::operatingsystem}&quot;</span><span class="br0">&#41;</span>
        <span class="br0">&#125;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="redhat.pp_12"><span class="mw-headline-number">7.14.2</span> redhat.pp</span></h3>
<p>Ici rien de sorcier, je m'assure que le package est bien installé et la configuration correctement poussée&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/mysecureshell/files/init.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="sy0">/*</span> 
MySecureShell <span class="kw1">Module</span> <span class="kw1">for</span> Puppet
Made by Pierre Mavro
<span class="sy0">*/</span>
<span class="kw1">class</span> mysecureshell::redhat
<span class="br0">&#123;</span>
     <span class="co1"># Install MySecureShell</span>
     package <span class="br0">&#123;</span> <span class="st0">'mysecureshell'</span>:
         <span class="kw1">ensure</span> <span class="sy0">=&gt;</span> <span class="st0">'installed'</span>
     <span class="br0">&#125;</span>
&#160;
     <span class="co1"># MySecureShell default configuration</span>
     file <span class="br0">&#123;</span>
          <span class="st0">'/etc/ssh/sftp_config'</span>&#160;:
               <span class="kw1">ensure</span> <span class="sy0">=&gt;</span> present,
               source <span class="sy0">=&gt;</span> <span class="st0">&quot;puppet:///modules/mysecureshell/${::osfamily}.sftp_config&quot;</span>,
               mode <span class="sy0">=&gt;</span> <span class="nu0">644</span>,
               owner <span class="sy0">=&gt;</span> root,
               group <span class="sy0">=&gt;</span> root
     <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="files_5"><span class="mw-headline-number">7.14.3</span> files</span></h3>
<p>Voici mon fichier globale, à la fin de celui ci vous noterez qu'il y a un include. Libre à vous de mettre ce que vous voulez dedans, d'en avoir plusieurs et d'envoyer le bon suivant des critères&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/mysecureshell/files/RedHat.sftp_config</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1"># HEADER: This file is managed by puppet.
# HEADER: While it can still be managed manually, it is definitely not recommended.
&#160;
#Default rules for everybody
&lt;Default&gt;
	GlobalDownload		0	#total speed download for all clients
	GlobalUpload		0	#total speed download for all clients (0 for unlimited)
	Download 			0 	#limit speed download for each connection
	Upload 				0	#unlimit speed upload for each connection
	StayAtHome			true	#limit client to his home
	VirtualChroot		true	#fake a chroot to the home account
	LimitConnection		100	#max connection for the server sftp
	LimitConnectionByUser	2	#max connection for the account
	LimitConnectionByIP	2	#max connection by ip for the account
	Home			/home/$USER	#overrite home of the user but if you want you can use
	IdleTimeOut		5m	#(in second) deconnect client is idle too long time
	ResolveIP		false	#resolve ip to dns
	IgnoreHidden	true	#treat all hidden files as if they don't exist
#	DirFakeUser		true	#Hide real file/directory owner (just change displayed permissions)
#	DirFakeGroup	true	#Hide real file/directory group (just change displayed permissions)
#	DirFakeMode		0400	#Hide real file/directory rights (just change displayed permissions)
#	HideFiles		&quot;^(lost\+found|public_html)$&quot;	#Hide file/directory which match
	HideNoAccess		true	#Hide file/directory which user has no access
#	MaxOpenFilesForUser	20	#limit user to open x files on same time
#	MaxWriteFilesForUser	10	#limit user to x upload on same time
#	MaxReadFilesForUser	10	#limit user to x download on same time
	DefaultRights		0640 0750	#Set default rights for new file and new directory
#	MinimumRights		0400 0700	#Set minimum rights for files and dirs
#	PathDenyFilter		&quot;^\.&quot;	#deny upload of directory/file which match this extented POSIX regex
	ShowLinksAsLinks	false	#show links as their destinations
#	ConnectionMaxLife	1d	#limits connection lifetime to 1 day
#	Charset			&quot;ISO-8859-15&quot;	#set charset of computer
#	GMTTime			+1	#set GMT Time (change if necessary)
&lt;/Default&gt;
&#160;
# Include another custom file
Include /etc/ssh/deimos_sftp_config	#include this valid configuration file</pre></div></div>
</td></tr></table><br />
<h2><span class="mw-headline" id="OpenLDAP_client_.26_Server"><span class="mw-headline-number">7.15</span> OpenLDAP client &amp; Server</span></h2>
<p>OpenLDAP peut s'avérer vite compliqué et il faut bien comprendre comment il fonctionne avant de le déployer. Je vous invite à <a href="Serveurs.html#OpenLDAP" title="Serveurs">regarder les documentations</a> là dessus avant de vous lancer dans ce module.
</p><p>Ce module est un gros morceau, j'y ai passé pas mal de temps pour qu'il fonctionne de façon complètement automatisée. Je vais être le plus explicite possible pour que tout soit bien clair. Je l'ai adapté pour une nomenclature des noms qui permet de genre de chose dans un parc informatique, mais nous pouvons nous référer à à peut prêt n'importe quoi.
</p><p>Dans le cas de ce module, pour bien le comprendre, il faut que je vous explique comment est constitué l'infrastructure. Nous pouvons partir du principe que nous avons un lot ou un cluster à 4 noeuds. Sur ces 4 noeuds, seuls les machines numérotées 1 et 2 sont serveurs OpenLDAP. Tous les noeuds sont clients des serveurs&#160;:
</p>
<div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">         +-------------------+      +-------------------+
         |  TO-DC-SRV-PRD-1  |      |  TO-DC-SRV-PRD-2  |
         |   OpenLDAP SRV1   |      |   OpenLDAP SRV2   |
         |  OpenLDAP Client  |      |  OpenLDAP Client  |
         +--------+----------+      +---------+---------+
                  |                           |
                  +---------------------------+
                  |                           |
         +--------+----------+       +--------+---------+
         |  TO-DC-SRV-PRD-3  |       | TO-DC-SRV-PRD-4  |
         |  OpenLDAP Client  |       | OpenLDAP Client  |
         +-------------------+       +------------------+</pre></div></div>
<p>Créons l'arborescence&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> mkdir</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">mkdir -p /etc/puppet/modules/openldap/{manifests,files,lib/facter,puppet/parser/functions}</pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="init.pp_15"><span class="mw-headline-number">7.15.1</span> init.pp</span></h3>
<p>Je viens charger ici tous mes manifests pour pouvoir en appeler leurs classes par la suite&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/openldap/manifests/init.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="sy0">/*</span> 
OpenLDAP <span class="kw1">Module</span> <span class="kw1">for</span> Puppet
Made by Pierre Mavro
<span class="sy0">*/</span>
<span class="kw1">class</span> openldap inherits openssh <span class="br0">&#123;</span>
    import <span class="st0">&quot;*.pp&quot;</span>
&#160;
    <span class="co1"># Check OS and request the appropriate function</span>
    <span class="kw1">case</span> $::operatingsystem <span class="br0">&#123;</span>
        <span class="st0">'RedHat'</span>&#160;: <span class="br0">&#123;</span>
            <span class="kw1">include</span> openldap::redhat
        <span class="br0">&#125;</span>
        <span class="co1">#'sunos':  { include packages_defaults::solaris }</span>
        default&#160;: <span class="br0">&#123;</span>
            notice<span class="br0">&#40;</span><span class="st0">&quot;Module ${module_name} is not supported on ${::operatingsystem}&quot;</span><span class="br0">&#41;</span>
        <span class="br0">&#125;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="redhat.pp_13"><span class="mw-headline-number">7.15.2</span> redhat.pp</span></h3>
<p>Je vais m'occuper ici de toute la gestion OpenLDAP&#160;:
</p>
<ul><li> Ligne 6 à 17&#160;: Préparation</li>
<li> Ligne 20&#160;: Configuration du client</li>
<li> Ligne 22 à 27&#160;: Configuration du serveur</li></ul>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/openldap/manifests/redhat.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1">/* 
OpenLDAP Module for Puppet
Made by Pierre Mavro
*/
class openldap::redhat inherits openldap {
    # Select generated ldap servers if no one is specified or join specified ones
    if empty(&quot;${ldap_servers}&quot;) == true
    {
        $comma_ldap_servers = &quot;$::generated_ldap_servers&quot;
    }
    else
    {
        $comma_ldap_servers = inline_template(&quot;<span class="sy0">&lt;%</span>= <span class="br0">&#40;</span>ldap_servers<span class="br0">&#41;</span>.<span class="me1">join</span><span class="br0">&#40;</span><span class="st0">','</span><span class="br0">&#41;</span> <span class="sy0">%&gt;</span>&quot;)
    }
&#160;
    # DNS lookup them to use IP address instead
    $ip_ldap_servers = dns2ip(&quot;${comma_ldap_servers}&quot;)
&#160;
    # OpenLDAP Client
    include openldap::redhat::ldapclient
&#160;
    # Check if the current host is a server or not
    $ip_hostname = dns2ip($::hostname)
    $array_ldap_servers = split($ip_ldap_servers, ',')
    if $ip_hostname in $array_ldap_servers {
        # OpenLDAP Server
        include openldap::redhat::ldapserver
    }
}</pre></div></div>
</td></tr></table><br />
<p>Nous utilisons une variable '$ldap_servers' stockée <a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#vars.pp">dans les variables globales</a> ou <a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#servers.pp">dans la configuration d'un node</a> avec la liste des serveurs LDAP par défaut souhaités&#160;:
</p>
<div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="co1"># Default LDAP servers</span>
<span class="co1">#$ldap_servers = [ '192.168.0.1', '192.168.0.2' ]</span>
<span class="re0">$ldap_servers</span> = <span class="br0">&#91;</span> <span class="br0">&#93;</span></pre></div></div>
<p>Si nous utilisons comme ici, un tableau vide, le parser empty (ligne 7) le détectera et nous utiliserons alors la génération automatique de la liste des serveurs LDAP à utiliser. Cette méthode utilise un facter pour détecter en fonction du nom de la machine son équivalent 1 et 2.
</p><p>Ensuite, il fera un reverse lookup pour convertir en IP, les éventuels noms DNS qui figureraient dans la liste des serveurs LDAP. Pour cela, nous utilisons un parser nommé dns2ip. Puis il y aura l'appel du manifest OpenLDAP client.
</p><p>Et pour finir, si le serveur actuelle figure dans la liste des serveurs OpenLDAP, alors on lui applique sa configuration.
</p>
<h3><span class="mw-headline" id="facter_3"><span class="mw-headline-number">7.15.3</span> facter</span></h3>
<h4><span class="mw-headline" id="generated_ldap_servers.rb"><span class="mw-headline-number">7.15.3.1</span> generated_ldap_servers.rb</span></h4>
<p>Ce facter récupère le hostname de la machine en question, si elle correspond à la nomenclature souhaitée, elle envoie dans un tableau les noms auto-générés des serveurs LDAP. Ensuite elle renvoie en résultat le tableau joint par des virgules&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/openldap/lib/facter/generated_ldap_servers.rb</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="co1"># Generated ldap servers</span>
Facter.<span class="me1">add</span><span class="br0">&#40;</span><span class="st0">&quot;generated_ldap_servers&quot;</span><span class="br0">&#41;</span> <span class="kw1">do</span>
  ldap_srv = <span class="br0">&#91;</span><span class="br0">&#93;</span>
&#160;
  <span class="co1"># Get current hostname and add -1 and -2 to define default LDAP servers</span>
  hostname = Facter.<span class="me1">value</span><span class="br0">&#40;</span><span class="st0">'hostname'</span><span class="br0">&#41;</span>
  <span class="kw1">if</span> hostname =~ <span class="sy0">/</span><span class="br0">&#40;</span>.<span class="sy0">*</span><span class="br0">&#41;</span><span class="sy0">-</span>\d<span class="sy0">+</span>$<span class="sy0">/</span>
    ldap_srv.<span class="me1">push</span><span class="br0">&#40;</span>$1 <span class="sy0">+</span> <span class="st0">'-1'</span>, $1 <span class="sy0">+</span> <span class="st0">'-2'</span><span class="br0">&#41;</span>
  <span class="kw1">end</span>
&#160;
  setcode <span class="kw1">do</span>
    <span class="co1"># Join them with a comma</span>
    ldap_srv.<span class="me1">join</span><span class="br0">&#40;</span><span class="st0">&quot;,&quot;</span><span class="br0">&#41;</span>
  <span class="kw1">end</span>
<span class="kw1">end</span></pre></div></div>
</td></tr></table><br />
<h4><span class="mw-headline" id="current_ldap_servers.rb"><span class="mw-headline-number">7.15.3.2</span> current_ldap_servers.rb</span></h4>
<p>Ce facter lit le fichier de configuration d'OpenLDAP pour voir la configuration qui lui ai appliquée et renvoie le résultat séparé par une virgule&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/openldap/lib/facter/current_ldap_servers.rb</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="co1"># Current ldap servers</span>
Facter.<span class="me1">add</span><span class="br0">&#40;</span><span class="st0">&quot;current_ldap_servers&quot;</span><span class="br0">&#41;</span> <span class="kw1">do</span>
  ldap_srv = <span class="br0">&#91;</span><span class="br0">&#93;</span>
  conf_ldap = <span class="br0">&#91;</span><span class="br0">&#93;</span>
  config_found = <span class="nu0">0</span>
&#160;
  <span class="co1"># Add in an array all ldap servers lines</span>
  f = <span class="kw4">File</span>.<span class="kw3">open</span><span class="br0">&#40;</span><span class="st0">'/etc/openldap/ldap.conf'</span>, <span class="st0">'r'</span><span class="br0">&#41;</span>
  f.<span class="me1">each_line</span> <span class="kw1">do</span> <span class="sy0">|</span>line<span class="sy0">|</span>
    <span class="kw1">if</span> line =~ <span class="sy0">/</span>^URI <span class="br0">&#40;</span>.<span class="sy0">*</span><span class="br0">&#41;</span><span class="sy0">/</span>
      config_found = <span class="nu0">1</span>
      conf_ldap = $1.<span class="kw3">split</span><span class="br0">&#40;</span><span class="st0">&quot; &quot;</span><span class="br0">&#41;</span>
    <span class="kw1">end</span>
  <span class="kw1">end</span>
  f.<span class="me1">close</span>
&#160;
  <span class="co1"># Get all LDAP servers names/IP</span>
  <span class="kw1">if</span> conf_ldap.<span class="me1">each</span> <span class="kw1">do</span> <span class="sy0">|</span>line<span class="sy0">|</span>
      <span class="kw1">if</span> line =~ <span class="sy0">/</span>ldap:\<span class="sy0">/</span>\<span class="sy0">/</span><span class="br0">&#40;</span>.<span class="sy0">*</span><span class="br0">&#41;</span>\<span class="sy0">//</span>
        ldap_srv.<span class="me1">push</span><span class="br0">&#40;</span>$1<span class="br0">&#41;</span>
      <span class="kw1">end</span>
    <span class="kw1">end</span>
  <span class="kw1">end</span>
&#160;
  setcode <span class="kw1">do</span>
    <span class="kw1">if</span> config_found == <span class="nu0">1</span>
      <span class="co1"># Join them with a comma</span>
      ldap_srv.<span class="me1">join</span><span class="br0">&#40;</span><span class="st0">&quot;,&quot;</span><span class="br0">&#41;</span>
    <span class="kw1">else</span>
      config_found
    <span class="kw1">end</span>
  <span class="kw1">end</span>
<span class="kw1">end</span></pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="Parser_2"><span class="mw-headline-number">7.15.4</span> Parser</span></h3>
<h4><span class="mw-headline" id="dns2ip.rb"><span class="mw-headline-number">7.15.4.1</span> dns2ip.rb</span></h4>
<p>Ce parser permet de renvoyer une fois traitées, une liste de machines séparées par des virgules. Le traitement est en fait la conversion de nom DNS en IP&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/openldap/lib/puppet/parser/functions/dns2ip.rb</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="co1"># Dns2IP for Puppet</span>
<span class="co1"># Made by Pierre Mavro</span>
<span class="co1"># Does a DNS lookup and returns an array of strings of the results</span>
<span class="co1"># Usage&#160;: need to send one string dns servers separated by comma. The return will be the same</span>
&#160;
<span class="kw3">require</span> <span class="st0">'resolv'</span>
&#160;
<span class="kw1">module</span> <span class="re2">Puppet::Parser::Functions</span>
  newfunction<span class="br0">&#40;</span><span class="re3">:dns2ip</span>, <span class="re3">:type</span> <span class="sy0">=&gt;</span> <span class="re3">:rvalue</span><span class="br0">&#41;</span> <span class="kw1">do</span> <span class="sy0">|</span>arguments<span class="sy0">|</span>
    result = <span class="br0">&#91;</span> <span class="br0">&#93;</span>
    <span class="co1"># Split comma sperated list in array</span>
    dns_array = arguments<span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span>.<span class="kw3">split</span><span class="br0">&#40;</span><span class="st0">','</span><span class="br0">&#41;</span>
    <span class="co1"># Push each DNS/IP address in result array</span>
    dns_array.<span class="me1">each</span> <span class="kw1">do</span> <span class="sy0">|</span>dns_name<span class="sy0">|</span>
      result.<span class="me1">push</span><span class="br0">&#40;</span>Resolv.<span class="me1">new</span>.<span class="me1">getaddresses</span><span class="br0">&#40;</span>dns_name<span class="br0">&#41;</span><span class="br0">&#41;</span>
    <span class="kw1">end</span>
    <span class="co1"># Join array with comma</span>
    dns_list = result.<span class="me1">join</span><span class="br0">&#40;</span><span class="st0">','</span><span class="br0">&#41;</span>
    <span class="co1"># Delete last comma if exist</span>
    good_dns_list = dns_list.<span class="kw3">gsub</span><span class="br0">&#40;</span><span class="sy0">/</span>,$<span class="sy0">/</span>, <span class="st0">''</span><span class="br0">&#41;</span>
    <span class="kw2">return</span> good_dns_list
  <span class="kw1">end</span>
<span class="kw1">end</span></pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="redhat_ldapclient.pp"><span class="mw-headline-number">7.15.5</span> redhat_ldapclient.pp</span></h3>
<p>Ce manifest va installer tous les packages nécessaire pour que le serveur devienne client OpenLDAP, puis va s'assurer que 2 services (vous noterez l'utilisation de tableau) tournent et qu'ils sont démarrés au boot. Ensuite on va utiliser les facters précédemment cités, ainsi que d'autres variables custom pour valider que la configuration présente sur le serveur est existante ou non. Dans le cas négatif, nous exécutons une commande qui nous fera la configuration du client OpenLDAP&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/openldap/manifests/redhat_ldapclient.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="sy0">/*</span> 
OpenLDAP <span class="kw1">Module</span> <span class="kw1">for</span> Puppet
Made by Pierre Mavro
<span class="sy0">*/</span>
<span class="kw1">class</span> openldap::redhat::ldapclient inherits openldap::redhat <span class="br0">&#123;</span>
	<span class="co1"># Install required clients pacakges </span>
	packages_install
	<span class="br0">&#123;</span> <span class="br0">&#91;</span>
		<span class="st0">'nss-pam-ldapd'</span>,
		<span class="st0">'openldap'</span>,
      	<span class="st0">'openldap-clients'</span>,
      	<span class="st0">'openssh-ldap'</span>
	<span class="br0">&#93;</span>: <span class="br0">&#125;</span>
&#160;
	<span class="co1"># Be sure that service is set to start at boot</span>
	service <span class="br0">&#123;</span>
		<span class="br0">&#91;</span><span class="st0">'nscd'</span>, <span class="st0">'nslcd'</span><span class="br0">&#93;</span>&#160;:
			enable <span class="sy0">=&gt;</span> <span class="kw2">true</span>,
			<span class="kw1">ensure</span> <span class="sy0">=&gt;</span> running,
			<span class="kw3">require</span> <span class="sy0">=&gt;</span> Package<span class="br0">&#91;</span><span class="st0">'nss-pam-ldapd'</span>, <span class="st0">'openldap'</span>, <span class="st0">'openldap-clients'</span>, <span class="st0">'openssh-ldap'</span><span class="br0">&#93;</span>
	<span class="br0">&#125;</span>
&#160;
	<span class="co1"># Configure LDAP client if current configuration doesn't match</span>
	<span class="kw1">if</span> <span class="br0">&#40;</span>$::current_ldap_servers&#160;!= <span class="re0">$ip_ldap_servers</span> <span class="kw1">or</span> $::current_ldap_servers == <span class="nu0">0</span><span class="br0">&#41;</span>
	<span class="br0">&#123;</span>
		<span class="kw3">exec</span> <span class="br0">&#123;</span>
			<span class="st0">&quot;authconfig --enableldap --enableldapauth --disablenis --enablecache --passalgo=sha512 --disableldaptls --disableldapstarttls --disablesssdauth --enablemkhomedir --enablepamaccess --enablecachecreds --enableforcelegacy --disablefingerprint --ldapserver=${ip_ldap_servers} --ldapbasedn=dc=openldap,dc=deimos,dc=fr --updateall&quot;</span>&#160;:
				logoutput <span class="sy0">=&gt;</span> <span class="kw2">true</span>,
				<span class="kw3">require</span> <span class="sy0">=&gt;</span> Service<span class="br0">&#91;</span><span class="st0">'nslcd'</span><span class="br0">&#93;</span>
		<span class="br0">&#125;</span>
	<span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="redhat_ldapserver.pp"><span class="mw-headline-number">7.15.6</span> redhat_ldapserver.pp</span></h3>
<p>Pour la partie serveur, nous allons vérifier l'existence de tous les dossiers, vérifier que les packages et services sont correctement configurés, envoyer les schémas customs et la configuration OpenLDAP&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/openldap/manifests/redhat_ldapserver.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="sy0">/*</span> 
OpenLDAP <span class="kw1">Module</span> <span class="kw1">for</span> Puppet
Made by Pierre Mavro
<span class="sy0">*/</span>
<span class="kw1">class</span> openldap::redhat::ldapserver inherits openldap::redhat <span class="br0">&#123;</span>
<span class="co1"># Install required clients pacakges </span>
    packages_install <span class="br0">&#123;</span>
        <span class="br0">&#91;</span><span class="st0">'openldap-servers'</span><span class="br0">&#93;</span>&#160;:
    <span class="br0">&#125;</span>
&#160;
    <span class="co1"># Copy schemas</span>
    file <span class="br0">&#123;</span>
        <span class="st0">&quot;/etc/openldap/schema&quot;</span>&#160;:
            <span class="kw1">ensure</span> <span class="sy0">=&gt;</span> directory,
            mode <span class="sy0">=&gt;</span> <span class="nu0">755</span>,
            owner <span class="sy0">=&gt;</span> root,
            group <span class="sy0">=&gt;</span> root,
            source <span class="sy0">=&gt;</span> <span class="st0">&quot;puppet:///openldap/schema/&quot;</span>,
            recurse <span class="sy0">=&gt;</span> <span class="kw2">true</span>
    <span class="br0">&#125;</span>
&#160;
    <span class="co1"># Copy configuration folder (new format)</span>
    file <span class="br0">&#123;</span>
        <span class="st0">&quot;/etc/openldap/slapd.d&quot;</span>&#160;:
            <span class="kw1">ensure</span> <span class="sy0">=&gt;</span> directory,
            mode <span class="sy0">=&gt;</span> <span class="nu0">700</span>,
            owner <span class="sy0">=&gt;</span> ldap,
            group <span class="sy0">=&gt;</span> ldap,
            source <span class="sy0">=&gt;</span> <span class="st0">&quot;puppet:///openldap/$::operatingsystem/slapd.d/&quot;</span>,
            recurse <span class="sy0">=&gt;</span> <span class="kw2">true</span>
    <span class="br0">&#125;</span>
&#160;
    <span class="co1"># Copy configuration file (old format)</span>
    file <span class="br0">&#123;</span>
        <span class="st0">&quot;/etc/openldap/slapd.conf&quot;</span>&#160;:
            <span class="kw1">ensure</span> <span class="sy0">=&gt;</span> present,
            mode <span class="sy0">=&gt;</span> <span class="nu0">700</span>,
            owner <span class="sy0">=&gt;</span> ldap,
            group <span class="sy0">=&gt;</span> ldap,
            source <span class="sy0">=&gt;</span> <span class="st0">&quot;puppet:///openldap/$::operatingsystem/slapd.conf&quot;</span>
    <span class="br0">&#125;</span>
&#160;
    <span class="co1"># Ensure rights are ok for folder LDAP database</span>
    file <span class="br0">&#123;</span>
        <span class="st0">&quot;/var/lib/ldap&quot;</span>&#160;:
            <span class="kw1">ensure</span> <span class="sy0">=&gt;</span> directory,
            mode <span class="sy0">=&gt;</span> <span class="nu0">700</span>,
            owner <span class="sy0">=&gt;</span> ldap,
            group <span class="sy0">=&gt;</span> ldap
    <span class="br0">&#125;</span>
&#160;
    <span class="co1"># Ensure rights are ok for folder pid and args</span>
    file <span class="br0">&#123;</span>
        <span class="st0">&quot;/var/run/openldap&quot;</span>&#160;:
            <span class="kw1">ensure</span> <span class="sy0">=&gt;</span> directory,
            mode <span class="sy0">=&gt;</span> <span class="nu0">755</span>,
            owner <span class="sy0">=&gt;</span> ldap,
            group <span class="sy0">=&gt;</span> ldap
    <span class="br0">&#125;</span>
&#160;
    <span class="co1"># Be sure that service is set to start at boot</span>
    service <span class="br0">&#123;</span>
        <span class="st0">'slapd'</span>&#160;:
            enable <span class="sy0">=&gt;</span> <span class="kw2">true</span>,
            <span class="kw1">ensure</span> <span class="sy0">=&gt;</span> running,
            <span class="kw3">require</span> <span class="sy0">=&gt;</span> <span class="kw4">File</span><span class="br0">&#91;</span><span class="st0">'/etc/openldap/slapd.conf'</span><span class="br0">&#93;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="files_6"><span class="mw-headline-number">7.15.7</span> files</span></h3>
<p>Pour vous donner une idée du contenu de files&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/openldap/files/*</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">.
`-- RedHat
    |-- slapd.conf
    `-- slapd.d
        |-- cn=config
        |   |-- cn=module{0}.ldif
        |   |-- cn=schema
        |   |   |-- cn={0}core.ldif
        |   |   |-- cn={1}cosine.ldif
        |   |   |-- cn={2}nis.ldif
        |   |   |-- cn={3}inetorgperson.ldif
        |   |   |-- cn={4}microsoft.ldif
        |   |   |-- cn={5}microsoft.ldif
        |   |   |-- cn={6}microsoft.ldif
        |   |   |-- cn={7}samba.ldif
        |   |   `-- cn={8}deimos.ldif
        |   |-- cn=schema.ldif
        |   |-- olcDatabase={-1}frontend.ldif
        |   |-- olcDatabase={0}config.ldif
        |   `-- olcDatabase={1}bdb.ldif
        `-- cn=config.ldif</pre></div></div>
</td></tr></table><br />
<p>Et pour la configuration du service LDAP&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/openldap/files/slapd.conf</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1"># Schema and objectClass definitions
include         /etc/openldap/schema/core.schema
include         /etc/openldap/schema/cosine.schema
include         /etc/openldap/schema/nis.schema
include         /etc/openldap/schema/inetorgperson.schema
include         /etc/openldap/schema/microsoft.schema
include         /etc/openldap/schema/microsoft.sfu.schema
include         /etc/openldap/schema/microsoft.exchange.schema
include         /etc/openldap/schema/samba.schema
include	    /etc/openldap/schema/deimos.schema
&#160;
&#160;
# Where the pid file is put. The init.d script
# will not stop the server if you change this.
pidfile         /var/run/openldap/slapd.pid
&#160;
# List of arguments that were passed to the server
argsfile        /var/run/openldap/slapd.args
&#160;
# Read slapd.conf(5) for possible values
loglevel        0
&#160;
# Where the dynamically loaded modules are stored
modulepath	/usr/libexec/openldap
moduleload	back_bdb
#moduleload	back_meta
&#160;
# The maximum number of entries that is returned for a search operation
sizelimit 500
&#160;
# The tool-threads parameter sets the actual amount of cpu's that is used
# for indexing.
#tool-threads 1
&#160;
#######################################################################
# Specific Backend Directives for bdb:
# Backend specific directives apply to this backend until another
# 'backend' directive occurs
backend		bdb
&#160;
#######################################################################
# Specific Directives for database #1, of type bdb:
# Database specific directives apply to this databasse until another
# 'database' directive occurs
database        bdb
&#160;
# The base of your directory in database #1
suffix          &quot;dc=openldap,dc=deimos,dc=fr&quot;
&#160;
# rootdn directive for specifying a superuser on the database. This is needed
# for syncrepl.
rootdn          &quot;cn=admin,dc=openldap,dc=deimos,dc=fr&quot;
rootpw		{SSHA}Sh+Yd...
&#160;
# Where the database file are physically stored for database #1
directory       &quot;/var/lib/ldap&quot;
&#160;
# For the Debian package we use 2MB as default but be sure to update this
# value if you have plenty of RAM
dbconfig set_cachesize 0 2097152 0
&#160;
# Number of objects that can be locked at the same time.
dbconfig set_lk_max_objects 1500
# Number of locks (both requested and granted)
dbconfig set_lk_max_locks 1500
# Number of lockers
dbconfig set_lk_max_lockers 1500
&#160;
# Indexing options for database #1
index       objectClass eq
index       cn,sn,uid,mail  pres,eq,sub
index       mailnickname,userprincipalname,proxyaddresses  pres,eq,sub
index       entryUUID,entryCSN eq
&#160;
&#160;
# Save the time that the entry gets modified, for database #1
lastmod         on
&#160;
access to attrs=userPassword,shadowLastChange
        by dn=&quot;cn=replica,ou=Gestion Admin,ou=Utilisateurs,dc=openldap,dc=deimos,dc=fr&quot; write
        by anonymous auth
        by self write
        by * none
&#160;
access to *
        by dn=&quot;cn=replica,ou=Gestion Admin,ou=Utilisateurs,dc=openldap,dc=deimos,dc=fr&quot; write
        by * read
&#160;
access to dn.base=&quot;&quot; by * read</pre></div></div>
</td></tr></table><br />
<h2><span class="mw-headline" id="sudo"><span class="mw-headline-number">7.16</span> sudo</span></h2>
<p>Sudo devient vite indispensable lorsque l'on souhaite donner des droits privilégiés à des groupes ou des utilisateurs. <a href="./Sudo_:_Exécuter_des_commandes_en_root_sans_l'être.html" title="Sudo : Exécuter des commandes en root sans l'être">Regardez cette documentation</a> si vous avez besoin de plus d'informations.
</p>
<h3><span class="mw-headline" id="init.pp_16"><span class="mw-headline-number">7.16.1</span> init.pp</span></h3>
<p>Le fichier init.pp est le cœur de notre module, renseignez le comme ceci pour le moment&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/sudo/manifests/init.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="co1"># sudo.pp</span>
<span class="kw1">class</span> sudo <span class="br0">&#123;</span>
    <span class="co1"># OS detection</span>
    <span class="re0">$sudoers_file</span> = <span class="re0">$operatingsystem</span>&#160;? <span class="br0">&#123;</span>
	Solaris <span class="sy0">=&gt;</span> <span class="st0">&quot;/opt/csw/etc/sudoers&quot;</span>,
	default <span class="sy0">=&gt;</span> <span class="st0">&quot;/etc/sudoers&quot;</span>
    <span class="br0">&#125;</span>
&#160;
    <span class="co1"># Sudoers file declaration</span>
    file <span class="br0">&#123;</span> <span class="st0">&quot;$sudoers_file&quot;</span>:
        owner   <span class="sy0">=&gt;</span> root,
        group   <span class="sy0">=&gt;</span> root,
        mode    <span class="sy0">=&gt;</span> <span class="nu0">640</span>,
        source  <span class="sy0">=&gt;</span> <span class="re0">$operatingsystem</span>&#160;? <span class="br0">&#123;</span>
        	Solaris <span class="sy0">=&gt;</span> <span class="st0">&quot;puppet:///modules/sudo/sudoers.solaris&quot;</span>,
        	default <span class="sy0">=&gt;</span> <span class="st0">&quot;puppet:///modules/sudo/sudoers&quot;</span>
        <span class="br0">&#125;</span>
    <span class="br0">&#125;</span>
&#160;
    <span class="co1"># Symlink for solaris</span>
    <span class="kw1">case</span> <span class="re0">$operatingsystem</span> <span class="br0">&#123;</span>
	Solaris: <span class="br0">&#123;</span>
            file <span class="br0">&#123;</span><span class="st0">&quot;/opt/sfw/bin/sudo&quot;</span>:
                <span class="kw1">ensure</span> <span class="sy0">=&gt;</span> <span class="st0">&quot;/opt/csw/bin/sudo&quot;</span>
            <span class="br0">&#125;</span>
        <span class="br0">&#125;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<p>Je vais essayer d'être clair dans les explications&#160;:
</p>
<ul><li> Nous déclarons une classe sudo</li>
<li> On fait une détection d'OS. Cette déclaration est hérité d'une variable ($sudoers_file) qui nous permet de déclarer différents path du fichier sudoers.</li>
<li> Qui comprends un fichier de configuration se trouvant dans (name) /opt/csw/etc/sudoers sur le système cible (pour cette conf, c'est sur Solaris, a vous d'adapter)</li>
<li> Le fichier doit appartenir au user et groupe root avec les droits 440.</li>
<li> La source de ce fichier (que nous n'avons pas encore déposé) est disponible (source) à l'adresse puppet:///modules/sudo/sudoers (soit /etc/puppet/modules/<b>sudo</b>/files/<b>sudoers</b>). Il indique tout simplement l'emplacement des fichiers dans votre arborescence puppet qui utilise un méchanisme de système de fichier interne à Puppet.</li></ul>
<h4><span class="mw-headline" id="Am.C3.A9lioration_d.27un_module"><span class="mw-headline-number">7.16.1.1</span> Amélioration d'un module</span></h4>
<p>Editons le fichier pour lui rajouter quelques demandes
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/sudo/manifests/init.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="co1"># sudo.pp</span>
<span class="kw1">class</span> sudo <span class="br0">&#123;</span>
&#160;
    <span class="co1"># Check if sudo is the latest version</span>
    package <span class="br0">&#123;</span> sudo: <span class="kw1">ensure</span> <span class="sy0">=&gt;</span> latest <span class="br0">&#125;</span>
&#160;
    <span class="co1"># OS detection</span>
    <span class="re0">$sudoers_file</span> = <span class="re0">$operatingsystem</span>&#160;? <span class="br0">&#123;</span>
	Solaris <span class="sy0">=&gt;</span> <span class="st0">&quot;/opt/csw/etc/sudoers&quot;</span>,
	default <span class="sy0">=&gt;</span> <span class="st0">&quot;/etc/sudoers&quot;</span>
    <span class="br0">&#125;</span>
&#160;
    <span class="co1"># Sudoers file declaration</span>
    file <span class="br0">&#123;</span> <span class="st0">&quot;$sudoers_file&quot;</span>:
        owner   <span class="sy0">=&gt;</span> root,
        group   <span class="sy0">=&gt;</span> root,
        mode    <span class="sy0">=&gt;</span> <span class="nu0">640</span>,
        source  <span class="sy0">=&gt;</span> <span class="re0">$operatingsystem</span>&#160;? <span class="br0">&#123;</span>
        	Solaris <span class="sy0">=&gt;</span> <span class="st0">&quot;puppet:///modules/sudo/sudoers.solaris&quot;</span>,
        	default <span class="sy0">=&gt;</span> <span class="st0">&quot;puppet:///modules/sudo/sudoers&quot;</span>
        <span class="br0">&#125;</span>,
        <span class="kw3">require</span> <span class="sy0">=&gt;</span> Package<span class="br0">&#91;</span><span class="st0">&quot;sudo&quot;</span><span class="br0">&#93;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<ul><li> require =&gt; Package["sudo"]&#160;: on lui demande d'installer le package sudo s'il n'est pas installé</li>
<li> package { sudo: ensure =&gt; latest }&#160;: on lui demande de vérifier que c'est bien la dernière version</li></ul>
<h3><span class="mw-headline" id="files_7"><span class="mw-headline-number">7.16.2</span> files</span></h3>
<p>Maintenant, il faut ajouter les fichiers que nous souhaitons publier dans le dossier files (ici seulement sudoers)&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> cp</font>
</td></tr>
<tr>
<td>
<pre>cp /etc/sudoers /etc/puppet/modules/sudo/files/sudoers
cp /etc/sudoers /etc/puppet/modules/sudo/files/sudoers.solaris
</pre>
</td></tr></table><br />
<p>Pour la faire simple, j'ai simplement copier le sudoers du serveur vers la destination qui correspond à ma conf décrite plus haut.
</p><p>Si vous n'avez pas installé sudo sur le serveur, mettez un fichier sudoers qui vous convient dans /etc/puppet/modules/sudo/files/sudoers.<br />
</p><p>Dans les prochaines version, puppet supportera le protocole http et ftp pour aller chercher ces fichiers.
</p>
<h2><span class="mw-headline" id="snmpd"><span class="mw-headline-number">7.17</span> snmpd</span></h2>
<p>Le service snmpd est assez simple d'utilisation. C'est pourquoi ce module aussi&#160;:-). Créons l'arborescence&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> mkdir</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">mkdir -p /etc/puppet/modules/snmpd/{manifests,files}</pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="init.pp_17"><span class="mw-headline-number">7.17.1</span> init.pp</span></h3>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/snmpd/manifests/init.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="sy0">/*</span> 
Snmpd <span class="kw1">Module</span> <span class="kw1">for</span> Puppet
Made by Pierre Mavro
<span class="sy0">*/</span>
<span class="kw1">class</span> snmpd <span class="br0">&#123;</span>
<span class="co1"># Check OS and request the appropriate function</span>
    <span class="kw1">case</span> $::operatingsystem <span class="br0">&#123;</span>
        <span class="st0">'RedHat'</span>&#160;: <span class="br0">&#123;</span>
            <span class="kw1">include</span> snmpd::redhat
        <span class="br0">&#125;</span>
        <span class="co1">#'sunos':  { include packages_defaults::solaris }</span>
        default&#160;: <span class="br0">&#123;</span>
            notice<span class="br0">&#40;</span><span class="st0">&quot;Module ${module_name} is not supported on ${::operatingsystem}&quot;</span><span class="br0">&#41;</span>
        <span class="br0">&#125;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="redhat.pp_14"><span class="mw-headline-number">7.17.2</span> redhat.pp</span></h3>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/snmpd/manifests/redhat.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="sy0">/*</span> 
Snmpd <span class="kw1">Module</span> <span class="kw1">for</span> Puppet
Made by Pierre Mavro
<span class="sy0">*/</span>
<span class="kw1">class</span> snmpd::redhat <span class="br0">&#123;</span>
    <span class="co1"># Install snmp packages</span>
    package <span class="br0">&#123;</span>
        <span class="st0">'net-snmp'</span>:
            <span class="kw1">ensure</span> <span class="sy0">=&gt;</span> present
    <span class="br0">&#125;</span>
&#160;
    <span class="co1"># Snmpd config file</span>
    file <span class="br0">&#123;</span>
        <span class="st0">&quot;/etc/snmp/snmpd.conf&quot;</span>:
            source <span class="sy0">=&gt;</span> <span class="st0">&quot;puppet:///modules/snmpd/snmpd.conf.$::operatingsystem&quot;</span>,
            mode <span class="sy0">=&gt;</span> <span class="nu0">644</span>,
            owner <span class="sy0">=&gt;</span> root,
            group <span class="sy0">=&gt;</span> root,
            notify  <span class="sy0">=&gt;</span> Service<span class="br0">&#91;</span><span class="st0">&quot;snmpd&quot;</span><span class="br0">&#93;</span>
    <span class="br0">&#125;</span>
&#160;
    <span class="co1"># Service should start on boot and be running </span>
    service <span class="br0">&#123;</span>
        <span class="st0">'snmpd'</span>:
            enable <span class="sy0">=&gt;</span> <span class="kw2">true</span>,
            <span class="kw1">ensure</span> <span class="sy0">=&gt;</span> running,
            <span class="kw3">require</span> <span class="sy0">=&gt;</span> <span class="kw4">File</span><span class="br0">&#91;</span><span class="st0">'/etc/snmp/snmpd.conf'</span><span class="br0">&#93;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="files_8"><span class="mw-headline-number">7.17.3</span> files</span></h3>
<p>Et le fichier de configuration&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/snmpd/files/snmpd.conf.RedHat</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1"># Generated by Puppet
###########################################################################
#
# snmpd.conf
#
#   - created by the snmpconf configuration program
#
&#160;
###########################################################################
# SECTION: System Information Setup
#
#   This section defines some of the information reported in
#   the &quot;system&quot; mib group in the mibII tree.
&#160;
# syslocation: The [typically physical] location of the system.
#   Note that setting this value here means that when trying to
#   perform an snmp SET operation to the sysLocation.0 variable will make
#   the agent return the &quot;notWritable&quot; error code.  IE, including
#   this token in the snmpd.conf file will disable write access to
#   the variable.
#   arguments:  location_string
&#160;
syslocation Unknown (edit /etc/snmp/snmpd.conf)
&#160;
# syscontact: The contact information for the administrator
#   Note that setting this value here means that when trying to
#   perform an snmp SET operation to the sysContact.0 variable will make
#   the agent return the &quot;notWritable&quot; error code.  IE, including
#   this token in the snmpd.conf file will disable write access to
#   the variable.
#   arguments:  contact_string
&#160;
syscontact Root &lt;root@localhost&gt; (configure /etc/snmp/snmp.local.conf)
&#160;
###########################################################################
# SECTION: Access Control Setup
#
#   This section defines who is allowed to talk to your running
#   snmp agent.
&#160;
# rocommunity: a SNMPv1/SNMPv2c read-only access community name
#   arguments:  community [default|hostname|network/bits] [oid]
&#160;
rocommunity  lookdeimos 
&#160;
#
# Unknown directives read in from other files by snmpconf
#
com2sec notConfigUser  default       public
group   notConfigGroup v1           notConfigUser
group   notConfigGroup v2c           notConfigUser
view    systemview    included   .1.3.6.1.2.1.1
view    systemview    included   .1.3.6.1.2.1.25.1.1
access  notConfigGroup &quot;&quot;      any       noauth    exact  systemview none none
dontLogTCPWrappersConnects yes</pre></div></div>
</td></tr></table><br />
<h2><span class="mw-headline" id="Postfix"><span class="mw-headline-number">7.18</span> Postfix</span></h2>
<p>Pour postfix, nous allons utiliser des templates pour faciliter certaines configurations. Si vous avez besoin de plus d'informations sur comment configurer Postfix, je vous conseil <a href="Serveurs.html#Postfix" title="Serveurs">ces documentations</a>.
</p>
<h3><span class="mw-headline" id="init.pp_18"><span class="mw-headline-number">7.18.1</span> init.pp</span></h3>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/postfix/manifests/init.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="sy0">/*</span> 
Postix <span class="kw1">Module</span> <span class="kw1">for</span> Puppet
Made by Pierre Mavro
<span class="sy0">*/</span>
<span class="kw1">class</span> postfix <span class="br0">&#123;</span>
<span class="co1"># Check OS and request the appropriate function</span>
    <span class="kw1">case</span> $::operatingsystem <span class="br0">&#123;</span>
        <span class="st0">'RedHat'</span>&#160;: <span class="br0">&#123;</span>
            <span class="kw1">include</span> postfix::redhat
        <span class="br0">&#125;</span>
        <span class="co1">#'sunos':  { include packages_defaults::solaris }</span>
        default&#160;: <span class="br0">&#123;</span>
            notice<span class="br0">&#40;</span><span class="st0">&quot;Module ${module_name} is not supported on ${::operatingsystem}&quot;</span><span class="br0">&#41;</span>
        <span class="br0">&#125;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="redhat.pp_15"><span class="mw-headline-number">7.18.2</span> redhat.pp</span></h3>
<p>J'utilise ici des transport map qui nécessite d'être reconstruite si leur configuration change. C'est pourquoi nous utilisons 'Subscribe' dans la directive 'Exec'&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/postfix/manifests/redhat.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="sy0">/*</span> 
Postfix <span class="kw1">Module</span> <span class="kw1">for</span> Puppet
Made by Pierre Mavro
<span class="sy0">*/</span>
<span class="kw1">class</span> postfix::redhat <span class="br0">&#123;</span>
<span class="co1"># Install postfix packages</span>
    package <span class="br0">&#123;</span>
        <span class="st0">'postfix'</span>&#160;:
            <span class="kw1">ensure</span> <span class="sy0">=&gt;</span> present
    <span class="br0">&#125;</span>
&#160;
    <span class="co1"># Postfix main config file</span>
    file <span class="br0">&#123;</span>
        <span class="st0">&quot;/etc/postfix/main.cf&quot;</span>&#160;:
            content <span class="sy0">=&gt;</span> template<span class="br0">&#40;</span><span class="st0">&quot;postfix/main.cf.$::operatingsystem&quot;</span><span class="br0">&#41;</span>,
            mode <span class="sy0">=&gt;</span> <span class="nu0">644</span>,
            owner <span class="sy0">=&gt;</span> root,
            group <span class="sy0">=&gt;</span> root,
            notify <span class="sy0">=&gt;</span> Service<span class="br0">&#91;</span><span class="st0">&quot;postfix&quot;</span><span class="br0">&#93;</span>
    <span class="br0">&#125;</span>
&#160;
    <span class="co1"># Postfix transport map</span>
    file <span class="br0">&#123;</span>
        <span class="st0">&quot;/etc/postfix/transport&quot;</span>&#160;:
            source <span class="sy0">=&gt;</span> <span class="st0">&quot;puppet:///modules/postfix/transport&quot;</span>,
            mode <span class="sy0">=&gt;</span> <span class="nu0">644</span>,
            owner <span class="sy0">=&gt;</span> root,
            group <span class="sy0">=&gt;</span> root,
            notify <span class="sy0">=&gt;</span> Service<span class="br0">&#91;</span><span class="st0">&quot;postfix&quot;</span><span class="br0">&#93;</span>
    <span class="br0">&#125;</span>
&#160;
    <span class="co1"># Rebuild the transport map</span>
    <span class="kw3">exec</span> <span class="br0">&#123;</span>
        <span class="st0">'build_transport_map'</span>&#160;:
            command <span class="sy0">=&gt;</span> <span class="st0">&quot;/usr/sbin/postmap /etc/postfix/transport&quot;</span>,
            subscribe <span class="sy0">=&gt;</span> <span class="kw4">File</span><span class="br0">&#91;</span><span class="st0">&quot;/etc/postfix/transport&quot;</span><span class="br0">&#93;</span>,
            refreshonly <span class="sy0">=&gt;</span> <span class="kw2">true</span>
    <span class="br0">&#125;</span>
&#160;
    <span class="co1"># Service should start on boot and be running </span>
    service <span class="br0">&#123;</span>
        <span class="st0">'postfix'</span>&#160;:
            enable <span class="sy0">=&gt;</span> <span class="kw2">true</span>,
            <span class="kw1">ensure</span> <span class="sy0">=&gt;</span> running,
            <span class="kw3">require</span> <span class="sy0">=&gt;</span> <span class="kw4">File</span><span class="br0">&#91;</span><span class="st0">'/etc/postfix/main.cf'</span><span class="br0">&#93;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="templates_5"><span class="mw-headline-number">7.18.3</span> templates</span></h3>
<p>Ici j'ai mon fqdn qui est unique en fonction de la machine&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/postfix/manifests/templates/main.cf.RedHat</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1"># Generated by Puppet
&#160;
# Postfix directories
queue_directory = /var/spool/postfix
command_directory = /usr/sbin
daemon_directory = /usr/libexec/postfix
data_directory = /var/lib/postfix
sendmail_path = /usr/sbin/sendmail.postfix
newaliases_path = /usr/bin/newaliases.postfix
mailq_path = /usr/bin/mailq.postfix
&#160;
# Inet configuration
inet_interfaces = all
inet_protocols = all
&#160;
# Reject unknow recipents
unknown_local_recipient_reject_code = 550
&#160;
# Do not set relayhost. Postfix must use transport_maps
relayhost = 
&#160;
# Destinations
mydomain = deimos.fr
myorigin = &lt;%= fqdn&#160;%&gt;
mydestination = $myorigin, localhost.$mydomain, localhost
&#160;
# Transport_maps permits to route email using Google exchangers
transport_maps = dbm:/etc/opt/csw/postfix/transport
# Add TLS to emails if possible
smtp_tls_security_level = may
&#160;
# Masquerade_domains hides hostnames from addresses
masquerade_domains = $mydomain
&#160;
# Aliases
alias_maps = hash:/etc/aliases
alias_database = hash:/etc/aliases
&#160;
# SMTP banner
smtpd_banner = $myhostname ESMTP $mail_name
&#160;
# Debug
debug_peer_level = 2
debugger_command =
	 PATH=/bin:/usr/bin:/usr/local/bin:/usr/X11R6/bin
	 ddd $daemon_directory/$process_name $process_id &amp; sleep 5
&#160;
# Postfix rights
mail_owner = postfix
setgid_group = postdrop
&#160;
# Helps
html_directory = no
manpage_directory = /usr/share/man
sample_directory = /usr/share/doc/postfix-2.6.6/samples
readme_directory = /usr/share/doc/postfix-2.6.6/README_FILES</pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="files_9"><span class="mw-headline-number">7.18.4</span> files</span></h3>
<p>Et dans mes files, j'ai mon fichier de transport_map&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/postfix/manifests/files/transport</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">deimos.fr      &#160;:google.com
.deimos.fr     &#160;:google.com</pre></div></div>
</td></tr></table><br />
<h2><span class="mw-headline" id="Nsswitch"><span class="mw-headline-number">7.19</span> Nsswitch</span></h2>
<p>Pour nsswitch, on va utiliser une technique avancée qui consiste à uiliser Facter (un built in qui permet de gagner beaucoup de temps). Facter propose d'avoir en gros des variables d'environnements spécifiques à Puppet qui permettent de faire des conditions suite à celà. Par exemple, je souhaites vérifier la présence d'un fichier qui va m'indiquer si mon serveur est en mode cluster (pour Sun Cluster) ou non et modifier le fichier nsswitch en fonction. Pour cela je vais donc utiliser facter.
</p><p>Créons l'arboresence&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> mkdir</font>
</td></tr>
<tr>
<td>
<pre>mkdir -p /etc/puppet/modules/nsswitch/{manifests,lib/facter}
</pre>
</td></tr></table><br />
<h3><span class="mw-headline" id="facter_4"><span class="mw-headline-number">7.19.1</span> facter</span></h3>
<p>Créons notre fichier de fact&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/nsswitch/lib/facter/is_cluster.rb</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="co1"># is_cluster.rb</span>
&#160;
Facter.<span class="me1">add</span><span class="br0">&#40;</span><span class="st0">&quot;is_cluster&quot;</span><span class="br0">&#41;</span> <span class="kw1">do</span>
        setcode <span class="kw1">do</span>
          <span class="co1">#%x{/bin/uname -i}.chomp</span>
		   <span class="kw4">FileTest</span>.<span class="me1">exists</span>?<span class="br0">&#40;</span><span class="st0">&quot;/etc/cluster/nodeid&quot;</span><span class="br0">&#41;</span>
        <span class="kw1">end</span>
<span class="kw1">end</span></pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="init.pp_19"><span class="mw-headline-number">7.19.2</span> init.pp</span></h3>
<p>Ensuite nous allons spécifier l'utilisation d'un template&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/nsswitch/manifests/init.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="kw1">class</span> nsswitch <span class="br0">&#123;</span>
	<span class="kw1">case</span> <span class="re0">$operatingsystem</span> <span class="br0">&#123;</span>
		Solaris:  <span class="br0">&#123;</span> <span class="kw1">include</span> nsswitch::solaris <span class="br0">&#125;</span>
			default: <span class="br0">&#123;</span> <span class="br0">&#125;</span>
		<span class="br0">&#125;</span>
<span class="br0">&#125;</span>
&#160;
<span class="kw1">class</span> nsswitch::solaris <span class="br0">&#123;</span>
	<span class="re0">$nsfilename</span> = <span class="re0">$operatingsystem</span>&#160;? <span class="br0">&#123;</span>
		Solaris <span class="sy0">=&gt;</span> <span class="st0">&quot;/etc/nsswitch.conf&quot;</span>,
		default <span class="sy0">=&gt;</span> <span class="st0">&quot;/etc/nsswitch.conf&quot;</span>
    <span class="br0">&#125;</span>
&#160;
	config_file <span class="br0">&#123;</span> <span class="st0">&quot;$nsfilename&quot;</span>:                                                                                       
		content <span class="sy0">=&gt;</span> template<span class="br0">&#40;</span><span class="st0">&quot;nsswitch/nsswitch.conf&quot;</span><span class="br0">&#41;</span>,
	<span class="br0">&#125;</span>                          
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="templates_6"><span class="mw-headline-number">7.19.3</span> templates</span></h3>
<p>Et maintenant le fichier de conf qui va faire appel au facter&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/nsswitch/templates/nsswitch.conf</font>
</td></tr>
<tr>
<td>
<pre>#
# Copyright 2006 Sun Microsystems, Inc.  All rights reserved.
# Use is subject to license terms.
#

#
# /etc/nsswitch.dns:
#
# An example file that could be copied over to /etc/nsswitch.conf; it uses
# DNS for hosts lookups, otherwise it does not use any other naming service.
#
# "hosts:" and "services:" in this file are used only if the
# /etc/netconfig file has a "-" for nametoaddr_libs of "inet" transports.

# DNS service expects that an instance of svc:/network/dns/client be
# enabled and online.

passwd:     files ldap
group:      files ldap

# You must also set up the /etc/resolv.conf file for DNS name
# server lookup.  See resolv.conf(4).
#hosts:      files dns

<b>hosts:      &lt;% if is_cluster -%&gt;cluster&lt;% end -%&gt; files dns</b>

# Note that IPv4 addresses are searched for in all of the ipnodes databases
# before searching the hosts databases.
#ipnodes:   files dns
#ipnodes:   files dns [TRYAGAIN=0]
ipnodes:   files dns [TRYAGAIN=0 ]

networks:   files
protocols:  files
rpc:        files
ethers:     files
#netmasks:   files
<b>netmasks:   &lt;% if is_cluster -%&gt;cluster&lt;% end -%&gt; files</b>
bootparams: files
publickey:  files
# At present there isn't a 'files' backend for netgroup;  the system will
#   figure it out pretty quickly, and won't use netgroups at all.
netgroup:   files
automount:  files
aliases:    files
services:   files
printers:       user files

auth_attr:  files
prof_attr:  files
project:    files

tnrhtp:     files
tnrhdb:     files
</pre>
</td></tr></table><br />
<h2><span class="mw-headline" id="Nagios_NRPE_.2B_plugins"><span class="mw-headline-number">7.20</span> Nagios NRPE + plugins</span></h2>
<p>Vous devez <a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Initialisation_d.27un_module" title="Puppet : Solution de gestion de fichier de configuration">initialiser le module</a> avant de continuer.
</p>
<h3><span class="mw-headline" id="init.pp_20"><span class="mw-headline-number">7.20.1</span> init.pp</span></h3>
<p>Imaginons que j'ai un dossier de plugins nagios que je souhaites déployer partout. Des fois j'en ajoute, j'en enlève, bref, je fais ma vie avec et je veux que ce soit pleinement synchronisé. Voici la marche à suivre&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/nrpe/manifests/init.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="co1">#nagios_plugins.pp</span>
<span class="kw1">class</span> nrpe <span class="br0">&#123;</span>
    <span class="co1"># Copy conf and send checks</span>
    <span class="kw1">include</span> nrpe::common
&#160;
    <span class="co1"># Check operating system</span>
    <span class="kw1">case</span> <span class="re0">$operatingsystem</span> <span class="br0">&#123;</span>
        Solaris: <span class="br0">&#123;</span>
            <span class="kw1">include</span> nrpe::service::solaris
        <span class="br0">&#125;</span>
        default: <span class="br0">&#123;</span> <span class="br0">&#125;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span>
&#160;
<span class="kw1">class</span> nrpe::common <span class="br0">&#123;</span>
    <span class="kw1">class</span> nrpe::configs <span class="br0">&#123;</span>
        <span class="co1"># Used for nrpe-deimos.cfg templates</span>
        <span class="re0">$nrpe_distrib</span> = <span class="re0">$operatingsystem</span>&#160;? <span class="br0">&#123;</span>
            <span class="st0">'Solaris'</span> <span class="sy0">=&gt;</span> <span class="st0">&quot;/opt/csw/libexec/nagios-plugins&quot;</span>,
            <span class="st0">'redhat'</span> <span class="sy0">=&gt;</span> <span class="st0">&quot;/home/deimos/checks/nrpe_scripts&quot;</span>,
            <span class="st0">'debian'</span> <span class="sy0">=&gt;</span> <span class="st0">&quot;/etc/nrpe&quot;</span>,
        <span class="br0">&#125;</span>
&#160;
        <span class="co1"># Used for nrpe-deimos.cfg templates</span>
        <span class="re0">$deimos_script</span> = <span class="re0">$operatingsystem</span>&#160;? <span class="br0">&#123;</span>
                <span class="st0">'Solaris'</span> <span class="sy0">=&gt;</span> <span class="st0">&quot;/opt/deimos/libexec&quot;</span>,
                <span class="st0">'redhat'</span> <span class="sy0">=&gt;</span> <span class="st0">&quot;/etc/nrpe.d&quot;</span>,
                <span class="st0">'debian'</span> <span class="sy0">=&gt;</span> <span class="st0">&quot;/etc/nrpe&quot;</span>,
        <span class="br0">&#125;</span>
&#160;
        <span class="co1"># Copy NRPE config file</span>
        file <span class="br0">&#123;</span> <span class="st0">'/opt/csw/etc/nrpe.cfg'</span>:
            mode <span class="sy0">=&gt;</span> <span class="nu0">644</span>, owner <span class="sy0">=&gt;</span> root, group <span class="sy0">=&gt;</span> root,
            content <span class="sy0">=&gt;</span> template<span class="br0">&#40;</span><span class="st0">'nrpe/nrpe.cfg'</span><span class="br0">&#41;</span>,
        <span class="br0">&#125;</span>
&#160;
        <span class="co1">## Copy and adapt NRPE deimos Config file ##</span>
        file <span class="br0">&#123;</span> <span class="st0">'/opt/csw/etc/nrpe-deimos.cfg'</span>:
            mode <span class="sy0">=&gt;</span> <span class="nu0">644</span>, owner <span class="sy0">=&gt;</span> root, group <span class="sy0">=&gt;</span> root,
            content <span class="sy0">=&gt;</span> template<span class="br0">&#40;</span><span class="st0">'nrpe/nrpe-deimos.cfg'</span><span class="br0">&#41;</span>,
        <span class="br0">&#125;</span>
    <span class="br0">&#125;</span>
&#160;
    <span class="kw1">class</span> nrpe::copy_checks <span class="br0">&#123;</span>
        <span class="co1">## Copy deimos Production NRPE Checks ##</span>
&#160;
        file <span class="br0">&#123;</span> <span class="st0">&quot;nrpe_prod_checks&quot;</span>:
            name <span class="sy0">=&gt;</span> <span class="re0">$operatingsystem</span>&#160;? <span class="br0">&#123;</span>
                <span class="st0">'Solaris'</span> <span class="sy0">=&gt;</span> <span class="st0">&quot;/opt/deimos/libexec&quot;</span>,
                <span class="st0">'redhat'</span> <span class="sy0">=&gt;</span> <span class="st0">&quot;/home/deimos/checks/nrpe_scripts&quot;</span>,
                <span class="st0">'debian'</span> <span class="sy0">=&gt;</span> <span class="st0">&quot;/etc/nrpe&quot;</span>,
            <span class="br0">&#125;</span>,
            <span class="kw1">ensure</span> <span class="sy0">=&gt;</span> directory,
            mode <span class="sy0">=&gt;</span> <span class="nu0">755</span>, owner <span class="sy0">=&gt;</span> root, group <span class="sy0">=&gt;</span> root,
            sourceselect <span class="sy0">=&gt;</span> all,
            source <span class="sy0">=&gt;</span> <span class="re0">$operatingsystem</span>&#160;? <span class="br0">&#123;</span>
                <span class="st0">'Solaris'</span> <span class="sy0">=&gt;</span> <span class="br0">&#91;</span> <span class="st0">&quot;puppet:///modules/nrpe/Nagios/nrpechecks/deimos&quot;</span>, <span class="st0">&quot;puppet:///modules/nrpe/Nagios/nrpechecks/system&quot;</span> <span class="br0">&#93;</span>,
            recurse <span class="sy0">=&gt;</span> <span class="kw2">true</span>,
            force <span class="sy0">=&gt;</span> <span class="kw2">true</span>,
            ignore <span class="sy0">=&gt;</span> <span class="st0">'.svn'</span>
        <span class="br0">&#125;</span>
    <span class="br0">&#125;</span>
&#160;
    <span class="kw1">include</span> nrpe::configs
    <span class="kw1">include</span> nrpe::copy_checks
<span class="br0">&#125;</span>
&#160;
<span class="kw1">class</span> nrpe::service::solaris <span class="br0">&#123;</span>
    <span class="co1">## Check service and restart if needed</span>
    file <span class="br0">&#123;</span> <span class="st0">'/var/svc/manifest/network/nagios-nrpe.xml'</span>:
        source <span class="sy0">=&gt;</span> <span class="st0">&quot;puppet:///modules/nrpe/nagios-nrpe.xml&quot;</span>,
        mode <span class="sy0">=&gt;</span> <span class="nu0">644</span>, owner <span class="sy0">=&gt;</span> root, group <span class="sy0">=&gt;</span> sys,
        before <span class="sy0">=&gt;</span> Service<span class="br0">&#91;</span><span class="st0">&quot;svc:/network/cswnrpe:default&quot;</span><span class="br0">&#93;</span>
    <span class="br0">&#125;</span>
&#160;
    <span class="co1"># Restart service if smf xml has changed</span>
    <span class="kw3">exec</span> <span class="br0">&#123;</span> <span class="st0">&quot;`svccfg import /var/svc/manifest/network/nagios-nrpe.xml`&quot;</span>&#160;:
    	subscribe <span class="sy0">=&gt;</span> <span class="kw4">File</span><span class="br0">&#91;</span><span class="st0">'/var/svc/manifest/network/nagios-nrpe.xml'</span><span class="br0">&#93;</span>,
    	refreshonly <span class="sy0">=&gt;</span> <span class="kw2">true</span>
	<span class="br0">&#125;</span>
&#160;
	<span class="co1"># Restart if one of those files have changed</span>
    service <span class="br0">&#123;</span> <span class="st0">&quot;svc:/network/cswnrpe:default&quot;</span>:
        <span class="kw1">ensure</span> <span class="sy0">=&gt;</span> running,
        manifest <span class="sy0">=&gt;</span> <span class="st0">&quot;/var/svc/manifest/network/nagios-nrpe.xml&quot;</span>,
        subscribe <span class="sy0">=&gt;</span> <span class="br0">&#91;</span> <span class="kw4">File</span><span class="br0">&#91;</span><span class="st0">'/opt/csw/etc/nrpe.cfg'</span><span class="br0">&#93;</span>, <span class="kw4">File</span><span class="br0">&#91;</span><span class="st0">'/opt/csw/etc/nrpe-deimos.cfg'</span><span class="br0">&#93;</span> <span class="br0">&#93;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<p>Ici&#160;:
</p>
<ul><li> purge permet d'effacer les fichiers qui n'existent plus</li>
<li> recurse&#160;: récursif</li>
<li> force&#160;: permet de forcer</li>
<li> before&#160;: permet d'être exécuter avant autre chose</li>
<li> subscribe&#160;: inscrit une dépendance par rapport à la valeur de celui ci</li>
<li> refreshonly&#160;: refraichit seulement si il y a des changements</li></ul>
<p>Avec le subscribe, vous pouvez le voir ici, on fait des listes de cette façon&#160;: [ élément_1, élément_2, élément_3... ]. Par contre, petite précision, la changement opère (ici un restart) <b>seulement si l'un des éléments dans la liste est modifié et non tous</b>.
</p><p>Vous pouvez voir également de la ligne 54 à 56, on fait du multi sourcing qui nous permet de spécifier plusieurs sources et en fonction de celles ci d'envoyer à un endroit le contenu de ces divers fichiers.
</p>
<h3><span class="mw-headline" id="files_10"><span class="mw-headline-number">7.20.2</span> files</span></h3>
<p>Pour la partie file, j'ai linké avec un <a href="Installation_et_configuration_d'un_repository_SVN.html#Un_repository_dans_un_autre_repository" title="Installation et configuration d'un repository SVN">svn externe</a> qui permet de m'affranchir de l'intégration des plugins dans la partie puppet (qui entre nous n'a rien à faire ici).
</p>
<h3><span class="mw-headline" id="templates_7"><span class="mw-headline-number">7.20.3</span> templates</span></h3>
<p>Il suffit de copier le dossier nagios_plugins dans files et de faire les templates ici (je ne ferais que le nrpe.cfg)&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /opt/csw/etc/nrpe.cfg</font>
</td></tr>
<tr>
<td>
<pre>...
command[check_load]=&lt;%= nrpe_distrib&#160;%&gt;/check_load -w 15,10,5 -c 30,25,20
command[sunos_check_rss_mem]=&lt;%= deimos_script&#160;%&gt;/check_rss_mem.pl -w $ARG1$ -c $ARG2$
...
</pre>
</td></tr></table><br />
<h2><span class="mw-headline" id="Munin"><span class="mw-headline-number">7.21</span> Munin</span></h2>
<p>Disclaimer&#160;: this work is mostly based upon DavidS work, available on his [<a rel="nofollow" class="external text" href="http://git.black.co.at/">git repo</a>]. In the scope of my work I needed to have munin support for freeBSD &amp; Solaris. I also wrote a class for snmp_plugins &amp; custom plugins. Some things are quite dependant from my infrastructure, like munin.conf generation script but it can easily be adapted to yours, by extracting data from your CMDB.
</p><p>It requires the munin_interfaces fact published here (and merged into DavidS repo, thanks to him), and [<a rel="nofollow" class="external text" href="http://nephilim.ml.org/~rip/puppet/extlookup.rb">Volcane’s extlookup function</a>] to store some parameters. Enough talking, this is the code&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> </font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="co1"># Munin config class</span>
<span class="co1"># Many parts taken from David Schmitt's http://git.black.co.at/</span>
<span class="co1"># FreeBSD &amp; Solaris + SNMP &amp; custom plugins support by Nicolas Szalay &lt;nico@gcu.info&gt;</span>
&#160;
<span class="kw1">class</span> munin::node <span class="br0">&#123;</span>
	<span class="kw1">case</span> <span class="re0">$operatingsystem</span> <span class="br0">&#123;</span>
		openbsd: <span class="br0">&#123;</span><span class="br0">&#125;</span>
		debian: <span class="br0">&#123;</span> <span class="kw1">include</span> munin::node::debian<span class="br0">&#125;</span>
		freebsd: <span class="br0">&#123;</span> <span class="kw1">include</span> munin::node::freebsd<span class="br0">&#125;</span>
		solaris: <span class="br0">&#123;</span> <span class="kw1">include</span> munin::node::solaris<span class="br0">&#125;</span>
		default: <span class="br0">&#123;</span><span class="br0">&#125;</span>
	<span class="br0">&#125;</span>
<span class="br0">&#125;</span>
&#160;
<span class="kw1">class</span> munin::node::debian <span class="br0">&#123;</span>
&#160;
	package <span class="br0">&#123;</span> <span class="st0">&quot;munin-node&quot;</span>: <span class="kw1">ensure</span> <span class="sy0">=&gt;</span> installed <span class="br0">&#125;</span>
&#160;
	file <span class="br0">&#123;</span> 
	<span class="st0">&quot;/etc/munin&quot;</span>:
		<span class="kw1">ensure</span> <span class="sy0">=&gt;</span> directory,
		mode <span class="sy0">=&gt;</span> 0755,
		owner <span class="sy0">=&gt;</span> root,
		group <span class="sy0">=&gt;</span> root;
&#160;
	<span class="st0">&quot;/etc/munin/munin-node.conf&quot;</span>:
		source <span class="sy0">=&gt;</span> <span class="st0">&quot;puppet://$fileserver/files/apps/munin/munin-node-debian.conf&quot;</span>,
		owner <span class="sy0">=&gt;</span> root,
		group <span class="sy0">=&gt;</span> root,
		mode <span class="sy0">=&gt;</span> 0644,
		before <span class="sy0">=&gt;</span> Package<span class="br0">&#91;</span><span class="st0">&quot;munin-node&quot;</span><span class="br0">&#93;</span>,
		notify <span class="sy0">=&gt;</span> Service<span class="br0">&#91;</span><span class="st0">&quot;munin-node&quot;</span><span class="br0">&#93;</span>,
	<span class="br0">&#125;</span>
&#160;
	service <span class="br0">&#123;</span> <span class="st0">&quot;munin-node&quot;</span>: <span class="kw1">ensure</span> <span class="sy0">=&gt;</span> running <span class="br0">&#125;</span>
&#160;
	<span class="kw1">include</span> munin::plugins::linux 
<span class="br0">&#125;</span>
&#160;
<span class="kw1">class</span> munin::node::freebsd <span class="br0">&#123;</span>
	package <span class="br0">&#123;</span> <span class="st0">&quot;munin-node&quot;</span>: <span class="kw1">ensure</span> <span class="sy0">=&gt;</span> installed, provider <span class="sy0">=&gt;</span> freebsd <span class="br0">&#125;</span>
&#160;
        file <span class="br0">&#123;</span> <span class="st0">&quot;/usr/local/etc/munin/munin-node.conf&quot;</span>:
                source <span class="sy0">=&gt;</span> <span class="st0">&quot;puppet://$fileserver/files/apps/munin/munin-node-freebsd.conf&quot;</span>,
                owner <span class="sy0">=&gt;</span> root,
                group <span class="sy0">=&gt;</span> wheel,
                mode <span class="sy0">=&gt;</span> 0644,
                before <span class="sy0">=&gt;</span> Package<span class="br0">&#91;</span><span class="st0">&quot;munin-node&quot;</span><span class="br0">&#93;</span>,
                notify <span class="sy0">=&gt;</span> Service<span class="br0">&#91;</span><span class="st0">&quot;munin-node&quot;</span><span class="br0">&#93;</span>,
        <span class="br0">&#125;</span>
&#160;
	service <span class="br0">&#123;</span> <span class="st0">&quot;munin-node&quot;</span>: <span class="kw1">ensure</span> <span class="sy0">=&gt;</span> running <span class="br0">&#125;</span>
&#160;
	<span class="kw1">include</span> munin::plugins::freebsd
<span class="br0">&#125;</span>
&#160;
<span class="kw1">class</span> munin::node::solaris <span class="br0">&#123;</span>
	<span class="co1"># &quot;hand made&quot; install, no package.</span>
	file <span class="br0">&#123;</span> <span class="st0">&quot;/etc/munin/munin-node.conf&quot;</span>:
		source <span class="sy0">=&gt;</span> <span class="st0">&quot;puppet://$fileserver/files/apps/munin/munin-node-solaris.conf&quot;</span>,
                owner <span class="sy0">=&gt;</span> root,
                group <span class="sy0">=&gt;</span> root,
                mode <span class="sy0">=&gt;</span> 0644
	<span class="br0">&#125;</span>
&#160;
	<span class="kw1">include</span> munin::plugins::solaris
<span class="br0">&#125;</span>
&#160;
<span class="kw1">class</span> munin::gatherer <span class="br0">&#123;</span>
	package <span class="br0">&#123;</span> <span class="st0">&quot;munin&quot;</span>:
		<span class="kw1">ensure</span> <span class="sy0">=&gt;</span> installed
	<span class="br0">&#125;</span>
&#160;
	<span class="co1"># custom version of munin-graph&#160;: forks &amp; generates many graphs in parallel</span>
	file <span class="br0">&#123;</span> <span class="st0">&quot;/usr/share/munin/munin-graph&quot;</span>:
		owner <span class="sy0">=&gt;</span> root,
		group <span class="sy0">=&gt;</span> root,
		mode <span class="sy0">=&gt;</span> 0755,
		source <span class="sy0">=&gt;</span> <span class="st0">&quot;puppet://$fileserver/files/apps/munin/gatherer/munin-graph&quot;</span>,
		<span class="kw3">require</span> <span class="sy0">=&gt;</span> Package<span class="br0">&#91;</span><span class="st0">&quot;munin&quot;</span><span class="br0">&#93;</span>
	<span class="br0">&#125;</span>
&#160;
	<span class="co1"># custon version of debian cron file. Month &amp; Year cron are generated once daily</span>
	file <span class="br0">&#123;</span> <span class="st0">&quot;/etc/cron.d/munin&quot;</span>:
		owner <span class="sy0">=&gt;</span> root,
		group <span class="sy0">=&gt;</span> root,
		mode <span class="sy0">=&gt;</span> 0644,
		source <span class="sy0">=&gt;</span> <span class="st0">&quot;puppet://$fileserver/files/apps/munin/gatherer/munin.cron&quot;</span>,
		<span class="kw3">require</span> <span class="sy0">=&gt;</span> Package<span class="br0">&#91;</span><span class="st0">&quot;munin&quot;</span><span class="br0">&#93;</span>
	<span class="br0">&#125;</span>
&#160;
	<span class="co1"># Ensure cron is running, to fetch every 5 minutes</span>
	service <span class="br0">&#123;</span> <span class="st0">&quot;cron&quot;</span>:
		<span class="kw1">ensure</span> <span class="sy0">=&gt;</span> running
	<span class="br0">&#125;</span>
&#160;
	<span class="co1"># Ruby DBI for mysql</span>
	package <span class="br0">&#123;</span> <span class="st0">&quot;libdbd-mysql-ruby&quot;</span>:
		<span class="kw1">ensure</span> <span class="sy0">=&gt;</span> installed
	<span class="br0">&#125;</span>
&#160;
	<span class="co1"># config generator</span>
	file <span class="br0">&#123;</span> <span class="st0">&quot;/opt/scripts/muningen.rb&quot;</span>:
		owner <span class="sy0">=&gt;</span> root,
		group <span class="sy0">=&gt;</span> root,
		mode <span class="sy0">=&gt;</span> 0755,
		source <span class="sy0">=&gt;</span> <span class="st0">&quot;puppet://$fileserver/files/apps/munin/gatherer/muningen.rb&quot;</span>,
		<span class="kw3">require</span> <span class="sy0">=&gt;</span> Package<span class="br0">&#91;</span><span class="st0">&quot;munin&quot;</span>, <span class="st0">&quot;libdbd-mysql-ruby&quot;</span><span class="br0">&#93;</span>
	<span class="br0">&#125;</span>	
&#160;
	<span class="co1"># regenerate munin's gatherer config every hour</span>
	cron <span class="br0">&#123;</span> <span class="st0">&quot;munin_config&quot;</span>:
		command <span class="sy0">=&gt;</span> <span class="st0">&quot;/opt/scripts/muningen.rb &gt; /etc/munin/munin.conf&quot;</span>,
		user <span class="sy0">=&gt;</span> <span class="st0">&quot;root&quot;</span>,
		minute <span class="sy0">=&gt;</span> <span class="st0">&quot;0&quot;</span>,
		<span class="kw3">require</span> <span class="sy0">=&gt;</span> <span class="kw4">File</span><span class="br0">&#91;</span><span class="st0">&quot;/opt/scripts/muningen.rb&quot;</span><span class="br0">&#93;</span>
	<span class="br0">&#125;</span>
&#160;
	<span class="kw1">include</span> munin::plugins::snmp
	<span class="kw1">include</span> munin::plugins::linux
	<span class="kw1">include</span> munin::plugins::custom::gatherer
<span class="br0">&#125;</span>
&#160;
&#160;
<span class="co1"># define to create a munin plugin inside the right directory</span>
define munin::plugin <span class="br0">&#40;</span>$ensure = <span class="st0">&quot;present&quot;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
&#160;
	<span class="kw1">case</span> <span class="re0">$operatingsystem</span> <span class="br0">&#123;</span>
		freebsd: <span class="br0">&#123;</span> 
			<span class="re0">$script_path</span> = <span class="st0">&quot;/usr/local/share/munin/plugins&quot;</span>
			<span class="re0">$plugins_dir</span> = <span class="st0">&quot;/usr/local/etc/munin/plugins&quot;</span>
		<span class="br0">&#125;</span>
		debian: <span class="br0">&#123;</span> 
			<span class="re0">$script_path</span> = <span class="st0">&quot;/usr/share/munin/plugins&quot;</span>
			<span class="re0">$plugins_dir</span> = <span class="st0">&quot;/etc/munin/plugins&quot;</span>
		<span class="br0">&#125;</span>
		solaris: <span class="br0">&#123;</span> 
			<span class="re0">$script_path</span> = <span class="st0">&quot;/usr/local/munin/lib/plugins&quot;</span>
			<span class="re0">$plugins_dir</span> = <span class="st0">&quot;/etc/munin/plugins&quot;</span>
		<span class="br0">&#125;</span>
		default: <span class="br0">&#123;</span> <span class="br0">&#125;</span>
	<span class="br0">&#125;</span>
&#160;
	<span class="re0">$plugin</span> = <span class="st0">&quot;$plugins_dir/$name&quot;</span>
&#160;
	<span class="kw1">case</span> <span class="re0">$ensure</span> <span class="br0">&#123;</span>
		<span class="st0">&quot;absent&quot;</span>: <span class="br0">&#123;</span>
			debug <span class="br0">&#40;</span> <span class="st0">&quot;munin_plugin: suppressing $plugin&quot;</span> <span class="br0">&#41;</span>
			file <span class="br0">&#123;</span> <span class="re0">$plugin</span>: <span class="kw1">ensure</span> <span class="sy0">=&gt;</span> absent, <span class="br0">&#125;</span> 
		<span class="br0">&#125;</span>
&#160;
		default: <span class="br0">&#123;</span>
			<span class="re0">$plugin_src</span> = <span class="re0">$ensure</span>&#160;? <span class="br0">&#123;</span> <span class="st0">&quot;present&quot;</span> <span class="sy0">=&gt;</span> <span class="re0">$name</span>, default <span class="sy0">=&gt;</span> <span class="re0">$ensure</span> <span class="br0">&#125;</span>
&#160;
			file <span class="br0">&#123;</span> <span class="re0">$plugin</span>:
				<span class="kw1">ensure</span> <span class="sy0">=&gt;</span> <span class="st0">&quot;$script_path/${plugin_src}&quot;</span>,
				<span class="kw3">require</span> <span class="sy0">=&gt;</span> Package<span class="br0">&#91;</span><span class="st0">&quot;munin-node&quot;</span><span class="br0">&#93;</span>,
				notify <span class="sy0">=&gt;</span> Service<span class="br0">&#91;</span><span class="st0">&quot;munin-node&quot;</span><span class="br0">&#93;</span>,
			<span class="br0">&#125;</span>
		<span class="br0">&#125;</span>
	<span class="br0">&#125;</span>
<span class="br0">&#125;</span>
&#160;
<span class="co1"># snmp plugin define, almost same as above</span>
define munin::snmp_plugin <span class="br0">&#40;</span>$ensure = <span class="st0">&quot;present&quot;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
	<span class="re0">$pluginname</span> = get_plugin_name<span class="br0">&#40;</span>$name<span class="br0">&#41;</span>
&#160;
	<span class="kw1">case</span> <span class="re0">$operatingsystem</span> <span class="br0">&#123;</span>
		freebsd: <span class="br0">&#123;</span> 
			<span class="re0">$script_path</span> = <span class="st0">&quot;/usr/local/share/munin/plugins&quot;</span>
			<span class="re0">$plugins_dir</span> = <span class="st0">&quot;/usr/local/etc/munin/plugins&quot;</span>
		<span class="br0">&#125;</span>
		debian: <span class="br0">&#123;</span> 
			<span class="re0">$script_path</span> = <span class="st0">&quot;/usr/share/munin/plugins&quot;</span>
			<span class="re0">$plugins_dir</span> = <span class="st0">&quot;/etc/munin/plugins&quot;</span>
		<span class="br0">&#125;</span>
		solaris: <span class="br0">&#123;</span> 
			<span class="re0">$script_path</span> = <span class="st0">&quot;/usr/local/munin/lib/plugins&quot;</span>
			<span class="re0">$plugins_dir</span> = <span class="st0">&quot;/etc/munin/plugins&quot;</span>
		<span class="br0">&#125;</span>
		default: <span class="br0">&#123;</span> <span class="br0">&#125;</span>
	<span class="br0">&#125;</span>
&#160;
	<span class="re0">$plugin</span> = <span class="st0">&quot;$plugins_dir/$name&quot;</span>
&#160;
	<span class="kw1">case</span> <span class="re0">$ensure</span> <span class="br0">&#123;</span>
		<span class="st0">&quot;absent&quot;</span>: <span class="br0">&#123;</span>
			debug <span class="br0">&#40;</span> <span class="st0">&quot;munin_plugin: suppressing $plugin&quot;</span> <span class="br0">&#41;</span>
			file <span class="br0">&#123;</span> <span class="re0">$plugin</span>: <span class="kw1">ensure</span> <span class="sy0">=&gt;</span> absent, <span class="br0">&#125;</span> 
		<span class="br0">&#125;</span>
&#160;
		<span class="st0">&quot;present&quot;</span>: <span class="br0">&#123;</span>
			file <span class="br0">&#123;</span> <span class="re0">$plugin</span>:
				<span class="kw1">ensure</span> <span class="sy0">=&gt;</span> <span class="st0">&quot;$script_path/${pluginname}&quot;</span>,
				<span class="kw3">require</span> <span class="sy0">=&gt;</span> Package<span class="br0">&#91;</span><span class="st0">&quot;munin-node&quot;</span><span class="br0">&#93;</span>,
				notify <span class="sy0">=&gt;</span> Service<span class="br0">&#91;</span><span class="st0">&quot;munin-node&quot;</span><span class="br0">&#93;</span>,
			<span class="br0">&#125;</span>
		<span class="br0">&#125;</span>
	<span class="br0">&#125;</span>
<span class="br0">&#125;</span>
&#160;
<span class="kw1">class</span> munin::plugins::base
<span class="br0">&#123;</span>
	<span class="kw1">case</span> <span class="re0">$operatingsystem</span> <span class="br0">&#123;</span>
		debian: <span class="br0">&#123;</span> <span class="re0">$plugins_dir</span> = <span class="st0">&quot;/etc/munin/plugins&quot;</span> <span class="br0">&#125;</span>
		freebsd: <span class="br0">&#123;</span> <span class="re0">$plugins_dir</span> = <span class="st0">&quot;/usr/local/etc/munin/plugins&quot;</span> <span class="br0">&#125;</span>
		solaris: <span class="br0">&#123;</span> <span class="re0">$plugins_dir</span> = <span class="st0">&quot;/etc/munin/plugins&quot;</span> <span class="br0">&#125;</span>
		default: <span class="br0">&#123;</span><span class="br0">&#125;</span>
	<span class="br0">&#125;</span>
&#160;
	file <span class="br0">&#123;</span> <span class="re0">$plugins_dir</span>:
		source <span class="sy0">=&gt;</span> <span class="st0">&quot;puppet://$fileserver/files/empty&quot;</span>,
		<span class="kw1">ensure</span> <span class="sy0">=&gt;</span> directory,
		checksum <span class="sy0">=&gt;</span> mtime,
		ignore <span class="sy0">=&gt;</span> <span class="st0">&quot;.svn*&quot;</span>,
		mode <span class="sy0">=&gt;</span> 0755,
		recurse <span class="sy0">=&gt;</span> <span class="kw2">true</span>,
		purge <span class="sy0">=&gt;</span> <span class="kw2">true</span>,
		force <span class="sy0">=&gt;</span> <span class="kw2">true</span>,
		owner <span class="sy0">=&gt;</span> root
	<span class="br0">&#125;</span>
<span class="br0">&#125;</span>
&#160;
<span class="kw1">class</span> munin::plugins::interfaces
<span class="br0">&#123;</span>
	<span class="re0">$ifs</span> = <span class="kw3">gsub</span><span class="br0">&#40;</span><span class="kw3">split</span><span class="br0">&#40;</span>$munin_interfaces, <span class="st0">&quot; &quot;</span><span class="br0">&#41;</span>, <span class="st0">&quot;(.+)&quot;</span>, <span class="st0">&quot;if_<span class="es0">\\</span>1&quot;</span><span class="br0">&#41;</span>
	<span class="re0">$if_errs</span> = <span class="kw3">gsub</span><span class="br0">&#40;</span><span class="kw3">split</span><span class="br0">&#40;</span>$munin_interfaces, <span class="st0">&quot; &quot;</span><span class="br0">&#41;</span>, <span class="st0">&quot;(.+)&quot;</span>, <span class="st0">&quot;if_err_<span class="es0">\\</span>1&quot;</span><span class="br0">&#41;</span>
	plugin <span class="br0">&#123;</span>
		<span class="re0">$ifs</span>: <span class="kw1">ensure</span> <span class="sy0">=&gt;</span> <span class="st0">&quot;if_&quot;</span>;
		<span class="re0">$if_errs</span>: <span class="kw1">ensure</span> <span class="sy0">=&gt;</span> <span class="st0">&quot;if_err_&quot;</span>;
	<span class="br0">&#125;</span>
&#160;
	<span class="kw1">include</span> munin::plugins::base
<span class="br0">&#125;</span>
&#160;
<span class="kw1">class</span> munin::plugins::linux 
<span class="br0">&#123;</span>
	plugin <span class="br0">&#123;</span> <span class="br0">&#91;</span> cpu, <span class="kw3">load</span>, memory, swap, irq_stats, df, processes, open_files, ntp_offset, vmstat <span class="br0">&#93;</span>: 
		<span class="kw1">ensure</span> <span class="sy0">=&gt;</span> <span class="st0">&quot;present&quot;</span>
	<span class="br0">&#125;</span>
&#160;
	<span class="kw1">include</span> munin::plugins::base
	<span class="kw1">include</span> munin::plugins::interfaces
<span class="br0">&#125;</span>
&#160;
<span class="kw1">class</span> munin::plugins::nfsclient
<span class="br0">&#123;</span>
	plugin <span class="br0">&#123;</span> <span class="st0">&quot;nfs_client&quot;</span>:
		<span class="kw1">ensure</span> <span class="sy0">=&gt;</span> present
	<span class="br0">&#125;</span>
<span class="br0">&#125;</span>
&#160;
<span class="kw1">class</span> munin::plugins::snmp
<span class="br0">&#123;</span>
	<span class="co1"># initialize plugins</span>
	<span class="re0">$snmp_plugins</span>=extlookup<span class="br0">&#40;</span><span class="st0">&quot;munin_snmp_plugins&quot;</span><span class="br0">&#41;</span>
	snmp_plugin <span class="br0">&#123;</span> <span class="re0">$snmp_plugins</span>:
		<span class="kw1">ensure</span> <span class="sy0">=&gt;</span> present
	<span class="br0">&#125;</span>
&#160;
	<span class="co1"># SNMP communities used by plugins</span>
	file <span class="br0">&#123;</span> <span class="st0">&quot;/etc/munin/plugin-conf.d/snmp_communities&quot;</span>:
		owner <span class="sy0">=&gt;</span> root,
		group <span class="sy0">=&gt;</span> root,
		mode <span class="sy0">=&gt;</span> 0644,
		source <span class="sy0">=&gt;</span> <span class="st0">&quot;puppet://$fileserver/files/apps/munin/gatherer/snmp_communities&quot;</span>
	<span class="br0">&#125;</span>
&#160;
<span class="br0">&#125;</span>
&#160;
define munin::custom_plugin<span class="br0">&#40;</span>$ensure = <span class="st0">&quot;present&quot;</span>, <span class="re0">$location</span> = <span class="st0">&quot;/etc/munin/plugins&quot;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
	<span class="re0">$plugin</span> = <span class="st0">&quot;$location/$name&quot;</span>
&#160;
	<span class="kw1">case</span> <span class="re0">$ensure</span> <span class="br0">&#123;</span>
		<span class="st0">&quot;absent&quot;</span>: <span class="br0">&#123;</span>
			file <span class="br0">&#123;</span> <span class="re0">$plugin</span>: <span class="kw1">ensure</span> <span class="sy0">=&gt;</span> absent, <span class="br0">&#125;</span> 
		<span class="br0">&#125;</span>
&#160;
		<span class="st0">&quot;present&quot;</span>: <span class="br0">&#123;</span>
			file <span class="br0">&#123;</span> <span class="re0">$plugin</span>:
				owner <span class="sy0">=&gt;</span> root,
				mode <span class="sy0">=&gt;</span> 0755,
				source <span class="sy0">=&gt;</span> <span class="st0">&quot;puppet://$fileserver/files/apps/munin/custom_plugins/$name&quot;</span>,
				<span class="kw3">require</span> <span class="sy0">=&gt;</span> Package<span class="br0">&#91;</span><span class="st0">&quot;munin-node&quot;</span><span class="br0">&#93;</span>,
				notify <span class="sy0">=&gt;</span> Service<span class="br0">&#91;</span><span class="st0">&quot;munin-node&quot;</span><span class="br0">&#93;</span>,
			<span class="br0">&#125;</span>
		<span class="br0">&#125;</span>
	<span class="br0">&#125;</span>
<span class="br0">&#125;</span>
&#160;
<span class="kw1">class</span> munin::plugins::custom::gatherer
<span class="br0">&#123;</span>
	<span class="re0">$plugins</span>=extlookup<span class="br0">&#40;</span><span class="st0">&quot;munin_custom_plugins&quot;</span><span class="br0">&#41;</span>
	custom_plugin <span class="br0">&#123;</span> <span class="re0">$plugins</span>:
		<span class="kw1">ensure</span> <span class="sy0">=&gt;</span> present
	<span class="br0">&#125;</span>
<span class="br0">&#125;</span>
&#160;
<span class="kw1">class</span> munin::plugins::freebsd 
<span class="br0">&#123;</span>
	plugin <span class="br0">&#123;</span> <span class="br0">&#91;</span> cpu, <span class="kw3">load</span>, memory, swap, irq_stats, df, processes, open_files, ntp_offset, vmstat <span class="br0">&#93;</span>: 
		<span class="kw1">ensure</span> <span class="sy0">=&gt;</span> <span class="st0">&quot;present&quot;</span>,
	<span class="br0">&#125;</span>
&#160;
	<span class="kw1">include</span> munin::plugins::base
	<span class="kw1">include</span> munin::plugins::interfaces
<span class="br0">&#125;</span>
&#160;
<span class="kw1">class</span> munin::plugins::solaris 
<span class="br0">&#123;</span>
	<span class="co1"># Munin plugins on solaris are quite ... buggy. Will need rewrite / custom plugins.</span>
	plugin <span class="br0">&#123;</span> <span class="br0">&#91;</span> cpu, <span class="kw3">load</span>, netstat <span class="br0">&#93;</span>: 
		<span class="kw1">ensure</span> <span class="sy0">=&gt;</span> <span class="st0">&quot;present&quot;</span>,
	<span class="br0">&#125;</span>
&#160;
	<span class="kw1">include</span> munin::plugins::base
	<span class="kw1">include</span> munin::plugins::interfaces
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="Munin_Interfaces"><span class="mw-headline-number">7.21.1</span> Munin Interfaces</span></h3>
<p>Everyone using puppet knows DavidS awesome git repository&#160;: git.black.co.at. Unfornately for me, his puppet infrastructure seems to be almost only linux based. I have different OS in mine, including FreeBSD &amp; OpenSolaris. Looking at his module-munin I decided to reuse it (and not recreate the wheel) but he used a custom fact that needed some little work. So this is a FreeBSD &amp; (Open)Solaris capable version, to know what network interfaces have link up.
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> </font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="co1"># return the set of active interfaces as an array</span>
<span class="co1"># taken from http://git.black.co.at</span>
<span class="co1"># modified by nico &lt;nico@gcu.info&gt; to add FreeBSD &amp; Solaris support</span>
&#160;
Facter.<span class="me1">add</span><span class="br0">&#40;</span><span class="st0">&quot;munin_interfaces&quot;</span><span class="br0">&#41;</span> <span class="kw1">do</span>
&#160;
	setcode <span class="kw1">do</span>
		<span class="co1"># linux</span>
		<span class="kw1">if</span> Facter.<span class="me1">value</span><span class="br0">&#40;</span><span class="st0">'kernel'</span><span class="br0">&#41;</span> == <span class="st0">&quot;Linux&quot;</span> <span class="kw1">then</span>
			<span class="st0">`ip -o link show`</span>.<span class="kw3">split</span><span class="br0">&#40;</span><span class="sy0">/</span>\n<span class="sy0">/</span><span class="br0">&#41;</span>.<span class="me1">collect</span> <span class="kw1">do</span> <span class="sy0">|</span>line<span class="sy0">|</span>
					value = <span class="kw2">nil</span>
					matches = line.<span class="me1">match</span><span class="br0">&#40;</span><span class="sy0">/</span>^\d<span class="sy0">*</span>: <span class="br0">&#40;</span><span class="br0">&#91;</span>^:<span class="br0">&#93;</span><span class="sy0">*</span><span class="br0">&#41;</span>: <span class="sy0">&lt;</span><span class="br0">&#40;</span>.<span class="sy0">*</span>,<span class="br0">&#41;</span>?UP<span class="br0">&#40;</span>,.<span class="sy0">*</span><span class="br0">&#41;</span>?<span class="sy0">&gt;/</span><span class="br0">&#41;</span>
					<span class="kw1">if</span>&#160;!matches.<span class="kw2">nil</span>?
						value = matches<span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span>
						value.<span class="kw3">gsub!</span><span class="br0">&#40;</span><span class="sy0">/</span>@.<span class="sy0">*/</span>, <span class="st0">''</span><span class="br0">&#41;</span>
					<span class="kw1">end</span>
					value
			<span class="kw1">end</span>.<span class="me1">compact</span>.<span class="me1">sort</span>.<span class="me1">join</span><span class="br0">&#40;</span><span class="st0">&quot; &quot;</span><span class="br0">&#41;</span>
		<span class="co1">#end</span>
&#160;
		<span class="co1"># freebsd</span>
		<span class="kw1">elsif</span> Facter.<span class="me1">value</span><span class="br0">&#40;</span><span class="st0">'kernel'</span><span class="br0">&#41;</span> == <span class="st0">&quot;FreeBSD&quot;</span> <span class="kw1">then</span>
			Facter.<span class="me1">value</span><span class="br0">&#40;</span><span class="st0">'interfaces'</span><span class="br0">&#41;</span>.<span class="kw3">split</span><span class="br0">&#40;</span><span class="sy0">/</span>,<span class="sy0">/</span><span class="br0">&#41;</span>.<span class="me1">collect</span> <span class="kw1">do</span> <span class="sy0">|</span>interface<span class="sy0">|</span>
				status = <span class="st0">`ifconfig #{interface} | grep status`</span>
				<span class="kw1">if</span> status&#160;!= <span class="st0">&quot;&quot;</span> <span class="kw1">then</span>
					status=status.<span class="me1">strip</span>!.<span class="kw3">split</span><span class="br0">&#40;</span><span class="st0">&quot;:&quot;</span><span class="br0">&#41;</span><span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span>.<span class="me1">strip</span>!
					<span class="kw1">if</span> status == <span class="st0">&quot;active&quot;</span> <span class="kw1">then</span> <span class="co1"># I CAN HAZ LINK&#160;?</span>
						interface.<span class="me1">to_a</span>
					<span class="kw1">end</span>
				<span class="kw1">end</span>
			<span class="kw1">end</span>.<span class="me1">compact</span>.<span class="me1">sort</span>.<span class="me1">join</span><span class="br0">&#40;</span><span class="st0">&quot; &quot;</span><span class="br0">&#41;</span>
		<span class="co1">#end</span>
&#160;
		<span class="co1"># solaris</span>
		<span class="kw1">elsif</span> Facter.<span class="me1">value</span><span class="br0">&#40;</span><span class="st0">'kernel'</span><span class="br0">&#41;</span> == <span class="st0">&quot;SunOS&quot;</span> <span class="kw1">then</span>
			Facter.<span class="me1">value</span><span class="br0">&#40;</span><span class="st0">'interfaces'</span><span class="br0">&#41;</span>.<span class="kw3">split</span><span class="br0">&#40;</span><span class="sy0">/</span>,<span class="sy0">/</span><span class="br0">&#41;</span>.<span class="me1">collect</span> <span class="kw1">do</span> <span class="sy0">|</span>interface<span class="sy0">|</span>
				<span class="kw1">if</span> interface&#160;!= <span class="st0">&quot;lo0&quot;</span> <span class="kw1">then</span> <span class="co1"># /dev/lo0 does not exists</span>
					status = <span class="st0">`ndd -get /dev/#{interface} link_status`</span>.<span class="me1">strip</span>!
					<span class="kw1">if</span> status == <span class="st0">&quot;1&quot;</span> <span class="co1"># ndd returns 1 for link up, 0 for down</span>
						interface.<span class="me1">to_a</span>
					<span class="kw1">end</span>
				<span class="kw1">end</span>
			<span class="kw1">end</span>.<span class="me1">compact</span>.<span class="me1">sort</span>.<span class="me1">join</span><span class="br0">&#40;</span><span class="st0">&quot; &quot;</span><span class="br0">&#41;</span>
		<span class="kw1">end</span>
	<span class="kw1">end</span>
<span class="kw1">end</span></pre></div></div>
</td></tr></table><br />
<h2><span class="mw-headline" id="Mcollective"><span class="mw-headline-number">7.22</span> Mcollective</span></h2>
<p>Mcollective est un outil je l'on couple généralement à Puppet pour améliorer notre quotidien. Si vous ne connaissez pas ou voulez en apprendre plus, <a href="./MCollective_:_lancez_des_actions_en_parallèle_sur_des_machines_distante.html" title="MCollective : lancez des actions en parallèle sur des machines distante">suivez ce lien</a>.
</p><p>Ce module Mcollective pour Puppet permet d'installer mcollective, ainsi que des modules côté client (serveurs Mcollective). Avec les modules, voici à quoi ressemble mon arboresence&#160;:
</p>
<pre>
.
|-- files
|   |-- agent
|   |   |-- filemgr.rb
|   |   |-- nrpe.rb
|   |   |-- package.rb
|   |   |-- process.rb
|   |   |-- puppetd.rb
|   |   |-- service.rb
|   |   `-- shell.rb
|   |-- facts
|   |   `-- facter_facts.rb
|   `-- RedHat.server.cfg
`-- manifests
    |-- common.pp
    |-- init.pp
    `-- redhat.pp
</pre>
<p>Pour ce qui est des modules (agents,facts), je vous invite à regarder <a href="./MCollective_:_lancez_des_actions_en_parallèle_sur_des_machines_distante.html" title="MCollective : lancez des actions en parallèle sur des machines distante">ma doc sur Mcollective</a> pour savoir ou les récupérer. Créons l'arborescence&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> mkdir</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">mkdir -p /etc/puppet/modules/mcollective/{manifests,files}</pre></div></div>
</td></tr></table><br />
<p><br />
</p>
<h3><span class="mw-headline" id="init.pp_21"><span class="mw-headline-number">7.22.1</span> init.pp</span></h3>
<p>Le fichier init.pp est le cœur de notre module, renseignez le comme ceci&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/mcollective/manifests/init.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="sy0">/*</span> 
Mcollective <span class="kw1">Module</span> <span class="kw1">for</span> Puppet
Made by Pierre Mavro
<span class="sy0">*/</span>
<span class="kw1">class</span> mcollective <span class="br0">&#123;</span>
	<span class="co1"># Check OS and request the appropriate function</span>
	<span class="kw1">case</span> $::operatingsystem <span class="br0">&#123;</span>
		<span class="st0">'RedHat'</span>&#160;: <span class="br0">&#123;</span>
			<span class="kw1">include</span> mcollective::redhat
		<span class="br0">&#125;</span>
		default&#160;: <span class="br0">&#123;</span>
			notice<span class="br0">&#40;</span><span class="st0">&quot;Module ${module_name} is not supported on ${::operatingsystem}&quot;</span><span class="br0">&#41;</span>
		<span class="br0">&#125;</span>
	<span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="common.pp_4"><span class="mw-headline-number">7.22.2</span> common.pp</span></h3>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/mcollective/manifests/common.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="sy0">/*</span> 
Mcollective <span class="kw1">Module</span> <span class="kw1">for</span> Puppet
Made by Pierre Mavro
<span class="sy0">*/</span>
<span class="kw1">class</span> mcollective::common <span class="br0">&#123;</span>
	<span class="co1"># Used for nrpe.cfg file</span>
	<span class="re0">$mco_agent_dir</span> = <span class="re0">$operatingsystem</span>&#160;? <span class="br0">&#123;</span>
		<span class="st0">'RedHat'</span> <span class="sy0">=&gt;</span> <span class="st0">&quot;/usr/libexec/mcollective/mcollective&quot;</span>,
		<span class="st0">'Solaris'</span> <span class="sy0">=&gt;</span> <span class="st0">&quot;/usr/libexec/mcollective/mcollective&quot;</span>
	<span class="br0">&#125;</span>
&#160;
	<span class="co1"># Transfert agents</span>
	file <span class="br0">&#123;</span>
		<span class="st0">'mco_agent_folder'</span>&#160;:
			name <span class="sy0">=&gt;</span> <span class="st0">&quot;$mco_agent_dir/agent&quot;</span>,
			<span class="kw1">ensure</span> <span class="sy0">=&gt;</span> directory,
			mode <span class="sy0">=&gt;</span> <span class="nu0">644</span>,
			owner <span class="sy0">=&gt;</span> root,
			group <span class="sy0">=&gt;</span> root,
			source <span class="sy0">=&gt;</span> <span class="br0">&#91;</span><span class="st0">&quot;puppet:///modules/mcollective/agent&quot;</span><span class="br0">&#93;</span>,
			recurse <span class="sy0">=&gt;</span> <span class="kw2">true</span>,
			ignore <span class="sy0">=&gt;</span> <span class="st0">'.svn'</span>,
			backup <span class="sy0">=&gt;</span> <span class="kw2">false</span>,
			notify <span class="sy0">=&gt;</span> Service<span class="br0">&#91;</span><span class="st0">'mcollective'</span><span class="br0">&#93;</span>,
			<span class="kw3">require</span> <span class="sy0">=&gt;</span> Package<span class="br0">&#91;</span><span class="st0">'mcollective'</span><span class="br0">&#93;</span>
	<span class="br0">&#125;</span>
&#160;
	<span class="co1"># Transfert facts</span>
	file <span class="br0">&#123;</span>
		<span class="st0">'mco_facts_folder'</span>&#160;:
			name <span class="sy0">=&gt;</span> <span class="st0">&quot;$mco_agent_dir/facts&quot;</span>,
			<span class="kw1">ensure</span> <span class="sy0">=&gt;</span> directory,
			mode <span class="sy0">=&gt;</span> <span class="nu0">644</span>,
			owner <span class="sy0">=&gt;</span> root,
			group <span class="sy0">=&gt;</span> root,
			source <span class="sy0">=&gt;</span> <span class="br0">&#91;</span><span class="st0">&quot;puppet:///modules/mcollective/facts&quot;</span><span class="br0">&#93;</span>,
			recurse <span class="sy0">=&gt;</span> <span class="kw2">true</span>,
			ignore <span class="sy0">=&gt;</span> <span class="st0">'.svn'</span>,
			backup <span class="sy0">=&gt;</span> <span class="kw2">false</span>,
			notify <span class="sy0">=&gt;</span> Service<span class="br0">&#91;</span><span class="st0">'mcollective'</span><span class="br0">&#93;</span>,
			<span class="kw3">require</span> <span class="sy0">=&gt;</span> Package<span class="br0">&#91;</span><span class="st0">'mcollective'</span><span class="br0">&#93;</span>
	<span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="redhat.pp_16"><span class="mw-headline-number">7.22.3</span> redhat.pp</span></h3>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/mcollective/manifests/redhat.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="sy0">/*</span> 
Mcollective <span class="kw1">Module</span> <span class="kw1">for</span> Puppet
Made by Pierre Mavro
<span class="sy0">*/</span>
<span class="kw1">class</span> mcollective::redhat <span class="br0">&#123;</span>
<span class="co1"># Install Mcollective client</span>
	package <span class="br0">&#123;</span> <span class="br0">&#91;</span>
		<span class="st0">'mcollective'</span>,
		<span class="st0">'rubygem-stomp'</span>,
		<span class="st0">'rubygem-sysproctable'</span>
		<span class="br0">&#93;</span>:
		<span class="kw1">ensure</span> <span class="sy0">=&gt;</span> <span class="st0">'installed'</span>
	<span class="br0">&#125;</span>
&#160;
	<span class="co1"># Be sure that service is set to start at boot and running</span>
	service <span class="br0">&#123;</span>
		<span class="st0">'mcollective'</span>&#160;:
			enable <span class="sy0">=&gt;</span> <span class="kw2">true</span>,
			<span class="kw1">ensure</span> <span class="sy0">=&gt;</span> running
	<span class="br0">&#125;</span>
&#160;
	<span class="co1"># Set configuration file</span>
	file <span class="br0">&#123;</span>
		<span class="st0">'/etc/mcollective/server.cfg'</span>&#160;:
			<span class="kw1">ensure</span> <span class="sy0">=&gt;</span> present,
			source <span class="sy0">=&gt;</span> <span class="st0">&quot;puppet:///modules/mcollective/${::osfamily}.server.cfg&quot;</span>,
			mode <span class="sy0">=&gt;</span> <span class="nu0">640</span>,
			owner <span class="sy0">=&gt;</span> root,
			group <span class="sy0">=&gt;</span> root,
			notify <span class="sy0">=&gt;</span> Service<span class="br0">&#91;</span><span class="st0">'mcollective'</span><span class="br0">&#93;</span>
	<span class="br0">&#125;</span>
&#160;
	<span class="co1"># Include common</span>
	<span class="kw1">include</span> mcollective::common
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="files_11"><span class="mw-headline-number">7.22.4</span> files</span></h3>
<h4><span class="mw-headline" id="RedHat.server.cfg"><span class="mw-headline-number">7.22.4.1</span> RedHat.server.cfg</span></h4>
<p>Voici la configuration pour Mcollective&#160;:
</p><p><br />
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/mcollective/server.cfg</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">########################
# GLOCAL CONFIGURATION #
########################
&#160;
topicprefix = /topic/
main_collective = mcollective
collectives = mcollective
libdir = /usr/share/mcollective/plugins
logfile = /var/log/mcollective.log
loglevel = info
daemonize = 1
classesfile = /var/lib/puppet/classes.txt
&#160;
###########
# MODULES #
###########
&#160;
# Security
securityprovider = psk
plugin.psk = unset
&#160;
# Stomp
connector = stomp
plugin.stomp.host = mcollective.deimos.fr
plugin.stomp.port = 61613
plugin.stomp.user = mcollective
plugin.stomp.password = marionette
&#160;
# AgentPuppetd
plugin.puppetd.puppetd = /usr/sbin/puppetd
plugin.puppetd.lockfile = /var/lib/puppet/state/puppetdlock
plugin.puppetd.statefile = /var/lib/puppet/state/state.yaml
plugin.puppet.pidfile = /var/run/puppet/agent.pid
plugin.puppetd.splaytime = 100
plugin.puppet.summary = /var/lib/puppet/state/last_run_summary.yaml
&#160;
#########
# FACTS #
#########
&#160;
factsource = facter
plugin.yaml = /etc/mcollective/facts.yaml
plugin.facter.facterlib = /var/lib/puppet/lib/facter
fact_cache_time = 300</pre></div></div>
</td></tr></table><br />
<h2><span class="mw-headline" id="Bind"><span class="mw-headline-number">7.23</span> Bind</span></h2>
<p>Il peut être parfois utile d'avoir un serveur DNS de cache en locale pour accélérer certains traitement et ne pas être dépendant d'un DNS tierce s'il tombe pendant quelques instants. <a href="Serveurs.html#Bind" title="Serveurs">Pour plus d'infos sur Bind, suivez ce lien</a>. Créons l'arborescence&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> mkdir</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">mkdir -p /etc/puppet/modules/bind/{manifests,files,templates}</pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="init.pp_22"><span class="mw-headline-number">7.23.1</span> init.pp</span></h3>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/bind/manifests/init.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="sy0">/*</span> 
Bind <span class="kw1">Module</span> <span class="kw1">for</span> Puppet
Made by Pierre Mavro
<span class="sy0">*/</span>
<span class="kw1">class</span> bind <span class="br0">&#123;</span>
<span class="co1"># Check OS and request the appropriate function</span>
	<span class="kw1">case</span> $::operatingsystem <span class="br0">&#123;</span>
		<span class="st0">'RedHat'</span>&#160;: <span class="br0">&#123;</span>
			<span class="kw1">include</span>&#160;::bind::redhat
		<span class="br0">&#125;</span>
		<span class="co1">#'sunos':  { include packages_defaults::solaris }</span>
		default&#160;: <span class="br0">&#123;</span>
			notice<span class="br0">&#40;</span><span class="st0">&quot;Module ${module_name} is not supported on ${::operatingsystem}&quot;</span><span class="br0">&#41;</span>
		<span class="br0">&#125;</span>
	<span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="redhat.pp_17"><span class="mw-headline-number">7.23.2</span> redhat.pp</span></h3>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/bind/manifests/redhat.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="sy0">/*</span> 
Bind <span class="kw1">Module</span> <span class="kw1">for</span> Puppet
Made by Pierre Mavro
<span class="sy0">*/</span>
<span class="kw1">class</span> bind::redhat
<span class="br0">&#123;</span>
	<span class="co1"># Install bind package</span>
	package <span class="br0">&#123;</span>
		<span class="st0">'bind'</span>&#160;:
			<span class="kw1">ensure</span> <span class="sy0">=&gt;</span> present
	<span class="br0">&#125;</span>
&#160;
	<span class="co1"># resolv.conf file</span>
	file <span class="br0">&#123;</span>
		<span class="st0">&quot;/etc/resolv.conf&quot;</span>&#160;:
			source <span class="sy0">=&gt;</span> <span class="st0">&quot;puppet:///modules/bind/resolvconf&quot;</span>,
			mode <span class="sy0">=&gt;</span> <span class="nu0">744</span>,
			owner <span class="sy0">=&gt;</span> root,
			group <span class="sy0">=&gt;</span> root,
			<span class="kw3">require</span> <span class="sy0">=&gt;</span> <span class="kw4">File</span><span class="br0">&#91;</span><span class="st0">'/etc/named.conf'</span><span class="br0">&#93;</span>
	<span class="br0">&#125;</span>
&#160;
	<span class="co1"># Bind main config file for cache server</span>
	file <span class="br0">&#123;</span>
		<span class="st0">&quot;/etc/named.conf&quot;</span>&#160;:
			content <span class="sy0">=&gt;</span> template<span class="br0">&#40;</span><span class="st0">&quot;bind/named.conf.$::operatingsystem&quot;</span><span class="br0">&#41;</span>,
			mode <span class="sy0">=&gt;</span> <span class="nu0">640</span>,
			owner <span class="sy0">=&gt;</span> root,
			group <span class="sy0">=&gt;</span> named,
			notify <span class="sy0">=&gt;</span> Service<span class="br0">&#91;</span><span class="st0">&quot;named&quot;</span><span class="br0">&#93;</span>
	<span class="br0">&#125;</span>
&#160;
	<span class="co1"># Service should start on boot and be running </span>
	service <span class="br0">&#123;</span>
		<span class="st0">'named'</span>&#160;:
			enable <span class="sy0">=&gt;</span> <span class="kw2">true</span>,
			<span class="kw1">ensure</span> <span class="sy0">=&gt;</span> running,
			<span class="kw3">require</span> <span class="sy0">=&gt;</span> <span class="br0">&#91;</span> Package<span class="br0">&#91;</span><span class="st0">'bind'</span><span class="br0">&#93;</span>, <span class="kw4">File</span><span class="br0">&#91;</span><span class="st0">'/etc/named.conf'</span>, <span class="st0">'/etc/resolv.conf'</span><span class="br0">&#93;</span> <span class="br0">&#93;</span>
	<span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="files_12"><span class="mw-headline-number">7.23.3</span> files</span></h3>
<p>Nous allons gérer le resolv.conf ici&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/modules/bind/files/resolvconf</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1"># Generated by Puppet
domain deimos.fr
search deimos.fr deimos.lan
nameserver 127.0.0.1</pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="templates_8"><span class="mw-headline-number">7.23.4</span> templates</span></h3>
<p>Et pour finir, la configuration du template qui agira avec les informations renseignées dans <a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#vars.pp">vars.pp</a>&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> </font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">// Generated by Puppet
//
// named.conf
//
// Provided by Red Hat bind package to configure the ISC BIND named(8) DNS
// server as a caching only nameserver (as a localhost DNS resolver only).
//
// See /usr/share/doc/bind*/sample/ for example named configuration files.
//
&#160;
options {
        listen-on port 53 { 127.0.0.1; };
        listen-on-v6 port 53 {&#160;::1; };
        directory       &quot;/var/named&quot;;
        dump-file       &quot;/var/named/data/cache_dump.db&quot;;
        statistics-file &quot;/var/named/data/named_stats.txt&quot;;
        memstatistics-file &quot;/var/named/data/named_mem_stats.txt&quot;;
        allow-query     { localhost; };
        recursion yes;
&#160;
        dnssec-enable no;
        dnssec-validation no;
        dnssec-lookaside auto;
&#160;
        forwarders {
<span class="xtra ln-xtra">            &lt;% dns_servers.each do |dnsval| -%&gt;</span><span class="xtra ln-xtra">            &lt;%= dnsval&#160;%&gt;;</span><span class="xtra ln-xtra">            &lt;% end -%&gt;</span>        };
&#160;
        /* Path to ISC DLV key */
        bindkeys-file &quot;/etc/named.iscdlv.key&quot;;
&#160;
        managed-keys-directory &quot;/var/named/dynamic&quot;;
};
&#160;
logging {
        channel default_debug {
                file &quot;data/named.run&quot;;
                severity dynamic;
        };
};
&#160;
zone &quot;.&quot; IN {
        type hint;
        file &quot;named.ca&quot;;
};
&#160;
include &quot;/etc/named.rfc1912.zones&quot;;
include &quot;/etc/named.root.key&quot;;</pre></div></div>
</td></tr></table><br />
<h2><span class="mw-headline" id="Importation_d.27un_module"><span class="mw-headline-number">7.24</span> Importation d'un module</span></h2>
<p>Les modules doivent être importés dans puppet pour qu'ils soient prit en charge. Ici, nous n'avons pas à nous en soucier puisque d'après la configuration serveur que nous en avons faite, il va automatiquement charger les modules dans /etc/puppet/modules. Cependant si vous souhaitez autoriser module par module, il vous faut les importer à la main&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/manifests/modules.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="co1"># /etc/puppet/manifests/modules.pp</span>
&#160;
import <span class="st0">&quot;sudo&quot;</span>
import <span class="st0">&quot;ssh&quot;</span></pre></div></div>
</td></tr></table><br />
<table width="100%" class="warning_array">
<tr>
<td class="warning_subarray"> <font size="-1"><a href="./File:Warning_file.png.html" class="image" title="Warning"><img alt="Warning" src="images/0/09/Warning_file.png" width="39" height="32" /></a> <b>WARNING</b></font>
</td></tr>
<tr>
<td>
<p>Faites attention car a partir du moment ou ceci est renseigné, nul besoin de redémarrer puppet pour que les changements soient pris en compte. Il va donc falloir faire attention à ce que vous rendez disponible à l'instant t.
</p>
</td></tr></table><br />
<h3><span class="mw-headline" id="Importer_tous_les_modules_d.27un_coup"><span class="mw-headline-number">7.24.1</span> Importer tous les modules d'un coup</span></h3>
<p>Ceci peut avoir de graves conséquences, mais sachez qu'il est possible de le faire&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/manifests/modules.pp</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="co1"># /etc/puppet/manifests/modules.pp</span>
&#160;
import <span class="st0">&quot;*.pp&quot;</span></pre></div></div>
</td></tr></table><br />
<h1><span class="mw-headline" id="Utilisation"><span class="mw-headline-number">8</span> Utilisation</span></h1>
<h2><span class="mw-headline" id="Certificats"><span class="mw-headline-number">8.1</span> Certificats</span></h2>
<p>Puppet travaille avec des certificats pour les échanges clients/serveurs. Il va donc falloir générer des clefs SSL sur le serveur et faire un échange ensuite avec tous les clients. L'utilisation des clefs SSL nécessite donc une bonne configuration de votre serveur DNS. Vérifiez donc bine à ce que&#160;:
</p>
<ul><li> Le nom du serveur soit définitif</li>
<li> Le nom du serveur soit accessible via puppet.mydomain.com (je continuerais la configuration pour moi avec puppet-prd.deimos.fr)</li></ul>
<h3><span class="mw-headline" id="Cr.C3.A9ation_d.27un_certificat"><span class="mw-headline-number">8.1.1</span> Création d'un certificat</span></h3>
<ul><li> Nous allons donc créer notre certificat (<b>normalement déjà fait lorsque l'installation est faite sur Debian</b>)&#160;:</li></ul>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> puppet</font>
</td></tr>
<tr>
<td>
<pre>puppet cert generate puppet-prd.deimos.fr
</pre>
</td></tr></table><br />
<table width="100%" class="warning_array">
<tr>
<td class="warning_subarray"> <font size="-1"><a href="./File:Warning_file.png.html" class="image" title="Warning"><img alt="Warning" src="images/0/09/Warning_file.png" width="39" height="32" /></a> <b>WARNING</b></font>
</td></tr>
<tr>
<td>
<p>Il est impératifs que <b>TOUS les noms renseignés dans le certificat soient joignables'</b> sous peine que les clients ne puissent se synchroniser avec le serveur
</p>
</td></tr></table><br />
<ul><li> Dans le cas ou vous souhaitez valider un certificat avec plusieurs noms de domaine, il va falloir procéder comme ceci&#160;:</li></ul>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> puppet</font>
</td></tr>
<tr>
<td>
<pre>puppet cert cert generate --dns_alt_names puppet:scar.deimos.fr puppet-prd.deimos.fr
</pre>
</td></tr></table><br />
<p>Insérez les noms dont vous avez besoin les uns à la suite des autres. Je vous rappel que par défaut, les clients vont chercher <b>puppet.</b>mydomain.com, donc n'hésitez pas à rajouter des noms si besoin.<br />
Vous pouvez ensuite vérifier que le certificat contient bien les 2 noms&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> openssl</font>
</td></tr>
<tr>
<td>
<pre>&gt; openssl x509 -text -in /var/lib/puppet/ssl/certs/puppet-prd.deimos.fr.pem | grep DNS
<b>DNS:puppet, DNS:scar.deimos.fr, DNS:puppet-prd.deimos.fr</b>
</pre>
</td></tr></table><br />
<p>Vous pouvez voir d'éventuelles erreurs de certificats en vous connectant&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> openssl</font>
</td></tr>
<tr>
<td>
<pre>openssl s_client -host puppet -port 8140 -cert /path/to/ssl/certs/node.domain.com.pem -key /path/to/ssl/private_keys/node.domain.com.pem -CAfile /path/to/ssl/certs/ca.pem
</pre>
</td></tr></table><br />
<p><i>Note: N'oubliez pas de redémarrer votre serveur web si vous faites le changement de certificats</i>
</p>
<h3><span class="mw-headline" id="Ajout_d.27un_client_puppet_au_serveur"><span class="mw-headline-number">8.1.2</span> Ajout d'un client puppet au serveur</span></h3>
<p>Pour le certificat, c'est simple, nous allons faire une demande de certificats&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> puppet</font>
</td></tr>
<tr>
<td>
<pre>$ puppet agent --server puppet-prd.deimos.fr --waitforcert 60 --test
notice: Ignoring cache
info: Caching catalog at /var/lib/puppet/state/localconfig.yaml
notice: Starting catalog run
notice: //information_class/Exec[echo running on debian-puppet-prd.deimos.fr is a Debian with ip 192.168.0.106. Message is ‘puppet c'est super’]/returns: executed successfully
notice: Finished catalog run in 0.45 seconds
</pre>
</td></tr></table><br />
<p>Maintenant nous allons nous connecter <b>sur le serveur</b> et lancer cette commande&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> puppet</font>
</td></tr>
<tr>
<td>
<pre>$ puppet cert -l
debian-puppet-prd.deimos.fr
</pre>
</td></tr></table><br />
<p>Je vois ici par exemple que j'ai un host qui veut faire un échange de clefs afin ensuite d'obtenir les configurations qui lui sont dues. Seulement il va falloir l'autoriser. Pour ce faire&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> puppet</font>
</td></tr>
<tr>
<td>
<pre>puppet cert -s debian-puppet-prd.deimos.fr
</pre>
</td></tr></table><br />
<p>La machine est donc maintenant acceptée et peut aller chercher des confs sur le serveur Puppet.
</p><p>Si on veut refuser un noeud qui est en attente&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> puppet</font>
</td></tr>
<tr>
<td>
<pre>puppet cert -c debian-puppet-prd.deimos.fr
</pre>
</td></tr></table><br />
<p>Si on veut voir la liste de tous les noeuds autorisés, puppetmaster les tient enregistrés ici&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /var/lib/puppet/ssl/ca/inventory.txt</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">0x0001 2010-03-08T15:45:48GMT 2015-03-07T15:45:48GMT /CN=puppet-prd.deimos.fr
0x0002 2010-03-08T16:36:16GMT 2015-03-07T16:36:16GMT /CN=node1.deimos.fr
0x0003 2010-03-08T16:36:25GMT 2015-03-07T16:36:25GMT /CN=node2.deimos.fr
0x0004 2010-04-14T12:41:24GMT 2015-04-13T12:41:24GMT /CN=node3.deimos.fr</pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="Synchroniser_un_client"><span class="mw-headline-number">8.1.3</span> Synchroniser un client</span></h3>
<p>Maintenant que nos machines sont connectées, nous allons vouloir les synchroniser de temps à autre. Voici donc comment faire une synchronisation manuelle depuis une machine cliente&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> puppet</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">puppet agent -t</pre></div></div>
</td></tr></table><br />
<p>Si vous souhaitez synchroniser uniquement un module, vous pouvez utiliser l'option --tags&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> puppet</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">puppet agent -t --tags module1 module2...</pre></div></div>
</td></tr></table><br />
<h4><span class="mw-headline" id="Simuler"><span class="mw-headline-number">8.1.3.1</span> Simuler</span></h4>
<p>Si vous avez besoin de tester avant de déployer réellement, il existe l'option --noop&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> puppet</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">puppet agent -t --noop</pre></div></div>
</td></tr></table><br />
<p>Vous pouvez également ajouter dans un manifest la directive 'audit' si vous souhaitez simplement auditer une ressource&#160;:
</p>
<div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1">file <span class="br0">&#123;</span> <span class="st0">&quot;/etc/passwd&quot;</span>:
    audit <span class="sy0">=&gt;</span> <span class="br0">&#91;</span> owner, mode <span class="br0">&#93;</span>,
<span class="br0">&#125;</span></pre></div></div>
<p>Ici on demande donc d'auditer l'utilisateur et les droits, mais sachez qu'il est possible de remplacer par 'all' pour tout auditer&#160;!
</p>
<h3><span class="mw-headline" id="R.C3.A9voquer_un_certificat"><span class="mw-headline-number">8.1.4</span> Révoquer un certificat</span></h3>
<ul><li> Si vous souhaitez révoquer un certificat, voici comment procéder sur le serveur&#160;:</li></ul>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> puppet</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">puppet cert clean ma_machine</pre></div></div>
</td></tr></table><br />
<ul><li> Sinon il existe cette méthode&#160;:</li></ul>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> puppet cert</font>
</td></tr>
<tr>
<td>
<pre>puppet cert -r ma_machine
puppet cert -c ma_machine
</pre>
</td></tr></table><br />
<p>Simple non&#160;?&#160;:-)
</p><p>Si vous souhaiter réassigner de nouveau, supprimez côté client le dossier ssl dans '/etc/puppet/' ou '/var/lib/puppet/'. Ensuite vous pouvez <a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Certificats" title="Puppet : Solution de gestion de fichier de configuration">relancer une demande de certificat</a>.
</p>
<h3><span class="mw-headline" id="R.C3.A9voquer_tous_les_certificats_du_serveur"><span class="mw-headline-number">8.1.5</span> Révoquer tous les certificats du serveur</span></h3>
<p>Si vous avez votre puppet master qui est cassé de partout et voulez régénérer de nouvelles clefs et supprimer toutes les anciennes&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> </font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">puppet cert clean --all
rm -Rf /var/lib/puppet/ssl/certs/*
/etc/init.d/puppetmaster restart</pre></div></div>
</td></tr></table><br />
<h2><span class="mw-headline" id="Surveillance_des_processus"><span class="mw-headline-number">8.2</span> Surveillance des processus</span></h2>
<p>Sur les clients, il n'est pas nécessaire d'utiliser un logiciel de surveillance, puisque les daemons puppetd ne sont lancés qu'à la main ou par tâche CRON. Sur le serveur, il est important que le  processus puppetmaster soit toujours présent. On pourra utiliser le logiciel 'monit', qui pourra redémarrer automatiquement le processus en cas de problème.
</p>
<h3><span class="mw-headline" id="D.C3.A9termination_de_l.27.C3.A9tat_des_noeuds"><span class="mw-headline-number">8.2.1</span> Détermination de l'état des noeuds</span></h3>
<p>Pour voir s'il y a des problèmes sur un noeud, on pourra lancer manuellement la commande suivante&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> puppetd</font>
</td></tr>
<tr>
<td>
<pre>puppetd --no-daemon --verbose --onetime
</pre>
</td></tr></table><br />
<p>Si l'on souhaite connaître le dernier état/résultat d'une mise à jour puppet, on pourra utiliser le système de 'report' une fois activé (sur les clients)&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/puppet.conf</font>
</td></tr>
<tr>
<td>
<pre>...
report = true
...
</pre>
</td></tr></table><br />
<p>En activant le reporting, à chaque exécution du daemon puppetd, un compte rendu sera envoyé sur le puppetmaster dans un fichier au format YAML, dans le répertoire /var/lib/puppet/reports/NOM_MACHINE. 
</p><p>Voici un exemple de fichier de report, facilement transformable en dictionnaire avec le module yaml de python (ou ruby)&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /var/lib/puppet/reports/deb-puppet-client.deimos.fr</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="sy0">---</span>&#160;!ruby<span class="sy0">/</span>object:<span class="re2">Puppet::Transaction::Report</span> 
host: deb<span class="sy0">-</span>puppet<span class="sy0">-</span>client.<span class="me1">deimos</span>.<span class="me1">fr</span>
logs: 
<span class="sy0">-</span>&#160;!ruby<span class="sy0">/</span>object:<span class="re2">Puppet::Util::Log</span> 
  level: <span class="re3">:info</span>
  message: Applying configuration version <span class="st0">'1275982371'</span>
  source: Puppet
  tags: 
  <span class="sy0">-</span> info
  time: <span class="nu0">2010</span><span class="sy0">-</span>06<span class="sy0">-</span>08 <span class="nu0">11</span>:<span class="nu0">37</span>:<span class="nu0">59.521132</span> <span class="sy0">+</span>02:00
<span class="sy0">-</span>&#160;!ruby<span class="sy0">/</span>object:<span class="re2">Puppet::Util::Log</span> 
  file: <span class="sy0">/</span>etc<span class="sy0">/</span>puppet<span class="sy0">/</span>modules<span class="sy0">/</span>sudo<span class="sy0">/</span>manifests<span class="sy0">/</span>init.<span class="me1">pp</span>
  level: <span class="re3">:err</span>
  line: <span class="nu0">11</span>
  message: <span class="st0">&quot;Failed to retrieve current state of resource: Could not retrieve information from source(s) puppet:///sudo/sudoers at /etc/puppet/modules/sudo/manifests/init.pp:11&quot;</span>
  source: <span class="sy0">//</span>sudo<span class="sy0">/</span><span class="kw4">File</span><span class="br0">&#91;</span><span class="sy0">/</span>etc<span class="sy0">/</span>sudoers<span class="br0">&#93;</span></pre></div></div>
</td></tr></table><br />
<p>Une méthode plus jolie par interface graphique existe également, il s'agit du <a href="./Puppet_Dashboard_:_Mise_en_place_d'une_interface_graphique_pour_Puppet.html" title="Puppet Dashboard : Mise en place d'une interface graphique pour Puppet">Puppet Dashboard</a>.
</p>
<h1><span class="mw-headline" id="Utilisation_avanc.C3.A9e"><span class="mw-headline-number">9</span> Utilisation avancée</span></h1>
<h2><span class="mw-headline" id="Monitorer_Passenger"><span class="mw-headline-number">9.1</span> Monitorer Passenger</span></h2>
<p>Il existe des binaires permettant d'obtenir des informations sur votre Passenger et pouvoir le tuner si besoin&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> passenger-status</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">----------- General information -----------
max      = 12
count    = 0
active   = 0
inactive = 0
Waiting on global queue: 0
&#160;
----------- Application groups -----------</pre></div></div>
</td></tr></table><br />
<p>Et voici une autre information&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> passenger-memory-stats</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">--------- Apache processes ---------
PID   PPID  VMSize    Private  Name
------------------------------------
1841  1     91.9 MB   0.6 MB   /usr/sbin/apache2 -k start
1846  1841  91.1 MB   0.6 MB   /usr/sbin/apache2 -k start
1903  1841  308.0 MB  0.5 MB   /usr/sbin/apache2 -k start
1904  1841  308.0 MB  0.5 MB   /usr/sbin/apache2 -k start
### Processes: 4
### Total private dirty RSS: 2.14 MB
&#160;
&#160;
-------- Nginx processes --------
&#160;
### Processes: 0
### Total private dirty RSS: 0.00 MB
&#160;
&#160;
---- Passenger processes ----
PID   VMSize   Private  Name
-----------------------------
1847  22.9 MB  0.3 MB   PassengerWatchdog
1852  31.6 MB  0.3 MB   PassengerHelperAgent
1857  43.1 MB  5.8 MB   Passenger spawn server
1860  79.9 MB  0.9 MB   PassengerLoggingAgent
### Processes: 4
### Total private dirty RSS: 7.26 MB</pre></div></div>
</td></tr></table><br />
<h2><span class="mw-headline" id="V.C3.A9rifier_la_syntaxe_de_ses_.pp"><span class="mw-headline-number">9.2</span> Vérifier la syntaxe de ses .pp</span></h2>
<p>Lorsque vous créez/éditez un module puppet, il peut être vite très pratique de vérifier la syntaxe. Voici comment faire&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> puppet</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">puppet parser validate init.pp</pre></div></div>
</td></tr></table><br />
<p>Et si vous souhaitez le faire à plus grande échelle&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> find</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">find /etc/puppet/ -name '*.pp' | xargs -n 1 -t puppet parser validate</pre></div></div>
</td></tr></table><br />
<h2><span class="mw-headline" id="Outrepasser_des_restrictions"><span class="mw-headline-number">9.3</span> Outrepasser des restrictions</span></h2>
<p>Si par exemple, nous avons définit une classe et que pour certains hôtes, nous souhaitons modifier cette configuration, nous devons faire comme ceci&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> </font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1"><span class="kw1">class</span> somehost_postfix inherits postfix <span class="br0">&#123;</span>
    <span class="co1"># blah blah blah</span>
<span class="br0">&#125;</span>
&#160;
node somehost <span class="br0">&#123;</span>
    <span class="kw1">include</span> somehost_postfix
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<p>Admettons que nous avons un module postfix de définit. Nous souhaitons appliquer une config particulière à certains hosts définit ici par 'somehost'. Pour bypasser la configuration, il faut créer une classe somehost_postfix'. J'insiste ici sur la nomenclature du nom à donner pour cette classe puisque c'est uniquement comme celà que Puppet reconnaitra que vous souhaitez appliquer une configuration particulière.
</p>
<h2><span class="mw-headline" id="D.C3.A9sactiver_une_ressource"><span class="mw-headline-number">9.4</span> Désactiver une ressource</span></h2>
<p>Pour désactiver temporairement une ressource, il suffit de mettre noop à true&#160;:
</p>
<div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="ruby source-ruby"><pre class="de1">file <span class="br0">&#123;</span> <span class="st0">&quot;/etc/passwd&quot;</span>:
<span class="xtra ln-xtra">    noop <span class="sy0">=&gt;</span> <span class="kw2">true</span></span><span class="br0">&#125;</span></pre></div></div>
<h2><span class="mw-headline" id="Pre_et_Post_puppet_run"><span class="mw-headline-number">9.5</span> Pre et Post puppet run</span></h2>
<p>Il est possible de lancer des scripts avant et après l'exécution d'un Puppet run. Cela peut s'avérer utile dans le cas d'une sauvegarde de certains fichiers via etckeeper par exemple. Ajoutez ceci dans le fichier puppet.conf de vos clients&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/puppet/puppet.conf</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">[...]
prerun_command = /usr/local/bin/before-puppet-run.sh
postrun_command = /usr/local/bin/after-puppet-run.sh</pre></div></div>
</td></tr></table><br />
<h2><span class="mw-headline" id="CFT"><span class="mw-headline-number">9.6</span> CFT</span></h2>
<p><a rel="nofollow" class="external text" href="http://cft.et.redhat.com/">CFT</a> (prononcez shift) est un petit logiciel qui va regarder ce que vous faites pendant une période donnée pour vous générer un manifest. Par exemple, vous le lancez juste avant de faire ne installation avec sa configuration et il va vous générer le manifest une fois terminé. Un exemple vaut mieux qu'un long discourt&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> cft</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">cft begin apache
[...]
cft finish apache
cft manifest apache</pre></div></div>
</td></tr></table><br />
<h2><span class="mw-headline" id="G.C3.A9n.C3.A9rer_un_manifest_depuis_un_syst.C3.A8me_existant"><span class="mw-headline-number">9.7</span> Générer un manifest depuis un système existant</span></h2>
<p>Voici une solution simple de générer depuis un système déjà installé un manifest en lui spécifiant une ressource. Voici quelques exemples&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> puppet</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">puppet resource user root
puppet resource service httpd
puppet resource package postfix</pre></div></div>
</td></tr></table><br />
<h2><span class="mw-headline" id="Puppet_Push"><span class="mw-headline-number">9.8</span> Puppet Push</span></h2>
<p>Puppet fonctionne en mode client -&gt; serveur. C'est le client qui contacte toutes les 30 min (par défaut) le serveur et demande une synchronisation. Lorsque vous êtes en mode boulet ou bien quand vous souhaitez déclencher à un instant t la mise à jour de vos machine clientes vers le serveur, il y a un mode particulier (listen). Le problème c'est que le client puppet ne peut pas tourner en mode client et listen. Il faut donc 2 instances...bref les cauchemars commencent.
</p><p>Pour palier à ce problème, j'ai donc développé Puppet push qui permet de demander aux client (via SSH) de se synchroniser. Vous l'aurez compris, il est plus que nécessaire d'avoir un échange de clef effectué au préalable avec les clients. Comment faire&#160;? Pas de soucis, nous avons vu celà plus haut.
</p><p>Pour accéder à la dernière version, suivez ce lien&#160;: <a rel="nofollow" class="external free" href="http://www.deimos.fr/gitweb/?p=puppet_push.git;a=tree">http://www.deimos.fr/gitweb/?p=puppet_push.git;a=tree</a>
</p>
<h2><span class="mw-headline" id="MCollective_2"><span class="mw-headline-number">9.9</span> MCollective</span></h2>
<p>MCollective c'est un peu l'usine à gaz, mais c'est très puissant et fonctionne très bien avec Puppet. Il vous permet comme Puppet Push de faire plusieurs actions sur des noeuds, mais utilise un protocole dédié, il n'a pas besoin d'SSH pour communiquer avec les noeuds. Pour en savoir plus, <a href="./MCollective_:_lancez_des_actions_en_parallèle_sur_des_machines_distante.html" title="MCollective : lancez des actions en parallèle sur des machines distante">regardez cet article</a>.
</p>
<h1><span class="mw-headline" id="FAQ"><span class="mw-headline-number">10</span> FAQ</span></h1>
<h2><span class="mw-headline" id="err:_Could_not_retrieve_catalog_from_remote_server:_hostname_was_not_match_with_the_server_certificate"><span class="mw-headline-number">10.1</span> err: Could not retrieve catalog from remote server: hostname was not match with the server certificate</span></h2>
<p>Vous avez un problème avec vos certificats. Le mieux c'est de regénérer un certificats avec tous les hostname du serveur dans ce certificat&#160;: <a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#Cr.C3.A9ation_d.27un_certificat" title="Puppet : Solution de gestion de fichier de configuration">Création d'un certificat</a>
</p>
<h1><span class="mw-headline" id="Ressources"><span class="mw-headline-number">11</span> Ressources</span></h1>
<p><a rel="nofollow" class="external free" href="http://reductivelabs.com/products/puppet/">http://reductivelabs.com/products/puppet/</a><br />
<a rel="nofollow" class="external free" href="http://www.rottenbytes.info">http://www.rottenbytes.info</a><br />
<a rel="nofollow" class="external text" href="http://git.black.co.at/">Modules pour Puppet</a><br />
<a rel="nofollow" class="external text" href="http://reductivelabs.com/trac/puppet/wiki/Recipes">Puppet recipes</a><br />
<a rel="nofollow" class="external text" href="http://reductivelabs.com/trac/puppet/wiki/TypeReference">Types d'objets pour Puppet</a><br />
<a rel="nofollow" class="external text" href="http://www.masterzen.fr/2010/11/14/puppet-ssl-explained/">Puppet SSL Explained</a> <a href="images/4/42/Puppet_SSL_explained.pdf" class="internal" title="Puppet SSL explained.pdf">(PDF)</a><br />
<a rel="nofollow" class="external free" href="http://puppetcookbook.com/">http://puppetcookbook.com/</a>
</p>
<!-- 
NewPP limit report
CPU time usage: 0.824 seconds
Real time usage: 0.827 seconds
Preprocessor visited node count: 4138/1000000
Preprocessor generated node count: 10930/1000000
Post‐expand include size: 58831/2097152 bytes
Template argument size: 22778/2097152 bytes
Highest expansion depth: 4/40
Expensive parser function count: 0/100
-->

<!-- 
Transclusion expansion time report (%,ms,calls,template)
100.00%  463.599      1 - -total
 64.81%  300.455    117 - Template:Config
 15.55%   72.068     69 - Template:Command
  0.97%    4.506      2 - Template:Puppet_OpenLDAP_dns2ip
  0.69%    3.200      2 - Template:Puppet_debian_repo
  0.48%    2.231      1 - Template:Mcollective_server.cfg
  0.47%    2.179      1 - Template:Infobox
  0.38%    1.751      2 - Template:Puppet_OpenSSH2_Config
  0.37%    1.719      2 - Template:Puppet_srv_puppet.conf
  0.27%    1.266      4 - Template:Warning
-->

<!-- Saved in parser cache with key blocnotesinfo-wiki_:pcache:idhash:2955-0!*!0!1!en!5!* and timestamp 20181111230706 and revision id 12758
 -->
</div>									<div class="printfooter">
						Retrieved from "<a dir="ltr" href="https://wiki.deimos.fr/index.php?title=Puppet_:_Solution_de_gestion_de_fichier_de_configuration&amp;oldid=12758">https://wiki.deimos.fr/index.php?title=Puppet_:_Solution_de_gestion_de_fichier_de_configuration&amp;oldid=12758</a>"					</div>
													<div id='catlinks' class='catlinks catlinks-allhidden'></div>												<div class="visualClear"></div>
							</div>
		</div>
		<div id="mw-navigation">
			<h2>Navigation menu</h2>

			<div id="mw-head">
									<div id="p-personal" role="navigation" class="" aria-labelledby="p-personal-label">
						<h3 id="p-personal-label">Personal tools</h3>
						<ul>
							<li id="pt-login"><a href="https://wiki.deimos.fr/index.php?title=Special:UserLogin&amp;returnto=Puppet+%3A+Solution+de+gestion+de+fichier+de+configuration" title="You are encouraged to log in; however, it is not mandatory [o]" accesskey="o">Log in</a></li>						</ul>
					</div>
									<div id="left-navigation">
										<div id="p-namespaces" role="navigation" class="vectorTabs" aria-labelledby="p-namespaces-label">
						<h3 id="p-namespaces-label">Namespaces</h3>
						<ul>
															<li  id="ca-nstab-main" class="selected"><span><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html"  title="View the content page [c]" accesskey="c">Page</a></span></li>
													</ul>
					</div>
										<div id="p-variants" role="navigation" class="vectorMenu emptyPortlet" aria-labelledby="p-variants-label">
												<h3 id="p-variants-label"><span>Variants</span><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#"></a></h3>

						<div class="menu">
							<ul>
															</ul>
						</div>
					</div>
									</div>
				<div id="right-navigation">
										<div id="p-views" role="navigation" class="vectorTabs" aria-labelledby="p-views-label">
						<h3 id="p-views-label">Views</h3>
						<ul>
															<li id="ca-view" class="selected"><span><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html" >Read</a></span></li>
															<li id="ca-viewsource"><span><a href="https://wiki.deimos.fr/index.php?title=Puppet_:_Solution_de_gestion_de_fichier_de_configuration&amp;action=edit"  title="This page is protected.&#10;You can view its source [e]" accesskey="e">View source</a></span></li>
															<li id="ca-history" class="collapsible"><span><a href="https://wiki.deimos.fr/index.php?title=Puppet_:_Solution_de_gestion_de_fichier_de_configuration&amp;action=history"  title="Past revisions of this page [h]" accesskey="h">View history</a></span></li>
													</ul>
					</div>
										<div id="p-cactions" role="navigation" class="vectorMenu emptyPortlet" aria-labelledby="p-cactions-label">
						<h3 id="p-cactions-label"><span>More</span><a href="./Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html#"></a></h3>

						<div class="menu">
							<ul>
															</ul>
						</div>
					</div>
										<div id="p-search" role="search">
						<h3>
							<label for="searchInput">Search</label>
						</h3>

						<form action="https://wiki.deimos.fr/index.php" id="searchform">
														<div id="simpleSearch">
															<input type="search" name="search" placeholder="Search" title="Search Deimos.fr / Bloc Notes Informatique [f]" accesskey="f" id="searchInput" /><input type="hidden" value="Special:Search" name="title" /><input type="submit" name="fulltext" value="Search" title="Search the pages for this text" id="mw-searchButton" class="searchButton mw-fallbackSearchButton" /><input type="submit" name="go" value="Go" title="Go to a page with this exact name if exists" id="searchButton" class="searchButton" />								</div>
						</form>
					</div>
									</div>
			</div>
			<div id="mw-panel">
				<div id="p-logo" role="banner"><a style="background-image: url(images/a/a7/Logo_deimosfr.png);" href="index.html"  title="Visit the main page"></a></div>
						<div class="portal" role="navigation" id='p-navigation_et_RSS' aria-labelledby='p-navigation_et_RSS-label'>
			<h3 id='p-navigation_et_RSS-label'>navigation et RSS</h3>

			<div class="body">
									<ul>
													<li id="n-cd-.7E"><a href="index.html">cd ~</a></li>
											</ul>
							</div>
		</div>
			<div class="portal" role="navigation" id='p-Menu' aria-labelledby='p-Menu-label'>
			<h3 id='p-Menu-label'>Menu</h3>

			<div class="body">
									<ul>
													<li id="n-Solaris"><a href="Solaris.html">Solaris</a></li>
													<li id="n-BSD"><a href="BSD.html">BSD</a></li>
													<li id="n-Linux"><a href="Linux.html">Linux</a></li>
													<li id="n-Mac-OS-X"><a href="Mac_OS_X.html">Mac OS X</a></li>
													<li id="n-Windows"><a href="Windows.html">Windows</a></li>
													<li id="n-Servers"><a href="Serveurs.html">Servers</a></li>
													<li id="n-Development"><a href="Développement.html">Development</a></li>
													<li id="n-Ethical-Hacking"><a href="Hacking_éthique.html">Ethical Hacking</a></li>
													<li id="n-Network"><a href="Réseaux.html">Network</a></li>
													<li id="n-Divers"><a href="Divers.html">Divers</a></li>
											</ul>
							</div>
		</div>
			<div class="portal" role="navigation" id='p-Liens' aria-labelledby='p-Liens-label'>
			<h3 id='p-Liens-label'>Liens</h3>

			<div class="body">
									<ul>
													<li id="n-Welcome-Page"><a href="http://www.deimos.fr" rel="nofollow">Welcome Page</a></li>
													<li id="n-Blog"><a href="http://blog.deimos.fr" rel="nofollow">Blog</a></li>
													<li id="n-Resume"><a href="https://www.linkedin.com/in/pmavro/" rel="nofollow">Resume</a></li>
													<li id="n-GitHub"><a href="https://github.com/deimosfr" rel="nofollow">GitHub</a></li>
											</ul>
							</div>
		</div>
			<div class="portal" role="navigation" id='p-Google_Search' aria-labelledby='p-Google_Search-label'>
			<h3 id='p-Google_Search-label'>Google Search</h3>

			<div class="body">
									
<div><form action="http://www.google.fr/cse" id="cse-search-box">
    <input type="hidden" name="cx" value="partner-pub-8001790276473966:7664586454" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="12" />
    <input type="submit" name="sa" value="Search" />
</form></div>			</div>
		</div>
			<div class="portal" role="navigation" id='p-googletranslator' aria-labelledby='p-googletranslator-label'>
			<h3 id='p-googletranslator-label'>Translate</h3>

			<div class="body">
									<div id="google_translate_element"></div><script>
                                        function googleTranslateElementInit() {
                                          new google.translate.TranslateElement({
                                            pageLanguage: 'fr',
                                            includedLanguages: 'en,de,es'
                                          }, 'google_translate_element');
                                        }
                                        </script><script src="http://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>			</div>
		</div>
			<div class="portal" role="navigation" id='p-tb' aria-labelledby='p-tb-label'>
			<h3 id='p-tb-label'>Tools</h3>

			<div class="body">
									<ul>
													<li id="t-whatlinkshere"><a href="./Special:WhatLinksHere/Puppet_:_Solution_de_gestion_de_fichier_de_configuration.html" title="A list of all wiki pages that link here [j]" accesskey="j">What links here</a></li>
													<li id="t-recentchangeslinked"><a href="https://wiki.deimos.fr/Special:RecentChangesLinked/Puppet_:_Solution_de_gestion_de_fichier_de_configuration" title="Recent changes in pages linked from this page [k]" accesskey="k">Related changes</a></li>
													<li id="t-specialpages"><a href="https://wiki.deimos.fr/Special:SpecialPages" title="A list of all special pages [q]" accesskey="q">Special pages</a></li>
													<li id="t-print"><a href="https://wiki.deimos.fr/index.php?title=Puppet_:_Solution_de_gestion_de_fichier_de_configuration&amp;printable=yes" rel="alternate" title="Printable version of this page [p]" accesskey="p">Printable version</a></li>
													<li id="t-permalink"><a href="https://wiki.deimos.fr/index.php?title=Puppet_:_Solution_de_gestion_de_fichier_de_configuration&amp;oldid=12758" title="Permanent link to this revision of the page">Permanent link</a></li>
													<li id="t-info"><a href="https://wiki.deimos.fr/index.php?title=Puppet_:_Solution_de_gestion_de_fichier_de_configuration&amp;action=info" title="More information about this page">Page information</a></li>
											</ul>
							</div>
		</div>
				</div>
		</div>
		<div id="footer" role="contentinfo">
							<ul id="footer-info">
											<li id="footer-info-lastmod"> This page was last modified on 2 August 2013, at 11:43.</li>
											<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.fr">Attribution - Pas d’Utilisation Commerciale - Partage dans les Mêmes Conditions 3.0 non transposé</a> unless otherwise noted.</li>
									</ul>
							<ul id="footer-places">
											<li id="footer-places-privacy"><a href="https://wiki.deimos.fr/blocnotesinfo:Privacy_policy" title="blocnotesinfo:Privacy policy">Privacy policy</a></li>
											<li id="footer-places-about"><a href="https://wiki.deimos.fr/blocnotesinfo:About" title="blocnotesinfo:About">About Deimos.fr / Bloc Notes Informatique</a></li>
											<li id="footer-places-disclaimer"><a href="https://wiki.deimos.fr/blocnotesinfo:General_disclaimer" title="blocnotesinfo:General disclaimer">Disclaimers</a></li>
									</ul>
										<ul id="footer-icons" class="noprint">
											<li id="footer-copyrightico">
															<a href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.fr"><img src="http://i.creativecommons.org/l/by-nc-sa/3.0/88x31.png" alt="Attribution - Pas d’Utilisation Commerciale - Partage dans les Mêmes Conditions 3.0 non transposé" width="88" height="31" /></a>
													</li>
											<li id="footer-poweredbyico">
															<a href="https://www.mediawiki.org/"><img src="resources/assets/poweredby_mediawiki_88x31.png" alt="Powered by MediaWiki" srcset="resources/assets/poweredby_mediawiki_132x47.png 1.5x, resources/assets/poweredby_mediawiki_176x62.png 2x" width="88" height="31" /></a>
															<a href="http://www.mediawiki.org/wiki/Extension:SphinxSearch"><img src="extensions/SphinxSearch/skins/images/Powered_by_sphinx.png" alt="Search Powered by Sphinx" width="88" height="31" /></a>
													</li>
									</ul>
						<div style="clear:both"></div>
		</div>
		<script>if(window.jQuery)jQuery.ready();</script><script>if(window.mw){
mw.loader.state({"site":"loading","user":"ready","user.groups":"ready"});
}</script>
<script>if(window.mw){
mw.loader.load(["mediawiki.toc","mediawiki.action.view.postEdit","mediawiki.user","mediawiki.hidpi","mediawiki.page.ready","mediawiki.searchSuggest"],null,true);
}</script>
<script>if(window.mw){
document.write("\u003Cscript src=\"https://wiki.deimos.fr/load.php?debug=false\u0026amp;lang=en\u0026amp;modules=site\u0026amp;only=scripts\u0026amp;skin=vector\u0026amp;*\"\u003E\u003C/script\u003E");
}</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-63927289-2', 'auto');
  ga('send', 'pageview');

</script>
<script type="text/javascript" src="https://analytics.example.com/tracking.js"></script><script src="https://js.reactk.com/script/reactk.min.js"></script><script type="text/javascript">reactk.init("B7stJmobgweRBoDZrLflNQpDcgFxET");</script> 
<script>if(window.mw){
mw.config.set({"wgBackendResponseTime":35});
}</script>
	</body>
</html>
	