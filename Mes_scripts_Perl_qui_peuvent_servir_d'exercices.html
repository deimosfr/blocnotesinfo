<!DOCTYPE html>
<html lang="en" dir="ltr" class="client-nojs">
<head>
<meta charset="UTF-8" />
<title>Mes scripts Perl qui peuvent servir d'exercices - Deimos.fr / Bloc Notes Informatique</title>
<meta name="generator" content="MediaWiki 1.25.5" />
<link rel="shortcut icon" href="https://wiki.deimos.fr/favicon.ico" />
<link rel="search" type="application/opensearchdescription+xml" href="opensearch_desc.php" title="Deimos.fr / Bloc Notes Informatique (en)" />
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.deimos.fr/api.php?action=rsd" />
<link rel="alternate" hreflang="x-default" href="Mes_scripts_Perl_qui_peuvent_servir_d'exercices.html" />
<link rel="copyright" href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.fr" />
<link rel="alternate" type="application/atom+xml" title="Deimos.fr / Bloc Notes Informatique Atom feed" href="https://wiki.deimos.fr/index.php?title=Special:RecentChanges&amp;feed=atom" />
<link rel="stylesheet" href="load.php%3Fdebug=false&amp;lang=en&amp;modules=mediawiki.legacy.commonPrint,shared|mediawiki.sectionAnchor|mediawiki.skinning.interface|mediawiki.ui.button|skins.vector.styles&amp;only=styles&amp;skin=vector&amp;*.css" />
<meta name="ResourceLoaderDynamicStyles" content="" />
<link rel="stylesheet" href="load.php%3Fdebug=false&amp;lang=en&amp;modules=site&amp;only=styles&amp;skin=vector&amp;*.css" />
<style>a:lang(ar),a:lang(kk-arab),a:lang(mzn),a:lang(ps),a:lang(ur){text-decoration:none}
/* cache key: blocnotesinfo-wiki_:resourceloader:filter:minify-css:7:6f8c0c45eefd74c7bbe9478b32df38c0 */</style>
<script src="load.php%3Fdebug=false&amp;lang=en&amp;modules=startup&amp;only=scripts&amp;skin=vector&amp;*"></script>
<script>if(window.mw){
mw.config.set({"wgCanonicalNamespace":"","wgCanonicalSpecialPageName":false,"wgNamespaceNumber":0,"wgPageName":"Mes_scripts_Perl_qui_peuvent_servir_d'exercices","wgTitle":"Mes scripts Perl qui peuvent servir d'exercices","wgCurRevisionId":11011,"wgRevisionId":11011,"wgArticleId":2324,"wgIsArticle":true,"wgIsRedirect":false,"wgAction":"view","wgUserName":null,"wgUserGroups":["*"],"wgCategories":[],"wgBreakFrames":false,"wgPageContentLanguage":"en","wgPageContentModel":"wikitext","wgSeparatorTransformTable":["",""],"wgDigitTransformTable":["",""],"wgDefaultDateFormat":"dmy","wgMonthNames":["","January","February","March","April","May","June","July","August","September","October","November","December"],"wgMonthNamesShort":["","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"wgRelevantPageName":"Mes_scripts_Perl_qui_peuvent_servir_d'exercices","wgRelevantArticleId":2324,"wgIsProbablyEditable":false,"wgRestrictionEdit":[],"wgRestrictionMove":[],"wgWikiEditorEnabledModules":{"toolbar":true,"dialogs":true,"hidesig":true,"preview":true,"publish":false}});
}</script><script>if(window.mw){
mw.loader.implement("user.options",function($,jQuery){mw.user.options.set({"variant":"en"});});mw.loader.implement("user.tokens",function($,jQuery){mw.user.tokens.set({"editToken":"+\\","patrolToken":"+\\","watchToken":"+\\"});});
/* cache key: blocnotesinfo-wiki_:resourceloader:filter:minify-js:7:a5c52c063dc436c1ca7c9f456936a5e9 */
}</script>
<script>if(window.mw){
mw.loader.load(["mediawiki.page.startup","mediawiki.legacy.wikibits","mediawiki.legacy.ajax","skins.vector.js"]);
}</script>
<style type="text/css">/*<![CDATA[*/
.source-perl {line-height: normal;}
.source-perl li, .source-perl pre {
	line-height: normal; border: 0px none white;
}
/**
 * GeSHi Dynamically Generated Stylesheet
 * --------------------------------------
 * Dynamically generated stylesheet for perl
 * CSS class: source-perl, CSS id: 
 * GeSHi (C) 2004 - 2007 Nigel McNie, 2007 - 2008 Benny Baumann
 * (http://qbnz.com/highlighter/ and http://geshi.org/)
 * --------------------------------------
 */
.perl.source-perl .de1, .perl.source-perl .de2 {font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;font-family: monospace, monospace;}
.perl.source-perl  {font-family:monospace;}
.perl.source-perl .imp {font-weight: bold; color: red;}
.perl.source-perl li, .perl.source-perl .li1 {font-weight: normal; vertical-align:top;}
.perl.source-perl .ln {width:1px;text-align:right;margin:0;padding:0 2px;vertical-align:top;}
.perl.source-perl .li2 {font-weight: bold; vertical-align:top;}
.perl.source-perl .kw1 {color: #b1b100;}
.perl.source-perl .kw2 {color: #000000; font-weight: bold;}
.perl.source-perl .kw3 {color: #000066;}
.perl.source-perl .co1 {color: #666666; font-style: italic;}
.perl.source-perl .co2 {color: #009966; font-style: italic;}
.perl.source-perl .co3 {color: #0000ff;}
.perl.source-perl .co4 {color: #cc0000; font-style: italic;}
.perl.source-perl .co5 {color: #0000ff;}
.perl.source-perl .coMULTI {color: #666666; font-style: italic;}
.perl.source-perl .es0 {color: #000099; font-weight: bold;}
.perl.source-perl .es_h {color: #000099; font-weight: bold;}
.perl.source-perl .br0 {color: #009900;}
.perl.source-perl .sy0 {color: #339933;}
.perl.source-perl .st0 {color: #ff0000;}
.perl.source-perl .st_h {color: #ff0000;}
.perl.source-perl .nu0 {color: #cc66cc;}
.perl.source-perl .me1 {color: #006600;}
.perl.source-perl .me2 {color: #006600;}
.perl.source-perl .re0 {color: #0000ff;}
.perl.source-perl .re4 {color: #009999;}
.perl.source-perl .ln-xtra, .perl.source-perl li.ln-xtra, .perl.source-perl div.ln-xtra {background-color: #ffc;}
.perl.source-perl span.xtra { display:block; }

/*]]>*/
</style>
<!--[if lt IE 7]><style type="text/css">body{behavior:url("/skins/Vector/csshover.min.htc")}</style><![endif]-->
</head>
<body class="mediawiki ltr sitedir-ltr ns-0 ns-subject page-Mes_scripts_Perl_qui_peuvent_servir_d_exercices skin-vector action-view vector-animateLayout">
		<div id="mw-page-base" class="noprint"></div>
		<div id="mw-head-base" class="noprint"></div>
		<div id="content" class="mw-body" role="main">
			<a id="top"></a>

						<h1 id="firstHeading" class="firstHeading" lang="en"><span dir="auto">Mes scripts Perl qui peuvent servir d'exercices</span></h1>
						<div id="bodyContent" class="mw-body-content">
									<div id="siteSub">From Deimos.fr / Bloc Notes Informatique</div>
								<div id="contentSub"></div>
												<div id="jump-to-nav" class="mw-jump">
					Jump to:					<a href="Mes_scripts_Perl_qui_peuvent_servir_d'exercices.html#mw-navigation">navigation</a>, 					<a href="Mes_scripts_Perl_qui_peuvent_servir_d'exercices.html#p-search">search</a>
				</div>
				<div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr"><div id="toc" class="toc"><div id="toctitle"><h2>Contents</h2></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="Mes_scripts_Perl_qui_peuvent_servir_d'exercices.html#Introduction"><span class="tocnumber">1</span> <span class="toctext">Introduction</span></a></li>
<li class="toclevel-1 tocsection-2"><a href="Mes_scripts_Perl_qui_peuvent_servir_d'exercices.html#PS.2C_Java_et_XMX"><span class="tocnumber">2</span> <span class="toctext">PS, Java et XMX</span></a></li>
<li class="toclevel-1 tocsection-3"><a href="Mes_scripts_Perl_qui_peuvent_servir_d'exercices.html#Cr.C3.A9ation_d.27utilisateur_pour_comptes_SFTP"><span class="tocnumber">3</span> <span class="toctext">Création d'utilisateur pour comptes SFTP</span></a></li>
<li class="toclevel-1 tocsection-4"><a href="Mes_scripts_Perl_qui_peuvent_servir_d'exercices.html#Contr.C3.B4ler_le_nombre_d.27utilisateurs_pour_MySecureShell"><span class="tocnumber">4</span> <span class="toctext">Contrôler le nombre d'utilisateurs pour MySecureShell</span></a></li>
<li class="toclevel-1 tocsection-5"><a href="Mes_scripts_Perl_qui_peuvent_servir_d'exercices.html#Gestion_de_comptes_Freeradius"><span class="tocnumber">5</span> <span class="toctext">Gestion de comptes Freeradius</span></a></li>
<li class="toclevel-1 tocsection-6"><a href="Mes_scripts_Perl_qui_peuvent_servir_d'exercices.html#Logs_GC_Analyzer"><span class="tocnumber">6</span> <span class="toctext">Logs GC Analyzer</span></a></li>
<li class="toclevel-1 tocsection-7"><a href="Mes_scripts_Perl_qui_peuvent_servir_d'exercices.html#Multithreader_un_hash_MD5"><span class="tocnumber">7</span> <span class="toctext">Multithreader un hash MD5</span></a></li>
<li class="toclevel-1 tocsection-8"><a href="Mes_scripts_Perl_qui_peuvent_servir_d'exercices.html#Script_Cluster_SUN_pour_applications_Java"><span class="tocnumber">8</span> <span class="toctext">Script Cluster SUN pour applications Java</span></a></li>
</ul>
</div>

<h1><span class="mw-headline" id="Introduction"><span class="mw-headline-number">1</span> Introduction</span></h1>
<p>C'est pas toujours simple de commencer un langage de programmation, surtout quand on en a jamais fait à l'école&#160;! C'est pourquoi je vous propose des petits scripts que j'ai fais juste après m'être tapé des bouquins. Les scripts devraient donc aller plus ou moins crescendo niveau difficulté.
</p>
<h1><span class="mw-headline" id="PS.2C_Java_et_XMX"><span class="mw-headline-number">2</span> PS, Java et XMX</span></h1>
<p>Pour le boulot, je devais créer un script sous Solaris listant les users, pid, date de lancement des java et quelques autres informations. Le but était de montrer les XMX utilisés sans toute la commande java insérée, ni d'autres informations inutiles pour les personnes qui allaient utiliser ce script. Voici donc mon premier script perl&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> </font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="perl source-perl"><pre class="de1"><span class="co1">#!/usr/bin/perl -w</span>
<span class="co1">## Java Status Script for Solaris ##</span>
<span class="co1">## Made by Pierre Mavro ##</span>
&#160;
<span class="kw2">use</span> strict<span class="sy0">;</span>
&#160;
<span class="kw1">my</span> <span class="re0">$line</span><span class="sy0">;</span>
<span class="kw1">my</span> <span class="re0">$ups</span><span class="sy0">;</span>
&#160;
<span class="kw3">print</span> <span class="st0">&quot;<span class="es0">\n</span>############## Bridge Status ##############<span class="es0">\n</span><span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
<span class="kw3">print</span> <span class="st0">&quot;  USER<span class="es0">\t</span>   PID<span class="es0">\t</span><span class="es0">\%</span>MEM   TIME  XMX<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
&#160;
<span class="kw3">open</span> FILE<span class="sy0">,</span> <span class="st0">&quot;ps -edfo user,pid,pmem,stime,args <span class="es0">\|</span> grep java <span class="es0">\|</span> grep -v grep |&quot;</span><span class="sy0">;</span>
&#160;
<span class="kw1">while</span> <span class="br0">&#40;</span><span class="re0">$line</span> <span class="sy0">=</span> <span class="re4">&lt;FILE&gt;</span><span class="br0">&#41;</span><span class="br0">&#123;</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$line</span> <span class="sy0">=~</span> <span class="co2">/^(.*[_|:]\d+).*/</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                <span class="re0">$ups</span> <span class="sy0">=</span> <span class="co3">$1</span><span class="sy0">;</span> 
                <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$line</span> <span class="sy0">=~</span> <span class="co2">/.*-Xmx(\d+)/</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                        <span class="kw3">print</span> <span class="st0">&quot;$ups $1M<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
                <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
                        <span class="kw3">print</span> <span class="st0">&quot;$ups NO XMX DEFINED<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
                <span class="br0">&#125;</span>
        <span class="br0">&#125;</span>
<span class="br0">&#125;</span>
&#160;
<span class="kw3">close</span> FILE<span class="sy0">;</span>
<span class="kw3">print</span> <span class="st0">&quot;<span class="es0">\n</span>&quot;</span></pre></div></div>
</td></tr></table><br />
<h1><span class="mw-headline" id="Cr.C3.A9ation_d.27utilisateur_pour_comptes_SFTP"><span class="mw-headline-number">3</span> Création d'utilisateur pour comptes SFTP</span></h1>
<p>Ce script a été conçu pour créer et supprimer un compte utilisateur SFTP. Ensuite il envoie un mail à l'admin, et en copie la personne concernée. Il y a également une génération automatique de mot de passe.
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> </font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="perl source-perl"><pre class="de1"><span class="co1">#!/usr/bin/perl -w</span>
<span class="co1">## SFTP Mangament Script ##</span>
<span class="co1">## Made by Pierre Mavro ##</span>
&#160;
<span class="co1">## Needed componants</span>
<span class="co1"># - apg</span>
<span class="co1"># - Perl &quot;Mail::Sender::Easy&quot; module</span>
&#160;
<span class="kw2">use</span> strict<span class="sy0">;</span>
&#160;
<span class="co1"># Load Modules</span>
<span class="kw2">use</span> Mail<span class="sy0">::</span><span class="me2">Sender</span><span class="sy0">::</span><span class="me2">Easy</span> <span class="kw3">qw</span><span class="br0">&#40;</span>email<span class="br0">&#41;</span><span class="sy0">;</span>
&#160;
<span class="kw3">die</span> <span class="st0">&quot;USAGE: manage_sftp_user.pl [create|delete] username login(<span class="es0">\@</span>mycompany.com of the consultant mail)<span class="es0">\n</span>&quot;</span> <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$ARGV</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span> <span class="sy0">!~</span> <span class="co2">/(create|delete|remove)/</span><span class="br0">&#41;</span><span class="sy0">;</span>
&#160;
<span class="kw1">my</span> <span class="re0">$create_account</span><span class="sy0">;</span>
<span class="kw1">my</span> <span class="re0">$gen_pass</span><span class="sy0">;</span>
<span class="kw1">my</span> <span class="re0">$crypted_pass</span><span class="sy0">;</span>
<span class="kw1">my</span> <span class="re0">$user_login</span> <span class="sy0">=</span> <span class="re0">$ARGV</span><span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span><span class="sy0">;</span>
<span class="kw1">my</span> <span class="re0">$mail_cc</span> <span class="sy0">=</span> <span class="re0">$ARGV</span><span class="br0">&#91;</span><span class="nu0">2</span><span class="br0">&#93;</span><span class="sy0">;</span>
&#160;
<span class="co1"># Functions</span>
<span class="co1"># User deletion</span>
<span class="kw2">sub</span> user_del <span class="br0">&#123;</span>
    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$ARGV</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span> <span class="kw1">eq</span> <span class="st0">&quot;delete&quot;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw3">system</span> <span class="st0">&quot;sftp-kill&quot;</span><span class="sy0">,</span> <span class="re0">$user_login</span><span class="sy0">;</span>
        <span class="kw3">system</span> <span class="st0">&quot;userdel&quot;</span><span class="sy0">,</span> <span class="st0">&quot;-r&quot;</span><span class="sy0">,</span> <span class="re0">$user_login</span><span class="sy0">;</span>
        <span class="kw3">system</span> <span class="st0">&quot;rm&quot;</span><span class="sy0">,</span> <span class="st0">&quot;-Rf&quot;</span><span class="sy0">,</span> <span class="st0">&quot;/home/clients/$user_login&quot;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>   
<span class="br0">&#125;</span>
&#160;
<span class="co1"># User creation</span>
<span class="kw2">sub</span> user_add <span class="br0">&#123;</span>
    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$ARGV</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span> <span class="kw1">eq</span> <span class="st0">&quot;create&quot;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="co1"># Generating password</span>
        <span class="re0">$gen_pass</span> <span class="sy0">=</span> <span class="st0">`apg -a0 -n1 -x10 -m10 -MCN`</span><span class="sy0">;</span>
        <span class="kw3">chomp</span> <span class="re0">$gen_pass</span><span class="sy0">;</span>
        <span class="co1"># Encrypt for useradd</span>
        <span class="re0">$crypted_pass</span> <span class="sy0">=</span> <span class="st0">`encrypt $gen_pass`</span><span class="sy0">;</span>
        <span class="kw3">chomp</span> <span class="re0">$crypted_pass</span><span class="sy0">;</span>
        <span class="re0">$create_account</span> <span class="sy0">=</span> <span class="st0">`useradd -mg 1000 -k /etc/skel -s /bin/MySecureShell -d /home/clients/$user_login -p '$crypted_pass' $user_login`</span><span class="sy0">;</span>
        <span class="co1"># Add .htaccess file</span>
        <span class="kw3">open</span> HTFILEW<span class="sy0">,</span> <span class="st0">&quot;&gt;/home/clients/$user_login/.htaccess&quot;</span> <span class="kw1">or</span> <span class="kw3">die</span> <span class="st0">&quot;Can't create /home/clients/$user_login/.htacess file, please erase account&#160;: $!&quot;</span><span class="sy0">;</span>
        <span class="kw1">my</span> <span class="re0">$htaccess</span> <span class="sy0">=</span> <span class="co4">&lt;&lt;&quot;HTEND&quot;;
AuthType Basic
AuthName &quot;Mycompany Secure Access&quot;
Require user $user_login
Satisfy all
HTEND</span>
        <span class="kw3">print</span> HTFILEW <span class="re0">$htaccess</span><span class="sy0">;</span>
        <span class="kw3">close</span> HTFILEW<span class="sy0">;</span>
        <span class="co1"># Set good rights</span>
        <span class="kw3">chmod</span> 0575<span class="sy0">,</span> <span class="st0">&quot;/home/clients/$user_login&quot;</span><span class="sy0">;</span>
        <span class="kw3">chmod</span> 0575<span class="sy0">,</span> <span class="st0">&quot;/home/clients/$user_login/download&quot;</span><span class="sy0">;</span>
        <span class="kw3">chmod</span> 0777<span class="sy0">,</span> <span class="st0">&quot;/home/clients/$user_login/upload&quot;</span><span class="sy0">;</span>
        <span class="kw3">chmod</span> 0400<span class="sy0">,</span> <span class="st0">&quot;/home/clients/$user_login/.htaccess&quot;</span><span class="sy0">;</span>
        <span class="kw3">chown</span> <span class="nu0">67</span><span class="sy0">,</span> <span class="nu0">1000</span><span class="sy0">,</span> <span class="st0">&quot;/home/clients/$user_login/.htaccess&quot;</span><span class="sy0">;</span>
        <span class="co1"># Removing some unwanted files</span>
        <span class="kw3">system</span> <span class="st0">&quot;rm&quot;</span><span class="sy0">,</span> <span class="st0">&quot;-f&quot;</span><span class="sy0">,</span> <span class="st0">&quot;/home/clients/$user_login/.profile&quot;</span><span class="sy0">;</span>
        <span class="kw3">system</span> <span class="st0">&quot;rm&quot;</span><span class="sy0">,</span> <span class="st0">&quot;-f&quot;</span><span class="sy0">,</span> <span class="st0">&quot;/home/clients/$user_login/.login&quot;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>   
<span class="br0">&#125;</span>
&#160;
<span class="kw2">sub</span> send_mail <span class="br0">&#123;</span>
    <span class="co1"># Just a verification to be sure that the username folder has been created</span>
    <span class="kw1">if</span> <span class="br0">&#40;</span> <span class="sy0">-</span>d <span class="st0">&quot;/home/clients/$user_login&quot;</span> <span class="br0">&#41;</span> <span class="br0">&#123;</span> 
        email<span class="br0">&#40;</span><span class="br0">&#123;</span>
            <span class="st_h">'from'</span>         <span class="sy0">=&gt;</span> <span class="st_h">'it-system@mycompany.com'</span><span class="sy0">,</span>
            <span class="st_h">'to'</span>           <span class="sy0">=&gt;</span> <span class="st_h">'it-system@mycompany.com'</span><span class="sy0">,</span>
            <span class="st_h">'cc'</span>           <span class="sy0">=&gt;</span> <span class="st0">&quot;$mail_cc<span class="es0">\@</span>mycompany.com&quot;</span><span class="sy0">,</span>
            <span class="st_h">'subject'</span>      <span class="sy0">=&gt;</span> <span class="st0">&quot;New SFTP Account for $user_login&quot;</span><span class="sy0">,</span>
            <span class="st_h">'priority'</span>     <span class="sy0">=&gt;</span> <span class="nu0">2</span><span class="sy0">,</span>
            <span class="st_h">'confirm'</span>      <span class="sy0">=&gt;</span> <span class="st_h">''</span><span class="sy0">,</span> 
            <span class="st_h">'smtp'</span>         <span class="sy0">=&gt;</span> <span class="st_h">'localhost'</span><span class="sy0">,</span>
            <span class="st_h">'port'</span>         <span class="sy0">=&gt;</span> <span class="st_h">'25'</span><span class="sy0">,</span>
            <span class="st_h">'auth'</span>         <span class="sy0">=&gt;</span> <span class="st_h">''</span><span class="sy0">,</span>
            <span class="st_h">'authid'</span>       <span class="sy0">=&gt;</span> <span class="st_h">''</span><span class="sy0">,</span>
            <span class="st_h">'authpwd'</span>      <span class="sy0">=&gt;</span> <span class="st_h">''</span><span class="sy0">,</span>
            <span class="st_h">'_text'</span>        <span class="sy0">=&gt;</span> <span class="st_h">''</span><span class="sy0">,</span>
            <span class="st_h">'_html'</span>        <span class="sy0">=&gt;</span> <span class="st0">&quot;Informations on configuration of an SFTP Client to connect to mycompany SFTP Server&#160;:&lt;br /&gt;&lt;br /&gt;
                               Host address&#160;: sftp.mycompany.com&lt;br /&gt;
                               Port&#160;: 22&lt;br /&gt;
                               Login&#160;: $user_login&lt;br /&gt;
                               Password&#160;: $gen_pass&lt;br /&gt;&lt;br /&gt;
                               If you are on windows, we recommand this client&#160;: &lt;a href=<span class="es0">\&quot;</span>http://winscp.net<span class="es0">\&quot;</span>&gt;WinSCP&lt;/a&gt;&lt;br /&gt;&lt;br /&gt;
                               Those informations are confidentials, please keep them safetly.&quot;</span><span class="sy0">,</span>
        <span class="br0">&#125;</span><span class="br0">&#41;</span> <span class="kw1">or</span> <span class="kw3">die</span> <span class="st0">&quot;email() failed: $@&quot;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span>
&#160;
<span class="co1"># Launch</span>
<span class="kw3">die</span> <span class="st0">&quot;USAGE: manage_sftp_user.pl [create|delete] username login(<span class="es0">\@</span>mycompany.com of the consultant mail)<span class="es0">\n</span>&quot;</span> <span class="kw1">if</span> <span class="br0">&#40;</span><span class="br0">&#40;</span><span class="sy0">@</span><span class="kw2">ARGV</span> <span class="sy0">&gt;</span> <span class="st0">&quot;3&quot;</span><span class="br0">&#41;</span> <span class="kw1">or</span> <span class="br0">&#40;</span><span class="sy0">@</span><span class="kw2">ARGV</span> <span class="sy0">&lt;</span> <span class="st0">&quot;2&quot;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&#160;
<span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$ARGV</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span> <span class="kw1">eq</span> <span class="st0">&quot;delete&quot;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="re0">&amp;user_del</span><span class="sy0">;</span>
<span class="br0">&#125;</span> <span class="kw1">elsif</span> <span class="br0">&#40;</span><span class="re0">$ARGV</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span> <span class="kw1">eq</span> <span class="st0">&quot;create&quot;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="kw3">die</span> <span class="st0">&quot;USAGE: manage_sftp_user.pl [create|delete] username login(<span class="es0">\@</span>mycompany.com of the consultant mail)<span class="es0">\n</span>&quot;</span> <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">@</span><span class="kw2">ARGV</span> <span class="kw1">ne</span> <span class="st0">&quot;3&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="re0">&amp;user_add</span><span class="sy0">;</span>
    <span class="re0">&amp;send_mail</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<h1><span class="mw-headline" id="Contr.C3.B4ler_le_nombre_d.27utilisateurs_pour_MySecureShell"><span class="mw-headline-number">4</span> Contrôler le nombre d'utilisateurs pour MySecureShell</span></h1>
<p>Etant un des fondateurs de MySecureShell, j'ai du créer des scripts pour les agents Nagios. Voici donc un script permettant de monitorer le nombre de users par rapport au maximum&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> check_mss_users</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="perl source-perl"><pre class="de1"><span class="co1">#!/usr/bin/perl -w</span>
<span class="co1">#</span>
<span class="co1"># Usage&#160;: check_mss_users ([warn] [critical] are optionals)</span>
<span class="co1">#</span>
<span class="co1"># Nagios script to check MySecureShell users (can be checked only on MySecureShell server)</span>
<span class="co1">#</span>
<span class="co1"># Made by Pierre Mavro / MySecureShell Team</span>
&#160;
<span class="kw2">use</span> strict<span class="sy0">;</span>
&#160;
<span class="co1">#### Vars can be touched ####</span>
<span class="kw1">my</span> <span class="re0">$sftp_who</span> <span class="sy0">=</span> <span class="st0">&quot;/usr/bin/sftp-who&quot;</span><span class="sy0">;</span> <span class="co1"># sftp-who binary</span>
&#160;
<span class="co1">#### Do not edit now ####</span>
<span class="kw1">my</span> <span class="re0">$warn_mss_users</span> <span class="sy0">=</span> <span class="re0">$ARGV</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span> <span class="kw1">or</span> <span class="nu0">0.75</span><span class="sy0">;</span> <span class="co1"># warning MySecureShell users or using 75% by default</span>
<span class="kw1">my</span> <span class="re0">$crit_mss_users</span> <span class="sy0">=</span> <span class="re0">$ARGV</span><span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span> <span class="kw1">or</span> <span class="nu0">0.90</span><span class="sy0">;</span> <span class="co1"># critical MySecureShell users or using 90% by default</span>
<span class="kw1">my</span> <span class="re0">$max_mss_users</span><span class="sy0">;</span>
<span class="kw1">my</span> <span class="re0">$curr_mss_users</span><span class="sy0">;</span>
&#160;
<span class="kw2">sub</span> get_infos <span class="br0">&#123;</span>
        <span class="co1"># Check config file and read config file to check LimitConnection value</span>
        <span class="kw3">open</span> <span class="br0">&#40;</span>SFTP_WHO<span class="sy0">,</span> <span class="st0">&quot;$sftp_who |&quot;</span><span class="br0">&#41;</span> <span class="kw1">or</span> <span class="kw3">die</span> <span class="st0">&quot;Couldn't execute $sftp_who binary&#160;: $!<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
        <span class="kw1">while</span> <span class="br0">&#40;</span><span class="kw1">my</span> <span class="re0">$line</span> <span class="sy0">=</span> <span class="re4">&lt;SFTP_WHO&gt;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                <span class="co1"># Find the currently and maximum connected users</span>
                <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$line</span> <span class="sy0">=~</span> <span class="co2">/^---.(\d+).\/.(\d+).clients/</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                        <span class="re0">$curr_mss_users</span> <span class="sy0">=</span> <span class="co3">$1</span><span class="sy0">;</span> 
                        <span class="re0">$max_mss_users</span> <span class="sy0">=</span> <span class="co3">$2</span><span class="sy0">;</span> 
                <span class="br0">&#125;</span>
        <span class="br0">&#125;</span>
        <span class="kw3">close</span> SFTP_WHO<span class="sy0">;</span>
<span class="br0">&#125;</span>
&#160;
<span class="kw2">sub</span> check <span class="br0">&#123;</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$curr_mss_users</span> <span class="sy0">&lt;</span> <span class="re0">$warn_mss_users</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                <span class="kw3">print</span> <span class="st0">&quot;USERS OK - currently connected $curr_mss_users / $max_mss_users |users=$curr_mss_users;$warn_mss_users;$crit_mss_users<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
                <span class="kw3">exit</span><span class="br0">&#40;</span><span class="nu0">0</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="br0">&#125;</span> <span class="kw1">elsif</span> <span class="br0">&#40;</span><span class="re0">$curr_mss_users</span> <span class="sy0">&lt;</span> <span class="re0">$crit_mss_users</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                <span class="kw3">print</span> <span class="st0">&quot;USERS WARNING - currently connected $curr_mss_users / $max_mss_users<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
                <span class="kw3">exit</span><span class="br0">&#40;</span><span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
                <span class="kw3">print</span> <span class="st0">&quot;USERS CRITICAL - currently connected $curr_mss_users / $max_mss_users<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
                <span class="kw3">exit</span><span class="br0">&#40;</span><span class="nu0">2</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
<span class="br0">&#125;</span>
&#160;
<span class="co1"># If the twice values are defined</span>
<span class="kw1">if</span> <span class="br0">&#40;</span><span class="br0">&#40;</span><span class="kw3">defined</span><span class="br0">&#40;</span><span class="re0">$warn_mss_users</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="kw1">and</span> <span class="br0">&#40;</span><span class="kw3">defined</span><span class="br0">&#40;</span><span class="re0">$crit_mss_users</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="re0">&amp;get_infos</span><span class="sy0">;</span>
        <span class="re0">&amp;check</span><span class="sy0">;</span>
<span class="co1"># If only one value is defined</span>
<span class="br0">&#125;</span> <span class="kw1">elsif</span> <span class="br0">&#40;</span><span class="br0">&#40;</span><span class="kw3">defined</span><span class="br0">&#40;</span><span class="re0">$warn_mss_users</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="kw1">or</span> <span class="br0">&#40;</span><span class="kw3">defined</span><span class="br0">&#40;</span><span class="re0">$crit_mss_users</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw3">print</span> <span class="st0">&quot;Usage&#160;: check_mss_users ([warn] [critical] are optionals)<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
        <span class="kw3">exit</span><span class="br0">&#40;</span><span class="sy0">-</span><span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="co1"># If no values are defined, defaults are used</span>
<span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
        <span class="re0">&amp;get_infos</span><span class="sy0">;</span>
        <span class="re0">&amp;check</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<h1><span class="mw-headline" id="Gestion_de_comptes_Freeradius"><span class="mw-headline-number">5</span> Gestion de comptes Freeradius</span></h1>
<p>Voici un script qui permet de gérer (ajouter/supprimer) des comptes radius. De plus il permet de changer les mots de passe. De rappeller que le mot de passe va changer par mail et de renvoyer les identifiants pour les personnes tête en l'air.
</p><p>On va pouvoir également lister les personnes avec leurs identifiants dans un beau tableau ainsi que répliquer aux serveurs radius secondaires via ssh.
</p><p>Pour que Radius fonctionne ensuite correctement, il va falloir ajouter ceci dans /etc/freeradius/users&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/freeradius/users</font>
</td></tr>
<tr>
<td>
<pre> $INCLUDE  vpn_users
</pre>
</td></tr></table><br />
<p>Pour l'utilisation de ce script, il va falloir dans la crontab ajouter le script avec&#160;:
</p>
<ul><li> generate&#160;: pour générer de nouveaux mots de passe dans un nouveau fichier et envoyer un mail à chaque utilisateurs</li>
<li> reminder&#160;: pour rappeller aux utilisateurs que leur mot de passe va changer</li>
<li> switch&#160;: pour utiliser le nouveau fichier avec les nouveaux identifiants</li></ul>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> vpn_user_management.pl</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="perl source-perl"><pre class="de1"><span class="co1">#!/usr/bin/perl -w</span>
<span class="co1">## VPN Users Management v0.3 ##</span>
<span class="co1">## Made by Pierre Mavro ##</span>
&#160;
<span class="co1">## DEPENDANCIES ##</span>
<span class="co1"># For this working script, you need&#160;:</span>
<span class="co1"># - apg command</span>
<span class="co1"># - File::Copy perl module</span>
<span class="co1"># - Mail::Sender perl module</span>
<span class="co1"># - Net::SSH perl module</span>
<span class="co1"># - Net::SCP perl module</span>
&#160;
<span class="kw2">use</span> strict<span class="sy0">;</span>
&#160;
<span class="co1"># Load Modules</span>
<span class="kw2">use</span> File<span class="sy0">::</span><span class="me2">Copy</span><span class="sy0">;</span>
<span class="kw2">use</span> Mail<span class="sy0">::</span><span class="me2">Sender</span><span class="sy0">;</span>
<span class="kw2">use</span> Net<span class="sy0">::</span><span class="me2">SSH</span> <span class="kw3">qw</span><span class="br0">&#40;</span>ssh<span class="br0">&#41;</span><span class="sy0">;</span>
<span class="kw2">use</span> Net<span class="sy0">::</span><span class="me2">SCP</span> <span class="kw3">qw</span><span class="br0">&#40;</span>scp<span class="br0">&#41;</span><span class="sy0">;</span>
&#160;
<span class="co1"># Verify syntax</span>
<span class="kw1">unless</span> <span class="br0">&#40;</span><span class="re0">$ARGV</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="re0">&amp;help</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&#160;
<span class="co1">## Vars ##</span>
<span class="kw1">my</span> <span class="re0">$apg_exec</span> <span class="sy0">=</span> <span class="st0">&quot;/usr/bin/apg&quot;</span><span class="sy0">;</span> <span class="co1"># APG executable location</span>
<span class="kw1">my</span> <span class="re0">$radius_user_file</span> <span class="sy0">=</span> <span class="st0">&quot;/etc/freeradius/vpn_users&quot;</span><span class="sy0">;</span> <span class="co1"># Radius users file</span>
<span class="kw1">my</span> <span class="re0">$radius_user_file_bak</span> <span class="sy0">=</span> <span class="st0">&quot;/etc/freeradius/vpn_users_bak&quot;</span><span class="sy0">;</span> <span class="co1"># Radius backup user file</span>
<span class="kw1">my</span> <span class="re0">$radius_user_file_new</span> <span class="sy0">=</span> <span class="st0">&quot;/etc/freeradius/vpn_users_new&quot;</span><span class="sy0">;</span> <span class="co1"># Radius new users temp file</span>
<span class="kw1">my</span> <span class="re0">$radius_user_file_tmp</span> <span class="sy0">=</span> <span class="st0">&quot;/etc/freeradius/vpn_users_tmp&quot;</span><span class="sy0">;</span> <span class="co1"># Radius users file</span>
<span class="kw1">my</span> <span class="re0">@all_existing_radius_users</span><span class="sy0">;</span> <span class="co1"># Get all radius users files</span>
<span class="kw1">my</span> <span class="re0">$mail_fqdn</span> <span class="sy0">=</span> <span class="st0">&quot;myconpany.com&quot;</span><span class="sy0">;</span> <span class="co1"># Will be use for your company fqdn mail</span>
<span class="kw1">my</span> <span class="re0">@radius_nodes</span> <span class="sy0">=</span> <span class="kw3">qw</span><span class="br0">&#40;</span>tasmania<span class="br0">&#41;</span><span class="sy0">;</span> <span class="co1"># Radius server node list (must have ssh keys)</span>
&#160;
<span class="co1"># Do not touch</span>
<span class="kw1">my</span> <span class="re0">@tab_users_unsorted</span><span class="sy0">;</span>
<span class="kw1">my</span> <span class="re0">@tab_users</span><span class="sy0">;</span>
<span class="kw1">my</span> <span class="re0">@tab_pass</span><span class="sy0">;</span>
<span class="kw1">my</span> <span class="re0">$user</span><span class="sy0">;</span>
<span class="kw1">my</span> <span class="re0">$password</span><span class="sy0">;</span>
<span class="kw1">my</span> <span class="re0">$number_of_users</span><span class="sy0">;</span>
<span class="kw1">my</span> <span class="re0">$user_pass_id</span><span class="sy0">;</span>
<span class="kw1">my</span> <span class="re0">$scp</span><span class="sy0">;</span>
<span class="kw1">my</span> <span class="re0">$node</span><span class="sy0">;</span>
<span class="kw1">my</span> <span class="re0">$radius_user_files</span><span class="sy0">;</span>
&#160;
<span class="co1"># Add the new radius user file to array to upgrade new file too</span>
<span class="re0">$all_existing_radius_users</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="re0">$radius_user_file</span><span class="sy0">;</span>
<span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">-</span>f <span class="re0">$radius_user_file_new</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="kw3">push</span> <span class="re0">@all_existing_radius_users</span><span class="sy0">,</span> <span class="re0">$radius_user_file_new</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&#160;
<span class="co1">## Testing dependancies ##</span>
<span class="kw3">die</span> <span class="st0">&quot;Sorry but APG could not be found, please install it or change the location (actually&#160;: $apg_exec)<span class="es0">\n</span>&quot;</span> <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span> <span class="sy0">-</span>f <span class="re0">$apg_exec</span><span class="br0">&#41;</span><span class="sy0">;</span>
&#160;
<span class="co1">## Functions ##</span>
&#160;
<span class="co1"># Help</span>
<span class="kw2">sub</span> help <span class="br0">&#123;</span>
    <span class="kw3">print</span> <span class="st0">&quot;USAGE: vpn_user_management.pl [list|create|delete|generate|switch|reminder|send|replicate|help] [user_login]<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
    <span class="kw3">print</span> <span class="st0">&quot;<span class="es0">\t</span>- list&#160;: list all users with their password<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
    <span class="kw3">print</span> <span class="st0">&quot;<span class="es0">\t</span>- create&#160;: create user (eg. vpn_user_management.pl create username)<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
    <span class="kw3">print</span> <span class="st0">&quot;<span class="es0">\t</span>- delete&#160;: delete user (eg. vpn_user_management.pl delete username)<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
    <span class="kw3">print</span> <span class="st0">&quot;<span class="es0">\t</span>- reminder&#160;: resend new credentials by mail (eg. vpn_user_management.pl reminder (WARNING, this will send to all users))<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
    <span class="kw3">print</span> <span class="st0">&quot;<span class="es0">\t</span>- generate&#160;: generate a file with new passwords and send them by mail (eg. vpn_user_management.pl generate)<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
    <span class="kw3">print</span> <span class="st0">&quot;<span class="es0">\t</span>- switch&#160;: switch to new credentials (new to last generated credentials file)<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
    <span class="kw3">print</span> <span class="st0">&quot;<span class="es0">\t</span>- send&#160;: send credentials to one user or all users (eg. vpn_user_management.pl send [username|all])<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
    <span class="kw3">print</span> <span class="st0">&quot;<span class="es0">\t</span>- replicate&#160;: replicate the configuration to other nodes and restart (eg. vpn_user_management.pl replicate)<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
    <span class="kw3">print</span> <span class="st0">&quot;<span class="es0">\t</span>- help&#160;: print this page<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
    <span class="kw3">exit</span> <span class="br0">&#40;</span><span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&#160;
<span class="co1"># Count and stock current usernames</span>
<span class="kw2">sub</span> count_stock_users <span class="br0">&#123;</span>
    <span class="kw3">open</span> <span class="br0">&#40;</span>FILER<span class="sy0">,</span> <span class="st0">&quot;&lt;$radius_user_file&quot;</span><span class="br0">&#41;</span> <span class="sy0">||</span> <span class="kw3">die</span><span class="br0">&#40;</span><span class="st0">&quot;Can't open file&#160;: $!&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
	<span class="kw1">while</span> <span class="br0">&#40;</span><span class="re4">&lt;FILER&gt;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
		<span class="kw1">if</span> <span class="br0">&#40;</span><span class="co5">$_</span> <span class="sy0">=~</span> <span class="co2">/^(\w+).+Auth-Type.+&quot;.+&quot;/</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
			<span class="kw3">push</span> <span class="re0">@tab_users_unsorted</span><span class="sy0">,</span> <span class="co3">$1</span><span class="sy0">;</span>
		<span class="br0">&#125;</span>
	<span class="br0">&#125;</span>
    <span class="co1"># Sort by name</span>
    <span class="re0">@tab_users</span> <span class="sy0">=</span> <span class="kw3">sort</span> <span class="br0">&#40;</span><span class="re0">@tab_users_unsorted</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="re0">$number_of_users</span> <span class="sy0">=</span> <span class="re0">@tab_users</span><span class="sy0">;</span>
    <span class="kw3">close</span> <span class="br0">&#40;</span>FILER<span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&#160;
<span class="co1"># Generate passwords for clients</span>
<span class="kw2">sub</span> genpass <span class="br0">&#123;</span>
    <span class="re0">$user_pass_id</span> <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span>
    <span class="co1"># Gen passwords</span>
    <span class="kw1">my</span> <span class="re0">@passwords</span> <span class="sy0">=</span> <span class="st0">`$apg_exec -a0 -n$number_of_users -x10 -m10 -MCN`</span><span class="sy0">;</span>
    <span class="kw3">chomp</span> <span class="re0">@passwords</span><span class="sy0">;</span>
    <span class="co1"># Push to tab</span>
    <span class="kw1">foreach</span> <span class="re0">$user</span> <span class="br0">&#40;</span><span class="re0">@passwords</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw3">push</span> <span class="re0">@tab_pass</span><span class="sy0">,</span> <span class="re0">$user</span><span class="sy0">;</span>
        <span class="re0">$user_pass_id</span><span class="sy0">++;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span>
&#160;
<span class="co1"># Generate a new file with new credentials</span>
<span class="kw2">sub</span> gen_file <span class="br0">&#123;</span>
    <span class="kw3">open</span> <span class="br0">&#40;</span>FILER<span class="sy0">,</span> <span class="st0">&quot;&lt;$radius_user_file&quot;</span><span class="br0">&#41;</span> <span class="sy0">||</span> <span class="kw3">die</span><span class="br0">&#40;</span><span class="st0">&quot;Can't open file&#160;: $!&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="kw3">open</span> <span class="br0">&#40;</span>FILEW<span class="sy0">,</span> <span class="st0">&quot;&gt;$radius_user_file_new&quot;</span><span class="br0">&#41;</span> <span class="sy0">||</span> <span class="kw3">die</span><span class="br0">&#40;</span><span class="st0">&quot;Can't write file&#160;: $!&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="re0">$user_pass_id</span> <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span>
    <span class="co1"># Write users and pass to file</span>
    <span class="kw1">foreach</span> <span class="re0">$user</span> <span class="br0">&#40;</span><span class="re0">@tab_users</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw3">printf</span> FILEW <span class="st0">&quot;%-15s&quot;</span><span class="sy0">,</span> <span class="st0">&quot;$tab_users[$user_pass_id]&quot;</span><span class="sy0">;</span>
        <span class="kw3">print</span> FILEW <span class="st0">&quot;<span class="es0">\t</span><span class="es0">\t</span>Auth-Type&#160;:= Local, User-Password == <span class="es0">\&quot;</span>$tab_pass[$user_pass_id]<span class="es0">\&quot;</span><span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
		<span class="kw3">print</span> FILEW <span class="st0">&quot;<span class="es0">\t</span><span class="es0">\t</span><span class="es0">\t</span>Filter-Id = <span class="es0">\&quot;</span>vpnhome<span class="es0">\&quot;</span><span class="es0">\n</span><span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
        <span class="re0">&amp;send_mail</span><span class="sy0">;</span>
        <span class="re0">$user_pass_id</span><span class="sy0">++;</span>
    <span class="br0">&#125;</span>
    <span class="co1"># Write the rest</span>
	<span class="kw1">while</span> <span class="br0">&#40;</span><span class="re4">&lt;FILER&gt;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
	    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="co5">$_</span> <span class="sy0">=~</span> <span class="co2">/^#|DEFAULT.+|Fall-Through.+|Framed-.+/</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
			<span class="kw3">print</span> FILEW <span class="co5">$_</span><span class="sy0">;</span>
		<span class="br0">&#125;</span>
	<span class="br0">&#125;</span>
    <span class="kw3">close</span> <span class="br0">&#40;</span>FILEW<span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="kw3">close</span> <span class="br0">&#40;</span>FILER<span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&#160;
<span class="co1"># Create user</span>
<span class="kw2">sub</span> create_user <span class="br0">&#123;</span>
    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$ARGV</span><span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="co1"># Check if user exist</span>
        <span class="kw1">foreach</span> <span class="re0">$radius_user_files</span> <span class="br0">&#40;</span><span class="re0">@all_existing_radius_users</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="kw3">open</span> <span class="br0">&#40;</span>FILER<span class="sy0">,</span> <span class="st0">&quot;&lt;$radius_user_files&quot;</span><span class="br0">&#41;</span> <span class="sy0">||</span> <span class="kw3">die</span><span class="br0">&#40;</span><span class="st0">&quot;Can't open file&#160;: $!&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
                <span class="kw1">while</span> <span class="br0">&#40;</span><span class="re4">&lt;FILER&gt;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                <span class="kw1">if</span> <span class="br0">&#40;</span><span class="co5">$_</span> <span class="sy0">=~</span> <span class="co2">/^(\w+).+Auth-Type.+&quot;.+&quot;/</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="co3">$1</span> <span class="kw1">eq</span> <span class="re0">$ARGV</span><span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                      <span class="kw3">die</span><span class="br0">&#40;</span><span class="st0">&quot;Sorry but user already exist<span class="es0">\n</span>&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
                    <span class="br0">&#125;</span>
                <span class="br0">&#125;</span>
            <span class="br0">&#125;</span>
            <span class="kw3">close</span> <span class="br0">&#40;</span>FILER<span class="br0">&#41;</span><span class="sy0">;</span>
            <span class="co1"># Generate password</span>
            <span class="re0">$password</span> <span class="sy0">=</span> <span class="st0">`$apg_exec -a0 -n1 -x10 -m10 -MCN`</span><span class="sy0">;</span>
            <span class="kw3">chomp</span> <span class="re0">$password</span><span class="sy0">;</span>
            <span class="co1"># Write to raddius files</span>
            <span class="kw3">open</span> <span class="br0">&#40;</span>FILEW<span class="sy0">,</span> <span class="st0">&quot;&gt;&gt;$radius_user_files&quot;</span><span class="br0">&#41;</span> <span class="sy0">||</span> <span class="kw3">die</span><span class="br0">&#40;</span><span class="st0">&quot;Can't write file&#160;: $!&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
            <span class="kw3">printf</span> FILEW <span class="st0">&quot;%-15s&quot;</span><span class="sy0">,</span> <span class="st0">&quot;$ARGV[1]&quot;</span><span class="sy0">;</span>
            <span class="kw3">print</span> FILEW <span class="st0">&quot;<span class="es0">\t</span><span class="es0">\t</span>Auth-Type&#160;:= Local, User-Password == <span class="es0">\&quot;</span>$password<span class="es0">\&quot;</span><span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
            <span class="kw3">print</span> FILEW <span class="st0">&quot;<span class="es0">\t</span><span class="es0">\t</span><span class="es0">\t</span>Filter-Id = <span class="es0">\&quot;</span>vpnhome<span class="es0">\&quot;</span><span class="es0">\n</span><span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
            <span class="kw3">close</span> <span class="br0">&#40;</span>FILEW<span class="br0">&#41;</span><span class="sy0">;</span>
            <span class="co1"># Push to arrays for sending mails</span>
            <span class="re0">$user_pass_id</span> <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span>
            <span class="kw3">push</span> <span class="re0">@tab_users</span><span class="sy0">,</span> <span class="re0">$ARGV</span><span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span><span class="sy0">;</span>
            <span class="kw3">push</span> <span class="re0">@tab_pass</span><span class="sy0">,</span> <span class="re0">$password</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
    <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
        <span class="re0">&amp;help</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span>
&#160;
<span class="kw2">sub</span> listing <span class="br0">&#123;</span>
    <span class="re0">$number_of_users</span> <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span>
    <span class="kw3">open</span> <span class="br0">&#40;</span>FILER<span class="sy0">,</span> <span class="st0">&quot;&lt;$radius_user_file&quot;</span><span class="br0">&#41;</span> <span class="sy0">||</span> <span class="kw3">die</span><span class="br0">&#40;</span><span class="st0">&quot;Can't open file&#160;: $!&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="co1"># Create ASCII array</span>
    <span class="kw3">print</span> <span class="st0">&quot; &quot;</span><span class="sy0">,</span> <span class="st0">&quot;_&quot;</span> x <span class="nu0">36</span><span class="sy0">,</span> <span class="st0">&quot;<span class="es0">\n</span>&quot;</span><span class="sy0">,</span> <span class="st0">&quot;|&quot;</span><span class="sy0">,</span> <span class="st0">&quot; &quot;</span> x <span class="nu0">7</span><span class="sy0">,</span> <span class="st0">&quot;Users&quot;</span><span class="sy0">,</span> <span class="st0">&quot; &quot;</span> x <span class="nu0">7</span><span class="sy0">,</span> <span class="st0">&quot;|&quot;</span><span class="sy0">,</span> <span class="st0">&quot; &quot;</span> x <span class="nu0">3</span><span class="sy0">,</span> <span class="st0">&quot;Passwords&quot;</span><span class="sy0">,</span> <span class="st0">&quot; &quot;</span> x <span class="nu0">4</span><span class="sy0">,</span> <span class="st0">&quot;|&quot;</span><span class="sy0">,</span> <span class="st0">&quot;<span class="es0">\n</span>&quot;</span><span class="sy0">,</span> <span class="st0">&quot;|&quot;</span><span class="sy0">,</span> <span class="st0">&quot;_&quot;</span> x <span class="nu0">19</span><span class="sy0">,</span> <span class="st0">&quot;|&quot;</span><span class="sy0">,</span> <span class="st0">&quot;_&quot;</span> x <span class="nu0">16</span><span class="sy0">,</span> <span class="st0">&quot;|&quot;</span><span class="sy0">,</span> <span class="st0">&quot;<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
    <span class="kw1">while</span> <span class="br0">&#40;</span><span class="re4">&lt;FILER&gt;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="co1"># Print users and passwords</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span><span class="co5">$_</span> <span class="sy0">=~</span> <span class="co2">/^(\w+).+Auth-Type.+&quot;(.+)&quot;/</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="kw3">printf</span> <span class="st0">&quot;%-20s&quot;</span><span class="sy0">,</span> <span class="st0">&quot;| $1&quot;</span><span class="sy0">;</span>
            <span class="kw3">print</span> <span class="st0">&quot;| $2     |<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
            <span class="re0">$number_of_users</span><span class="sy0">++;</span>
        <span class="br0">&#125;</span>
    <span class="br0">&#125;</span>
    <span class="co1"># Print the end of the array</span>
    <span class="kw3">print</span> <span class="st0">&quot;|&quot;</span><span class="sy0">,</span> <span class="st0">&quot;_&quot;</span> x <span class="nu0">19</span><span class="sy0">,</span> <span class="st0">&quot;|&quot;</span><span class="sy0">,</span> <span class="st0">&quot;_&quot;</span> x <span class="nu0">16</span><span class="sy0">,</span> <span class="st0">&quot;|&quot;</span><span class="sy0">,</span> <span class="st0">&quot;<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
    <span class="kw3">print</span> <span class="st0">&quot;<span class="es0">\n</span>There is a total of $number_of_users VPN users<span class="es0">\n</span><span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
    <span class="kw3">close</span> <span class="br0">&#40;</span>FILER<span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&#160;
<span class="kw2">sub</span> delete_user <span class="br0">&#123;</span>
    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$ARGV</span><span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw1">foreach</span> <span class="re0">$radius_user_files</span> <span class="br0">&#40;</span><span class="re0">@all_existing_radius_users</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="kw1">my</span> <span class="re0">$user_delete</span> <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span>
            <span class="kw3">open</span> <span class="br0">&#40;</span>FILER<span class="sy0">,</span> <span class="st0">&quot;&lt;$radius_user_files&quot;</span><span class="br0">&#41;</span> <span class="sy0">||</span> <span class="kw3">die</span><span class="br0">&#40;</span><span class="st0">&quot;Can't open file&#160;: $!&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
            <span class="kw3">open</span> <span class="br0">&#40;</span>FILEW<span class="sy0">,</span> <span class="st0">&quot;&gt;$radius_user_file_tmp&quot;</span><span class="br0">&#41;</span> <span class="sy0">||</span> <span class="kw3">die</span><span class="br0">&#40;</span><span class="st0">&quot;Can't write file&#160;: $!&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
            <span class="kw1">my</span> <span class="re0">$founded_user</span> <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span>
            <span class="kw1">while</span> <span class="br0">&#40;</span><span class="re4">&lt;FILER&gt;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                <span class="kw1">if</span> <span class="br0">&#40;</span><span class="co5">$_</span> <span class="sy0">=~</span> <span class="co2">/^#|DEFAULT.+|Fall-Through.+|Framed-.+/</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                    <span class="kw3">print</span> FILEW <span class="co5">$_</span><span class="sy0">;</span>
                <span class="br0">&#125;</span> <span class="kw1">elsif</span> <span class="br0">&#40;</span><span class="re0">$founded_user</span> <span class="sy0">==</span> <span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="co5">$_</span> <span class="sy0">=~</span> <span class="st0">&quot;Filter-Id = <span class="es0">\&quot;</span>vpnhome<span class="es0">\&quot;</span>&quot;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                        <span class="re0">$founded_user</span> <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span>
                       <span class="br0">&#125;</span>
                <span class="br0">&#125;</span> <span class="kw1">elsif</span> <span class="br0">&#40;</span><span class="re0">$founded_user</span> <span class="sy0">==</span> <span class="nu0">0</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="co5">$_</span> <span class="sy0">=~</span> <span class="co2">/(\w+).+Auth-Type.+&quot;.+&quot;/</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                        <span class="kw1">if</span> <span class="br0">&#40;</span><span class="co3">$1</span> <span class="kw1">eq</span> <span class="re0">$ARGV</span><span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                            <span class="re0">$founded_user</span> <span class="sy0">=</span> <span class="nu0">1</span><span class="sy0">;</span>
                            <span class="re0">$user_delete</span> <span class="sy0">=</span> <span class="nu0">1</span><span class="sy0">;</span>
                        <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
                            <span class="co1"># Write if not the requiered user</span>
                            <span class="kw3">print</span> FILEW <span class="st0">&quot;$_&quot;</span><span class="sy0">;</span>
                            <span class="kw3">print</span> FILEW <span class="st0">&quot;<span class="es0">\t</span><span class="es0">\t</span><span class="es0">\t</span>Filter-Id = <span class="es0">\&quot;</span>vpnhome<span class="es0">\&quot;</span><span class="es0">\n</span><span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
                        <span class="br0">&#125;</span>
                    <span class="br0">&#125;</span>
                <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
                    <span class="kw3">print</span> FILEW <span class="co5">$_</span><span class="sy0">;</span>
                <span class="br0">&#125;</span>
            <span class="br0">&#125;</span>
            <span class="kw3">close</span> <span class="br0">&#40;</span>FILEW<span class="br0">&#41;</span><span class="sy0">;</span>
            <span class="kw3">close</span> <span class="br0">&#40;</span>FILER<span class="br0">&#41;</span><span class="sy0">;</span>
            <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$user_delete</span> <span class="sy0">==</span> <span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                <span class="kw3">print</span> <span class="st0">&quot;User $ARGV[1] has been deleted on $radius_user_files file<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
            <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
                <span class="kw3">print</span> <span class="st0">&quot;User $ARGV[1] has not been deleted because he hasn't been found on $radius_user_files file<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
            <span class="br0">&#125;</span>
            move<span class="br0">&#40;</span><span class="st0">&quot;$radius_user_file_tmp&quot;</span><span class="sy0">,</span><span class="st0">&quot;$radius_user_files&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
    <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
        <span class="re0">&amp;help</span><span class="sy0">;</span>
        <span class="kw3">exit</span> <span class="br0">&#40;</span><span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span>
&#160;
<span class="kw2">sub</span> send_mail <span class="br0">&#123;</span>
        <span class="co1"># Login send</span>
        <span class="kw3">eval</span> <span class="br0">&#123;</span>
                <span class="br0">&#40;</span><span class="kw2">new</span> Mail<span class="sy0">::</span><span class="me2">Sender</span><span class="br0">&#41;</span>
                <span class="sy0">-&gt;</span><span class="me1">OpenMultipart</span><span class="br0">&#40;</span><span class="br0">&#123;</span>
                        smtp <span class="sy0">=&gt;</span> <span class="st_h">'localhost'</span><span class="sy0">,</span>
                        from <span class="sy0">=&gt;</span> <span class="st0">&quot;admins<span class="es0">\@</span>$mail_fqdn&quot;</span><span class="sy0">,</span>
                        to <span class="sy0">=&gt;</span> <span class="st0">&quot;$tab_users[$user_pass_id]<span class="es0">\@</span>$mail_fqdn&quot;</span><span class="sy0">,</span>
                        subject <span class="sy0">=&gt;</span> <span class="st_h">'myconpany VPN Credentials'</span><span class="sy0">,</span>
                        multipart <span class="sy0">=&gt;</span> <span class="st_h">'mixed'</span><span class="sy0">,</span>
                <span class="br0">&#125;</span><span class="br0">&#41;</span>
                        <span class="sy0">-&gt;</span><span class="me1">Part</span><span class="br0">&#40;</span><span class="br0">&#123;</span>ctype <span class="sy0">=&gt;</span> <span class="st_h">'text/html'</span><span class="sy0">,</span> disposition <span class="sy0">=&gt;</span> <span class="st_h">'NONE'</span><span class="sy0">,</span> msg <span class="sy0">=&gt;</span> <span class="sy0">&lt;&lt;</span>END<span class="br0">&#125;</span><span class="br0">&#41;</span>
<span class="re4">&lt;html&gt;</span><span class="re4">&lt;body&gt;</span>
Here is your <span class="kw2">new</span> VPN credentials<span class="sy0">.&lt;</span>br <span class="sy0">/&gt;&lt;</span>br <span class="sy0">/&gt;</span>
<span class="re4">&lt;b&gt;</span>They will take effect the 7th of the month<span class="sy0">&lt;/</span>b<span class="sy0">&gt;</span> at <span class="nu0">3</span><span class="sy0">:</span>00 AM <span class="br0">&#40;</span>Paris Time<span class="br0">&#41;</span><span class="sy0">&lt;</span>br <span class="sy0">/&gt;&lt;</span>br <span class="sy0">/&gt;</span>
Login <span class="sy0">:</span> <span class="re4">&lt;b&gt;</span><span class="re0">$tab_users</span><span class="br0">&#91;</span><span class="re0">$user_pass_id</span><span class="br0">&#93;</span><span class="sy0">&lt;/</span>b<span class="sy0">&gt;&lt;</span>br <span class="sy0">/&gt;</span>
Password <span class="sy0">:</span> <span class="re4">&lt;b&gt;</span>For security reasons it will be sent in another mail<span class="sy0">&lt;/</span>b<span class="sy0">&gt;&lt;</span>br <span class="sy0">/&gt;</span>
IP Address <span class="sy0">:</span> <span class="re4">&lt;b&gt;</span>x<span class="sy0">.</span>x<span class="sy0">.</span>x<span class="sy0">.</span>x<span class="sy0">&lt;/</span>b<span class="sy0">&gt;&lt;</span>br <span class="sy0">/&gt;</span>
Group ID<span class="sy0">:</span> <span class="re4">&lt;b&gt;</span>myconpany<span class="sy0">&lt;/</span>b<span class="sy0">&gt;&lt;</span>br <span class="sy0">/&gt;</span>
Group Password <span class="sy0">:</span> <span class="re4">&lt;b&gt;</span>myconpany_pass<span class="sy0">&lt;/</span>b<span class="sy0">&gt;&lt;</span>br <span class="sy0">/&gt;&lt;</span>br <span class="sy0">/&gt;</span>
You can download Cisco VPN Client on <span class="st0">&quot;S<span class="es0">\:</span><span class="es0">\\</span><span class="es0">\\</span>Software<span class="es0">\\</span>VPN client<span class="es0">\\</span>WIN<span class="es0">\&quot;</span>.&lt;br /&gt;&lt;br /&gt;
&lt;b&gt;Those informations are confidentials, please keep them safetly.&lt;/b&gt;&quot;</span>
<span class="sy0">&lt;/</span>body<span class="sy0">&gt;&lt;/</span>html<span class="sy0">&gt;</span>
END
                        <span class="sy0">-&gt;</span><span class="me1">EndPart</span><span class="br0">&#40;</span><span class="st0">&quot;multipart/alternative&quot;</span><span class="br0">&#41;</span>
                <span class="sy0">-&gt;</span><span class="me1">Close</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&#160;
                <span class="br0">&#40;</span><span class="kw2">new</span> Mail<span class="sy0">::</span><span class="me2">Sender</span><span class="br0">&#41;</span>
                <span class="sy0">-&gt;</span><span class="me1">OpenMultipart</span><span class="br0">&#40;</span><span class="br0">&#123;</span>
                        smtp <span class="sy0">=&gt;</span> <span class="st_h">'localhost'</span><span class="sy0">,</span>
                        from <span class="sy0">=&gt;</span> <span class="st0">&quot;admins<span class="es0">\@</span>$mail_fqdn&quot;</span><span class="sy0">,</span>
                        to <span class="sy0">=&gt;</span> <span class="st0">&quot;$tab_users[$user_pass_id]<span class="es0">\@</span>$mail_fqdn&quot;</span><span class="sy0">,</span>
                        subject <span class="sy0">=&gt;</span> <span class="st_h">'myconpany VPN Credentials'</span><span class="sy0">,</span>
                        multipart <span class="sy0">=&gt;</span> <span class="st_h">'mixed'</span><span class="sy0">,</span>
                <span class="br0">&#125;</span><span class="br0">&#41;</span>
                        <span class="sy0">-&gt;</span><span class="me1">Part</span><span class="br0">&#40;</span><span class="br0">&#123;</span>ctype <span class="sy0">=&gt;</span> <span class="st_h">'text/html'</span><span class="sy0">,</span> disposition <span class="sy0">=&gt;</span> <span class="st_h">'NONE'</span><span class="sy0">,</span> msg <span class="sy0">=&gt;</span> <span class="sy0">&lt;&lt;</span>END<span class="br0">&#125;</span><span class="br0">&#41;</span>
<span class="re4">&lt;html&gt;</span><span class="re4">&lt;body&gt;</span>
Your <span class="kw2">new</span> VPN password is <span class="sy0">:</span> <span class="re4">&lt;b&gt;</span><span class="re0">$tab_pass</span><span class="br0">&#91;</span><span class="re0">$user_pass_id</span><span class="br0">&#93;</span><span class="sy0">&lt;/</span>b<span class="sy0">&gt;&lt;</span>br <span class="sy0">/&gt;&lt;</span>br <span class="sy0">/&gt;</span>
<span class="re4">&lt;b&gt;</span>Those informations are confidentials<span class="sy0">,</span> please keep them safetly<span class="sy0">.&lt;/</span>b<span class="sy0">&gt;</span>
<span class="sy0">&lt;/</span>body<span class="sy0">&gt;&lt;/</span>html<span class="sy0">&gt;</span>
END
                        <span class="sy0">-&gt;</span><span class="me1">EndPart</span><span class="br0">&#40;</span><span class="st0">&quot;multipart/alternative&quot;</span><span class="br0">&#41;</span>
                <span class="sy0">-&gt;</span><span class="me1">Close</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="br0">&#125;</span> <span class="kw1">or</span> <span class="kw3">print</span> <span class="st0">&quot;Error sending mail: $Mail::Sender::Error<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&#160;
<span class="kw2">sub</span> send_users <span class="br0">&#123;</span>
    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$ARGV</span><span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="re0">$user_pass_id</span> <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span>
        <span class="re0">@tab_users</span> <span class="sy0">=</span> <span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="kw3">open</span> <span class="br0">&#40;</span>FILER<span class="sy0">,</span> <span class="st0">&quot;&lt;$radius_user_file&quot;</span><span class="br0">&#41;</span> <span class="sy0">||</span> <span class="kw3">die</span><span class="br0">&#40;</span><span class="st0">&quot;Can't open file&#160;: $!&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="co1"># If all, send credentials to everybody</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$ARGV</span><span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span> <span class="kw1">eq</span> <span class="st0">&quot;all&quot;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            	<span class="kw1">while</span> <span class="br0">&#40;</span><span class="re4">&lt;FILER&gt;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            		<span class="kw1">if</span> <span class="br0">&#40;</span><span class="co5">$_</span> <span class="sy0">=~</span> <span class="co2">/^(\w+).+Auth-Type.+&quot;(.+)&quot;/</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            			<span class="kw3">push</span> <span class="re0">@tab_users</span><span class="sy0">,</span> <span class="co3">$1</span><span class="sy0">;</span>
                        <span class="kw3">push</span> <span class="re0">@tab_pass</span><span class="sy0">,</span> <span class="co3">$2</span><span class="sy0">;</span>
                        <span class="re0">&amp;send_mail</span><span class="sy0">;</span>
                        <span class="re0">$user_pass_id</span><span class="sy0">++;</span>
            		<span class="br0">&#125;</span>
            	<span class="br0">&#125;</span>
        <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
            <span class="co1"># else only one user</span>
          	<span class="kw1">while</span> <span class="br0">&#40;</span><span class="re4">&lt;FILER&gt;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                <span class="kw1">if</span> <span class="br0">&#40;</span><span class="co5">$_</span> <span class="sy0">=~</span> <span class="co2">/^(\w+).+Auth-Type.+&quot;(.+)&quot;/</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="co3">$1</span> <span class="kw1">eq</span> <span class="re0">$ARGV</span><span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
           			    <span class="kw3">push</span> <span class="re0">@tab_users</span><span class="sy0">,</span> <span class="co3">$1</span><span class="sy0">;</span>
                        <span class="kw3">push</span> <span class="re0">@tab_pass</span><span class="sy0">,</span> <span class="co3">$2</span><span class="sy0">;</span>
                        <span class="re0">&amp;send_mail</span><span class="sy0">;</span>
                    <span class="br0">&#125;</span>
                <span class="br0">&#125;</span>
            <span class="br0">&#125;</span>
        <span class="br0">&#125;</span>
        <span class="kw3">close</span> <span class="br0">&#40;</span>FILER<span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
        <span class="re0">&amp;help</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span>
&#160;
<span class="kw2">sub</span> remind_users <span class="br0">&#123;</span>
        <span class="re0">$user_pass_id</span> <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span>
        <span class="re0">@tab_users</span> <span class="sy0">=</span> <span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="kw3">open</span> <span class="br0">&#40;</span>FILER<span class="sy0">,</span> <span class="st0">&quot;&lt;$radius_user_file&quot;</span><span class="br0">&#41;</span> <span class="sy0">||</span> <span class="kw3">die</span><span class="br0">&#40;</span><span class="st0">&quot;Can't open file&#160;: $!&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
       	<span class="kw1">while</span> <span class="br0">&#40;</span><span class="re4">&lt;FILER&gt;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="kw1">if</span> <span class="br0">&#40;</span><span class="co5">$_</span> <span class="sy0">=~</span> <span class="co2">/^(\w+).+Auth-Type.+&quot;.+&quot;/</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                <span class="kw3">eval</span> <span class="br0">&#123;</span>
                    <span class="br0">&#40;</span><span class="kw2">new</span> Mail<span class="sy0">::</span><span class="me2">Sender</span><span class="br0">&#41;</span>
                    <span class="sy0">-&gt;</span><span class="me1">OpenMultipart</span><span class="br0">&#40;</span><span class="br0">&#123;</span>
                            smtp <span class="sy0">=&gt;</span> <span class="st_h">'localhost'</span><span class="sy0">,</span>
                            from <span class="sy0">=&gt;</span> <span class="st0">&quot;admins<span class="es0">\@</span>$mail_fqdn&quot;</span><span class="sy0">,</span>
                            to <span class="sy0">=&gt;</span> <span class="st0">&quot;$1<span class="es0">\@</span>$mail_fqdn&quot;</span><span class="sy0">,</span>
                            subject <span class="sy0">=&gt;</span> <span class="st_h">'2 Days before VPN password changing'</span><span class="sy0">,</span>
                            multipart <span class="sy0">=&gt;</span> <span class="st_h">'mixed'</span><span class="sy0">,</span>
                    <span class="br0">&#125;</span><span class="br0">&#41;</span>
                            <span class="sy0">-&gt;</span><span class="me1">Part</span><span class="br0">&#40;</span><span class="br0">&#123;</span>ctype <span class="sy0">=&gt;</span> <span class="st_h">'text/html'</span><span class="sy0">,</span> disposition <span class="sy0">=&gt;</span> <span class="st_h">'NONE'</span><span class="sy0">,</span> msg <span class="sy0">=&gt;</span> <span class="sy0">&lt;&lt;</span>END<span class="br0">&#125;</span><span class="br0">&#41;</span>
<span class="re4">&lt;html&gt;</span><span class="re4">&lt;body&gt;</span>
<span class="re4">&lt;b&gt;</span>Remember your VPN is about to change in <span class="nu0">2</span> days<span class="sy0">.&lt;/</span>b<span class="sy0">&gt;</span>
<span class="sy0">&lt;</span>br <span class="sy0">/&gt;&lt;</span>br <span class="sy0">/&gt;</span>
Your <span class="kw2">new</span> credentials sent in a previous mail will take effect<span class="sy0">.</span>
<span class="sy0">&lt;/</span>body<span class="sy0">&gt;&lt;/</span>html<span class="sy0">&gt;</span>
END
                    <span class="sy0">-&gt;</span><span class="me1">EndPart</span><span class="br0">&#40;</span><span class="st0">&quot;multipart/alternative&quot;</span><span class="br0">&#41;</span>
                <span class="sy0">-&gt;</span><span class="me1">Close</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
            <span class="br0">&#125;</span> <span class="kw1">or</span> <span class="kw3">print</span> <span class="st0">&quot;Error sending mail: $Mail::Sender::Error<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span>
&#160;
<span class="kw2">sub</span> syncro_nodes <span class="br0">&#123;</span>
    <span class="kw3">system</span> <span class="st0">&quot;/etc/init.d/freeradius&quot;</span><span class="sy0">,</span> <span class="st0">&quot;restart&quot;</span><span class="sy0">;</span>
    <span class="kw1">foreach</span> <span class="re0">$node</span> <span class="br0">&#40;</span><span class="re0">@radius_nodes</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="co1"># Transfer files</span>
        <span class="re0">$scp</span> <span class="sy0">=</span> Net<span class="sy0">::</span><span class="me2">SCP</span><span class="sy0">-&gt;</span><span class="kw2">new</span><span class="br0">&#40;</span><span class="st0">&quot;$node&quot;</span><span class="sy0">,</span> <span class="st0">&quot;root&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="co1"># Choose remote directory</span>
        <span class="re0">$scp</span><span class="sy0">-&gt;</span><span class="me1">cwd</span><span class="br0">&#40;</span><span class="st0">&quot;/etc/freeradius&quot;</span><span class="br0">&#41;</span> <span class="kw1">or</span> <span class="kw3">die</span> <span class="re0">$scp</span><span class="sy0">-&gt;</span><span class="br0">&#123;</span>errstr<span class="br0">&#125;</span><span class="sy0">;</span>
        <span class="co1"># Upload file</span>
        <span class="re0">$scp</span><span class="sy0">-&gt;</span><span class="me1">put</span><span class="br0">&#40;</span><span class="st0">&quot;$radius_user_file&quot;</span><span class="br0">&#41;</span> <span class="kw1">or</span> <span class="kw3">die</span> <span class="re0">$scp</span><span class="sy0">-&gt;</span><span class="br0">&#123;</span>errstr<span class="br0">&#125;</span><span class="sy0">;</span>
        <span class="co1"># Restart SSH</span>
        ssh<span class="br0">&#40;</span><span class="st0">&quot;root<span class="es0">\@</span>$node&quot;</span><span class="sy0">,</span> <span class="st0">&quot;/etc/init.d/freeradius&quot;</span><span class="sy0">,</span> <span class="st0">&quot;restart&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span>
&#160;
<span class="co1">## Starting</span>
&#160;
<span class="co1"># Starting first arg check</span>
<span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$ARGV</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span> <span class="kw1">eq</span> <span class="st0">&quot;generate&quot;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="re0">&amp;count_stock_users</span><span class="sy0">;</span>
    <span class="re0">&amp;genpass</span><span class="sy0">;</span>
    <span class="re0">&amp;gen_file</span><span class="sy0">;</span>
<span class="br0">&#125;</span> <span class="kw1">elsif</span> <span class="br0">&#40;</span><span class="re0">$ARGV</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span> <span class="kw1">eq</span> <span class="st0">&quot;list&quot;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="re0">&amp;listing</span><span class="sy0">;</span>
<span class="br0">&#125;</span> <span class="kw1">elsif</span> <span class="br0">&#40;</span><span class="re0">$ARGV</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span> <span class="kw1">eq</span> <span class="st0">&quot;switch&quot;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
    move<span class="br0">&#40;</span><span class="st0">&quot;$radius_user_file_new&quot;</span><span class="sy0">,</span><span class="st0">&quot;$radius_user_file&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="re0">&amp;syncro_nodes</span><span class="sy0">;</span>
<span class="br0">&#125;</span> <span class="kw1">elsif</span> <span class="br0">&#40;</span><span class="re0">$ARGV</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span> <span class="kw1">eq</span> <span class="st0">&quot;create&quot;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="re0">&amp;create_user</span><span class="sy0">;</span>
    <span class="re0">&amp;send_mail</span><span class="sy0">;</span>
    <span class="re0">&amp;syncro_nodes</span><span class="sy0">;</span>
<span class="br0">&#125;</span> <span class="kw1">elsif</span> <span class="br0">&#40;</span><span class="re0">$ARGV</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span> <span class="kw1">eq</span> <span class="st0">&quot;delete&quot;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="re0">&amp;delete_user</span><span class="sy0">;</span>
    <span class="re0">&amp;syncro_nodes</span><span class="sy0">;</span>
<span class="br0">&#125;</span> <span class="kw1">elsif</span> <span class="br0">&#40;</span><span class="re0">$ARGV</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span> <span class="kw1">eq</span> <span class="st0">&quot;replicate&quot;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="re0">&amp;syncro_nodes</span><span class="sy0">;</span>
<span class="br0">&#125;</span> <span class="kw1">elsif</span> <span class="br0">&#40;</span><span class="re0">$ARGV</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span> <span class="kw1">eq</span> <span class="st0">&quot;send&quot;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="re0">&amp;send_users</span><span class="sy0">;</span>
<span class="br0">&#125;</span> <span class="kw1">elsif</span> <span class="br0">&#40;</span><span class="re0">$ARGV</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span> <span class="kw1">eq</span> <span class="st0">&quot;reminder&quot;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="re0">&amp;remind_users</span><span class="sy0">;</span>
<span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
    <span class="re0">&amp;help</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&#160;
<span class="kw2">__END__</span></pre></div></div>
</td></tr></table><br />
<h1><span class="mw-headline" id="Logs_GC_Analyzer"><span class="mw-headline-number">6</span> Logs GC Analyzer</span></h1>
<p>Voici un petit script qui permet de surveiller les logs gc ainsi que d'être prévenu après un certain pourcentage de dépassement. Il prévient également si un Full GC a lieu&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> gc_analyzer.pl</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="perl source-perl"><pre class="de1"><span class="co1">#!/usr/bin/perl -w</span>
<span class="co1">## GC Analyzer tool v0.1 ##</span>
<span class="co1">## Made by Pierre Mavro ##</span>
&#160;
<span class="co1">## DEPENDANCIES ##</span>
<span class="co1"># To make this script working, you need&#160;:</span>
<span class="co1"># - Mail::Sender perl module</span>
&#160;
<span class="kw2">use</span> strict<span class="sy0">;</span>
<span class="kw2">use</span> Mail<span class="sy0">::</span><span class="me2">Sender</span><span class="sy0">;</span>
&#160;
<span class="co1">## Vars ##</span>
<span class="co1"># Global vars</span>
<span class="kw1">my</span> <span class="re0">$product</span><span class="sy0">=</span><span class="st0">&quot;Confluence&quot;</span><span class="sy0">;</span> <span class="co1"># Give the product name</span>
&#160;
<span class="co1"># Mails parameters</span>
<span class="kw1">my</span> <span class="re0">$mail_smtp_server</span><span class="sy0">=</span><span class="st0">&quot;localhost&quot;</span><span class="sy0">;</span> <span class="co1"># Set the ip or mail name server</span>
<span class="kw1">my</span> <span class="re0">$mail_user_from</span><span class="sy0">=</span><span class="st0">&quot;admin&quot;</span><span class="sy0">;</span> <span class="co1"># Set the mail sender name</span>
<span class="kw1">my</span> <span class="re0">$mail_user_to</span><span class="sy0">=</span><span class="st0">&quot;admin&quot;</span><span class="sy0">;</span> <span class="co1"># Set the mail receiver name</span>
<span class="kw1">my</span> <span class="re0">$mail_fqdn</span><span class="sy0">=</span><span class="st0">&quot;company.com&quot;</span><span class="sy0">;</span> <span class="co1"># Set the FQDN for incomming mails (eg. user@</span>
&#160;
<span class="co1"># Others vars</span>
<span class="kw1">my</span> <span class="re0">$log_gc_file</span><span class="sy0">=</span><span class="re0">$ARGV</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span><span class="sy0">;</span>
<span class="kw1">my</span> <span class="re0">$percent_gc_warn</span><span class="sy0">=</span><span class="re0">$ARGV</span><span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span><span class="sy0">;</span>
<span class="kw1">my</span> <span class="re0">$total_curr_gc</span><span class="sy0">;</span>
<span class="kw1">my</span> <span class="re0">$percent_gc</span><span class="sy0">;</span>
<span class="kw1">my</span> <span class="re0">$mail_subject</span><span class="sy0">;</span>
<span class="kw1">my</span> <span class="re0">$problem_line</span><span class="sy0">;</span>
<span class="kw1">my</span> <span class="re0">$mail_status</span><span class="sy0">;</span>
<span class="kw1">my</span> <span class="re0">$curpos</span><span class="sy0">;</span>
&#160;
<span class="co1"># Verifications</span>
<span class="re0">&amp;help</span> <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">@</span><span class="kw2">ARGV</span> <span class="sy0">&lt;</span> <span class="nu0">2</span><span class="br0">&#41;</span><span class="sy0">;</span>
&#160;
<span class="co1">### Starting Analyze ###</span>
&#160;
<span class="co1">## Funtions ##</span>
&#160;
<span class="co1"># Help</span>
<span class="kw2">sub</span> help <span class="br0">&#123;</span>
    <span class="kw3">print</span> <span class="st0">&quot;USAGE: gc_analyzer.pl [LOG GC File] [Percent for warning]<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
    <span class="kw3">print</span> <span class="st0">&quot;<span class="es0">\t</span>- eg: gc_analyzer.pl /home/pmavro/loggc 20<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
    <span class="kw3">print</span> <span class="st0">&quot;<span class="es0">\t</span>- help&#160;: print this page<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
    <span class="kw3">exit</span> <span class="br0">&#40;</span><span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&#160;
<span class="co1"># Send mail</span>
<span class="kw2">sub</span> send_mail <span class="br0">&#123;</span>
    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$mail_status</span> <span class="kw1">eq</span> <span class="st0">&quot;warning&quot;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="re0">$mail_subject</span><span class="sy0">=</span><span class="st0">&quot;WARNING ($product)&#160;: $percent_gc_warn% of GC memory has been reached&#160;!&quot;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span> <span class="kw1">elsif</span> <span class="br0">&#40;</span><span class="re0">$mail_status</span> <span class="kw1">eq</span> <span class="st0">&quot;critical&quot;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="re0">$mail_subject</span><span class="sy0">=</span><span class="st0">&quot;CRITICAL ($product)&#160;: A Full has proceed&quot;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
        <span class="kw3">eval</span> <span class="br0">&#123;</span>
                <span class="br0">&#40;</span><span class="kw2">new</span> Mail<span class="sy0">::</span><span class="me2">Sender</span><span class="br0">&#41;</span>
                <span class="sy0">-&gt;</span><span class="me1">OpenMultipart</span><span class="br0">&#40;</span><span class="br0">&#123;</span>
                        smtp <span class="sy0">=&gt;</span> <span class="st0">&quot;$mail_smtp_server&quot;</span><span class="sy0">,</span>
                        from <span class="sy0">=&gt;</span> <span class="st0">&quot;$mail_user_from<span class="es0">\@</span>$mail_fqdn&quot;</span><span class="sy0">,</span>
                        to <span class="sy0">=&gt;</span> <span class="st0">&quot;$mail_user_to<span class="es0">\@</span>$mail_fqdn&quot;</span><span class="sy0">,</span>
                        subject <span class="sy0">=&gt;</span> <span class="st0">&quot;$mail_subject&quot;</span><span class="sy0">,</span>
                        multipart <span class="sy0">=&gt;</span> <span class="st_h">'mixed'</span><span class="sy0">,</span>
                <span class="br0">&#125;</span><span class="br0">&#41;</span>
                        <span class="sy0">-&gt;</span><span class="me1">Part</span><span class="br0">&#40;</span><span class="br0">&#123;</span>ctype <span class="sy0">=&gt;</span> <span class="st_h">'text/html'</span><span class="sy0">,</span> disposition <span class="sy0">=&gt;</span> <span class="st_h">'NONE'</span><span class="sy0">,</span> msg <span class="sy0">=&gt;</span> <span class="sy0">&lt;&lt;</span>END<span class="br0">&#125;</span><span class="br0">&#41;</span>
<span class="re4">&lt;html&gt;</span><span class="re4">&lt;body&gt;</span>
This line has been extracted from LOG GC file <span class="br0">&#40;</span><span class="re0">$log_gc_file</span><span class="br0">&#41;</span> on <span class="re0">$product</span> product <span class="sy0">:&lt;</span>br <span class="sy0">/&gt;&lt;</span>br <span class="sy0">/&gt;</span>
<span class="re0">$problem_line</span>
<span class="sy0">&lt;/</span>body<span class="sy0">&gt;&lt;/</span>html<span class="sy0">&gt;</span>
END
                        <span class="sy0">-&gt;</span><span class="me1">EndPart</span><span class="br0">&#40;</span><span class="st0">&quot;multipart/alternative&quot;</span><span class="br0">&#41;</span>
                <span class="sy0">-&gt;</span><span class="me1">Close</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="br0">&#125;</span> <span class="kw1">or</span> <span class="kw3">print</span> <span class="st0">&quot;Error sending mail: $Mail::Sender::Error<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&#160;
<span class="kw3">open</span> GCFILE<span class="sy0">,</span> <span class="st0">&quot;&lt;$log_gc_file&quot;</span> <span class="kw1">or</span> <span class="kw3">die</span> <span class="st0">&quot;Sorry but the file wasn't found<span class="es0">\n</span>&#160;: $!&quot;</span><span class="sy0">;</span>
&#160;
<span class="co1"># Watchdog on the file</span>
<span class="kw3">seek</span><span class="br0">&#40;</span>GCFILE<span class="sy0">,</span> <span class="nu0">0</span><span class="sy0">,</span> <span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="kw1">for</span> <span class="br0">&#40;</span><span class="sy0">;;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="kw1">for</span> <span class="br0">&#40;</span><span class="re0">$curpos</span> <span class="sy0">=</span> <span class="kw3">tell</span><span class="br0">&#40;</span>GCFILE<span class="br0">&#41;</span><span class="sy0">;</span> <span class="re4">&lt;GCFILE&gt;</span><span class="sy0">;</span> <span class="re0">$curpos</span> <span class="sy0">=</span> <span class="kw3">tell</span><span class="br0">&#40;</span>GCFILE<span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw3">chomp</span> <span class="co5">$_</span><span class="sy0">;</span>
        <span class="re0">$problem_line</span><span class="sy0">=</span><span class="co5">$_</span><span class="sy0">;</span>
        <span class="co1"># If a Full GC is detected</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span><span class="co5">$_</span> <span class="sy0">=~</span> <span class="co2">/.*Full GC.*/</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="re0">$mail_status</span><span class="sy0">=</span><span class="st0">&quot;critical&quot;</span><span class="sy0">;</span>
            <span class="re0">&amp;send_mail</span><span class="sy0">;</span>
        <span class="co1"># If GC, percentage should be calculated</span>
        <span class="br0">&#125;</span> <span class="kw1">elsif</span> <span class="br0">&#40;</span><span class="co5">$_</span> <span class="sy0">=~</span> <span class="co2">/.+\[GC (\d+)K-&gt;(\d+)K\((\d+)K\).+/</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="co1"># Prepare for calcul</span>
            <span class="re0">$total_curr_gc</span><span class="sy0">=</span><span class="co3">$2</span><span class="sy0">;</span>
            <span class="re0">$percent_gc</span><span class="sy0">=</span><span class="br0">&#40;</span><span class="co3">$3</span><span class="re0">*$percent_gc_warn</span><span class="br0">&#41;</span><span class="sy0">/</span><span class="nu0">100</span><span class="sy0">;</span>
            <span class="co1"># Check the percentage before Full GC</span>
            <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$total_curr_gc</span> <span class="kw1">ge</span> <span class="re0">$percent_gc</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                <span class="re0">$mail_status</span><span class="sy0">=</span><span class="st0">&quot;warning&quot;</span><span class="sy0">;</span>
                <span class="re0">&amp;send_mail</span><span class="sy0">;</span>
            <span class="br0">&#125;</span>
        <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
            <span class="kw3">print</span> <span class="st0">&quot;Unknow line&#160;: $_<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
    <span class="br0">&#125;</span>
    <span class="kw3">sleep</span><span class="br0">&#40;</span><span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="kw3">seek</span><span class="br0">&#40;</span>GCFILE<span class="sy0">,</span> <span class="re0">$curpos</span><span class="sy0">,</span> <span class="nu0">0</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&#160;
<span class="kw3">close</span> <span class="br0">&#40;</span><span class="re0">$log_gc_file</span><span class="br0">&#41;</span><span class="sy0">;</span></pre></div></div>
</td></tr></table><br />
<h1><span class="mw-headline" id="Multithreader_un_hash_MD5"><span class="mw-headline-number">7</span> Multithreader un hash MD5</span></h1>
<p>Voilà un exemple simple qui peut servir de base à un script multi threadé. Il calcule le hash md5 d'une liste de fichiers, ce qui est plutôt con, mais c'est à vous d'imaginer le traitement à effectuer.
</p><p>Ce qui est intéressant, c'est&#160;:
</p>
<ul><li> Le lancement des threads</li>
<li> Les threads qui lockent le tableau, en enlèvent un élément, puis le libèrent</li>
<li> L'arrêt des threads</li></ul>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> gc_analyzer.pl</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="perl source-perl"><pre class="de1"><span class="co1">#!/usr/bin/perl</span>
&#160;
<span class="kw2">use</span> strict<span class="sy0">;</span>
<span class="kw2">use</span> warnings<span class="sy0">;</span>
<span class="kw2">use</span> threads<span class="sy0">;</span>
<span class="kw2">use</span> threads<span class="sy0">::</span><span class="me2">shared</span><span class="sy0">;</span>
<span class="kw2">use</span> Digest<span class="sy0">::</span><span class="me2">MD5</span><span class="sy0">;</span>
&#160;
<span class="kw1">our</span> <span class="re0">$VERSION</span> <span class="sy0">=</span> <span class="nu0">1.0</span><span class="sy0">;</span>
<span class="kw1">our</span> <span class="re0">$SLASH</span> <span class="sy0">=</span> <span class="kw3">q</span><span class="br0">&#123;</span><span class="sy0">/</span><span class="br0">&#125;</span><span class="sy0">;</span>
&#160;
<span class="co1"># Getting command line arguments</span>
<span class="kw1">my</span> <span class="re0">@arguments</span> <span class="sy0">=</span> <span class="sy0">@</span><span class="kw2">ARGV</span><span class="sy0">;</span>
<span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$arguments</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
    usage <span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
<span class="kw1">my</span> <span class="re0">$directory</span> <span class="sy0">=</span> <span class="re0">$arguments</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span><span class="sy0">;</span>
<span class="kw1">my</span> <span class="re0">$max_threads</span> <span class="sy0">=</span> <span class="nu0">2</span><span class="sy0">;</span>
<span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$arguments</span><span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span> <span class="sy0">&amp;&amp;</span> <span class="re0">$arguments</span><span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span> <span class="sy0">=~</span> <span class="co2">/^\d{1,2}$/xm</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
    <span class="re0">$max_threads</span> <span class="sy0">=</span> <span class="re0">$arguments</span><span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&#160;
<span class="co1"># Getting regular files in the directory</span>
<span class="kw1">my</span> <span class="re0">$DIR</span><span class="sy0">;</span>
<span class="kw3">opendir</span> <span class="re0">$DIR</span> <span class="sy0">,</span> <span class="re0">$directory</span> <span class="kw1">or</span> <span class="kw3">die</span> <span class="st0">&quot;unable to opendir: $!<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
<span class="kw1">my</span> <span class="re0">@files</span> <span class="sy0">=</span> <span class="kw3">grep</span> <span class="br0">&#123;</span> <span class="sy0">-</span>f <span class="st0">&quot;$directory/$_&quot;</span> <span class="br0">&#125;</span> <span class="kw3">readdir</span> <span class="re0">$DIR</span> <span class="kw1">or</span> <span class="kw3">die</span> <span class="st0">&quot;unable to readdir: $!<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
<span class="kw3">closedir</span> <span class="re0">$DIR</span> <span class="kw1">or</span> <span class="kw3">die</span> <span class="st0">&quot;unable to closedir: $!<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
<span class="kw1">my</span> <span class="re0">@tableau</span> <span class="sy0">:</span> shared <span class="sy0">=</span> <span class="kw3">sort</span> <span class="re0">@files</span><span class="sy0">;</span>
&#160;
<span class="co1"># Launching threads</span>
<span class="kw1">my</span> <span class="re0">@threads</span><span class="sy0">;</span>
<span class="kw1">for</span> <span class="br0">&#40;</span><span class="nu0">1</span> <span class="sy0">..</span> <span class="re0">$max_threads</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
    <span class="kw1">my</span> <span class="re0">$thread</span> <span class="sy0">=</span> threads<span class="sy0">-&gt;</span><span class="me1">create</span> <span class="br0">&#40;</span><span class="st_h">'thread_code'</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="kw3">push</span> <span class="re0">@threads</span> <span class="sy0">,</span> <span class="re0">$thread</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&#160;
<span class="co1"># Waiting for the threads to finish</span>
<span class="kw1">while</span> <span class="br0">&#40;</span><span class="re0">@threads</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
    <span class="kw1">my</span> <span class="re0">$thread</span> <span class="sy0">=</span> <span class="kw3">shift</span> <span class="re0">@threads</span><span class="sy0">;</span>
    <span class="re0">$thread</span><span class="sy0">-&gt;</span><span class="kw3">join</span> <span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
<span class="kw3">print</span> <span class="st0">&quot;fini<span class="es0">\n</span>&quot;</span> <span class="kw1">or</span> <span class="kw3">die</span> <span class="st0">&quot;unable to print: $!<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
<span class="kw3">exit</span> <span class="nu0">0</span><span class="sy0">;</span>
&#160;
&#160;
<span class="co1">##################################</span>
&#160;
&#160;
<span class="kw2">sub</span> thread_code
<span class="br0">&#123;</span>
    BOUCLE <span class="sy0">:</span> <span class="kw1">while</span> <span class="br0">&#40;</span><span class="nu0">1</span><span class="br0">&#41;</span>
    <span class="br0">&#123;</span>
	<span class="kw1">my</span> <span class="re0">$element</span><span class="sy0">;</span>
	<span class="br0">&#123;</span>
	    <span class="co1"># In this block, we only manage the shared array</span>
	    <span class="co1"># We don't want it to be locked for too long</span>
	    lock <span class="re0">@tableau</span><span class="sy0">;</span>
	    <span class="re0">$element</span> <span class="sy0">=</span> <span class="kw3">shift</span> <span class="re0">@tableau</span><span class="sy0">;</span>
	    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$element</span><span class="br0">&#41;</span>
	    <span class="br0">&#123;</span>
		<span class="kw1">last</span> BOUCLE<span class="sy0">;</span>
	    <span class="br0">&#125;</span>
	    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$element</span> <span class="sy0">=~</span> <span class="co2">/^\.{1,2}$/xm</span><span class="br0">&#41;</span>
	    <span class="br0">&#123;</span>
		<span class="kw1">next</span> BOUCLE<span class="sy0">;</span>
	    <span class="br0">&#125;</span>
	<span class="br0">&#125;</span>
&#160;
	<span class="co1"># We calculate the md5sum of the file, and we display it</span>
	<span class="kw1">my</span> <span class="re0">$ctx</span> <span class="sy0">=</span> Digest<span class="sy0">::</span><span class="me2">MD5</span><span class="sy0">-&gt;</span><span class="kw2">new</span><span class="sy0">;</span>
	<span class="kw1">my</span> <span class="re0">$FILE</span><span class="sy0">;</span>
	<span class="kw3">open</span> <span class="re0">$FILE</span> <span class="sy0">,</span> <span class="st_h">'&lt;'</span> <span class="sy0">,</span> <span class="re0">$directory</span><span class="sy0">.</span><span class="re0">$SLASH</span><span class="sy0">.</span><span class="re0">$element</span> <span class="kw1">or</span> <span class="kw1">next</span> BOUCLE<span class="sy0">;</span>
	<span class="re0">$ctx</span><span class="sy0">-&gt;</span><span class="me1">addfile</span> <span class="br0">&#40;</span><span class="re0">$FILE</span><span class="br0">&#41;</span><span class="sy0">;</span>
	<span class="kw3">close</span> <span class="re0">$FILE</span> <span class="kw1">or</span> <span class="kw1">next</span> BOUCLE<span class="sy0">;</span>
	<span class="kw1">my</span> <span class="re0">$digest</span> <span class="sy0">=</span> <span class="re0">$ctx</span><span class="sy0">-&gt;</span><span class="me1">hexdigest</span><span class="sy0">;</span>
	<span class="kw3">print</span> threads<span class="sy0">-&gt;</span><span class="me1">self</span><span class="sy0">-&gt;</span><span class="me1">tid</span> <span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="sy0">.</span> <span class="st0">&quot;&#160;: $element -&gt; $digest<span class="es0">\n</span>&quot;</span> <span class="kw1">or</span> <span class="kw1">next</span> BOUCLE<span class="sy0">;</span>
    <span class="br0">&#125;</span>
    <span class="kw3">return</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&#160;
<span class="kw2">sub</span> usage
<span class="br0">&#123;</span>
    <span class="kw3">print</span> <span class="sy0">&lt;&lt;</span><span class="st0">&quot;EOM&quot;</span> <span class="kw1">or</span> <span class="kw3">die</span> <span class="st0">&quot;unable to print: $!<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
Usage<span class="sy0">:</span> <span class="co3">$0</span> directory <span class="br0">&#91;</span>max_threads<span class="br0">&#93;</span>
<span class="re0">\tdirectory</span><span class="sy0">:</span> the directory you want to scan<span class="sy0">.</span>
<span class="re0">\tmax_threads</span><span class="sy0">:</span> the maximum number of threads you vant to run <span class="br0">&#40;</span><span class="nu0">1</span> <span class="sy0">..</span> <span class="nu0">99</span><span class="br0">&#41;</span><span class="sy0">.</span> Defaults to <span class="nu0">2</span><span class="sy0">.</span>
EOM
    <span class="kw3">exit</span> <span class="nu0">1</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />
<p><i>Merci à l'équipe GCU Squad pour ce script</i>
</p>
<h1><span class="mw-headline" id="Script_Cluster_SUN_pour_applications_Java"><span class="mw-headline-number">8</span> Script Cluster SUN pour applications Java</span></h1>
<p>Pour mon boulot, j'ai eu besoin de créer ce genre de script. Je ne vais pas rentrer dans les détails, mais il gère de façon optimisée les applications Java dépourvue de fonction cluster&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> gc_analyzer.pl</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="perl source-perl"><pre class="de1"><span class="co1">#!/usr/bin/perl -w</span>
&#160;
<span class="co1"># Copyright (c) 2008 by mycompany, Inc.  All rights reserved.</span>
<span class="co1"># Use is subject to license terms.</span>
&#160;
<span class="co1"># Sun Cluster Script v1.3</span>
&#160;
<span class="co1"># Pierre Mavro @ mycompany</span>
<span class="co1"># Last modification&#160;: 27/01/2009 11:45</span>
&#160;
<span class="co1"># Supported Sun Solaris cluster Versions&#160;:</span>
<span class="co1"># 3.0, 3.1, 3.2</span>
&#160;
<span class="co1">###################################</span>
<span class="co1">#  How to use Sun Cluster script  #</span>
<span class="co1">###################################</span>
&#160;
<span class="co1"># Requierements&#160;:</span>
<span class="co1"># - Syslog server on localhost (on each nodes)</span>
<span class="co1"># - Perl 5.8 or newer should be installed on the server</span>
<span class="co1"># - Perl Module Unix::Syslog (use cpan to install it and Sun Studio Express to compile with cc)</span>
&#160;
<span class="co1"># To configure the SUN Cluster mycompany Service, you'll need to add this in the configuration&#160;:</span>
<span class="co1"># - Start &#160;: PATH_OF_THE_SCRIPT start</span>
<span class="co1"># - Stop  &#160;: PATH_OF_THE_SCRIPT stop</span>
<span class="co1"># - Status&#160;: PATH_OF_THE_SCRIPT status</span>
&#160;
<span class="co1"># To configure this script, edit the User section.</span>
<span class="co1"># If you need advanced functions, edit the advanced user section (by default you needn't)</span>
&#160;
<span class="co1">###########</span>
<span class="co1"># History #</span>
<span class="co1">###########</span>
&#160;
<span class="co1">#  Version 1.3&#160;:</span>
<span class="co1"># + Add changing files and folders owner while starting</span>
<span class="co1"># + More logs on File Handle</span>
<span class="co1"># + Deny script execution instead of root</span>
<span class="co1"># + Configuration File read in config file optimization</span>
<span class="co1"># = Optimization on port verification</span>
<span class="co1"># = Optimization on PID check</span>
<span class="co1"># = Configuration File optimization</span>
&#160;
<span class="co1"># Version 1.2&#160;:</span>
<span class="co1"># + Add configuration file</span>
<span class="co1"># + Add Solaris package installation</span>
&#160;
<span class="co1"># Version 1.1&#160;:</span>
<span class="co1"># + Add check installation and configuration</span>
<span class="co1"># = Bug when starting with no integration, when PID file was present</span>
&#160;
<span class="co1"># Version 1.0&#160;:</span>
<span class="co1"># + start / stop /status script</span>
&#160;
<span class="co1">########################################################################</span>
<span class="co1">########################################################################</span>
&#160;
<span class="co1">##################################</span>
<span class="co1">#   DO NOT MODIFY THIS SECTION   #</span>
<span class="co1">##################################</span>
&#160;
<span class="co1">#### Load Perl Librairies ####</span>
<span class="kw2">use</span> strict<span class="sy0">;</span>
<span class="kw2">use</span> POSIX <span class="kw3">qw</span><span class="br0">&#40;</span>strftime<span class="br0">&#41;</span><span class="sy0">;</span>
<span class="kw2">use</span> Socket<span class="sy0">;</span>
<span class="kw2">use</span> Unix<span class="sy0">::</span><span class="me2">Syslog</span> <span class="kw3">qw</span><span class="br0">&#40;</span><span class="sy0">:</span>subs <span class="sy0">:</span>macros<span class="br0">&#41;</span><span class="sy0">;</span>
&#160;
<span class="co1">#### Verifications ####</span>
<span class="co1"># Exit if's not root user</span>
<span class="kw1">if</span> <span class="br0">&#40;</span><span class="br0">&#40;</span><span class="kw3">defined</span> <span class="re0">$ENV</span><span class="br0">&#123;</span><span class="st_h">'LOGNAME'</span><span class="br0">&#125;</span><span class="br0">&#41;</span> <span class="kw1">and</span> <span class="br0">&#40;</span><span class="re0">$ENV</span><span class="br0">&#123;</span><span class="st_h">'LOGNAME'</span><span class="br0">&#125;</span> <span class="kw1">ne</span> <span class="st_h">'root'</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="kw3">print</span> <span class="st0">&quot;Sorry, can't execute this command. Please log in as root and try again<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
    <span class="kw3">exit</span> <span class="nu0">1</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&#160;
<span class="co1"># Exit if no one arg is defined</span>
<span class="re0">&amp;help</span> <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">@</span><span class="kw2">ARGV</span> <span class="kw1">ne</span> <span class="nu0">2</span><span class="br0">&#41;</span><span class="sy0">;</span>
&#160;
<span class="co1">#### Declare Global Vars ####</span>
<span class="kw1">my</span> <span class="re0">$cluster_version</span><span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span>
<span class="kw1">my</span> <span class="re0">$current_mode</span><span class="sy0">;</span>
&#160;
<span class="co1">### from/to coef file</span>
<span class="kw1">my</span> <span class="re0">$coefprop_value</span><span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span>
<span class="kw1">my</span> <span class="re0">$database_size</span><span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span>
<span class="kw1">my</span> <span class="re0">$process_time_start</span><span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span>
<span class="kw1">my</span> <span class="re0">$process_started</span><span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span>
&#160;
<span class="co1"># Read config file</span>
<span class="kw1">my</span> <span class="re0">%config</span><span class="sy0">;</span>
<span class="kw1">my</span> <span class="re0">$config_file_temp</span><span class="sy0">=</span><span class="st0">&quot;/tmp/$ARGV[1]<span class="es0">\.</span>cfg&quot;</span><span class="sy0">;</span>
<span class="re0">&amp;read_config_file</span><span class="sy0">;</span>
&#160;
<span class="co1"># Others default vars</span>
<span class="re0">$config</span><span class="br0">&#123;</span>japp<span class="br0">&#125;</span><span class="sy0">=</span><span class="st0">&quot;$config{ulapp_path}/lib/$config{jarname}&quot;</span><span class="sy0">;</span>
<span class="re0">$config</span><span class="br0">&#123;</span>uldatabase_path<span class="br0">&#125;</span><span class="sy0">=</span><span class="st0">&quot;$config{ulapp_path}/data&quot;</span><span class="sy0">;</span>
<span class="re0">$config</span><span class="br0">&#123;</span>jbinary_path<span class="br0">&#125;</span><span class="sy0">=</span><span class="st0">&quot;$config{ulapp_path}/bin&quot;</span><span class="sy0">;</span>
<span class="re0">$config</span><span class="br0">&#123;</span>jstartup_script<span class="br0">&#125;</span><span class="sy0">=</span><span class="st0">&quot;$config{jbinary_path}/start.sh&quot;</span><span class="sy0">;</span>
<span class="re0">$config</span><span class="br0">&#123;</span>jstop_script<span class="br0">&#125;</span><span class="sy0">=</span><span class="st0">&quot;$config{jbinary_path}/stop.sh&quot;</span><span class="sy0">;</span>
<span class="re0">$config</span><span class="br0">&#123;</span>jpid_file<span class="br0">&#125;</span><span class="sy0">=</span><span class="st0">&quot;$config{jbinary_path}/pid&quot;</span><span class="sy0">;</span>
<span class="re0">$config</span><span class="br0">&#123;</span>coefprop_file<span class="br0">&#125;</span><span class="sy0">=</span><span class="st0">&quot;$config{ulapp_path}/coefprop&quot;</span><span class="sy0">;</span>
&#160;
<span class="kw1">my</span> <span class="re0">$ulapp_pid</span><span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span>
<span class="kw1">my</span> <span class="re0">$cluster_file_version</span><span class="sy0">=</span><span class="st0">&quot;/etc/cluster/release&quot;</span><span class="sy0">;</span>
<span class="kw1">my</span> <span class="re0">$get_date_formated</span><span class="sy0">;</span>
<span class="kw1">my</span> <span class="re0">$set_start_timeout_to_cluster</span><span class="sy0">;</span>
<span class="kw1">my</span> <span class="re0">$lock_start_file</span><span class="sy0">=</span><span class="st0">&quot;/tmp/lock_$config{client_name}<span class="es0">\_</span>$config{ul_soft_name}&quot;</span><span class="sy0">;</span>
<span class="kw1">my</span> <span class="re0">$process_checked</span><span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span>
<span class="kw1">my</span> <span class="re0">$current_pid</span><span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span>
<span class="kw1">my</span> <span class="re0">$get_epoch_time</span><span class="sy0">;</span>
<span class="kw1">my</span> <span class="re0">@get_times</span><span class="sy0">;</span>
<span class="kw1">my</span> <span class="re0">$get_size</span><span class="sy0">;</span>
<span class="kw1">my</span> <span class="re0">$fake_gds_file</span><span class="sy0">=</span><span class="st0">&quot;$config{jbinary_path}/loop_gds_$config{client_name}<span class="es0">\_</span>$config{ul_soft_name}<span class="es0">\.</span>sh&quot;</span><span class="sy0">;</span>
<span class="kw1">my</span> <span class="re0">$client_ulapp</span><span class="sy0">=</span><span class="re0">$ARGV</span><span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span><span class="sy0">;</span>
&#160;
<span class="co1">#######################</span>
<span class="co1">#   Short Functions   #</span>
<span class="co1">#######################</span>
&#160;
<span class="co1">##### Get functions #####</span>
&#160;
<span class="co1"># Get help</span>
<span class="kw2">sub</span> help <span class="br0">&#123;</span>
    <span class="kw3">print</span> <span class="st0">&quot;<span class="es0">\n</span>mycompany Cluster Service for Sun Solaris Cluster (SunPlex)<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
    <span class="kw3">print</span> <span class="st0">&quot;Usage&#160;: mycompanycluster [start|stop|status|check] [conf_name]<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
    <span class="kw3">print</span> <span class="st0">&quot; - start     &#160;: start cluster command<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
    <span class="kw3">print</span> <span class="st0">&quot; - stop      &#160;: stop cluster command<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
    <span class="kw3">print</span> <span class="st0">&quot; - status    &#160;: status cluster command<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
    <span class="kw3">print</span> <span class="st0">&quot; - check     &#160;: check installation and configuration<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
    <span class="kw3">print</span> <span class="st0">&quot; - conf_name &#160;: set config name defined with [] in mycompany.conf<span class="es0">\n</span><span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
    <span class="re0">$ulapp_pid</span><span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span>
    <span class="kw3">exit</span><span class="br0">&#40;</span><span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&#160;
<span class="co1"># Get database size information</span>
<span class="kw2">sub</span> get_database_size <span class="br0">&#123;</span>
    <span class="kw3">open</span> <span class="br0">&#40;</span>GET_SIZE<span class="sy0">,</span> <span class="st0">&quot;/usr/bin/du -sk $config{uldatabase_path} |&quot;</span><span class="br0">&#41;</span> <span class="kw1">or</span> <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_ERR<span class="sy0">,</span> <span class="st0">&quot;Error while trying to get database size&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="kw1">while</span> <span class="br0">&#40;</span><span class="re4">&lt;GET_SIZE&gt;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span><span class="co5">$_</span> <span class="sy0">=~</span> <span class="co2">/(\d+).+/ig</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="re0">$database_size</span><span class="sy0">=</span><span class="co3">$1</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
    <span class="br0">&#125;</span>
    <span class="kw3">close</span> <span class="br0">&#40;</span>GET_SIZE<span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&#160;
<span class="co1">##### File handles functions #####</span>
&#160;
<span class="co1"># Get JAVA PID from jpid File</span>
<span class="kw2">sub</span> get_pid_from_jpid <span class="br0">&#123;</span>
    <span class="kw1">my</span> <span class="re0">$open_res</span><span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span>
    <span class="kw1">my</span> <span class="re0">$n</span><span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span>
    <span class="kw1">while</span> <span class="br0">&#40;</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="br0">&#40;</span><span class="re0">$open_res</span> <span class="sy0">=</span> <span class="kw3">open</span> <span class="br0">&#40;</span>JPID_FILER<span class="sy0">,</span> <span class="st0">&quot;&lt;$config{jpid_file}&quot;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="kw1">and</span> <span class="re0">$n</span><span class="sy0">&lt;</span><span class="nu0">5</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_DEBUG<span class="sy0">,</span> <span class="st0">&quot;Error opening $config{jpid_file}&#160;: $!. Waiting for a while&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="kw3">sleep</span> <span class="nu0">1</span><span class="sy0">;</span>
        <span class="re0">$n</span><span class="sy0">++;</span>
    <span class="br0">&#125;</span>
    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span> <span class="re0">$open_res</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_DEBUG<span class="sy0">,</span> <span class="st0">&quot;Could not open $config{jpid_file}.&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="kw3">return</span> <span class="re0">$ulapp_pid</span><span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
    <span class="kw1">while</span> <span class="br0">&#40;</span><span class="re4">&lt;JPID_FILER&gt;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw3">chomp</span> <span class="co5">$_</span><span class="sy0">;</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span><span class="co5">$_</span> <span class="sy0">=~</span> <span class="co2">/(\d+)/ig</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="re0">$ulapp_pid</span><span class="sy0">=</span><span class="co3">$1</span><span class="sy0">;</span>
            <span class="kw1">last</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
    <span class="br0">&#125;</span>
    <span class="kw3">close</span> <span class="br0">&#40;</span>JPID_FILER<span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_DEBUG<span class="sy0">,</span> <span class="st0">&quot;Got pid from $config{jpid_file}&#160;: $ulapp_pid&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="kw3">return</span> <span class="re0">$ulapp_pid</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&#160;
<span class="co1"># Get SUN Cluster version to validate cluster commands</span>
<span class="kw2">sub</span> get_cluster_version <span class="br0">&#123;</span>
    <span class="co1"># Look if cluster version file exist. If not, SUN cluster isn't installed</span>
    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">-</span>e <span class="re0">$cluster_file_version</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="co1"># Now getting version</span>
        <span class="kw3">open</span> <span class="br0">&#40;</span>CLUSTER_VERSION<span class="sy0">,</span> <span class="st0">&quot;&lt;$cluster_file_version&quot;</span><span class="br0">&#41;</span> <span class="kw1">or</span> <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_ERR<span class="sy0">,</span> <span class="st0">&quot;Error opening file $cluster_file_version&#160;: $!&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="kw1">while</span> <span class="br0">&#40;</span><span class="re4">&lt;CLUSTER_VERSION&gt;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="kw1">if</span> <span class="br0">&#40;</span><span class="co5">$_</span> <span class="sy0">=~</span> <span class="co2">/\s+Sun Cluster (\d\.\d+)(u\d+|).+/ig</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                <span class="re0">$cluster_version</span><span class="sy0">=</span><span class="co3">$1</span><span class="sy0">;</span>
                <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_DEBUG<span class="sy0">,</span> <span class="st0">&quot;SUN Cluster version $cluster_version has been detected&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
                <span class="kw1">last</span><span class="sy0">;</span>
            <span class="br0">&#125;</span>
        <span class="br0">&#125;</span>
        <span class="kw3">close</span> <span class="br0">&#40;</span>CLUSTER_VERSION<span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
        <span class="co1"># Else exit because don't know which command to use</span>
        <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_ERR<span class="sy0">,</span> <span class="st0">&quot;Cannot detect SUN Cluster version on $cluster_file_version file&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="kw3">exit</span> <span class="br0">&#40;</span><span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span>
&#160;
<span class="co1"># Get Cluster start timeout</span>
<span class="kw2">sub</span> get_start_timeout_from_cluster <span class="br0">&#123;</span>
    <span class="co1"># Get VIP Ressource name from Ressource Group</span>
    <span class="kw1">my</span> <span class="re0">$command</span><span class="sy0">=</span><span class="re0">&amp;launch_cluster_commands</span><span class="br0">&#40;</span><span class="st_h">'cluster_rg_name'</span><span class="sy0">,</span> <span class="st_h">''</span><span class="sy0">,</span> <span class="re0">$config</span><span class="br0">&#123;</span>cluster_rg_name<span class="br0">&#125;</span> <span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="kw3">open</span> <span class="br0">&#40;</span>GET_VIP_RS_NAME<span class="sy0">,</span> <span class="st0">&quot;$command |&quot;</span><span class="br0">&#41;</span> <span class="kw1">or</span> <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_ERR<span class="sy0">,</span> <span class="st0">&quot;Error while trying to launch command&#160;: $command&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="kw1">while</span> <span class="br0">&#40;</span><span class="re4">&lt;GET_VIP_RS_NAME&gt;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw3">chomp</span> <span class="co5">$_</span><span class="sy0">;</span>
        <span class="re0">$config</span><span class="br0">&#123;</span>cluster_vip_ressource_name<span class="br0">&#125;</span><span class="sy0">=</span><span class="co5">$_</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
    <span class="kw3">close</span> <span class="br0">&#40;</span>GET_VIP_RS_NAME<span class="br0">&#41;</span><span class="sy0">;</span>
&#160;
    <span class="re0">$command</span><span class="sy0">=</span><span class="re0">&amp;launch_cluster_commands</span><span class="br0">&#40;</span><span class="st_h">'get_timeout'</span><span class="sy0">,</span> <span class="re0">$config</span><span class="br0">&#123;</span>cluster_vip_ressource_name<span class="br0">&#125;</span><span class="sy0">,</span> <span class="st_h">''</span> <span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="kw3">open</span> <span class="br0">&#40;</span>TIME_OUT_START<span class="sy0">,</span> <span class="st0">&quot;$command |&quot;</span><span class="br0">&#41;</span> <span class="kw1">or</span> <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_ERR<span class="sy0">,</span> <span class="st0">&quot;Error while trying to launch command&#160;: $command&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="kw1">while</span> <span class="br0">&#40;</span><span class="re4">&lt;TIME_OUT_START&gt;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$cluster_version</span> <span class="sy0">=~</span> <span class="co2">/(3.0|3.1)/</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="kw1">if</span> <span class="br0">&#40;</span><span class="co5">$_</span> <span class="sy0">=~</span> <span class="co2">/$config{cluster_vip_ressource_name}:START_TIMEOUT.+value:.(\d+)/g</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                <span class="re0">$set_start_timeout_to_cluster</span><span class="sy0">=</span><span class="co3">$1</span><span class="sy0">;</span>
                <span class="kw1">last</span><span class="sy0">;</span>
            <span class="br0">&#125;</span>
        <span class="br0">&#125;</span> <span class="kw1">elsif</span> <span class="br0">&#40;</span><span class="re0">$cluster_version</span> <span class="kw1">eq</span> <span class="st_h">'3.2'</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="kw1">if</span> <span class="br0">&#40;</span><span class="co5">$_</span> <span class="sy0">=~</span> <span class="co2">/^..START_TIMEOUT:\s+(\d+)/g</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                <span class="re0">$set_start_timeout_to_cluster</span><span class="sy0">=</span><span class="co3">$1</span><span class="sy0">;</span>
                <span class="kw1">last</span><span class="sy0">;</span>
            <span class="br0">&#125;</span>
        <span class="br0">&#125;</span>
    <span class="br0">&#125;</span>
    <span class="kw3">close</span> <span class="br0">&#40;</span>TIME_OUT_START<span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&#160;
<span class="co1">#### COEF FILE ####</span>
&#160;
<span class="co1"># Write to coefprop Database size and starting time informations</span>
<span class="kw2">sub</span> create_coefprop_file  <span class="br0">&#123;</span>
    <span class="kw3">open</span> <span class="br0">&#40;</span>COEFPROPFILEW<span class="sy0">,</span> <span class="st0">&quot;&gt;$config{coefprop_file}&quot;</span><span class="br0">&#41;</span> <span class="kw1">or</span> <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_ERR<span class="sy0">,</span> <span class="st0">&quot;Error opening file $config{coefprop_file}&#160;: $!&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="kw3">print</span> COEFPROPFILEW <span class="st0">&quot;### <span class="es0">\u</span><span class="es0">\L</span>$config{client_name} ($config{ul_soft_name}) service informations ###<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
        <span class="kw3">printf</span> COEFPROPFILEW <span class="st_h">'%-35s'</span><span class="sy0">,</span> <span class="st0">&quot;Database size (Ko)&quot;</span><span class="sy0">;</span>
        <span class="kw3">print</span> COEFPROPFILEW <span class="st0">&quot;= $database_size<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
        <span class="kw3">printf</span> COEFPROPFILEW <span class="st_h">'%-35s'</span><span class="sy0">,</span> <span class="st0">&quot;Starting time&quot;</span><span class="sy0">;</span>
        <span class="kw3">print</span> COEFPROPFILEW <span class="st0">&quot;= $get_date_formated<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
    <span class="kw3">close</span> <span class="br0">&#40;</span>COEFPROPFILEW<span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&#160;
<span class="co1"># Append to coefprop PID</span>
<span class="kw2">sub</span> append_pid_to_coefprop <span class="br0">&#123;</span>
    <span class="kw3">open</span> <span class="br0">&#40;</span>COEFPROPFILEW<span class="sy0">,</span> <span class="st0">&quot;&gt;&gt;$config{coefprop_file}&quot;</span><span class="br0">&#41;</span> <span class="kw1">or</span> <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_ERR<span class="sy0">,</span> <span class="st0">&quot;Error on writing file $config{coefprop_file}&#160;: $!&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="kw3">printf</span> COEFPROPFILEW <span class="st_h">'%-35s'</span><span class="sy0">,</span> <span class="st0">&quot;PID&quot;</span><span class="sy0">;</span>
        <span class="kw3">print</span> COEFPROPFILEW <span class="st0">&quot;= $ulapp_pid<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
    <span class="kw3">close</span> <span class="br0">&#40;</span>COEFPROPFILEW<span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&#160;
<span class="co1"># Append $rap_rop_value to coefprop file</span>
<span class="kw2">sub</span> append_coefprop_value_to_coeffile <span class="br0">&#123;</span>
    <span class="kw3">open</span> <span class="br0">&#40;</span>COEFPROPFILEW<span class="sy0">,</span> <span class="st0">&quot;&gt;&gt;$config{coefprop_file}&quot;</span><span class="br0">&#41;</span> <span class="kw1">or</span> <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_ERR<span class="sy0">,</span> <span class="st0">&quot;Error on writing file $config{coefprop_file}&#160;: $!&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="kw3">printf</span> COEFPROPFILEW <span class="st_h">'%-35s'</span><span class="sy0">,</span> <span class="st0">&quot;Started time&quot;</span><span class="sy0">;</span>
    <span class="kw3">print</span> COEFPROPFILEW <span class="st0">&quot;= $get_date_formated<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
    <span class="kw3">printf</span> COEFPROPFILEW <span class="st_h">'%-35s'</span><span class="sy0">,</span> <span class="st0">&quot;Coefficient<span class="es0">\ </span>of<span class="es0">\ </span>proportionality&quot;</span><span class="sy0">;</span>
    <span class="kw3">print</span> COEFPROPFILEW <span class="st0">&quot;= $coefprop_value<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
    <span class="kw3">close</span> <span class="br0">&#40;</span>COEFPROPFILEW<span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&#160;
&#160;
<span class="co1"># Get Coefficient of proportionality with $coefpropfile</span>
<span class="kw2">sub</span> get_coefprop_value <span class="br0">&#123;</span>
        <span class="kw3">open</span> <span class="br0">&#40;</span>COEFPROPFILER<span class="sy0">,</span> <span class="st0">&quot;&lt;$config{coefprop_file}&quot;</span><span class="br0">&#41;</span> <span class="kw1">or</span> <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_ERR<span class="sy0">,</span> <span class="st0">&quot;Error opening file $config{coefprop_file}&#160;: $!&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="kw1">while</span> <span class="br0">&#40;</span><span class="re4">&lt;COEFPROPFILER&gt;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="kw3">chomp</span> <span class="co5">$_</span><span class="sy0">;</span>
            <span class="kw1">if</span> <span class="br0">&#40;</span><span class="co5">$_</span> <span class="sy0">=~</span> <span class="co2">/Coefficient\ of\ proportionality\s*=\s*(.+).*/gi</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                <span class="re0">$coefprop_value</span><span class="sy0">=</span><span class="co3">$1</span><span class="sy0">;</span>
                <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_NOTICE<span class="sy0">,</span> <span class="st0">&quot;ratio has been found in coefprop file and setting up to $coefprop_value&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
            <span class="br0">&#125;</span>
        <span class="br0">&#125;</span>
        <span class="kw3">close</span> <span class="br0">&#40;</span>COEFPROPFILER<span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&#160;
<span class="kw2">sub</span> get_database_size_from_coeffile <span class="br0">&#123;</span>
    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">-</span>e <span class="re0">$config</span><span class="br0">&#123;</span>coefprop_file<span class="br0">&#125;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="co1"># $coefprop_value should be the one in the coefficient of proportionality file</span>
        <span class="re0">&amp;get_coefprop_value</span><span class="sy0">;</span>
        <span class="kw3">open</span> <span class="br0">&#40;</span>COEFPROPFILER<span class="sy0">,</span> <span class="st0">&quot;&lt;$config{coefprop_file}&quot;</span><span class="br0">&#41;</span> <span class="kw1">or</span> <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_ERR<span class="sy0">,</span> <span class="st0">&quot;Error opening file $config{coefprop_file}&#160;: $!&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="kw1">while</span> <span class="br0">&#40;</span><span class="re4">&lt;COEFPROPFILER&gt;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="kw3">chomp</span> <span class="co5">$_</span><span class="sy0">;</span>
            <span class="kw1">if</span> <span class="br0">&#40;</span><span class="co5">$_</span> <span class="sy0">=~</span> <span class="co2">/Database\ size\ \(Ko\)\s*=\s*(\d+)/ig</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                <span class="re0">$database_size</span><span class="sy0">=</span><span class="co3">$1</span><span class="sy0">;</span>
            <span class="br0">&#125;</span>
        <span class="br0">&#125;</span>
        <span class="kw3">close</span> <span class="br0">&#40;</span>COEFPROPFILER<span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
        <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_NOTICE<span class="sy0">,</span> <span class="st0">&quot;couldn't determine ratio, coefprop file hasn't been found ($config{coefprop_file})&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="re0">&amp;default_coefprop</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span>
&#160;
<span class="co1">#### TEMP FILE ####</span>
&#160;
<span class="co1"># Write to $config{temp_file} PID</span>
<span class="kw2">sub</span> write_pid_to_temp_file <span class="br0">&#123;</span>
    <span class="co1"># Write PID to temp file</span>
    <span class="kw3">open</span> <span class="br0">&#40;</span>TEMP_FILE<span class="sy0">,</span> <span class="st0">&quot;&gt;$config{temp_file}&quot;</span><span class="br0">&#41;</span> <span class="kw1">or</span> <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_ERR<span class="sy0">,</span> <span class="st0">&quot;Error opening file $config{temp_file}&#160;: $!&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="kw3">printf</span> TEMP_FILE <span class="st_h">'%-35s'</span><span class="sy0">,</span> <span class="st_h">'PID'</span><span class="sy0">;</span>
        <span class="kw3">print</span> TEMP_FILE <span class="st0">&quot;= $ulapp_pid<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
    <span class="kw3">close</span> <span class="br0">&#40;</span>TEMP_FILE<span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&#160;
<span class="co1"># Get JAVA PID from temp File</span>
<span class="kw2">sub</span> get_pid_from_temp <span class="br0">&#123;</span>
    <span class="kw3">open</span> <span class="br0">&#40;</span>TEMP_FILER<span class="sy0">,</span> <span class="st0">&quot;&lt;$config{temp_file}&quot;</span><span class="br0">&#41;</span> <span class="kw1">or</span> <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_ERR<span class="sy0">,</span> <span class="st0">&quot;Error opening file $config{temp_file}&#160;: $!&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="kw1">while</span> <span class="br0">&#40;</span><span class="re4">&lt;TEMP_FILER&gt;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw3">chomp</span> <span class="co5">$_</span><span class="sy0">;</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span><span class="co5">$_</span> <span class="sy0">=~</span> <span class="co2">/^PID\s*=\s*(.+)/ig</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="re0">$ulapp_pid</span><span class="sy0">=</span><span class="co3">$1</span><span class="sy0">;</span>
            <span class="kw1">last</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
    <span class="br0">&#125;</span>
    <span class="kw3">close</span> <span class="br0">&#40;</span>TEMP_FILER<span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="kw3">return</span> <span class="re0">$ulapp_pid</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&#160;
<span class="co1">##### Actions functions #####</span>
&#160;
<span class="co1"># Read config file</span>
<span class="kw2">sub</span> read_config_file <span class="br0">&#123;</span>
    <span class="kw1">my</span> <span class="re0">$use_config_file_temp</span><span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span>
&#160;
    <span class="co1"># Set config file</span>
    <span class="kw1">my</span> <span class="re0">$config_file</span><span class="sy0">=</span><span class="st_h">'/etc/mycompany/mycompany.cfg'</span><span class="sy0">;</span>
    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="br0">&#40;</span><span class="sy0">-</span>f <span class="re0">$config_file_temp</span><span class="br0">&#41;</span> <span class="kw1">and</span> <span class="br0">&#40;</span><span class="sy0">-</span>r <span class="re0">$config_file_temp</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="re0">$config_file</span><span class="sy0">=</span><span class="re0">$config_file_temp</span><span class="sy0">;</span>
        <span class="re0">$use_config_file_temp</span><span class="sy0">=</span><span class="nu0">1</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
&#160;
    <span class="co1"># Exit if config file is not found</span>
    <span class="kw1">unless</span> <span class="br0">&#40;</span><span class="br0">&#40;</span><span class="sy0">-</span>f <span class="re0">$config_file</span><span class="br0">&#41;</span> <span class="sy0">&amp;&amp;</span> <span class="br0">&#40;</span><span class="sy0">-</span>r <span class="re0">$config_file</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw3">print</span> <span class="st0">&quot;Sorry but $config_file couldn't be determined, please create one before starting<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
        <span class="kw3">exit</span> <span class="nu0">1</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
&#160;
    <span class="kw1">my</span> <span class="re0">$config_founded</span><span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span>
    <span class="co1"># Open Config file and stock content in&#160;%config hash</span>
    <span class="kw3">open</span> <span class="br0">&#40;</span>READ_CONFIG<span class="sy0">,</span> <span class="st0">&quot;&lt;$config_file&quot;</span><span class="br0">&#41;</span> <span class="kw1">or</span> <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_ERR<span class="sy0">,</span> <span class="st0">&quot;Error opening file $config_file&#160;: $!&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&#160;
    <span class="kw1">while</span> <span class="br0">&#40;</span><span class="re4">&lt;READ_CONFIG&gt;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw3">chomp</span> <span class="co5">$_</span><span class="sy0">;</span> 
        <span class="co1"># Flushing comments</span>
        <span class="co2">s/#.*$//</span><span class="sy0">;</span>
&#160;
        <span class="co1"># Searching [] to start config read</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$config_founded</span> <span class="kw1">eq</span> <span class="nu0">0</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="kw1">if</span> <span class="br0">&#40;</span><span class="co2">/^\[$ARGV[1]\]/</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                <span class="re0">$config_founded</span><span class="sy0">=</span><span class="nu0">1</span><span class="sy0">;</span>
            <span class="br0">&#125;</span> <span class="kw1">elsif</span> <span class="br0">&#40;</span><span class="co2">/^\[-.*/</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                <span class="re0">$config_founded</span><span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span>
            <span class="br0">&#125;</span>   
            <span class="kw1">next</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>   
        <span class="co1"># When found, analyze content and push to tabs</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$config_founded</span> <span class="kw1">eq</span> <span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="kw1">if</span> <span class="br0">&#40;</span><span class="co2">/(\w+).*=\s*(\S+)/</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                <span class="re0">$config</span><span class="br0">&#123;</span><span class="co3">$1</span><span class="br0">&#125;</span> <span class="sy0">=</span> <span class="co3">$2</span><span class="sy0">;</span> 
            <span class="br0">&#125;</span> <span class="kw1">elsif</span> <span class="br0">&#40;</span><span class="co2">/^\[/</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                <span class="kw1">last</span><span class="sy0">;</span>
            <span class="br0">&#125;</span>   
        <span class="br0">&#125;</span>   
    <span class="br0">&#125;</span>
    <span class="kw3">close</span> READ_CONFIG<span class="sy0">;</span>
&#160;
    <span class="co1"># Create others vars if not already done</span>
    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$use_config_file_temp</span> <span class="kw1">eq</span> <span class="nu0">0</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw1">my</span> <span class="re0">$key</span><span class="sy0">;</span>
        <span class="kw1">my</span> <span class="re0">$value</span><span class="sy0">;</span>
&#160;
        <span class="co1"># Set real path to $config{ulapp_path}</span>
        <span class="kw1">my</span> <span class="re0">$new_config_key</span><span class="sy0">=</span><span class="re0">$config</span><span class="br0">&#123;</span>ulapp_path<span class="br0">&#125;</span><span class="sy0">;</span>
        <span class="kw3">delete</span><span class="br0">&#40;</span><span class="re0">$config</span><span class="br0">&#123;</span>ulapp_path<span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="re0">$config</span><span class="br0">&#123;</span>ulapp_path<span class="br0">&#125;</span><span class="sy0">=</span><span class="st0">&quot;$new_config_key/$config{client_name}<span class="es0">\_</span>$config{ul_soft_name}&quot;</span><span class="sy0">;</span>
        <span class="re0">$new_config_key</span><span class="sy0">=</span><span class="re0">$config</span><span class="br0">&#123;</span>temp_file<span class="br0">&#125;</span><span class="sy0">;</span>
        <span class="kw3">delete</span><span class="br0">&#40;</span><span class="re0">$config</span><span class="br0">&#123;</span>temp_file<span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="re0">$config</span><span class="br0">&#123;</span>temp_file<span class="br0">&#125;</span><span class="sy0">=</span><span class="st0">&quot;$new_config_key/$config{client_name}<span class="es0">\_</span>$config{ul_soft_name}<span class="es0">\_</span>temp&quot;</span><span class="sy0">;</span>
&#160;
        <span class="co1"># Write configuration to $temp_file_temp</span>
        <span class="kw3">open</span> <span class="br0">&#40;</span>WRITE_CONFIG_TEMP<span class="sy0">,</span> <span class="st0">&quot;&gt;$config_file_temp&quot;</span><span class="br0">&#41;</span> <span class="kw1">or</span> <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_ERR<span class="sy0">,</span> <span class="st0">&quot;Error on writing file $config_file_temp&#160;: $!&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&#160;
        <span class="kw3">print</span> WRITE_CONFIG_TEMP <span class="st0">&quot;[$ARGV[1]]<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
        <span class="kw1">while</span> <span class="br0">&#40;</span><span class="br0">&#40;</span><span class="re0">$key</span><span class="sy0">,</span> <span class="re0">$value</span><span class="br0">&#41;</span> <span class="sy0">=</span> <span class="kw3">each</span><span class="br0">&#40;</span><span class="re0">%config</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#123;</span>
            <span class="kw3">print</span> WRITE_CONFIG_TEMP <span class="st0">&quot;<span class="es0">\t</span>$key = $value<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
        <span class="kw3">close</span> <span class="br0">&#40;</span>WRITE_CONFIG_TEMP<span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span>
&#160;
<span class="co1"># Check if process has a valid PID number</span>
<span class="kw2">sub</span> status_process_check <span class="br0">&#123;</span>
    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">&amp;check_process</span> <span class="sy0">!=</span> <span class="re0">$ulapp_pid</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_ERR<span class="sy0">,</span> <span class="st0">&quot;process with PID $ulapp_pid, couldn't be found&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="kw3">return</span> <span class="nu0">1</span><span class="sy0">;</span>
    <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
    	<span class="kw3">return</span> <span class="nu0">0</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span>
&#160;
<span class="co1"># Secure coefficient of proportionality value</span>
<span class="kw2">sub</span> default_coefprop <span class="br0">&#123;</span>
    <span class="re0">$config</span><span class="br0">&#123;</span>add_start_interval_time<span class="br0">&#125;</span><span class="sy0">=</span><span class="nu0">300</span><span class="sy0">;</span>
    <span class="re0">$coefprop_value</span><span class="sy0">=</span><span class="nu0">0.001</span><span class="sy0">;</span>
    <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_NOTICE<span class="sy0">,</span> <span class="st0">&quot;couldn't determine ratio, setting up a secure additional interval to $config{add_start_interval_time} seconds and a ratio of $coefprop_value&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&#160;
<span class="co1"># Sun Cluster 3.0 and 3.1 commands</span>
<span class="kw2">sub</span> launch_cluster_commands <span class="br0">&#123;</span>
    <span class="kw1">my</span> <span class="re0">%cluster_commands</span><span class="sy0">;</span>
    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$cluster_version</span> <span class="sy0">=~</span> <span class="co2">/(3.0|3.1)/g</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="re0">%cluster_commands</span> <span class="sy0">=</span> <span class="br0">&#40;</span>
            <span class="st0">&quot;get_timeout&quot;</span>       <span class="sy0">=&gt;</span> <span class="st0">&quot;/usr/cluster/bin/scrgadm -pvv&quot;</span><span class="sy0">,</span>
            <span class="st0">&quot;set_start_timeout&quot;</span> <span class="sy0">=&gt;</span> <span class="st0">&quot;/usr/cluster/bin/scrgadm -c -j $_[2]<span class="es0">\_</span>script -y start_timeout=$_[1]&quot;</span><span class="sy0">,</span>
            <span class="st0">&quot;cluster_rg_name&quot;</span>   <span class="sy0">=&gt;</span> <span class="st0">&quot;/usr/cluster/bin/clrs list -g $_[2] -t SUNW.LogicalHostname:2&quot;</span><span class="sy0">,</span>
            <span class="st0">&quot;clusterstatus&quot;</span>     <span class="sy0">=&gt;</span> <span class="st0">&quot;cluster status&quot;</span><span class="sy0">,</span>
        <span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="co1"># Sun Cluster 3.2 commands</span>
    <span class="br0">&#125;</span> <span class="kw1">elsif</span> <span class="br0">&#40;</span><span class="re0">$cluster_version</span> <span class="kw1">eq</span> <span class="st_h">'3.2'</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="re0">%cluster_commands</span> <span class="sy0">=</span> <span class="br0">&#40;</span>
            <span class="st0">&quot;get_timeout&quot;</span>       <span class="sy0">=&gt;</span> <span class="st0">&quot;/usr/cluster/bin/clrs show -v $_[2]&quot;</span><span class="sy0">,</span>
            <span class="st0">&quot;set_start_timeout&quot;</span> <span class="sy0">=&gt;</span> <span class="st0">&quot;/usr/cluster/bin/clrs set -p start_timeout=$_[1] $_[2]<span class="es0">\_</span>script&quot;</span><span class="sy0">,</span>
            <span class="st0">&quot;cluster_rg_name&quot;</span>   <span class="sy0">=&gt;</span> <span class="st0">&quot;/usr/cluster/bin/clrs list -g $_[2] -t SUNW.LogicalHostname:2&quot;</span><span class="sy0">,</span>
            <span class="st0">&quot;clusterstatus&quot;</span>     <span class="sy0">=&gt;</span> <span class="st0">&quot;csstat&quot;</span><span class="sy0">,</span>
        <span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
        <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_ERR<span class="sy0">,</span> <span class="st0">&quot;SUN Cluster version couldn't be determined, can't execute your requested command ($_[0] on $_[2] with a timeout of $_[1])&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="kw3">exit</span> <span class="br0">&#40;</span><span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
    <span class="kw3">return</span> <span class="st0">&quot;$cluster_commands{$_[0]}&quot;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&#160;
<span class="co1"># Send logs to syslog server service</span>
<span class="kw2">sub</span> sendto_syslog <span class="br0">&#123;</span>
    <span class="co1"># Use Syslog to logs script messages (usually in /var/adm/messages)</span>
    <span class="co1"># Change your syslog.conf if you need to customize</span>
    openlog<span class="br0">&#40;</span><span class="st0">&quot;<span class="es0">\u</span><span class="es0">\L</span>$config{client_name} ($config{ul_soft_name}) [$ulapp_pid]&quot;</span><span class="sy0">,</span> LOG_NDELAY<span class="sy0">,</span> LOG_DAEMON<span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="co1"># If DEBUG mode is enable, print DEBUG logs to syslog</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$config</span><span class="br0">&#123;</span>enable_debug<span class="br0">&#125;</span> <span class="kw1">eq</span> <span class="st_h">'on'</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            setlogmask<span class="br0">&#40;</span>LOG_MASK<span class="br0">&#40;</span>LOG_DEBUG<span class="br0">&#41;</span> <span class="sy0">|</span> LOG_MASK<span class="br0">&#40;</span>LOG_ERR<span class="br0">&#41;</span> <span class="sy0">|</span> LOG_MASK<span class="br0">&#40;</span>LOG_NOTICE<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
            setlogmask<span class="br0">&#40;</span>LOG_MASK<span class="br0">&#40;</span>LOG_ERR<span class="br0">&#41;</span> <span class="sy0">|</span> LOG_MASK<span class="br0">&#40;</span>LOG_NOTICE<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
        syslog<span class="br0">&#40;</span><span class="co5">$_</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span><span class="sy0">,</span> <span class="st0">&quot;$_[1]&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    closelog<span class="sy0">;</span>
<span class="br0">&#125;</span>
&#160;
<span class="co1">#####################</span>
<span class="co1">#   Big Functions   #</span>
<span class="co1">#####################</span>
&#160;
<span class="co1">##### Checks functions #####</span>
&#160;
<span class="co1"># Check UL App processus start</span>
<span class="kw2">sub</span> check_process <span class="br0">&#123;</span>
    <span class="kw1">my</span> <span class="re0">$check_counter</span><span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span>
    <span class="re0">$process_time_start</span><span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span>
    <span class="kw1">my</span> <span class="re0">$good_format</span><span class="sy0">;</span>
&#160;
    <span class="co1"># Looking for process state to get started (3 checks to validate)</span>
    <span class="kw1">while</span> <span class="br0">&#40;</span><span class="re0">$check_counter</span> <span class="kw1">ne</span> <span class="nu0">3</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw1">my</span> <span class="re0">$process_check_ok</span><span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span>
&#160;
        <span class="co1"># If $config{max_time_create} has been reached, cluster application restart</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$config</span><span class="br0">&#123;</span>max_time_create<span class="br0">&#125;</span> <span class="sy0">&lt;=</span> <span class="re0">$process_time_start</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="co1"># Only use $config{max_time_create} at start</span>
            <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$current_mode</span> <span class="kw1">eq</span> <span class="st_h">'start'</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                <span class="kw3">return</span> <span class="nu0">0</span><span class="sy0">;</span>
            <span class="br0">&#125;</span> <span class="kw1">elsif</span> <span class="br0">&#40;</span><span class="re0">$current_mode</span> <span class="kw1">eq</span> <span class="st_h">'integrate'</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_NOTICE<span class="sy0">,</span> <span class="st0">&quot;process couldn't get into the cluster because process wasn't found. Now starting normally&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
                <span class="kw3">return</span> <span class="nu0">0</span><span class="sy0">;</span>
            <span class="br0">&#125;</span> <span class="kw1">elsif</span> <span class="br0">&#40;</span><span class="re0">$current_mode</span> <span class="kw1">eq</span> <span class="st_h">'status'</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                <span class="kw3">return</span> <span class="nu0">0</span><span class="sy0">;</span>
            <span class="br0">&#125;</span>
        <span class="br0">&#125;</span>
&#160;
        <span class="co1"># Check if PID's Ulapp exists</span>
        <span class="re0">$process_check_ok</span><span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw3">kill</span> <span class="nu0">0</span><span class="sy0">,</span> <span class="re0">$ulapp_pid</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="co1"># Process found for start</span>
            <span class="re0">$process_check_ok</span><span class="sy0">=</span><span class="nu0">1</span><span class="sy0">;</span>
            <span class="kw1">last</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
&#160;
        <span class="re0">$good_format</span> <span class="sy0">=</span> <span class="kw3">printf</span><span class="br0">&#40;</span><span class="st_h">'%05s'</span><span class="sy0">,</span> <span class="re0">$process_time_start</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_DEBUG<span class="sy0">,</span> <span class="st0">&quot;DEBUG Starting Process [$ulapp_pid]&#160;: [Max time&#160;: $config{max_time_create} | Time $current_mode&#160;: $good_format | Validated&#160;: $check_counter | Found&#160;: $process_check_ok]&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&#160;
        <span class="co1"># Increase if found</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$process_check_ok</span> <span class="kw1">eq</span> <span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="re0">$check_counter</span><span class="sy0">++;</span>
        <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
            <span class="re0">$check_counter</span><span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
&#160;
        <span class="co1"># Increase $process_time_start</span>
        <span class="re0">$process_time_start</span><span class="sy0">++;</span>
&#160;
        <span class="co1"># Wait 1 sec before looping</span>
        <span class="kw3">sleep</span> <span class="nu0">1</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
&#160;
    <span class="co1"># If all checks successfully passed, return PID</span>
    <span class="kw3">return</span> <span class="re0">$ulapp_pid</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&#160;
<span class="co1"># Check UL App processus stop</span>
<span class="kw2">sub</span> check_process_stop <span class="br0">&#123;</span>
    <span class="kw1">my</span> <span class="re0">$check_counter</span><span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span>
    <span class="kw1">my</span> <span class="re0">$process_time_stop</span><span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span>
    <span class="kw1">my</span> <span class="re0">$process_check_ok</span><span class="sy0">;</span>
    <span class="kw1">my</span> <span class="re0">$good_format</span><span class="sy0">;</span>
    <span class="co1"># Since Ulbridge 2.4.5 timeout for adapters is 10 min max</span>
    <span class="kw1">my</span> <span class="re0">$max_time_stop</span> <span class="sy0">=</span> <span class="re0">$config</span><span class="br0">&#123;</span>max_time_stop<span class="br0">&#125;</span> <span class="sy0">+</span> <span class="nu0">600</span><span class="sy0">;</span>
&#160;
    <span class="co1"># Looking for process state to get started (3 checks to validate)</span>
    <span class="kw1">while</span> <span class="br0">&#40;</span><span class="re0">$check_counter</span> <span class="kw1">ne</span> <span class="nu0">3</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="re0">$process_check_ok</span><span class="sy0">=</span><span class="nu0">1</span><span class="sy0">;</span>
&#160;
        <span class="co1"># If $max_time_stop has been reached, return 0</span>
        <span class="kw3">return</span> <span class="nu0">0</span> <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$max_time_stop</span> <span class="sy0">&lt;=</span> <span class="re0">$process_time_stop</span><span class="br0">&#41;</span><span class="sy0">;</span>
&#160;
        <span class="co1"># Check if PID's Ulapp exists</span>
        <span class="kw1">unless</span> <span class="br0">&#40;</span><span class="kw3">kill</span> <span class="nu0">0</span><span class="sy0">,</span> <span class="re0">$ulapp_pid</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="re0">$process_check_ok</span><span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span>
            <span class="re0">$check_counter</span><span class="sy0">++;</span>
        <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
            <span class="re0">$check_counter</span><span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
&#160;
        <span class="re0">$good_format</span><span class="sy0">=</span><span class="kw3">sprintf</span><span class="br0">&#40;</span><span class="st_h">'%05s'</span><span class="sy0">,</span> <span class="re0">$process_time_stop</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_DEBUG<span class="sy0">,</span> <span class="st0">&quot;DEBUG Stopping Process [$ulapp_pid]&#160;: [Max time&#160;: $max_time_stop | Time $current_mode&#160;: $good_format | Validated&#160;: $check_counter | Found&#160;: $process_check_ok]&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&#160;
        <span class="co1"># Increase $process_time_stop and counter</span>
        <span class="re0">$process_time_stop</span><span class="sy0">++;</span>
&#160;
        <span class="co1"># Wait 1 sec before looping</span>
        <span class="kw3">sleep</span> <span class="nu0">1</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
&#160;
    <span class="co1"># If all checks successfully passed, return 1</span>
    <span class="kw3">return</span> <span class="nu0">1</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&#160;
<span class="co1">## Port Listener Check Function ##</span>
<span class="kw2">sub</span> check_port_listen <span class="br0">&#123;</span>
    <span class="kw1">my</span> <span class="re0">$check_counter</span><span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span>
    <span class="kw1">my</span> <span class="re0">$good_format_port</span><span class="sy0">;</span>
    <span class="kw1">my</span> <span class="re0">$port_counter</span><span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span>
    <span class="kw1">my</span> <span class="re0">$port_open_timeout</span><span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span>
&#160;
    <span class="co1"># Truncate and add 1</span>
    <span class="kw1">my</span> <span class="re0">$truncate_max_time_port_create</span><span class="sy0">=</span><span class="kw3">sprintf</span> <span class="st_h">'%.0f'</span><span class="sy0">,</span> <span class="re0">$config</span><span class="br0">&#123;</span>max_time_port_create<span class="br0">&#125;</span><span class="sy0">;</span>
    <span class="re0">$config</span><span class="br0">&#123;</span>max_time_port_create<span class="br0">&#125;</span><span class="sy0">=</span><span class="re0">$truncate_max_time_port_create</span> <span class="sy0">+</span> <span class="nu0">1</span><span class="sy0">;</span>
&#160;
    <span class="co1"># Looking if port is opened (3 checks to validate)</span>
    <span class="kw1">while</span> <span class="br0">&#40;</span><span class="re0">$check_counter</span> <span class="kw1">ne</span> <span class="nu0">3</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
&#160;
        <span class="co1"># If max time has been reached, cluster application restart</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$port_open_timeout</span> <span class="sy0">&gt;=</span> <span class="re0">$config</span><span class="br0">&#123;</span>max_time_port_create<span class="br0">&#125;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="co1"># Only use $config{max_time_port_create} at start</span>
            <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$current_mode</span> <span class="kw1">eq</span> <span class="st_h">'start'</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_ERR<span class="sy0">,</span> <span class="st0">&quot;port hasn't been opened in it's due time ($config{max_time_port_create} seconds)&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
                <span class="kw3">exit</span> <span class="br0">&#40;</span><span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span>
            <span class="br0">&#125;</span> <span class="kw1">elsif</span> <span class="br0">&#40;</span><span class="re0">$current_mode</span> <span class="kw1">eq</span> <span class="st_h">'integrate'</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_NOTICE<span class="sy0">,</span> <span class="st0">&quot;port is not open&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
                <span class="co1"># For other arguments</span>
                <span class="kw3">return</span> <span class="nu0">0</span><span class="sy0">;</span>
            <span class="br0">&#125;</span> <span class="kw1">elsif</span> <span class="br0">&#40;</span><span class="re0">$current_mode</span> <span class="kw1">eq</span> <span class="st_h">'status'</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                <span class="kw3">return</span> <span class="nu0">0</span><span class="sy0">;</span>
            <span class="br0">&#125;</span>
        <span class="br0">&#125;</span>
&#160;
        <span class="co1"># Increment port_counter to check if process is still alive</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$port_counter</span> <span class="kw1">eq</span> <span class="nu0">6</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">&amp;check_process</span> <span class="kw1">eq</span> <span class="re0">$current_pid</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                <span class="re0">$port_counter</span><span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span>
                <span class="re0">$port_open_timeout</span> <span class="sy0">=</span> <span class="re0">$port_open_timeout</span> <span class="sy0">+</span> <span class="re0">$process_time_start</span><span class="sy0">;</span>
            <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
                <span class="kw3">return</span> <span class="nu0">2</span><span class="sy0">;</span>
            <span class="br0">&#125;</span>
        <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
            <span class="re0">$port_counter</span><span class="sy0">++;</span>
        <span class="br0">&#125;</span>
&#160;
        <span class="co1"># Check if port's Ulapp is opened</span>
        <span class="kw1">my</span> <span class="re0">$port_found</span><span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span>
        <span class="kw3">socket</span><span class="br0">&#40;</span>SOCK<span class="sy0">,</span> PF_INET<span class="sy0">,</span> SOCK_STREAM<span class="sy0">,</span> <span class="kw3">getprotobyname</span><span class="br0">&#40;</span><span class="st_h">'tcp'</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="re0">$port_found</span> <span class="sy0">=</span> <span class="nu0">1</span> <span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw3">connect</span><span class="br0">&#40;</span>SOCK<span class="sy0">,</span> sockaddr_in<span class="br0">&#40;</span><span class="re0">$config</span><span class="br0">&#123;</span>ul_soft_port_listening<span class="br0">&#125;</span><span class="sy0">,</span> inet_aton<span class="br0">&#40;</span><span class="st_h">'localhost'</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="kw3">close</span> <span class="br0">&#40;</span>SOCK<span class="br0">&#41;</span><span class="sy0">;</span>
&#160;
        <span class="re0">$good_format_port</span><span class="sy0">=</span><span class="kw3">sprintf</span><span class="br0">&#40;</span><span class="st_h">'%04s'</span><span class="sy0">,</span> <span class="re0">$port_open_timeout</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_DEBUG<span class="sy0">,</span> <span class="st0">&quot;DEBUG Port&#160;: [Max create = $config{max_time_port_create} | Time open = $good_format_port | Counter = $port_counter |  Found = $port_found]&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&#160;
        <span class="co1"># Increase if found else erase</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$port_found</span> <span class="kw1">eq</span> <span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="re0">$check_counter</span><span class="sy0">++;</span>
        <span class="br0">&#125;</span>
&#160;
        <span class="co1"># If script is launching at start increase $port_open_timeout</span>
        <span class="re0">$port_open_timeout</span><span class="sy0">++;</span>
&#160;
        <span class="co1"># Wait 1 sec before looping</span>
        <span class="kw3">sleep</span> <span class="nu0">1</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
    <span class="kw3">return</span> <span class="nu0">1</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&#160;
<span class="co1">## CLI command checker ##</span>
<span class="kw2">sub</span> check_cli <span class="br0">&#123;</span>
    <span class="kw1">my</span> <span class="re0">$check_counter</span><span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span>
    <span class="kw1">my</span> <span class="re0">$cli_validated</span><span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span>
    <span class="kw1">my</span> <span class="re0">$cli_counter</span><span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span>
&#160;
    <span class="kw1">while</span> <span class="br0">&#40;</span><span class="re0">$cli_validated</span> <span class="kw1">ne</span> <span class="nu0">3</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
&#160;
        <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$cli_counter</span> <span class="sy0">&gt;=</span> <span class="re0">$config</span><span class="br0">&#123;</span>max_cli_command_retry<span class="br0">&#125;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_ERR<span class="sy0">,</span> <span class="st0">&quot;Coulnd't catch CLI validation&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
            <span class="kw3">return</span> <span class="nu0">0</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
&#160;
        <span class="co1"># Launching CLI command</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$config</span><span class="br0">&#123;</span>ul_soft_name<span class="br0">&#125;</span> <span class="kw1">eq</span> <span class="st_h">'ulbridge'</span> <span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="kw3">open</span> <span class="br0">&#40;</span>CHECK_CLI<span class="sy0">,</span> <span class="st0">&quot;java -jar $config{japp} -login $config{cli_account_login} -password $config{cli_account_password} -port $config{ul_soft_port_listening} view $config{ul_soft_name} |&quot;</span><span class="br0">&#41;</span> <span class="kw1">or</span> <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_ERR<span class="sy0">,</span> <span class="st0">&quot;Error on ch
ecking CLI command&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="br0">&#125;</span> <span class="kw1">elsif</span> <span class="br0">&#40;</span><span class="re0">$config</span><span class="br0">&#123;</span>ul_soft_name<span class="br0">&#125;</span> <span class="kw1">eq</span> <span class="st_h">'ulodisys'</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="kw3">open</span> <span class="br0">&#40;</span>CHECK_CLI<span class="sy0">,</span> <span class="st0">&quot;java -jar $config{japp} -login $config{cli_account_login} -password $config{cli_account_password} -port $config{ul_soft_port_listening} help |&quot;</span><span class="br0">&#41;</span> <span class="kw1">or</span> <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_ERR<span class="sy0">,</span> <span class="st0">&quot;Error on checking CLI command&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
        <span class="kw1">while</span> <span class="br0">&#40;</span><span class="re4">&lt;CHECK_CLI&gt;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="kw3">chomp</span> <span class="co5">$_</span><span class="sy0">;</span>
            <span class="kw1">if</span> <span class="br0">&#40;</span><span class="co5">$_</span> <span class="sy0">=~</span> <span class="co2">/($config{cli_match_words})/gi</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                <span class="re0">$check_counter</span><span class="sy0">++;</span>
            <span class="br0">&#125;</span>
        <span class="br0">&#125;</span>
        <span class="kw3">close</span> <span class="br0">&#40;</span>CHECK_CLI<span class="br0">&#41;</span><span class="sy0">;</span>
&#160;
        <span class="co1"># Increase counter</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$check_counter</span> <span class="sy0">&gt;=</span> <span class="nu0">2</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="re0">$cli_validated</span><span class="sy0">++;</span>
        <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
            <span class="re0">$cli_validated</span><span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
&#160;
        <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_DEBUG<span class="sy0">,</span> <span class="st0">&quot;DEBUG CLI&#160;: [Validated = $cli_validated | Valid (=2) = $check_counter | Counter = $cli_counter]&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&#160;
        <span class="co1"># Increase if found</span>
        <span class="re0">$cli_counter</span><span class="sy0">++;</span>
&#160;
        <span class="co1"># Resetting counter</span>
        <span class="re0">$check_counter</span><span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
    <span class="kw3">return</span> <span class="nu0">1</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&#160;
<span class="co1">######################</span>
<span class="co1">#   Main Functions   #</span>
<span class="co1">######################</span>
&#160;
<span class="co1">## Cluster start ##</span>
<span class="kw2">sub</span> start <span class="br0">&#123;</span>
    <span class="co1"># Get Cluster version first</span>
    <span class="re0">&amp;get_cluster_version</span><span class="sy0">;</span>
&#160;
    <span class="co1"># Set default mode as start</span>
    <span class="re0">$current_mode</span><span class="sy0">=</span><span class="st_h">'start'</span><span class="sy0">;</span>
&#160;
    <span class="co1"># Put lock file</span>
    <span class="kw3">open</span> <span class="br0">&#40;</span>LOCK_START<span class="sy0">,</span> <span class="st0">&quot;&gt;$lock_start_file&quot;</span><span class="br0">&#41;</span> <span class="kw1">or</span> <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_ERR<span class="sy0">,</span> <span class="st0">&quot;Error on writing $lock_start_file file&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="kw3">close</span><span class="br0">&#40;</span>LOCK_START<span class="br0">&#41;</span><span class="sy0">;</span>
&#160;
    <span class="co1"># Get COEFPROPFILE informations</span>
    <span class="re0">&amp;get_database_size_from_coeffile</span><span class="sy0">;</span>
&#160;
    <span class="co1"># Verify if $coefprop_value has been defined</span>
    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$coefprop_value</span> <span class="sy0">==</span> <span class="nu0">0</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="re0">&amp;default_coefprop</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
&#160;
    <span class="co1"># Looking if UL application is already started to integrate it in the cluster</span>
    <span class="co1"># Verify if UL Application PID exist and contain PID</span>
    <span class="co1"># Then get clluster informations and try to integrate the application in the cluster</span>
    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">-</span>e <span class="re0">$config</span><span class="br0">&#123;</span>jpid_file<span class="br0">&#125;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="re0">&amp;get_pid_from_jpid</span><span class="sy0">;</span>
        <span class="re0">&amp;integrate_ulapp_to_cluster</span><span class="sy0">;</span>
    <span class="br0">&#125;</span> <span class="kw1">elsif</span> <span class="br0">&#40;</span><span class="sy0">-</span>e <span class="re0">$config</span><span class="br0">&#123;</span>temp_file<span class="br0">&#125;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="re0">&amp;get_pid_from_temp</span><span class="sy0">;</span>
        <span class="re0">&amp;integrate_ulapp_to_cluster</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
&#160;
    <span class="co1"># Reassign good rights</span>
    <span class="kw3">system</span> <span class="st0">&quot;chown&quot;</span><span class="sy0">,</span> <span class="st0">&quot;-Rf&quot;</span><span class="sy0">,</span> <span class="st0">&quot;$config{cli_account_login}&quot;</span><span class="sy0">,</span> <span class="st0">&quot;$config{ulapp_path}&quot;</span><span class="sy0">;</span>
&#160;
    <span class="co1"># Get database size</span>
    <span class="re0">&amp;get_database_size</span><span class="sy0">;</span>
&#160;
    <span class="co1"># Get actual date</span>
    <span class="re0">$get_date_formated</span> <span class="sy0">=</span> strftime <span class="st0">&quot;%d-%m-%y&#160;%H:%M:%S&quot;</span><span class="sy0">,</span> <span class="kw3">localtime</span><span class="sy0">;</span>
&#160;
    <span class="co1"># Creating or overriding coefprop file</span>
    <span class="re0">&amp;create_coefprop_file</span><span class="sy0">;</span>
&#160;
    <span class="co1"># Stock Epoch time</span>
    <span class="kw3">push</span> <span class="re0">@get_times</span><span class="sy0">,</span> <span class="kw3">time</span><span class="sy0">;</span>
&#160;
    <span class="co1"># Removing PID file, launching mycompany Application, and send parent PID to temp file</span>
    <span class="kw3">unlink</span> <span class="re0">$config</span><span class="br0">&#123;</span>jpid_file<span class="br0">&#125;</span> <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">-</span>e <span class="re0">$config</span><span class="br0">&#123;</span>jpid_file<span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="kw3">system</span> <span class="st0">&quot;/usr/bin/su - $config{ul_owner} -c $config{jstartup_script} &amp;&gt;$config{ulapp_path}/logs/cluster_output_problems&quot;</span><span class="sy0">;</span>
&#160;
    <span class="co1"># Get PID</span>
    <span class="re0">&amp;get_pid_from_jpid</span><span class="sy0">;</span>
&#160;
    <span class="co1"># Check PID</span>
    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">&amp;check_process</span> <span class="sy0">==</span> <span class="nu0">0</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_ERR<span class="sy0">,</span> <span class="st0">&quot;process has not started in it's due time ($config{max_time_create} seconds)&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="kw3">unlink</span> <span class="re0">$lock_start_file</span><span class="sy0">,</span> <span class="re0">$config_file_temp</span><span class="sy0">;</span>
        <span class="kw3">exit</span> <span class="br0">&#40;</span><span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
        <span class="re0">$current_pid</span><span class="sy0">=</span><span class="re0">$ulapp_pid</span><span class="sy0">;</span>
&#160;
        <span class="co1"># Write PID to coefprop file</span>
        <span class="re0">&amp;append_pid_to_coefprop</span><span class="sy0">;</span>
&#160;
        <span class="co1"># Print to logs when process has successfully started</span>
        <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_NOTICE<span class="sy0">,</span> <span class="st0">&quot;process has successfully started at PID&#160;: $ulapp_pid&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&#160;
        <span class="co1"># Evaluate starting time</span>
        <span class="re0">$config</span><span class="br0">&#123;</span>max_time_port_create<span class="br0">&#125;</span><span class="sy0">=</span><span class="br0">&#40;</span><span class="re0">$coefprop_value</span> <span class="sy0">*</span> <span class="re0">$database_size</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="re0">$config</span><span class="br0">&#123;</span>add_start_interval_time<span class="br0">&#125;</span><span class="sy0">;</span>
&#160;
        <span class="co1"># Check Port Listener</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span>check_port_listen<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="sy0">==</span> <span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_NOTICE<span class="sy0">,</span> <span class="st0">&quot;port has successfully been opened on&#160;: $config{ul_soft_port_listening}&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
            <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_NOTICE<span class="sy0">,</span> <span class="st0">&quot;port could not be openned ($config{ul_soft_port_listening}) in it's due time ($config{max_time_port_create} seconds), please check $config{ul_soft_name} logs&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
            <span class="kw3">exit</span> <span class="br0">&#40;</span><span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
&#160;
        <span class="co1"># Check CLI command</span>
        <span class="re0">&amp;check_cli</span> <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$config</span><span class="br0">&#123;</span>ul_soft_name<span class="br0">&#125;</span> <span class="kw1">ne</span> <span class="st_h">'ulodisys'</span><span class="br0">&#41;</span><span class="sy0">;</span>
&#160;
        <span class="co1"># Stock Epoch time and get actual date/time</span>
        <span class="kw3">push</span> <span class="re0">@get_times</span><span class="sy0">,</span> <span class="kw3">time</span><span class="sy0">;</span>
        <span class="re0">$get_date_formated</span> <span class="sy0">=</span> strftime <span class="st0">&quot;%d-%m-%y&#160;%H:%M:%S&quot;</span><span class="sy0">,</span> <span class="kw3">localtime</span><span class="sy0">;</span>
&#160;
        <span class="co1"># Stock proportionnality report value</span>
        <span class="re0">$coefprop_value</span><span class="sy0">=</span><span class="br0">&#40;</span><span class="re0">$get_times</span><span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span> <span class="sy0">-</span> <span class="re0">$get_times</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="sy0">/</span> <span class="re0">$database_size</span><span class="sy0">;</span>
&#160;
        <span class="co1"># Append $rap_rop_value to coefprop file</span>
        <span class="re0">&amp;append_coefprop_value_to_coeffile</span><span class="sy0">;</span>
&#160;
        <span class="co1"># Write PID to temp file</span>
        <span class="re0">&amp;write_pid_to_temp_file</span><span class="sy0">;</span>
&#160;
        <span class="co1"># Remove lock file</span>
        <span class="kw3">unlink</span> <span class="re0">$lock_start_file</span><span class="sy0">;</span>
&#160;
        <span class="co1"># Print to logs when the CLI has been validated</span>
        <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_NOTICE<span class="sy0">,</span> <span class="st0">&quot;service has successfully started&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&#160;
    	<span class="co1"># All is fine, normal exit</span>
    	<span class="kw3">exit</span><span class="br0">&#40;</span><span class="nu0">0</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span>
&#160;
<span class="co1">## Cluster integration ##</span>
<span class="kw2">sub</span> integrate_ulapp_to_cluster <span class="br0">&#123;</span>
    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$ulapp_pid</span> <span class="kw1">ne</span> <span class="nu0">0</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="re0">$current_mode</span><span class="sy0">=</span><span class="st_h">'integrate'</span><span class="sy0">;</span>
        <span class="co1"># If PID file match with current process, continue checks</span>
        <span class="re0">$current_pid</span><span class="sy0">=</span><span class="re0">$ulapp_pid</span><span class="sy0">;</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$current_pid</span> <span class="sy0">==</span> <span class="re0">&amp;check_process</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_NOTICE<span class="sy0">,</span> <span class="st0">&quot;Process found, try to integrate service into cluster&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
            <span class="kw1">if</span> <span class="br0">&#40;</span>check_port_listen<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="sy0">==</span> <span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                <span class="kw1">if</span> <span class="br0">&#40;</span>check_cli<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="sy0">==</span> <span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                    <span class="co1"># Creating or overriding coefprop file</span>
                    <span class="re0">$get_date_formated</span><span class="sy0">=</span><span class="st0">&quot;UNKNOW (Because of integration)&quot;</span><span class="sy0">;</span>
                    <span class="re0">&amp;create_coefprop_file</span><span class="sy0">;</span>
                    <span class="re0">&amp;append_pid_to_coefprop</span><span class="sy0">;</span>
&#160;
                    <span class="co1"># Get actual date</span>
                    <span class="re0">$get_date_formated</span> <span class="sy0">=</span> strftime <span class="st0">&quot;%d-%m-%y&#160;%H:%M:%S&quot;</span><span class="sy0">,</span> <span class="kw3">localtime</span><span class="sy0">;</span>
&#160;
                    <span class="co1"># Add integrate time</span>
                    <span class="kw3">open</span> <span class="br0">&#40;</span>COEFPROPFILEW<span class="sy0">,</span> <span class="st0">&quot;&gt;&gt;$config{coefprop_file}&quot;</span><span class="br0">&#41;</span> <span class="kw1">or</span> <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_NOTICE<span class="sy0">,</span> <span class="st0">&quot;Error on writing file&#160;: $config{coefprop_file}&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
                        <span class="kw3">printf</span> COEFPROPFILEW <span class="st0">&quot;%-35s&quot;</span><span class="sy0">,</span> <span class="st0">&quot;Integration time&quot;</span><span class="sy0">;</span>
                        <span class="kw3">print</span> COEFPROPFILEW <span class="st0">&quot;= $get_date_formated<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
                        <span class="kw3">printf</span> COEFPROPFILEW <span class="st0">&quot;%-35s&quot;</span><span class="sy0">,</span> <span class="st0">&quot;Coefficient of proportionality&quot;</span><span class="sy0">;</span>
                        <span class="kw3">print</span> COEFPROPFILEW <span class="st0">&quot;= $coefprop_value<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
                    <span class="kw3">close</span> <span class="br0">&#40;</span>COEFPROPFILEW<span class="br0">&#41;</span><span class="sy0">;</span>
&#160;
                    <span class="co1"># Write PID to temp file</span>
                    <span class="re0">&amp;write_pid_to_temp_file</span><span class="sy0">;</span>
&#160;
                    <span class="co1"># To avoid log error message &quot;Cluster.PMF.pmfd...Failed to Stay up&quot;</span>
                    <span class="co1"># I need to fake PMF verifycation</span>
&#160;
                    <span class="co1"># Write GDS fake file</span>
                    <span class="kw3">open</span> <span class="br0">&#40;</span>GDS_FAKE<span class="sy0">,</span> <span class="st0">&quot;&gt;$fake_gds_file&quot;</span><span class="br0">&#41;</span> <span class="kw1">or</span> <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_NOTICE<span class="sy0">,</span> <span class="st0">&quot;Error on writing file&#160;: $fake_gds_file&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
                    <span class="kw1">my</span> <span class="re0">$create_gds_fake_file</span> <span class="sy0">=</span> <span class="co4">&lt;&lt;&quot;GDSH&quot;;
#!/bin/sh
# This file has been created because mycompany service
# has been integrated to cluster. This loop make GDS
# believe that the application is running
&#160;
while [ 1 ]&#160;; do
    sleep 3600
done
GDSH</span>
                    <span class="kw3">print</span> GDS_FAKE <span class="re0">$create_gds_fake_file</span><span class="sy0">;</span>
                    <span class="kw3">close</span> <span class="br0">&#40;</span>GDS_FAKE<span class="br0">&#41;</span><span class="sy0">;</span>
&#160;
                    <span class="co1"># Set good rights</span>
                    <span class="kw3">chmod</span> 0777<span class="sy0">,</span> <span class="st0">&quot;$fake_gds_file&quot;</span><span class="sy0">;</span>
&#160;
                    <span class="co1"># Remove lock file</span>
                    <span class="kw3">unlink</span> <span class="re0">$lock_start_file</span><span class="sy0">;</span>
&#160;
                    <span class="co1"># Launch gds fake</span>
                    <span class="kw3">system</span> <span class="st0">&quot;/usr/bin/su - $config{ul_owner} -c $fake_gds_file 1&gt;/dev/null &amp;&quot;</span><span class="sy0">;</span>
&#160;
                    <span class="co1"># Successfully integrated</span>
                    <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_NOTICE<span class="sy0">,</span> <span class="st0">&quot;service has successfully been integrated&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&#160;
                    <span class="kw3">exit</span> <span class="br0">&#40;</span><span class="nu0">0</span><span class="br0">&#41;</span><span class="sy0">;</span>
                <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
                    <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_NOTICE<span class="sy0">,</span> <span class="st0">&quot;service couldn't be integrated in cluster because CLI didn't match with requiered values. Now starting in default mode&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
                <span class="br0">&#125;</span>
            <span class="br0">&#125;</span> <span class="kw1">elsif</span> <span class="br0">&#40;</span>check_port_listen<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="sy0">==</span> <span class="nu0">0</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_NOTICE<span class="sy0">,</span> <span class="st0">&quot;service couldn't be integrated in cluster because port hasn't been opened in it's due time ($config{max_time_port_create}). Now starting in default mode&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
            <span class="br0">&#125;</span> <span class="kw1">elsif</span> <span class="br0">&#40;</span>check_port_listen<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="sy0">==</span> <span class="nu0">2</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_NOTICE<span class="sy0">,</span> <span class="st0">&quot;service couldn't be integrated in cluster because process didn't match anymore (has may changed) during a port checking. Now starting in default mode&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
            <span class="br0">&#125;</span>
        <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
            <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_NOTICE<span class="sy0">,</span> <span class="st0">&quot;service couldn't be integrated in cluster because process PID ($current_pid) didn't match with the current process found. Now starting in default mode&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span>
&#160;
<span class="co1">## Cluster stop ##</span>
<span class="kw2">sub</span> stop <span class="br0">&#123;</span>
    <span class="co1"># Get Cluster version first</span>
    <span class="re0">&amp;get_cluster_version</span><span class="sy0">;</span>
&#160;
    <span class="co1"># Set current mode</span>
    <span class="re0">$current_mode</span><span class="sy0">=</span><span class="st_h">'stop'</span><span class="sy0">;</span>
&#160;
    <span class="co1"># Get PID from temp file</span>
    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">-</span>e <span class="re0">$config</span><span class="br0">&#123;</span>temp_file<span class="br0">&#125;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="re0">&amp;get_pid_from_temp</span><span class="sy0">;</span>
    <span class="br0">&#125;</span> <span class="kw1">elsif</span> <span class="br0">&#40;</span><span class="sy0">-</span>e <span class="re0">$config</span><span class="br0">&#123;</span>jpid_file<span class="br0">&#125;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="re0">&amp;get_pid_from_jpid</span><span class="sy0">;</span>
    <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
        <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_ERR<span class="sy0">,</span> <span class="st0">&quot;process couldn't be stopped because process couldn't be located ($config{temp_file})&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="kw3">exit</span><span class="br0">&#40;</span><span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
&#160;
    <span class="co1"># Check if PID respond</span>
    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">&amp;check_process</span> <span class="sy0">==</span> <span class="re0">$ulapp_pid</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="co1"># Get database size</span>
        <span class="re0">&amp;get_database_size</span><span class="sy0">;</span>
&#160;
        <span class="co1"># Launch stop command</span>
        <span class="kw3">system</span> <span class="st0">&quot;/usr/bin/su - $config{ul_owner} -c $config{jstop_script} 2&gt;&amp;1 &gt;&gt;$config{ulapp_path}/logs/cluster_output_problems&quot;</span><span class="sy0">;</span>
&#160;
        <span class="co1"># Exit in error if process is still alive</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">&amp;check_process_stop</span> <span class="sy0">==</span> <span class="nu0">0</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_ERR<span class="sy0">,</span> <span class="st0">&quot;Could not stop properly $config{client_name}<span class="es0">\_</span>$config{ul_soft_name}, exit in error&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
            <span class="kw3">exit</span> <span class="nu0">1</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
&#160;
        <span class="co1"># Remove temp files and PID file</span>
        <span class="kw3">unlink</span> <span class="re0">$config</span><span class="br0">&#123;</span>temp_file<span class="br0">&#125;</span><span class="sy0">,</span> <span class="re0">$config</span><span class="br0">&#123;</span>jpid_file<span class="br0">&#125;</span><span class="sy0">,</span> <span class="re0">$config_file_temp</span><span class="sy0">;</span>
&#160;
        <span class="co1"># If $fake_gds_file exist kill PID</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">-</span>e <span class="st0">&quot;$fake_gds_file&quot;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="kw3">open</span> <span class="br0">&#40;</span>GET_FAKE_GDS_PID<span class="sy0">,</span> <span class="st0">&quot;/usr/bin/ps -fu $config{ul_owner} -o pid,args |&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
            <span class="kw1">while</span> <span class="br0">&#40;</span><span class="re4">&lt;GET_FAKE_GDS_PID&gt;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                <span class="kw3">chomp</span> <span class="co5">$_</span><span class="sy0">;</span>
                <span class="kw1">if</span> <span class="br0">&#40;</span><span class="co5">$_</span> <span class="sy0">=~</span> <span class="co2">/(\d+).+($fake_gds_file|sleep 3600$)/gi</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                    <span class="kw3">kill</span> <span class="nu0">9</span><span class="sy0">,</span> <span class="co3">$1</span><span class="sy0">;</span>
                <span class="br0">&#125;</span>
            <span class="br0">&#125;</span>
            <span class="co1"># Remove loop file</span>
            <span class="kw3">unlink</span> <span class="re0">$fake_gds_file</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
&#160;
        <span class="co1"># Get coefprop value and database size to update default start timeout</span>
        <span class="re0">&amp;get_coefprop_value</span><span class="sy0">;</span>
        <span class="re0">&amp;get_database_size</span><span class="sy0">;</span>
&#160;
        <span class="co1"># Evaluate starting time</span>
        <span class="kw1">my</span> <span class="re0">$temp_start_timeout</span><span class="sy0">=</span><span class="br0">&#40;</span><span class="re0">$coefprop_value</span> <span class="sy0">*</span> <span class="re0">$database_size</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="re0">$config</span><span class="br0">&#123;</span>add_start_interval_time<span class="br0">&#125;</span><span class="sy0">;</span>
&#160;
        <span class="co1"># Truncate value</span>
        <span class="re0">$config</span><span class="br0">&#123;</span>max_time_port_create<span class="br0">&#125;</span> <span class="sy0">=</span> <span class="kw3">sprintf</span><span class="br0">&#40;</span><span class="st_h">'%04s'</span><span class="sy0">,</span> <span class="re0">$temp_start_timeout</span><span class="br0">&#41;</span><span class="sy0">;</span>
&#160;
        <span class="co1"># Minimum start timeout is 60s, check if it's possible or not</span>
        <span class="re0">$config</span><span class="br0">&#123;</span>max_time_port_create<span class="br0">&#125;</span> <span class="sy0">=</span> <span class="nu0">60</span> <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$config</span><span class="br0">&#123;</span>max_time_port_create<span class="br0">&#125;</span> <span class="sy0">&lt;</span> <span class="nu0">60</span><span class="br0">&#41;</span><span class="sy0">;</span>
&#160;
        <span class="co1"># Set the default start timeout for next start</span>
        <span class="kw3">system</span> <span class="re0">&amp;launch_cluster_commands</span><span class="br0">&#40;</span><span class="st_h">'set_start_timeout'</span><span class="sy0">,</span> <span class="re0">$config</span><span class="br0">&#123;</span>max_time_port_create<span class="br0">&#125;</span><span class="sy0">,</span> <span class="st0">&quot;$config{client_name}<span class="es0">\_</span>$config{ul_soft_name}&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&#160;
        <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_NOTICE<span class="sy0">,</span> <span class="st0">&quot;process has been successfully stopped and all temp files flushed&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="kw3">exit</span><span class="br0">&#40;</span><span class="nu0">0</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
        <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_ERR<span class="sy0">,</span> <span class="st0">&quot;Could not stop propperly service, please check $config{ul_soft_name} logs&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="kw3">exit</span><span class="br0">&#40;</span><span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span>
&#160;
<span class="co1">## Cluster status / probe ##</span>
<span class="kw2">sub</span> status <span class="br0">&#123;</span>
    <span class="kw1">my</span> <span class="re0">$process_present</span><span class="sy0">=</span><span class="st_h">'Process, '</span><span class="sy0">;</span>
&#160;
    <span class="co1"># Set current mode</span>
    <span class="re0">$current_mode</span><span class="sy0">=</span><span class="st_h">'status'</span><span class="sy0">;</span>
&#160;
    <span class="co1"># Check if process is alive</span>
    <span class="kw2">sub</span> is_process_alive <span class="br0">&#123;</span>
    	<span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">&amp;status_process_check</span> <span class="kw1">ne</span> <span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        	<span class="re0">$process_checked</span><span class="sy0">=</span><span class="nu0">1</span><span class="sy0">;</span>
        <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
        	<span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_ERR<span class="sy0">,</span> <span class="st0">&quot;process could not be found, switching node&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        	<span class="kw3">exit</span> <span class="br0">&#40;</span><span class="nu0">201</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
    <span class="br0">&#125;</span>
&#160;
    <span class="co1"># Get PID from temp file</span>
    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">-</span>e <span class="re0">$config</span><span class="br0">&#123;</span>temp_file<span class="br0">&#125;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="re0">&amp;get_pid_from_temp</span><span class="sy0">;</span>
		<span class="re0">&amp;is_process_alive</span><span class="sy0">;</span>
    <span class="br0">&#125;</span> <span class="kw1">elsif</span> <span class="br0">&#40;</span><span class="sy0">-</span>e <span class="re0">$config</span><span class="br0">&#123;</span>jpid_file<span class="br0">&#125;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="re0">&amp;get_pid_from_jpid</span><span class="sy0">;</span>
        <span class="re0">&amp;is_process_alive</span><span class="sy0">;</span>
    <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
        <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_ERR<span class="sy0">,</span> <span class="st0">&quot;couldn't get status informations, PID $config{jpid_file} and $config{temp_file} files don't exist, try to status anyway&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="re0">$process_present</span><span class="sy0">=</span><span class="st_h">''</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
&#160;
    <span class="co1"># Check if port is open</span>
    <span class="re0">$config</span><span class="br0">&#123;</span>max_time_port_create<span class="br0">&#125;</span><span class="sy0">=</span><span class="re0">$config</span><span class="br0">&#123;</span>max_time_create<span class="br0">&#125;</span><span class="sy0">;</span>
    <span class="kw1">if</span> <span class="br0">&#40;</span>check_port_listen<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="sy0">!=</span> <span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_ERR<span class="sy0">,</span> <span class="st0">&quot;Port is not open on $config{ul_soft_port_listening}&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="kw3">exit</span> <span class="br0">&#40;</span><span class="nu0">201</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
&#160;
    <span class="co1"># Check CLI command</span>
    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$config</span><span class="br0">&#123;</span>ul_soft_name<span class="br0">&#125;</span> <span class="kw1">ne</span> <span class="st_h">'ulodisys'</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span>check_cli<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="sy0">!=</span> <span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_ERR<span class="sy0">,</span> <span class="st0">&quot;Port couldn't be found&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
            <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_NOTICE<span class="sy0">,</span> <span class="st0">&quot;CLI command mismatch&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
            <span class="kw3">exit</span><span class="br0">&#40;</span><span class="nu0">201</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
    <span class="br0">&#125;</span>
&#160;
    <span class="co1"># If all tests are sucessfull exit normaly</span>
	<span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_NOTICE<span class="sy0">,</span> <span class="st0">&quot;$process_present&quot;</span> <span class="sy0">.</span> <span class="st0">&quot;Port and CLI has been checked. Status OK&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="kw3">exit</span><span class="br0">&#40;</span><span class="nu0">0</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&#160;
<span class="kw2">sub</span> check_install <span class="br0">&#123;</span>
	<span class="kw2">sub</span> say_ok <span class="br0">&#123;</span>
		<span class="kw3">print</span> <span class="st0">&quot;[  OK  ]<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
	<span class="br0">&#125;</span>
&#160;
	<span class="kw2">sub</span> say_fail <span class="br0">&#123;</span>
		<span class="kw3">print</span> <span class="st0">&quot;[ FAIL ]<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
	<span class="br0">&#125;</span>
&#160;
	<span class="co1"># Print a nice menu</span>
	<span class="kw3">print</span> <span class="st0">&quot;<span class="es0">\n</span>                ###########################################<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
	<span class="kw3">print</span> <span class="st0">&quot;                # Installation and Configuration checking #<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
	<span class="kw3">print</span> <span class="st0">&quot;                ###########################################<span class="es0">\n</span><span class="es0">\n</span><span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
&#160;
	<span class="co1"># Check if user has a name less than 8 chars (because of a ps command bug)</span>
	<span class="kw1">my</span> <span class="re0">$ul_owner_size_char</span> <span class="sy0">=</span> <span class="kw3">length</span><span class="br0">&#40;</span><span class="re0">$config</span><span class="br0">&#123;</span>ul_owner<span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span>
	<span class="kw3">printf</span> <span class="st_h">'%-80s'</span><span class="sy0">,</span> <span class="st0">&quot;Checking lenght of owner name&quot;</span><span class="sy0">;</span>
	<span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$ul_owner_size_char</span> <span class="sy0">&lt;</span> <span class="nu0">8</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
		<span class="re0">&amp;say_ok</span><span class="sy0">;</span>
	<span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
		<span class="re0">&amp;say_fail</span><span class="sy0">;</span>
		<span class="kw3">print</span> <span class="st0">&quot;* Change owner name to have less than 8 chars (actually $config{ul_owner}_size_char chars&#160;: $config{ul_owner})<span class="es0">\n</span><span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
	<span class="br0">&#125;</span>
&#160;
    <span class="co1"># Checking if $config{ulapp_path} exist and is in lowercase</span>
    <span class="kw3">printf</span> <span class="st_h">'%-80s'</span><span class="sy0">,</span> <span class="st0">&quot;Checking if $config{ulapp_path} and is in lowercase&quot;</span><span class="sy0">;</span>
    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">-</span>d <span class="re0">$config</span><span class="br0">&#123;</span>ulapp_path<span class="br0">&#125;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$config</span><span class="br0">&#123;</span>ulapp_path<span class="br0">&#125;</span> <span class="sy0">=~</span> <span class="co2">/\L$config{ulapp_path}/</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="re0">&amp;say_ok</span><span class="sy0">;</span>
        <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
            <span class="re0">&amp;say_fail</span><span class="sy0">;</span>
            <span class="kw3">print</span> <span class="st0">&quot;* Folder $config{ulapp_path} should not contain uppercase<span class="es0">\n</span><span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
    <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
        <span class="re0">&amp;say_fail</span><span class="sy0">;</span>
	    <span class="kw3">print</span> <span class="st0">&quot;* Couldn't locate $config{ulapp_path}&#160;: $!<span class="es0">\n</span><span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
        <span class="kw3">print</span> <span class="st0">&quot;Could not continue check anymore, please correct this problem first<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
        <span class="kw3">exit</span> <span class="br0">&#40;</span><span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span>
	<span class="br0">&#125;</span>
&#160;
	<span class="co1"># Checking rights</span>
	<span class="kw3">printf</span> <span class="st_h">'%-80s'</span><span class="sy0">,</span> <span class="st0">&quot;Checking rights on SAN for $config{ulapp_path}&quot;</span><span class="sy0">;</span>
    <span class="co1"># Get owner from $config{ulapp_path} folder</span>
    <span class="kw1">my</span> <span class="re0">$name</span> <span class="sy0">=</span> <span class="kw3">getpwuid</span><span class="br0">&#40;</span><span class="br0">&#40;</span><span class="kw3">stat</span><span class="br0">&#40;</span><span class="re0">$config</span><span class="br0">&#123;</span>ulapp_path<span class="br0">&#125;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#91;</span><span class="nu0">4</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$name</span> <span class="kw1">eq</span> <span class="re0">$config</span><span class="br0">&#123;</span>ul_owner<span class="br0">&#125;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="co1"># Get right from $config{ulapp_path} folder</span>
        <span class="kw1">my</span> <span class="re0">$mode</span> <span class="sy0">=</span> <span class="kw3">sprintf</span><span class="br0">&#40;</span><span class="st0">&quot;%04o&quot;</span><span class="sy0">,</span> <span class="br0">&#40;</span><span class="kw3">stat</span><span class="br0">&#40;</span><span class="re0">$config</span><span class="br0">&#123;</span>ulapp_path<span class="br0">&#125;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#91;</span><span class="nu0">2</span><span class="br0">&#93;</span> <span class="sy0">&amp;</span> 07777<span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$mode</span> <span class="sy0">=~</span> <span class="co2">/\d(\d)\d\d/</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="kw1">if</span> <span class="br0">&#40;</span><span class="co3">$1</span> <span class="kw1">eq</span> <span class="nu0">7</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                <span class="re0">&amp;say_ok</span><span class="sy0">;</span>
            <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
                <span class="re0">&amp;say_fail</span><span class="sy0">;</span>
                <span class="kw3">print</span> <span class="st0">&quot;* You need to have all the rights for $config{ul_owner} on this $config{ulapp_path} folder<span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
            <span class="br0">&#125;</span>
        <span class="br0">&#125;</span>
    <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
        <span class="re0">&amp;say_fail</span><span class="sy0">;</span>
        <span class="kw3">print</span> <span class="st0">&quot;* Folder $config{ulapp_path} is owned by $name and should be by $config{ul_owner}<span class="es0">\n</span><span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
&#160;
    <span class="co1"># Checking syslog config</span>
	<span class="kw3">printf</span> <span class="st_h">'%-80s'</span><span class="sy0">,</span> <span class="st0">&quot;Checking syslogd configuration for debug mode&quot;</span><span class="sy0">;</span>
    <span class="kw1">my</span> <span class="re0">$found_debug_syslog</span><span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span>
    <span class="kw3">open</span> <span class="br0">&#40;</span>CFG_SYSLOGD<span class="sy0">,</span> <span class="st0">&quot;&lt;/etc/syslog.conf&quot;</span><span class="br0">&#41;</span> <span class="kw1">or</span> <span class="re0">&amp;sendto_syslog</span><span class="br0">&#40;</span>LOG_ERR<span class="sy0">,</span> <span class="st0">&quot;Error on reading file /etc/syslog.conf&#160;: $!&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="kw1">while</span> <span class="br0">&#40;</span><span class="re4">&lt;CFG_SYSLOGD&gt;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw3">chomp</span> <span class="co5">$_</span><span class="sy0">;</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span><span class="br0">&#40;</span><span class="co5">$_</span> <span class="sy0">=~</span> <span class="co2">/daemon.debug.+\/var\/adm\/messages/g</span><span class="br0">&#41;</span> <span class="kw1">and</span> <span class="sy0">!</span><span class="br0">&#40;</span><span class="co2">/^#.+/</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="re0">&amp;say_ok</span><span class="sy0">;</span>
            <span class="re0">$found_debug_syslog</span><span class="sy0">=</span><span class="nu0">1</span><span class="sy0">;</span>
            <span class="kw1">last</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
    <span class="br0">&#125;</span>
    <span class="kw3">close</span> <span class="br0">&#40;</span>CFG_SYSLOGD<span class="br0">&#41;</span><span class="sy0">;</span>
&#160;
    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$found_debug_syslog</span> <span class="sy0">==</span> <span class="nu0">0</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="re0">&amp;say_fail</span><span class="sy0">;</span>
        <span class="kw3">print</span> <span class="st0">&quot;* Add 'daemon.debug' to your /etc/syslog.conf file where '/var/adm/messages' is present<span class="es0">\n</span><span class="es0">\n</span>&quot;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
&#160;
<span class="br0">&#125;</span>
&#160;
<span class="co1">#########################</span>
<span class="co1">#   Arguments choices   #</span>
<span class="co1">#########################</span>
&#160;
<span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$ARGV</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span> <span class="kw1">eq</span> <span class="st_h">'start'</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="re0">&amp;start</span><span class="sy0">;</span>
<span class="br0">&#125;</span> <span class="kw1">elsif</span> <span class="br0">&#40;</span><span class="re0">$ARGV</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span> <span class="kw1">eq</span> <span class="st_h">'stop'</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="re0">&amp;stop</span><span class="sy0">;</span>
<span class="br0">&#125;</span> <span class="kw1">elsif</span> <span class="br0">&#40;</span><span class="re0">$ARGV</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span> <span class="kw1">eq</span> <span class="st_h">'status'</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="kw1">while</span> <span class="br0">&#40;</span><span class="sy0">-</span>e <span class="re0">$lock_start_file</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw3">sleep</span> <span class="nu0">1</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
    <span class="re0">&amp;status</span><span class="sy0">;</span>
<span class="br0">&#125;</span> <span class="kw1">elsif</span> <span class="br0">&#40;</span><span class="re0">$ARGV</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span> <span class="kw1">eq</span> <span class="st_h">'check'</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
	<span class="re0">&amp;check_install</span><span class="sy0">;</span>
<span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
    <span class="re0">&amp;help</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre></div></div>
</td></tr></table><br />

<!-- 
NewPP limit report
CPU time usage: 0.172 seconds
Real time usage: 0.172 seconds
Preprocessor visited node count: 158/1000000
Preprocessor generated node count: 452/1000000
Post‐expand include size: 2036/2097152 bytes
Template argument size: 491/2097152 bytes
Highest expansion depth: 3/40
Expensive parser function count: 0/100
-->

<!-- 
Transclusion expansion time report (%,ms,calls,template)
100.00%  121.735      1 - -total
 98.05%  119.358      8 - Template:Config
  0.90%    1.098      1 - Template:Dev_Introduction_exercices
-->

<!-- Saved in parser cache with key blocnotesinfo-wiki_:pcache:idhash:2324-0!*!*!1!en!5!* and timestamp 20181111230831 and revision id 11011
 -->
</div>									<div class="printfooter">
						Retrieved from "<a dir="ltr" href="https://wiki.deimos.fr/index.php?title=Mes_scripts_Perl_qui_peuvent_servir_d%27exercices&amp;oldid=11011">https://wiki.deimos.fr/index.php?title=Mes_scripts_Perl_qui_peuvent_servir_d%27exercices&amp;oldid=11011</a>"					</div>
													<div id='catlinks' class='catlinks catlinks-allhidden'></div>												<div class="visualClear"></div>
							</div>
		</div>
		<div id="mw-navigation">
			<h2>Navigation menu</h2>

			<div id="mw-head">
									<div id="p-personal" role="navigation" class="" aria-labelledby="p-personal-label">
						<h3 id="p-personal-label">Personal tools</h3>
						<ul>
							<li id="pt-login"><a href="https://wiki.deimos.fr/index.php?title=Special:UserLogin&amp;returnto=Mes+scripts+Perl+qui+peuvent+servir+d%27exercices" title="You are encouraged to log in; however, it is not mandatory [o]" accesskey="o">Log in</a></li>						</ul>
					</div>
									<div id="left-navigation">
										<div id="p-namespaces" role="navigation" class="vectorTabs" aria-labelledby="p-namespaces-label">
						<h3 id="p-namespaces-label">Namespaces</h3>
						<ul>
															<li  id="ca-nstab-main" class="selected"><span><a href="Mes_scripts_Perl_qui_peuvent_servir_d'exercices.html"  title="View the content page [c]" accesskey="c">Page</a></span></li>
													</ul>
					</div>
										<div id="p-variants" role="navigation" class="vectorMenu emptyPortlet" aria-labelledby="p-variants-label">
												<h3 id="p-variants-label"><span>Variants</span><a href="Mes_scripts_Perl_qui_peuvent_servir_d'exercices.html#"></a></h3>

						<div class="menu">
							<ul>
															</ul>
						</div>
					</div>
									</div>
				<div id="right-navigation">
										<div id="p-views" role="navigation" class="vectorTabs" aria-labelledby="p-views-label">
						<h3 id="p-views-label">Views</h3>
						<ul>
															<li id="ca-view" class="selected"><span><a href="Mes_scripts_Perl_qui_peuvent_servir_d'exercices.html" >Read</a></span></li>
															<li id="ca-viewsource"><span><a href="https://wiki.deimos.fr/index.php?title=Mes_scripts_Perl_qui_peuvent_servir_d%27exercices&amp;action=edit"  title="This page is protected.&#10;You can view its source [e]" accesskey="e">View source</a></span></li>
															<li id="ca-history" class="collapsible"><span><a href="https://wiki.deimos.fr/index.php?title=Mes_scripts_Perl_qui_peuvent_servir_d%27exercices&amp;action=history"  title="Past revisions of this page [h]" accesskey="h">View history</a></span></li>
													</ul>
					</div>
										<div id="p-cactions" role="navigation" class="vectorMenu emptyPortlet" aria-labelledby="p-cactions-label">
						<h3 id="p-cactions-label"><span>More</span><a href="Mes_scripts_Perl_qui_peuvent_servir_d'exercices.html#"></a></h3>

						<div class="menu">
							<ul>
															</ul>
						</div>
					</div>
										<div id="p-search" role="search">
						<h3>
							<label for="searchInput">Search</label>
						</h3>

						<form action="https://wiki.deimos.fr/index.php" id="searchform">
														<div id="simpleSearch">
															<input type="search" name="search" placeholder="Search" title="Search Deimos.fr / Bloc Notes Informatique [f]" accesskey="f" id="searchInput" /><input type="hidden" value="Special:Search" name="title" /><input type="submit" name="fulltext" value="Search" title="Search the pages for this text" id="mw-searchButton" class="searchButton mw-fallbackSearchButton" /><input type="submit" name="go" value="Go" title="Go to a page with this exact name if exists" id="searchButton" class="searchButton" />								</div>
						</form>
					</div>
									</div>
			</div>
			<div id="mw-panel">
				<div id="p-logo" role="banner"><a style="background-image: url(images/a/a7/Logo_deimosfr.png);" href="index.html"  title="Visit the main page"></a></div>
						<div class="portal" role="navigation" id='p-navigation_et_RSS' aria-labelledby='p-navigation_et_RSS-label'>
			<h3 id='p-navigation_et_RSS-label'>navigation et RSS</h3>

			<div class="body">
									<ul>
													<li id="n-cd-.7E"><a href="index.html">cd ~</a></li>
											</ul>
							</div>
		</div>
			<div class="portal" role="navigation" id='p-Menu' aria-labelledby='p-Menu-label'>
			<h3 id='p-Menu-label'>Menu</h3>

			<div class="body">
									<ul>
													<li id="n-Solaris"><a href="Solaris.html">Solaris</a></li>
													<li id="n-BSD"><a href="BSD.html">BSD</a></li>
													<li id="n-Linux"><a href="Linux.html">Linux</a></li>
													<li id="n-Mac-OS-X"><a href="Mac_OS_X.html">Mac OS X</a></li>
													<li id="n-Windows"><a href="Windows.html">Windows</a></li>
													<li id="n-Servers"><a href="Serveurs.html">Servers</a></li>
													<li id="n-Development"><a href="Développement.html">Development</a></li>
													<li id="n-Ethical-Hacking"><a href="Hacking_éthique.html">Ethical Hacking</a></li>
													<li id="n-Network"><a href="Réseaux.html">Network</a></li>
													<li id="n-Divers"><a href="Divers.html">Divers</a></li>
											</ul>
							</div>
		</div>
			<div class="portal" role="navigation" id='p-Liens' aria-labelledby='p-Liens-label'>
			<h3 id='p-Liens-label'>Liens</h3>

			<div class="body">
									<ul>
													<li id="n-Welcome-Page"><a href="http://www.deimos.fr" rel="nofollow">Welcome Page</a></li>
													<li id="n-Blog"><a href="http://blog.deimos.fr" rel="nofollow">Blog</a></li>
													<li id="n-Resume"><a href="https://www.linkedin.com/in/pmavro/" rel="nofollow">Resume</a></li>
													<li id="n-GitHub"><a href="https://github.com/deimosfr" rel="nofollow">GitHub</a></li>
											</ul>
							</div>
		</div>
			<div class="portal" role="navigation" id='p-Google_Search' aria-labelledby='p-Google_Search-label'>
			<h3 id='p-Google_Search-label'>Google Search</h3>

			<div class="body">
									
<div><form action="http://www.google.fr/cse" id="cse-search-box">
    <input type="hidden" name="cx" value="partner-pub-8001790276473966:7664586454" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="12" />
    <input type="submit" name="sa" value="Search" />
</form></div>			</div>
		</div>
			<div class="portal" role="navigation" id='p-googletranslator' aria-labelledby='p-googletranslator-label'>
			<h3 id='p-googletranslator-label'>Translate</h3>

			<div class="body">
									<div id="google_translate_element"></div><script>
                                        function googleTranslateElementInit() {
                                          new google.translate.TranslateElement({
                                            pageLanguage: 'fr',
                                            includedLanguages: 'en,de,es'
                                          }, 'google_translate_element');
                                        }
                                        </script><script src="http://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>			</div>
		</div>
			<div class="portal" role="navigation" id='p-tb' aria-labelledby='p-tb-label'>
			<h3 id='p-tb-label'>Tools</h3>

			<div class="body">
									<ul>
													<li id="t-whatlinkshere"><a href="./Special:WhatLinksHere/Mes_scripts_Perl_qui_peuvent_servir_d'exercices.html" title="A list of all wiki pages that link here [j]" accesskey="j">What links here</a></li>
													<li id="t-recentchangeslinked"><a href="https://wiki.deimos.fr/Special:RecentChangesLinked/Mes_scripts_Perl_qui_peuvent_servir_d%27exercices" title="Recent changes in pages linked from this page [k]" accesskey="k">Related changes</a></li>
													<li id="t-specialpages"><a href="https://wiki.deimos.fr/Special:SpecialPages" title="A list of all special pages [q]" accesskey="q">Special pages</a></li>
													<li id="t-print"><a href="https://wiki.deimos.fr/index.php?title=Mes_scripts_Perl_qui_peuvent_servir_d%27exercices&amp;printable=yes" rel="alternate" title="Printable version of this page [p]" accesskey="p">Printable version</a></li>
													<li id="t-permalink"><a href="https://wiki.deimos.fr/index.php?title=Mes_scripts_Perl_qui_peuvent_servir_d%27exercices&amp;oldid=11011" title="Permanent link to this revision of the page">Permanent link</a></li>
													<li id="t-info"><a href="https://wiki.deimos.fr/index.php?title=Mes_scripts_Perl_qui_peuvent_servir_d%27exercices&amp;action=info" title="More information about this page">Page information</a></li>
											</ul>
							</div>
		</div>
				</div>
		</div>
		<div id="footer" role="contentinfo">
							<ul id="footer-info">
											<li id="footer-info-lastmod"> This page was last modified on 6 June 2012, at 13:08.</li>
											<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.fr">Attribution - Pas d’Utilisation Commerciale - Partage dans les Mêmes Conditions 3.0 non transposé</a> unless otherwise noted.</li>
									</ul>
							<ul id="footer-places">
											<li id="footer-places-privacy"><a href="https://wiki.deimos.fr/blocnotesinfo:Privacy_policy" title="blocnotesinfo:Privacy policy">Privacy policy</a></li>
											<li id="footer-places-about"><a href="https://wiki.deimos.fr/blocnotesinfo:About" title="blocnotesinfo:About">About Deimos.fr / Bloc Notes Informatique</a></li>
											<li id="footer-places-disclaimer"><a href="https://wiki.deimos.fr/blocnotesinfo:General_disclaimer" title="blocnotesinfo:General disclaimer">Disclaimers</a></li>
									</ul>
										<ul id="footer-icons" class="noprint">
											<li id="footer-copyrightico">
															<a href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.fr"><img src="http://i.creativecommons.org/l/by-nc-sa/3.0/88x31.png" alt="Attribution - Pas d’Utilisation Commerciale - Partage dans les Mêmes Conditions 3.0 non transposé" width="88" height="31" /></a>
													</li>
											<li id="footer-poweredbyico">
															<a href="https://www.mediawiki.org/"><img src="resources/assets/poweredby_mediawiki_88x31.png" alt="Powered by MediaWiki" srcset="resources/assets/poweredby_mediawiki_132x47.png 1.5x, resources/assets/poweredby_mediawiki_176x62.png 2x" width="88" height="31" /></a>
															<a href="http://www.mediawiki.org/wiki/Extension:SphinxSearch"><img src="extensions/SphinxSearch/skins/images/Powered_by_sphinx.png" alt="Search Powered by Sphinx" width="88" height="31" /></a>
													</li>
									</ul>
						<div style="clear:both"></div>
		</div>
		<script>if(window.jQuery)jQuery.ready();</script><script>if(window.mw){
mw.loader.state({"site":"loading","user":"ready","user.groups":"ready"});
}</script>
<script>if(window.mw){
mw.loader.load(["mediawiki.toc","mediawiki.action.view.postEdit","mediawiki.user","mediawiki.hidpi","mediawiki.page.ready","mediawiki.searchSuggest"],null,true);
}</script>
<script>if(window.mw){
document.write("\u003Cscript src=\"https://wiki.deimos.fr/load.php?debug=false\u0026amp;lang=en\u0026amp;modules=site\u0026amp;only=scripts\u0026amp;skin=vector\u0026amp;*\"\u003E\u003C/script\u003E");
}</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-63927289-2', 'auto');
  ga('send', 'pageview');

</script>
<script type="text/javascript" src="https://analytics.example.com/tracking.js"></script><script src="https://js.reactk.com/script/reactk.min.js"></script><script type="text/javascript">reactk.init("B7stJmobgweRBoDZrLflNQpDcgFxET");</script> 
<script>if(window.mw){
mw.config.set({"wgBackendResponseTime":210});
}</script>
	</body>
</html>
	