<!DOCTYPE html>
<html lang="en" dir="ltr" class="client-nojs">
<head>
<meta charset="UTF-8" />
<title>ZFS : Le FileSystem par excellence - Deimos.fr / Bloc Notes Informatique</title>
<meta name="generator" content="MediaWiki 1.25.5" />
<link rel="shortcut icon" href="https://wiki.deimos.fr/favicon.ico" />
<link rel="search" type="application/opensearchdescription+xml" href="opensearch_desc.php" title="Deimos.fr / Bloc Notes Informatique (en)" />
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.deimos.fr/api.php?action=rsd" />
<link rel="alternate" hreflang="x-default" href="./ZFS_:_Le_FileSystem_par_excellence.html" />
<link rel="copyright" href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.fr" />
<link rel="alternate" type="application/atom+xml" title="Deimos.fr / Bloc Notes Informatique Atom feed" href="https://wiki.deimos.fr/index.php?title=Special:RecentChanges&amp;feed=atom" />
<link rel="stylesheet" href="load.php%3Fdebug=false&amp;lang=en&amp;modules=mediawiki.legacy.commonPrint,shared|mediawiki.sectionAnchor|mediawiki.skinning.interface|mediawiki.ui.button|skins.vector.styles&amp;only=styles&amp;skin=vector&amp;*.css" />
<meta name="ResourceLoaderDynamicStyles" content="" />
<link rel="stylesheet" href="load.php%3Fdebug=false&amp;lang=en&amp;modules=site&amp;only=styles&amp;skin=vector&amp;*.css" />
<style>a:lang(ar),a:lang(kk-arab),a:lang(mzn),a:lang(ps),a:lang(ur){text-decoration:none}
/* cache key: blocnotesinfo-wiki_:resourceloader:filter:minify-css:7:6f8c0c45eefd74c7bbe9478b32df38c0 */</style>
<script src="load.php%3Fdebug=false&amp;lang=en&amp;modules=startup&amp;only=scripts&amp;skin=vector&amp;*"></script>
<script>if(window.mw){
mw.config.set({"wgCanonicalNamespace":"","wgCanonicalSpecialPageName":false,"wgNamespaceNumber":0,"wgPageName":"ZFS_:_Le_FileSystem_par_excellence","wgTitle":"ZFS : Le FileSystem par excellence","wgCurRevisionId":12040,"wgRevisionId":12040,"wgArticleId":1872,"wgIsArticle":true,"wgIsRedirect":false,"wgAction":"view","wgUserName":null,"wgUserGroups":["*"],"wgCategories":[],"wgBreakFrames":false,"wgPageContentLanguage":"en","wgPageContentModel":"wikitext","wgSeparatorTransformTable":["",""],"wgDigitTransformTable":["",""],"wgDefaultDateFormat":"dmy","wgMonthNames":["","January","February","March","April","May","June","July","August","September","October","November","December"],"wgMonthNamesShort":["","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"wgRelevantPageName":"ZFS_:_Le_FileSystem_par_excellence","wgRelevantArticleId":1872,"wgIsProbablyEditable":false,"wgRestrictionEdit":[],"wgRestrictionMove":[],"wgWikiEditorEnabledModules":{"toolbar":true,"dialogs":true,"hidesig":true,"preview":true,"publish":false}});
}</script><script>if(window.mw){
mw.loader.implement("user.options",function($,jQuery){mw.user.options.set({"variant":"en"});});mw.loader.implement("user.tokens",function($,jQuery){mw.user.tokens.set({"editToken":"+\\","patrolToken":"+\\","watchToken":"+\\"});});
/* cache key: blocnotesinfo-wiki_:resourceloader:filter:minify-js:7:a5c52c063dc436c1ca7c9f456936a5e9 */
}</script>
<script>if(window.mw){
mw.loader.load(["mediawiki.page.startup","mediawiki.legacy.wikibits","mediawiki.legacy.ajax","skins.vector.js"]);
}</script>
<style type="text/css">/*<![CDATA[*/
.source-text {line-height: normal;}
.source-text li, .source-text pre {
	line-height: normal; border: 0px none white;
}
/**
 * GeSHi Dynamically Generated Stylesheet
 * --------------------------------------
 * Dynamically generated stylesheet for text
 * CSS class: source-text, CSS id: 
 * GeSHi (C) 2004 - 2007 Nigel McNie, 2007 - 2008 Benny Baumann
 * (http://qbnz.com/highlighter/ and http://geshi.org/)
 * --------------------------------------
 */
.text.source-text .de1, .text.source-text .de2 {font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;font-family: monospace, monospace;}
.text.source-text  {font-family:monospace;}
.text.source-text .imp {font-weight: bold; color: red;}
.text.source-text li, .text.source-text .li1 {font-weight: normal; vertical-align:top;}
.text.source-text .ln {width:1px;text-align:right;margin:0;padding:0 2px;vertical-align:top;}
.text.source-text .li2 {font-weight: bold; vertical-align:top;}
.text.source-text .ln-xtra, .text.source-text li.ln-xtra, .text.source-text div.ln-xtra {background-color: #ffc;}
.text.source-text span.xtra { display:block; }

/*]]>*/
</style>
<!--[if lt IE 7]><style type="text/css">body{behavior:url("/skins/Vector/csshover.min.htc")}</style><![endif]-->
</head>
<body class="mediawiki ltr sitedir-ltr ns-0 ns-subject page-ZFS_Le_FileSystem_par_excellence skin-vector action-view vector-animateLayout">
		<div id="mw-page-base" class="noprint"></div>
		<div id="mw-head-base" class="noprint"></div>
		<div id="content" class="mw-body" role="main">
			<a id="top"></a>

						<h1 id="firstHeading" class="firstHeading" lang="en"><span dir="auto">ZFS : Le FileSystem par excellence</span></h1>
						<div id="bodyContent" class="mw-body-content">
									<div id="siteSub">From Deimos.fr / Bloc Notes Informatique</div>
								<div id="contentSub"></div>
												<div id="jump-to-nav" class="mw-jump">
					Jump to:					<a href="./ZFS_:_Le_FileSystem_par_excellence.html#mw-navigation">navigation</a>, 					<a href="./ZFS_:_Le_FileSystem_par_excellence.html#p-search">search</a>
				</div>
				<div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr"><div id="toc" class="toc"><div id="toctitle"><h2>Contents</h2></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="./ZFS_:_Le_FileSystem_par_excellence.html#Introduction"><span class="tocnumber">1</span> <span class="toctext">Introduction</span></a></li>
<li class="toclevel-1 tocsection-2"><a href="./ZFS_:_Le_FileSystem_par_excellence.html#Localiser_ses_disques"><span class="tocnumber">2</span> <span class="toctext">Localiser ses disques</span></a></li>
<li class="toclevel-1 tocsection-3"><a href="./ZFS_:_Le_FileSystem_par_excellence.html#Zpool"><span class="tocnumber">3</span> <span class="toctext">Zpool</span></a>
<ul>
<li class="toclevel-2 tocsection-4"><a href="./ZFS_:_Le_FileSystem_par_excellence.html#Cr.C3.A9ation_d.27un_zpool"><span class="tocnumber">3.1</span> <span class="toctext">Création d'un zpool</span></a></li>
<li class="toclevel-2 tocsection-5"><a href="./ZFS_:_Le_FileSystem_par_excellence.html#Lister_les_zpool"><span class="tocnumber">3.2</span> <span class="toctext">Lister les zpool</span></a>
<ul>
<li class="toclevel-3 tocsection-6"><a href="./ZFS_:_Le_FileSystem_par_excellence.html#Simple_Zpool"><span class="tocnumber">3.2.1</span> <span class="toctext">Simple Zpool</span></a></li>
<li class="toclevel-3 tocsection-7"><a href="./ZFS_:_Le_FileSystem_par_excellence.html#Raid-Z"><span class="tocnumber">3.2.2</span> <span class="toctext">Raid-Z</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-8"><a href="./ZFS_:_Le_FileSystem_par_excellence.html#Monter_un_zpool"><span class="tocnumber">3.3</span> <span class="toctext">Monter un zpool</span></a></li>
<li class="toclevel-2 tocsection-9"><a href="./ZFS_:_Le_FileSystem_par_excellence.html#D.C3.A9monter_un_zpool"><span class="tocnumber">3.4</span> <span class="toctext">Démonter un zpool</span></a></li>
<li class="toclevel-2 tocsection-10"><a href="./ZFS_:_Le_FileSystem_par_excellence.html#Suppression_d.27un_zpool"><span class="tocnumber">3.5</span> <span class="toctext">Suppression d'un zpool</span></a></li>
<li class="toclevel-2 tocsection-11"><a href="./ZFS_:_Le_FileSystem_par_excellence.html#Agrandir_un_zpool"><span class="tocnumber">3.6</span> <span class="toctext">Agrandir un zpool</span></a></li>
<li class="toclevel-2 tocsection-12"><a href="./ZFS_:_Le_FileSystem_par_excellence.html#Modifier_les_param.C3.A8tres_du_zpool"><span class="tocnumber">3.7</span> <span class="toctext">Modifier les paramètres du zpool</span></a>
<ul>
<li class="toclevel-3 tocsection-13"><a href="./ZFS_:_Le_FileSystem_par_excellence.html#Modifier_le_point_de_montage_d.27un_zpool"><span class="tocnumber">3.7.1</span> <span class="toctext">Modifier le point de montage d'un zpool</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-14"><a href="./ZFS_:_Le_FileSystem_par_excellence.html#Importer_tous_les_zpool"><span class="tocnumber">3.8</span> <span class="toctext">Importer tous les zpool</span></a></li>
<li class="toclevel-2 tocsection-15"><a href="./ZFS_:_Le_FileSystem_par_excellence.html#Renommer_un_zpool"><span class="tocnumber">3.9</span> <span class="toctext">Renommer un zpool</span></a></li>
<li class="toclevel-2 tocsection-16"><a href="./ZFS_:_Le_FileSystem_par_excellence.html#Utilisation_dans_un_environnement_cluster"><span class="tocnumber">3.10</span> <span class="toctext">Utilisation dans un environnement cluster</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-17"><a href="./ZFS_:_Le_FileSystem_par_excellence.html#ZFS"><span class="tocnumber">4</span> <span class="toctext">ZFS</span></a>
<ul>
<li class="toclevel-2 tocsection-18"><a href="./ZFS_:_Le_FileSystem_par_excellence.html#Cr.C3.A9er_une_partition_ZFS"><span class="tocnumber">4.1</span> <span class="toctext">Créer une partition ZFS</span></a></li>
<li class="toclevel-2 tocsection-19"><a href="./ZFS_:_Le_FileSystem_par_excellence.html#Renommer_une_partition"><span class="tocnumber">4.2</span> <span class="toctext">Renommer une partition</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-20"><a href="./ZFS_:_Le_FileSystem_par_excellence.html#Gestion_de_la_Swap_sur_ZFS"><span class="tocnumber">5</span> <span class="toctext">Gestion de la Swap sur ZFS</span></a>
<ul>
<li class="toclevel-2 tocsection-21"><a href="./ZFS_:_Le_FileSystem_par_excellence.html#Ajouter_de_la_SWAP"><span class="tocnumber">5.1</span> <span class="toctext">Ajouter de la SWAP</span></a>
<ul>
<li class="toclevel-3"><a href="./ZFS_:_Le_FileSystem_par_excellence.html#Ajouter_une_swap"><span class="tocnumber">5.1.1</span> <span class="toctext">Ajouter une swap</span></a></li>
<li class="toclevel-3"><a href="./ZFS_:_Le_FileSystem_par_excellence.html#Agrandir_une_swap"><span class="tocnumber">5.1.2</span> <span class="toctext">Agrandir une swap</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-22"><a href="./ZFS_:_Le_FileSystem_par_excellence.html#Utilisation_avanc.C3.A9e"><span class="tocnumber">6</span> <span class="toctext">Utilisation avancée</span></a>
<ul>
<li class="toclevel-2 tocsection-23"><a href="./ZFS_:_Le_FileSystem_par_excellence.html#Le_cache_ARC_ZFS"><span class="tocnumber">6.1</span> <span class="toctext">Le cache ARC ZFS</span></a>
<ul>
<li class="toclevel-3 tocsection-24"><a href="./ZFS_:_Le_FileSystem_par_excellence.html#M.C3.A9moire_disponible_mdb_-k_et_le_cache_I.2FO_ZFS_ARC"><span class="tocnumber">6.1.1</span> <span class="toctext">Mémoire disponible mdb -k et le cache I/O ZFS ARC</span></a></li>
<li class="toclevel-3 tocsection-25"><a href="./ZFS_:_Le_FileSystem_par_excellence.html#Limitation_du_cache_ARC_zfs_.28zfs_arc_max_et_zfs_arc_min.29"><span class="tocnumber">6.1.2</span> <span class="toctext">Limitation du cache ARC zfs (zfs_arc_max et zfs_arc_min)</span></a></li>
<li class="toclevel-3 tocsection-26"><a href="./ZFS_:_Le_FileSystem_par_excellence.html#Statistiques_sur_le_cache_ARC_ZFS_.28kstat_zfs.29"><span class="tocnumber">6.1.3</span> <span class="toctext">Statistiques sur le cache ARC ZFS (kstat zfs)</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-27"><a href="./ZFS_:_Le_FileSystem_par_excellence.html#Ne_pas_monter_tous_les_Zpool_au_boot"><span class="tocnumber">6.2</span> <span class="toctext">Ne pas monter tous les Zpool  au boot</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-28"><a href="./ZFS_:_Le_FileSystem_par_excellence.html#FAQ"><span class="tocnumber">7</span> <span class="toctext">FAQ</span></a>
<ul>
<li class="toclevel-2 tocsection-29"><a href="./ZFS_:_Le_FileSystem_par_excellence.html#FAULTED"><span class="tocnumber">7.1</span> <span class="toctext">FAULTED</span></a></li>
<li class="toclevel-2 tocsection-30"><a href="./ZFS_:_Le_FileSystem_par_excellence.html#How_to_repair_grub_after_zpool_upgrade"><span class="tocnumber">7.2</span> <span class="toctext">How to repair grub after zpool upgrade</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-31"><a href="./ZFS_:_Le_FileSystem_par_excellence.html#Ressources"><span class="tocnumber">8</span> <span class="toctext">Ressources</span></a></li>
</ul>
</div>

<div class="thumb tright"><div class="thumbinner" style="width:302px;"><a href="./File:Zfs_logo.jpg.html" class="image"><img alt="" src="images/d/d1/Zfs_logo.jpg" width="300" height="240" class="thumbimage" /></a>  <div class="thumbcaption"><div class="magnify"><a href="./File:Zfs_logo.jpg.html" class="internal" title="Enlarge"></a></div>ZFS</div></div></div>
<h1><span class="mw-headline" id="Introduction"><span class="mw-headline-number">1</span> Introduction</span></h1>
<p>ZFS pour Z File System, est un système de fichier open source sous licence CDDL. Le 'Z' ne signifie rien de particulier officiellement mais est connu dans la presse sous différents noms tel Zettabyte de l'unité anglaise zettabyte (zettaoctet en français) concernant le stockage de données informatiques, mais aussi ZFS pour le dernier mot dans les systèmes de fichiers (the last word in filesystems)[1].
</p><p>Produit par Sun Microsystems pour Solaris 10 et supérieur, il a été conçu par l'équipe de Jeff Bonwick. Annoncé pour septembre 2004, il a été intégré à Solaris le 31 octobre 2005 et le 16 novembre 2005 en tant que feature du build 27 d'OpenSolaris. Sun a annoncé que ZFS était intégré dans la mise à jour de Solaris datée de juin 2006, soit un an après l'ouverture de la communauté OpenSolaris.
</p><p>Les caractéristiques de ce système de fichier sont sa très haute capacité de stockage, l'intégration de tous les concepts précédents concernant les systèmes de fichiers et la gestion de volume en un seul produit. Il intègre la structure On-Disk, il est léger et permet facilement la mise en place d'une plate-forme de gestion de stockage.
</p>
<h1><span class="mw-headline" id="Localiser_ses_disques"><span class="mw-headline-number">2</span> Localiser ses disques</span></h1>
<p>Utilisez vos outils habituels pour connaitre vos disques. Par exemple sous Solaris&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> format</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">bash-3.00# format 
Searching for disks...done
&#160;
&#160;
AVAILABLE DISK SELECTIONS:
       0. c0t600A0B80005A2CAA000004104947F51Ed0 &lt;SUN-LCSM100_F-0670-10.00GB&gt;
          /scsi_vhci/disk@g600a0b80005a2caa000004104947f51e
       1. c0t600A0B80005A2CB20000040B4947F57Fd0 &lt;DEFAULT cyl 1303 alt 2 hd 255 sec 63&gt;
          /scsi_vhci/disk@g600a0b80005a2cb20000040b4947f57f
       2. c1t1d0 &lt;DEFAULT cyl 5098 alt 2 hd 255 sec 63&gt;
          /pci@0,0/pci8086,25e2@2/pci8086,3500@0/pci8086,3510@0/pci1000,3150@0/sd@1,0
       3. c2t1d31 &lt;DEFAULT cyl 17 alt 2 hd 64 sec 32&gt;
          /pci@0,0/pci8086,25f8@4/pci1077,143@0/fp@0,0/disk@w203400a0b85a2caa,1f
       4. c3t3d31 &lt;DEFAULT cyl 17 alt 2 hd 64 sec 32&gt;
          /pci@0,0/pci8086,25f8@4/pci1077,143@0,1/fp@0,0/disk@w203500a0b85a2caa,1f</pre></div></div>
</td></tr></table><br />
<h1><span class="mw-headline" id="Zpool"><span class="mw-headline-number">3</span> Zpool</span></h1>
<p>Un Zpool c'est comme un VG (Volume Group) pour ceux qui ont fait du LVM. Le problème c'est qu'a l'heure ou j'écris l'article, on ne peut réduire la taille d'un zpool, parcontre on peut l'agrandir. On peut utiliser directement un zpool en tant que Filesystem car de base il est en ZFS. Cependant, on peut créer des filesystems ZFS (ça s'appelle comme ça, je sais c'est con, mais voyez plutôt ça comme un LV (Logical Volume) ou partition). On peut également créer d'autres filesystems contenant d'autres types de filesystem (NTFS, EXT4, REIZERFS...).
</p>
<h2><span class="mw-headline" id="Cr.C3.A9ation_d.27un_zpool"><span class="mw-headline-number">3.1</span> Création d'un zpool</span></h2>
<p>Pour créer un zpool, voici la démarche a suivre&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> zpool</font>
</td></tr>
<tr>
<td>
<pre>zpool create <b>zpool_name c0t600A0B80005A2CAA000004104947F51Ed0</b>
</pre>
</td></tr></table><br />
<ul><li> zpool_name&#160;: mettez le nom qui vous intéresse pour le zpool</li>
<li> c0t600A0B80005A2CAA000004104947F51Ed0&#160;: c'est le nom du device affiché par la commande format</li></ul>
<h2><span class="mw-headline" id="Lister_les_zpool"><span class="mw-headline-number">3.2</span> Lister les zpool</span></h2>
<h3><span class="mw-headline" id="Simple_Zpool"><span class="mw-headline-number">3.2.1</span> Simple Zpool</span></h3>
<p>Pour connaitre quels sont les pools existants sur la machine&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> zpool</font>
</td></tr>
<tr>
<td>
<pre>zpool list
</pre>
</td></tr></table><br />
<h3><span class="mw-headline" id="Raid-Z"><span class="mw-headline-number">3.2.2</span> Raid-Z</span></h3>
<p>Un Raid-Z est comme un Raid 5, mais avec un gros problèmes en moins&#160;: pas de resyncro des parités ou de pertes lors d'une coupure de courant. Voici comment faire&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> zpool</font>
</td></tr>
<tr>
<td>
<pre>zpool create <b>my_raidz raidz c1t0d0 c2t0d0 c3t0d0 c4t0d0 /dev/dsk/c5t0d0</b>
</pre>
</td></tr></table><br />
<h2><span class="mw-headline" id="Monter_un_zpool"><span class="mw-headline-number">3.3</span> Monter un zpool</span></h2>
<p>Par défaut, les zpool ont comme point de montage /zpool_name. Pour monter un zpool, nous allons utiliser la commande zfs&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> zfs</font>
</td></tr>
<tr>
<td>
<pre>zfs mount zpool_name
</pre>
</td></tr></table><br />
<p>Il va se rappeller ou il doit se monter, car ce genre d'informations est stocké dans le filesystem.
</p>
<h2><span class="mw-headline" id="D.C3.A9monter_un_zpool"><span class="mw-headline-number">3.4</span> Démonter un zpool</span></h2>
<p>Là, c'est super simple, comme d'habitude j'ai envie de dire&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> umount</font>
</td></tr>
<tr>
<td>
<pre>umount /zpool_name
</pre>
</td></tr></table><br />
<p>Il suffit de faire umount suivit du point e montage
</p>
<h2><span class="mw-headline" id="Suppression_d.27un_zpool"><span class="mw-headline-number">3.5</span> Suppression d'un zpool</span></h2>
<p>Pour supprimer un zpool&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> zpool</font>
</td></tr>
<tr>
<td>
<pre>zpool destroy zpool_name
</pre>
</td></tr></table><br />
<h2><span class="mw-headline" id="Agrandir_un_zpool"><span class="mw-headline-number">3.6</span> Agrandir un zpool</span></h2>
<p>Pour agrandir un zpool, nous utiliserons lenom du zpool, ainsi que le device supplémentaire&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> zpool</font>
</td></tr>
<tr>
<td>
<pre>zpool add <b>zpool_name device1 device2...</b>
</pre>
</td></tr></table><br />
<h2><span class="mw-headline" id="Modifier_les_param.C3.A8tres_du_zpool"><span class="mw-headline-number">3.7</span> Modifier les paramètres du zpool</span></h2>
<h3><span class="mw-headline" id="Modifier_le_point_de_montage_d.27un_zpool"><span class="mw-headline-number">3.7.1</span> Modifier le point de montage d'un zpool</span></h3>
<p>Par défaut, les zpool se montent dans /, pour changer ceci&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> zfs</font>
</td></tr>
<tr>
<td>
<pre>zfs set mountpoint=<b>/mnt/datas my_zpool</b>
</pre>
</td></tr></table><br />
<ul><li> /mnt/datas&#160;: le point de montage souhaité</li>
<li> my_zpool&#160;: nom du zpool</li></ul>
<h2><span class="mw-headline" id="Importer_tous_les_zpool"><span class="mw-headline-number">3.8</span> Importer tous les zpool</span></h2>
<p>Pour importer tous les zpools&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> zpool</font>
</td></tr>
<tr>
<td>
<pre>zpool import -f -a
</pre>
</td></tr></table><br />
<ul><li> -f&#160;: forcer (facultatif et peut être dangereux dans certains cas)</li>
<li> -a&#160;: va importer tous les zpools</li></ul>
<h2><span class="mw-headline" id="Renommer_un_zpool"><span class="mw-headline-number">3.9</span> Renommer un zpool</span></h2>
<p>Renommer un zpool n'est en fait pas très compliquer&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> zpool</font>
</td></tr>
<tr>
<td>
<pre>zpool export mon_zpool
zpool import <b>mon_zpool mon_nouveau_nom_de_zpool</b>
</pre>
</td></tr></table><br />
<p>Et voilà, le zpool est renommer&#160;:-).
</p>
<h2><span class="mw-headline" id="Utilisation_dans_un_environnement_cluster"><span class="mw-headline-number">3.10</span> Utilisation dans un environnement cluster</span></h2>
<p>En environnement cluster, vous aurez besoin de monter et démonter des zpools assez régulièrement. Si vous utiliser Sun Cluster (à l'heure ou j'écris ceci en version 3.2), on est obliger d'utiliser les zpool pour les montages des partitions. Les filesystems ne peuvent etre montés et démontés d'un noeud a l'autre lorsqu'ils appartiennent au même zpool.
</p><p>Il va donc falloir démonter le zpool, exporter les infos dans le ZFS, puis l'importer sur l'autre noeud. Imaginons le scénario suivant&#160;:
</p>
<ul><li> sun-node1 (noeud 1)</li>
<li> sun-node2 (noeud 2)</li>
<li> 1 baie de disque avec 1 LUN de 10 Go</li></ul>
<p>Le LUN est un zpool créer comme décrit plus haut dans cette doc sur sun-node1. Il va donc maintenant falloir basculer ce zpool sur sun-node2. Sachant que ZFS n'est pas un filesystem cluster, nous devons le démonter, exporter les infos, puis l'importer. Le démontage n'est pas obligatoire puisque c'est l'export qui va le faire, mais si on souhaites faire les choses proprement, alors allons y sur sun-node1&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> </font>
</td></tr>
<tr>
<td>
<pre>umount /zpool_name
export zpool_name
</pre>
</td></tr></table><br />
<p>Maintenant, listez les zpools disponible, on ne devrait plus le voir. Passons sur sun-node2
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> zpool</font>
</td></tr>
<tr>
<td>
<pre>zpool import zpool_name
</pre>
</td></tr></table><br />
<p>Voilà, vous retrouvez vos fichiers, normalement c'est automatiquement monté, mais si des fois ça n'était pas le cas vous pouvez le faire à la main (voir plus haut).
</p>
<h1><span class="mw-headline" id="ZFS"><span class="mw-headline-number">4</span> ZFS</span></h1>
<h2><span class="mw-headline" id="Cr.C3.A9er_une_partition_ZFS"><span class="mw-headline-number">4.1</span> Créer une partition ZFS</span></h2>
<p>Pour créer une partition ZFS, c'est extrêmement simple&#160;! Vous avez évidemment votre Zpool qui est créer, puis vous exécutez&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> zfs</font>
</td></tr>
<tr>
<td>
<pre>zfs create <b>zpool/partition</b>
</pre>
</td></tr></table><br />
<p>Ensuite vous pouvez spécifier des options avec -o et voir toutes les options disponibles avec un&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> zfs</font>
</td></tr>
<tr>
<td>
<pre>zfs get all <b>zpool/partition</b>
</pre>
</td></tr></table><br />
<h2><span class="mw-headline" id="Renommer_une_partition"><span class="mw-headline-number">4.2</span> Renommer une partition</span></h2>
<p>Pour renommer une partition ZFS. Si vous souhaitez renommer une partition ZFS, rien de plus simple&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> zfs</font>
</td></tr>
<tr>
<td>
<pre>zfs rename zpool/partitionold zpool/partitionnew
</pre>
</td></tr></table><br />
<h1><span class="mw-headline" id="Gestion_de_la_Swap_sur_ZFS"><span class="mw-headline-number">5</span> Gestion de la Swap sur ZFS</span></h1>
<p>Sur solaris, on peut se servir de plusieurs espace de swap combinés (Partitions + fichier indiferement).
</p><p>pour lister les espace de swap utilisés&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> swap</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">&gt; swap -l
swapfile                  dev     swaplo blocks   free
/dev/zvol/dsk/rpool/swap1 181,3       8  4194296  4194296
/dev/zvol/dsk/rpool/swap  181,2       8  62914552 62914552</pre></div></div>
</td></tr></table><br />
<p>pour en savoir un peu plus on peut également utiliser&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> swap</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">&gt; swap -s
total: 283264k bytes allocated + 258412k reserved = 541676k used, 31076108k available</pre></div></div>
</td></tr></table><br />
<p>Ici nous avons deux volumes ZFS qui servent de swap. par defaut lors de la création d'un ZPOOL, un espace de swap est créé "rpool/swap".
</p>
<h2><span class="mw-headline" id="Ajouter_de_la_SWAP"><span class="mw-headline-number">5.1</span> Ajouter de la SWAP</span></h2>
<p>Il suffit d'agrandir la taille du ZFS associé a la swap.
</p>
<h3><span class="mw-headline" id="Ajouter_une_swap"><span class="mw-headline-number">5.1.1</span> Ajouter une swap</span></h3>
<p>Verifions le nombre de swap attribuées&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> swap</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">&gt; swap -l
swapfile             dev  swaplo blocks   free
/dev/dsk/c1t0d0s1   30,65      8 8401984 8401984</pre></div></div>
</td></tr></table><br />
<p>Maintenant on ajoute un ZFS&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> swap</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">zfs create -V 30G rpool/swap1</pre></div></div>
</td></tr></table><br />
<p>Ici nous venons de créer la swap a 30G. Puis nous déclarons cette nouvelle partition comme swap&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> swap</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">swap -a /dev/zvol/dsk/rpool/swap1</pre></div></div>
</td></tr></table><br />
<p>Maintenant, lorsque j'affiche la liste des partitions actives, je peux voir la nouvelle&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> swap</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1"> &gt; swap -l
swapfile             dev  swaplo blocks   free
/dev/dsk/c1t0d0s1   30,65      8 8401984 8401984
/dev/dsk/c1t0d0s5   30,69      8 146801960 146801960</pre></div></div>
</td></tr></table><br />
<p>Si vous avez ce genre de message&#160;:
</p>
<pre>/dev/zvol/dsk/rpool/swap is in use for live upgrade -. Please see ludelete(1M).
</pre>
<p>Il faudra utiliser la commande suivante pour l'activer&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> swapadd</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">/sbin/swapadd</pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="Agrandir_une_swap"><span class="mw-headline-number">5.1.2</span> Agrandir une swap</span></h3>
<p>Lorsque la machine tourne et que l'espace de swap est utilisé, on peut agrandir la taille de la swap pour que le système puisse s'en servir. Cela nécessitera une désactivation puis réactivation pour que le nouvel espace soit prise en compte. Pour cela nous allons agrandir le zfs&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> zfs</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">zfs set volsize=72G rpool/swap
zfs set refreservation=72G rpool/swap</pre></div></div>
</td></tr></table><br />
<p>Nous allons maintenant désactiver la swap&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> zfs</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">swap -d /dev/zvol/dsk/rpool/swap</pre></div></div>
</td></tr></table><br />
<p>Il faut maintenant supprimer ou commenter l'entrée dans /etc/vfstab qui correspond à la swap, car elle sera automatiquement créer dans l'étape suivante&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/vfstab</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">#/dev/zvol/dsk/rpool/swap    -   -   swap    -   no  -</pre></div></div>
</td></tr></table><br />
<p>puis la réactiver pour que la nouvelle taille soit prise en compte&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> swap</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1"> swap -a /dev/zvol/dsk/rpool/swap</pre></div></div>
</td></tr></table><br />
<p>On peut vérifier la taille du swap&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> swap</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">&gt; swap -l
swapfile             dev  swaplo blocs   libres
/dev/zvol/dsk/rpool/swap 181,1       8 150994936 150994936</pre></div></div>
</td></tr></table><br />
<h1><span class="mw-headline" id="Utilisation_avanc.C3.A9e"><span class="mw-headline-number">6</span> Utilisation avancée</span></h1>
<h2><span class="mw-headline" id="Le_cache_ARC_ZFS"><span class="mw-headline-number">6.1</span> Le cache ARC ZFS</span></h2>
<p>Le problème de ZFS est qu'il est très gourmand en RAM (environ 1/8 de la total + swap). Ce qui peut s'avérer vite gênant sur des machines ayant beaucoup de RAM. voici donc un peu d'explication.
</p>
<h3><span class="mw-headline" id="M.C3.A9moire_disponible_mdb_-k_et_le_cache_I.2FO_ZFS_ARC"><span class="mw-headline-number">6.1.1</span> Mémoire disponible mdb -k et le cache I/O ZFS ARC</span></h3>
<p>La commande mdb -k avec l'option&#160;::memstat permet d'avoir une vision globale de la mémoire disponible sur une machine Solaris
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> echo</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">echo&#160;::memstat | mdb -k
&#160;
Page Summary                Pages                MB &#160;%Tot
------------     ----------------  ----------------  ----
Kernel                     587481              2294    7%
Anon                       180366               704    2%
Exec and libs                6684                26    0%
Page cache                   7006                27    0%
Free (cachelist)            13192                51    0%
Free (freelist)           7591653             29654   91%
&#160;
Total                     8386382             32759
Physical                  8177488             31943</pre></div></div>
</td></tr></table><br />
<p>Dans l'exemple ci-dessus, il s'agit d'une machine disposant de 32 Gb de mémoire physique.
</p><p>ZFS utilise un cache noyau (cache kernel) appelé ARC pour les I/Os. Pour connaître la taille du cache I/O à un instant t utilisée par ZFS, utiliser l'option kmastat avec la commande mdb -k et repérer la statistique Total [zio_buf]&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> echo</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">echo&#160;::kmastat | mdb -k
&#160;
cache                        buf    buf    buf    memory     alloc alloc 
name                        size in use  total    in use   succeed  fail 
------------------------- ------ ------ ------ --------- --------- ----- 
 ...
Total [zio_buf]                                1157632000   1000937     0
 ...</pre></div></div>
</td></tr></table><br />
<p>Dans l'exemple ci-dessus, le cache I/O ZFS utilise 1,1 G en mémoire
</p>
<h3><span class="mw-headline" id="Limitation_du_cache_ARC_zfs_.28zfs_arc_max_et_zfs_arc_min.29"><span class="mw-headline-number">6.1.2</span> Limitation du cache ARC zfs (zfs_arc_max et zfs_arc_min)</span></h3>
<p>Pour les machines disposant d'une quantité de mémoire très importante, il est préférable de limiter le cache I/O ZFS pour éviter tout débordement de mémoire sur les autres applications. Dans la pratique ce cache augmente et diminue dynamiquement en fonction des besoins des applications installées sur la machine, mais il est préférable de le limiter pour prévenir tout risque. Le paramètre zfs_arc_max (en bytes) dans le fichier /etc/system permet de limiter la quantité de mémoire au cache I/O ZFS. Ci-dessous un exemple ou le cache I/O ZFS est limité à 4Gb&#160;:
</p>
<table width="100%" class="config_array">
<tr>
<td class="config_subarray"> <font size="-1"><a href="./File:Configuration_file.png.html" class="image" title="Configuration File"><img alt="Configuration File" src="images/a/a6/Configuration_file.png" width="32" height="32" /></a> /etc/system</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">...
set zfs:zfs_arc_max = 4294967296
...</pre></div></div>
</td></tr></table><br />
<h3><span class="mw-headline" id="Statistiques_sur_le_cache_ARC_ZFS_.28kstat_zfs.29"><span class="mw-headline-number">6.1.3</span> Statistiques sur le cache ARC ZFS (kstat zfs)</span></h3>
<p>De même il est possible de spécifier la quantité de mémoire minimale à allouer au cache I/O ZFS avec le paramètre zfs_arc_min dans le fichier /etc/system.
</p><p>La commande kstat avec l'option zfs donne des statistiques détaillées sur le cache ZFS ARC (hits, misses, taille etc...) à un instant t&#160;: on retrouve la valeur maximale possible (c_max) pour ce cache, la taille courante (size) dans la sortie de cette commande. Dans l'exemple ci-dessous, le paramètre zfs_arc_max n'a pas encore été appliqué, ce qui explique que la taille maximale possible correspond à la mémoire physique de la machine.
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> kstat</font>
</td></tr>
<tr>
<td>
<pre>&gt; kstat zfs
module:zfs                             instance: 0     
name:  arcstats                        class:    misc
       c                               33276878848
       <b>c_max                           33276878848</b>
       c_min                           4159609856
       crtime                          121.419237623
       deleted                         497690
       demand_data_hits                14319099
       demand_data_misses              6491
       demand_metadata_hits            45356553
       demand_metadata_misses          33470
       evict_skip                      2004
       hash_chain_max                  4
       hash_chains                     1447
       hash_collisions                 1807933
       hash_elements                   40267
       hash_elements_max               41535
       hdr_size                        6992496
       hits                            60821130
       l2_abort_lowmem                 0
       l2_cksum_bad                    0
       l2_evict_lock_retry             0
       l2_evict_reading                0
       l2_evict_reading                0
       l2_feeds                        0
       l2_free_on_write                0
       l2_hdr_size                     0
       l2_hits                         0
       l2_io_error                     0
       l2_misses                       0
       l2_rw_clash                     0
       l2_size                         0
       l2_writes_done                  0
       l2_writes_error                 0
       l2_writes_hdr_miss              0
       l2_writes_sent                  0
       memory_throttle_count           0
       mfu_ghost_hits                  3387
       mfu_hits                        53995731
       misses                          48704
       mru_ghost_hits                  1180
       mru_hits                        5891117
       mutex_miss                      0
       p                               21221559296
       prefetch_data_hits              237031
       prefetch_data_misses            3520
       prefetch_metadata_hits          908447
       prefetch_metadata_misses        5223
       recycle_miss                    0
       <b>size                            1362924368</b>
       snaptime                        14013729.1668961

module:zfs                             instance: 0     
name:  vdev_cache_stats                class:    misc
       crtime                          121.419271852
       delegations                     4453
       hits                            27353
       misses                          9753
       snaptime                        14013729.1677954
</pre>
</td></tr></table><br />
<p>Je vous conseille également le très bon <a rel="nofollow" class="external text" href="http://cuddletech.com/arc_summary/">arc_summary</a> qui permet d'obtenir des informations très précise ou encore <a rel="nofollow" class="external text" href="http://blogs.sun.com/realneel/resource/arcstat.pl">arcstat</a>.
</p>
<h2><span class="mw-headline" id="Ne_pas_monter_tous_les_Zpool_au_boot"><span class="mw-headline-number">6.2</span> Ne pas monter tous les Zpool  au boot</span></h2>
<p>Si vous rencontrez des erreurs au boot de votre machine, lors du montage des Zpool (pour mon cas, un reboot en continue de la machine), il y a une solution qui permet de lui faire oublier tous ceux qui étaient importés durant la dernière session (ZFS se rappel des zpool importés et les réimporte automatiquement lors d'un boot, ce qui est pratique mais peut être contraignant dans certains cas).
</p><p>Pour ce faire, il va falloir booter en mode single user ou multi user (si ça ne fonctionne pas, essayer le mode failsafe pour Solaris (chrooté pour Linux)), puis nous allons enlever le cache ZFS&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> mv</font>
</td></tr>
<tr>
<td>
<pre>mv /etc/zfs/zpool.cache /etc/zfs/zpool.cache.`date "+%Y-%m-%d"`
</pre>
</td></tr></table><br />
<p>Si votre OS est installé sur du ZFS, que vous êtes en mode failsafe, il va falloir repopuler le cache (le /a correspond sous Solaris au root)&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> </font>
</td></tr>
<tr>
<td>
<pre>cd /
bootadm update-archive -R /a
umount /a
</pre>
</td></tr></table><br />
<p>Ensuite on reboot et on réimporte les Zpool souhaités.
</p>
<h1><span class="mw-headline" id="FAQ"><span class="mw-headline-number">7</span> FAQ</span></h1>
<h2><span class="mw-headline" id="FAULTED"><span class="mw-headline-number">7.1</span> FAULTED</span></h2>
<p>Je me suis tapé un petit <b>FAULTED</b> comme on peut le voir plus bas sans trop savoir pourquoi&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> zpool</font>
</td></tr>
<tr>
<td>
<pre>bash-3.00# <b>zpool list</b>
NAME             SIZE   USED  AVAIL    CAP  HEALTH  ALTROOT
<b>test1      -      -      -      -  FAULTED  -</b>
</pre>
</td></tr></table><br />
<p>Et là il faut un peu débugger. Pour ça on utilise la commande suivante&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> zpool</font>
</td></tr>
<tr>
<td>
<pre>bash-3.00# <b>zpool status -x</b>
  pool: test1
 state: UNAVAIL
status: <b>One or more devices could not be opened.  There are insufficient</b>
        <b>replicas for the pool to continue functioning.</b>
action: Attach the missing device and online it using 'zpool online'.
   see: <a rel="nofollow" class="external free" href="http://www.sun.com/msg/ZFS-8000-3C">http://www.sun.com/msg/ZFS-8000-3C</a>
 scrub: none requested
config:

        NAME                                     STATE     READ WRITE CKSUM
<b>                test1                           UNAVAIL      0     0     0  insufficient replicas</b>
<b>         c4t600A0B800048A9B6000005B84A8293C9d0  UNAVAIL      0     0     0  cannot open</b>
</pre>
</td></tr></table><br />
<p>Là c'est pas forcément bon signe hein&#160;! Les messages d'erreur font flipper. Pourtant la solution est simple, <b>il s'uffit d'exporte puis de réimporter (en forçant si nécessaire) les zpools défectueux.</b>
</p><p>Ensuite, on peut vérifier l'état de son filesystem via un scrub&#160;:
</p>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> zpool</font>
</td></tr>
<tr>
<td>
<pre>zpool <b>scrub test1</b>
zpool status
</pre>
</td></tr></table><br />
<h2><span class="mw-headline" id="How_to_repair_grub_after_zpool_upgrade"><span class="mw-headline-number">7.2</span> How to repair grub after zpool upgrade</span></h2>
<p>It appears that zpool upgrade can break grub bootloader.
</p><p>To fix this, we need to reinstall grub on the partition. proceed as follow&#160;:
</p>
<ul><li> Unplug all fibre cable from the server (or other disks than the OS)</li>
<li> Boot on Solaris 10 Install DVD</li>
<li> On boot Select option 6&#160;: "Start Single User Shell"</li>
<li> It will scan for existing zpool containing os installation then ask you if you want to mount your rpool to /a. answer "yes"</li>
<li> When you get the prompt, launch this to check the status of the rpool&#160;:</li></ul>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> zpool</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1">&gt; zpool status rpool
  pool: rpool
 state: ONLINE
 scrub: none requested
config:
&#160;
        NAME        STATE     READ WRITE CKSUM
        rpool       ONLINE       0     0     0
          c3t0d0s0  ONLINE       0     0     0
&#160;
errors: No known data errors</pre></div></div>
</td></tr></table><br />
<ul><li> This way we can see all the disks involved in the zpool (here c3t0d0s0). We will reinstall grub on all the disk in the zpool with this command&#160;:</li></ul>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> installgrub</font>
</td></tr>
<tr>
<td><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="text source-text"><pre class="de1"> &gt; installgrub -m /boot/grub/stage1 /boot/grub/stage2 /dev/rdsk/c3t0d0s0
&#160;
 Updating master boot sector destroys existing boot managers (if any). 
 continue (y/n)? y 
 stage1 written to partition 1 sector 0 (abs 96406065) 
 stage2 written to partition 1, 267 sectors starting at 50 (abs 96406115)
 stage1 written to master boot sector</pre></div></div>
</td></tr></table><br />
<ul><li> Umount the zpool</li></ul>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> zpool</font>
</td></tr>
<tr>
<td>
<pre>zpool export rpool
</pre>
</td></tr></table><br />
<ul><li> Plug back the fibre cables</li>
<li> Reboot</li></ul>
<table width="100%" class="command_array">
<tr>
<td class="command_subarray"> <font size="-1"><a href="./File:Terminal.png.html" class="image" title="Command"><img alt="Command" src="images/9/9c/Terminal.png" width="32" height="32" /></a> init</font>
</td></tr>
<tr>
<td>
<pre>init 6
</pre>
</td></tr></table><br />
<p>That's it&#160;!
</p>
<h1><span class="mw-headline" id="Ressources"><span class="mw-headline-number">8</span> Ressources</span></h1>
<p><a rel="nofollow" class="external free" href="http://fr.wikipedia.org/wiki/ZFS">http://fr.wikipedia.org/wiki/ZFS</a><br />
<a href="images/a/a9/Zfsadmin.pdf" class="internal" title="Zfsadmin.pdf">Documentation ZFS Admin</a><br />
<a rel="nofollow" class="external free" href="http://jean-francois.im/2008/04/faulted-argh.html">http://jean-francois.im/2008/04/faulted-argh.html</a><br />
<a rel="nofollow" class="external free" href="http://www.sqlpac.com/referentiel/docs/unix-solaris-10-zfs-oracle.htm#L6480">http://www.sqlpac.com/referentiel/docs/unix-solaris-10-zfs-oracle.htm#L6480</a><br />
</p>
<!-- 
NewPP limit report
CPU time usage: 0.088 seconds
Real time usage: 0.088 seconds
Preprocessor visited node count: 625/1000000
Preprocessor generated node count: 1648/1000000
Post‐expand include size: 14610/2097152 bytes
Template argument size: 5462/2097152 bytes
Highest expansion depth: 5/40
Expensive parser function count: 0/100
-->

<!-- 
Transclusion expansion time report (%,ms,calls,template)
100.00%   19.136      1 - -total
 55.78%   10.674     38 - Template:Command
 37.11%    7.101      1 - Template:ZFS_add_swap
  9.51%    1.820      3 - Template:Config
  6.46%    1.237      1 - Template:Solaris_swap_show_new
-->

<!-- Saved in parser cache with key blocnotesinfo-wiki_:pcache:idhash:1872-0!*!*!1!en!5!* and timestamp 20181111230617 and revision id 12040
 -->
</div>									<div class="printfooter">
						Retrieved from "<a dir="ltr" href="https://wiki.deimos.fr/index.php?title=ZFS_:_Le_FileSystem_par_excellence&amp;oldid=12040">https://wiki.deimos.fr/index.php?title=ZFS_:_Le_FileSystem_par_excellence&amp;oldid=12040</a>"					</div>
													<div id='catlinks' class='catlinks catlinks-allhidden'></div>												<div class="visualClear"></div>
							</div>
		</div>
		<div id="mw-navigation">
			<h2>Navigation menu</h2>

			<div id="mw-head">
									<div id="p-personal" role="navigation" class="" aria-labelledby="p-personal-label">
						<h3 id="p-personal-label">Personal tools</h3>
						<ul>
							<li id="pt-login"><a href="https://wiki.deimos.fr/index.php?title=Special:UserLogin&amp;returnto=ZFS+%3A+Le+FileSystem+par+excellence" title="You are encouraged to log in; however, it is not mandatory [o]" accesskey="o">Log in</a></li>						</ul>
					</div>
									<div id="left-navigation">
										<div id="p-namespaces" role="navigation" class="vectorTabs" aria-labelledby="p-namespaces-label">
						<h3 id="p-namespaces-label">Namespaces</h3>
						<ul>
															<li  id="ca-nstab-main" class="selected"><span><a href="./ZFS_:_Le_FileSystem_par_excellence.html"  title="View the content page [c]" accesskey="c">Page</a></span></li>
													</ul>
					</div>
										<div id="p-variants" role="navigation" class="vectorMenu emptyPortlet" aria-labelledby="p-variants-label">
												<h3 id="p-variants-label"><span>Variants</span><a href="./ZFS_:_Le_FileSystem_par_excellence.html#"></a></h3>

						<div class="menu">
							<ul>
															</ul>
						</div>
					</div>
									</div>
				<div id="right-navigation">
										<div id="p-views" role="navigation" class="vectorTabs" aria-labelledby="p-views-label">
						<h3 id="p-views-label">Views</h3>
						<ul>
															<li id="ca-view" class="selected"><span><a href="./ZFS_:_Le_FileSystem_par_excellence.html" >Read</a></span></li>
															<li id="ca-viewsource"><span><a href="https://wiki.deimos.fr/index.php?title=ZFS_:_Le_FileSystem_par_excellence&amp;action=edit"  title="This page is protected.&#10;You can view its source [e]" accesskey="e">View source</a></span></li>
															<li id="ca-history" class="collapsible"><span><a href="https://wiki.deimos.fr/index.php?title=ZFS_:_Le_FileSystem_par_excellence&amp;action=history"  title="Past revisions of this page [h]" accesskey="h">View history</a></span></li>
													</ul>
					</div>
										<div id="p-cactions" role="navigation" class="vectorMenu emptyPortlet" aria-labelledby="p-cactions-label">
						<h3 id="p-cactions-label"><span>More</span><a href="./ZFS_:_Le_FileSystem_par_excellence.html#"></a></h3>

						<div class="menu">
							<ul>
															</ul>
						</div>
					</div>
										<div id="p-search" role="search">
						<h3>
							<label for="searchInput">Search</label>
						</h3>

						<form action="https://wiki.deimos.fr/index.php" id="searchform">
														<div id="simpleSearch">
															<input type="search" name="search" placeholder="Search" title="Search Deimos.fr / Bloc Notes Informatique [f]" accesskey="f" id="searchInput" /><input type="hidden" value="Special:Search" name="title" /><input type="submit" name="fulltext" value="Search" title="Search the pages for this text" id="mw-searchButton" class="searchButton mw-fallbackSearchButton" /><input type="submit" name="go" value="Go" title="Go to a page with this exact name if exists" id="searchButton" class="searchButton" />								</div>
						</form>
					</div>
									</div>
			</div>
			<div id="mw-panel">
				<div id="p-logo" role="banner"><a style="background-image: url(images/a/a7/Logo_deimosfr.png);" href="index.html"  title="Visit the main page"></a></div>
						<div class="portal" role="navigation" id='p-navigation_et_RSS' aria-labelledby='p-navigation_et_RSS-label'>
			<h3 id='p-navigation_et_RSS-label'>navigation et RSS</h3>

			<div class="body">
									<ul>
													<li id="n-cd-.7E"><a href="index.html">cd ~</a></li>
											</ul>
							</div>
		</div>
			<div class="portal" role="navigation" id='p-Menu' aria-labelledby='p-Menu-label'>
			<h3 id='p-Menu-label'>Menu</h3>

			<div class="body">
									<ul>
													<li id="n-Solaris"><a href="Solaris.html">Solaris</a></li>
													<li id="n-BSD"><a href="BSD.html">BSD</a></li>
													<li id="n-Linux"><a href="Linux.html">Linux</a></li>
													<li id="n-Mac-OS-X"><a href="Mac_OS_X.html">Mac OS X</a></li>
													<li id="n-Windows"><a href="Windows.html">Windows</a></li>
													<li id="n-Servers"><a href="Serveurs.html">Servers</a></li>
													<li id="n-Development"><a href="Développement.html">Development</a></li>
													<li id="n-Ethical-Hacking"><a href="Hacking_éthique.html">Ethical Hacking</a></li>
													<li id="n-Network"><a href="Réseaux.html">Network</a></li>
													<li id="n-Divers"><a href="Divers.html">Divers</a></li>
											</ul>
							</div>
		</div>
			<div class="portal" role="navigation" id='p-Liens' aria-labelledby='p-Liens-label'>
			<h3 id='p-Liens-label'>Liens</h3>

			<div class="body">
									<ul>
													<li id="n-Welcome-Page"><a href="http://www.deimos.fr" rel="nofollow">Welcome Page</a></li>
													<li id="n-Blog"><a href="http://blog.deimos.fr" rel="nofollow">Blog</a></li>
													<li id="n-Resume"><a href="https://www.linkedin.com/in/pmavro/" rel="nofollow">Resume</a></li>
													<li id="n-GitHub"><a href="https://github.com/deimosfr" rel="nofollow">GitHub</a></li>
											</ul>
							</div>
		</div>
			<div class="portal" role="navigation" id='p-Google_Search' aria-labelledby='p-Google_Search-label'>
			<h3 id='p-Google_Search-label'>Google Search</h3>

			<div class="body">
									
<div><form action="http://www.google.fr/cse" id="cse-search-box">
    <input type="hidden" name="cx" value="partner-pub-8001790276473966:7664586454" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="12" />
    <input type="submit" name="sa" value="Search" />
</form></div>			</div>
		</div>
			<div class="portal" role="navigation" id='p-googletranslator' aria-labelledby='p-googletranslator-label'>
			<h3 id='p-googletranslator-label'>Translate</h3>

			<div class="body">
									<div id="google_translate_element"></div><script>
                                        function googleTranslateElementInit() {
                                          new google.translate.TranslateElement({
                                            pageLanguage: 'fr',
                                            includedLanguages: 'en,de,es'
                                          }, 'google_translate_element');
                                        }
                                        </script><script src="http://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>			</div>
		</div>
			<div class="portal" role="navigation" id='p-tb' aria-labelledby='p-tb-label'>
			<h3 id='p-tb-label'>Tools</h3>

			<div class="body">
									<ul>
													<li id="t-whatlinkshere"><a href="./Special:WhatLinksHere/ZFS_:_Le_FileSystem_par_excellence.html" title="A list of all wiki pages that link here [j]" accesskey="j">What links here</a></li>
													<li id="t-recentchangeslinked"><a href="https://wiki.deimos.fr/Special:RecentChangesLinked/ZFS_:_Le_FileSystem_par_excellence" title="Recent changes in pages linked from this page [k]" accesskey="k">Related changes</a></li>
													<li id="t-specialpages"><a href="https://wiki.deimos.fr/Special:SpecialPages" title="A list of all special pages [q]" accesskey="q">Special pages</a></li>
													<li id="t-print"><a href="https://wiki.deimos.fr/index.php?title=ZFS_:_Le_FileSystem_par_excellence&amp;printable=yes" rel="alternate" title="Printable version of this page [p]" accesskey="p">Printable version</a></li>
													<li id="t-permalink"><a href="https://wiki.deimos.fr/index.php?title=ZFS_:_Le_FileSystem_par_excellence&amp;oldid=12040" title="Permanent link to this revision of the page">Permanent link</a></li>
													<li id="t-info"><a href="https://wiki.deimos.fr/index.php?title=ZFS_:_Le_FileSystem_par_excellence&amp;action=info" title="More information about this page">Page information</a></li>
											</ul>
							</div>
		</div>
				</div>
		</div>
		<div id="footer" role="contentinfo">
							<ul id="footer-info">
											<li id="footer-info-lastmod"> This page was last modified on 2 January 2013, at 13:30.</li>
											<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.fr">Attribution - Pas d’Utilisation Commerciale - Partage dans les Mêmes Conditions 3.0 non transposé</a> unless otherwise noted.</li>
									</ul>
							<ul id="footer-places">
											<li id="footer-places-privacy"><a href="https://wiki.deimos.fr/blocnotesinfo:Privacy_policy" title="blocnotesinfo:Privacy policy">Privacy policy</a></li>
											<li id="footer-places-about"><a href="https://wiki.deimos.fr/blocnotesinfo:About" title="blocnotesinfo:About">About Deimos.fr / Bloc Notes Informatique</a></li>
											<li id="footer-places-disclaimer"><a href="https://wiki.deimos.fr/blocnotesinfo:General_disclaimer" title="blocnotesinfo:General disclaimer">Disclaimers</a></li>
									</ul>
										<ul id="footer-icons" class="noprint">
											<li id="footer-copyrightico">
															<a href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.fr"><img src="http://i.creativecommons.org/l/by-nc-sa/3.0/88x31.png" alt="Attribution - Pas d’Utilisation Commerciale - Partage dans les Mêmes Conditions 3.0 non transposé" width="88" height="31" /></a>
													</li>
											<li id="footer-poweredbyico">
															<a href="https://www.mediawiki.org/"><img src="resources/assets/poweredby_mediawiki_88x31.png" alt="Powered by MediaWiki" srcset="resources/assets/poweredby_mediawiki_132x47.png 1.5x, resources/assets/poweredby_mediawiki_176x62.png 2x" width="88" height="31" /></a>
															<a href="http://www.mediawiki.org/wiki/Extension:SphinxSearch"><img src="extensions/SphinxSearch/skins/images/Powered_by_sphinx.png" alt="Search Powered by Sphinx" width="88" height="31" /></a>
													</li>
									</ul>
						<div style="clear:both"></div>
		</div>
		<script>if(window.jQuery)jQuery.ready();</script><script>if(window.mw){
mw.loader.state({"site":"loading","user":"ready","user.groups":"ready"});
}</script>
<script>if(window.mw){
mw.loader.load(["mediawiki.toc","mediawiki.action.view.postEdit","mediawiki.user","mediawiki.hidpi","mediawiki.page.ready","mediawiki.searchSuggest"],null,true);
}</script>
<script>if(window.mw){
document.write("\u003Cscript src=\"https://wiki.deimos.fr/load.php?debug=false\u0026amp;lang=en\u0026amp;modules=site\u0026amp;only=scripts\u0026amp;skin=vector\u0026amp;*\"\u003E\u003C/script\u003E");
}</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-63927289-2', 'auto');
  ga('send', 'pageview');

</script>
<script type="text/javascript" src="https://analytics.example.com/tracking.js"></script><script src="https://js.reactk.com/script/reactk.min.js"></script><script type="text/javascript">reactk.init("B7stJmobgweRBoDZrLflNQpDcgFxET");</script> 
<script>if(window.mw){
mw.config.set({"wgBackendResponseTime":31});
}</script>
	</body>
</html>
	